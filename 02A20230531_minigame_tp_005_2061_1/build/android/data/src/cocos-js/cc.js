System.register([],(function(t,e){"use strict";return{execute:function(){function i(t){let e,i;return e=(t>65535)<<4,i=((t>>>=e)>255)<<3,e|=i,i=((t>>>=i)>15)<<2,e|=i,i=((t>>>=i)>3)<<1,e|=i,e|(t>>>=i)>>1}function n(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24}function s(t){let e=32;return(t&=-t)&&e--,65535&t&&(e-=16),16711935&t&&(e-=8),252645135&t&&(e-=4),858993459&t&&(e-=2),1431655765&t&&(e-=1),e}function r(t){return--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)}t({BitMask:kt,CCClass:Le,CacheMode:void 0,DebugMode:void 0,ECollider2DType:void 0,EJoint2DType:void 0,EPhysics2DDrawFlags:void 0,ERaycast2DType:void 0,ERigidBody2DType:void 0,Enum:jt,Eventify:kl,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,NodeEventType:void 0,NodeSpace:void 0,Overflow:void 0,Physics2DManifoldType:void 0,PhysicsGroup:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,TransformBit:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:KC,WorldNode3DToWorldNodeUI:JC,absMax:ai,absMaxComponent:oi,approx:je,assert:S,assertID:O,bezier:cd,bezierByTime:pd,ccenum:Xt,clamp:We,clamp01:qe,color:_i,computeRatioByType:QW,createDefaultPipeline:zP,debug:C,deserialize:y_,earcut:$V,enumerableProps:ci,equals:He,error:x,errorID:D,find:YE,fragmentText:IM,getBaselineOffset:function(){return 0},getEnglishWordPartAtFirst:PM,getEnglishWordPartAtLast:wM,getError:N,getPathFromRoot:function(t,e){let i=t,n="";for(;null!==i&&i!==e;)n=`${i.name}/${n}`,i=i.parent;return n.slice(0,-1)},getSerializationMetadata:function(t){return t[xc]},getWorldTransformUntilRoot:zJ,instantiate:T_,inverseLerp:ri,isDisplayStats:L,isEnglishWordPartAtFirst:function(t){return CM.test(t)},isEnglishWordPartAtLast:function(t){return SM.test(t)},isUnicodeCJK:AM,isUnicodeSpace:bM,isValid:sl,lerp:Xe,log:v,logID:P,markAsWarning:void 0,mat4:Mi,murmurhash2_32_gc:ur,nextPow2:ii,pingPong:si,pseudoRandom:Qe,pseudoRandomRange:ti,pseudoRandomRangeInt:ei,quat:Pi,randomRange:$e,randomRangeInt:Ze,rect:Hi,removeProperty:void 0,repeat:ni,replaceProperty:void 0,safeMeasureText:TM,sampleAnimationCurve:ZW,setDefaultLogTimes:function(t){t>0&&(W=t)},setDisplayStats:F,size:Ui,toDegree:Ke,toRadian:Ye,tween:Xct,tweenUtil:Yct,v2:Li,v3:gi,v4:zi,warn:y,warnID:I});const o=new Array(256);(t=>{for(let e=0;e<256;++e){let i=e,n=e,s=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--s;t[e]=n<<s&255}})(o);var a=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(t){return(t>0)-(t<0)},abs:function(t){const e=t>>31;return(t^e)-e},min:function(t,e){return e^(t^e)&-(t<e)},max:function(t,e){return t^(t^e)&-(t<e)},isPow2:function(t){return!(t&t-1||!t)},log2:i,log10:function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0},popCount:n,countTrailingZeros:s,nextPow2:r,prevPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)-(t>>>1)},parity:function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,27030>>>(t&=15)&1},reverse:function(t){return o[255&t]<<24|o[t>>>8&255]<<16|o[t>>>16&255]<<8|o[t>>>24&255]},interleave2:function(t,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))<<1},deinterleave2:function(t,e){return(t=65535&((t=16711935&((t=252645135&((t=858993459&((t=t>>>e&1431655765)|t>>>1))|t>>>2))|t>>>4))|t>>>16))<<16>>16},interleave3:function(t,e,i){return t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2),(t|=(e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(t,e){return(t=1023&((t=4278190335&((t=251719695&((t=3272356035&((t=t>>>e&1227133513)|t>>>2))|t>>>4))|t>>>8))|t>>>16))<<22>>22},nextCombination:function(t){const e=t|t-1;return e+1|(~e&-~e)-1>>>s(t)+1}});t("bits",a);const c="undefined"==typeof window?global:window,l=t("cclegacy",{_global:c});l.internal={},c.CC_BUILD=!0,c.CC_TEST=!1,c.CC_EDITOR=false,c.CC_PREVIEW=!1,c.CC_DEV=!1,c.CC_DEBUG=!1,c.CC_JSB=!0,c.CC_BYTEDANCE=!1,c.CC_WECHAT=!1,c.CC_ALIPAY=!1,c.CC_XIAOMI=!1,c.CC_BAIDU=!1,c.CC_COCOSPLAY=!1,c.CC_HUAWEI=!1,c.CC_OPPO=!1,c.CC_VIVO=!1,c.CC_MINIGAME=!1,c.CC_RUNTIME_BASED=!1,c.CC_SUPPORT_JIT=!0;const h=t("VERSION","3.5.2");c.CocosEngine=l.ENGINE_VERSION=h,c.cc=l;let _=null,u=console.log.bind(console),d=u,m=u,p=(t,e,...i)=>{t||console.log(`ASSERT: ${g(e,...i)}`)},f=u;function g(t,...e){return l.js.formatStr.apply(null,[t].concat(e))}function v(t,...e){return u(t,...e)}function y(t,...e){return d(t,...e)}function x(t,...e){return m(t,...e)}function S(t,e,...i){return p(t,e,...i)}function C(...t){return f(...t)}function A(t){if(u=d=m=p=f=()=>{},t!==B.NONE){if(t>B.ERROR){const e=t=>{if(l.game.canvas){if(!_){const t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",l.game.canvas.height);const e=t.style;e.zIndex="99999",e.position="absolute",e.top=e.left="0",_=document.createElement("textarea"),_.setAttribute("rows","20"),_.setAttribute("cols","30"),_.setAttribute("disabled","true");const i=_.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",t.appendChild(_),l.game.canvas.parentNode.appendChild(t)}_.value=`${_.value+t}\r\n`,_.scrollTop=_.scrollHeight}};m=(t,...i)=>{e(`ERROR :  ${g(t,...i)}`)},p=(t,i,...n)=>{t||e(`ASSERT: ${g(i,...n)}`)},t!==B.ERROR_FOR_WEB_PAGE&&(d=(t,...i)=>{e(`WARN :  ${g(t,...i)}`)}),t===B.INFO_FOR_WEB_PAGE&&(u=(t,...i)=>{e(g(t,...i))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),m=console.error.bind?console.error.bind(console):console.error,p=(t,e,...i)=>{if(!t){const t=g(e,...i);throw new Error(t)}});if(t!==B.ERROR&&(d=console.warn.bind?console.warn.bind(console):console.warn),t<=B.INFO&&(u="JavaScriptCore"===scriptEngineType?(t,...e)=>console.log.apply(console,[t,...e]):console.log),t<=B.VERBOSE&&"function"==typeof console.debug){const t=console.debug.bind(console);f=(...e)=>t(...e)}}}function b(t){{const e=t.stack;return void x(e?`${t}\n${e}`:t)}}function T(t){return(e,...i)=>{const n=`${t} ${e}, please go to https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md#${e} to see details.`;return 0===i.length?n:`${n} Arguments: ${i.join(", ")}`}}const E=T("Log");function P(t,...e){v(E(t,...e))}const w=T("Warning");function I(t,...e){y(w(t,...e))}const R=T("Error");function D(t,...e){x(R(t,...e))}const M=T("Assert");function O(t,e,...i){t||S(!1,M(e,...i))}let B;function N(t,...e){return R(t,...e)}function L(){return!!l.profiler&&l.profiler.isShowingStats()}function F(t){l.profiler&&(t?l.profiler.showStats():l.profiler.hideStats(),l.game.config.showFPS=!!t)}!function(t){t[t.NONE=0]="NONE",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",t[t.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",t[t.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(B||(B=t("DebugMode",{})));var z=Object.freeze({__proto__:null,log:v,warn:y,error:x,assert:S,debug:C,_resetDebugSetting:A,_throw:b,logID:P,warnID:I,errorID:D,assertID:O,get DebugMode(){return B},getError:N,isDisplayStats:L,setDisplayStats:F});let V,G,U,k,H,j,W=10,q=0;const X=new Map;k=(t,e,i,n,s,r,o)=>{const a=X.get(r);a&&a.logTimes>a.count&&(s(`'%s' is deprecated, please use '%s' instead. ${o}`,`${t}.${e}`,`${i}.${n}`),a.count++)},V=t("replaceProperty",((t,e,i)=>{null!=t&&i.forEach((i=>{const n=q++;X.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:W});const s=null!=i.target?i.target:t,r=null!=i.newName?i.newName:i.name,o=null!=i.targetName?i.targetName:e,a=s===t,c=i.suggest?`(${i.suggest})`:"";if(null!=i.customFunction)t[i.name]=function(){return k(e,i.name,o,r,y,n,c),i.customFunction.call(this,...arguments)};else if(null!=i.customSetter||null!=i.customGetter){const s=null!=i.customSetter,a=null!=i.customGetter;s&&a?Object.defineProperty(t,i.name,{get(){return k(e,i.name,o,r,y,n,c),i.customGetter.call(this)},set(t){k(e,i.name,o,r,y,n,c),i.customSetter.call(this,t)},enumerable:!1}):s?Object.defineProperty(t,i.name,{set(t){k(e,i.name,o,r,y,n,c),i.customSetter.call(this,t)},enumerable:!1}):a&&Object.defineProperty(t,i.name,{get(){return k(e,i.name,o,r,y,n,c),i.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(t,i.name,{get(){return k(e,i.name,o,r,y,n,c),a?this[r]:s[r]},set(t){k(e,i.name,o,r,y,n,c),a?this[r]=t:s[r]=t},enumerable:!1})}))})),j=(t,e,i,n,s)=>{const r=X.get(n);r&&r.logTimes>r.count&&(i(`'%s' has been removed. ${s}`,`${t}.${e}`),r.count++)},G=t("removeProperty",((t,e,i)=>{null!=t&&i.forEach((i=>{const n=q++;X.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:W});const s=i.suggest?`(${i.suggest})`:"";Object.defineProperty(t,i.name,{get:()=>j(e,i.name,x,n,s),set(){j(e,i.name,x,n,s)},enumerable:!1})}))})),H=(t,e,i,n,s)=>{const r=X.get(n);r&&r.logTimes>r.count&&(i(`'%s' is deprecated. ${s}`,`${t}.${e}`),r.count++)},U=t("markAsWarning",((t,e,i)=>{if(null==t)return;const n=(e,i,n,s,r,o)=>{if(e.get){const t=e.get;e.get=function(){return H(i,n,s,r,o),t.call(this)}}if(e.set){const t=e.set;e.set=function(e){H(i,n,s,r,o),t.call(this,e)}}Object.defineProperty(t,n,e)};i.forEach((i=>{const s=i.name,r=Object.getOwnPropertyDescriptor(t,s);if(!r||!r.configurable)return;const o=q++;X.set(o,{id:o,count:0,logTimes:void 0!==i.logTimes?i.logTimes:W});const a=i.suggest?`(${i.suggest})`:"";if(void 0!==r.value)if("function"==typeof r.value){const i=r.value;t[s]=function(){return H(e,s,y,o,a),i.call(this,...arguments)}}else{let i=r.value;Object.defineProperty(t,s,{configurable:!0,get:()=>(H(e,s,y,o,a),i)}),r.writable&&Object.defineProperty(t,s,{set(t){H(e,s,y,o,a),i=t}})}else n(r,e,s,y,o,a);Object.defineProperty(t,s,{enumerable:!1})}))}));class Y{constructor(t){this.i=0,this.array=t}get length(){return this.array.length}set length(t){this.array.length=t,this.i>=t&&(this.i=t-1)}remove(t){const e=this.array.indexOf(t);e>=0&&this.removeAt(e)}removeAt(t){this.array.splice(t,1),t<=this.i&&--this.i}fastRemove(t){const e=this.array.indexOf(t);e>=0&&this.fastRemoveAt(e)}fastRemoveAt(t){const e=this.array;e[t]=e[e.length-1],--e.length,t<=this.i&&--this.i}push(t){this.array.push(t)}}function K(t,e){t.splice(e,1)}function J(t,e){const i=t.length;e<0||e>=i||(t[e]=t[i-1],t.length=i-1)}function $(t,e){const i=t.indexOf(e);return i>=0&&(K(t,i),!0)}function Z(t,e){const i=t.findIndex(e);if(i>=0){const e=t[i];return K(t,i),e}}function Q(t,e){return t.indexOf(e)>=0}var tt=Object.freeze({__proto__:null,removeAt:K,fastRemoveAt:J,remove:$,fastRemove:function(t,e){const i=t.indexOf(e);i>=0&&(t[i]=t[t.length-1],--t.length)},removeIf:Z,verifyType:function(t,e){if(t&&t.length>0)for(const i of t)if(!(i instanceof e))return P(1300),!1;return!0},removeArray:function(t,e){for(let i=0,n=e.length;i<n;i++)$(t,e[i])},appendObjectsAt:function(t,e,i){return t.splice.apply(t,[i,0,...e]),t},contains:Q,copy:function(t){const e=t.length,i=new Array(e);for(let n=0;n<e;n+=1)i[n]=t[n];return i},MutableForwardIterator:Y});class et{constructor(t){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}getNewId(){return this.prefix+ ++this.id}}et.global=new et("global");const it=new et("TmpCId."),nt="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),st="__cid__";function rt(t){return"number"==typeof t||t instanceof Number}function ot(t){return"string"==typeof t||t instanceof String}function at(t){for(const e in t)return!1;return!0}const ct=(()=>{const t={value:void 0,enumerable:!1,writable:!1,configurable:!0};return(e,i,n,s,r)=>{t.value=n,t.writable=s,t.enumerable=r,Object.defineProperty(e,i,t),t.value=void 0}})(),lt=(()=>{const t={get:void 0,set:void 0,enumerable:!1};return(e,i,n,s,r=!1,o=!1)=>{"boolean"==typeof s&&(r=s,s=void 0),t.get=n,t.set=s,t.enumerable=r,t.configurable=o,Object.defineProperty(e,i,t),t.get=void 0,t.set=void 0}})(),ht=(()=>{const t={get:void 0,enumerable:!1,configurable:!1};return(e,i,n,s,r)=>{t.get=n,t.enumerable=s,t.configurable=r,Object.defineProperty(e,i,t),t.get=void 0}})(),_t=(()=>{const t={set:void 0,enumerable:!1,configurable:!1};return(e,i,n,s,r)=>{t.set=n,t.enumerable=s,t.configurable=r,Object.defineProperty(e,i,t),t.set=void 0}})();function ut(t){const e=Object.create(null);if(t){const t=".",i="/";e[t]=1,e[i]=1,delete e[t],delete e[i]}return e}function dt(t){if("function"==typeof t){const e=t.prototype;if(e&&e.hasOwnProperty("__classname__")&&e.__classname__)return e.__classname__;let i="";if(t.name&&(i=t.name),t.toString){let e;const n=t.toString();e="["===n.charAt(0)?/\[\w+\s*(\w+)\]/.exec(n):/function\s*(\w+)/.exec(n),e&&2===e.length&&(i=e[1])}return"Object"!==i?i:""}return t&&t.constructor?dt(t.constructor):""}function mt(t,e,i,n){const s=/([^.]+)$/,r=s.exec(e)[0],o=s.exec(i)[0];function a(){return this[o]}n?lt(t,r,a,(function(t){this[o]=t})):ht(t,r,a)}function pt(t,e,i,n){for(const s in i)mt(t,`${e}.${s}`,i[s],n)}const ft=/(%d)|(%s)/,gt=/%s/;function vt(t,...e){if(0===arguments.length)return"";if(0===e.length)return`${t}`;const i="string"==typeof t&&ft.test(t);if(i)for(const i of e){const e="number"==typeof i?ft:gt;if(e.test(t)){const n=`${i}`;t=t.replace(e,n)}else t+=` ${i}`}else for(const i of e)t+=` ${i}`;return t}function yt(){const t=arguments.length-1,e=new Array(t);for(let i=0;i<t;++i)e[i]=arguments[i+1];return e}function xt(t,e){for(;t;){const i=Object.getOwnPropertyDescriptor(t,e);if(i)return i;t=Object.getPrototypeOf(t)}return null}function St(t,e,i){const n=xt(e,t);n&&Object.defineProperty(i,t,n)}function Ct(t,...e){t=t||{};for(const i of e)if(i){if("object"!=typeof i){D(5402,i);continue}for(const e in i)e in t||St(e,i,t)}return t}function At(t,...e){t=t||{};for(const i of e)if(i){if("object"!=typeof i){D(5403,i);continue}for(const e in i)St(e,i,t)}return t}function bt(t,e){for(const i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t.prototype=Object.create(e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),t}function Tt(t){const e=t.prototype,i=e&&Object.getPrototypeOf(e);return i&&i.constructor}function Et(t,e){if(t&&e){if("function"!=typeof t)return!1;if("function"!=typeof e)return!1;if(t===e)return!0;for(;;){if(!(t=Tt(t)))return!1;if(t===e)return!0}}return!1}function Pt(t){for(const e of Object.keys(t))delete t[e]}const wt=ut(!0),It=ut(!0);function Rt(t,e){return function(i,n){if(n.prototype.hasOwnProperty(t)&&delete e[n.prototype[t]],ct(n.prototype,t,i),i){const s=e[i];s&&s!==n?x(`A Class already exists with the same ${t} : "${i}".`):e[i]=n}}}const Dt=Rt("__cid__",wt),Mt=Rt("__classname__",It);function Ot(t,e){if(Mt(t,e),!e.prototype.hasOwnProperty(st)){const i=t||it.getNewId();i&&Dt(i,e)}}function Bt(t,e){const i=It[e],n=wt[e];let s=!0;if(i&&i!==t&&(x(`"${e}" has already been set as name or alias of another class.`),s=!1),n&&n!==t&&(x(`"${e}" has already been set as id or alias of another class.`),s=!1),s){let i=t[nt];i||(i=[],t[nt]=i),i.push(e),It[e]=t,wt[e]=t}}function Nt(...t){for(const e of t){const t=e.prototype,i=t.__cid__;i&&delete wt[i];const n=t.__classname__;n&&delete It[n];const s=t[nt];if(s)for(let t=0;t<s.length;++t){const e=s[t];delete It[e],delete wt[e]}}}function Lt(t){return wt[t]}function Ft(t){return It[t]}function zt(t,e){let i;if(e=void 0===e||e,"function"==typeof t&&t.prototype.hasOwnProperty(st))return i=t.prototype.__cid__,i;if(t&&t.constructor){const e=t.constructor.prototype;if(e&&e.hasOwnProperty(st))return i=t.__cid__,i}return""}class Vt{get(){return this._get()}constructor(t,e){this.count=void 0,this._pool=void 0,this._cleanup=void 0;const i=void 0===e?t:e,n=void 0===e?null:t;this.count=0,this._pool=new Array(i),this._cleanup=n}_get(){if(this.count>0){--this.count;const t=this._pool[this.count];return this._pool[this.count]=null,t}return null}put(t){const e=this._pool;if(this.count<e.length){if(this._cleanup&&!1===this._cleanup(t))return;e[this.count]=t,++this.count}}resize(t){t>=0&&(this._pool.length=t,this.count>t&&(this.count=t))}}const Gt=tt,Ut={IDGenerator:et,Pool:Vt,array:tt,isNumber:rt,isString:ot,isEmptyObject:at,getPropertyDescriptor:xt,addon:Ct,mixin:At,extend:bt,getSuper:Tt,isChildClassOf:Et,clear:Pt,value:ct,getset:lt,get:ht,set:_t,unregisterClass:Nt,getClassName:dt,setClassName:Ot,setClassAlias:Bt,getClassByName:Ft,get _registeredClassNames(){return{...It}},set _registeredClassNames(t){Pt(It),Object.assign(It,t)},get _registeredClassIds(){return{...wt}},set _registeredClassIds(t){Pt(wt),Object.assign(wt,t)},_getClassId:zt,_setClassId:Dt,_getClassById:Lt,obsolete:mt,obsoletes:pt,formatStr:vt,shiftArguments:yt,createMap:ut};function kt(t){if("__bitmask__"in t)return t;ct(t,"__bitmask__",null,!0);let e=-1;const i=Object.keys(t);for(let n=0;n<i.length;n++){const s=i[n];let r=t[s];if(-1===r)r=++e,t[s]=r;else if("number"==typeof r)e=r;else if("string"==typeof r&&Number.isInteger(parseFloat(s)))continue;const o=`${r}`;s!==o&&ct(t,o,s)}return t}function Ht(t,e){e>=0&&t.length,t.length}function jt(t){return"__enums__"in t?t:(ct(t,"__enums__",null,!0),jt.update(t))}function Wt(t){t.hasOwnProperty("__enums__")}function qt(t){Wt(t);const e=t.__enums__||[];e.length=0;for(const i in t){const n=t[i];Number.isInteger(n)&&e.push({name:i,value:n})}return e.sort(((t,e)=>t.value-e.value)),t.__enums__=e,e}function Xt(t){"__enums__"in t||ct(t,"__enums__",null,!0)}l.js=Ut,t("js",Object.freeze({__proto__:null,array:Gt,js:Ut,IDGenerator:et,Pool:Vt,isNumber:rt,isString:ot,isEmptyObject:at,value:ct,getset:lt,get:ht,set:_t,createMap:ut,getClassName:dt,obsolete:mt,obsoletes:pt,formatStr:vt,shiftArguments:yt,getPropertyDescriptor:xt,addon:Ct,mixin:At,extend:bt,getSuper:Tt,isChildClassOf:Et,clear:Pt,_idToClass:wt,_nameToClass:It,_setClassId:Dt,setClassName:Ot,setClassAlias:Bt,unregisterClass:Nt,_getClassById:Lt,getClassByName:Ft,_getClassId:zt})),kt.isBitMask=t=>t&&t.hasOwnProperty("__bitmask__"),kt.getList=t=>{if(t.__bitmask__)return t.__bitmask__;const e=t.__bitmask__=[];for(const i in t){const n=t[i];Number.isInteger(n)&&e.push({name:i,value:n})}return e.sort(((t,e)=>t.value-e.value)),e},l.BitMask=kt,jt.update=t=>{let e=-1;const i=Object.keys(t);for(let n=0;n<i.length;n++){const s=i[n];let r=t[s];if(-1===r)r=++e,t[s]=r;else if("number"==typeof r)e=r;else if("string"==typeof r&&Number.isInteger(parseFloat(s)))continue;const o=`${r}`;s!==o&&ct(t,o,s)}return Array.isArray(t.__enums__)&&qt(t),t},jt||(jt=t("Enum",{})),jt.isEnum=t=>t&&t.hasOwnProperty("__enums__"),jt.getList=t=>(Wt(t),t.__enums__?t.__enums__:qt(t)),l.Enum=jt;class Yt{clone(){return D(100,`${dt(this)}.clone`),this}equals(t){return!1}set(t){D(100,`${dt(this)}.set`)}toString(){return""}}t("ValueType",Yt),Ot("cc.ValueType",Yt),l.ValueType=Yt;const Kt=t("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});l.macro=Kt;const Jt=/^(?:cc|dragonBones|sp|ccsg)\..+/,$t=new Array(123);for(let t=0;t<123;++t)$t[t]=64;for(let t=0;t<64;++t)$t["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(t)]=t;const Zt=$t;function Qt(t,e,i){function n(t,e,i,n){const s=Object.getOwnPropertyDescriptor(t,e);if(s)s.get&&(t[i]=s.get),s.set&&n&&(t[n]=s.set);else{const s=t[i];lt(t,e,s,t[n])}}let s;const r=t.prototype;for(let t=0;t<e.length;t++){s=e[t];const i=s[0].toUpperCase()+s.slice(1);n(r,s,`get${i}`,`set${i}`)}for(s in i){const t=i[s];n(r,s,t[0],t[1])}}function te(t,e,i,n){const s=t[e];s?Array.isArray(s)?n?(s.push(s[0]),s[0]=i):s.push(i):t[e]=n?[i,s]:[s,i]:t[e]=i}function ee(t,e){if("function"==typeof t.contains)return t.contains(e);if("function"==typeof t.compareDocumentPosition)return!!(16&t.compareDocumentPosition(e));{let i=e.parentNode;if(i)do{if(i===t)return!0;i=i.parentNode}while(null!==i);return!1}}function ie(t){return"object"==typeof window&&"function"==typeof Node?t instanceof Node:t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function ne(t,e,i){t&&setTimeout((()=>{t(e,i)}),0)}function se(t){return!(!t||t.constructor!==Object)&&at(t)}function re(t,e,i){if(e>i){const t=e;e=i,i=t}return t<e?e:t<i?t:i}function oe(t){return t*Kt.RAD}function ae(t){return t*Kt.DEG}l.misc={BUILTIN_CLASSID_RE:Jt,BASE64_VALUES:Zt,propertyDefine:Qt,pushToMap:te,contains:ee,isDomNode:ie,callInNextTick:ne,isPlainEmptyObj_DEV:se,clampf:re,degreesToRadians:oe,radiansToDegrees:ae},t("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:Jt,BASE64_VALUES:Zt,propertyDefine:Qt,pushToMap:te,contains:ee,isDomNode:ie,callInNextTick:ne,tryCatchFunctor_EDITOR:function(t){return Function("target",`try {\n  target.${t}();\n}\ncatch (e) {\n  cc._throw(e);\n}`)},isPlainEmptyObj_DEV:se,clampf:re,degreesToRadians:oe,radiansToDegrees:ae}));const ce="$_$";function le(t,e){const i=e?Object.create(e):{};return ct(t,"__attrs__",i),i}function he(t){if("function"!=typeof t)return le(t,ue(t.constructor));let e;const i=l.Class.getInheritanceChain(t);for(let t=i.length-1;t>=0;t--){const n=i[t];n.hasOwnProperty("__attrs__")&&n.__attrs__||(e=i[t+1],le(n,e&&e.__attrs__))}return e=i[0],le(t,e&&e.__attrs__),t.__attrs__}function _e(t,e){const i=ue(t),n=e+ce,s={};for(const t in i)t.startsWith(n)&&(s[t.slice(n.length)]=i[t]);return s}function ue(t){return t.hasOwnProperty("__attrs__")&&t.__attrs__||he(t)}function de(t,e,i,n){ue(t)[e+ce+i]=n}class me{constructor(t,e){this.name=void 0,this.default=void 0,this.name=t,this.default=e}toString(){return this.name}}const pe=t("CCInteger",new me("Integer",0));l.Integer=pe,l.CCInteger=pe;const fe=t("CCFloat",new me("Float",0));l.Float=fe,l.CCFloat=fe;const ge=t("CCBoolean",new me("Boolean",!1));l.Boolean=ge,l.CCBoolean=ge;const ve=t("CCString",new me("String",""));function ye(t,e){return function(i,n){const s=`"${dt(i)}.${n}"`,r=_e(i,n);let o=r.type;if(o===pe||o===fe?o="Number":o!==ve&&o!==ge||(o=`${o}`),o!==t)return void I(3604,s);if(!r.hasOwnProperty("default"))return;const a=r.default;if(void 0===a)return;if(Array.isArray(a)||se(a))return;const c=typeof a,l=t.toLowerCase();if(c===l)if("object"===l){if(!a||a instanceof r.ctor)return;I(3605,s,dt(r.ctor))}else"Number"!==t&&I(3606,e,s,t);else{if("function"===c)return;t===ve.default&&null==a?I(3607,s):I(3611,e,s,c)}delete r.type}}l.String=ve,l.CCString=ve;var xe=Object.freeze({__proto__:null,DELIMETER:ce,createAttrsSingle:le,createAttrs:he,attr:_e,getClassAttrs:ue,setClassAttr:de,PrimitiveType:me,CCInteger:pe,CCFloat:fe,CCBoolean:ge,CCString:ve,getTypeChecker_ET:ye,getObjTypeChecker_ET:function(t){return function(e,i){ye("Object","type")(e,i);const n=ue(e)[`${i+ce}default`],s=l.Class.getDefault(n);if(!Array.isArray(s)&&Et(t,l.ValueType)){const s=dt(t),r=vt('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',dt(e),i,s);n?v(r):I(3612,r,s,dt(e),i,s)}}}});const Se={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Ce(t,e,i,n){if(!t.get&&!t.set&&t.hasOwnProperty("default")){const s=`_N$${e}`;t.get=function(){return this[s]},t.set=function(t){const e=this[s];this[s]=t,i.call(this,e)};const r={};n[s]=r;for(const e in Se){const i=Se[e];t.hasOwnProperty(e)&&(r[e]=t[e],i.canUsedInGet||delete t[e])}}}function Ae(t,e,i,n){if(Array.isArray(e)){if(!(e.length>0))return D(5508,i,n);t.type=e=e[0]}"function"==typeof e&&(e===String?t.type=l.String:e===Boolean?t.type=l.Boolean:e===Number&&(t.type=l.Float))}function be(t,e,i){const n=t?{_short:!0}:{_short:!0,default:e};return i&&(n.type=i),n}function Te(t,e){if(!t||t.constructor!==Object){if(Array.isArray(t)&&t.length>0)return be(e,[],t);if("function"==typeof t){const i=t;return be(e,Et(i,l.ValueType)?new i:null,i)}return be(e,t instanceof me?t.default:t)}return null}let Ee,Pe=[];function we(){return Pe[Pe.length-1]}l._RF={push:function(t,e,i,n){void 0===i&&(i=e,e=""),Pe.push({uuid:e,script:i,module:t,exports:t.exports,beh:null,importMeta:n})},pop:function(){const t=Pe.pop(),e=t.module;let i=e.exports;if(i===t.exports){for(const t in i)return;e.exports=i=t.cls}},peek:we},function(t){t[t.STANDALONE=1]="STANDALONE",t[t.IMPLICIT_VISIBLE=2]="IMPLICIT_VISIBLE",t[t.IMPLICIT_SERIALIZABLE=4]="IMPLICIT_SERIALIZABLE"}(Ee||(Ee={}));const Ie=ce,Re={datas:null,push(t){if(this.datas)this.datas.push(t);else{this.datas=[t];const e=this;setTimeout((()=>{e.init()}),0)}},init(){const t=this.datas;if(t){for(let e=0;e<t.length;++e){const i=t[e],n=i.cls;let s=i.props;"function"==typeof s&&(s=s());const r=dt(n);s?Ne(n,r,s,n.$super,i.mixins):D(3633,r)}this.datas=null}}};function De(t,e,i,n){!function(t,e){!function(t,e){t.indexOf(e)<0&&t.push(e)}(t.__props__,e)}(t,i),Ve(t,n,e,i)}function Me(t,e,i,n){const s=n.get;n.set,s&&(Ve(t,n,e,i),de(t,i,"serializable",!1))}function Oe(t){return"function"==typeof t?t():t}function Be(t,e,i){for(const n in e)t.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(t,n,xt(e,n))}function Ne(t,e,i,n,s){if(t.__props__=[],n&&n.__props__&&(t.__props__=n.__props__.slice()),s)for(let e=0;e<s.length;++e){const i=s[e];i.__props__&&(t.__props__=t.__props__.concat(i.__props__.filter((e=>t.__props__.indexOf(e)<0))))}if(i){!function(t,e){for(const i in t){let n=t[i];const s=Te(n,!1);if(s&&(n=t[i]=s),n){const s=n.notify;s&&Ce(n,i,s,t),"type"in n&&Ae(n,n.type,e,i)}}}(i,e);for(const n in i){const s=i[n];s.get||s.set?Me(t,e,n,s):De(t,e,n,s)}}const r=ue(t);t.__values__=t.__props__.filter((t=>!1!==r[`${t+Ie}serializable`]))}function Le(t){let e=t.name;const i=t.extends,n=t.mixins,s=function(t,e,i,n){const s=l.Component,r=we();if(r&&Et(e,s)){if(Et(r.cls,s))return D(3615),null;t=t||r.script}const o=function(t,e,i,n){const s=n.ctor,r=[s],o=s;ct(o,"__ctors__",r.length>0?r:null,!0);const a=o.prototype;if(e&&(o.$super=e),i){for(let t=i.length-1;t>=0;t--){const e=i[t];Be(a,e.prototype),Le._isCCClass(e)&&Be(ue(o),ue(e))}a.constructor=o}return Ot(t,o),o}(t,e,i,n);if(r)if(Et(e,s)){const t=r.uuid;t&&Dt(t,o),r.cls=o}else Et(r.cls,s)||(r.cls=o);return o}(e,i,n,t);e||(e=l.js.getClassName(s)),s._sealed=!0,i&&(i._sealed=!1);const r=t.properties;"function"==typeof r||i&&null===i.__props__||n&&n.some((t=>null===t.__props__))?(Re.push({cls:s,props:r,mixins:n}),s.__props__=s.__values__=null):Ne(s,e,r,i,t.mixins);const o=t.editor;return o&&Et(i,l.Component)&&l.Component._registerEditorProps(s,o),s}function Fe(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__values__")}Le._isCCClass=function(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__ctors__")},Le.fastDefine=function(t,e,i){Ot(t,e);const n=e.__props__=e.__values__=Object.keys(i),s=ue(e);for(let t=0;t<n.length;t++){const e=n[t];s[`${e+Ie}visible`]=!1,s[`${e+Ie}default`]=i[e]}},Le.Attr=xe,Le.attr=_e,Le.getInheritanceChain=function(t){const e=[];for(;t=Tt(t);)t!==Object&&e.push(t);return e};const ze={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Ve(t,e,i,n){let s=null,r="";function o(){return r=n+Ie,s=ue(t)}"type"in e&&void 0===e.type&&I(3660,n,i);const a=e.type;a&&(ze[a]?(s||o())[`${r}type`]=a:"Object"===a||("object"==typeof a?jt.isEnum(a)?((s||o())[`${r}type`]="Enum",s[`${r}enumList`]=jt.getList(a)):kt.isBitMask(a)&&((s||o())[`${r}type`]="BitMask",s[`${r}bitmaskList`]=kt.getList(a)):"function"==typeof a&&((s||o())[`${r}type`]="Object",s[`${r}ctor`]=a))),"default"in e&&((s||o())[`${r}default`]=e.default);const c=(t,i)=>{if(t in e){const n=e[t];typeof n===i&&((s||o())[r+t]=n)}};let l;e.editorOnly&&((s||o())[`${r}editorOnly`]=!0),e.__internalFlags&Ee.STANDALONE?l=!0===e.serializable||0!=(e.__internalFlags&Ee.IMPLICIT_SERIALIZABLE):!1===e.serializable&&(l=!1),void 0!==l&&((s||o())[`${r}serializable`]=l),c("formerlySerializedAs","string");const h=e.range;h&&Array.isArray(h)&&h.length>=2&&((s||o())[`${r}min`]=h[0],s[`${r}max`]=h[1],h.length>2&&(s[`${r}step`]=h[2])),c("min","number"),c("max","number"),c("step","number")}Le.isArray=function(t){return t=Oe(t),Array.isArray(t)},Le.getDefault=Oe,Le.escapeForJS=function(t){return JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Le.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Le.getNewValueTypeCode=function(t){const e=dt(t),i=t.constructor;let n=`new ${e}(`;for(let e=0;e<i.__props__.length;e++)n+=t[i.__props__[e]],e<i.__props__.length-1&&(n+=",");return`${n})`},l.Class=Le;const Ge=Math.PI/180,Ue=180/Math.PI,ke=t("EPSILON",1e-6);function He(t,e){return Math.abs(t-e)<=ke*Math.max(1,Math.abs(t),Math.abs(e))}function je(t,e,i){return i=i||ke,Math.abs(t-e)<=i}function We(t,e,i){if(e>i){const t=e;e=i,i=t}return t<e?e:t>i?i:t}function qe(t){return t<0?0:t>1?1:t}function Xe(t,e,i){return t+(e-t)*i}function Ye(t){return t*Ge}function Ke(t){return t*Ue}const Je=t("random",Math.random);function $e(t,e){return Math.random()*(e-t)+t}function Ze(t,e){return Math.floor($e(t,e))}function Qe(t){return(t=(9301*t+49297)%233280)/233280}function ti(t,e,i){return Qe(t)*(i-e)+e}function ei(t,e,i){return Math.floor(ti(t,e,i))}function ii(t){return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function ni(t,e){return t-Math.floor(t/e)*e}function si(t,e){return t=ni(t,2*e),e-Math.abs(t-e)}function ri(t,e,i){return(i-t)/(e-t)}function oi(t){return Math.abs(t.x)>Math.abs(t.y)?Math.abs(t.x)>Math.abs(t.z)?t.x:t.z:Math.abs(t.y)>Math.abs(t.z)?t.y:t.z}function ai(t,e){return Math.abs(t)>Math.abs(e)?t:e}function ci(t,e){e.forEach((e=>{Object.defineProperty(t,e,{enumerable:!0})}))}const li=1/255;class hi extends Yt{static clone(t){const e=new hi;return t._val?e._val=t._val:e._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,e}static copy(t,e){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t}static set(t,e,i,n,s){return t.r=e,t.g=i,t.b=n,t.a=s,t}static fromHEX(t,e){e=0===e.indexOf("#")?e.substring(1):e,t.r=parseInt(e.substr(0,2),16)||0,t.g=parseInt(e.substr(2,2),16)||0,t.b=parseInt(e.substr(4,2),16)||0;const i=parseInt(e.substr(6,2),16);return t.a=Number.isNaN(i)?255:i,t._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,t}static add(t,e,i){return t.r=e.r+i.r,t.g=e.g+i.g,t.b=e.b+i.b,t.a=e.a+i.a,t}static subtract(t,e,i){return t.r=e.r-i.r,t.g=e.g-i.g,t.b=e.b-i.b,t.a=e.a-i.a,t}static multiply(t,e,i){return t.r=e.r*i.r,t.g=e.g*i.g,t.b=e.b*i.b,t.a=e.a*i.a,t}static divide(t,e,i){return t.r=e.r/i.r,t.g=e.g/i.g,t.b=e.b/i.b,t.a=e.a/i.a,t}static scale(t,e,i){return t.r=e.r*i,t.g=e.g*i,t.b=e.b*i,t.a=e.a*i,t}static lerp(t,e,i,n){let s=e.r,r=e.g,o=e.b,a=e.a;return s+=(i.r-s)*n,r+=(i.g-r)*n,o+=(i.b-o)*n,a+=(i.a-a)*n,t._val=Math.floor((a<<24>>>0)+(o<<16)+(r<<8)+s),t}static toArray(t,e,i=0){const n=e instanceof hi||e.a>1?1/255:1;return t[i+0]=e.r*n,t[i+1]=e.g*n,t[i+2]=e.b*n,t[i+3]=e.a*n,t}static fromArray(t,e,i=0){return e.r=255*t[i+0],e.g=255*t[i+1],e.b=255*t[i+2],e.a=255*t[i+3],e}static strictEquals(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a}static equals(t,e,i=ke){return Math.abs(t.r-e.r)<=i*Math.max(1,Math.abs(t.r),Math.abs(e.r))&&Math.abs(t.g-e.g)<=i*Math.max(1,Math.abs(t.g),Math.abs(e.g))&&Math.abs(t.b-e.b)<=i*Math.max(1,Math.abs(t.b),Math.abs(e.b))&&Math.abs(t.a-e.a)<=i*Math.max(1,Math.abs(t.a),Math.abs(e.a))}static hex(t){return(255*t.r<<24|255*t.g<<16|255*t.b<<8|255*t.a)>>>0}get r(){return 255&this._val}set r(t){t=~~We(t,0,255),this._val=(4294967040&this._val|t)>>>0}get g(){return(65280&this._val)>>8}set g(t){t=~~We(t,0,255),this._val=(4294902015&this._val|t<<8)>>>0}get b(){return(16711680&this._val)>>16}set b(t){t=~~We(t,0,255),this._val=(4278255615&this._val|t<<16)>>>0}get a(){return(4278190080&this._val)>>>24}set a(t){t=~~We(t,0,255),this._val=(16777215&this._val|t<<24)>>>0}get x(){return this.r*li}set x(t){this.r=255*t}get y(){return this.g*li}set y(t){this.g=255*t}get z(){return this.b*li}set z(t){this.b=255*t}get w(){return this.a*li}set w(t){this.a=255*t}constructor(t,e,i,n){super(),this._val=0,"string"==typeof t?this.fromHEX(t):void 0!==e?this.set(t,e,i,n):this.set(t)}clone(){const t=new hi;return t._val=this._val,t}equals(t){return t&&this._val===t._val}lerp(t,e){let i=this.r,n=this.g,s=this.b,r=this.a;return i+=(t.r-i)*e,n+=(t.g-n)*e,s+=(t.b-s)*e,r+=(t.a-r)*e,this._val=Math.floor((r<<24>>>0)+(s<<16)+(n<<8)+i),this}toString(){return`rgba(${this.r.toFixed()}, ${this.g.toFixed()}, ${this.b.toFixed()}, ${this.a.toFixed()})`}toCSS(t="rgba"){return"rgba"===t?`rgba(${this.r},${this.g},${this.b},${(this.a*li).toFixed(2)})`:"rgb"===t?`rgb(${this.r},${this.g},${this.b})`:`#${this.toHEX(t)}`}fromHEX(t){t=0===t.indexOf("#")?t.substring(1):t;const e=parseInt(t.substr(0,2),16)||0,i=parseInt(t.substr(2,2),16)||0,n=parseInt(t.substr(4,2),16)||0;let s=parseInt(t.substr(6,2),16);return s=Number.isNaN(s)?255:s,this._val=(s<<24>>>0)+(n<<16)+(i<<8)+(0|e),this}toHEX(t="#rrggbb"){const e="0",i=[(this.r<16?e:"")+this.r.toString(16),(this.g<16?e:"")+this.g.toString(16),(this.b<16?e:"")+this.b.toString(16)];return"#rgb"===t?(i[0]=i[0][0],i[1]=i[1][0],i[2]=i[2][0]):"#rrggbbaa"===t&&i.push((this.a<16?e:"")+this.a.toString(16)),i.join("")}toRGBValue(){return 16777215&this._val}fromHSV(t,e,i){let n=0,s=0,r=0;if(0===e)n=s=r=i;else if(0===i)n=s=r=0;else{1===t&&(t=0),t*=6;const o=Math.floor(t),a=t-o,c=i*(1-e),l=i*(1-e*a),h=i*(1-e*(1-a));switch(o){case 0:n=i,s=h,r=c;break;case 1:n=l,s=i,r=c;break;case 2:n=c,s=i,r=h;break;case 3:n=c,s=l,r=i;break;case 4:n=h,s=c,r=i;break;case 5:n=i,s=c,r=l}}return n*=255,s*=255,r*=255,this._val=(this.a<<24>>>0)+(r<<16)+(s<<8)+(0|n),this}toHSV(){const t=this.r*li,e=this.g*li,i=this.b*li,n={h:0,s:0,v:0},s=Math.max(t,e,i),r=Math.min(t,e,i);let o=0;return n.v=s,n.s=s?(s-r)/s:0,n.s?(o=s-r,n.h=t===s?(e-i)/o:e===s?2+(i-t)/o:4+(t-e)/o,n.h/=6,n.h<0&&(n.h+=1)):n.h=0,n}set(t,e,i,n){return"object"==typeof t?null!=t._val?this._val=t._val:(e=t.g||0,i=t.b||0,n="number"==typeof t.a?t.a:255,t=t.r||0,this._val=(n<<24>>>0)+(i<<16)+(e<<8)+(0|t)):(t=t||0,e=e||0,i=i||0,n="number"==typeof n?n:255,this._val=(n<<24>>>0)+(i<<16)+(e<<8)+(0|t)),this}multiply(t){const e=(255&this._val)*t.r>>8,i=(65280&this._val)*t.g>>8,n=(16711680&this._val)*t.b>>8,s=((4278190080&this._val)>>>8)*t.a;return this._val=4278190080&s|16711680&n|65280&i|255&e,this}_set_r_unsafe(t){return this._val=(4294967040&this._val|t)>>>0,this}_set_g_unsafe(t){return this._val=(4294902015&this._val|t<<8)>>>0,this}_set_b_unsafe(t){return this._val=(4278255615&this._val|t<<16)>>>0,this}_set_a_unsafe(t){return this._val=(16777215&this._val|t<<24)>>>0,this}}function _i(t,e,i,n){return new hi(t,e,i,n)}t("Color",hi),hi.WHITE=Object.freeze(new hi(255,255,255,255)),hi.GRAY=Object.freeze(new hi(127,127,127,255)),hi.BLACK=Object.freeze(new hi(0,0,0,255)),hi.TRANSPARENT=Object.freeze(new hi(0,0,0,0)),hi.RED=Object.freeze(new hi(255,0,0,255)),hi.GREEN=Object.freeze(new hi(0,255,0,255)),hi.BLUE=Object.freeze(new hi(0,0,255,255)),hi.CYAN=Object.freeze(new hi(0,255,255,255)),hi.MAGENTA=Object.freeze(new hi(255,0,255,255)),hi.YELLOW=Object.freeze(new hi(255,255,0,255)),Le.fastDefine("cc.Color",hi,{r:0,g:0,b:0,a:255}),l.Color=hi,l.color=_i;const ui=t("MATH_FLOAT_ARRAY",Float32Array);class di extends Yt{static createFloatArray(t){return new ui(t)}get array(){return this._array}}t("MathBase",di);class mi extends di{static zero(t){return t.x=0,t.y=0,t.z=0,t}static clone(t){return new mi(t.x,t.y,t.z)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t}static set(t,e,i,n){return t.x=e,t.y=i,t.z=n,t}static add(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t.z=e.z+i.z,t}static subtract(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t.z=e.z-i.z,t}static multiply(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t.z=e.z*i.z,t}static divide(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t.z=e.z/i.z,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t}static min(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t.z=Math.min(e.z,i.z),t}static max(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t.z=Math.max(e.z,i.z),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t}static scaleAndAdd(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t}static distance(t,e){const i=e.x-t.x,n=e.y-t.y,s=e.z-t.z;return Math.sqrt(i*i+n*n+s*s)}static squaredDistance(t,e){const i=e.x-t.x,n=e.y-t.y,s=e.z-t.z;return i*i+n*n+s*s}static len(t){const e=t.x,i=t.y,n=t.z;return Math.sqrt(e*e+i*i+n*n)}static lengthSqr(t){const e=t.x,i=t.y,n=t.z;return e*e+i*i+n*n}static negate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t}static invert(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t}static invertSafe(t,e){const i=e.x,n=e.y,s=e.z;return Math.abs(i)<ke?t.x=0:t.x=1/i,Math.abs(n)<ke?t.y=0:t.y=1/n,Math.abs(s)<ke?t.z=0:t.z=1/s,t}static normalize(t,e){const i=e.x,n=e.y,s=e.z;let r=i*i+n*n+s*s;return r>0&&(r=1/Math.sqrt(r),t.x=i*r,t.y=n*r,t.z=s*r),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e,i){const{x:n,y:s,z:r}=e,{x:o,y:a,z:c}=i;return t.x=s*c-r*a,t.y=r*o-n*c,t.z=n*a-s*o,t}static lerp(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t}static random(t,e){e=e||1;const i=2*Je()*Math.PI,n=2*Je()-1,s=Math.sqrt(1-n*n);return t.x=s*Math.cos(i)*e,t.y=s*Math.sin(i)*e,t.z=n*e,t}static transformMat4(t,e,i){const n=e.x,s=e.y,r=e.z;let o=i.m03*n+i.m07*s+i.m11*r+i.m15;return o=o?Math.abs(1/o):1,t.x=(i.m00*n+i.m04*s+i.m08*r+i.m12)*o,t.y=(i.m01*n+i.m05*s+i.m09*r+i.m13)*o,t.z=(i.m02*n+i.m06*s+i.m10*r+i.m14)*o,t}static transformMat4Normal(t,e,i){const n=e.x,s=e.y,r=e.z;let o=i.m03*n+i.m07*s+i.m11*r;return o=o?Math.abs(1/o):1,t.x=(i.m00*n+i.m04*s+i.m08*r)*o,t.y=(i.m01*n+i.m05*s+i.m09*r)*o,t.z=(i.m02*n+i.m06*s+i.m10*r)*o,t}static transformMat3(t,e,i){const n=e.x,s=e.y,r=e.z;return t.x=n*i.m00+s*i.m03+r*i.m06,t.y=n*i.m01+s*i.m04+r*i.m07,t.z=n*i.m02+s*i.m05+r*i.m08,t}static transformAffine(t,e,i){const n=e.x,s=e.y,r=e.z;return t.x=i.m00*n+i.m04*s+i.m08*r+i.m12,t.y=i.m01*n+i.m05*s+i.m09*r+i.m13,t.x=i.m02*n+i.m06*s+i.m10*r+i.m14,t}static transformQuat(t,e,i){const n=i.w*e.x+i.y*e.z-i.z*e.y,s=i.w*e.y+i.z*e.x-i.x*e.z,r=i.w*e.z+i.x*e.y-i.y*e.x,o=-i.x*e.x-i.y*e.y-i.z*e.z;return t.x=n*i.w+o*-i.x+s*-i.z-r*-i.y,t.y=s*i.w+o*-i.y+r*-i.x-n*-i.z,t.z=r*i.w+o*-i.z+n*-i.y-s*-i.x,t}static transformRTS(t,e,i,n,s){const r=e.x*s.x,o=e.y*s.y,a=e.z*s.z,c=i.w*r+i.y*a-i.z*o,l=i.w*o+i.z*r-i.x*a,h=i.w*a+i.x*o-i.y*r,_=-i.x*r-i.y*o-i.z*a;return t.x=c*i.w+_*-i.x+l*-i.z-h*-i.y+n.x,t.y=l*i.w+_*-i.y+h*-i.x-c*-i.z+n.y,t.z=h*i.w+_*-i.z+c*-i.y-l*-i.x+n.z,t}static transformInverseRTS(t,e,i,n,s){const r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,c=i.w*r-i.y*a+i.z*o,l=i.w*o-i.z*r+i.x*a,h=i.w*a-i.x*o+i.y*r,_=i.x*r+i.y*o+i.z*a;return t.x=(c*i.w+_*i.x+l*i.z-h*i.y)/s.x,t.y=(l*i.w+_*i.y+h*i.x-c*i.z)/s.y,t.z=(h*i.w+_*i.z+c*i.y-l*i.x)/s.z,t}static rotateX(t,e,i,n){const s=e.x-i.x,r=e.y-i.y,o=e.z-i.z,a=Math.cos(n),c=Math.sin(n),l=s,h=r*a-o*c,_=r*c+o*a;return t.x=l+i.x,t.y=h+i.y,t.z=_+i.z,t}static rotateY(t,e,i,n){const s=e.x-i.x,r=e.y-i.y,o=e.z-i.z,a=Math.cos(n),c=Math.sin(n),l=o*c+s*a,h=r,_=o*a-s*c;return t.x=l+i.x,t.y=h+i.y,t.z=_+i.z,t}static rotateZ(t,e,i,n){const s=e.x-i.x,r=e.y-i.y,o=e.z-i.z,a=Math.cos(n),c=Math.sin(n),l=s*a-r*c,h=s*c+r*a,_=o;return t.x=l+i.x,t.y=h+i.y,t.z=_+i.z,t}static toArray(t,e,i=0){return t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t}static fromArray(t,e,i=0){return t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z}static equals(t,e,i=ke){const{x:n,y:s,z:r}=t,{x:o,y:a,z:c}=e;return Math.abs(n-o)<=i*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(s-a)<=i*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(r-c)<=i*Math.max(1,Math.abs(r),Math.abs(c))}static angle(t,e){mi.normalize(pi,t),mi.normalize(fi,e);const i=mi.dot(pi,fi);return i>1?0:i<-1?Math.PI:Math.acos(i)}static projectOnPlane(t,e,i){return mi.subtract(t,e,mi.project(t,e,i))}static project(t,e,i){const n=mi.lengthSqr(i);return n<1e-6?mi.set(t,0,0,0):mi.multiplyScalar(t,i,mi.dot(e,i)/n)}get x(){return this._array[0]}set x(t){this._array[0]=t}get y(){return this._array[1]}set y(t){this._array[1]=t}get z(){return this._array[2]}set z(t){this._array[2]=t}constructor(t,e,i){if(super(),t&&"object"==typeof t)if(ArrayBuffer.isView(t))this._array=t,this._array.fill(0);else{const e=t.array;this._array=di.createFloatArray(3),this._array[0]=e[0],this._array[1]=e[1],this._array[2]=e[2]}else this._array=di.createFloatArray(3),this._array[0]=t||0,this._array[1]=e||0,this._array[2]=i||0}clone(){return new mi(this._array[0],this._array[1],this._array[2])}set(t,e,i){return t&&"object"==typeof t?(this._array[0]=t.x,this._array[1]=t.y,this._array[2]=t.z):(this._array[0]=t||0,this._array[1]=e||0,this._array[2]=i||0),this}equals(t,e=ke){const i=t.array;return Math.abs(this._array[0]-i[0])<=e*Math.max(1,Math.abs(this._array[0]),Math.abs(i[0]))&&Math.abs(this._array[1]-i[1])<=e*Math.max(1,Math.abs(this._array[1]),Math.abs(i[1]))&&Math.abs(this._array[2]-i[2])<=e*Math.max(1,Math.abs(this._array[2]),Math.abs(i[2]))}equals3f(t,e,i,n=ke){return Math.abs(this._array[0]-t)<=n*Math.max(1,Math.abs(this._array[0]),Math.abs(t))&&Math.abs(this._array[1]-e)<=n*Math.max(1,Math.abs(this._array[1]),Math.abs(e))&&Math.abs(this._array[2]-i)<=n*Math.max(1,Math.abs(this._array[2]),Math.abs(i))}strictEquals(t){const e=t.array;return this._array[0]===e[0]&&this._array[1]===e[1]&&this._array[2]===e[2]}strictEquals3f(t,e,i){return this._array[0]===t&&this._array[1]===e&&this._array[2]===i}toString(){return`(${this._array[0].toFixed(2)}, ${this._array[1].toFixed(2)}, ${this._array[2].toFixed(2)})`}lerp(t,e){return this._array[0]+=e*(t.x-this._array[0]),this._array[1]+=e*(t.y-this._array[1]),this._array[2]+=e*(t.z-this._array[2]),this}add(t){const e=t.array;return this._array[0]+=e[0],this._array[1]+=e[1],this._array[2]+=e[2],this}add3f(t,e,i){return this._array[0]+=t,this._array[1]+=e,this._array[2]+=i,this}subtract(t){const e=t.array;return this._array[0]-=e[0],this._array[1]-=e[1],this._array[2]-=e[2],this}subtract3f(t,e,i){return this._array[0]-=t,this._array[1]-=e,this._array[2]-=i,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec3.multiply for vector * vector operation"),this._array[0]*=t,this._array[1]*=t,this._array[2]*=t,this}multiply(t){"object"!=typeof t&&console.warn("should use Vec3.scale for vector * scalar operation");const e=t.array;return this._array[0]*=e[0],this._array[1]*=e[1],this._array[2]*=e[2],this}multiply3f(t,e,i){return this._array[0]*=t,this._array[1]*=e,this._array[2]*=i,this}divide(t){const e=t.array;return this._array[0]/=e[0],this._array[1]/=e[1],this._array[2]/=e[2],this}divide3f(t,e,i){return this._array[0]/=t,this._array[1]/=e,this._array[2]/=i,this}negative(){return this._array[0]=-this._array[0],this._array[1]=-this._array[1],this._array[2]=-this._array[2],this}clampf(t,e){const i=t.array,n=e.array;return this._array[0]=We(this._array[0],i[0],n[0]),this._array[1]=We(this._array[1],i[1],n[1]),this._array[2]=We(this._array[2],i[2],n[2]),this}dot(t){const e=t.array;return this._array[0]*e[0]+this._array[1]*e[1]+this._array[2]*e[2]}cross(t){const e=this._array[0],i=this._array[1],n=this._array[2],s=t.array[0],r=t.array[1],o=t.array[2];return this._array[0]=i*o-n*r,this._array[1]=n*s-e*o,this._array[2]=e*r-i*s,this}length(){return Math.sqrt(this._array[0]*this._array[0]+this._array[1]*this._array[1]+this._array[2]*this._array[2])}lengthSqr(){return this._array[0]*this._array[0]+this._array[1]*this._array[1]+this._array[2]*this._array[2]}normalize(){const t=this._array[0],e=this._array[1],i=this._array[2];let n=t*t+e*e+i*i;return n>0&&(n=1/Math.sqrt(n),this._array[0]=t*n,this._array[1]=e*n,this._array[2]=i*n),this}transformMat4(t){const e=this._array[0],i=this._array[1],n=this._array[2],s=t.array;let r=s[3]*e+s[7]*i+s[11]*n+s[15];return r=r?1/r:1,this._array[0]=(s[0]*e+s[4]*i+s[8]*n+s[12])*r,this._array[1]=(s[1]*e+s[5]*i+s[9]*n+s[13])*r,this._array[2]=(s[2]*e+s[6]*i+s[10]*n+s[14])*r,this}}t("Vec3",mi),mi.UNIT_X=Object.freeze(new mi(1,0,0)),mi.UNIT_Y=Object.freeze(new mi(0,1,0)),mi.UNIT_Z=Object.freeze(new mi(0,0,1)),mi.RIGHT=Object.freeze(new mi(1,0,0)),mi.UP=Object.freeze(new mi(0,1,0)),mi.FORWARD=Object.freeze(new mi(0,0,-1)),mi.ZERO=Object.freeze(new mi(0,0,0)),mi.ONE=Object.freeze(new mi(1,1,1)),mi.NEG_ONE=Object.freeze(new mi(-1,-1,-1));const pi=new mi,fi=new mi;function gi(t,e,i){return new mi(t,e,i)}ci(mi.prototype,["x","y","z"]),Le.fastDefine("cc.Vec3",mi,{x:0,y:0,z:0}),l.Vec3=mi,l.v3=gi;class vi extends di{static clone(t){return new vi(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)}static copy(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t}static set(t,e,i,n,s,r,o,a,c,l){return t.m00=e,t.m01=i,t.m02=n,t.m03=s,t.m04=r,t.m05=o,t.m06=a,t.m07=c,t.m08=l,t}static identity(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static transpose(t,e){if(t===e){const i=e.m01,n=e.m02,s=e.m05;t.m01=e.m03,t.m02=e.m06,t.m03=i,t.m05=e.m07,t.m06=n,t.m07=s}else t.m00=e.m00,t.m01=e.m03,t.m02=e.m06,t.m03=e.m01,t.m04=e.m04,t.m05=e.m07,t.m06=e.m02,t.m07=e.m05,t.m08=e.m08;return t}static invert(t,e){const i=e.m00,n=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,c=e.m06,l=e.m07,h=e.m08,_=h*o-a*l,u=-h*r+a*c,d=l*r-o*c;let m=i*_+n*u+s*d;return 0===m?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t):(m=1/m,t.m00=_*m,t.m01=(-h*n+s*l)*m,t.m02=(a*n-s*o)*m,t.m03=u*m,t.m04=(h*i-s*c)*m,t.m05=(-a*i+s*r)*m,t.m06=d*m,t.m07=(-l*i+n*c)*m,t.m08=(o*i-n*r)*m,t)}static determinant(t){const e=t.m00,i=t.m01,n=t.m02,s=t.m03,r=t.m04,o=t.m05,a=t.m06,c=t.m07,l=t.m08;return e*(l*r-o*c)+i*(-l*s+o*a)+n*(c*s-r*a)}static multiply(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=i.m00,d=i.m01,m=i.m02,p=i.m03,f=i.m04,g=i.m05,v=i.m06,y=i.m07,x=i.m08;return t.m00=u*n+d*o+m*l,t.m01=u*s+d*a+m*h,t.m02=u*r+d*c+m*_,t.m03=p*n+f*o+g*l,t.m04=p*s+f*a+g*h,t.m05=p*r+f*c+g*_,t.m06=v*n+y*o+x*l,t.m07=v*s+y*a+x*h,t.m08=v*r+y*c+x*_,t}static multiplyMat4(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=i.m00,d=i.m01,m=i.m02,p=i.m04,f=i.m05,g=i.m06,v=i.m08,y=i.m09,x=i.m10;return t.m00=u*n+d*o+m*l,t.m01=u*s+d*a+m*h,t.m02=u*r+d*c+m*_,t.m03=p*n+f*o+g*l,t.m04=p*s+f*a+g*h,t.m05=p*r+f*c+g*_,t.m06=v*n+y*o+x*l,t.m07=v*s+y*a+x*h,t.m08=v*r+y*c+x*_,t}static transform(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=i.x,d=i.y;return t.m00=n,t.m01=s,t.m02=r,t.m03=o,t.m04=a,t.m05=c,t.m06=u*n+d*o+l,t.m07=u*s+d*a+h,t.m08=u*r+d*c+_,t}static scale(t,e,i){const n=i.x,s=i.y;return t.m00=n*e.m00,t.m01=n*e.m01,t.m02=n*e.m02,t.m03=s*e.m03,t.m04=s*e.m04,t.m05=s*e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t}static rotate(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=Math.sin(i),d=Math.cos(i);return t.m00=d*n+u*o,t.m01=d*s+u*a,t.m02=d*r+u*c,t.m03=d*o-u*n,t.m04=d*a-u*s,t.m05=d*c-u*r,t.m06=l,t.m07=h,t.m08=_,t}static fromMat4(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m04,t.m04=e.m05,t.m05=e.m06,t.m06=e.m08,t.m07=e.m09,t.m08=e.m10,t}static fromViewUp(t,e,i){return mi.lengthSqr(e)<ke*ke?(vi.identity(t),t):(mi.normalize(yi,mi.cross(yi,i||mi.UNIT_Y,e)),mi.lengthSqr(yi)<ke*ke?(vi.identity(t),t):(mi.cross(xi,e,yi),vi.set(t,yi.x,yi.y,yi.z,xi.x,xi.y,xi.z,e.x,e.y,e.z),t))}static fromTranslation(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=e.x,t.m07=e.y,t.m08=1,t}static fromScaling(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=e.y,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static fromRotation(t,e){const i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=i,t.m02=0,t.m03=-i,t.m04=n,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static fromQuat(t,e){const i=e.x,n=e.y,s=e.z,r=e.w,o=i+i,a=n+n,c=s+s,l=i*o,h=n*o,_=n*a,u=s*o,d=s*a,m=s*c,p=r*o,f=r*a,g=r*c;return t.m00=1-_-m,t.m03=h-g,t.m06=u+f,t.m01=h+g,t.m04=1-l-m,t.m07=d-p,t.m02=u-f,t.m05=d+p,t.m08=1-l-_,t}static inverseTransposeMat4(t,e){const i=e.m00,n=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,c=e.m06,l=e.m07,h=e.m08,_=e.m09,u=e.m10,d=e.m11,m=e.m12,p=e.m13,f=e.m14,g=e.m15,v=i*a-n*o,y=i*c-s*o,x=i*l-r*o,S=n*c-s*a,C=n*l-r*a,A=s*l-r*c,b=h*p-_*m,T=h*f-u*m,E=h*g-d*m,P=_*f-u*p,w=_*g-d*p,I=u*g-d*f;let R=v*I-y*w+x*P+S*E-C*T+A*b;return R?(R=1/R,t.m00=(a*I-c*w+l*P)*R,t.m01=(c*E-o*I-l*T)*R,t.m02=(o*w-a*E+l*b)*R,t.m03=(s*w-n*I-r*P)*R,t.m04=(i*I-s*E+r*T)*R,t.m05=(n*E-i*w-r*b)*R,t.m06=(p*A-f*C+g*S)*R,t.m07=(f*x-m*A-g*y)*R,t.m08=(m*C-p*x+g*v)*R,t):null}static toArray(t,e,i=0){return t[i+0]=e.m00,t[i+1]=e.m01,t[i+2]=e.m02,t[i+3]=e.m03,t[i+4]=e.m04,t[i+5]=e.m05,t[i+6]=e.m06,t[i+7]=e.m07,t[i+8]=e.m08,t}static fromArray(t,e,i=0){return t.m00=e[i+0],t.m01=e[i+1],t.m02=e[i+2],t.m03=e[i+3],t.m04=e[i+4],t.m05=e[i+5],t.m06=e[i+6],t.m07=e[i+7],t.m08=e[i+8],t}static add(t,e,i){return t.m00=e.m00+i.m00,t.m01=e.m01+i.m01,t.m02=e.m02+i.m02,t.m03=e.m03+i.m03,t.m04=e.m04+i.m04,t.m05=e.m05+i.m05,t.m06=e.m06+i.m06,t.m07=e.m07+i.m07,t.m08=e.m08+i.m08,t}static subtract(t,e,i){return t.m00=e.m00-i.m00,t.m01=e.m01-i.m01,t.m02=e.m02-i.m02,t.m03=e.m03-i.m03,t.m04=e.m04-i.m04,t.m05=e.m05-i.m05,t.m06=e.m06-i.m06,t.m07=e.m07-i.m07,t.m08=e.m08-i.m08,t}static multiplyScalar(t,e,i){return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*i,t.m05=e.m05*i,t.m06=e.m06*i,t.m07=e.m07*i,t.m08=e.m08*i,t}static multiplyScalarAndAdd(t,e,i,n){return t.m00=i.m00*n+e.m00,t.m01=i.m01*n+e.m01,t.m02=i.m02*n+e.m02,t.m03=i.m03*n+e.m03,t.m04=i.m04*n+e.m04,t.m05=i.m05*n+e.m05,t.m06=i.m06*n+e.m06,t.m07=i.m07*n+e.m07,t.m08=i.m08*n+e.m08,t}static strictEquals(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08}static equals(t,e,i=ke){return Math.abs(t.m00-e.m00)<=i*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=i*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=i*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=i*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=i*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=i*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=i*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=i*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=i*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))}get m00(){return this._array[0]}set m00(t){this._array[0]=t}get m01(){return this._array[1]}set m01(t){this._array[1]=t}get m02(){return this._array[2]}set m02(t){this._array[2]=t}get m03(){return this._array[3]}set m03(t){this._array[3]=t}get m04(){return this._array[4]}set m04(t){this._array[4]=t}get m05(){return this._array[5]}set m05(t){this._array[5]=t}get m06(){return this._array[6]}set m06(t){this._array[6]=t}get m07(){return this._array[7]}set m07(t){this._array[7]=t}get m08(){return this._array[8]}set m08(t){this._array[8]=t}constructor(t=1,e=0,i=0,n=0,s=1,r=0,o=0,a=0,c=1){if(super(),t&&"object"==typeof t)if(ArrayBuffer.isView(t))this._array=t,this._array.set([1,0,0,0,1,0,0,0,1]);else{const e=t.array;this._array=di.createFloatArray(9),this._array[0]=e[0],this._array[1]=e[1],this._array[2]=e[2],this._array[3]=e[3],this._array[4]=e[4],this._array[5]=e[5],this._array[6]=e[6],this._array[7]=e[7],this._array[8]=e[8]}else this._array=di.createFloatArray(9),this._array[0]=t,this._array[1]=e,this._array[2]=i,this._array[3]=n,this._array[4]=s,this._array[5]=r,this._array[6]=o,this._array[7]=a,this._array[8]=c}clone(){const t=this._array;return new vi(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])}set(t=1,e=0,i=0,n=0,s=1,r=0,o=0,a=0,c=1){if(t&&"object"==typeof t){const e=t.array;this._array[0]=e[0],this._array[1]=e[1],this._array[2]=e[2],this._array[3]=e[3],this._array[4]=e[4],this._array[5]=e[5],this._array[6]=e[6],this._array[7]=e[7],this._array[8]=e[8]}else this._array[0]=t,this._array[1]=e,this._array[2]=i,this._array[3]=n,this._array[4]=s,this._array[5]=r,this._array[6]=o,this._array[7]=a,this._array[8]=c;return this}equals(t,e=ke){const i=t.array;return Math.abs(this._array[0]-i[0])<=e*Math.max(1,Math.abs(this._array[0]),Math.abs(i[0]))&&Math.abs(this._array[1]-i[1])<=e*Math.max(1,Math.abs(this._array[1]),Math.abs(i[1]))&&Math.abs(this._array[2]-i[2])<=e*Math.max(1,Math.abs(this._array[2]),Math.abs(i[2]))&&Math.abs(this._array[3]-i[3])<=e*Math.max(1,Math.abs(this._array[3]),Math.abs(i[3]))&&Math.abs(this._array[4]-i[4])<=e*Math.max(1,Math.abs(this._array[4]),Math.abs(i[4]))&&Math.abs(this._array[5]-i[5])<=e*Math.max(1,Math.abs(this._array[5]),Math.abs(i[5]))&&Math.abs(this._array[6]-i[6])<=e*Math.max(1,Math.abs(this._array[6]),Math.abs(i[6]))&&Math.abs(this._array[7]-i[7])<=e*Math.max(1,Math.abs(this._array[7]),Math.abs(i[7]))&&Math.abs(this._array[8]-i[8])<=e*Math.max(1,Math.abs(this._array[8]),Math.abs(i[8]))}strictEquals(t){const e=t.array;return this._array[0]===e[0]&&this._array[1]===e[1]&&this._array[2]===e[2]&&this._array[3]===e[3]&&this._array[4]===e[4]&&this._array[5]===e[5]&&this._array[6]===e[6]&&this._array[7]===e[7]&&this._array[8]===e[8]}toString(){return`[\n${this._array[0]}, ${this._array[1]}, ${this._array[2]},\n${this._array[3]},\n${this._array[4]}, ${this._array[5]},\n${this._array[6]}, ${this._array[7]},\n${this._array[8]}\n]`}identity(){return this._array[0]=1,this._array[1]=0,this._array[2]=0,this._array[3]=0,this._array[4]=1,this._array[5]=0,this._array[6]=0,this._array[7]=0,this._array[8]=1,this}transpose(){const t=this._array[1],e=this._array[2],i=this._array[5];return this._array[1]=this._array[3],this._array[2]=this._array[6],this._array[3]=t,this._array[5]=this._array[7],this._array[6]=e,this._array[7]=i,this}invert(){const t=this._array[0],e=this._array[1],i=this._array[2],n=this._array[3],s=this._array[4],r=this._array[5],o=this._array[6],a=this._array[7],c=this._array[8],l=c*s-r*a,h=-c*n+r*o,_=a*n-s*o;let u=t*l+e*h+i*_;return 0===u?(this.set(0,0,0,0,0,0,0,0,0),this):(u=1/u,this._array[0]=l*u,this._array[1]=(-c*e+i*a)*u,this._array[2]=(r*e-i*s)*u,this._array[3]=h*u,this._array[4]=(c*t-i*o)*u,this._array[5]=(-r*t+i*n)*u,this._array[6]=_*u,this._array[7]=(-a*t+e*o)*u,this._array[8]=(s*t-e*n)*u,this)}determinant(){const t=this._array[0],e=this._array[1],i=this._array[2],n=this._array[3],s=this._array[4],r=this._array[5],o=this._array[6],a=this._array[7],c=this._array[8];return t*(c*s-r*a)+e*(-c*n+r*o)+i*(a*n-s*o)}add(t){const e=t.array;return this._array[0]+=e[0],this._array[1]+=e[1],this._array[2]+=e[2],this._array[3]+=e[3],this._array[4]+=e[4],this._array[5]+=e[5],this._array[6]+=e[6],this._array[7]+=e[7],this._array[8]+=e[8],this}subtract(t){const e=t.array;return this._array[0]-=e[0],this._array[1]-=e[1],this._array[2]-=e[2],this._array[3]-=e[3],this._array[4]-=e[4],this._array[5]-=e[5],this._array[6]-=e[6],this._array[7]-=e[7],this._array[8]-=e[8],this}multiply(t){const e=this._array[0],i=this._array[1],n=this._array[2],s=this._array[3],r=this._array[4],o=this._array[5],a=this._array[6],c=this._array[7],l=this._array[8],h=t.array,_=h[0],u=h[1],d=h[2],m=h[3],p=h[4],f=h[5],g=h[6],v=h[7],y=h[8];return this._array[0]=_*e+u*s+d*a,this._array[1]=_*i+u*r+d*c,this._array[2]=_*n+u*o+d*l,this._array[3]=m*e+p*s+f*a,this._array[4]=m*i+p*r+f*c,this._array[5]=m*n+p*o+f*l,this._array[6]=g*e+v*s+y*a,this._array[7]=g*i+v*r+y*c,this._array[8]=g*n+v*o+y*l,this}multiplyScalar(t){return this._array[0]*=t,this._array[1]*=t,this._array[2]*=t,this._array[3]*=t,this._array[4]*=t,this._array[5]*=t,this._array[6]*=t,this._array[7]*=t,this._array[8]*=t,this}scale(t){const e=t.array[0],i=t.array[1];return this._array[0]*=e,this._array[1]*=e,this._array[2]*=e,this._array[3]*=i,this._array[4]*=i,this._array[5]*=i,this}rotate(t){const e=this._array[0],i=this._array[1],n=this._array[2],s=this._array[3],r=this._array[4],o=this._array[5],a=this._array[6],c=this._array[7],l=this._array[8],h=Math.sin(t),_=Math.cos(t);return this._array[0]=_*e+h*s,this._array[1]=_*i+h*r,this._array[2]=_*n+h*o,this._array[3]=_*s-h*e,this._array[4]=_*r-h*i,this._array[5]=_*o-h*n,this._array[6]=a,this._array[7]=c,this._array[8]=l,this}fromQuat(t){const e=t.x,i=t.y,n=t.z,s=t.w,r=e+e,o=i+i,a=n+n,c=e*r,l=i*r,h=i*o,_=n*r,u=n*o,d=n*a,m=s*r,p=s*o,f=s*a;return this._array[0]=1-h-d,this._array[3]=l-f,this._array[6]=_+p,this._array[1]=l+f,this._array[4]=1-c-d,this._array[7]=u-m,this._array[2]=_-p,this._array[5]=u+m,this._array[8]=1-c-h,this}}t("Mat3",vi),vi.IDENTITY=Object.freeze(new vi);const yi=new mi,xi=new mi;ci(vi.prototype,["m00","m01","m02","m03","m04","m05","m06","m07","m08"]),Le.fastDefine("cc.Mat3",vi,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),l.Mat3=vi;class Si extends di{static clone(t){return new Si(t.x,t.y,t.z,t.w)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}static set(t,e,i,n,s){return t.x=e,t.y=i,t.z=n,t.w=s,t}static identity(t){return t.x=0,t.y=0,t.z=0,t.w=1,t}static rotationTo(t,e,i){const n=mi.dot(e,i);return n<-.999999?(mi.cross(bi,mi.UNIT_X,e),bi.length()<1e-6&&mi.cross(bi,mi.UNIT_Y,e),mi.normalize(bi,bi),Si.fromAxisAngle(t,bi,Math.PI),t):n>.999999?(t.x=0,t.y=0,t.z=0,t.w=1,t):(mi.cross(bi,e,i),t.x=bi.x,t.y=bi.y,t.z=bi.z,t.w=1+n,Si.normalize(t,t))}static getAxisAngle(t,e){const i=2*Math.acos(e.w),n=Math.sin(i/2);return 0!==n?(t.x=e.x/n,t.y=e.y/n,t.z=e.z/n):(t.x=1,t.y=0,t.z=0),i}static multiply(t,e,i){const n=e.x*i.w+e.w*i.x+e.y*i.z-e.z*i.y,s=e.y*i.w+e.w*i.y+e.z*i.x-e.x*i.z,r=e.z*i.w+e.w*i.z+e.x*i.y-e.y*i.x,o=e.w*i.w-e.x*i.x-e.y*i.y-e.z*i.z;return t.x=n,t.y=s,t.z=r,t.w=o,t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i,t}static scaleAndAdd(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t.w=e.w+i.w*n,t}static rotateX(t,e,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:r,y:o,z:a,w:c}=e;return t.x=r*s+c*n,t.y=o*s+a*n,t.z=a*s-o*n,t.w=c*s-r*n,t}static rotateY(t,e,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:r,y:o,z:a,w:c}=e;return t.x=r*s-a*n,t.y=o*s+c*n,t.z=a*s+r*n,t.w=c*s-o*n,t}static rotateZ(t,e,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:r,y:o,z:a,w:c}=e;return t.x=r*s+o*n,t.y=o*s-r*n,t.z=a*s+c*n,t.w=c*s-a*n,t}static rotateAround(t,e,i,n){return Si.invert(Ci,e),mi.transformQuat(bi,i,Ci),Si.fromAxisAngle(Ci,bi,n),Si.multiply(t,e,Ci),t}static rotateAroundLocal(t,e,i,n){return Si.fromAxisAngle(Ci,i,n),Si.multiply(t,e,Ci),t}static calculateW(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=Math.sqrt(Math.abs(1-e.x*e.x-e.y*e.y-e.z*e.z)),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static lerp(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t.w=e.w+n*(i.w-e.w),t}static slerp(t,e,i,n){let s=0,r=0,o=i.x,a=i.y,c=i.z,l=i.w,h=e.x*i.x+e.y*i.y+e.z*i.z+e.w*i.w;if(h<0&&(h=-h,o=-o,a=-a,c=-c,l=-l),1-h>1e-6){const t=Math.acos(h),e=Math.sin(t);s=Math.sin((1-n)*t)/e,r=Math.sin(n*t)/e}else s=1-n,r=n;return t.x=s*e.x+r*o,t.y=s*e.y+r*a,t.z=s*e.z+r*c,t.w=s*e.w+r*l,t}static sqlerp(t,e,i,n,s,r){return Si.slerp(Ci,e,s,r),Si.slerp(Ai,i,n,r),Si.slerp(t,Ci,Ai,2*r*(1-r)),t}static invert(t,e){const i=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w,n=i?1/i:0;return t.x=-e.x*n,t.y=-e.y*n,t.z=-e.z*n,t.w=e.w*n,t}static conjugate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w,t}static len(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w)}static lengthSqr(t){return t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w}static normalize(t,e){let i=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;return i>0&&(i=1/Math.sqrt(i),t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i),t}static fromAxes(t,e,i,n){return vi.set(Ti,e.x,e.y,e.z,i.x,i.y,i.z,n.x,n.y,n.z),Si.normalize(t,Si.fromMat3(t,Ti))}static fromViewUp(t,e,i){return vi.fromViewUp(Ti,e,i),Si.normalize(t,Si.fromMat3(t,Ti))}static fromAxisAngle(t,e,i){i*=.5;const n=Math.sin(i);return t.x=n*e.x,t.y=n*e.y,t.z=n*e.z,t.w=Math.cos(i),t}static fromMat3(t,e){const{m00:i,m03:n,m06:s,m01:r,m04:o,m07:a,m02:c,m05:l,m08:h}=e,_=i+o+h;if(_>0){const e=.5/Math.sqrt(_+1);t.w=.25/e,t.x=(l-a)*e,t.y=(s-c)*e,t.z=(r-n)*e}else if(i>o&&i>h){const e=2*Math.sqrt(1+i-o-h);t.w=(l-a)/e,t.x=.25*e,t.y=(n+r)/e,t.z=(s+c)/e}else if(o>h){const e=2*Math.sqrt(1+o-i-h);t.w=(s-c)/e,t.x=(n+r)/e,t.y=.25*e,t.z=(a+l)/e}else{const e=2*Math.sqrt(1+h-i-o);t.w=(r-n)/e,t.x=(s+c)/e,t.y=(a+l)/e,t.z=.25*e}return t}static fromEuler(t,e,i,n){e*=Ei,i*=Ei,n*=Ei;const s=Math.sin(e),r=Math.cos(e),o=Math.sin(i),a=Math.cos(i),c=Math.sin(n),l=Math.cos(n);return t.x=s*a*l+r*o*c,t.y=r*o*l+s*a*c,t.z=r*a*c-s*o*l,t.w=r*a*l-s*o*c,t}static fromAngleZ(t,e){return e*=Ei,t.x=t.y=0,t.z=Math.sin(e),t.w=Math.cos(e),t}static toAxisX(t,e){const i=2*e.y,n=2*e.z;return t.x=1-i*e.y-n*e.z,t.y=i*e.x+n*e.w,t.z=n*e.x+i*e.w,t}static toAxisY(t,e){const i=2*e.x,n=2*e.y,s=2*e.z;return t.x=n*e.x-s*e.w,t.y=1-i*e.x-s*e.z,t.z=s*e.y+i*e.w,t}static toAxisZ(t,e){const i=2*e.x,n=2*e.y,s=2*e.z;return t.x=s*e.x-n*e.w,t.y=s*e.y-i*e.w,t.z=1-i*e.x-n*e.y,t}static toEuler(t,e,i){const{x:n,y:s,z:r,w:o}=e;let a=0,c=0,l=0;const h=n*s+r*o;if(h>.499999)a=0,c=Ke(2*Math.atan2(n,o)),l=90;else if(h<-.499999)a=0,c=-Ke(2*Math.atan2(n,o)),l=-90;else{const t=n*n,e=s*s,_=r*r;a=Ke(Math.atan2(2*n*o-2*s*r,1-2*t-2*_)),c=Ke(Math.atan2(2*s*o-2*n*r,1-2*e-2*_)),l=Ke(Math.asin(2*h)),i&&(a=-180*Math.sign(a+1e-6)+a,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return t.x=a,t.y=c,t.z=l,t}static toArray(t,e,i=0){return t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t[i+3]=e.w,t}static fromArray(t,e,i=0){return t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t.w=e[i+3],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w}static equals(t,e,i=ke){return Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=i*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=i*Math.max(1,Math.abs(t.w),Math.abs(e.w))}get x(){return this._array[0]}set x(t){this._array[0]=t}get y(){return this._array[1]}set y(t){this._array[1]=t}get z(){return this._array[2]}set z(t){this._array[2]=t}get w(){return this._array[3]}set w(t){this._array[3]=t}constructor(t,e,i,n){if(super(),t&&"object"==typeof t)if(ArrayBuffer.isView(t))this._array=t,this._array.fill(0),this._array[3]=1;else{const e=t.array;this._array=di.createFloatArray(4),this._array[0]=e[0],this._array[1]=e[1],this._array[2]=e[2],this._array[3]=e[3]}else this._array=di.createFloatArray(4),this._array[0]=t||0,this._array[1]=e||0,this._array[2]=i||0,this._array[3]=null!=n?n:1}clone(){return new Si(this._array[0],this._array[1],this._array[2],this._array[3])}set(t,e,i,n){if(t&&"object"==typeof t){const e=t.array;this._array[0]=e[0],this._array[1]=e[1],this._array[2]=e[2],this._array[3]=e[3]}else this._array[0]=t||0,this._array[1]=e||0,this._array[2]=i||0,this._array[3]=null!=n?n:1;return this}equals(t,e=ke){const i=t.array;return Math.abs(this._array[0]-i[0])<=e*Math.max(1,Math.abs(this._array[0]),Math.abs(i[0]))&&Math.abs(this._array[1]-i[1])<=e*Math.max(1,Math.abs(this._array[1]),Math.abs(i[1]))&&Math.abs(this._array[2]-i[2])<=e*Math.max(1,Math.abs(this._array[2]),Math.abs(i[2]))&&Math.abs(this._array[3]-i[3])<=e*Math.max(1,Math.abs(this._array[3]),Math.abs(i[3]))}strictEquals(t){const e=t.array;return t&&this._array[0]===e[0]&&this._array[1]===e[1]&&this._array[2]===e[2]&&this._array[3]===e[3]}getEulerAngles(t){return Si.toEuler(t,this)}lerp(t,e){const i=t.array;return this._array[0]+=e*(i[0]-this._array[0]),this._array[1]+=e*(i[1]-this._array[1]),this._array[2]+=e*(i[2]-this._array[2]),this._array[3]+=e*(i[3]-this._array[3]),this}slerp(t,e){return Si.slerp(this,this,t,e)}length(){const t=this._array;return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3])}lengthSqr(){const t=this._array;return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3]}}t("Quat",Si),Si.IDENTITY=Object.freeze(new Si),ci(Si.prototype,["x","y","z","w"]);const Ci=new Si,Ai=new Si,bi=new mi,Ti=new vi,Ei=.5*Math.PI/180;function Pi(t=0,e=0,i=0,n=1){return new Si(t,e,i,n)}Le.fastDefine("cc.Quat",Si,{x:0,y:0,z:0,w:1}),l.Quat=Si,l.quat=Pi;const wi=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]);class Ii extends di{static clone(t){return new Ii(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)}static copy(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t}static set(t,e,i,n,s,r,o,a,c,l,h,_,u,d,m,p,f){return t.m00=e,t.m01=i,t.m02=n,t.m03=s,t.m04=r,t.m05=o,t.m06=a,t.m07=c,t.m08=l,t.m09=h,t.m10=_,t.m11=u,t.m12=d,t.m13=m,t.m14=p,t.m15=f,t}static identity(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static transpose(t,e){if(t===e){const i=e.m01,n=e.m02,s=e.m03,r=e.m06,o=e.m07,a=e.m11;t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=i,t.m06=e.m09,t.m07=e.m13,t.m08=n,t.m09=r,t.m11=e.m14,t.m12=s,t.m13=o,t.m14=a}else t.m00=e.m00,t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=e.m01,t.m05=e.m05,t.m06=e.m09,t.m07=e.m13,t.m08=e.m02,t.m09=e.m06,t.m10=e.m10,t.m11=e.m14,t.m12=e.m03,t.m13=e.m07,t.m14=e.m11,t.m15=e.m15;return t}static invert(t,e){const i=e.m00,n=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,c=e.m06,l=e.m07,h=e.m08,_=e.m09,u=e.m10,d=e.m11,m=e.m12,p=e.m13,f=e.m14,g=e.m15,v=i*a-n*o,y=i*c-s*o,x=i*l-r*o,S=n*c-s*a,C=n*l-r*a,A=s*l-r*c,b=h*p-_*m,T=h*f-u*m,E=h*g-d*m,P=_*f-u*p,w=_*g-d*p,I=u*g-d*f;let R=v*I-y*w+x*P+S*E-C*T+A*b;return 0===R?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=0,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=0,t):(R=1/R,t.m00=(a*I-c*w+l*P)*R,t.m01=(s*w-n*I-r*P)*R,t.m02=(p*A-f*C+g*S)*R,t.m03=(u*C-_*A-d*S)*R,t.m04=(c*E-o*I-l*T)*R,t.m05=(i*I-s*E+r*T)*R,t.m06=(f*x-m*A-g*y)*R,t.m07=(h*A-u*x+d*y)*R,t.m08=(o*w-a*E+l*b)*R,t.m09=(n*E-i*w-r*b)*R,t.m10=(m*C-p*x+g*v)*R,t.m11=(_*x-h*C-d*v)*R,t.m12=(a*T-o*P-c*b)*R,t.m13=(i*P-n*T+s*b)*R,t.m14=(p*y-m*S-f*v)*R,t.m15=(h*S-_*y+u*v)*R,t)}static determinant(t){const e=t.m00,i=t.m01,n=t.m02,s=t.m03,r=t.m04,o=t.m05,a=t.m06,c=t.m07,l=t.m08,h=t.m09,_=t.m10,u=t.m11,d=t.m12,m=t.m13,p=t.m14,f=t.m15;return(e*o-i*r)*(_*f-u*p)-(e*a-n*r)*(h*f-u*m)+(e*c-s*r)*(h*p-_*m)+(i*a-n*o)*(l*f-u*d)-(i*c-s*o)*(l*p-_*d)+(n*c-s*a)*(l*m-h*d)}static multiply(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=e.m09,d=e.m10,m=e.m11,p=e.m12,f=e.m13,g=e.m14,v=e.m15;let y=i.m00,x=i.m01,S=i.m02,C=i.m03;return t.m00=y*n+x*a+S*_+C*p,t.m01=y*s+x*c+S*u+C*f,t.m02=y*r+x*l+S*d+C*g,t.m03=y*o+x*h+S*m+C*v,y=i.m04,x=i.m05,S=i.m06,C=i.m07,t.m04=y*n+x*a+S*_+C*p,t.m05=y*s+x*c+S*u+C*f,t.m06=y*r+x*l+S*d+C*g,t.m07=y*o+x*h+S*m+C*v,y=i.m08,x=i.m09,S=i.m10,C=i.m11,t.m08=y*n+x*a+S*_+C*p,t.m09=y*s+x*c+S*u+C*f,t.m10=y*r+x*l+S*d+C*g,t.m11=y*o+x*h+S*m+C*v,y=i.m12,x=i.m13,S=i.m14,C=i.m15,t.m12=y*n+x*a+S*_+C*p,t.m13=y*s+x*c+S*u+C*f,t.m14=y*r+x*l+S*d+C*g,t.m15=y*o+x*h+S*m+C*v,t}static transform(t,e,i){const n=i.x,s=i.y,r=i.z;if(e===t)t.m12=e.m00*n+e.m04*s+e.m08*r+e.m12,t.m13=e.m01*n+e.m05*s+e.m09*r+e.m13,t.m14=e.m02*n+e.m06*s+e.m10*r+e.m14,t.m15=e.m03*n+e.m07*s+e.m11*r+e.m15;else{const i=e.m00,o=e.m01,a=e.m02,c=e.m03,l=e.m04,h=e.m05,_=e.m06,u=e.m07,d=e.m08,m=e.m09,p=e.m10,f=e.m11;e.m12,e.m13,e.m14,e.m15,t.m00=i,t.m01=o,t.m02=a,t.m03=c,t.m04=l,t.m05=h,t.m06=_,t.m07=u,t.m08=d,t.m09=m,t.m10=p,t.m11=f,t.m12=i*n+l*s+d*r+e.m12,t.m13=o*n+h*s+m*r+e.m13,t.m14=a*n+_*s+p*r+e.m14,t.m15=c*n+u*s+f*r+e.m15}return t}static translate(t,e,i){return console.warn("function changed"),e===t?(t.m12+=i.x,t.m13+=i.y,t.m14+=i.z):(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12+=i.x,t.m13+=i.y,t.m14+=i.z,t.m15=e.m15),t}static scale(t,e,i){const n=i.x,s=i.y,r=i.z;return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*s,t.m05=e.m05*s,t.m06=e.m06*s,t.m07=e.m07*s,t.m08=e.m08*r,t.m09=e.m09*r,t.m10=e.m10*r,t.m11=e.m11*r,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t}static rotate(t,e,i,n){let s=n.x,r=n.y,o=n.z,a=Math.sqrt(s*s+r*r+o*o);if(Math.abs(a)<ke)return null;a=1/a,s*=a,r*=a,o*=a;const c=Math.sin(i),l=Math.cos(i),h=1-l,_=e.m00,u=e.m01,d=e.m02,m=e.m03,p=e.m04,f=e.m05,g=e.m06,v=e.m07,y=e.m08,x=e.m09,S=e.m10,C=e.m11,A=s*s*h+l,b=r*s*h+o*c,T=o*s*h-r*c,E=s*r*h-o*c,P=r*r*h+l,w=o*r*h+s*c,I=s*o*h+r*c,R=r*o*h-s*c,D=o*o*h+l;return t.m00=_*A+p*b+y*T,t.m01=u*A+f*b+x*T,t.m02=d*A+g*b+S*T,t.m03=m*A+v*b+C*T,t.m04=_*E+p*P+y*w,t.m05=u*E+f*P+x*w,t.m06=d*E+g*P+S*w,t.m07=m*E+v*P+C*w,t.m08=_*I+p*R+y*D,t.m09=u*I+f*R+x*D,t.m10=d*I+g*R+S*D,t.m11=m*I+v*R+C*D,e!==t&&(t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t}static rotateX(t,e,i){const n=Math.sin(i),s=Math.cos(i),r=e.m04,o=e.m05,a=e.m06,c=e.m07,l=e.m08,h=e.m09,_=e.m10,u=e.m11;return e!==t&&(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m04=r*s+l*n,t.m05=o*s+h*n,t.m06=a*s+_*n,t.m07=c*s+u*n,t.m08=l*s-r*n,t.m09=h*s-o*n,t.m10=_*s-a*n,t.m11=u*s-c*n,t}static rotateY(t,e,i){const n=Math.sin(i),s=Math.cos(i),r=e.m00,o=e.m01,a=e.m02,c=e.m03,l=e.m08,h=e.m09,_=e.m10,u=e.m11;return e!==t&&(t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=r*s-l*n,t.m01=o*s-h*n,t.m02=a*s-_*n,t.m03=c*s-u*n,t.m08=r*n+l*s,t.m09=o*n+h*s,t.m10=a*n+_*s,t.m11=c*n+u*s,t}static rotateZ(t,e,i){const n=Math.sin(i),s=Math.cos(i),r=e.m00,o=e.m01,a=e.m02,c=e.m03,l=e.m04,h=e.m05,_=e.m06,u=e.m07;return e!==t&&(t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=r*s+l*n,t.m01=o*s+h*n,t.m02=a*s+_*n,t.m03=c*s+u*n,t.m04=l*s-r*n,t.m05=h*s-o*n,t.m06=_*s-a*n,t.m07=u*s-c*n,t}static fromTranslation(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=e.x,t.m13=e.y,t.m14=e.z,t.m15=1,t}static fromScaling(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=e.y,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=e.z,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromRotation(t,e,i){let n=i.x,s=i.y,r=i.z,o=Math.sqrt(n*n+s*s+r*r);if(Math.abs(o)<ke)return null;o=1/o,n*=o,s*=o,r*=o;const a=Math.sin(e),c=Math.cos(e),l=1-c;return t.m00=n*n*l+c,t.m01=s*n*l+r*a,t.m02=r*n*l-s*a,t.m03=0,t.m04=n*s*l-r*a,t.m05=s*s*l+c,t.m06=r*s*l+n*a,t.m07=0,t.m08=n*r*l+s*a,t.m09=s*r*l-n*a,t.m10=r*r*l+c,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromXRotation(t,e){const i=Math.sin(e),n=Math.cos(e);return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=n,t.m06=i,t.m07=0,t.m08=0,t.m09=-i,t.m10=n,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromYRotation(t,e){const i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=0,t.m02=-i,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=i,t.m09=0,t.m10=n,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromZRotation(t,e){const i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=i,t.m02=0,t.m03=0,t.m04=-i,t.m05=n,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromRT(t,e,i){const n=e.x,s=e.y,r=e.z,o=e.w,a=n+n,c=s+s,l=r+r,h=n*a,_=n*c,u=n*l,d=s*c,m=s*l,p=r*l,f=o*a,g=o*c,v=o*l;return t.m00=1-(d+p),t.m01=_+v,t.m02=u-g,t.m03=0,t.m04=_-v,t.m05=1-(h+p),t.m06=m+f,t.m07=0,t.m08=u+g,t.m09=m-f,t.m10=1-(h+d),t.m11=0,t.m12=i.x,t.m13=i.y,t.m14=i.z,t.m15=1,t}static getTranslation(t,e){return t.x=e.m12,t.y=e.m13,t.z=e.m14,t}static getScaling(t,e){const i=Di.m00=e.m00,n=Di.m01=e.m01,s=Di.m02=e.m02,r=Di.m03=e.m04,o=Di.m04=e.m05,a=Di.m05=e.m06,c=Di.m06=e.m08,l=Di.m07=e.m09,h=Di.m08=e.m10;return t.x=Math.sqrt(i*i+n*n+s*s),t.y=Math.sqrt(r*r+o*o+a*a),t.z=Math.sqrt(c*c+l*l+h*h),vi.determinant(Di)<0&&(t.x*=-1),t}static getRotation(t,e){const i=e.m00+e.m05+e.m10;let n=0;return i>0?(n=2*Math.sqrt(i+1),t.w=.25*n,t.x=(e.m06-e.m09)/n,t.y=(e.m08-e.m02)/n,t.z=(e.m01-e.m04)/n):e.m00>e.m05&&e.m00>e.m10?(n=2*Math.sqrt(1+e.m00-e.m05-e.m10),t.w=(e.m06-e.m09)/n,t.x=.25*n,t.y=(e.m01+e.m04)/n,t.z=(e.m08+e.m02)/n):e.m05>e.m10?(n=2*Math.sqrt(1+e.m05-e.m00-e.m10),t.w=(e.m08-e.m02)/n,t.x=(e.m01+e.m04)/n,t.y=.25*n,t.z=(e.m06+e.m09)/n):(n=2*Math.sqrt(1+e.m10-e.m00-e.m05),t.w=(e.m01-e.m04)/n,t.x=(e.m08+e.m02)/n,t.y=(e.m06+e.m09)/n,t.z=.25*n),t}static toRTS(t,e,i,n){n.x=mi.set(Ri,t.m00,t.m01,t.m02).length(),Di.m00=t.m00/n.x,Di.m01=t.m01/n.x,Di.m02=t.m02/n.x,n.y=mi.set(Ri,t.m04,t.m05,t.m06).length(),Di.m03=t.m04/n.y,Di.m04=t.m05/n.y,Di.m05=t.m06/n.y,n.z=mi.set(Ri,t.m08,t.m09,t.m10).length(),Di.m06=t.m08/n.z,Di.m07=t.m09/n.z,Di.m08=t.m10/n.z,vi.determinant(Di)<0&&(n.x*=-1,Di.m00*=-1,Di.m01*=-1,Di.m02*=-1),Si.fromMat3(e,Di),mi.set(i,t.m12,t.m13,t.m14)}static fromRTS(t,e,i,n){const s=e.x,r=e.y,o=e.z,a=e.w,c=s+s,l=r+r,h=o+o,_=s*c,u=s*l,d=s*h,m=r*l,p=r*h,f=o*h,g=a*c,v=a*l,y=a*h,x=n.x,S=n.y,C=n.z;return t.m00=(1-(m+f))*x,t.m01=(u+y)*x,t.m02=(d-v)*x,t.m03=0,t.m04=(u-y)*S,t.m05=(1-(_+f))*S,t.m06=(p+g)*S,t.m07=0,t.m08=(d+v)*C,t.m09=(p-g)*C,t.m10=(1-(_+m))*C,t.m11=0,t.m12=i.x,t.m13=i.y,t.m14=i.z,t.m15=1,t}static fromRTSOrigin(t,e,i,n,s){const r=e.x,o=e.y,a=e.z,c=e.w,l=r+r,h=o+o,_=a+a,u=r*l,d=r*h,m=r*_,p=o*h,f=o*_,g=a*_,v=c*l,y=c*h,x=c*_,S=n.x,C=n.y,A=n.z,b=s.x,T=s.y,E=s.z;return t.m00=(1-(p+g))*S,t.m01=(d+x)*S,t.m02=(m-y)*S,t.m03=0,t.m04=(d-x)*C,t.m05=(1-(u+g))*C,t.m06=(f+v)*C,t.m07=0,t.m08=(m+y)*A,t.m09=(f-v)*A,t.m10=(1-(u+p))*A,t.m11=0,t.m12=i.x+b-(t.m00*b+t.m04*T+t.m08*E),t.m13=i.y+T-(t.m01*b+t.m05*T+t.m09*E),t.m14=i.z+E-(t.m02*b+t.m06*T+t.m10*E),t.m15=1,t}static fromQuat(t,e){const i=e.x,n=e.y,s=e.z,r=e.w,o=i+i,a=n+n,c=s+s,l=i*o,h=n*o,_=n*a,u=s*o,d=s*a,m=s*c,p=r*o,f=r*a,g=r*c;return t.m00=1-_-m,t.m01=h+g,t.m02=u-f,t.m03=0,t.m04=h-g,t.m05=1-l-m,t.m06=d+p,t.m07=0,t.m08=u+f,t.m09=d-p,t.m10=1-l-_,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static frustum(t,e,i,n,s,r,o){const a=1/(i-e),c=1/(s-n),l=1/(r-o);return t.m00=2*r*a,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=2*r*c,t.m06=0,t.m07=0,t.m08=(i+e)*a,t.m09=(s+n)*c,t.m10=(o+r)*l,t.m11=-1,t.m12=0,t.m13=0,t.m14=o*r*2*l,t.m15=0,t}static perspective(t,e,i,n,s,r=!0,o=-1,a=1,c=0){const l=1/Math.tan(e/2),h=1/(n-s),_=r?l/i:l,u=(r?l:l*i)*a,d=wi[c];return t.m00=_*d[0],t.m01=_*d[1],t.m02=0,t.m03=0,t.m04=u*d[2],t.m05=u*d[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=(s-o*n)*h,t.m11=-1,t.m12=0,t.m13=0,t.m14=s*n*h*(1-o),t.m15=0,t}static ortho(t,e,i,n,s,r,o,a=-1,c=1,l=0){const h=1/(e-i),_=1/(n-s)*c,u=1/(r-o),d=-2*h,m=-2*_,p=(e+i)*h,f=(s+n)*_,g=wi[l];return t.m00=d*g[0],t.m01=d*g[1],t.m02=0,t.m03=0,t.m04=m*g[2],t.m05=m*g[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=u*(1-a),t.m11=0,t.m12=p*g[0]+f*g[2],t.m13=p*g[1]+f*g[3],t.m14=(r-a*o)*u,t.m15=1,t}static lookAt(t,e,i,n){const s=e.x,r=e.y,o=e.z,a=n.x,c=n.y,l=n.z;let h=s-i.x,_=r-i.y,u=o-i.z,d=1/Math.sqrt(h*h+_*_+u*u);h*=d,_*=d,u*=d;let m=c*u-l*_,p=l*h-a*u,f=a*_-c*h;d=1/Math.sqrt(m*m+p*p+f*f),m*=d,p*=d,f*=d;const g=_*f-u*p,v=u*m-h*f,y=h*p-_*m;return t.m00=m,t.m01=g,t.m02=h,t.m03=0,t.m04=p,t.m05=v,t.m06=_,t.m07=0,t.m08=f,t.m09=y,t.m10=u,t.m11=0,t.m12=-(m*s+p*r+f*o),t.m13=-(g*s+v*r+y*o),t.m14=-(h*s+_*r+u*o),t.m15=1,t}static inverseTranspose(t,e){const i=e.m00,n=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,c=e.m06,l=e.m07,h=e.m08,_=e.m09,u=e.m10,d=e.m11,m=e.m12,p=e.m13,f=e.m14,g=e.m15,v=i*a-n*o,y=i*c-s*o,x=i*l-r*o,S=n*c-s*a,C=n*l-r*a,A=s*l-r*c,b=h*p-_*m,T=h*f-u*m,E=h*g-d*m,P=_*f-u*p,w=_*g-d*p,I=u*g-d*f;let R=v*I-y*w+x*P+S*E-C*T+A*b;return R?(R=1/R,t.m00=(a*I-c*w+l*P)*R,t.m01=(c*E-o*I-l*T)*R,t.m02=(o*w-a*E+l*b)*R,t.m03=0,t.m04=(s*w-n*I-r*P)*R,t.m05=(i*I-s*E+r*T)*R,t.m06=(n*E-i*w-r*b)*R,t.m07=0,t.m08=(p*A-f*C+g*S)*R,t.m09=(f*x-m*A-g*y)*R,t.m10=(m*C-p*x+g*v)*R,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t):null}static toArray(t,e,i=0){return t[i+0]=e.m00,t[i+1]=e.m01,t[i+2]=e.m02,t[i+3]=e.m03,t[i+4]=e.m04,t[i+5]=e.m05,t[i+6]=e.m06,t[i+7]=e.m07,t[i+8]=e.m08,t[i+9]=e.m09,t[i+10]=e.m10,t[i+11]=e.m11,t[i+12]=e.m12,t[i+13]=e.m13,t[i+14]=e.m14,t[i+15]=e.m15,t}static fromArray(t,e,i=0){return t.m00=e[i+0],t.m01=e[i+1],t.m02=e[i+2],t.m03=e[i+3],t.m04=e[i+4],t.m05=e[i+5],t.m06=e[i+6],t.m07=e[i+7],t.m08=e[i+8],t.m09=e[i+9],t.m10=e[i+10],t.m11=e[i+11],t.m12=e[i+12],t.m13=e[i+13],t.m14=e[i+14],t.m15=e[i+15],t}static add(t,e,i){return t.m00=e.m00+i.m00,t.m01=e.m01+i.m01,t.m02=e.m02+i.m02,t.m03=e.m03+i.m03,t.m04=e.m04+i.m04,t.m05=e.m05+i.m05,t.m06=e.m06+i.m06,t.m07=e.m07+i.m07,t.m08=e.m08+i.m08,t.m09=e.m09+i.m09,t.m10=e.m10+i.m10,t.m11=e.m11+i.m11,t.m12=e.m12+i.m12,t.m13=e.m13+i.m13,t.m14=e.m14+i.m14,t.m15=e.m15+i.m15,t}static subtract(t,e,i){return t.m00=e.m00-i.m00,t.m01=e.m01-i.m01,t.m02=e.m02-i.m02,t.m03=e.m03-i.m03,t.m04=e.m04-i.m04,t.m05=e.m05-i.m05,t.m06=e.m06-i.m06,t.m07=e.m07-i.m07,t.m08=e.m08-i.m08,t.m09=e.m09-i.m09,t.m10=e.m10-i.m10,t.m11=e.m11-i.m11,t.m12=e.m12-i.m12,t.m13=e.m13-i.m13,t.m14=e.m14-i.m14,t.m15=e.m15-i.m15,t}static multiplyScalar(t,e,i){return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*i,t.m05=e.m05*i,t.m06=e.m06*i,t.m07=e.m07*i,t.m08=e.m08*i,t.m09=e.m09*i,t.m10=e.m10*i,t.m11=e.m11*i,t.m12=e.m12*i,t.m13=e.m13*i,t.m14=e.m14*i,t.m15=e.m15*i,t}static multiplyScalarAndAdd(t,e,i,n){return t.m00=e.m00+i.m00*n,t.m01=e.m01+i.m01*n,t.m02=e.m02+i.m02*n,t.m03=e.m03+i.m03*n,t.m04=e.m04+i.m04*n,t.m05=e.m05+i.m05*n,t.m06=e.m06+i.m06*n,t.m07=e.m07+i.m07*n,t.m08=e.m08+i.m08*n,t.m09=e.m09+i.m09*n,t.m10=e.m10+i.m10*n,t.m11=e.m11+i.m11*n,t.m12=e.m12+i.m12*n,t.m13=e.m13+i.m13*n,t.m14=e.m14+i.m14*n,t.m15=e.m15+i.m15*n,t}static strictEquals(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15}static equals(t,e,i=ke){return Math.abs(t.m00-e.m00)<=i*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=i*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=i*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=i*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=i*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=i*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=i*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=i*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=i*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))&&Math.abs(t.m09-e.m09)<=i*Math.max(1,Math.abs(t.m09),Math.abs(e.m09))&&Math.abs(t.m10-e.m10)<=i*Math.max(1,Math.abs(t.m10),Math.abs(e.m10))&&Math.abs(t.m11-e.m11)<=i*Math.max(1,Math.abs(t.m11),Math.abs(e.m11))&&Math.abs(t.m12-e.m12)<=i*Math.max(1,Math.abs(t.m12),Math.abs(e.m12))&&Math.abs(t.m13-e.m13)<=i*Math.max(1,Math.abs(t.m13),Math.abs(e.m13))&&Math.abs(t.m14-e.m14)<=i*Math.max(1,Math.abs(t.m14),Math.abs(e.m14))&&Math.abs(t.m15-e.m15)<=i*Math.max(1,Math.abs(t.m15),Math.abs(e.m15))}get m00(){return this._array[0]}set m00(t){this._array[0]=t}get m01(){return this._array[1]}set m01(t){this._array[1]=t}get m02(){return this._array[2]}set m02(t){this._array[2]=t}get m03(){return this._array[3]}set m03(t){this._array[3]=t}get m04(){return this._array[4]}set m04(t){this._array[4]=t}get m05(){return this._array[5]}set m05(t){this._array[5]=t}get m06(){return this._array[6]}set m06(t){this._array[6]=t}get m07(){return this._array[7]}set m07(t){this._array[7]=t}get m08(){return this._array[8]}set m08(t){this._array[8]=t}get m09(){return this._array[9]}set m09(t){this._array[9]=t}get m10(){return this._array[10]}set m10(t){this._array[10]=t}get m11(){return this._array[11]}set m11(t){this._array[11]=t}get m12(){return this._array[12]}set m12(t){this._array[12]=t}get m13(){return this._array[13]}set m13(t){this._array[13]=t}get m14(){return this._array[14]}set m14(t){this._array[14]=t}get m15(){return this._array[15]}set m15(t){this._array[15]=t}constructor(t=1,e=0,i=0,n=0,s=0,r=1,o=0,a=0,c=0,l=0,h=1,_=0,u=0,d=0,m=0,p=1){if(super(),t&&"object"==typeof t)if(ArrayBuffer.isView(t))this._array=t,this._array.set([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);else{const e=t.array;this._array=di.createFloatArray(16),this._array[0]=e[0],this._array[1]=e[1],this._array[2]=e[2],this._array[3]=e[3],this._array[4]=e[4],this._array[5]=e[5],this._array[6]=e[6],this._array[7]=e[7],this._array[8]=e[8],this._array[9]=e[9],this._array[10]=e[10],this._array[11]=e[11],this._array[12]=e[12],this._array[13]=e[13],this._array[14]=e[14],this._array[15]=e[15]}else this._array=di.createFloatArray(16),this._array[0]=t,this._array[1]=e,this._array[2]=i,this._array[3]=n,this._array[4]=s,this._array[5]=r,this._array[6]=o,this._array[7]=a,this._array[8]=c,this._array[9]=l,this._array[10]=h,this._array[11]=_,this._array[12]=u,this._array[13]=d,this._array[14]=m,this._array[15]=p}clone(){const t=this._array;return new Ii(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}set(t=1,e=0,i=0,n=0,s=0,r=1,o=0,a=0,c=0,l=0,h=1,_=0,u=0,d=0,m=0,p=1){if(t&&"object"==typeof t){const e=t.array;this._array[1]=e[1],this._array[2]=e[2],this._array[3]=e[3],this._array[4]=e[4],this._array[5]=e[5],this._array[6]=e[6],this._array[7]=e[7],this._array[8]=e[8],this._array[9]=e[9],this._array[10]=e[10],this._array[11]=e[11],this._array[12]=e[12],this._array[13]=e[13],this._array[14]=e[14],this._array[15]=e[15],this._array[0]=e[0]}else this._array[1]=e,this._array[2]=i,this._array[3]=n,this._array[4]=s,this._array[5]=r,this._array[6]=o,this._array[7]=a,this._array[8]=c,this._array[9]=l,this._array[10]=h,this._array[11]=_,this._array[12]=u,this._array[13]=d,this._array[14]=m,this._array[15]=p,this._array[0]=t;return this}equals(t,e=ke){const i=t.array;return Math.abs(this._array[0]-i[0])<=e*Math.max(1,Math.abs(this._array[0]),Math.abs(i[0]))&&Math.abs(this._array[1]-i[1])<=e*Math.max(1,Math.abs(this._array[1]),Math.abs(i[1]))&&Math.abs(this._array[2]-i[2])<=e*Math.max(1,Math.abs(this._array[2]),Math.abs(i[2]))&&Math.abs(this._array[3]-i[3])<=e*Math.max(1,Math.abs(this._array[3]),Math.abs(i[3]))&&Math.abs(this._array[4]-i[4])<=e*Math.max(1,Math.abs(this._array[4]),Math.abs(i[4]))&&Math.abs(this._array[5]-i[5])<=e*Math.max(1,Math.abs(this._array[5]),Math.abs(i[5]))&&Math.abs(this._array[6]-i[6])<=e*Math.max(1,Math.abs(this._array[6]),Math.abs(i[6]))&&Math.abs(this._array[7]-i[7])<=e*Math.max(1,Math.abs(this._array[7]),Math.abs(i[7]))&&Math.abs(this._array[8]-i[8])<=e*Math.max(1,Math.abs(this._array[8]),Math.abs(i[8]))&&Math.abs(this._array[9]-i[9])<=e*Math.max(1,Math.abs(this._array[9]),Math.abs(i[9]))&&Math.abs(this._array[10]-i[10])<=e*Math.max(1,Math.abs(this._array[10]),Math.abs(i[10]))&&Math.abs(this._array[11]-i[11])<=e*Math.max(1,Math.abs(this._array[11]),Math.abs(i[11]))&&Math.abs(this._array[12]-i[12])<=e*Math.max(1,Math.abs(this._array[12]),Math.abs(i[12]))&&Math.abs(this._array[13]-i[13])<=e*Math.max(1,Math.abs(this._array[13]),Math.abs(i[13]))&&Math.abs(this._array[14]-i[14])<=e*Math.max(1,Math.abs(this._array[14]),Math.abs(i[14]))&&Math.abs(this._array[15]-i[15])<=e*Math.max(1,Math.abs(this._array[15]),Math.abs(i[15]))}strictEquals(t){const e=t.array;return this._array[0]===t.m00&&this._array[1]===e[1]&&this._array[2]===e[2]&&this._array[3]===e[3]&&this._array[4]===e[4]&&this._array[5]===e[5]&&this._array[6]===e[6]&&this._array[7]===e[7]&&this._array[8]===e[8]&&this._array[9]===e[9]&&this._array[10]===e[10]&&this._array[11]===e[11]&&this._array[12]===e[12]&&this._array[13]===e[13]&&this._array[14]===e[14]&&this._array[15]===e[15]}toString(){return`[\n${this._array[0]}, ${this._array[1]}, ${this._array[2]}, ${this._array[3]},\n${this._array[4]}, ${this._array[5]}, ${this._array[6]}, ${this._array[7]},\n${this._array[8]}, ${this._array[9]}, ${this._array[10]}, ${this._array[11]},\n${this._array[12]}, ${this._array[13]}, ${this._array[14]}, ${this._array[15]}\n]`}identity(){return this._array[0]=1,this._array[1]=0,this._array[2]=0,this._array[3]=0,this._array[4]=0,this._array[5]=1,this._array[6]=0,this._array[7]=0,this._array[8]=0,this._array[9]=0,this._array[10]=1,this._array[11]=0,this._array[12]=0,this._array[13]=0,this._array[14]=0,this._array[15]=1,this}zero(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this}transpose(){const t=this._array[1],e=this._array[2],i=this._array[3],n=this._array[6],s=this._array[7],r=this._array[11];return this._array[1]=this._array[4],this._array[2]=this._array[8],this._array[3]=this._array[12],this._array[4]=t,this._array[6]=this._array[9],this._array[7]=this._array[13],this._array[8]=e,this._array[9]=n,this._array[11]=this._array[14],this._array[12]=i,this._array[13]=s,this._array[14]=r,this}invert(){const t=this._array[0],e=this._array[1],i=this._array[2],n=this._array[3],s=this._array[4],r=this._array[5],o=this._array[6],a=this._array[7],c=this._array[8],l=this._array[9],h=this._array[10],_=this._array[11],u=this._array[12],d=this._array[13],m=this._array[14],p=this._array[15],f=t*r-e*s,g=t*o-i*s,v=t*a-n*s,y=e*o-i*r,x=e*a-n*r,S=i*a-n*o,C=c*d-l*u,A=c*m-h*u,b=c*p-_*u,T=l*m-h*d,E=l*p-_*d,P=h*p-_*m;let w=f*P-g*E+v*T+y*b-x*A+S*C;return 0===w?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(w=1/w,this._array[0]=(r*P-o*E+a*T)*w,this._array[1]=(i*E-e*P-n*T)*w,this._array[2]=(d*S-m*x+p*y)*w,this._array[3]=(h*x-l*S-_*y)*w,this._array[4]=(o*b-s*P-a*A)*w,this._array[5]=(t*P-i*b+n*A)*w,this._array[6]=(m*v-u*S-p*g)*w,this._array[7]=(c*S-h*v+_*g)*w,this._array[8]=(s*E-r*b+a*C)*w,this._array[9]=(e*b-t*E-n*C)*w,this._array[10]=(u*x-d*v+p*f)*w,this._array[11]=(l*v-c*x-_*f)*w,this._array[12]=(r*A-s*T-o*C)*w,this._array[13]=(t*T-e*A+i*C)*w,this._array[14]=(d*g-u*y-m*f)*w,this._array[15]=(c*y-l*g+h*f)*w,this)}determinant(){const t=this._array[0],e=this._array[1],i=this._array[2],n=this._array[3],s=this._array[4],r=this._array[5],o=this._array[6],a=this._array[7],c=this._array[8],l=this._array[9],h=this._array[10],_=this._array[11],u=this._array[12],d=this._array[13],m=this._array[14],p=this._array[15];return(t*r-e*s)*(h*p-_*m)-(t*o-i*s)*(l*p-_*d)+(t*a-n*s)*(l*m-h*d)+(e*o-i*r)*(c*p-_*u)-(e*a-n*r)*(c*m-h*u)+(i*a-n*o)*(c*d-l*u)}add(t){const e=t.array;return this._array[0]+=e[0],this._array[1]+=e[1],this._array[2]+=e[2],this._array[3]+=e[3],this._array[4]+=e[4],this._array[5]+=e[5],this._array[6]+=e[6],this._array[7]+=e[7],this._array[8]+=e[8],this._array[9]+=e[9],this._array[10]+=e[10],this._array[11]+=e[11],this._array[12]+=e[12],this._array[13]+=e[13],this._array[14]+=e[14],this._array[15]+=e[15],this}subtract(t){const e=t.array;return this._array[0]-=e[0],this._array[1]-=e[1],this._array[2]-=e[2],this._array[3]-=e[3],this._array[4]-=e[4],this._array[5]-=e[5],this._array[6]-=e[6],this._array[7]-=e[7],this._array[8]-=e[8],this._array[9]-=e[9],this._array[10]-=e[10],this._array[11]-=e[11],this._array[12]-=e[12],this._array[13]-=e[13],this._array[14]-=e[14],this._array[15]-=e[15],this}multiply(t){const e=this._array[0],i=this._array[1],n=this._array[2],s=this._array[3],r=this._array[4],o=this._array[5],a=this._array[6],c=this._array[7],l=this._array[8],h=this._array[9],_=this._array[10],u=this._array[11],d=this._array[12],m=this._array[13],p=this._array[14],f=this._array[15],g=t.array;let v=g[0],y=g[1],x=g[2],S=g[3];return this._array[0]=v*e+y*r+x*l+S*d,this._array[1]=v*i+y*o+x*h+S*m,this._array[2]=v*n+y*a+x*_+S*p,this._array[3]=v*s+y*c+x*u+S*f,v=g[4],y=g[5],x=g[6],S=g[7],this._array[4]=v*e+y*r+x*l+S*d,this._array[5]=v*i+y*o+x*h+S*m,this._array[6]=v*n+y*a+x*_+S*p,this._array[7]=v*s+y*c+x*u+S*f,v=g[8],y=g[9],x=g[10],S=g[11],this._array[8]=v*e+y*r+x*l+S*d,this._array[9]=v*i+y*o+x*h+S*m,this._array[10]=v*n+y*a+x*_+S*p,this._array[11]=v*s+y*c+x*u+S*f,v=g[12],y=g[13],x=g[14],S=g[15],this._array[12]=v*e+y*r+x*l+S*d,this._array[13]=v*i+y*o+x*h+S*m,this._array[14]=v*n+y*a+x*_+S*p,this._array[15]=v*s+y*c+x*u+S*f,this}multiplyScalar(t){return this._array[0]*=t,this._array[1]*=t,this._array[2]*=t,this._array[3]*=t,this._array[4]*=t,this._array[5]*=t,this._array[6]*=t,this._array[7]*=t,this._array[8]*=t,this._array[9]*=t,this._array[10]*=t,this._array[11]*=t,this._array[12]*=t,this._array[13]*=t,this._array[14]*=t,this._array[15]*=t,this}translate(t){console.warn("function changed");const e=t.array;return this._array[12]+=e[0],this._array[13]+=e[1],this._array[14]+=e[2],this}scale(t){const e=t.array,i=e[0],n=e[1],s=e[2];return this._array[0]*=i,this._array[1]*=i,this._array[2]*=i,this._array[3]*=i,this._array[4]*=n,this._array[5]*=n,this._array[6]*=n,this._array[7]*=n,this._array[8]*=s,this._array[9]*=s,this._array[10]*=s,this._array[11]*=s,this}rotate(t,e){let i=e.x,n=e.y,s=e.z,r=Math.sqrt(i*i+n*n+s*s);if(Math.abs(r)<ke)return null;r=1/r,i*=r,n*=r,s*=r;const o=Math.sin(t),a=Math.cos(t),c=1-a,l=this._array[0],h=this._array[1],_=this._array[2],u=this._array[3],d=this._array[4],m=this._array[5],p=this._array[6],f=this._array[7],g=this._array[8],v=this._array[9],y=this._array[10],x=this._array[11],S=i*i*c+a,C=n*i*c+s*o,A=s*i*c-n*o,b=i*n*c-s*o,T=n*n*c+a,E=s*n*c+i*o,P=i*s*c+n*o,w=n*s*c-i*o,I=s*s*c+a;return this._array[0]=l*S+d*C+g*A,this._array[1]=h*S+m*C+v*A,this._array[2]=_*S+p*C+y*A,this._array[3]=u*S+f*C+x*A,this._array[4]=l*b+d*T+g*E,this._array[5]=h*b+m*T+v*E,this._array[6]=_*b+p*T+y*E,this._array[7]=u*b+f*T+x*E,this._array[8]=l*P+d*w+g*I,this._array[9]=h*P+m*w+v*I,this._array[10]=_*P+p*w+y*I,this._array[11]=u*P+f*w+x*I,this}getTranslation(t){return t.x=this._array[12],t.y=this._array[13],t.z=this._array[14],t}getScale(t){const e=t.array,i=Di.array,n=i[0]=this._array[0],s=i[1]=this._array[1],r=i[2]=this._array[2],o=i[3]=this._array[4],a=i[4]=this._array[5],c=i[5]=this._array[6],l=i[6]=this._array[8],h=i[7]=this._array[9],_=i[8]=this._array[10];return e[0]=Math.sqrt(n*n+s*s+r*r),e[1]=Math.sqrt(o*o+a*a+c*c),e[2]=Math.sqrt(l*l+h*h+_*_),vi.determinant(Di)<0&&(t.x*=-1),t}getRotation(t){const e=this._array[0]+this._array[5]+this._array[10];let i=0;return e>0?(i=2*Math.sqrt(e+1),t.w=.25*i,t.x=(this._array[6]-this._array[9])/i,t.y=(this._array[8]-this._array[2])/i,t.z=(this._array[1]-this._array[4])/i):this._array[0]>this._array[5]&&this._array[0]>this._array[10]?(i=2*Math.sqrt(1+this._array[0]-this._array[5]-this._array[10]),t.w=(this._array[6]-this._array[9])/i,t.x=.25*i,t.y=(this._array[1]+this._array[4])/i,t.z=(this._array[8]+this._array[2])/i):this._array[5]>this._array[10]?(i=2*Math.sqrt(1+this._array[5]-this._array[0]-this._array[10]),t.w=(this._array[8]-this._array[2])/i,t.x=(this._array[1]+this._array[4])/i,t.y=.25*i,t.z=(this._array[6]+this._array[9])/i):(i=2*Math.sqrt(1+this._array[10]-this._array[0]-this._array[5]),t.w=(this._array[1]-this._array[4])/i,t.x=(this._array[8]+this._array[2])/i,t.y=(this._array[6]+this._array[9])/i,t.z=.25*i),t}fromRTS(t,e,i){const n=t.x,s=t.y,r=t.z,o=t.w,a=n+n,c=s+s,l=r+r,h=n*a,_=n*c,u=n*l,d=s*c,m=s*l,p=r*l,f=o*a,g=o*c,v=o*l,y=i.x,x=i.y,S=i.z;return this._array[0]=(1-(d+p))*y,this._array[1]=(_+v)*y,this._array[2]=(u-g)*y,this._array[3]=0,this._array[4]=(_-v)*x,this._array[5]=(1-(h+p))*x,this._array[6]=(m+f)*x,this._array[7]=0,this._array[8]=(u+g)*S,this._array[9]=(m-f)*S,this._array[10]=(1-(h+d))*S,this._array[11]=0,this._array[12]=e.x,this._array[13]=e.y,this._array[14]=e.z,this._array[15]=1,this}fromQuat(t){const e=t.x,i=t.y,n=t.z,s=t.w,r=e+e,o=i+i,a=n+n,c=e*r,l=i*r,h=i*o,_=n*r,u=n*o,d=n*a,m=s*r,p=s*o,f=s*a;return this._array[0]=1-h-d,this._array[1]=l+f,this._array[2]=_-p,this._array[3]=0,this._array[4]=l-f,this._array[5]=1-c-d,this._array[6]=u+m,this._array[7]=0,this._array[8]=_+p,this._array[9]=u-m,this._array[10]=1-c-h,this._array[11]=0,this._array[12]=0,this._array[13]=0,this._array[14]=0,this._array[15]=1,this}}t("Mat4",Ii),Ii.IDENTITY=Object.freeze(new Ii);const Ri=new mi,Di=new vi;function Mi(t,e,i,n,s,r,o,a,c,l,h,_,u,d,m,p){return new Ii(t,e,i,n,s,r,o,a,c,l,h,_,u,d,m,p)}ci(Ii.prototype,["m00","m01","m02","m03","m04","m05","m06","m07","m08","m09","m10","m11","m12","m13","m14","m15"]),Le.fastDefine("cc.Mat4",Ii,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),l.Mat4=Ii,l.mat4=Mi;class Oi extends Yt{static clone(t){return new Oi(t.x,t.y)}static copy(t,e){return t.x=e.x,t.y=e.y,t}static set(t,e,i){return t.x=e,t.y=i,t}static add(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t}static subtract(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t}static multiply(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t}static divide(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t}static min(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t}static max(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t}static scaleAndAdd(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t}static distance(t,e){const i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)}static squaredDistance(t,e){const i=e.x-t.x,n=e.y-t.y;return i*i+n*n}static len(t){const e=t.x,i=t.y;return Math.sqrt(e*e+i*i)}static lengthSqr(t){const e=t.x,i=t.y;return e*e+i*i}static negate(t,e){return t.x=-e.x,t.y=-e.y,t}static inverse(t,e){return t.x=1/e.x,t.y=1/e.y,t}static inverseSafe(t,e){const i=e.x,n=e.y;return Math.abs(i)<ke?t.x=0:t.x=1/i,Math.abs(n)<ke?t.y=0:t.y=1/n,t}static normalize(t,e){const i=e.x,n=e.y;let s=i*i+n*n;return s>0&&(s=1/Math.sqrt(s),t.x=i*s,t.y=n*s),t}static dot(t,e){return t.x*e.x+t.y*e.y}static cross(t,e,i){return t instanceof mi?(t.x=t.y=0,t.z=e.x*i.y-e.y*i.x,t):t.x*e.y-t.y*e.x}static lerp(t,e,i,n){const s=e.x,r=e.y;return t.x=s+n*(i.x-s),t.y=r+n*(i.y-r),t}static random(t,e){e=e||1;const i=2*Je()*Math.PI;return t.x=Math.cos(i)*e,t.y=Math.sin(i)*e,t}static transformMat3(t,e,i){const n=e.x,s=e.y;return t.x=i.m00*n+i.m03*s+i.m06,t.y=i.m01*n+i.m04*s+i.m07,t}static transformMat4(t,e,i){const n=e.x,s=e.y;return t.x=i.m00*n+i.m04*s+i.m12,t.y=i.m01*n+i.m05*s+i.m13,t}static str(t){return`Vec2(${t.x}, ${t.y})`}static toArray(t,e,i=0){return t[i+0]=e.x,t[i+1]=e.y,t}static fromArray(t,e,i=0){return t.x=e[i+0],t.y=e[i+1],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y}static equals(t,e,i=ke){return Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))}static angle(t,e){Oi.normalize(Bi,t),Oi.normalize(Ni,e);const i=Oi.dot(Bi,Ni);return i>1?0:i<-1?Math.PI:Math.acos(i)}constructor(t,e){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0)}clone(){return new Oi(this.x,this.y)}set(t,e){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0),this}equals(t,e=ke){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))}equals2f(t,e,i=ke){return Math.abs(this.x-t)<=i*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=i*Math.max(1,Math.abs(this.y),Math.abs(e))}strictEquals(t){return t&&this.x===t.x&&this.y===t.y}strictEquals2f(t,e){return this.x===t&&this.y===e}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}lerp(t,e){const i=this.x,n=this.y;return this.x=i+e*(t.x-i),this.y=n+e*(t.y-n),this}clampf(t,e){return this.x=We(this.x,t.x,e.x),this.y=We(this.y,t.y,e.y),this}add(t){return this.x+=t.x,this.y+=t.y,this}add2f(t,e){return this.x+=t,this.y+=e,this}subtract(t){return this.x-=t.x,this.y-=t.y,this}subtract2f(t,e){return this.x-=t,this.y-=e,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=t,this.y*=t,this}multiply(t){return"object"!=typeof t&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this}multiply2f(t,e){return this.x*=t,this.y*=e,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divide2f(t,e){return this.x/=t,this.y/=e,this}negative(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSqr(){return this.x*this.x+this.y*this.y}normalize(){const t=this.x,e=this.y;let i=t*t+e*e;return i>0&&(i=1/Math.sqrt(i),this.x*=i,this.y*=i),this}angle(t){const e=this.lengthSqr(),i=t.lengthSqr();if(0===e||0===i)return console.warn("Can't get angle between zero vector"),0;let n=this.dot(t)/Math.sqrt(e*i);return n=We(n,-1,1),Math.acos(n)}signAngle(t){const e=this.angle(t);return this.cross(t)<0?-e:e}rotate(t){const e=this.x,i=this.y,n=Math.sin(t),s=Math.cos(t);return this.x=s*e-n*i,this.y=n*e+s*i,this}project(t){const e=this.dot(t)/t.dot(t);return this.x=t.x*e,this.y=t.y*e,this}transformMat4(t){const e=this.x,i=this.y;return this.x=t.m00*e+t.m04*i+t.m12,this.y=t.m01*e+t.m05*i+t.m13,this}}t("Vec2",Oi),Oi.ZERO=Object.freeze(new Oi(0,0)),Oi.ONE=Object.freeze(new Oi(1,1)),Oi.NEG_ONE=Object.freeze(new Oi(-1,-1)),Oi.UNIT_X=Object.freeze(new Oi(1,0)),Oi.UNIT_Y=Object.freeze(new Oi(0,1));const Bi=new Oi,Ni=new Oi;function Li(t,e){return new Oi(t,e)}Le.fastDefine("cc.Vec2",Oi,{x:0,y:0}),l.Vec2=Oi,l.v2=Li;class Fi extends Yt{static clone(t){return new Fi(t.x,t.y,t.z,t.w)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}static set(t,e,i,n,s){return t.x=e,t.y=i,t.z=n,t.w=s,t}static add(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t.z=e.z+i.z,t.w=e.w+i.w,t}static subtract(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t.z=e.z-i.z,t.w=e.w-i.w,t}static multiply(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t.z=e.z*i.z,t.w=e.w*i.w,t}static divide(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t.z=e.z/i.z,t.w=e.w/i.w,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t.w=Math.ceil(e.w),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t.w=Math.floor(e.w),t}static min(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t.z=Math.min(e.z,i.z),t.w=Math.min(e.w,i.w),t}static max(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t.z=Math.max(e.z,i.z),t.w=Math.max(e.w,i.w),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t.w=Math.round(e.w),t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i,t}static scaleAndAdd(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t.w=e.w+i.w*n,t}static distance(t,e){const i=e.x-t.x,n=e.y-t.y,s=e.z-t.z,r=e.w-t.w;return Math.sqrt(i*i+n*n+s*s+r*r)}static squaredDistance(t,e){const i=e.x-t.x,n=e.y-t.y,s=e.z-t.z,r=e.w-t.w;return i*i+n*n+s*s+r*r}static len(t){const e=t.x,i=t.y,n=t.z,s=t.w;return Math.sqrt(e*e+i*i+n*n+s*s)}static lengthSqr(t){const e=t.x,i=t.y,n=t.z,s=t.w;return e*e+i*i+n*n+s*s}static negate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t}static inverse(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t.w=1/e.w,t}static inverseSafe(t,e){const i=e.x,n=e.y,s=e.z,r=e.w;return Math.abs(i)<ke?t.x=0:t.x=1/i,Math.abs(n)<ke?t.y=0:t.y=1/n,Math.abs(s)<ke?t.z=0:t.z=1/s,Math.abs(r)<ke?t.w=0:t.w=1/r,t}static normalize(t,e){const i=e.x,n=e.y,s=e.z,r=e.w;let o=i*i+n*n+s*s+r*r;return o>0&&(o=1/Math.sqrt(o),t.x=i*o,t.y=n*o,t.z=s*o,t.w=r*o),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static lerp(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t.w=e.w+n*(i.w-e.w),t}static random(t,e){e=e||1;const i=2*Je()*Math.PI,n=2*Je()-1,s=Math.sqrt(1-n*n);return t.x=s*Math.cos(i)*e,t.y=s*Math.sin(i)*e,t.z=n*e,t.w=0,t}static transformMat4(t,e,i){const n=e.x,s=e.y,r=e.z,o=e.w;return t.x=i.m00*n+i.m04*s+i.m08*r+i.m12*o,t.y=i.m01*n+i.m05*s+i.m09*r+i.m13*o,t.z=i.m02*n+i.m06*s+i.m10*r+i.m14*o,t.w=i.m03*n+i.m07*s+i.m11*r+i.m15*o,t}static transformAffine(t,e,i){const n=e.x,s=e.y,r=e.z,o=e.w;return t.x=i.m00*n+i.m04*s+i.m08*r+i.m12*o,t.y=i.m01*n+i.m05*s+i.m09*r+i.m13*o,t.z=i.m02*n+i.m06*s+i.m10*r+i.m14*o,t.w=e.w,t}static transformQuat(t,e,i){const{x:n,y:s,z:r}=e,o=i.x,a=i.y,c=i.z,l=i.w,h=l*n+a*r-c*s,_=l*s+c*n-o*r,u=l*r+o*s-a*n,d=-o*n-a*s-c*r;return t.x=h*l+d*-o+_*-c-u*-a,t.y=_*l+d*-a+u*-o-h*-c,t.z=u*l+d*-c+h*-a-_*-o,t.w=e.w,t}static toArray(t,e,i=0){return t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t[i+3]=e.w,t}static fromArray(t,e,i=0){return t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t.w=e[i+3],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w}static equals(t,e,i=ke){return Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=i*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=i*Math.max(1,Math.abs(t.w),Math.abs(e.w))}constructor(t,e,i,n){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=n||0)}clone(){return new Fi(this.x,this.y,this.z,this.w)}set(t,e,i,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=n||0),this}equals(t,e=ke){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))}equals4f(t,e,i,n,s=ke){return Math.abs(this.x-t)<=s*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=s*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-i)<=s*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=s*Math.max(1,Math.abs(this.w),Math.abs(n))}strictEquals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}strictEquals4f(t,e,i,n){return this.x===t&&this.y===e&&this.z===i&&this.w===n}lerp(t,e){const i=this.x,n=this.y,s=this.z,r=this.w;return this.x=i+e*(t.x-i),this.y=n+e*(t.y-n),this.z=s+e*(t.z-s),this.w=r+e*(t.w-r),this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.z.toFixed(2)}, ${this.w.toFixed(2)})`}clampf(t,e){return this.x=We(this.x,t.x,e.x),this.y=We(this.y,t.y,e.y),this.z=We(this.z,t.z,e.z),this.w=We(this.w,t.w,e.w),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add4f(t,e,i,n){return this.x+=t,this.y+=e,this.z+=i,this.w+=n,this}subtract(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subtract4f(t,e,i,n){return this.x-=t,this.y-=e,this.z-=i,this.w-=n,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}multiply(t){return"object"!=typeof t&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiply4f(t,e,i,n){return this.x*=t,this.y*=e,this.z*=i,this.w*=n,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}divide4f(t,e,i,n){return this.x/=t,this.y/=e,this.z/=i,this.w/=n,this}negative(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}cross(t){const{x:e,y:i,z:n}=this,{x:s,y:r,z:o}=t;return this.x=i*o-n*r,this.y=n*s-e*o,this.z=e*r-i*s,this}length(){const t=this.x,e=this.y,i=this.z,n=this.w;return Math.sqrt(t*t+e*e+i*i+n*n)}lengthSqr(){const t=this.x,e=this.y,i=this.z,n=this.w;return t*t+e*e+i*i+n*n}normalize(){const t=this.x,e=this.y,i=this.z,n=this.w;let s=t*t+e*e+i*i+n*n;return s>0&&(s=1/Math.sqrt(s),this.x=t*s,this.y=e*s,this.z=i*s,this.w=n*s),this}transformMat4(t){const e=this.x,i=this.y,n=this.z,s=this.w;return this.x=t.m00*e+t.m04*i+t.m08*n+t.m12*s,this.y=t.m01*e+t.m05*i+t.m09*n+t.m13*s,this.z=t.m02*e+t.m06*i+t.m10*n+t.m14*s,this.w=t.m03*e+t.m07*i+t.m11*n+t.m15*s,this}}function zi(t,e,i,n){return new Fi(t,e,i,n)}t("Vec4",Fi),Fi.ZERO=Object.freeze(new Fi(0,0,0,0)),Fi.ONE=Object.freeze(new Fi(1,1,1,1)),Fi.NEG_ONE=Object.freeze(new Fi(-1,-1,-1,-1)),Le.fastDefine("cc.Vec4",Fi,{x:0,y:0,z:0,w:0}),l.Vec4=Fi,l.v4=zi,V(Oi,"Vec2",[{name:"sub",newName:"subtract",target:Oi,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Oi,targetName:"Vec2"},{name:"div",newName:"divide",target:Oi,targetName:"Vec2"},{name:"dist",newName:"distance",target:Oi,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Oi,targetName:"Vec2"},{name:"mag",newName:"len",target:Oi,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Oi,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Oi,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Oi,targetName:"Vec2"}]),V(Oi.prototype,"Vec2",[{name:"mag",newName:"length",target:Oi.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Oi.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Oi.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Oi.prototype,targetName:"Vec2"}]),V(mi,"Vec3",[{name:"sub",newName:"subtract",target:mi,targetName:"Vec3"},{name:"mul",newName:"multiply",target:mi,targetName:"Vec3"},{name:"div",newName:"divide",target:mi,targetName:"Vec3"},{name:"dist",newName:"distance",target:mi,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:mi,targetName:"Vec3"},{name:"mag",newName:"len",target:mi,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:mi,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:mi,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:mi,targetName:"Vec3"}]),V(mi.prototype,"Vec3",[{name:"mag",newName:"length",target:mi.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:mi.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:mi.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:mi.prototype,targetName:"Vec3"}]),V(Fi,"Vec4",[{name:"sub",newName:"subtract",target:Fi,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Fi,targetName:"Vec4"},{name:"div",newName:"divide",target:Fi,targetName:"Vec4"},{name:"dist",newName:"distance",target:Fi,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Fi,targetName:"Vec4"},{name:"mag",newName:"len",target:Fi,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Fi,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Fi,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Fi,targetName:"Vec4"}]),V(Fi.prototype,"Vec4",[{name:"mag",newName:"length",target:Fi.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Fi.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Fi.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Fi.prototype,targetName:"Vec4"}]),V(Si,"Quat",[{name:"mag",newName:"len",target:Si,targetName:"Quat"},{name:"mul",newName:"multiply",target:Si,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Si,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Si,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Si,targetName:"Quat"}]),V(Si.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Si.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Si.prototype,targetName:"Quat"}]),V(hi,"Color",[{name:"sub",newName:"subtract",target:hi,targetName:"Color"},{name:"mul",newName:"multiply",target:hi,targetName:"Color"},{name:"div",newName:"divide",target:hi,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:hi,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction(...t){const e=t[1].toString(16);return l.Color.fromHEX(t[0],e)}}]),V(vi,"Mat3",[{name:"sub",newName:"subtract",target:vi,targetName:"Mat3"},{name:"mul",newName:"multiply",target:vi,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:vi,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:vi,targetName:"Mat3"}]),V(vi.prototype,"Mat3",[{name:"sub",newName:"subtract",target:vi.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:vi.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:vi.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:vi.prototype,targetName:"Mat3"}]),V(Ii,"Mat4",[{name:"sub",newName:"subtract",target:Ii,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Ii,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Ii,targetName:"Mat4"}]),V(Ii.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Ii.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Ii.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Ii.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Ii.prototype,targetName:"Mat4"}]);class Vi{static identity(){return new Vi}static clone(t){return new Vi(t.a,t.b,t.c,t.d,t.tx,t.ty)}static concat(t,e,i){const n=e.a,s=e.b,r=e.c,o=e.d,a=e.tx,c=e.ty;t.a=n*i.a+s*i.c,t.b=n*i.b+s*i.d,t.c=r*i.a+o*i.c,t.d=r*i.b+o*i.d,t.tx=a*i.a+c*i.c+i.tx,t.ty=a*i.b+c*i.d+i.ty}static invert(t,e){const i=1/(e.a*e.d-e.b*e.c);t.a=i*e.d,t.b=-i*e.b,t.c=-i*e.c,t.d=i*e.a,t.tx=i*(e.c*e.ty-e.d*e.tx),t.ty=i*(e.b*e.tx-e.a*e.ty)}static fromMat4(t,e){t.a=e.m00,t.b=e.m01,t.c=e.m04,t.d=e.m05,t.tx=e.m12,t.ty=e.m13}static transformVec2(t,e,i,n){let s,r;n?(s=e,r=i):(n=i,s=e.x,r=e.y),t.x=n.a*s+n.c*r+n.tx,t.y=n.b*s+n.d*r+n.ty}static transformSize(t,e,i){t.width=i.a*e.width+i.c*e.height,t.height=i.b*e.width+i.d*e.height}static transformRect(t,e,i){const n=e.x+e.width,s=e.y+e.height,r=i.a*e.x+i.c*e.y+i.tx,o=i.b*e.x+i.d*e.y+i.ty,a=i.a*n+i.c*e.y+i.tx,c=i.b*n+i.d*e.y+i.ty,l=i.a*e.x+i.c*s+i.tx,h=i.b*e.x+i.d*s+i.ty,_=i.a*n+i.c*s+i.tx,u=i.b*n+i.d*s+i.ty,d=Math.min(r,a,l,_),m=Math.max(r,a,l,_),p=Math.min(o,c,h,u),f=Math.max(o,c,h,u);t.x=d,t.y=p,t.width=m-d,t.height=f-p}static transformObb(t,e,i,n,s,r){const o=r.a*s.x+r.c*s.y+r.tx,a=r.b*s.x+r.d*s.y+r.ty,c=r.a*s.width,l=r.b*s.width,h=r.c*s.height,_=r.d*s.height;e.x=o,e.y=a,i.x=c+o,i.y=l+a,t.x=h+o,t.y=_+a,n.x=c+h+o,n.y=l+_+a}constructor(t=1,e=0,i=0,n=1,s=0,r=0){this.a=t,this.b=e,this.c=i,this.d=n,this.tx=s,this.ty=r}}t("AffineTransform",Vi),l.AffineTransform=Vi;class Gi extends Yt{static lerp(t,e,i,n){return t.width=e.width+(i.width-e.width)*n,t.height=e.height+(i.height-e.height)*n,t}set x(t){this.width=t}get x(){return this.width}set y(t){this.height=t}get y(){return this.height}constructor(t,e){super(),t&&"object"==typeof t?(this.width=t.width,this.height=t.height):(this.width=t||0,this.height=e||0)}clone(){return new Gi(this.width,this.height)}set(t,e){return t&&"object"==typeof t?(this.height=t.height,this.width=t.width):(this.width=t||0,this.height=e||0),this}equals(t){return this.width===t.width&&this.height===t.height}lerp(t,e){return this.width+=(t.width-this.width)*e,this.height+=(t.height-this.height)*e,this}toString(){return`(${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}}function Ui(t=0,e=0){return new Gi(t,e)}t("Size",Gi),Gi.ZERO=Object.freeze(new Gi(0,0)),Gi.ONE=Object.freeze(new Gi(1,1)),Le.fastDefine("cc.Size",Gi,{width:0,height:0}),l.size=Ui,l.Size=Gi;class ki extends Yt{static fromMinMax(t,e,i){const n=Math.min(e.x,i.x),s=Math.min(e.y,i.y),r=Math.max(e.x,i.x),o=Math.max(e.y,i.y);return t.x=n,t.y=s,t.width=r-n,t.height=o-s,t}static lerp(t,e,i,n){const s=e.x,r=e.y,o=e.width,a=e.height;return t.x=s+(i.x-s)*n,t.y=r+(i.y-r)*n,t.width=o+(i.width-o)*n,t.height=a+(i.height-a)*n,t}static intersection(t,e,i){const n=e.x,s=e.y,r=e.x+e.width,o=e.y+e.height,a=i.x,c=i.y,l=i.x+i.width,h=i.y+i.height;return t.x=Math.max(n,a),t.y=Math.max(s,c),t.width=Math.min(r,l)-t.x,t.height=Math.min(o,h)-t.y,t}static union(t,e,i){const n=e.x,s=e.y,r=e.width,o=e.height,a=i.x,c=i.y,l=i.width,h=i.height;return t.x=Math.min(n,a),t.y=Math.min(s,c),t.width=Math.max(n+r,a+l)-t.x,t.height=Math.max(s+o,c+h)-t.y,t}get xMin(){return this.x}set xMin(t){this.width+=this.x-t,this.x=t}get yMin(){return this.y}set yMin(t){this.height+=this.y-t,this.y=t}get xMax(){return this.x+this.width}set xMax(t){this.width=t-this.x}get yMax(){return this.y+this.height}set yMax(t){this.height=t-this.y}get center(){return new Oi(this.x+.5*this.width,this.y+.5*this.height)}set center(t){this.x=t.x-.5*this.width,this.y=t.y-.5*this.height}get origin(){return new Oi(this.x,this.y)}set origin(t){this.x=t.x,this.y=t.y}get size(){return new Gi(this.width,this.height)}set size(t){this.width=t.width,this.height=t.height}set z(t){this.width=t}get z(){return this.width}set w(t){this.height=t}get w(){return this.height}constructor(t,e,i,n){super(),t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=i||0,this.height=n||0)}clone(){return new ki(this.x,this.y,this.width,this.height)}set(t,e,i,n){return t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=i||0,this.height=n||0),this}equals(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}lerp(t,e){const i=this.x,n=this.y,s=this.width,r=this.height;return this.x=i+(t.x-i)*e,this.y=n+(t.y-n)*e,this.width=s+(t.width-s)*e,this.height=r+(t.height-r)*e,this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}intersects(t){const e=this.x+this.width,i=this.y+this.height,n=t.x+t.width,s=t.y+t.height;return!(e<t.x||n<this.x||i<t.y||s<this.y)}contains(t){return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y}containsRect(t){return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height}transformMat4(t){const e=this.x,i=this.y,n=e+this.width,s=i+this.height,r=t.m00*e+t.m04*i+t.m12,o=t.m01*e+t.m05*i+t.m13,a=t.m00*n+t.m04*i+t.m12,c=t.m01*n+t.m05*i+t.m13,l=t.m00*e+t.m04*s+t.m12,h=t.m01*e+t.m05*s+t.m13,_=t.m00*n+t.m04*s+t.m12,u=t.m01*n+t.m05*s+t.m13,d=Math.min(r,a,l,_),m=Math.max(r,a,l,_),p=Math.min(o,c,h,u),f=Math.max(o,c,h,u);return this.x=d,this.y=p,this.width=m-d,this.height=f-p,this}transformMat4ToPoints(t,e,i,n,s){const r=this.x,o=this.y,a=r+this.width,c=o+this.height;e.x=t.m00*r+t.m04*o+t.m12,e.y=t.m01*r+t.m05*o+t.m13,s.x=t.m00*a+t.m04*o+t.m12,s.y=t.m01*a+t.m05*o+t.m13,i.x=t.m00*r+t.m04*c+t.m12,i.y=t.m01*r+t.m05*c+t.m13,n.x=t.m00*a+t.m04*c+t.m12,n.y=t.m01*a+t.m05*c+t.m13}}function Hi(t=0,e=0,i=0,n=0){return new ki(t,e,i,n)}t("Rect",ki),Le.fastDefine("cc.Rect",ki,{x:0,y:0,width:0,height:0}),l.Rect=ki,l.rect=Hi;var ji=Object.freeze({__proto__:null,bits:a,Vec2:Oi,v2:Li,Vec3:mi,v3:gi,Vec4:Fi,v4:zi,Quat:Si,quat:Pi,Mat3:vi,Mat4:Ii,mat4:Mi,AffineTransform:Vi,Size:Gi,size:Ui,Rect:ki,rect:Hi,Color:hi,color:_i,EPSILON:ke,equals:He,approx:je,clamp:We,clamp01:qe,lerp:Xe,toRadian:Ye,toDegree:Ke,random:Je,randomRange:$e,randomRangeInt:Ze,pseudoRandom:Qe,pseudoRandomRange:ti,pseudoRandomRangeInt:ei,nextPow2:ii,repeat:ni,pingPong:si,inverseLerp:ri,absMaxComponent:oi,absMax:ai,enumerableProps:ci,MATH_FLOAT_ARRAY:ui,MathBase:di});t("math",ji);const Wi=new class{constructor(){this._finalizationRegistry=null,this._gcObjects=new WeakMap}registerGCObject(t){return t}init(){}finalizationRegistryCallback(t){const e=this._gcObjects.get(t);e&&(this._gcObjects.delete(t),e.destroy()),this._finalizationRegistry.unregister(t)}destroy(){}},qi=(t,e,i)=>{for(let n=0;n<e.length;++n)t.length<=n&&t.push(new i),t[n].copy(e[n]);t.length=e.length};let Xi,Yi,Ki,Ji,$i,Zi,Qi,tn,en,nn,sn,rn,on,an,cn,ln,hn,_n,un,dn,mn,pn,fn,gn,vn,yn,xn,Sn,Cn,An,bn,Tn,En,Pn,wn,In,Rn,Dn,Mn,On,Bn,Nn,Ln;!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SWAPCHAIN=1]="SWAPCHAIN",t[t.BUFFER=2]="BUFFER",t[t.TEXTURE=3]="TEXTURE",t[t.RENDER_PASS=4]="RENDER_PASS",t[t.FRAMEBUFFER=5]="FRAMEBUFFER",t[t.SAMPLER=6]="SAMPLER",t[t.SHADER=7]="SHADER",t[t.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",t[t.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",t[t.PIPELINE_STATE=10]="PIPELINE_STATE",t[t.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",t[t.COMMAND_BUFFER=13]="COMMAND_BUFFER",t[t.QUEUE=14]="QUEUE",t[t.QUERY_POOL=15]="QUERY_POOL",t[t.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",t[t.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",t[t.BUFFER_BARRIER=18]="BUFFER_BARRIER",t[t.COUNT=19]="COUNT"}(Xi||(Xi={})),function(t){t[t.UNREADY=0]="UNREADY",t[t.FAILED=1]="FAILED",t[t.SUCCESS=2]="SUCCESS"}(Yi||(Yi={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.GLES2=1]="GLES2",t[t.GLES3=2]="GLES3",t[t.METAL=3]="METAL",t[t.VULKAN=4]="VULKAN",t[t.NVN=5]="NVN",t[t.WEBGL=6]="WEBGL",t[t.WEBGL2=7]="WEBGL2",t[t.WEBGPU=8]="WEBGPU"}(Ki||(Ki={})),function(t){t[t.IDENTITY=0]="IDENTITY",t[t.ROTATE_90=1]="ROTATE_90",t[t.ROTATE_180=2]="ROTATE_180",t[t.ROTATE_270=3]="ROTATE_270"}(Ji||(Ji={})),function(t){t[t.ELEMENT_INDEX_UINT=0]="ELEMENT_INDEX_UINT",t[t.INSTANCED_ARRAYS=1]="INSTANCED_ARRAYS",t[t.MULTIPLE_RENDER_TARGETS=2]="MULTIPLE_RENDER_TARGETS",t[t.BLEND_MINMAX=3]="BLEND_MINMAX",t[t.COMPUTE_SHADER=4]="COMPUTE_SHADER",t[t.INPUT_ATTACHMENT_BENEFIT=5]="INPUT_ATTACHMENT_BENEFIT",t[t.COUNT=6]="COUNT"}($i||($i={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A8=1]="A8",t[t.L8=2]="L8",t[t.LA8=3]="LA8",t[t.R8=4]="R8",t[t.R8SN=5]="R8SN",t[t.R8UI=6]="R8UI",t[t.R8I=7]="R8I",t[t.R16F=8]="R16F",t[t.R16UI=9]="R16UI",t[t.R16I=10]="R16I",t[t.R32F=11]="R32F",t[t.R32UI=12]="R32UI",t[t.R32I=13]="R32I",t[t.RG8=14]="RG8",t[t.RG8SN=15]="RG8SN",t[t.RG8UI=16]="RG8UI",t[t.RG8I=17]="RG8I",t[t.RG16F=18]="RG16F",t[t.RG16UI=19]="RG16UI",t[t.RG16I=20]="RG16I",t[t.RG32F=21]="RG32F",t[t.RG32UI=22]="RG32UI",t[t.RG32I=23]="RG32I",t[t.RGB8=24]="RGB8",t[t.SRGB8=25]="SRGB8",t[t.RGB8SN=26]="RGB8SN",t[t.RGB8UI=27]="RGB8UI",t[t.RGB8I=28]="RGB8I",t[t.RGB16F=29]="RGB16F",t[t.RGB16UI=30]="RGB16UI",t[t.RGB16I=31]="RGB16I",t[t.RGB32F=32]="RGB32F",t[t.RGB32UI=33]="RGB32UI",t[t.RGB32I=34]="RGB32I",t[t.RGBA8=35]="RGBA8",t[t.BGRA8=36]="BGRA8",t[t.SRGB8_A8=37]="SRGB8_A8",t[t.RGBA8SN=38]="RGBA8SN",t[t.RGBA8UI=39]="RGBA8UI",t[t.RGBA8I=40]="RGBA8I",t[t.RGBA16F=41]="RGBA16F",t[t.RGBA16UI=42]="RGBA16UI",t[t.RGBA16I=43]="RGBA16I",t[t.RGBA32F=44]="RGBA32F",t[t.RGBA32UI=45]="RGBA32UI",t[t.RGBA32I=46]="RGBA32I",t[t.R5G6B5=47]="R5G6B5",t[t.R11G11B10F=48]="R11G11B10F",t[t.RGB5A1=49]="RGB5A1",t[t.RGBA4=50]="RGBA4",t[t.RGB10A2=51]="RGB10A2",t[t.RGB10A2UI=52]="RGB10A2UI",t[t.RGB9E5=53]="RGB9E5",t[t.DEPTH=54]="DEPTH",t[t.DEPTH_STENCIL=55]="DEPTH_STENCIL",t[t.BC1=56]="BC1",t[t.BC1_ALPHA=57]="BC1_ALPHA",t[t.BC1_SRGB=58]="BC1_SRGB",t[t.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",t[t.BC2=60]="BC2",t[t.BC2_SRGB=61]="BC2_SRGB",t[t.BC3=62]="BC3",t[t.BC3_SRGB=63]="BC3_SRGB",t[t.BC4=64]="BC4",t[t.BC4_SNORM=65]="BC4_SNORM",t[t.BC5=66]="BC5",t[t.BC5_SNORM=67]="BC5_SNORM",t[t.BC6H_UF16=68]="BC6H_UF16",t[t.BC6H_SF16=69]="BC6H_SF16",t[t.BC7=70]="BC7",t[t.BC7_SRGB=71]="BC7_SRGB",t[t.ETC_RGB8=72]="ETC_RGB8",t[t.ETC2_RGB8=73]="ETC2_RGB8",t[t.ETC2_SRGB8=74]="ETC2_SRGB8",t[t.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",t[t.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",t[t.ETC2_RGBA8=77]="ETC2_RGBA8",t[t.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",t[t.EAC_R11=79]="EAC_R11",t[t.EAC_R11SN=80]="EAC_R11SN",t[t.EAC_RG11=81]="EAC_RG11",t[t.EAC_RG11SN=82]="EAC_RG11SN",t[t.PVRTC_RGB2=83]="PVRTC_RGB2",t[t.PVRTC_RGBA2=84]="PVRTC_RGBA2",t[t.PVRTC_RGB4=85]="PVRTC_RGB4",t[t.PVRTC_RGBA4=86]="PVRTC_RGBA4",t[t.PVRTC2_2BPP=87]="PVRTC2_2BPP",t[t.PVRTC2_4BPP=88]="PVRTC2_4BPP",t[t.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",t[t.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",t[t.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",t[t.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",t[t.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",t[t.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",t[t.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",t[t.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",t[t.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",t[t.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",t[t.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",t[t.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",t[t.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",t[t.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",t[t.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",t[t.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",t[t.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",t[t.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",t[t.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",t[t.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",t[t.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",t[t.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",t[t.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",t[t.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",t[t.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",t[t.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",t[t.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",t[t.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",t[t.COUNT=117]="COUNT"}(Zi||(Zi={})),function(t){t[t.NONE=0]="NONE",t[t.UNORM=1]="UNORM",t[t.SNORM=2]="SNORM",t[t.UINT=3]="UINT",t[t.INT=4]="INT",t[t.UFLOAT=5]="UFLOAT",t[t.FLOAT=6]="FLOAT"}(Qi||(Qi={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BOOL=1]="BOOL",t[t.BOOL2=2]="BOOL2",t[t.BOOL3=3]="BOOL3",t[t.BOOL4=4]="BOOL4",t[t.INT=5]="INT",t[t.INT2=6]="INT2",t[t.INT3=7]="INT3",t[t.INT4=8]="INT4",t[t.UINT=9]="UINT",t[t.UINT2=10]="UINT2",t[t.UINT3=11]="UINT3",t[t.UINT4=12]="UINT4",t[t.FLOAT=13]="FLOAT",t[t.FLOAT2=14]="FLOAT2",t[t.FLOAT3=15]="FLOAT3",t[t.FLOAT4=16]="FLOAT4",t[t.MAT2=17]="MAT2",t[t.MAT2X3=18]="MAT2X3",t[t.MAT2X4=19]="MAT2X4",t[t.MAT3X2=20]="MAT3X2",t[t.MAT3=21]="MAT3",t[t.MAT3X4=22]="MAT3X4",t[t.MAT4X2=23]="MAT4X2",t[t.MAT4X3=24]="MAT4X3",t[t.MAT4=25]="MAT4",t[t.SAMPLER1D=26]="SAMPLER1D",t[t.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",t[t.SAMPLER2D=28]="SAMPLER2D",t[t.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",t[t.SAMPLER3D=30]="SAMPLER3D",t[t.SAMPLER_CUBE=31]="SAMPLER_CUBE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE1D=33]="TEXTURE1D",t[t.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",t[t.TEXTURE2D=35]="TEXTURE2D",t[t.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",t[t.TEXTURE3D=37]="TEXTURE3D",t[t.TEXTURE_CUBE=38]="TEXTURE_CUBE",t[t.IMAGE1D=39]="IMAGE1D",t[t.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",t[t.IMAGE2D=41]="IMAGE2D",t[t.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",t[t.IMAGE3D=43]="IMAGE3D",t[t.IMAGE_CUBE=44]="IMAGE_CUBE",t[t.SUBPASS_INPUT=45]="SUBPASS_INPUT",t[t.COUNT=46]="COUNT"}(tn||(tn={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.INDEX=4]="INDEX",t[t.VERTEX=8]="VERTEX",t[t.UNIFORM=16]="UNIFORM",t[t.STORAGE=32]="STORAGE",t[t.INDIRECT=64]="INDIRECT"}(en||(en={})),function(t){t[t.NONE=0]="NONE"}(nn||(nn={})),function(t){t[t.NONE=0]="NONE",t[t.READ_ONLY=1]="READ_ONLY",t[t.WRITE_ONLY=2]="WRITE_ONLY",t[t.READ_WRITE=3]="READ_WRITE"}(sn||(sn={})),function(t){t[t.NONE=0]="NONE",t[t.DEVICE=1]="DEVICE",t[t.HOST=2]="HOST"}(rn||(rn={})),function(t){t[t.TEX1D=0]="TEX1D",t[t.TEX2D=1]="TEX2D",t[t.TEX3D=2]="TEX3D",t[t.CUBE=3]="CUBE",t[t.TEX1D_ARRAY=4]="TEX1D_ARRAY",t[t.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(on||(on={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.SAMPLED=4]="SAMPLED",t[t.STORAGE=8]="STORAGE",t[t.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",t[t.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(an||(an={})),function(t){t[t.NONE=0]="NONE",t[t.GEN_MIPMAP=1]="GEN_MIPMAP",t[t.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(cn||(cn={})),function(t){t[t.NONE=0]="NONE",t[t.RENDER_TARGET=1]="RENDER_TARGET",t[t.SAMPLED_TEXTURE=2]="SAMPLED_TEXTURE",t[t.LINEAR_FILTER=4]="LINEAR_FILTER",t[t.STORAGE_TEXTURE=8]="STORAGE_TEXTURE",t[t.VERTEX_ATTRIBUTE=16]="VERTEX_ATTRIBUTE"}(ln||(ln={})),function(t){t[t.ONE=0]="ONE",t[t.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",t[t.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",t[t.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(hn||(hn={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON",t[t.RELAXED=2]="RELAXED",t[t.MAILBOX=3]="MAILBOX",t[t.HALF=4]="HALF"}(_n||(_n={})),function(t){t[t.NONE=0]="NONE",t[t.POINT=1]="POINT",t[t.LINEAR=2]="LINEAR",t[t.ANISOTROPIC=3]="ANISOTROPIC"}(un||(un={})),function(t){t[t.WRAP=0]="WRAP",t[t.MIRROR=1]="MIRROR",t[t.CLAMP=2]="CLAMP",t[t.BORDER=3]="BORDER"}(dn||(dn={})),function(t){t[t.NEVER=0]="NEVER",t[t.LESS=1]="LESS",t[t.EQUAL=2]="EQUAL",t[t.LESS_EQUAL=3]="LESS_EQUAL",t[t.GREATER=4]="GREATER",t[t.NOT_EQUAL=5]="NOT_EQUAL",t[t.GREATER_EQUAL=6]="GREATER_EQUAL",t[t.ALWAYS=7]="ALWAYS"}(mn||(mn={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=1]="KEEP",t[t.REPLACE=2]="REPLACE",t[t.INCR=3]="INCR",t[t.DECR=4]="DECR",t[t.INVERT=5]="INVERT",t[t.INCR_WRAP=6]="INCR_WRAP",t[t.DECR_WRAP=7]="DECR_WRAP"}(pn||(pn={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_ALPHA=2]="SRC_ALPHA",t[t.DST_ALPHA=3]="DST_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",t[t.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",t[t.SRC_COLOR=6]="SRC_COLOR",t[t.DST_COLOR=7]="DST_COLOR",t[t.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",t[t.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=11]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(fn||(fn={})),function(t){t[t.ADD=0]="ADD",t[t.SUB=1]="SUB",t[t.REV_SUB=2]="REV_SUB",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(gn||(gn={})),function(t){t[t.NONE=0]="NONE",t[t.R=1]="R",t[t.G=2]="G",t[t.B=4]="B",t[t.A=8]="A",t[t.ALL=15]="ALL"}(vn||(vn={})),function(t){t[t.NONE=0]="NONE",t[t.VERTEX=1]="VERTEX",t[t.CONTROL=2]="CONTROL",t[t.EVALUATION=4]="EVALUATION",t[t.GEOMETRY=8]="GEOMETRY",t[t.FRAGMENT=16]="FRAGMENT",t[t.COMPUTE=32]="COMPUTE",t[t.ALL=63]="ALL"}(yn||(yn={})),function(t){t[t.LOAD=0]="LOAD",t[t.CLEAR=1]="CLEAR",t[t.DISCARD=2]="DISCARD"}(xn||(xn={})),function(t){t[t.STORE=0]="STORE",t[t.DISCARD=1]="DISCARD"}(Sn||(Sn={})),function(t){t[t.NONE=0]="NONE",t[t.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",t[t.INDEX_BUFFER=2]="INDEX_BUFFER",t[t.VERTEX_BUFFER=4]="VERTEX_BUFFER",t[t.VERTEX_SHADER_READ_UNIFORM_BUFFER=8]="VERTEX_SHADER_READ_UNIFORM_BUFFER",t[t.VERTEX_SHADER_READ_TEXTURE=16]="VERTEX_SHADER_READ_TEXTURE",t[t.VERTEX_SHADER_READ_OTHER=32]="VERTEX_SHADER_READ_OTHER",t[t.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=64]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",t[t.FRAGMENT_SHADER_READ_TEXTURE=128]="FRAGMENT_SHADER_READ_TEXTURE",t[t.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=256]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=512]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_OTHER=1024]="FRAGMENT_SHADER_READ_OTHER",t[t.COLOR_ATTACHMENT_READ=2048]="COLOR_ATTACHMENT_READ",t[t.DEPTH_STENCIL_ATTACHMENT_READ=4096]="DEPTH_STENCIL_ATTACHMENT_READ",t[t.COMPUTE_SHADER_READ_UNIFORM_BUFFER=8192]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",t[t.COMPUTE_SHADER_READ_TEXTURE=16384]="COMPUTE_SHADER_READ_TEXTURE",t[t.COMPUTE_SHADER_READ_OTHER=32768]="COMPUTE_SHADER_READ_OTHER",t[t.TRANSFER_READ=65536]="TRANSFER_READ",t[t.HOST_READ=131072]="HOST_READ",t[t.PRESENT=262144]="PRESENT",t[t.VERTEX_SHADER_WRITE=524288]="VERTEX_SHADER_WRITE",t[t.FRAGMENT_SHADER_WRITE=1048576]="FRAGMENT_SHADER_WRITE",t[t.COLOR_ATTACHMENT_WRITE=2097152]="COLOR_ATTACHMENT_WRITE",t[t.DEPTH_STENCIL_ATTACHMENT_WRITE=4194304]="DEPTH_STENCIL_ATTACHMENT_WRITE",t[t.COMPUTE_SHADER_WRITE=8388608]="COMPUTE_SHADER_WRITE",t[t.TRANSFER_WRITE=16777216]="TRANSFER_WRITE",t[t.HOST_PREINITIALIZED=33554432]="HOST_PREINITIALIZED",t[t.HOST_WRITE=67108864]="HOST_WRITE"}(Cn||(Cn={})),function(t){t[t.NONE=0]="NONE",t[t.SAMPLE_ZERO=1]="SAMPLE_ZERO",t[t.AVERAGE=2]="AVERAGE",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(An||(An={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.RAY_TRACING=2]="RAY_TRACING"}(bn||(bn={})),function(t){t[t.POINT_LIST=0]="POINT_LIST",t[t.LINE_LIST=1]="LINE_LIST",t[t.LINE_STRIP=2]="LINE_STRIP",t[t.LINE_LOOP=3]="LINE_LOOP",t[t.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",t[t.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",t[t.ISO_LINE_LIST=6]="ISO_LINE_LIST",t[t.TRIANGLE_LIST=7]="TRIANGLE_LIST",t[t.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=9]="TRIANGLE_FAN",t[t.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",t[t.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",t[t.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",t[t.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Tn||(Tn={})),function(t){t[t.FILL=0]="FILL",t[t.POINT=1]="POINT",t[t.LINE=2]="LINE"}(En||(En={})),function(t){t[t.GOURAND=0]="GOURAND",t[t.FLAT=1]="FLAT"}(Pn||(Pn={})),function(t){t[t.NONE=0]="NONE",t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK"}(wn||(wn={})),function(t){t[t.NONE=0]="NONE",t[t.LINE_WIDTH=1]="LINE_WIDTH",t[t.DEPTH_BIAS=2]="DEPTH_BIAS",t[t.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",t[t.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",t[t.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(In||(In={})),function(t){t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK",t[t.ALL=3]="ALL"}(Rn||(Rn={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",t[t.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",t[t.STORAGE_BUFFER=4]="STORAGE_BUFFER",t[t.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",t[t.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE=64]="TEXTURE",t[t.STORAGE_IMAGE=128]="STORAGE_IMAGE",t[t.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(Dn||(Dn={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.TRANSFER=2]="TRANSFER"}(Mn||(Mn={})),function(t){t[t.OCCLUSION=0]="OCCLUSION",t[t.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",t[t.TIMESTAMP=2]="TIMESTAMP"}(On||(On={})),function(t){t[t.PRIMARY=0]="PRIMARY",t[t.SECONDARY=1]="SECONDARY"}(Bn||(Bn={})),function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.DEPTH=2]="DEPTH",t[t.STENCIL=4]="STENCIL",t[t.DEPTH_STENCIL=6]="DEPTH_STENCIL",t[t.ALL=7]="ALL"}(Nn||(Nn={}));class Fn{constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}}class zn{constructor(t=0,e=0,i=0,n=0,s=0,r=0,o=0,a=0,c=0,l=0,h=0,_=0,u=0,d=1,m=0,p=0,f=new Fn,g=new Fn,v=!1,y=-1,x=1,S=1){this.maxVertexAttributes=t,this.maxVertexUniformVectors=e,this.maxFragmentUniformVectors=i,this.maxTextureUnits=n,this.maxImageUnits=s,this.maxVertexTextureUnits=r,this.maxColorRenderTargets=o,this.maxShaderStorageBufferBindings=a,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=h,this.maxTextureSize=_,this.maxCubeMapTextureSize=u,this.uboOffsetAlignment=d,this.maxComputeSharedMemorySize=m,this.maxComputeWorkGroupInvocations=p,this.maxComputeWorkGroupSize=f,this.maxComputeWorkGroupCount=g,this.supportQuery=v,this.clipSpaceMinZ=y,this.screenSpaceSignY=x,this.clipSpaceSignY=S}copy(t){return this.maxVertexAttributes=t.maxVertexAttributes,this.maxVertexUniformVectors=t.maxVertexUniformVectors,this.maxFragmentUniformVectors=t.maxFragmentUniformVectors,this.maxTextureUnits=t.maxTextureUnits,this.maxImageUnits=t.maxImageUnits,this.maxVertexTextureUnits=t.maxVertexTextureUnits,this.maxColorRenderTargets=t.maxColorRenderTargets,this.maxShaderStorageBufferBindings=t.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=t.maxShaderStorageBlockSize,this.maxUniformBufferBindings=t.maxUniformBufferBindings,this.maxUniformBlockSize=t.maxUniformBlockSize,this.maxTextureSize=t.maxTextureSize,this.maxCubeMapTextureSize=t.maxCubeMapTextureSize,this.uboOffsetAlignment=t.uboOffsetAlignment,this.maxComputeSharedMemorySize=t.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=t.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(t.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(t.maxComputeWorkGroupCount),this.supportQuery=t.supportQuery,this.clipSpaceMinZ=t.clipSpaceMinZ,this.screenSpaceSignY=t.screenSpaceSignY,this.clipSpaceSignY=t.clipSpaceSignY,this}}class Vn{constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}}class Gn{constructor(t=0,e=0,i=0,n=0){this.x=t,this.y=e,this.width=i,this.height=n}copy(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}}class Un{constructor(t=0,e=0,i=1){this.width=t,this.height=e,this.depth=i}copy(t){return this.width=t.width,this.height=t.height,this.depth=t.depth,this}}class kn{constructor(t=0,e=0,i=1){this.mipLevel=t,this.baseArrayLayer=e,this.layerCount=i}copy(t){return this.mipLevel=t.mipLevel,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this}}class Hn{constructor(t=0,e=1,i=0,n=1){this.baseMipLevel=t,this.levelCount=e,this.baseArrayLayer=i,this.layerCount=n}copy(t){return this.baseMipLevel=t.baseMipLevel,this.levelCount=t.levelCount,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this}}class jn{constructor(t=new kn,e=new Vn,i=new kn,n=new Vn,s=new Un){this.srcSubres=t,this.srcOffset=e,this.dstSubres=i,this.dstOffset=n,this.extent=s}copy(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.extent.copy(t.extent),this}}class Wn{constructor(t=new kn,e=new Vn,i=new Un,n=new kn,s=new Vn,r=new Un){this.srcSubres=t,this.srcOffset=e,this.srcExtent=i,this.dstSubres=n,this.dstOffset=s,this.dstExtent=r}copy(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.srcExtent.copy(t.srcExtent),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.dstExtent.copy(t.dstExtent),this}}class qn{constructor(t=0,e=0,i=new Vn,n=new Un,s=new kn){this.buffStride=t,this.buffTexHeight=e,this.texOffset=i,this.texExtent=n,this.texSubres=s}copy(t){return this.buffStride=t.buffStride,this.buffTexHeight=t.buffTexHeight,this.texOffset.copy(t.texOffset),this.texExtent.copy(t.texExtent),this.texSubres.copy(t.texSubres),this}}class Xn{constructor(t=0,e=0,i=0,n=0,s=0,r=1){this.left=t,this.top=e,this.width=i,this.height=n,this.minDepth=s,this.maxDepth=r}copy(t){return this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height,this.minDepth=t.minDepth,this.maxDepth=t.maxDepth,this}}class Yn{constructor(t=0,e=0,i=0,n=0){this.x=t,this.y=e,this.z=i,this.w=n}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}}class Kn{constructor(t=[0],e=[0],i=[0],n=[0],s=[0],r=[0],o=[0],a=[0]){this.maxBlockCounts=t,this.maxSamplerTextureCounts=e,this.maxSamplerCounts=i,this.maxTextureCounts=n,this.maxBufferCounts=s,this.maxImageCounts=r,this.maxSubpassInputCounts=o,this.setIndices=a}copy(t){return this.maxBlockCounts=t.maxBlockCounts.slice(),this.maxSamplerTextureCounts=t.maxSamplerTextureCounts.slice(),this.maxSamplerCounts=t.maxSamplerCounts.slice(),this.maxTextureCounts=t.maxTextureCounts.slice(),this.maxBufferCounts=t.maxBufferCounts.slice(),this.maxImageCounts=t.maxImageCounts.slice(),this.maxSubpassInputCounts=t.maxSubpassInputCounts.slice(),this.setIndices=t.setIndices.slice(),this}}class Jn{constructor(t=null,e=_n.ON,i=0,n=0){this.windowHandle=t,this.vsyncMode=e,this.width=i,this.height=n}copy(t){return this.windowHandle=t.windowHandle,this.vsyncMode=t.vsyncMode,this.width=t.width,this.height=t.height,this}}class $n{constructor(t=new Kn){this.bindingMappingInfo=t}copy(t){return this.bindingMappingInfo.copy(t.bindingMappingInfo),this}}class Zn{constructor(t=en.NONE,e=rn.NONE,i=0,n=1,s=nn.NONE){this.usage=t,this.memUsage=e,this.size=i,this.stride=n,this.flags=s}copy(t){return this.usage=t.usage,this.memUsage=t.memUsage,this.size=t.size,this.stride=t.stride,this.flags=t.flags,this}}class Qn{constructor(t=null,e=0,i=0){this.buffer=t,this.offset=e,this.range=i}copy(t){return this.buffer=t.buffer,this.offset=t.offset,this.range=t.range,this}}class ts{constructor(t=0,e=0,i=0,n=0,s=0,r=0,o=0){this.vertexCount=t,this.firstVertex=e,this.indexCount=i,this.firstIndex=n,this.vertexOffset=s,this.instanceCount=r,this.firstInstance=o}copy(t){return this.vertexCount=t.vertexCount,this.firstVertex=t.firstVertex,this.indexCount=t.indexCount,this.firstIndex=t.firstIndex,this.vertexOffset=t.vertexOffset,this.instanceCount=t.instanceCount,this.firstInstance=t.firstInstance,this}}class es{constructor(t=0,e=0,i=0,n=null,s=0){this.groupCountX=t,this.groupCountY=e,this.groupCountZ=i,this.indirectBuffer=n,this.indirectOffset=s}copy(t){return this.groupCountX=t.groupCountX,this.groupCountY=t.groupCountY,this.groupCountZ=t.groupCountZ,this.indirectBuffer=t.indirectBuffer,this.indirectOffset=t.indirectOffset,this}}class is{constructor(t=[]){this.drawInfos=t}copy(t){return qi(this.drawInfos,t.drawInfos,ts),this}}class ss{constructor(t=on.TEX2D,e=an.NONE,i=Zi.UNKNOWN,n=0,s=0,r=cn.NONE,o=1,a=1,c=hn.ONE,l=1,h=0){this.type=t,this.usage=e,this.format=i,this.width=n,this.height=s,this.flags=r,this.layerCount=o,this.levelCount=a,this.samples=c,this.depth=l,this.externalRes=h}copy(t){return this.type=t.type,this.usage=t.usage,this.format=t.format,this.width=t.width,this.height=t.height,this.flags=t.flags,this.layerCount=t.layerCount,this.levelCount=t.levelCount,this.samples=t.samples,this.depth=t.depth,this.externalRes=t.externalRes,this}}class rs{constructor(t=null,e=on.TEX2D,i=Zi.UNKNOWN,n=0,s=1,r=0,o=1){this.texture=t,this.type=e,this.format=i,this.baseLevel=n,this.levelCount=s,this.baseLayer=r,this.layerCount=o}copy(t){return this.texture=t.texture,this.type=t.type,this.format=t.format,this.baseLevel=t.baseLevel,this.levelCount=t.levelCount,this.baseLayer=t.baseLayer,this.layerCount=t.layerCount,this}}class os{constructor(t=un.LINEAR,e=un.LINEAR,i=un.NONE,n=dn.WRAP,s=dn.WRAP,r=dn.WRAP,o=0,a=mn.ALWAYS){this.minFilter=t,this.magFilter=e,this.mipFilter=i,this.addressU=n,this.addressV=s,this.addressW=r,this.maxAnisotropy=o,this.cmpFunc=a}copy(t){return this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.mipFilter=t.mipFilter,this.addressU=t.addressU,this.addressV=t.addressV,this.addressW=t.addressW,this.maxAnisotropy=t.maxAnisotropy,this.cmpFunc=t.cmpFunc,this}}class as{constructor(t="",e=tn.UNKNOWN,i=0){this.name=t,this.type=e,this.count=i}copy(t){return this.name=t.name,this.type=t.type,this.count=t.count,this}}class cs{constructor(t=0,e=0,i="",n=[],s=0){this.set=t,this.binding=e,this.name=i,this.members=n,this.count=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,qi(this.members,t.members,as),this.count=t.count,this}}class ls{constructor(t=0,e=0,i="",n=tn.UNKNOWN,s=0){this.set=t,this.binding=e,this.name=i,this.type=n,this.count=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this}}class hs{constructor(t=0,e=0,i="",n=0){this.set=t,this.binding=e,this.name=i,this.count=n}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this}}class _s{constructor(t=0,e=0,i="",n=tn.UNKNOWN,s=0){this.set=t,this.binding=e,this.name=i,this.type=n,this.count=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this}}class us{constructor(t=0,e=0,i="",n=tn.UNKNOWN,s=0,r=sn.READ_WRITE){this.set=t,this.binding=e,this.name=i,this.type=n,this.count=s,this.memoryAccess=r}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.memoryAccess=t.memoryAccess,this}}class ds{constructor(t=0,e=0,i="",n=0,s=sn.READ_WRITE){this.set=t,this.binding=e,this.name=i,this.count=n,this.memoryAccess=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.memoryAccess=t.memoryAccess,this}}class ms{constructor(t=0,e=0,i="",n=0){this.set=t,this.binding=e,this.name=i,this.count=n}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this}}class ps{constructor(t=yn.NONE,e=""){this.stage=t,this.source=e}copy(t){return this.stage=t.stage,this.source=t.source,this}}class fs{constructor(t="",e=Zi.UNKNOWN,i=!1,n=0,s=!1,r=0){this.name=t,this.format=e,this.isNormalized=i,this.stream=n,this.isInstanced=s,this.location=r}copy(t){return this.name=t.name,this.format=t.format,this.isNormalized=t.isNormalized,this.stream=t.stream,this.isInstanced=t.isInstanced,this.location=t.location,this}}class gs{constructor(t="",e=[],i=[],n=[],s=[],r=[],o=[],a=[],c=[],l=[]){this.name=t,this.stages=e,this.attributes=i,this.blocks=n,this.buffers=s,this.samplerTextures=r,this.samplers=o,this.textures=a,this.images=c,this.subpassInputs=l}copy(t){return this.name=t.name,qi(this.stages,t.stages,ps),qi(this.attributes,t.attributes,fs),qi(this.blocks,t.blocks,cs),qi(this.buffers,t.buffers,ds),qi(this.samplerTextures,t.samplerTextures,ls),qi(this.samplers,t.samplers,hs),qi(this.textures,t.textures,_s),qi(this.images,t.images,us),qi(this.subpassInputs,t.subpassInputs,ms),this}}class vs{constructor(t=[],e=[],i=null,n=null){this.attributes=t,this.vertexBuffers=e,this.indexBuffer=i,this.indirectBuffer=n}copy(t){return qi(this.attributes,t.attributes,fs),this.vertexBuffers=t.vertexBuffers.slice(),this.indexBuffer=t.indexBuffer,this.indirectBuffer=t.indirectBuffer,this}}class ys{constructor(t=Zi.UNKNOWN,e=hn.ONE,i=xn.CLEAR,n=Sn.STORE,s=null,r=!1){this.format=t,this.sampleCount=e,this.loadOp=i,this.storeOp=n,this.barrier=s,this.isGeneralLayout=r}copy(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.loadOp=t.loadOp,this.storeOp=t.storeOp,this.barrier=t.barrier,this.isGeneralLayout=t.isGeneralLayout,this}}class xs{constructor(t=Zi.UNKNOWN,e=hn.ONE,i=xn.CLEAR,n=Sn.STORE,s=xn.CLEAR,r=Sn.STORE,o=null,a=!1){this.format=t,this.sampleCount=e,this.depthLoadOp=i,this.depthStoreOp=n,this.stencilLoadOp=s,this.stencilStoreOp=r,this.barrier=o,this.isGeneralLayout=a}copy(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.depthLoadOp=t.depthLoadOp,this.depthStoreOp=t.depthStoreOp,this.stencilLoadOp=t.stencilLoadOp,this.stencilStoreOp=t.stencilStoreOp,this.barrier=t.barrier,this.isGeneralLayout=t.isGeneralLayout,this}}class Ss{constructor(t=[],e=[],i=[],n=[],s=-1,r=-1,o=An.NONE,a=An.NONE){this.inputs=t,this.colors=e,this.resolves=i,this.preserves=n,this.depthStencil=s,this.depthStencilResolve=r,this.depthResolveMode=o,this.stencilResolveMode=a}copy(t){return this.inputs=t.inputs.slice(),this.colors=t.colors.slice(),this.resolves=t.resolves.slice(),this.preserves=t.preserves.slice(),this.depthStencil=t.depthStencil,this.depthStencilResolve=t.depthStencilResolve,this.depthResolveMode=t.depthResolveMode,this.stencilResolveMode=t.stencilResolveMode,this}}class Cs{constructor(t=0,e=0,i=null){this.srcSubpass=t,this.dstSubpass=e,this.barrier=i}copy(t){return this.srcSubpass=t.srcSubpass,this.dstSubpass=t.dstSubpass,this.barrier=t.barrier,this}}class As{constructor(t=[],e=new xs,i=[],n=[]){this.colorAttachments=t,this.depthStencilAttachment=e,this.subpasses=i,this.dependencies=n}copy(t){return qi(this.colorAttachments,t.colorAttachments,ys),this.depthStencilAttachment.copy(t.depthStencilAttachment),qi(this.subpasses,t.subpasses,Ss),qi(this.dependencies,t.dependencies,Cs),this}}class bs{constructor(t=Cn.NONE,e=Cn.NONE){this.prevAccesses=t,this.nextAccesses=e}copy(t){return this.prevAccesses=t.prevAccesses,this.nextAccesses=t.nextAccesses,this}}class Ts{constructor(t=Cn.NONE,e=Cn.NONE,i=!1,n=null,s=null){this.prevAccesses=t,this.nextAccesses=e,this.discardContents=i,this.srcQueue=n,this.dstQueue=s}copy(t){return this.prevAccesses=t.prevAccesses,this.nextAccesses=t.nextAccesses,this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this}}class Es{constructor(t=null,e=[],i=null){this.renderPass=t,this.colorTextures=e,this.depthStencilTexture=i}copy(t){return this.renderPass=t.renderPass,this.colorTextures=t.colorTextures.slice(),this.depthStencilTexture=t.depthStencilTexture,this}}class Ps{constructor(t=-1,e=Dn.UNKNOWN,i=0,n=yn.NONE,s=[]){this.binding=t,this.descriptorType=e,this.count=i,this.stageFlags=n,this.immutableSamplers=s}copy(t){return this.binding=t.binding,this.descriptorType=t.descriptorType,this.count=t.count,this.stageFlags=t.stageFlags,this.immutableSamplers=t.immutableSamplers.slice(),this}}class ws{constructor(t=[]){this.bindings=t}copy(t){return qi(this.bindings,t.bindings,Ps),this}}class Is{constructor(t=null){this.layout=t}copy(t){return this.layout=t.layout,this}}class Rs{constructor(t=[]){this.setLayouts=t}copy(t){return this.setLayouts=t.setLayouts.slice(),this}}class Ds{constructor(t=[]){this.attributes=t}copy(t){return qi(this.attributes,t.attributes,fs),this}}class Ms{constructor(t=null,e=Bn.PRIMARY){this.queue=t,this.type=e}copy(t){return this.queue=t.queue,this.type=t.type,this}}class Os{constructor(t=Mn.GRAPHICS){this.type=t}copy(t){return this.type=t.type,this}}class Bs{constructor(t=On.OCCLUSION,e=32767,i=!0){this.type=t,this.maxQueryObjects=e,this.forceWait=i}copy(t){return this.type=t.type,this.maxQueryObjects=t.maxQueryObjects,this.forceWait=t.forceWait,this}}class Ns{constructor(t="",e=0,i=0,n=Qi.NONE,s=!1,r=!1,o=!1,a=!1){this.name=t,this.size=e,this.count=i,this.type=n,this.hasAlpha=s,this.hasDepth=r,this.hasStencil=o,this.isCompressed=a}}class Ls{constructor(t=0,e=0){this.bufferSize=t,this.textureSize=e}copy(t){return this.bufferSize=t.bufferSize,this.textureSize=t.textureSize,this}}class Fs{constructor(t=0,e=0,i=0){this.writeMask=t,this.compareMask=e,this.reference=i}copy(t){return this.writeMask=t.writeMask,this.compareMask=t.compareMask,this.reference=t.reference,this}}class zs{constructor(t=new Xn,e=new Gn,i=new Yn,n=1,s=0,r=0,o=0,a=0,c=0,l=new Fs,h=new Fs){this.viewport=t,this.scissor=e,this.blendConstant=i,this.lineWidth=n,this.depthBiasConstant=s,this.depthBiasClamp=r,this.depthBiasSlope=o,this.depthMinBounds=a,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=h}copy(t){return this.viewport.copy(t.viewport),this.scissor.copy(t.scissor),this.blendConstant.copy(t.blendConstant),this.lineWidth=t.lineWidth,this.depthBiasConstant=t.depthBiasConstant,this.depthBiasClamp=t.depthBiasClamp,this.depthBiasSlope=t.depthBiasSlope,this.depthMinBounds=t.depthMinBounds,this.depthMaxBounds=t.depthMaxBounds,this.stencilStatesFront.copy(t.stencilStatesFront),this.stencilStatesBack.copy(t.stencilStatesBack),this}}class Vs extends class{constructor(){return Wi.registerGCObject(this)}destroy(){}}{get objectType(){return this._objectType}get objectID(){return this._objectID}get typedID(){return this._typedID}constructor(t){super(),this._objectType=Xi.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=t,this._objectID=Vs._idTable[Xi.UNKNOWN]++,this._typedID=Vs._idTable[t]++}}Vs._idTable=Array(Xi.COUNT).fill(65536),function(t){t.ATTR_POSITION="a_position",t.ATTR_NORMAL="a_normal",t.ATTR_TANGENT="a_tangent",t.ATTR_BITANGENT="a_bitangent",t.ATTR_WEIGHTS="a_weights",t.ATTR_JOINTS="a_joints",t.ATTR_COLOR="a_color",t.ATTR_COLOR1="a_color1",t.ATTR_COLOR2="a_color2",t.ATTR_TEX_COORD="a_texCoord",t.ATTR_TEX_COORD1="a_texCoord1",t.ATTR_TEX_COORD2="a_texCoord2",t.ATTR_TEX_COORD3="a_texCoord3",t.ATTR_TEX_COORD4="a_texCoord4",t.ATTR_TEX_COORD5="a_texCoord5",t.ATTR_TEX_COORD6="a_texCoord6",t.ATTR_TEX_COORD7="a_texCoord7",t.ATTR_TEX_COORD8="a_texCoord8",t.ATTR_BATCH_ID="a_batch_id",t.ATTR_BATCH_UV="a_batch_uv"}(Ln||(Ln={}));const Gs=Object.freeze([new Ns("UNKNOWN",0,0,Qi.NONE,!1,!1,!1,!1),new Ns("A8",1,1,Qi.UNORM,!0,!1,!1,!1),new Ns("L8",1,1,Qi.UNORM,!1,!1,!1,!1),new Ns("LA8",1,2,Qi.UNORM,!0,!1,!1,!1),new Ns("R8",1,1,Qi.UNORM,!1,!1,!1,!1),new Ns("R8SN",1,1,Qi.SNORM,!1,!1,!1,!1),new Ns("R8UI",1,1,Qi.UINT,!1,!1,!1,!1),new Ns("R8I",1,1,Qi.INT,!1,!1,!1,!1),new Ns("R16F",2,1,Qi.FLOAT,!1,!1,!1,!1),new Ns("R16UI",2,1,Qi.UINT,!1,!1,!1,!1),new Ns("R16I",2,1,Qi.INT,!1,!1,!1,!1),new Ns("R32F",4,1,Qi.FLOAT,!1,!1,!1,!1),new Ns("R32UI",4,1,Qi.UINT,!1,!1,!1,!1),new Ns("R32I",4,1,Qi.INT,!1,!1,!1,!1),new Ns("RG8",2,2,Qi.UNORM,!1,!1,!1,!1),new Ns("RG8SN",2,2,Qi.SNORM,!1,!1,!1,!1),new Ns("RG8UI",2,2,Qi.UINT,!1,!1,!1,!1),new Ns("RG8I",2,2,Qi.INT,!1,!1,!1,!1),new Ns("RG16F",4,2,Qi.FLOAT,!1,!1,!1,!1),new Ns("RG16UI",4,2,Qi.UINT,!1,!1,!1,!1),new Ns("RG16I",4,2,Qi.INT,!1,!1,!1,!1),new Ns("RG32F",8,2,Qi.FLOAT,!1,!1,!1,!1),new Ns("RG32UI",8,2,Qi.UINT,!1,!1,!1,!1),new Ns("RG32I",8,2,Qi.INT,!1,!1,!1,!1),new Ns("RGB8",3,3,Qi.UNORM,!1,!1,!1,!1),new Ns("SRGB8",3,3,Qi.UNORM,!1,!1,!1,!1),new Ns("RGB8SN",3,3,Qi.SNORM,!1,!1,!1,!1),new Ns("RGB8UI",3,3,Qi.UINT,!1,!1,!1,!1),new Ns("RGB8I",3,3,Qi.INT,!1,!1,!1,!1),new Ns("RGB16F",6,3,Qi.FLOAT,!1,!1,!1,!1),new Ns("RGB16UI",6,3,Qi.UINT,!1,!1,!1,!1),new Ns("RGB16I",6,3,Qi.INT,!1,!1,!1,!1),new Ns("RGB32F",12,3,Qi.FLOAT,!1,!1,!1,!1),new Ns("RGB32UI",12,3,Qi.UINT,!1,!1,!1,!1),new Ns("RGB32I",12,3,Qi.INT,!1,!1,!1,!1),new Ns("RGBA8",4,4,Qi.UNORM,!0,!1,!1,!1),new Ns("BGRA8",4,4,Qi.UNORM,!0,!1,!1,!1),new Ns("SRGB8_A8",4,4,Qi.UNORM,!0,!1,!1,!1),new Ns("RGBA8SN",4,4,Qi.SNORM,!0,!1,!1,!1),new Ns("RGBA8UI",4,4,Qi.UINT,!0,!1,!1,!1),new Ns("RGBA8I",4,4,Qi.INT,!0,!1,!1,!1),new Ns("RGBA16F",8,4,Qi.FLOAT,!0,!1,!1,!1),new Ns("RGBA16UI",8,4,Qi.UINT,!0,!1,!1,!1),new Ns("RGBA16I",8,4,Qi.INT,!0,!1,!1,!1),new Ns("RGBA32F",16,4,Qi.FLOAT,!0,!1,!1,!1),new Ns("RGBA32UI",16,4,Qi.UINT,!0,!1,!1,!1),new Ns("RGBA32I",16,4,Qi.INT,!0,!1,!1,!1),new Ns("R5G6B5",2,3,Qi.UNORM,!1,!1,!1,!1),new Ns("R11G11B10F",4,3,Qi.FLOAT,!1,!1,!1,!1),new Ns("RGB5A1",2,4,Qi.UNORM,!0,!1,!1,!1),new Ns("RGBA4",2,4,Qi.UNORM,!0,!1,!1,!1),new Ns("RGB10A2",2,4,Qi.UNORM,!0,!1,!1,!1),new Ns("RGB10A2UI",2,4,Qi.UINT,!0,!1,!1,!1),new Ns("RGB9E5",2,4,Qi.FLOAT,!0,!1,!1,!1),new Ns("DEPTH",4,1,Qi.FLOAT,!1,!0,!1,!1),new Ns("DEPTH_STENCIL",5,2,Qi.FLOAT,!1,!0,!0,!1),new Ns("BC1",1,3,Qi.UNORM,!1,!1,!1,!0),new Ns("BC1_ALPHA",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("BC1_SRGB",1,3,Qi.UNORM,!1,!1,!1,!0),new Ns("BC1_SRGB_ALPHA",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("BC2",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("BC2_SRGB",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("BC3",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("BC3_SRGB",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("BC4",1,1,Qi.UNORM,!1,!1,!1,!0),new Ns("BC4_SNORM",1,1,Qi.SNORM,!1,!1,!1,!0),new Ns("BC5",1,2,Qi.UNORM,!1,!1,!1,!0),new Ns("BC5_SNORM",1,2,Qi.SNORM,!1,!1,!1,!0),new Ns("BC6H_UF16",1,3,Qi.UFLOAT,!1,!1,!1,!0),new Ns("BC6H_SF16",1,3,Qi.FLOAT,!1,!1,!1,!0),new Ns("BC7",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("BC7_SRGB",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ETC_RGB8",1,3,Qi.UNORM,!1,!1,!1,!0),new Ns("ETC2_RGB8",1,3,Qi.UNORM,!1,!1,!1,!0),new Ns("ETC2_SRGB8",1,3,Qi.UNORM,!1,!1,!1,!0),new Ns("ETC2_RGB8_A1",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ETC2_SRGB8_A1",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ETC2_RGBA8",2,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ETC2_SRGB8_A8",2,4,Qi.UNORM,!0,!1,!1,!0),new Ns("EAC_R11",1,1,Qi.UNORM,!1,!1,!1,!0),new Ns("EAC_R11SN",1,1,Qi.SNORM,!1,!1,!1,!0),new Ns("EAC_RG11",2,2,Qi.UNORM,!1,!1,!1,!0),new Ns("EAC_RG11SN",2,2,Qi.SNORM,!1,!1,!1,!0),new Ns("PVRTC_RGB2",2,3,Qi.UNORM,!1,!1,!1,!0),new Ns("PVRTC_RGBA2",2,4,Qi.UNORM,!0,!1,!1,!0),new Ns("PVRTC_RGB4",2,3,Qi.UNORM,!1,!1,!1,!0),new Ns("PVRTC_RGBA4",2,4,Qi.UNORM,!0,!1,!1,!0),new Ns("PVRTC2_2BPP",2,4,Qi.UNORM,!0,!1,!1,!0),new Ns("PVRTC2_4BPP",2,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_4x4",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_5x4",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_5x5",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_6x5",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_6x6",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_8x5",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_8x6",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_8x8",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_10x5",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_10x6",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_10x8",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_10x10",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_12x10",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_RGBA_12x12",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_4x4",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_5x4",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_5x5",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_6x5",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_6x6",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_8x5",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_8x6",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_8x8",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_10x5",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_10x6",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_10x8",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_10x10",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_12x10",1,4,Qi.UNORM,!0,!1,!1,!0),new Ns("ASTC_SRGBA_12x12",1,4,Qi.UNORM,!0,!1,!1,!0)]),Us=Dn.UNIFORM_BUFFER|Dn.DYNAMIC_UNIFORM_BUFFER|Dn.STORAGE_BUFFER|Dn.DYNAMIC_STORAGE_BUFFER,ks=Dn.SAMPLER_TEXTURE|Dn.SAMPLER|Dn.TEXTURE|Dn.STORAGE_IMAGE|Dn.INPUT_ATTACHMENT,Hs=Dn.DYNAMIC_STORAGE_BUFFER|Dn.DYNAMIC_UNIFORM_BUFFER;function js(t){return t>0&&0==(t&t-1)}function Ws(t,e,i,n){if(!Gs[t].isCompressed)return e*i*n*Gs[t].size;switch(t){case Zi.BC1:case Zi.BC1_ALPHA:case Zi.BC1_SRGB:case Zi.BC1_SRGB_ALPHA:return Math.ceil(e/4)*Math.ceil(i/4)*8*n;case Zi.BC2:case Zi.BC2_SRGB:case Zi.BC3:case Zi.BC3_SRGB:case Zi.BC4:case Zi.BC4_SNORM:case Zi.BC6H_SF16:case Zi.BC6H_UF16:case Zi.BC7:case Zi.BC7_SRGB:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case Zi.BC5:case Zi.BC5_SNORM:return Math.ceil(e/4)*Math.ceil(i/4)*32*n;case Zi.ETC_RGB8:case Zi.ETC2_RGB8:case Zi.ETC2_SRGB8:case Zi.ETC2_RGB8_A1:case Zi.EAC_R11:case Zi.EAC_R11SN:return Math.ceil(e/4)*Math.ceil(i/4)*8*n;case Zi.ETC2_RGBA8:case Zi.ETC2_SRGB8_A1:case Zi.EAC_RG11:case Zi.EAC_RG11SN:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case Zi.PVRTC_RGB2:case Zi.PVRTC_RGBA2:case Zi.PVRTC2_2BPP:return Math.ceil(Math.max(e,16)*Math.max(i,8)/4)*n;case Zi.PVRTC_RGB4:case Zi.PVRTC_RGBA4:case Zi.PVRTC2_4BPP:return Math.ceil(Math.max(e,8)*Math.max(i,8)/2)*n;case Zi.ASTC_RGBA_4X4:case Zi.ASTC_SRGBA_4X4:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case Zi.ASTC_RGBA_5X4:case Zi.ASTC_SRGBA_5X4:return Math.ceil(e/5)*Math.ceil(i/4)*16*n;case Zi.ASTC_RGBA_5X5:case Zi.ASTC_SRGBA_5X5:return Math.ceil(e/5)*Math.ceil(i/5)*16*n;case Zi.ASTC_RGBA_6X5:case Zi.ASTC_SRGBA_6X5:return Math.ceil(e/6)*Math.ceil(i/5)*16*n;case Zi.ASTC_RGBA_6X6:case Zi.ASTC_SRGBA_6X6:return Math.ceil(e/6)*Math.ceil(i/6)*16*n;case Zi.ASTC_RGBA_8X5:case Zi.ASTC_SRGBA_8X5:return Math.ceil(e/8)*Math.ceil(i/5)*16*n;case Zi.ASTC_RGBA_8X6:case Zi.ASTC_SRGBA_8X6:return Math.ceil(e/8)*Math.ceil(i/6)*16*n;case Zi.ASTC_RGBA_8X8:case Zi.ASTC_SRGBA_8X8:return Math.ceil(e/8)*Math.ceil(i/8)*16*n;case Zi.ASTC_RGBA_10X5:case Zi.ASTC_SRGBA_10X5:return Math.ceil(e/10)*Math.ceil(i/5)*16*n;case Zi.ASTC_RGBA_10X6:case Zi.ASTC_SRGBA_10X6:return Math.ceil(e/10)*Math.ceil(i/6)*16*n;case Zi.ASTC_RGBA_10X8:case Zi.ASTC_SRGBA_10X8:return Math.ceil(e/10)*Math.ceil(i/8)*16*n;case Zi.ASTC_RGBA_10X10:case Zi.ASTC_SRGBA_10X10:return Math.ceil(e/10)*Math.ceil(i/10)*16*n;case Zi.ASTC_RGBA_12X10:case Zi.ASTC_SRGBA_12X10:return Math.ceil(e/12)*Math.ceil(i/10)*16*n;case Zi.ASTC_RGBA_12X12:case Zi.ASTC_SRGBA_12X12:return Math.ceil(e/12)*Math.ceil(i/12)*16*n;default:return 0}}function qs(t,e,i,n,s){let r=0;for(let o=0;o<s;++o)r+=Ws(t,e,i,n),e=Math.max(e>>1,1),i=Math.max(i>>1,1);return r}const Xs=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Ys(t){return Xs[t]||0}function Ks(t){const e=t.size/t.count;switch(t.type){case Qi.UNORM:case Qi.UINT:switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Qi.SNORM:case Qi.INT:switch(e){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Qi.FLOAT:return Float32Array}return Float32Array}var Js=Object.freeze({__proto__:null,get ObjectType(){return Xi},get Status(){return Yi},get API(){return Ki},get SurfaceTransform(){return Ji},get Feature(){return $i},get Format(){return Zi},get FormatType(){return Qi},get Type(){return tn},get BufferUsageBit(){return en},get BufferFlagBit(){return nn},get MemoryAccessBit(){return sn},get MemoryUsageBit(){return rn},get TextureType(){return on},get TextureUsageBit(){return an},get TextureFlagBit(){return cn},get FormatFeatureBit(){return ln},get SampleCount(){return hn},get VsyncMode(){return _n},get Filter(){return un},get Address(){return dn},get ComparisonFunc(){return mn},get StencilOp(){return pn},get BlendFactor(){return fn},get BlendOp(){return gn},get ColorMask(){return vn},get ShaderStageFlagBit(){return yn},get LoadOp(){return xn},get StoreOp(){return Sn},get AccessFlagBit(){return Cn},get ResolveMode(){return An},get PipelineBindPoint(){return bn},get PrimitiveMode(){return Tn},get PolygonMode(){return En},get ShadeModel(){return Pn},get CullMode(){return wn},get DynamicStateFlagBit(){return In},get StencilFace(){return Rn},get DescriptorType(){return Dn},get QueueType(){return Mn},get QueryType(){return On},get CommandBufferType(){return Bn},get ClearFlagBit(){return Nn},Size:Fn,DeviceCaps:zn,Offset:Vn,Rect:Gn,Extent:Un,TextureSubresLayers:kn,TextureSubresRange:Hn,TextureCopy:jn,TextureBlit:Wn,BufferTextureCopy:qn,Viewport:Xn,Color:Yn,BindingMappingInfo:Kn,SwapchainInfo:Jn,DeviceInfo:$n,BufferInfo:Zn,BufferViewInfo:Qn,DrawInfo:ts,DispatchInfo:es,IndirectBuffer:is,TextureInfo:ss,TextureViewInfo:rs,SamplerInfo:os,Uniform:as,UniformBlock:cs,UniformSamplerTexture:ls,UniformSampler:hs,UniformTexture:_s,UniformStorageImage:us,UniformStorageBuffer:ds,UniformInputAttachment:ms,ShaderStage:ps,Attribute:fs,ShaderInfo:gs,InputAssemblerInfo:vs,ColorAttachment:ys,DepthStencilAttachment:xs,SubpassInfo:Ss,SubpassDependency:Cs,RenderPassInfo:As,GeneralBarrierInfo:bs,TextureBarrierInfo:Ts,FramebufferInfo:Es,DescriptorSetLayoutBinding:Ps,DescriptorSetLayoutInfo:ws,DescriptorSetInfo:Is,PipelineLayoutInfo:Rs,InputState:Ds,CommandBufferInfo:Ms,QueueInfo:Os,QueryPoolInfo:Bs,FormatInfo:Ns,MemoryStatus:Ls,DynamicStencilStates:Fs,DynamicStates:zs,GFXObject:Vs,get AttributeName(){return Ln},FormatInfos:Gs,DESCRIPTOR_BUFFER_TYPE:Us,DESCRIPTOR_SAMPLER_TYPE:ks,DESCRIPTOR_DYNAMIC_TYPE:Hs,DRAW_INFO_SIZE:28,IsPowerOf2:js,FormatSize:Ws,FormatSurfaceSize:qs,GetTypeSize:Ys,getTypedArrayConstructor:Ks});class $s{constructor(t=!1,e=En.FILL,i=Pn.GOURAND,n=wn.BACK,s=!0,r=!1,o=0,a=0,c=0,l=!0,h=!1,_=1){this._nativeObj=void 0,this._isDiscard=!1,this._polygonMode=En.FILL,this._shadeModel=Pn.GOURAND,this._cullMode=wn.BACK,this._isFrontFaceCCW=!0,this._depthBiasEnabled=!1,this._depthBias=0,this._depthBiasClamp=0,this._depthBiasSlop=0,this._isDepthClip=!0,this._isMultisample=!1,this._lineWidth=1,this._nativeObj=new gfx.RasterizerState,this.assignProperties(t,e,i,n,s,r,o,a,c,l,h,_)}get native(){return this._nativeObj}get isDiscard(){return this._isDiscard}set isDiscard(t){this._isDiscard=t,this._nativeObj.isDiscard=t}get polygonMode(){return this._polygonMode}set polygonMode(t){this._polygonMode=t,this._nativeObj.polygonMode=t}get shadeModel(){return this._shadeModel}set shadeModel(t){this._shadeModel=t,this._nativeObj.shadeModel=t}get cullMode(){return this._cullMode}set cullMode(t){this._cullMode=t,this._nativeObj.cullMode=t}get isFrontFaceCCW(){return this._isFrontFaceCCW}set isFrontFaceCCW(t){this._isFrontFaceCCW=t,this._nativeObj.isFrontFaceCCW=t}get depthBiasEnabled(){return this._depthBiasEnabled}set depthBiasEnabled(t){this._depthBiasEnabled=t,this._nativeObj.depthBiasEnabled=t}get depthBias(){return this._depthBias}set depthBias(t){this._depthBias=t,this._nativeObj.depthBias=t}get depthBiasClamp(){return this._depthBiasClamp}set depthBiasClamp(t){this._depthBiasClamp=t,this._nativeObj.depthBiasClamp=t}get depthBiasSlop(){return this._depthBiasSlop}set depthBiasSlop(t){this._depthBiasSlop=t,this._nativeObj.depthBiasSlop=t}get isDepthClip(){return this._isDepthClip}set isDepthClip(t){this._isDepthClip=t,this._nativeObj.isDepthClip=t}get isMultisample(){return this._isMultisample}set isMultisample(t){this._isMultisample=t,this._nativeObj.isMultisample=t}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this._nativeObj.lineWidth=t}reset(){this.assignProperties(!1,En.FILL,Pn.GOURAND,wn.BACK,!0,!1,0,0,0,!0,!1,1)}assign(t){t&&this.assignProperties(t.isDiscard,t.polygonMode,t.shadeModel,t.cullMode,t.isFrontFaceCCW,t.depthBiasEnabled,t.depthBias,t.depthBiasClamp,t.depthBiasSlop,t.isDepthClip,t.isMultisample,t.lineWidth)}destroy(){this._nativeObj=null}assignProperties(t,e,i,n,s,r,o,a,c,l,h,_){void 0!==t&&(this.isDiscard=t),void 0!==e&&(this.polygonMode=e),void 0!==i&&(this.shadeModel=i),void 0!==n&&(this.cullMode=n),void 0!==s&&(this.isFrontFaceCCW=s),void 0!==r&&(this.depthBiasEnabled=r),void 0!==o&&(this.depthBias=o),void 0!==a&&(this.depthBiasClamp=a),void 0!==c&&(this.depthBiasSlop=c),void 0!==l&&(this.isDepthClip=l),void 0!==h&&(this.isMultisample=h),void 0!==_&&(this.lineWidth=_)}}class Zs{constructor(t=!0,e=!0,i=mn.LESS,n=!1,s=mn.ALWAYS,r=65535,o=65535,a=pn.KEEP,c=pn.KEEP,l=pn.KEEP,h=1,_=!1,u=mn.ALWAYS,d=65535,m=65535,p=pn.KEEP,f=pn.KEEP,g=pn.KEEP,v=1){this._nativeObj=void 0,this._depthTest=!0,this._depthWrite=!0,this._depthFunc=mn.LESS,this._stencilTestFront=!1,this._stencilFuncFront=mn.ALWAYS,this._stencilReadMaskFront=65535,this._stencilWriteMaskFront=65535,this._stencilFailOpFront=pn.KEEP,this._stencilZFailOpFront=pn.KEEP,this._stencilPassOpFront=pn.KEEP,this._stencilRefFront=1,this._stencilTestBack=!1,this._stencilFuncBack=mn.ALWAYS,this._stencilReadMaskBack=65535,this._stencilWriteMaskBack=65535,this._stencilFailOpBack=pn.KEEP,this._stencilZFailOpBack=pn.KEEP,this._stencilPassOpBack=pn.KEEP,this._stencilRefBack=1,this._nativeObj=new gfx.DepthStencilState,this.assignProperties(t,e,i,n,s,r,o,a,c,l,h,_,u,d,m,p,f,g,v)}get native(){return this._nativeObj}get depthTest(){return this._depthTest}set depthTest(t){this._depthTest=t,this._nativeObj.depthTest=t}get depthWrite(){return this._depthWrite}set depthWrite(t){this._depthWrite=t,this._nativeObj.depthWrite=t}get depthFunc(){return this._depthFunc}set depthFunc(t){this._depthFunc=t,this._nativeObj.depthFunc=t}get stencilTestFront(){return this._stencilTestFront}set stencilTestFront(t){this._stencilTestFront=t,this._nativeObj.stencilTestFront=t}get stencilFuncFront(){return this._stencilFuncFront}set stencilFuncFront(t){this._stencilFuncFront=t,this._nativeObj.stencilFuncFront=t}get stencilReadMaskFront(){return this._stencilReadMaskFront}set stencilReadMaskFront(t){this._stencilReadMaskFront=t,this._nativeObj.stencilReadMaskFront=t}get stencilWriteMaskFront(){return this._stencilWriteMaskFront}set stencilWriteMaskFront(t){this._stencilWriteMaskFront=t,this._nativeObj.stencilWriteMaskFront=t}get stencilFailOpFront(){return this._stencilFailOpFront}set stencilFailOpFront(t){this._stencilFailOpFront=t,this._nativeObj.stencilFailOpFront=t}get stencilZFailOpFront(){return this._stencilZFailOpFront}set stencilZFailOpFront(t){this._stencilZFailOpFront=t,this._nativeObj.stencilZFailOpFront=t}get stencilPassOpFront(){return this._stencilPassOpFront}set stencilPassOpFront(t){this._stencilPassOpFront=t,this._nativeObj.stencilPassOpFront=t}get stencilRefFront(){return this._stencilRefFront}set stencilRefFront(t){this._stencilRefFront=t,this._nativeObj.stencilRefFront=t}get stencilTestBack(){return this._stencilTestBack}set stencilTestBack(t){this._stencilTestBack=t,this._nativeObj.stencilTestBack=t}get stencilFuncBack(){return this._stencilFuncBack}set stencilFuncBack(t){this._stencilFuncBack=t,this._nativeObj.stencilFuncBack=t}get stencilReadMaskBack(){return this._stencilReadMaskBack}set stencilReadMaskBack(t){this._stencilReadMaskBack=t,this._nativeObj.stencilReadMaskBack=t}get stencilWriteMaskBack(){return this._stencilWriteMaskBack}set stencilWriteMaskBack(t){this._stencilWriteMaskBack=t,this._nativeObj.stencilWriteMaskBack=t}get stencilFailOpBack(){return this._stencilFailOpBack}set stencilFailOpBack(t){this._stencilFailOpBack=t,this._nativeObj.stencilFailOpBack=t}get stencilZFailOpBack(){return this._stencilZFailOpBack}set stencilZFailOpBack(t){this._stencilZFailOpBack=t,this._nativeObj.stencilZFailOpBack=t}get stencilPassOpBack(){return this._stencilPassOpBack}set stencilPassOpBack(t){this._stencilPassOpBack=t,this._nativeObj.stencilPassOpBack=t}get stencilRefBack(){return this._stencilRefBack}set stencilRefBack(t){this._stencilRefBack=t,this._nativeObj.stencilRefBack=t}reset(){this.assignProperties(!0,!0,mn.LESS,!1,mn.ALWAYS,65535,65535,pn.KEEP,pn.KEEP,pn.KEEP,1,!1,mn.ALWAYS,65535,65535,pn.KEEP,pn.KEEP,pn.KEEP,1)}assign(t){t&&this.assignProperties(t.depthTest,t.depthWrite,t.depthFunc,t.stencilTestFront,t.stencilFuncFront,t.stencilReadMaskFront,t.stencilWriteMaskFront,t.stencilFailOpFront,t.stencilZFailOpFront,t.stencilPassOpFront,t.stencilRefFront,t.stencilTestBack,t.stencilFuncBack,t.stencilReadMaskBack,t.stencilWriteMaskBack,t.stencilFailOpBack,t.stencilZFailOpBack,t.stencilPassOpBack,t.stencilRefBack)}destroy(){this._nativeObj=null}assignProperties(t,e,i,n,s,r,o,a,c,l,h,_,u,d,m,p,f,g,v){void 0!==t&&(this.depthTest=t),void 0!==e&&(this.depthWrite=e),void 0!==i&&(this.depthFunc=i),void 0!==n&&(this.stencilTestFront=n),void 0!==s&&(this.stencilFuncFront=s),void 0!==r&&(this.stencilReadMaskFront=r),void 0!==o&&(this.stencilWriteMaskFront=o),void 0!==a&&(this.stencilFailOpFront=a),void 0!==c&&(this.stencilZFailOpFront=c),void 0!==l&&(this.stencilPassOpFront=l),void 0!==h&&(this.stencilRefFront=h),void 0!==_&&(this.stencilTestBack=_),void 0!==u&&(this.stencilFuncBack=u),void 0!==d&&(this.stencilReadMaskBack=d),void 0!==m&&(this.stencilWriteMaskBack=m),void 0!==p&&(this.stencilFailOpBack=p),void 0!==f&&(this.stencilZFailOpBack=f),void 0!==g&&(this.stencilPassOpBack=g),void 0!==v&&(this.stencilRefBack=v)}}class Qs{get native(){return this._nativeObj}constructor(t=!1,e=fn.ONE,i=fn.ZERO,n=gn.ADD,s=fn.ONE,r=fn.ZERO,o=gn.ADD,a=vn.ALL){this._nativeObj=void 0,this._blend=!1,this._blendSrc=fn.ONE,this._blendDst=fn.ZERO,this._blendEq=gn.ADD,this._blendSrcAlpha=fn.ONE,this._blendDstAlpha=fn.ZERO,this._blendAlphaEq=gn.ADD,this._blendColorMask=vn.ALL,this._nativeObj=new gfx.BlendTarget,this.assignProperties(t,e,i,n,s,r,o,a)}get blend(){return this._blend}set blend(t){this._blend=t,this._nativeObj.blend=t}get blendSrc(){return this._blendSrc}set blendSrc(t){this._blendSrc=t,this._nativeObj.blendSrc=t}get blendDst(){return this._blendDst}set blendDst(t){this._blendDst=t,this._nativeObj.blendDst=t}get blendEq(){return this._blendEq}set blendEq(t){this._blendEq=t,this._nativeObj.blendEq=t}get blendSrcAlpha(){return this._blendSrcAlpha}set blendSrcAlpha(t){this._blendSrcAlpha=t,this._nativeObj.blendSrcAlpha=t}get blendDstAlpha(){return this._blendDstAlpha}set blendDstAlpha(t){this._blendDstAlpha=t,this._nativeObj.blendDstAlpha=t}get blendAlphaEq(){return this._blendAlphaEq}set blendAlphaEq(t){this._blendAlphaEq=t,this._nativeObj.blendAlphaEq=t}get blendColorMask(){return this._blendColorMask}set blendColorMask(t){this._blendColorMask=t,this._nativeObj.blendColorMask=t}reset(){this.assignProperties(!1,fn.ONE,fn.ZERO,gn.ADD,fn.ONE,fn.ZERO,gn.ADD,vn.ALL)}destroy(){this._nativeObj=null}assign(t){t&&this.assignProperties(t.blend,t.blendSrc,t.blendDst,t.blendEq,t.blendSrcAlpha,t.blendDstAlpha,t.blendAlphaEq,t.blendColorMask)}assignProperties(t,e,i,n,s,r,o,a){void 0!==t&&(this.blend=t),void 0!==e&&(this.blendSrc=e),void 0!==i&&(this.blendDst=i),void 0!==n&&(this.blendEq=n),void 0!==s&&(this.blendSrcAlpha=s),void 0!==r&&(this.blendDstAlpha=r),void 0!==o&&(this.blendAlphaEq=o),void 0!==a&&(this.blendColorMask=a)}}class tr{_setTargets(t){this.targets=t;const e="$__nativeObj";this._syncTargetsToNativeObj(e),function(t,e,i,n,s){for(let r=0,o=e.length;r<o;r++){let o=e[r],a=o[i].$__nativeObj||o[i];o[i]=new Proxy(a,{get:(t,e)=>e===n?t:Reflect.get(t,e),set:(e,i,n)=>(Reflect.set(e,i,n),s(t),!0)})}}(this,this.targets,"_nativeObj",e,(t=>{t._syncTargetsToNativeObj(e)}))}_syncTargetsToNativeObj(t){const e=this.targets.map((e=>e.native[t]||e.native));this._nativeObj.targets=e}get native(){return this._nativeObj}constructor(t=!1,e=!1,i=new Yn,n=[new Qs]){this.targets=void 0,this._blendColor=void 0,this._nativeObj=void 0,this._isA2C=!1,this._isIndepend=!1,this._nativeObj=new gfx.BlendState,this._setTargets(n),this.blendColor=i,this.isA2c=t,this.isIndepend=e}get isA2c(){return this._isA2C}set isA2c(t){this._isA2C=t,this._nativeObj.isA2C=t}get isIndepend(){return this._isIndepend}set isIndepend(t){this._isIndepend=t,this._nativeObj.isIndepend=t}get blendColor(){return this._blendColor}set blendColor(t){this._blendColor=t,this._nativeObj.blendColor=t}setTarget(t,e){let i=this.targets[t];i||(i=this.targets[t]=new Qs),i.assign(e),this._setTargets(this.targets)}reset(){this.isA2c=!1,this.isIndepend=!1,this.blendColor=new Yn(0,0,0,0);const t=this.targets;for(let e=1,i=t.length;e<i;++e)t[e].destroy();t.length=1,t[0].reset(),this._setTargets(t)}destroy(){for(let t=0,e=this.targets.length;t<e;++t)this.targets[t].destroy();this.targets=null,this._nativeObj=null}}const er=gfx.PipelineState,ir=gfx.PipelineStateInfo;class sr extends Vs{get layout(){return this._layout}constructor(){super(Xi.DESCRIPTOR_SET),this._layout=null,this._buffers=[],this._textures=[],this._samplers=[],this._isDirty=!1}bindBuffer(t,e,i=0){const n=this._layout.bindingIndices[t],s=this._layout.bindings[n];if(s&&s.descriptorType&Us){const n=this._layout.descriptorIndices[t];this._buffers[n+i]!==e&&(this._buffers[n+i]=e,this._isDirty=!0)}}bindSampler(t,e,i=0){const n=this._layout.bindingIndices[t],s=this._layout.bindings[n];if(s&&s.descriptorType&ks){const n=this._layout.descriptorIndices[t];this._samplers[n+i]!==e&&(this._samplers[n+i]=e,this._isDirty=!0)}}bindTexture(t,e,i=0){const n=this._layout.bindingIndices[t],s=this._layout.bindings[n];if(s&&s.descriptorType&ks){const n=this._layout.descriptorIndices[t];this._textures[n+i]!==e&&(this._textures[n+i]=e,this._isDirty=!0)}}getBuffer(t,e=0){const i=this._layout.descriptorIndices[t];return this._buffers[i+e]}getSampler(t,e=0){const i=this._layout.descriptorIndices[t];return this._samplers[i+e]}getTexture(t,e=0){const i=this._layout.descriptorIndices[t];return this._textures[i+e]}}class rr extends Vs{get usage(){return this._usage}get memUsage(){return this._memUsage}get size(){return this._size}get stride(){return this._stride}get count(){return this._count}get flags(){return this._flags}constructor(){super(Xi.BUFFER),this._usage=en.NONE,this._memUsage=rn.NONE,this._size=0,this._stride=1,this._count=0,this._flags=nn.NONE,this._isBufferView=!1}}class or extends Vs{get type(){return this._type}get queue(){return this._queue}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}constructor(){super(Xi.COMMAND_BUFFER),this._queue=null,this._type=Bn.PRIMARY,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}}class ar{constructor(){this._gfxAPI=Ki.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array($i.COUNT),this._formatFeatures=new Array(Zi.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new Ls,this._caps=new zn,this._bindingMappingInfo=new Kn,this._samplers=new Map,this._generalBarrierss=new Map,this._textureBarriers=new Map}get gfxAPI(){return this._gfxAPI}get queue(){return this._queue}get commandBuffer(){return this._cmdBuff}get renderer(){return this._renderer}get vendor(){return this._vendor}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}get memoryStatus(){return this._memoryStatus}get capabilities(){return this._caps}get bindingMappingInfo(){return this._bindingMappingInfo}hasFeature(t){return this._features[t]}getFormatFeatures(t){return this._formatFeatures[t]}}ar.canvas=void 0;class cr extends Vs{get colorTexture(){return this._colorTexture}get depthStencilTexture(){return this._depthStencilTexture}get surfaceTransform(){return this._transform}get width(){return this._colorTexture.width}get height(){return this._colorTexture.height}constructor(){super(Xi.SWAPCHAIN),this._transform=Ji.IDENTITY,this._colorTexture=null,this._depthStencilTexture=null}}class lr extends Vs{get renderPass(){return this._renderPass}get colorTextures(){return this._colorTextures}get depthStencilTexture(){return this._depthStencilTexture}constructor(){super(Xi.FRAMEBUFFER),this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null}}const hr=String.prototype.charCodeAt;function _r(t){return this[t]}function ur(t,e){let i=t.length,n=e^i,s=0;const r="string"==typeof t?hr:_r;for(;i>=4;){let e=255&r.call(t,s)|(255&r.call(t,++s))<<8|(255&r.call(t,++s))<<16|(255&r.call(t,++s))<<24;e=1540483477*(65535&e)+((1540483477*(e>>>16)&65535)<<16),e^=e>>>24,e=1540483477*(65535&e)+((1540483477*(e>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^e,i-=4,++s}switch(i){case 3:n^=(255&r.call(t,s+2))<<16;case 2:n^=(255&r.call(t,s+1))<<8;case 1:n^=255&r.call(t,s),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)}return n^=n>>>13,n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16),n^=n>>>15,n>>>0}class dr extends Vs{get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get indirectBuffer(){return this._indirectBuffer}get attributesHash(){return this._attributesHash}set vertexCount(t){this._drawInfo.vertexCount=t}get vertexCount(){return this._drawInfo.vertexCount}set firstVertex(t){this._drawInfo.firstVertex=t}get firstVertex(){return this._drawInfo.firstVertex}set indexCount(t){this._drawInfo.indexCount=t}get indexCount(){return this._drawInfo.indexCount}set firstIndex(t){this._drawInfo.firstIndex=t}get firstIndex(){return this._drawInfo.firstIndex}set vertexOffset(t){this._drawInfo.vertexOffset=t}get vertexOffset(){return this._drawInfo.vertexOffset}set instanceCount(t){this._drawInfo.instanceCount=t}get instanceCount(){return this._drawInfo.instanceCount}set firstInstance(t){this._drawInfo.firstInstance=t}get firstInstance(){return this._drawInfo.firstInstance}get drawInfo(){return this._drawInfo}constructor(){super(Xi.INPUT_ASSEMBLER),this._attributes=[],this._attributesHash=0,this._vertexBuffers=[],this._indexBuffer=null,this._indirectBuffer=null,this._drawInfo=new ts}getVertexBuffer(t=0){return t<this._vertexBuffers.length?this._vertexBuffers[t]:null}computeAttributesHash(){let t="attrs";for(let e=0;e<this.attributes.length;++e){const i=this.attributes[e];t+=`,${i.name},${i.format},${i.isNormalized},${i.stream},${i.isInstanced}`}return ur(t,666)}}class mr extends Vs{get bindings(){return this._bindings}get bindingIndices(){return this._bindingIndices}get descriptorIndices(){return this._descriptorIndices}constructor(){super(Xi.DESCRIPTOR_SET_LAYOUT),this._bindings=[],this._bindingIndices=[],this._descriptorIndices=[]}}class pr extends Vs{get setLayouts(){return this._setLayouts}constructor(){super(Xi.PIPELINE_LAYOUT),this._setLayouts=[]}}class fr extends Vs{get type(){return this._type}constructor(){super(Xi.QUEUE),this._type=Mn.GRAPHICS}}class gr extends Vs{get colorAttachments(){return this._colorInfos}get depthStencilAttachment(){return this._depthStencilInfo}get subPasses(){return this._subpasses}get hash(){return this._hash}constructor(){super(Xi.RENDER_PASS),this._colorInfos=[],this._depthStencilInfo=null,this._subpasses=[],this._hash=0}computeHash(){let t="";if(this._subpasses.length)for(let e=0;e<this._subpasses.length;++e){const i=this._subpasses[e];if(i.inputs.length){t+="ia";for(let e=0;e<i.inputs.length;++e){const n=this._colorInfos[i.inputs[e]];t+=`,${n.format},${n.sampleCount}`}}if(i.colors.length){t+="ca";for(let e=0;e<i.inputs.length;++e){const n=this._colorInfos[i.inputs[e]];t+=`,${n.format},${n.sampleCount}`}}if(i.depthStencil>=0){const e=this._colorInfos[i.depthStencil];t+=`ds,${e.format},${e.sampleCount}`}}else{t+="ca";for(let e=0;e<this._colorInfos.length;++e){const i=this._colorInfos[e];t+=`,${i.format},${i.sampleCount}`}const e=this._depthStencilInfo;e&&(t+=`ds,${e.format},${e.sampleCount}`)}return ur(t,666)}}class vr extends Vs{get name(){return this._name}get attributes(){return this._attributes}get blocks(){return this._blocks}get samplers(){return this._samplers}constructor(){super(Xi.SHADER),this._name="",this._stages=[],this._attributes=[],this._blocks=[],this._samplers=[]}}class yr extends Vs{get type(){return this._info.type}get usage(){return this._info.usage}get format(){return this._info.format}get width(){return this._info.width}get height(){return this._info.height}get depth(){return this._info.depth}get layerCount(){return this._info.layerCount}get levelCount(){return this._info.levelCount}get samples(){return this._info.samples}get flags(){return this._info.flags}get size(){return this._size}get info(){return this._info}get viewInfo(){return this._viewInfo}get isTextureView(){return this._isTextureView}constructor(){super(Xi.TEXTURE),this._info=new ss,this._viewInfo=new rs,this._isPowerOf2=!1,this._isTextureView=!1,this._size=0}static getLevelCount(t,e){return Math.floor(Math.log2(Math.max(t,e)))}}class xr extends Vs{get info(){return this._info}get hash(){return this._hash}constructor(t,e){super(Xi.SAMPLER),this._info=new os,this._hash=0,this._info.copy(t),this._hash=e}static computeHash(t){let e=t.minFilter;return e|=t.magFilter<<2,e|=t.mipFilter<<4,e|=t.addressU<<6,e|=t.addressV<<8,e|=t.addressW<<10,e|=t.maxAnisotropy<<12,e|=t.cmpFunc<<16,e}static unpackFromHash(t){const e=new os;return e.minFilter=(3&t)>>0,e.magFilter=(3&t)>>2,e.mipFilter=(3&t)>>4,e.addressU=(3&t)>>6,e.addressV=(3&t)>>8,e.addressW=(3&t)>>10,e.maxAnisotropy=(15&t)>>12,e.cmpFunc=(7&t)>>16,e}}class Sr extends Vs{get info(){return this._info}get hash(){return this._hash}constructor(t,e){super(Xi.GLOBAL_BARRIER),this._info=new bs,this._hash=0,this._info.copy(t),this._hash=e}static computeHash(t){return ur(`${t.prevAccesses} ${t.nextAccesses}`,666)}}class Cr extends Vs{get info(){return this._info}get hash(){return this._hash}constructor(t,e){super(Xi.TEXTURE_BARRIER),this._info=new Ts,this._hash=0,this._info.copy(t),this._hash=e}static computeHash(t){let e=`${t.prevAccesses} ${t.nextAccesses}`;return e+=t.discardContents,e+=t.srcQueue?t.srcQueue.type:0,e+=t.dstQueue?t.dstQueue.type:0,ur(e,666)}}const Ar={GFXDevice:!0,GFXBuffer:!0,GFXTexture:!0,GFXSampler:!0,GFXShader:!0,GFXInputAssembler:!0,GFXRenderPass:!0,GFXFramebuffer:!0,GFXPipelineState:!0,GFXCommandBuffer:!0,GFXQueue:!0,GFXObjectType:!0,GFXObject:!1,GFXAttributeName:!0,GFXType:!0,GFXFormat:!0,GFXBufferUsageBit:!0,GFXMemoryUsageBit:!0,GFXBufferFlagBit:!0,GFXBufferAccessBit:"MemoryAccessBit",GFXPrimitiveMode:!0,GFXPolygonMode:!0,GFXShadeModel:!0,GFXCullMode:!0,GFXComparisonFunc:!0,GFXStencilOp:!0,GFXBlendOp:!0,GFXBlendFactor:!0,GFXColorMask:!0,GFXFilter:!0,GFXAddress:!0,GFXTextureType:!0,GFXTextureUsageBit:!0,GFXSampleCount:!0,GFXTextureFlagBit:!0,GFXShaderStageFlagBit:!0,GFXDescriptorType:!0,GFXCommandBufferType:!0,GFXLoadOp:!0,GFXStoreOp:!0,GFXPipelineBindPoint:!0,GFXDynamicStateFlagBit:!0,GFXStencilFace:!0,GFXQueueType:!0,GFXRect:!0,GFXViewport:!0,GFXColor:!0,GFXClearFlag:!0,GFXOffset:!0,GFXExtent:!0,GFXTextureSubres:"TextureSubresLayers",GFXTextureCopy:!0,GFXBufferTextureCopy:!0,GFXFormatType:!0,GFXFormatInfo:!0,GFXMemoryStatus:!0,GFXFormatInfos:!0,GFXFormatSize:!0,GFXFormatSurfaceSize:!0,GFXGetTypeSize:!0,getTypedArrayConstructor:!1};for(const t in Ar){let e=Ar[t];!0===e?e=t.slice(3):!1===e&&(e=t),V(l,"cc",[{name:t,newName:e,target:l.gfx,targetName:"cc.gfx"}])}G(l,"cc",[{name:"GFX_MAX_VERTEX_ATTRIBUTES"},{name:"GFX_MAX_TEXTURE_UNITS"},{name:"GFX_MAX_ATTACHMENTS"},{name:"GFX_MAX_BUFFER_BINDINGS"},{name:"GFXTextureLayout"}]);const br=Object.assign({},Js);br.Device=gfx.Device,br.Swapchain=gfx.Swapchain,br.Buffer=gfx.Buffer,br.Texture=gfx.Texture,br.Sampler=gfx.Sampler,br.Shader=gfx.Shader,br.InputAssembler=gfx.InputAssembler,br.RenderPass=gfx.RenderPass,br.Framebuffer=gfx.Framebuffer,br.DescriptorSet=gfx.DescriptorSet,br.DescriptorSetLayout=gfx.DescriptorSetLayout,br.PipelineLayout=gfx.PipelineLayout,br.PipelineState=gfx.PipelineState,br.CommandBuffer=gfx.CommandBuffer,br.Queue=gfx.Queue,l.gfx=br;const Tr=Qs,Er=tr,Pr=$s,wr=Zs,Ir=er,Rr=ir;br.BlendTarget=Qs,br.BlendState=tr,br.RasterizerState=$s,br.DepthStencilState=Zs,br.PipelineStateInfo=ir,t("gfx",Object.freeze({__proto__:null,DescriptorSet:sr,Buffer:rr,CommandBuffer:or,get ObjectType(){return Xi},get Status(){return Yi},get API(){return Ki},get SurfaceTransform(){return Ji},get Feature(){return $i},get Format(){return Zi},get FormatType(){return Qi},get Type(){return tn},get BufferUsageBit(){return en},get BufferFlagBit(){return nn},get MemoryAccessBit(){return sn},get MemoryUsageBit(){return rn},get TextureType(){return on},get TextureUsageBit(){return an},get TextureFlagBit(){return cn},get FormatFeatureBit(){return ln},get SampleCount(){return hn},get VsyncMode(){return _n},get Filter(){return un},get Address(){return dn},get ComparisonFunc(){return mn},get StencilOp(){return pn},get BlendFactor(){return fn},get BlendOp(){return gn},get ColorMask(){return vn},get ShaderStageFlagBit(){return yn},get LoadOp(){return xn},get StoreOp(){return Sn},get AccessFlagBit(){return Cn},get ResolveMode(){return An},get PipelineBindPoint(){return bn},get PrimitiveMode(){return Tn},get PolygonMode(){return En},get ShadeModel(){return Pn},get CullMode(){return wn},get DynamicStateFlagBit(){return In},get StencilFace(){return Rn},get DescriptorType(){return Dn},get QueueType(){return Mn},get QueryType(){return On},get CommandBufferType(){return Bn},get ClearFlagBit(){return Nn},Size:Fn,DeviceCaps:zn,Offset:Vn,Rect:Gn,Extent:Un,TextureSubresLayers:kn,TextureSubresRange:Hn,TextureCopy:jn,TextureBlit:Wn,BufferTextureCopy:qn,Viewport:Xn,Color:Yn,BindingMappingInfo:Kn,SwapchainInfo:Jn,DeviceInfo:$n,BufferInfo:Zn,BufferViewInfo:Qn,DrawInfo:ts,DispatchInfo:es,IndirectBuffer:is,TextureInfo:ss,TextureViewInfo:rs,SamplerInfo:os,Uniform:as,UniformBlock:cs,UniformSamplerTexture:ls,UniformSampler:hs,UniformTexture:_s,UniformStorageImage:us,UniformStorageBuffer:ds,UniformInputAttachment:ms,ShaderStage:ps,Attribute:fs,ShaderInfo:gs,InputAssemblerInfo:vs,ColorAttachment:ys,DepthStencilAttachment:xs,SubpassInfo:Ss,SubpassDependency:Cs,RenderPassInfo:As,GeneralBarrierInfo:bs,TextureBarrierInfo:Ts,FramebufferInfo:Es,DescriptorSetLayoutBinding:Ps,DescriptorSetLayoutInfo:ws,DescriptorSetInfo:Is,PipelineLayoutInfo:Rs,InputState:Ds,CommandBufferInfo:Ms,QueueInfo:Os,QueryPoolInfo:Bs,FormatInfo:Ns,MemoryStatus:Ls,DynamicStencilStates:Fs,DynamicStates:zs,GFXObject:Vs,get AttributeName(){return Ln},FormatInfos:Gs,DESCRIPTOR_BUFFER_TYPE:Us,DESCRIPTOR_SAMPLER_TYPE:ks,DESCRIPTOR_DYNAMIC_TYPE:Hs,DRAW_INFO_SIZE:28,IsPowerOf2:js,FormatSize:Ws,FormatSurfaceSize:qs,GetTypeSize:Ys,getTypedArrayConstructor:Ks,Device:ar,Swapchain:cr,Framebuffer:lr,InputAssembler:dr,DescriptorSetLayout:mr,PipelineLayout:pr,Queue:fr,RenderPass:gr,Shader:vr,Texture:yr,Sampler:xr,GeneralBarrier:Sr,TextureBarrier:Cr,BlendTarget:Tr,BlendState:Er,RasterizerState:Pr,DepthStencilState:wr,PipelineState:Ir,PipelineStateInfo:Rr}));const Dr=new mi,Mr=new mi,Or=new mi,Br=new mi,Nr=new mi,Lr=new mi,Fr=new Array(3),zr=new Array(3);function Vr(t,e){return mi.dot(e.n,t)-e.d}function Gr(t,e,i){return mi.copy(t,e),mi.subtract(Nr,i.center,i.halfExtents),mi.add(Lr,i.center,i.halfExtents),t.x=t.x<Nr.x?Nr.x:t.x,t.y=t.y<Nr.y?Nr.y:t.y,t.z=t.z<Nr.z?Nr.z:t.z,t.x=t.x>Lr.x?Lr.x:t.x,t.y=t.y>Lr.y?Lr.y:t.y,t.z=t.z>Lr.z?Lr.z:t.z,t}function Ur(t,e,i){mi.set(Dr,i.orientation.m00,i.orientation.m01,i.orientation.m02),mi.set(Mr,i.orientation.m03,i.orientation.m04,i.orientation.m05),mi.set(Or,i.orientation.m06,i.orientation.m07,i.orientation.m08),Fr[0]=Dr,Fr[1]=Mr,Fr[2]=Or,zr[0]=i.halfExtents.x,zr[1]=i.halfExtents.y,zr[2]=i.halfExtents.z,mi.subtract(Br,e,i.center),mi.set(t,i.center.x,i.center.y,i.center.z);for(let e=0;e<3;e++){let i=mi.dot(Br,Fr[e]);i>zr[e]&&(i=zr[e]),i<-zr[e]&&(i=-zr[e]),t.x+=i*Fr[e].x,t.y+=i*Fr[e].y,t.z+=i*Fr[e].z}return t}var kr=Object.freeze({__proto__:null,point_plane:Vr,pt_point_plane:function(t,e,i){const n=Vr(e,i);return mi.subtract(t,e,mi.multiplyScalar(t,i.n,n))},pt_point_aabb:Gr,pt_point_obb:Ur,pt_point_line:function(t,e,i,n){mi.subtract(Dr,i,n);const s=Dr,r=mi.lengthSqr(s);if(0==r)mi.copy(t,i);else{mi.subtract(Dr,e,i);const o=mi.dot(Dr,s)/r;o<0?mi.copy(t,i):o>1?mi.copy(t,n):mi.scaleAndAdd(t,i,s,o)}}}),Hr={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512};class jr{static create(t,e,i,n,s,r){return new jr(t,e,i,n,s,r)}static clone(t){return new jr(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)}static copy(t,e){return mi.copy(t.s,e.s),mi.copy(t.e,e.e),t}static fromPoints(t,e,i){return mi.copy(t.s,e),mi.copy(t.e,i),t}static set(t,e,i,n,s,r,o){return t.s.x=e,t.s.y=i,t.s.z=n,t.e.x=s,t.e.y=r,t.e.z=o,t}static len(t){return mi.distance(t.s,t.e)}get type(){return this._type}constructor(t=0,e=0,i=0,n=0,s=0,r=-1){this.s=void 0,this.e=void 0,this._type=void 0,this._type=Hr.SHAPE_LINE,this.s=new mi(t,e,i),this.e=new mi(n,s,r)}length(){return mi.distance(this.s,this.e)}}class Wr{static create(t=0,e=0,i=0,n=0,s=0,r=1){return new Wr(t,e,i,n,s,r)}static clone(t){return new Wr(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)}static copy(t,e){return mi.copy(t.o,e.o),mi.copy(t.d,e.d),t}static fromPoints(t,e,i){return mi.copy(t.o,e),mi.normalize(t.d,mi.subtract(t.d,i,e)),t}static set(t,e,i,n,s,r,o){return t.o.x=e,t.o.y=i,t.o.z=n,t.d.x=s,t.d.y=r,t.d.z=o,t}get type(){return this._type}constructor(t=0,e=0,i=0,n=0,s=0,r=-1){this.o=void 0,this.d=void 0,this._type=void 0,this._type=Hr.SHAPE_RAY,this.o=new mi(t,e,i),this.d=new mi(n,s,r)}computeHit(t,e){mi.normalize(t,this.d),mi.scaleAndAdd(t,this.o,t,e)}}const qr=new mi,Xr=new mi,Yr=new mi,Kr=new mi;function Jr(t){return Math.max(Math.max(t.x,t.y),t.z)}class $r{static create(t,e,i,n){return new $r(t,e,i,n)}static clone(t){return new $r(t.center.x,t.center.y,t.center.z,t.radius)}static copy(t,e){return mi.copy(t.center,e.center),t.radius=e.radius,t}static fromPoints(t,e,i){return mi.multiplyScalar(t.center,mi.add(qr,e,i),.5),t.radius=.5*mi.subtract(qr,i,e).length(),t}static set(t,e,i,n,s){return t.center.x=e,t.center.y=i,t.center.z=n,t.radius=s,t}get center(){return this._center}set center(t){this._center=t}get radius(){return this._radius}set radius(t){this._radius=t}get type(){return this._type}constructor(t=0,e=0,i=0,n=1){this._center=new mi(0,0,0),this._radius=0,this._type=void 0,this._type=Hr.SHAPE_SPHERE,this._center=new mi(t,e,i),this._radius=n}destroy(){}clone(){return $r.clone(this)}copy(t){return $r.copy(this,t)}getBoundary(t,e){mi.set(t,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),mi.set(e,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}transform(t,e,i,n,s){mi.transformMat4(s.center,this.center,t),s.radius=this.radius*Jr(n)}translateAndRotate(t,e,i){mi.transformMat4(i.center,this.center,t)}setScale(t,e){e.radius=this.radius*Jr(t)}mergePoint(t){this.radius<0&&(this.center.set(t),this.radius=0),mi.subtract(Xr,t,this.center);const e=Xr.length();if(e>this.radius){const t=.5*(e-this.radius);this.radius+=t,mi.multiplyScalar(Xr,Xr,t/e),mi.add(this.center,this.center,Xr)}}mergePoints(t){const e=t.length;if(!(e<1)){this.radius=-1;for(let i=0;i<e;i++)this.mergePoint(t[i])}}mergeAABB(t){t.getBoundary(Yr,Kr),this.mergePoint(Yr),this.mergePoint(Kr)}}class Zr{static create(t=1,e=0,i=0,n=0,s=0,r=0,o=0,a=0,c=1){return new Zr(t,e,i,n,s,r,o,a,c)}static clone(t){return new Zr(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)}static copy(t,e){return mi.copy(t.a,e.a),mi.copy(t.b,e.b),mi.copy(t.c,e.c),t}static fromPoints(t,e,i,n){return mi.copy(t.a,e),mi.copy(t.b,i),mi.copy(t.c,n),t}static set(t,e,i,n,s,r,o,a,c,l){return t.a.x=e,t.a.y=i,t.a.z=n,t.b.x=s,t.b.y=r,t.b.z=o,t.c.x=a,t.c.y=c,t.c.z=l,t}get type(){return this._type}constructor(t=0,e=0,i=0,n=1,s=0,r=0,o=0,a=1,c=0){this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Hr.SHAPE_TRIANGLE,this.a=new mi(t,e,i),this.b=new mi(n,s,r),this.c=new mi(o,a,c)}}let Qr;!function(t){t[t.ALL=0]="ALL",t[t.CLOSEST=1]="CLOSEST",t[t.ANY=2]="ANY"}(Qr||(Qr={}));const to=function(){const t=new mi(0,0,0);return function(e,i){const n=mi.dot(e.d,i.n);if(Math.abs(n)<Number.EPSILON)return 0;mi.multiplyScalar(t,i.n,i.d);const s=mi.dot(mi.subtract(t,t,e.o),i.n)/n;return s<0?0:s}}(),eo=function(){const t=new mi(0,0,0),e=new mi(0,0,0),i=new mi(0,0,0),n=new mi(0,0,0),s=new mi(0,0,0);return function(r,o,a){mi.subtract(t,o.b,o.a),mi.subtract(e,o.c,o.a),mi.cross(i,r.d,e);const c=mi.dot(t,i);if(c<Number.EPSILON&&(!a||c>-Number.EPSILON))return 0;const l=1/c;mi.subtract(n,r.o,o.a);const h=mi.dot(n,i)*l;if(h<0||h>1)return 0;mi.cross(s,n,t);const _=mi.dot(r.d,s)*l;if(_<0||h+_>1)return 0;const u=mi.dot(e,s)*l;return u<0?0:u}}(),io=function(){const t=new mi(0,0,0);return function(e,i){const n=i.radius,s=i.center,r=e.o,o=e.d,a=n*n;mi.subtract(t,s,r);const c=t.lengthSqr(),l=mi.dot(t,o),h=a-(c-l*l);if(h<0)return 0;const _=Math.sqrt(h),u=c<a?l+_:l-_;return u<0?0:u}}(),no=function(){const t=new mi,e=new mi;return function(i,n){return mi.subtract(t,n.center,n.halfExtents),mi.add(e,n.center,n.halfExtents),so(i,t,e)}}();function so(t,e,i){const n=t.o,s=t.d,r=1/s.x,o=1/s.y,a=1/s.z,c=(e.x-n.x)*r,l=(i.x-n.x)*r,h=(e.y-n.y)*o,_=(i.y-n.y)*o,u=(e.z-n.z)*a,d=(i.z-n.z)*a,m=Math.max(Math.max(Math.min(c,l),Math.min(h,_)),Math.min(u,d)),p=Math.min(Math.min(Math.max(c,l),Math.max(h,_)),Math.max(u,d));return p<0||m>p?0:m>0?m:p}const ro=function(){let t=new mi,e=new mi,i=new mi;const n=new mi,s=new mi,r=new mi,o=new mi,a=new Array(3),c=new Array(3),l=new Array(3),h=new Array(6);return function(_,u){a[0]=u.halfExtents.x,a[1]=u.halfExtents.y,a[2]=u.halfExtents.z,t=u.center,e=_.o,i=_.d,mi.set(n,u.orientation.m00,u.orientation.m01,u.orientation.m02),mi.set(s,u.orientation.m03,u.orientation.m04,u.orientation.m05),mi.set(r,u.orientation.m06,u.orientation.m07,u.orientation.m08),mi.subtract(o,t,e),c[0]=mi.dot(n,i),c[1]=mi.dot(s,i),c[2]=mi.dot(r,i),l[0]=mi.dot(n,o),l[1]=mi.dot(s,o),l[2]=mi.dot(r,o);for(let t=0;t<3;++t){if(0===c[t]){if(-l[t]-a[t]>0||-l[t]+a[t]<0)return 0;c[t]=1e-7}h[2*t+0]=(l[t]+a[t])/c[t],h[2*t+1]=(l[t]-a[t])/c[t]}const d=Math.max(Math.max(Math.min(h[0],h[1]),Math.min(h[2],h[3])),Math.min(h[4],h[5])),m=Math.min(Math.min(Math.max(h[0],h[1]),Math.max(h[2],h[3])),Math.max(h[4],h[5]));return m<0||d>m?0:d>0?d:m}}(),oo=function(){const t=new mi,e=new mi,i=new mi,n=new mi,s=new mi,r=new mi,o=new mi,a=new $r;return function(c,l){const h=l.radius*l.radius,_=mi.normalize(t,c.d),u=l.ellipseCenter0,d=l.ellipseCenter1,m=mi.subtract(e,d,u);if(m.equals(mi.ZERO))return a.radius=l.radius,a.center.set(l.ellipseCenter0),zo.raySphere(c,a);const p=c.o,f=mi.subtract(i,p,u),g=mi.cross(n,_,m),v=g.lengthSqr();if(0===v){a.radius=l.radius;const t=mi.subtract(s,d,p);return f.lengthSqr()<t.lengthSqr()?a.center.set(l.ellipseCenter0):a.center.set(l.ellipseCenter1),zo.raySphere(c,a)}const y=mi.cross(s,f,m),x=m.lengthSqr(),S=2*mi.dot(g,y),C=S*S-4*v*(y.lengthSqr()-h*x);if(C<0)return 0;const A=(-S-Math.sqrt(C))/(2*v);if(A<0){a.radius=l.radius;const t=mi.subtract(r,d,p);return f.lengthSqr()<t.lengthSqr()?a.center.set(l.ellipseCenter0):a.center.set(l.ellipseCenter1),zo.raySphere(c,a)}{const t=mi.scaleAndAdd(r,c.o,_,A),e=mi.subtract(o,t,u),i=mi.dot(e,m)/x;return i>=0&&i<=1?A:i<0?(a.radius=l.radius,a.center.set(l.ellipseCenter0),zo.raySphere(c,a)):i>1?(a.radius=l.radius,a.center.set(l.ellipseCenter1),zo.raySphere(c,a)):0}}}(),ao=function(){const t=Zr.create(),e={distance:1/0,doubleSided:!1,mode:Qr.ANY};let i=0;const n=(t,e,n,s,r,o)=>{t===Qr.CLOSEST?(i>e||0===i)&&(i=e,o&&(0===o.length?o.push({distance:e,vertexIndex0:n/3,vertexIndex1:s/3,vertexIndex2:r/3}):(o[0].distance=e,o[0].vertexIndex0=n/3,o[0].vertexIndex1=s/3,o[0].vertexIndex2=r/3))):(i=e,o&&o.push({distance:e,vertexIndex0:n/3,vertexIndex1:s/3,vertexIndex2:r/3}))};return function(s,r,o){if(i=0,0===r.geometricInfo.positions.length)return i;const a=void 0===o?e:o;if(so(s,r.geometricInfo.boundingBox.min,r.geometricInfo.boundingBox.max)){const e=r.primitiveMode,{positions:i,indices:o}=r.geometricInfo;((e,i,s,r,o)=>{if(s===Tn.TRIANGLE_LIST){const s=i.length;for(let a=0;a<s;a+=3){const s=3*i[a],c=3*i[a+1],l=3*i[a+2];mi.set(t.a,e[s],e[s+1],e[s+2]),mi.set(t.b,e[c],e[c+1],e[c+2]),mi.set(t.c,e[l],e[l+1],e[l+2]);const h=zo.rayTriangle(r,t,o.doubleSided);if(!(0===h||h>o.distance)&&(n(o.mode,h,s,c,l,o.result),o.mode===Qr.ANY))return h}}else if(s===Tn.TRIANGLE_STRIP){const s=i.length-2;let a=0;for(let c=0;c<s;c+=1){const s=3*i[c-a],l=3*i[c+a+1],h=3*i[c+2];mi.set(t.a,e[s],e[s+1],e[s+2]),mi.set(t.b,e[l],e[l+1],e[l+2]),mi.set(t.c,e[h],e[h+1],e[h+2]),a=~a;const _=zo.rayTriangle(r,t,o.doubleSided);if(!(0===_||_>o.distance)&&(n(o.mode,_,s,l,h,o.result),o.mode===Qr.ANY))return _}}else if(s===Tn.TRIANGLE_FAN){const s=i.length-1,a=3*i[0];mi.set(t.a,e[a],e[a+1],e[a+2]);for(let c=1;c<s;c+=1){const s=3*i[c],l=3*i[c+1];mi.set(t.b,e[s],e[s+1],e[s+2]),mi.set(t.c,e[l],e[l+1],e[l+2]);const h=zo.rayTriangle(r,t,o.doubleSided);if(!(0===h||h>o.distance)&&(n(o.mode,h,a,s,l,o.result),o.mode===Qr.ANY))return h}}})(i,o,e,s,a)}return i}}(),co=function(){let t=0;const e={distance:1/0,doubleSided:!1,mode:Qr.ANY};return function(i,n,s){t=0;const r=void 0===s?e:s,o=n.renderingSubMeshes.length,a=n.struct.minPosition,c=n.struct.maxPosition;if(a&&c&&!so(i,a,c))return t;for(let e=0;e<o;e++){const s=n.renderingSubMeshes[e],o=ao(i,s,r);if(o)if(r.mode===Qr.CLOSEST)(0===t||t>o)&&(t=o,r.subIndices&&(r.subIndices[0]=e));else if(t=o,r.subIndices&&r.subIndices.push(e),r.mode===Qr.ANY)return o}return t&&r.mode===Qr.CLOSEST&&(r.result&&(r.result[0].distance=t,r.result.length=1),r.subIndices&&(r.subIndices.length=1)),t}}(),lo=function(){let t=0;const e={distance:1/0,doubleSided:!1,mode:Qr.ANY},i=new Wr,n=new Ii;return function(s,r,o){t=0;const a=void 0===o?e:o,c=r.worldBounds;if(c&&!no(s,c))return t;Wr.copy(i,s),r.node&&(Ii.invert(n,r.node.getWorldMatrix(n)),mi.transformMat4(i.o,s.o,n),mi.transformMat4Normal(i.d,s.d,n));const l=r.subModels;for(let e=0;e<l.length;e++){const n=l[e].subMesh,s=ao(i,n,a);if(s)if(a.mode===Qr.CLOSEST)(0===t||t>s)&&(t=s,a.subIndices&&(a.subIndices[0]=e));else if(t=s,a.subIndices&&a.subIndices.push(e),a.mode===Qr.ANY)return s}return t&&a.mode===Qr.CLOSEST&&(a.result&&(a.result[0].distance=t,a.result.length=1),a.subIndices&&(a.subIndices.length=1)),t}}(),ho=function(){const t=new mi(0,0,0);return function(e,i){mi.subtract(t,e.e,e.s);const n=(i.d-mi.dot(e.s,i.n))/mi.dot(t,i.n);return n<0||n>1?0:n}}(),_o=function(){const t=new mi(0,0,0),e=new mi(0,0,0),i=new mi(0,0,0),n=new mi(0,0,0),s=new mi(0,0,0),r=new mi(0,0,0);return function(o,a,c){mi.subtract(t,a.b,a.a),mi.subtract(e,a.c,a.a),mi.subtract(i,o.s,o.e),mi.cross(s,t,e);const l=mi.dot(i,s);if(l<=0)return 0;mi.subtract(n,o.s,a.a);const h=mi.dot(n,s);if(h<0||h>l)return 0;mi.cross(r,i,n);let _=mi.dot(e,r);if(_<0||_>l)return 0;let u=-mi.dot(t,r);if(u<0||_+u>l)return 0;if(c){const t=1/l;_*=t,u*=t;const e=1-_-u;mi.set(c,a.a.x*e+a.b.x*_+a.c.x*u,a.a.y*e+a.b.y*_+a.c.y*u,a.a.z*e+a.b.z*_+a.c.z*u)}return 1}}(),uo=new Wr;function mo(t,e){uo.o.set(t.s),mi.subtract(uo.d,t.e,t.s),uo.d.normalize();const i=no(uo,e);return i<=t.length()?i:0}function po(t,e){uo.o.set(t.s),mi.subtract(uo.d,t.e,t.s),uo.d.normalize();const i=ro(uo,e);return i<=t.length()?i:0}function fo(t,e){uo.o.set(t.s),mi.subtract(uo.d,t.e,t.s),uo.d.normalize();const i=io(uo,e);return i<=t.length()?i:0}const go=function(){const t=new mi,e=new mi,i=new mi,n=new mi;return function(s,r){return mi.subtract(t,s.center,s.halfExtents),mi.add(e,s.center,s.halfExtents),mi.subtract(i,r.center,r.halfExtents),mi.add(n,r.center,r.halfExtents),t.x<=n.x&&e.x>=i.x&&t.y<=n.y&&e.y>=i.y&&t.z<=n.z&&e.z>=i.z}}();function vo(t,e,i,n,s,r){mi.set(r[0],t.x+i.x*e.x+n.x*e.y+s.x*e.z,t.y+i.y*e.x+n.y*e.y+s.y*e.z,t.z+i.z*e.x+n.z*e.y+s.z*e.z),mi.set(r[1],t.x-i.x*e.x+n.x*e.y+s.x*e.z,t.y-i.y*e.x+n.y*e.y+s.y*e.z,t.z-i.z*e.x+n.z*e.y+s.z*e.z),mi.set(r[2],t.x+i.x*e.x-n.x*e.y+s.x*e.z,t.y+i.y*e.x-n.y*e.y+s.y*e.z,t.z+i.z*e.x-n.z*e.y+s.z*e.z),mi.set(r[3],t.x+i.x*e.x+n.x*e.y-s.x*e.z,t.y+i.y*e.x+n.y*e.y-s.y*e.z,t.z+i.z*e.x+n.z*e.y-s.z*e.z),mi.set(r[4],t.x-i.x*e.x-n.x*e.y-s.x*e.z,t.y-i.y*e.x-n.y*e.y-s.y*e.z,t.z-i.z*e.x-n.z*e.y-s.z*e.z),mi.set(r[5],t.x+i.x*e.x-n.x*e.y-s.x*e.z,t.y+i.y*e.x-n.y*e.y-s.y*e.z,t.z+i.z*e.x-n.z*e.y-s.z*e.z),mi.set(r[6],t.x-i.x*e.x+n.x*e.y-s.x*e.z,t.y-i.y*e.x+n.y*e.y-s.y*e.z,t.z-i.z*e.x+n.z*e.y-s.z*e.z),mi.set(r[7],t.x-i.x*e.x-n.x*e.y+s.x*e.z,t.y-i.y*e.x-n.y*e.y+s.y*e.z,t.z-i.z*e.x-n.z*e.y+s.z*e.z)}function yo(t,e){let i=mi.dot(e,t[0]),n=i;for(let s=1;s<8;++s){const r=mi.dot(e,t[s]);i=r<i?r:i,n=r>n?r:n}return[i,n]}const xo=function(){const t=new Array(15);for(let e=0;e<15;e++)t[e]=new mi(0,0,0);const e=new Array(8),i=new Array(8);for(let t=0;t<8;t++)e[t]=new mi(0,0,0),i[t]=new mi(0,0,0);const n=new mi,s=new mi;return function(r,o){mi.set(t[0],1,0,0),mi.set(t[1],0,1,0),mi.set(t[2],0,0,1),mi.set(t[3],o.orientation.m00,o.orientation.m01,o.orientation.m02),mi.set(t[4],o.orientation.m03,o.orientation.m04,o.orientation.m05),mi.set(t[5],o.orientation.m06,o.orientation.m07,o.orientation.m08);for(let e=0;e<3;++e)mi.cross(t[6+3*e],t[e],t[3]),mi.cross(t[7+3*e],t[e],t[4]),mi.cross(t[7+3*e],t[e],t[5]);mi.subtract(n,r.center,r.halfExtents),mi.add(s,r.center,r.halfExtents),function(t,e,i){mi.set(i[0],t.x,e.y,e.z),mi.set(i[1],t.x,e.y,t.z),mi.set(i[2],t.x,t.y,e.z),mi.set(i[3],t.x,t.y,t.z),mi.set(i[4],e.x,e.y,e.z),mi.set(i[5],e.x,e.y,t.z),mi.set(i[6],e.x,t.y,e.z),mi.set(i[7],e.x,t.y,t.z)}(n,s,e),vo(o.center,o.halfExtents,t[3],t[4],t[5],i);for(let n=0;n<15;++n){const s=yo(e,t[n]),r=yo(i,t[n]);if(r[0]>s[1]||s[0]>r[1])return 0}return 1}}(),So=function(t,e){const i=t.halfExtents.x*Math.abs(e.n.x)+t.halfExtents.y*Math.abs(e.n.y)+t.halfExtents.z*Math.abs(e.n.z),n=mi.dot(e.n,t.center);return n+i<e.d?-1:n-i>e.d?0:1},Co=function(t,e){for(let i=0;i<e.planes.length;i++)if(-1===So(t,e.planes[i]))return 0;return 1},Ao=function(){const t=new Array(8);let e=0,i=0;for(let e=0;e<t.length;e++)t[e]=new mi(0,0,0);return function(n,s){let r=0,o=!1;for(let t=0;t<s.planes.length;t++){if(r=So(n,s.planes[t]),-1===r)return 0;1===r&&(o=!0)}if(!o)return 1;for(let e=0;e<s.vertices.length;e++)mi.subtract(t[e],s.vertices[e],n.center);e=0,i=0;for(let r=0;r<s.vertices.length;r++)t[r].x>n.halfExtents.x?e++:t[r].x<-n.halfExtents.x&&i++;if(e===s.vertices.length||i===s.vertices.length)return 0;e=0,i=0;for(let r=0;r<s.vertices.length;r++)t[r].y>n.halfExtents.y?e++:t[r].y<-n.halfExtents.y&&i++;if(e===s.vertices.length||i===s.vertices.length)return 0;e=0,i=0;for(let r=0;r<s.vertices.length;r++)t[r].z>n.halfExtents.z?e++:t[r].z<-n.halfExtents.z&&i++;return e===s.vertices.length||i===s.vertices.length?0:1}}(),bo=function(){const t=new mi(0,0,0),e=new vi;return function(i,n){return mi.subtract(t,n,i.center),mi.transformMat3(t,t,vi.transpose(e,i.orientation)),s=t,r=i.halfExtents,Math.abs(s.x)<r.x&&Math.abs(s.y)<r.y&&Math.abs(s.z)<r.z;var s,r}}(),To=function(){const t=function(t,e,i,n){return Math.abs(t.x*e+t.y*i+t.z*n)};return function(e,i){const n=e.halfExtents.x*t(i.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*t(i.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*t(i.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),s=mi.dot(i.n,e.center);return s+n<i.d?-1:s-n>i.d?0:1}}(),Eo=function(t,e){for(let i=0;i<e.planes.length;i++)if(-1===To(t,e.planes[i]))return 0;return 1},Po=function(){const t=new Array(8);let e=0,i=0,n=0;for(let e=0;e<t.length;e++)t[e]=new mi(0,0,0);const s=function(t,e,i,n){return t.x*e+t.y*i+t.z*n};return function(r,o){let a=0,c=!1;for(let t=0;t<o.planes.length;t++){if(a=To(r,o.planes[t]),-1===a)return 0;1===a&&(c=!0)}if(!c)return 1;for(let e=0;e<o.vertices.length;e++)mi.subtract(t[e],o.vertices[e],r.center);i=0,n=0;for(let a=0;a<o.vertices.length;a++)e=s(t[a],r.orientation.m00,r.orientation.m01,r.orientation.m02),e>r.halfExtents.x?i++:e<-r.halfExtents.x&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(let a=0;a<o.vertices.length;a++)e=s(t[a],r.orientation.m03,r.orientation.m04,r.orientation.m05),e>r.halfExtents.y?i++:e<-r.halfExtents.y&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(let a=0;a<o.vertices.length;a++)e=s(t[a],r.orientation.m06,r.orientation.m07,r.orientation.m08),e>r.halfExtents.z?i++:e<-r.halfExtents.z&&n++;return i===o.vertices.length||n===o.vertices.length?0:1}}(),wo=function(){const t=new Array(15);for(let e=0;e<15;e++)t[e]=new mi(0,0,0);const e=new Array(8),i=new Array(8);for(let t=0;t<8;t++)e[t]=new mi(0,0,0),i[t]=new mi(0,0,0);return function(n,s){mi.set(t[0],n.orientation.m00,n.orientation.m01,n.orientation.m02),mi.set(t[1],n.orientation.m03,n.orientation.m04,n.orientation.m05),mi.set(t[2],n.orientation.m06,n.orientation.m07,n.orientation.m08),mi.set(t[3],s.orientation.m00,s.orientation.m01,s.orientation.m02),mi.set(t[4],s.orientation.m03,s.orientation.m04,s.orientation.m05),mi.set(t[5],s.orientation.m06,s.orientation.m07,s.orientation.m08);for(let e=0;e<3;++e)mi.cross(t[6+3*e],t[e],t[3]),mi.cross(t[7+3*e],t[e],t[4]),mi.cross(t[8+3*e],t[e],t[5]);vo(n.center,n.halfExtents,t[0],t[1],t[2],e),vo(s.center,s.halfExtents,t[3],t[4],t[5],i);for(let n=0;n<15;++n){const s=yo(e,t[n]),r=yo(i,t[n]);if(r[0]>s[1]||s[0]>r[1])return 0}return 1}}(),Io=function(){const t=new $r,e=new mi,i=new mi,n=new mi,s=new Array(8);for(let t=0;t<8;t++)s[t]=new mi;const r=new Array(8);for(let t=0;t<8;t++)r[t]=new mi;return function(o,a){if(0===mi.squaredDistance(a.ellipseCenter0,a.ellipseCenter1))return t.radius=a.radius,t.center.set(a.ellipseCenter0),zo.sphereOBB(t,o);{e.x=o.orientation.m00,e.y=o.orientation.m01,e.z=o.orientation.m02,i.x=o.orientation.m03,i.y=o.orientation.m04,i.z=o.orientation.m05,n.x=o.orientation.m06,n.y=o.orientation.m07,n.z=o.orientation.m08,vo(o.center,o.halfExtents,e,i,n,s);const t=r,c=mi.copy(t[0],e),l=mi.copy(t[1],i),h=mi.copy(t[2],n);mi.subtract(t[3],a.center,o.center).normalize();const _=mi.subtract(t[4],a.ellipseCenter0,a.ellipseCenter1);_.normalize(),mi.cross(t[5],c,_),mi.cross(t[6],l,_),mi.cross(t[7],h,_);for(let e=0;e<8;++e){const i=yo(s,t[e]),n=mi.dot(t[e],a.ellipseCenter0),r=mi.dot(t[e],a.ellipseCenter1),o=Math.max(n,r),c=Math.min(n,r)-a.radius,l=o+a.radius;if(c>i[1]||i[0]>l)return 0}return 1}}}(),Ro=function(t,e){const i=mi.dot(e.n,t.center),n=t.radius*e.n.length();return i+n<e.d?-1:i-n>e.d?0:1},Do=function(t,e){for(let i=0;i<e.planes.length;i++)if(-1===Ro(t,e.planes[i]))return 0;return 1},Mo=function(){const t=new mi(0,0,0),e=[1,-1,1,-1,1,-1];return function(i,n){for(let s=0;s<6;s++){const r=n.planes[s],o=i.radius,a=i.center,c=r.n,l=r.d,h=mi.dot(c,a);if(h+o<l)return 0;if(!(h-o>l)){mi.add(t,a,mi.multiplyScalar(t,c,o));for(let i=0;i<6;i++){if(i===s||i===s+e[s])continue;const r=n.planes[i];if(mi.dot(r.n,t)<r.d)return 0}}}return 1}}(),Oo=function(t,e){const i=t.radius+e.radius;return mi.squaredDistance(t.center,e.center)<i*i},Bo=function(){const t=new mi;return function(e,i){return Gr(t,e.center,i),mi.squaredDistance(e.center,t)<e.radius*e.radius}}(),No=function(){const t=new mi;return function(e,i){return Ur(t,e.center,i),mi.squaredDistance(e.center,t)<e.radius*e.radius}}(),Lo=function(){const t=new mi,e=new mi;return function(i,n){const s=i.radius+n.radius,r=s*s,o=mi.squaredDistance(n.ellipseCenter0,n.ellipseCenter1);if(0===o)return mi.squaredDistance(i.center,n.center)<r;{mi.subtract(t,i.center,n.ellipseCenter0),mi.subtract(e,n.ellipseCenter1,n.ellipseCenter0);const s=mi.dot(t,e)/o;return s<0?mi.squaredDistance(i.center,n.ellipseCenter0)<r:s>1?mi.squaredDistance(i.center,n.ellipseCenter1)<r:(mi.scaleAndAdd(t,n.ellipseCenter0,e,s),mi.squaredDistance(i.center,t)<r)}}}(),Fo=function(){const t=new mi,e=new mi,i=new mi,n=new mi,s=new mi,r=new mi;return function(o,a){const c=mi.subtract(t,o.ellipseCenter1,o.ellipseCenter0),l=mi.subtract(e,a.ellipseCenter1,a.ellipseCenter0),h=mi.subtract(i,o.ellipseCenter0,a.ellipseCenter0),_=mi.dot(c,c),u=mi.dot(c,l),d=mi.dot(l,l),m=mi.dot(c,h),p=mi.dot(l,h),f=_*d-u*u;let g,v,y=f,x=f;f<ke?(g=0,y=1,v=p,x=d):(g=u*p-d*m,v=_*p-u*m,g<0?(g=0,v=p,x=d):g>y&&(g=y,v=p+u,x=d)),v<0?(v=0,-m<0?g=0:-m>_?g=y:(g=-m,y=_)):v>x&&(v=x,-m+u<0?g=0:-m+u>_?g=y:(g=-m+u,y=_));const S=Math.abs(g)<ke?0:g/y,C=Math.abs(v)<ke?0:v/x,A=n;A.set(h),A.add(mi.multiplyScalar(s,c,S)),A.subtract(mi.multiplyScalar(r,l,C));const b=o.radius+a.radius;return A.lengthSqr()<b*b}}(),zo={raySphere:io,rayAABB:no,rayOBB:ro,rayPlane:to,rayTriangle:eo,rayCapsule:oo,raySubMesh:ao,rayMesh:co,rayModel:lo,lineSphere:fo,lineAABB:mo,lineOBB:po,linePlane:ho,lineTriangle:_o,sphereWithSphere:Oo,sphereAABB:Bo,sphereOBB:No,spherePlane:Ro,sphereFrustum:Do,sphereFrustumAccurate:Mo,sphereCapsule:Lo,aabbWithAABB:go,aabbWithOBB:xo,aabbPlane:So,aabbFrustum:Co,aabbFrustumAccurate:Ao,obbWithOBB:wo,obbPlane:To,obbFrustum:Eo,obbFrustumAccurate:Po,obbPoint:bo,obbCapsule:Io,capsuleWithCapsule:Fo,resolve(t,e,i=null){const n=t._type,s=e._type,r=this[n|s];return n<s?r(t,e,i):r(e,t,i)}};zo[Hr.SHAPE_RAY|Hr.SHAPE_SPHERE]=io,zo[Hr.SHAPE_RAY|Hr.SHAPE_AABB]=no,zo[Hr.SHAPE_RAY|Hr.SHAPE_OBB]=ro,zo[Hr.SHAPE_RAY|Hr.SHAPE_PLANE]=to,zo[Hr.SHAPE_RAY|Hr.SHAPE_TRIANGLE]=eo,zo[Hr.SHAPE_RAY|Hr.SHAPE_CAPSULE]=oo,zo[Hr.SHAPE_LINE|Hr.SHAPE_SPHERE]=fo,zo[Hr.SHAPE_LINE|Hr.SHAPE_AABB]=mo,zo[Hr.SHAPE_LINE|Hr.SHAPE_OBB]=po,zo[Hr.SHAPE_LINE|Hr.SHAPE_PLANE]=ho,zo[Hr.SHAPE_LINE|Hr.SHAPE_TRIANGLE]=_o,zo[Hr.SHAPE_SPHERE]=Oo,zo[Hr.SHAPE_SPHERE|Hr.SHAPE_AABB]=Bo,zo[Hr.SHAPE_SPHERE|Hr.SHAPE_OBB]=No,zo[Hr.SHAPE_SPHERE|Hr.SHAPE_PLANE]=Ro,zo[Hr.SHAPE_SPHERE|Hr.SHAPE_FRUSTUM]=Do,zo[Hr.SHAPE_SPHERE|Hr.SHAPE_FRUSTUM_ACCURATE]=Mo,zo[Hr.SHAPE_SPHERE|Hr.SHAPE_CAPSULE]=Lo,zo[Hr.SHAPE_AABB]=go,zo[Hr.SHAPE_AABB|Hr.SHAPE_OBB]=xo,zo[Hr.SHAPE_AABB|Hr.SHAPE_PLANE]=So,zo[Hr.SHAPE_AABB|Hr.SHAPE_FRUSTUM]=Co,zo[Hr.SHAPE_AABB|Hr.SHAPE_FRUSTUM_ACCURATE]=Ao,zo[Hr.SHAPE_OBB]=wo,zo[Hr.SHAPE_OBB|Hr.SHAPE_PLANE]=To,zo[Hr.SHAPE_OBB|Hr.SHAPE_FRUSTUM]=Eo,zo[Hr.SHAPE_OBB|Hr.SHAPE_FRUSTUM_ACCURATE]=Po,zo[Hr.SHAPE_OBB|Hr.SHAPE_CAPSULE]=Io,zo[Hr.SHAPE_CAPSULE]=Fo,V(jr.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),G(zo,"intersect",[{name:"line_quad"}]);const Vo=new mi(0,0,0),Go=new mi(0,0,0),Uo=l.mat4(),ko=l.v4();class Ho{static create(t,e,i,n){return new Ho(t,e,i,n)}static clone(t){return new Ho(t.n.x,t.n.y,t.n.z,t.d)}static copy(t,e){return mi.copy(t.n,e.n),t.d=e.d,t}static fromPoints(t,e,i,n){return mi.subtract(Vo,i,e),mi.subtract(Go,n,e),mi.normalize(t.n,mi.cross(t.n,Vo,Go)),t.d=mi.dot(t.n,e),t}static set(t,e,i,n,s){return t.n.x=e,t.n.y=i,t.n.z=n,t.d=s,t}static fromNormalAndPoint(t,e,i){return mi.copy(t.n,e),t.d=mi.dot(e,i),t}static normalize(t,e){const i=e.n.length();return mi.normalize(t.n,e.n),i>0&&(t.d=e.d/i),t}get type(){return this._type}set x(t){this.n.x=t}get x(){return this.n.x}set y(t){this.n.y=t}get y(){return this.n.y}set z(t){this.n.z=t}get z(){return this.n.z}set w(t){this.d=t}get w(){return this.d}constructor(t=0,e=1,i=0,n=0){this.n=void 0,this.d=void 0,this._type=void 0,this._type=Hr.SHAPE_PLANE,this.n=new mi(t,e,i),this.d=n}transform(t){Ii.invert(Uo,t),Ii.transpose(Uo,Uo),Fi.set(ko,this.n.x,this.n.y,this.n.z,this.d),Fi.transformMat4(ko,ko,Uo),mi.set(this.n,ko.x,ko.y,ko.z),this.d=ko.w}}const jo=jsb.NativeBufferPool;var Wo;jsb.NativeObjectPool,jsb.NativeBufferAllocator,function(t){t[t.UINT32=0]="UINT32",t[t.FLOAT32=1]="FLOAT32",t[t.NEVER=2]="NEVER"}(Wo||(Wo={}));class qo{constructor(t,e,i,n,s=8){this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=n.COUNT,this._entryBits=s,this._dataType=e,this._dataMembers=i,this._stride=4*this._elementCount,this._entriesPerChunk=1<<s,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new jo(t,s,this._stride);let r=Wo.NEVER,o=!1,a=!1;for(const t in e){if(o=this._hasFloat32,a=this._hasUint32,a&&o)break;r=e[t],o||r!==Wo.FLOAT32?a||r!==Wo.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}alloc(){let t=0;for(;t<this._freeLists.length;t++){const e=this._freeLists[t];if(e.length){const i=e[e.length-1];return e.length--,(t<<this._entryBits)+i+this._poolFlag}}const e=this._nativePool.allocateNewChunk(),i=[],n=[],s=[],r=this._hasFloat32,o=this._hasUint32;for(let t=0;t<this._entriesPerChunk;t++)r&&i.push(new Float32Array(e,this._stride*t,this._elementCount)),o&&n.push(new Uint32Array(e,this._stride*t,this._elementCount)),t&&s.push(t);return o&&this._uint32BufferViews.push(n),r&&this._float32BufferViews.push(i),this._freeLists.push(s),this._arrayBuffers.push(e),(t<<this._entryBits)+this._poolFlag}getBuffer(t){const e=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[e][i]}getTypedArray(t,e){const i=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t,s=e,r=(this._dataType[e]===Wo.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][n],o=this._dataMembers[e];return r.subarray(s,s+o)}free(t){const e=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[e][i].fill(0),this._freeLists[e].push(i)}}let Xo,Yo;!function(t){t[t.NODE=0]="NODE",t[t.PASS=1]="PASS",t[t.AABB=2]="AABB"}(Xo||(Xo={})),function(t){t[t.DIRTY_FLAG=0]="DIRTY_FLAG",t[t.LAYER=1]="LAYER",t[t.WORLD_SCALE=2]="WORLD_SCALE",t[t.WORLD_POSITION=5]="WORLD_POSITION",t[t.WORLD_ROTATION=8]="WORLD_ROTATION",t[t.WORLD_MATRIX=12]="WORLD_MATRIX",t[t.LOCAL_SCALE=28]="LOCAL_SCALE",t[t.LOCAL_POSITION=31]="LOCAL_POSITION",t[t.LOCAL_ROTATION=34]="LOCAL_ROTATION",t[t.COUNT=38]="COUNT"}(Yo||(Yo={}));const Ko={[Yo.DIRTY_FLAG]:Wo.UINT32,[Yo.LAYER]:Wo.UINT32,[Yo.WORLD_SCALE]:Wo.FLOAT32,[Yo.WORLD_POSITION]:Wo.FLOAT32,[Yo.WORLD_ROTATION]:Wo.FLOAT32,[Yo.WORLD_MATRIX]:Wo.FLOAT32,[Yo.LOCAL_SCALE]:Wo.FLOAT32,[Yo.LOCAL_POSITION]:Wo.FLOAT32,[Yo.LOCAL_ROTATION]:Wo.FLOAT32,[Yo.COUNT]:Wo.NEVER},Jo={[Yo.DIRTY_FLAG]:Yo.LAYER-Yo.DIRTY_FLAG,[Yo.LAYER]:Yo.WORLD_SCALE-Yo.LAYER,[Yo.WORLD_SCALE]:Yo.WORLD_POSITION-Yo.WORLD_SCALE,[Yo.WORLD_POSITION]:Yo.WORLD_ROTATION-Yo.WORLD_POSITION,[Yo.WORLD_ROTATION]:Yo.WORLD_MATRIX-Yo.WORLD_ROTATION,[Yo.WORLD_MATRIX]:Yo.LOCAL_SCALE-Yo.WORLD_MATRIX,[Yo.LOCAL_SCALE]:Yo.LOCAL_POSITION-Yo.LOCAL_SCALE,[Yo.LOCAL_POSITION]:Yo.LOCAL_ROTATION-Yo.LOCAL_POSITION,[Yo.LOCAL_ROTATION]:Yo.COUNT-Yo.LOCAL_ROTATION,[Yo.COUNT]:1},$o=new qo(Xo.NODE,Ko,Jo,Yo);let Zo;!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.STAGE=1]="STAGE",t[t.PHASE=2]="PHASE",t[t.PRIMITIVE=3]="PRIMITIVE",t[t.BATCHING_SCHEME=4]="BATCHING_SCHEME",t[t.DYNAMIC_STATE=5]="DYNAMIC_STATE",t[t.HASH=6]="HASH",t[t.COUNT=7]="COUNT"}(Zo||(Zo={}));const Qo={[Zo.PRIORITY]:Wo.UINT32,[Zo.STAGE]:Wo.UINT32,[Zo.PHASE]:Wo.UINT32,[Zo.PRIMITIVE]:Wo.UINT32,[Zo.BATCHING_SCHEME]:Wo.UINT32,[Zo.DYNAMIC_STATE]:Wo.UINT32,[Zo.HASH]:Wo.UINT32,[Zo.COUNT]:Wo.NEVER},ta={[Zo.PRIORITY]:Zo.STAGE-Zo.PRIORITY,[Zo.STAGE]:Zo.PHASE-Zo.STAGE,[Zo.PHASE]:Zo.PRIMITIVE-Zo.PHASE,[Zo.PRIMITIVE]:Zo.BATCHING_SCHEME-Zo.PRIMITIVE,[Zo.BATCHING_SCHEME]:Zo.DYNAMIC_STATE-Zo.BATCHING_SCHEME,[Zo.DYNAMIC_STATE]:Zo.HASH-Zo.DYNAMIC_STATE,[Zo.HASH]:Zo.COUNT-Zo.HASH,[Zo.COUNT]:1},ea=new qo(Xo.PASS,Qo,ta,Zo);let ia;!function(t){t[t.CENTER=0]="CENTER",t[t.HALFEXTENTS=3]="HALFEXTENTS",t[t.COUNT=6]="COUNT"}(ia||(ia={}));const na={[ia.CENTER]:Wo.FLOAT32,[ia.HALFEXTENTS]:Wo.FLOAT32,[ia.COUNT]:Wo.NEVER},sa={[ia.CENTER]:ia.HALFEXTENTS-ia.CENTER,[ia.HALFEXTENTS]:ia.COUNT-ia.HALFEXTENTS,[ia.COUNT]:1},ra=new qo(Xo.AABB,na,sa,ia),oa=ns.Node,aa=ns.Scene,ca=ns.Model,la=ns.SkinningModel,ha=ns.BakedSkinningModel,_a=ns.light,ua=ns.DirectionalLight,da=ns.SpotLight,ma=ns.SphereLight,pa=ns.Skybox,fa=ns.Fog,ga=ns.Ambient,va=ns.Shadow,ya=ns.OctreeInfo,xa=ns.Camera,Sa=ns.RenderWindow,Ca=ns.RenderScene,Aa=ns.DrawBatch2D,ba=ns.Pass,Ta=ns.SubModel,Ea=ns.Root,Pa=ns.PipelineSharedSceneData,wa=ns.AABB,Ia=nr.GeometryRenderer,Ra=new mi,Da=new mi,Ma=new mi,Oa=new mi,Ba=new vi,Na=(t,e,i)=>{Ba.m00=Math.abs(i.m00),Ba.m01=Math.abs(i.m01),Ba.m02=Math.abs(i.m02),Ba.m03=Math.abs(i.m04),Ba.m04=Math.abs(i.m05),Ba.m05=Math.abs(i.m06),Ba.m06=Math.abs(i.m08),Ba.m07=Math.abs(i.m09),Ba.m08=Math.abs(i.m10),mi.transformMat3(t,e,Ba)};class La{static create(t,e,i,n,s,r){return new La(t,e,i,n,s,r)}static clone(t){return new La(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)}static copy(t,e){return mi.copy(t.center,e.center),mi.copy(t.halfExtents,e.halfExtents),t}static fromPoints(t,e,i){return mi.add(Ra,i,e),mi.subtract(Da,i,e),mi.multiplyScalar(t.center,Ra,.5),mi.multiplyScalar(t.halfExtents,Da,.5),t}static set(t,e,i,n,s,r,o){return t.center.set(e,i,n),t.halfExtents.set(s,r,o),t}static merge(t,e,i){return mi.subtract(Ra,e.center,e.halfExtents),mi.subtract(Da,i.center,i.halfExtents),mi.add(Ma,e.center,e.halfExtents),mi.add(Oa,i.center,i.halfExtents),mi.max(Oa,Ma,Oa),mi.min(Ma,Ra,Da),La.fromPoints(t,Ma,Oa)}static toBoundingSphere(t,e){return t.center.set(e.center),t.radius=e.halfExtents.length(),t}static transform(t,e,i){return mi.transformMat4(t.center,e.center,i),Na(t.halfExtents,e.halfExtents,i),t}get type(){return this._type}constructor(t=0,e=0,i=0,n=1,s=1,r=1){return this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=Hr.SHAPE_AABB,this._aabbHandle=ra.alloc(),this.center=new mi(ra.getTypedArray(this._aabbHandle,ia.CENTER)),this.halfExtents=new mi(ra.getTypedArray(this._aabbHandle,ia.HALFEXTENTS)),this.center.set(t,e,i),this.halfExtents.set(n,s,r),this._nativeObj=new wa,void this._nativeObj.initWithData(ra.getBuffer(this._aabbHandle))}get native(){return this._nativeObj}getBoundary(t,e){mi.subtract(t,this.center,this.halfExtents),mi.add(e,this.center,this.halfExtents)}transform(t,e,i,n,s){mi.transformMat4(s.center,this.center,t),Na(s.halfExtents,this.halfExtents,t)}clone(){return La.clone(this)}copy(t){return La.copy(this,t)}mergePoint(t){this.getBoundary(Ra,Da),t.x<Ra.x&&(Ra.x=t.x),t.y<Ra.y&&(Ra.y=t.y),t.z<Ra.z&&(Ra.z=t.z),t.x>Da.x&&(Da.x=t.x),t.y>Da.y&&(Da.y=t.y),t.z>Da.z&&(Da.z=t.z),mi.add(Ma,Ra,Da),this.center.set(mi.multiplyScalar(Ma,Ma,.5)),this.halfExtents.set(Da.x-Ma.x,Da.y-Ma.y,Da.z-Ma.z)}mergePoints(t){if(!(t.length<1))for(let e=0;e<t.length;e++)this.mergePoint(t[e])}mergeFrustum(t){return this.mergePoints(t.vertices)}}const Fa=new mi,za=new mi,Va=new vi;class Ga{static create(t,e,i,n,s,r,o,a,c,l,h,_,u,d,m){return new Ga(t,e,i,n,s,r,o,a,c,l,h,_,u,d,m)}static clone(t){return new Ga(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)}static copy(t,e){return mi.copy(t.center,e.center),mi.copy(t.halfExtents,e.halfExtents),vi.copy(t.orientation,e.orientation),t}static fromPoints(t,e,i){return mi.multiplyScalar(t.center,mi.add(Fa,e,i),.5),mi.multiplyScalar(t.halfExtents,mi.subtract(za,i,e),.5),vi.identity(t.orientation),t}static set(t,e,i,n,s,r,o,a,c,l,h,_,u,d,m,p){return mi.set(t.center,e,i,n),mi.set(t.halfExtents,s,r,o),vi.set(t.orientation,a,c,l,h,_,u,d,m,p),t}get type(){return this._type}constructor(t=0,e=0,i=0,n=1,s=1,r=1,o=1,a=0,c=0,l=0,h=1,_=0,u=0,d=0,m=1){this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Hr.SHAPE_OBB,this.center=new mi(t,e,i),this.halfExtents=new mi(n,s,r),this.orientation=new vi(o,a,c,l,h,_,u,d,m)}getBoundary(t,e){var i,n,s;i=Fa,n=this.halfExtents,s=this.orientation,Va.m00=Math.abs(s.m00),Va.m01=Math.abs(s.m01),Va.m02=Math.abs(s.m02),Va.m03=Math.abs(s.m03),Va.m04=Math.abs(s.m04),Va.m05=Math.abs(s.m05),Va.m06=Math.abs(s.m06),Va.m07=Math.abs(s.m07),Va.m08=Math.abs(s.m08),mi.transformMat3(i,n,Va),mi.subtract(t,this.center,Fa),mi.add(e,this.center,Fa)}transform(t,e,i,n,s){mi.transformMat4(s.center,this.center,t),vi.fromQuat(s.orientation,i),mi.multiply(s.halfExtents,this.halfExtents,n)}translateAndRotate(t,e,i){mi.transformMat4(i.center,this.center,t),vi.fromQuat(i.orientation,e)}setScale(t,e){mi.multiply(e.halfExtents,this.halfExtents,t)}}class Ua{get type(){return this._type}constructor(t=.5,e=.5,i=1){this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=Hr.SHAPE_CAPSULE,this.radius=t,this.halfHeight=e,this.axis=i,this.center=new mi,this.rotation=new Si,this.ellipseCenter0=new mi(0,e,0),this.ellipseCenter1=new mi(0,-e,0),this.updateCache()}transform(t,e,i,n,s){const r=n,o=oi(r);s.radius=this.radius*Math.abs(o);let a=(this.halfHeight+this.radius)*Math.abs(r.y)-s.radius;a<0&&(a=0),s.halfHeight=a,mi.transformMat4(s.center,this.center,t),Si.multiply(s.rotation,this.rotation,i),s.updateCache()}updateCache(){this.updateLocalCenter(),mi.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),mi.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)}updateLocalCenter(){const t=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(t,0,0),this.ellipseCenter1.set(-t,0,0);break;case 1:this.ellipseCenter0.set(0,t,0),this.ellipseCenter1.set(0,-t,0);break;case 2:this.ellipseCenter0.set(0,0,t),this.ellipseCenter1.set(0,0,-t)}}}const ka=new Array(8);ka[0]=new mi(1,1,1),ka[1]=new mi(-1,1,1),ka[2]=new mi(-1,-1,1),ka[3]=new mi(1,-1,1),ka[4]=new mi(1,1,-1),ka[5]=new mi(-1,1,-1),ka[6]=new mi(-1,-1,-1),ka[7]=new mi(1,-1,-1);const Ha=new mi,ja=new mi,Wa=new mi;class qa{static createFromAABB(t,e){const i=new mi,n=new mi;return mi.subtract(i,e.center,e.halfExtents),mi.add(n,e.center,e.halfExtents),t.vertices[0].set(i.x,n.y,i.z),t.vertices[1].set(n.x,n.y,i.z),t.vertices[2].set(n.x,i.y,i.z),t.vertices[3].set(i.x,i.y,i.z),t.vertices[4].set(i.x,n.y,n.z),t.vertices[5].set(n.x,n.y,n.z),t.vertices[6].set(n.x,i.y,n.z),t.vertices[7].set(i.x,i.y,n.z),t._type!==Hr.SHAPE_FRUSTUM_ACCURATE||t.updatePlanes(),t}static split(t,e,i,n,s){const r=Math.tan(.5*e.fov),o=r*e.aspect;Ha.set(n*o,n*r,n),ja.set(s*o,s*r,s);const a=t.vertices;return Wa.set(Ha.x,Ha.y,Ha.z),mi.transformMat4(a[0],Wa,i),Wa.set(-Ha.x,Ha.y,Ha.z),mi.transformMat4(a[1],Wa,i),Wa.set(-Ha.x,-Ha.y,Ha.z),mi.transformMat4(a[2],Wa,i),Wa.set(Ha.x,-Ha.y,Ha.z),mi.transformMat4(a[3],Wa,i),Wa.set(ja.x,ja.y,ja.z),mi.transformMat4(a[4],Wa,i),Wa.set(-ja.x,ja.y,ja.z),mi.transformMat4(a[5],Wa,i),Wa.set(-ja.x,-ja.y,ja.z),mi.transformMat4(a[6],Wa,i),Wa.set(ja.x,-ja.y,ja.z),mi.transformMat4(a[7],Wa,i),t.updatePlanes(),t}static create(){return new qa}static clone(t){return qa.copy(new qa,t)}static copy(t,e){t._type=e._type;for(let i=0;i<6;++i)Ho.copy(t.planes[i],e.planes[i]);for(let i=0;i<8;++i)mi.copy(t.vertices[i],e.vertices[i]);return t}set accurate(t){this._type=t?Hr.SHAPE_FRUSTUM_ACCURATE:Hr.SHAPE_FRUSTUM}get type(){return this._type}constructor(){this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=Hr.SHAPE_FRUSTUM,this.planes=new Array(6);for(let t=0;t<6;++t)this.planes[t]=Ho.create(0,0,0,0);this.vertices=new Array(8);for(let t=0;t<8;++t)this.vertices[t]=new mi}update(t,e){if(mi.set(this.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08),this.planes[0].d=-(t.m15+t.m12),mi.set(this.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08),this.planes[1].d=-(t.m15-t.m12),mi.set(this.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09),this.planes[2].d=-(t.m15+t.m13),mi.set(this.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09),this.planes[3].d=-(t.m15-t.m13),mi.set(this.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10),this.planes[4].d=-(t.m15+t.m14),mi.set(this.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10),this.planes[5].d=-(t.m15-t.m14),this._type===Hr.SHAPE_FRUSTUM_ACCURATE){for(let t=0;t<6;t++){const e=this.planes[t],i=1/e.n.length();mi.multiplyScalar(e.n,e.n,i),e.d*=i}for(let t=0;t<8;t++)mi.transformMat4(this.vertices[t],ka[t],e)}}transform(t){if(this._type===Hr.SHAPE_FRUSTUM_ACCURATE){for(let e=0;e<8;e++)mi.transformMat4(this.vertices[e],this.vertices[e],t);this.updatePlanes()}}updatePlanes(){Ho.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Ho.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Ho.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Ho.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Ho.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Ho.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}}let Xa,Ya,Ka,Ja,$a,Za;qa.createOrtho=(t,e,i,n,s,r)=>{const o=e/2,a=i/2;mi.set(Wa,o,a,-n),mi.transformMat4(t.vertices[0],Wa,r),mi.set(Wa,-o,a,-n),mi.transformMat4(t.vertices[1],Wa,r),mi.set(Wa,-o,-a,-n),mi.transformMat4(t.vertices[2],Wa,r),mi.set(Wa,o,-a,-n),mi.transformMat4(t.vertices[3],Wa,r),mi.set(Wa,o,a,-s),mi.transformMat4(t.vertices[4],Wa,r),mi.set(Wa,-o,a,-s),mi.transformMat4(t.vertices[5],Wa,r),mi.set(Wa,-o,-a,-s),mi.transformMat4(t.vertices[6],Wa,r),mi.set(Wa,o,-a,-s),mi.transformMat4(t.vertices[7],Wa,r),Ho.fromPoints(t.planes[0],t.vertices[1],t.vertices[6],t.vertices[5]),Ho.fromPoints(t.planes[1],t.vertices[3],t.vertices[4],t.vertices[7]),Ho.fromPoints(t.planes[2],t.vertices[6],t.vertices[3],t.vertices[7]),Ho.fromPoints(t.planes[3],t.vertices[0],t.vertices[5],t.vertices[4]),Ho.fromPoints(t.planes[4],t.vertices[2],t.vertices[0],t.vertices[3]),Ho.fromPoints(t.planes[5],t.vertices[7],t.vertices[5],t.vertices[6])},function(t){t[t.Default=0]="Default",t[t.Normal=1]="Normal",t[t.Loop=2]="Loop",t[t.ShouldWrap=4]="ShouldWrap",t[t.Clamp=8]="Clamp",t[t.PingPong=22]="PingPong",t[t.Reverse=36]="Reverse"}(Xa||(Xa={})),function(t){t[t.Default=Xa.Default]="Default",t[t.Normal=Xa.Normal]="Normal",t[t.Reverse=Xa.Reverse]="Reverse",t[t.Loop=Xa.Loop]="Loop",t[t.LoopReverse=Xa.Loop|Xa.Reverse]="LoopReverse",t[t.PingPong=Xa.PingPong]="PingPong",t[t.PingPongReverse=Xa.PingPong|Xa.Reverse]="PingPongReverse"}(Ya||(Ya={})),Xt(Ya);class Qa{constructor(t){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}set(t){this.ratio=t.ratio,this.time=t.time,this.direction=t.direction,this.stopped=t.stopped,this.iterations=t.iterations,this.frameIndex=t.frameIndex}}function tc(t,e,i=1e-6){let n=0,s=t.length-1,r=s>>>1;for(;n<=s;r=n+s>>>1){const o=t[r];if(o>e+i)s=r-1;else{if(!(o<e-i))return r;n=r+1}}return~n}Ka=Symbol.iterator;class ec{constructor(){this._times=[],this._values=[]}get keyFramesCount(){return this._times.length}get rangeMin(){return this._times[0]}get rangeMax(){return this._times[this._values.length-1]}[Ka](){let t=0;return{next:()=>{if(t>=this._times.length)return{done:!0,value:void 0};{const e=[this._times[t],this._values[t]];return++t,{done:!1,value:e}}}}}keyframes(){return this}times(){return this._times}values(){return this._values}getKeyframeTime(t){return this._times[t]}getKeyframeValue(t){return this._values[t]}addKeyFrame(t,e){return this._insertNewKeyframe(t,e)}removeKeyframe(t){this._times.splice(t,1),this._values.splice(t,1)}indexOfKeyframe(t){return tc(this._times,t)}updateTime(t,e){const i=this._values[t];this.removeKeyframe(t),this._insertNewKeyframe(e,i)}assignSorted(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.slice());else{const e=Array.from(t);this.setKeyframes(e.map((([t])=>t)),e.map((([,t])=>t)))}}clear(){this._times.length=0,this._values.length=0}searchKeyframe(t){return tc(this._times,t)}setKeyframes(t,e){t.length,e.length,function(t){t.every(((t,e,i)=>0===e||t>i[e-1]||je(t,i[e-1],1e-6)))}(t),this._times=t,this._values=e}_insertNewKeyframe(t,e){const i=this._times,n=this._values,s=i.length,r=tc(i,t);if(r>=0)return r;const o=~r;return 0===o?(i.unshift(t),n.unshift(e)):o===s?(i.push(t),n.push(e)):(i.splice(o-1,0,t),n.splice(o-1,0,e)),o}}function ic(t){return t>-1e-9&&t<1e-9}function nc(t,e,i,n){i&&Object.defineProperty(t,e,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function sc(t,e,i,n,s){var r={};return Object.keys(n).forEach((function(t){r[t]=n[t]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=i.slice().reverse().reduce((function(i,n){return n(t,e,i)||i}),r),s&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(s):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(t,e,r),r=null),r}Le.fastDefine("cc.KeyframeCurve",ec,{_times:[],_values:[]}),function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.CUBIC=2]="CUBIC"}(Ja||(Ja=t("RealInterpolationMode",{}))),function(t){t[t.LINEAR=0]="LINEAR",t[t.CLAMP=1]="CLAMP",t[t.LOOP=2]="LOOP",t[t.PING_PONG=3]="PING_PONG"}($a||($a=t("ExtrapolationMode",{}))),function(t){t[t.NONE=0]="NONE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.BOTH=3]="BOTH"}(Za||(Za=t("TangentWeightMode",{})));const rc=()=>{},oc=()=>rc,ac=cc((()=>{}));function cc(t){return function(e){return"function"==typeof e?t(e):function(i){return t(i,e)}}}function lc(t){return e=>i=>{!function(t,e,i){const n=_c(t);if(n){const t=uc(n,"proto");uc(t,"editor")[e]=i}}(i,t,e)}}const hc="__ccclassCache__";function _c(t){return uc(t,hc)}function uc(t,e){return t[e]||(t[e]={})}const dc=cc(((t,e)=>{let i=Ut.getSuper(t);i===Object&&(i=null);const n={name:e,extends:i,ctor:t},s=t[hc];if(s){const e=s.proto;e&&Ut.mixin(n,e),t[hc]=void 0}return Le(n)})),mc=lc("requireComponent"),pc=lc("executionOrder"),fc=ac;function gc(t,e,i){let n=null;function s(t,e,i){!function(t,e,i,n,s,r){let o;const a=r&&(r.get||r.set);s&&(o=Te(s,a));const c=Ut.mixin(e,o||s||{});a?(r.get&&(c.get=r.get),r.set&&(c.set=r.set)):yc(t,c,i,n,r)}(function(t){return _c(t.constructor)}(t),function(t,e){var i,n;const s=uc(_c(t.constructor),"proto"),r=uc(s,"properties");return null!==(n=r[i=e])&&void 0!==n?n:r[i]={}}(t,e),t.constructor,e,n,i)}return void 0===t?gc({type:void 0}):void 0===e?(n=t,s):void s(t,e,i)}function vc(t,e,i){var n,s;const r=_c(t.constructor),o=uc(r,"proto"),a=uc(o,"properties"),c=null!==(s=a[n=e])&&void 0!==s?s:a[n]={};return c.__internalFlags|=Ee.STANDALONE,i&&(i.get||i.set)?(i.get&&(c.get=i.get),i.set&&(c.set=i.set)):yc(r,c,t.constructor,e,i),c}function yc(t,e,i,n,s){if(s)s.initializer&&(e.default=function(t){let e;try{e=t()}catch(e){return t}return"object"!=typeof e||null===e?e:t}(s.initializer));else{const s=t.default||(t.default=function(t){let e;try{e=new t}catch(t){return{}}return e}(i));s.hasOwnProperty(n)&&(e.default=s[n])}}const xc=Symbol("cc:SerializationMetadata"),Sc=(t,e,i)=>{bc(vc(t,e,i))};function Cc(t){return(e,i,n)=>{const s=vc(e,i,n);s.formerlySerializedAs=t,bc(s)}}const Ac=(t,e,i)=>{const n=vc(t,e,i);n.editorOnly=!0,bc(n)};function bc(t){t.__internalFlags|=Ee.IMPLICIT_SERIALIZABLE}const Tc=rc,Ec=ac,Pc=oc,wc=ac,Ic=oc,Rc=oc,Dc=oc,Mc=rc,Oc=oc,Bc=rc,Nc=oc,Lc=oc,Fc=oc,zc=oc,Vc=oc,Gc=oc,Uc=rc,kc=oc,Hc=rc,jc=rc,Wc=Kc(pe),qc=Kc(fe),Xc=Kc(ge),Yc=Kc(ve);function Kc(t){return gc({type:t})}const Jc=(t,e,i)=>{vc(t,e,i).override=!0},$c=t("editorExtrasTag","__editorExtras__");const Zc=class{};var Qc=Object.freeze({__proto__:null,uniquelyReferenced:Tc,ccclass:dc,property:gc,requireComponent:mc,executionOrder:pc,disallowMultiple:fc,allowReplicated:t=>{Le.Attr.setClassAttr(t,"replicated","visible",!0)},executeInEditMode:Ec,menu:Pc,playOnFocus:wc,inspector:Ic,icon:Rc,help:Dc,type:Kc,integer:Wc,float:qc,boolean:Xc,string:Yc});t("_decorator",Qc);const tl=1<<22,el=[];class il{static _deferredDestroy(){const t=el.length;for(let e=0;e<t;++e){const t=el[e];1&t._objFlags||t._destroyImmediate()}t===el.length?el.length=0:el.splice(0,t)}constructor(t=""){this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}get name(){return this._name}set name(t){this._name=t}set hideFlags(t){const e=t&il.Flags.AllHideMasks;this._objFlags=this._objFlags&~il.Flags.AllHideMasks|e}get hideFlags(){return this._objFlags&il.Flags.AllHideMasks}set replicated(t){t?this._objFlags|=tl:this._objFlags&=-4194305}get replicated(){return!!(this._objFlags&tl)}get isValid(){return!(1&this._objFlags)}destroy(){return 1&this._objFlags?(I(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,el.push(this),0))}_destruct(){const t=this.constructor;let e=t.__destruct__;e||(e=function(t,e){const i=t instanceof l._BaseNode||t instanceof l.Component,n=i?"_id":null;let s;const r={};for(s in t)if(t.hasOwnProperty(s)){if(s===n)continue;switch(typeof t[s]){case"string":r[s]="";break;case"object":case"function":r[s]=null}}if(Le._isCCClass(e)){const t=l.Class.Attr.getClassAttrs(e),n=e.__props__;for(let e=0;e<n.length;e++){s=n[e];const o=`${s+l.Class.Attr.DELIMETER}default`;if(o in t){if(i&&"_id"===s)continue;switch(typeof t[o]){case"string":r[s]="";break;case"object":case"function":r[s]=null;break;case"undefined":r[s]=void 0}}}}{let t="";for(s in r){let e;e=Le.IDENTIFIER_RE.test(s)?`o.${s}=`:`o[${Le.escapeForJS(s)}]=`;let i=r[s];""===i&&(i='""'),t+=`${e+i};\n`}return Function("o",t)}}(this,t),ct(t,"__destruct__",e,!0)),e(this)}_destroyImmediate(){1&this._objFlags?D(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}}t("CCObject",il);const nl=il.prototype;function sl(t,e){return"object"==typeof t?!(!t||t._objFlags&(e?5:1)):void 0!==t}nl._deserialize=null,nl._onPreDestroy=null,Le.fastDefine("cc.Object",il,{_name:"",_objFlags:0,[$c]:{}}),Le.Attr.setClassAttr(il,$c,"editorOnly",!0),Le.Attr.setClassAttr(il,"replicated","visible",!1),ct(il,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),l.isValid=sl,l.Object=il;class rl{constructor(t){this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=Ut.createMap(!0),this._count=0)}add(t,e){return t in this._map||this._count++,this._map[t]=e}get(t){return this._map[t]}has(t){return t in this._map}remove(t){const e=this._map[t];return t in this._map&&(delete this._map[t],this._count--),e}clear(){0!==this._count&&(this._map=Ut.createMap(!0),this._count=0)}forEach(t){for(const e in this._map)t(this._map[e],e)}find(t){for(const e in this._map)if(t(this._map[e],e))return this._map[e];return null}get count(){return this._count}destroy(){this._map=null}}class ol{constructor(t,e){this.id=ol._pipelineId++,this.name="",this.pipes=[],this.name=t;for(let t=0,i=e.length;t<i;t++)this.pipes.push(e[t])}insert(t,e){return e>this.pipes.length?(I(4921),this):(this.pipes.splice(e,0,t),this)}append(t){return this.pipes.push(t),this}remove(t){return this.pipes.splice(t,1),this}sync(t){const e=this.pipes;if(0===e.length)return null;t.isFinish=!1;for(let i=0,n=e.length;i<n;){const s=(0,e[i])(t);if(s)return t.isFinish=!0,s;i++,i!==n&&(t.input=t.output,t.output=null)}return t.isFinish=!0,t.output}async(t){0!==this.pipes.length&&(t.isFinish=!1,this._flow(0,t))}_flow(t,e){(0,this.pipes[t])(e,(i=>{i?(e.isFinish=!0,e.dispatch("complete",i)):++t<this.pipes.length?(e.input=e.output,e.output=null,this._flow(t,e)):(e.isFinish=!0,e.dispatch("complete",i,e.output))}))}}ol._pipelineId=0;const al=new rl,cl=new rl,ll=new rl,hl=new rl,_l=new ol("normal load",[]),ul=new ol("fetch",[]),dl=new ol("transform url",[]);let ml;!function(t){t.UUID="uuid",t.PATH="path",t.DIR="dir",t.URL="url",t.SCENE="scene"}(ml||(ml={}));const pl={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};let fl;!function(t){t.RESOURCES="resources",t.MAIN="main",t.START_SCENE="start-scene"}(fl||(fl={}));class gl{static create(t){let e;return 0!==gl._deadPool.length?(e=gl._deadPool.pop(),e.set(t)):e=new gl(t),e}constructor(t){this.id=gl._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}set(t=Object.create(null)){this.onComplete=t.onComplete||null,this.onProgress=t.onProgress||null,this.onError=t.onError||null,this.source=this.input=t.input,this.output=null,this.progress=t.progress,this.options=t.options||Object.create(null)}dispatch(t,e,i,n,s){switch(t){case"complete":this.onComplete&&this.onComplete(e,i);break;case"progress":this.onProgress&&this.onProgress(e,i,n,s);break;case"error":this.onError&&this.onError(e,i,n,s);break;default:{const r=`on${t[0].toUpperCase()}${t.substr(1)}`;"function"==typeof this[r]&&this[r](e,i,n,s);break}}}recycle(){gl._deadPool.length!==gl.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,gl._deadPool.push(this))}}gl.MAX_DEAD_NUM=500,gl._taskId=0,gl._deadPool=[];const vl="0123456789abcdef".split(""),yl=["","","",""],xl=yl.concat(yl,"-",yl,"-",yl,"-",yl,"-",yl,yl,yl),Sl=xl.map(((t,e)=>"-"===t?NaN:e)).filter(isFinite);function Cl(t){const e=t.split("@")[0];if(22!==e.length)return t;xl[0]=t[0],xl[1]=t[1];for(let e=2,i=2;e<22;e+=2){const n=Zt[t.charCodeAt(e)],s=Zt[t.charCodeAt(e+1)];xl[Sl[i++]]=vl[n>>2],xl[Sl[i++]]=vl[(3&n)<<2|s>>4],xl[Sl[i++]]=vl[15&s]}return t.replace(e,xl.join(""))}const Al=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function bl(t){const e=Al.exec(t);return e?e[1]:""}function Tl(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.nativeExt&&(e.ext=e.nativeExt);const i=hl.find((e=>!!e.getAssetInfo(t)));return i&&(e.bundle=i.name),wl(t,e)}function El(t){return!!t&&(t instanceof l.SceneAsset||t instanceof l.Scene)}function Pl(t){return t&&(46===t.charCodeAt(0)&&47===t.charCodeAt(1)?t=t.slice(2):47===t.charCodeAt(0)&&(t=t.slice(1))),t}function wl(t,e){const i=gl.create({input:t,options:e}),n=[];try{const t=dl.sync(i);for(const e of t){const t=e.url;e.recycle(),n.push(t)}}catch(t){for(const t of i.output)t.recycle();x(t.message,t.stack)}return i.recycle(),n.length>1?n:n[0]}var Il=Object.freeze({__proto__:null,getUuidFromURL:bl,getUrlWithUuid:Tl,isScene:El,normalize:Pl,transform:wl,decodeUuid:Cl});const Rl=new class{constructor(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}addContainer(t){-1===t._poolHandle&&(t._poolHandle=this._pools.length,this._pools.push(t))}removeContainer(t){-1!==t._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=t._poolHandle,J(this._pools,t._poolHandle),t._poolHandle=-1)}tryShrink(){for(let t=0;t<this._pools.length;t++)this._pools[t].tryShrink()}update(t){this._lastShrinkPassed+=t,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)}};class Dl{constructor(){this._poolHandle=-1,Rl.addContainer(this)}destroy(){Rl.removeContainer(this)}}class Ml extends Dl{constructor(t,e,i){super(),this._ctor=void 0,this._elementsPerBatch=void 0,this._nextAvail=void 0,this._freepool=[],this._dtor=void 0,this._ctor=t,this._dtor=i||null,this._elementsPerBatch=Math.max(e,1),this._nextAvail=this._elementsPerBatch-1;for(let e=0;e<this._elementsPerBatch;++e)this._freepool.push(t())}alloc(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(let t=0;t<this._elementsPerBatch;t++)this._freepool[t]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]}free(t){this._freepool[++this._nextAvail]=t}freeArray(t){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,t),this._nextAvail+=t.length}tryShrink(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(let t=this._nextAvail>>1;t<=this._nextAvail;t++)this._dtor(this._freepool[t]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}}destroy(){const t=arguments.length>0?arguments[0]:null;t&&I(14100);const e=t||this._dtor;if(e)for(let t=0;t<=this._nextAvail;t++)e(this._freepool[t]);this._freepool.length=0,this._nextAvail=-1,super.destroy()}}t("Pool",Ml);class Ol extends Dl{constructor(t,e,i){super(),this._fn=void 0,this._dtor=null,this._count=0,this._data=void 0,this._initSize=0,this._fn=t,this._dtor=i||null,this._data=new Array(e),this._initSize=e;for(let i=0;i<e;++i)this._data[i]=t()}get length(){return this._count}get data(){return this._data}reset(){this._count=0}resize(t){if(t>this._data.length)for(let e=this._data.length;e<t;++e)this._data[e]=this._fn()}add(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]}destroy(){if(this._dtor)for(let t=0;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=0,this._count=0,super.destroy()}tryShrink(){if(this._data.length>>2>this._count){const t=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(let e=t;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=t}}removeAt(t){if(t>=this._count)return;const e=this._count-1,i=this._data[t];this._data[t]=this._data[e],this._data[e]=i,this._count-=1}}t("RecyclePool",Ol);class Bl extends Dl{constructor(t,e){super(),this.array=void 0,this.length=0,this._compareFn=void 0,this._initSize=0,this.array=new Array(t),this._initSize=t,this.length=0,this._compareFn=e}push(t){this.array[this.length++]=t}pop(){return this.array[--this.length]}get(t){return this.array[t]}clear(){this.length=0}destroy(){this.length=0,this.array.length=0,super.destroy()}tryShrink(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))}sort(){this.array.length=this.length,this.array.sort(this._compareFn)}concat(t){for(let e=0;e<t.length;++e)this.array[this.length++]=t[e]}fastRemove(t){if(t>=this.length||t<0)return;const e=--this.length;this.array[t]=this.array[e]}indexOf(t){for(let e=0,i=this.length;e<i;++e)if(this.array[e]===t)return e;return-1}}t("CachedArray",Bl),t("memop",Object.freeze({__proto__:null,Pool:Ml,RecyclePool:Ol,CachedArray:Bl}));const Nl=Gt.fastRemoveAt;function Ll(){}class Fl{constructor(){this.callback=Ll,this.target=void 0,this.once=!1}set(t,e,i){this.callback=t||Ll,this.target=e,this.once=!!i}reset(){this.target=void 0,this.callback=Ll,this.once=!1}check(){return!(this.target instanceof il&&!sl(this.target,!0))}}const zl=new Ml((()=>new Fl),32);class Vl{constructor(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}removeByCallback(t){for(let e=0;e<this.callbackInfos.length;++e){const i=this.callbackInfos[e];i&&i.callback===t&&(i.reset(),zl.free(i),Nl(this.callbackInfos,e),--e)}}removeByTarget(t){for(let e=0;e<this.callbackInfos.length;++e){const i=this.callbackInfos[e];i&&i.target===t&&(i.reset(),zl.free(i),Nl(this.callbackInfos,e),--e)}}cancel(t){const e=this.callbackInfos[t];e&&(e.reset(),this.isInvoking?this.callbackInfos[t]=null:Nl(this.callbackInfos,t),zl.free(e)),this.containCanceled=!0}cancelAll(){for(let t=0;t<this.callbackInfos.length;t++){const e=this.callbackInfos[t];e&&(e.reset(),zl.free(e),this.callbackInfos[t]=null)}this.containCanceled=!0}purgeCanceled(){for(let t=this.callbackInfos.length-1;t>=0;--t)this.callbackInfos[t]||Nl(this.callbackInfos,t);this.containCanceled=!1}clear(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}const Gl=new Ml((()=>new Vl),16);class Ul{constructor(){this._callbackTable=ut(!0),this._offCallback=void 0}on(t,e,i,n){if(!this.hasEventListener(t,e,i)){let s=this._callbackTable[t];s||(s=this._callbackTable[t]=Gl.alloc());const r=zl.alloc();r.set(e,i,n),s.callbackInfos.push(r)}return e}hasEventListener(t,e,i){const n=this._callbackTable&&this._callbackTable[t];if(!n)return!1;const s=n.callbackInfos;if(!e){if(n.isInvoking){for(let t=0;t<s.length;++t)if(s[t])return!0;return!1}return s.length>0}for(let t=0;t<s.length;++t){const n=s[t];if(n&&n.check()&&n.callback===e&&n.target===i)return!0}return!1}removeAll(t){const e=typeof t;if("string"===e||"number"===e){const e=this._callbackTable&&this._callbackTable[t];e&&(e.isInvoking?e.cancelAll():(e.clear(),Gl.free(e),delete this._callbackTable[t]))}else if(t)for(const e in this._callbackTable){const i=this._callbackTable[e];if(i.isInvoking){const e=i.callbackInfos;for(let n=0;n<e.length;++n){const s=e[n];s&&s.target===t&&i.cancel(n)}}else i.removeByTarget(t)}}off(t,e,i){var n;const s=this._callbackTable&&this._callbackTable[t];if(s){const n=s.callbackInfos;if(e)for(let t=0;t<n.length;++t){const r=n[t];if(r&&r.callback===e&&r.target===i){s.cancel(t);break}}else this.removeAll(t)}null===(n=this._offCallback)||void 0===n||n.call(this)}emit(t,e,i,n,s,r){const o=this._callbackTable&&this._callbackTable[t];if(o){const a=!o.isInvoking;o.isInvoking=!0;const c=o.callbackInfos;for(let o=0,a=c.length;o<a;++o){const a=c[o];if(a){const o=a.callback,c=a.target;a.once&&this.off(t,o,c),a.check()?c?o.call(c,e,i,n,s,r):o(e,i,n,s,r):this.off(t,o,c)}}a&&(o.isInvoking=!1,o.containCanceled&&o.purgeCanceled())}}clear(){for(const t in this._callbackTable){const e=this._callbackTable[t];e&&(e.clear(),Gl.free(e),delete this._callbackTable[t])}}_registerOffCallback(t){this._offCallback=t}}function kl(t){class e extends t{constructor(...t){super(...t),this._callbackTable=ut(!0)}once(t,e,i){return this.on(t,e,i,!0)}targetOff(t){this.removeAll(t)}}const i=Ul.prototype,n=Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i));for(let t=0;t<n.length;++t){const s=n[t];if(!(s in e.prototype)){const t=Object.getOwnPropertyDescriptor(i,s);t&&Object.defineProperty(e.prototype,s,t)}}return e}const Hl=t("EventTarget",kl(class{}));let jl,Wl,ql,Xl,Yl,Kl;l.EventTarget=Hl,function(t){t.UNKNOWN="unknown",t.WECHAT="wechat",t.ANDROID="androidbrowser",t.IE="ie",t.EDGE="edge",t.QQ="qqbrowser",t.MOBILE_QQ="mqqbrowser",t.UC="ucbrowser",t.UCBS="ucbs",t.BROWSER_360="360browser",t.BAIDU_APP="baiduboxapp",t.BAIDU="baidubrowser",t.MAXTHON="maxthon",t.OPERA="opera",t.OUPENG="oupeng",t.MIUI="miuibrowser",t.FIREFOX="firefox",t.SAFARI="safari",t.CHROME="chrome",t.LIEBAO="liebao",t.QZONE="qzone",t.SOUGOU="sogou",t.HUAWEI="huawei"}(jl||(jl={})),function(t){t.UNKNOWN="unknown",t.ENGLISH="en",t.CHINESE="zh",t.FRENCH="fr",t.ITALIAN="it",t.GERMAN="de",t.SPANISH="es",t.DUTCH="du",t.RUSSIAN="ru",t.KOREAN="ko",t.JAPANESE="ja",t.HUNGARIAN="hu",t.PORTUGUESE="pt",t.ARABIC="ar",t.NORWEGIAN="no",t.POLISH="pl",t.TURKISH="tr",t.UKRAINIAN="uk",t.ROMANIAN="ro",t.BULGARIAN="bg"}(Wl||(Wl={})),function(t){t[t.NONE=0]="NONE",t[t.LAN=1]="LAN",t[t.WWAN=2]="WWAN"}(ql||(ql={})),function(t){t.UNKNOWN="Unknown",t.IOS="iOS",t.ANDROID="Android",t.WINDOWS="Windows",t.LINUX="Linux",t.OSX="OS X",t.OHOS="OHOS"}(Xl||(Xl={})),function(t){t.UNKNOWN="UNKNOWN",t.EDITOR_PAGE="EDITOR_PAGE",t.EDITOR_CORE="EDITOR_CORE",t.MOBILE_BROWSER="MOBILE_BROWSER",t.DESKTOP_BROWSER="DESKTOP_BROWSER",t.WIN32="WIN32",t.ANDROID="ANDROID",t.IOS="IOS",t.MACOS="MACOS",t.OHOS="OHOS",t.WECHAT_GAME="WECHAT_GAME",t.BAIDU_MINI_GAME="BAIDU_MINI_GAME",t.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",t.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",t.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",t.OPPO_MINI_GAME="OPPO_MINI_GAME",t.VIVO_MINI_GAME="VIVO_MINI_GAME",t.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",t.COCOSPLAY="COCOSPLAY",t.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",t.QTT_MINI_GAME="QTT_MINI_GAME"}(Yl||(Yl={})),function(t){t.WEBP="WEBP",t.IMAGE_BITMAP="IMAGE_BITMAP",t.WEB_VIEW="WEB_VIEW",t.VIDEO_PLAYER="VIDEO_PLAYER",t.SAFE_AREA="SAFE_AREA",t.INPUT_TOUCH="INPUT_TOUCH",t.EVENT_KEYBOARD="EVENT_KEYBOARD",t.EVENT_MOUSE="EVENT_MOUSE",t.EVENT_TOUCH="EVENT_TOUCH",t.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(Kl||(Kl={}));const Jl={0:ql.NONE,1:ql.LAN,2:ql.WWAN},$l={0:Yl.WIN32,2:Yl.MACOS,3:Yl.ANDROID,4:Yl.IOS,5:Yl.IOS,6:Yl.OHOS},Zl=new class extends Hl{get networkType(){return Jl[jsb.device.getNetworkType()]}constructor(){super(),this.isNative=void 0,this.isBrowser=void 0,this.isMobile=void 0,this.isLittleEndian=void 0,this.platform=void 0,this.language=void 0,this.nativeLanguage=void 0,this.os=void 0,this.osVersion=void 0,this.osMainVersion=void 0,this.browserType=void 0,this.browserVersion=void 0,this._featureMap=void 0,this.isNative=!0,this.isBrowser=!1,this.platform=$l[__getPlatform()],this.isMobile=this.platform===Yl.ANDROID||this.platform===Yl.IOS||this.platform===Yl.OHOS,this.isLittleEndian=(()=>{const t=new ArrayBuffer(2);return new DataView(t).setInt16(0,256,!0),256===new Int16Array(t)[0]})();const t=__getCurrentLanguageCode();this.nativeLanguage=t?t.toLowerCase():Wl.UNKNOWN,this.language=__getCurrentLanguage(),this.os=__getOS(),this.osVersion=__getOSVersion(),this.osMainVersion=parseInt(this.osVersion),this.browserType=jl.UNKNOWN,this.browserVersion="",this._featureMap={[Kl.WEBP]:!0,[Kl.IMAGE_BITMAP]:!1,[Kl.WEB_VIEW]:this.isMobile,[Kl.VIDEO_PLAYER]:this.isMobile,[Kl.SAFE_AREA]:this.isMobile,[Kl.INPUT_TOUCH]:this.isMobile,[Kl.EVENT_KEYBOARD]:!0,[Kl.EVENT_MOUSE]:!this.isMobile,[Kl.EVENT_TOUCH]:!0,[Kl.EVENT_ACCELEROMETER]:this.isMobile},this._registerEvent()}_registerEvent(){jsb.onPause=()=>{this.emit("hide"),l.internal.SplashScreen.instance.pauseRendering()},jsb.onResume=()=>{this.emit("show"),l.internal.SplashScreen.instance.resumeRendering()},jsb.onClose=()=>{this.emit("close")}}hasFeature(t){return this._featureMap[t]}getBatteryLevel(){return jsb.device.getBatteryLevel()}triggerGC(){jsb.garbageCollect()}openURL(t){jsb.openURL(t)}now(){return Date.now?Date.now():+new Date}restartJSVM(){__restartVM()}close(){__close()}},Ql=/(\.[^\.\/\?\\]*)(\?.*)?$/,th=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,eh=/[^\.\/]+\/\.\.\//;function ih(...t){let e="";for(const i of t)e=(e+(""===e?"":"/")+i).replace(/(\/|\\\\)$/,"");return e}function nh(t){const e=Ql.exec(t);return e?e[1]:""}function sh(t){if(t){const e=t.lastIndexOf(".");if(-1!==e)return t.substring(0,e)}return t}function rh(t,e){const i=t.indexOf("?");i>0&&(t=t.substring(0,i));const n=/(\/|\\)([^\/\\]+)$/g.exec(t.replace(/(\/|\\)$/,""));if(!n)return t;const s=n[2];return e&&t.substring(t.length-e.length).toLowerCase()===e.toLowerCase()?s.substring(0,s.length-e.length):s}function oh(t){const e=th.exec(t);return e?e[2]:""}function ah(t,e){e=e||"";let i=t.indexOf("?"),n="";return i>0&&(n=t.substring(i),t=t.substring(0,i)),i=t.lastIndexOf("."),i<0?t+e+n:t.substring(0,i)+e+n}function ch(t,e,i){if(0===e.indexOf("."))return ah(t,e);let n=t.indexOf("?"),s="";const r=i?nh(t):"";return n>0&&(s=t.substring(n),t=t.substring(0,n)),n=t.lastIndexOf("/"),n=n<=0?0:n+1,t.substring(0,n)+e+r+s}function lh(t){let e=t=String(t);do{e=t,t=t.replace(eh,"")}while(e.length!==t.length);return t}function hh(t){return t.replace(/[\/\\]$/,"")}function _h(){return Zl.os===Xl.WINDOWS?"\\":"/"}var uh,dh,mh,ph;t("path",Object.freeze({__proto__:null,join:ih,extname:nh,mainFileName:sh,basename:rh,dirname:oh,changeExtname:ah,changeBasename:ch,_normalize:lh,stripSep:hh,getSeperator:_h}));let fh=t("Asset",dc("cc.Asset")((ph=class extends(kl(il)){static deserialize(t){return l.deserialize(t)}get nativeUrl(){if(!this._nativeUrl){if(!this._native)return"";const t=this._native;if(47===t.charCodeAt(0))return t.slice(1);46===t.charCodeAt(0)?this._nativeUrl=Tl(this._uuid,{nativeExt:t,isNative:!0}):this._nativeUrl=Tl(this._uuid,{__nativeName__:t,nativeExt:nh(t),isNative:!0})}return this._nativeUrl}get _nativeAsset(){return this._file}set _nativeAsset(t){this._file=t}constructor(...t){super(...t),this.loaded=!0,nc(this,"_native",mh,this),this._nativeUrl="",this._file=null,this._ref=0,Object.defineProperty(this,"_uuid",{value:"",writable:!0})}toString(){return this.nativeUrl}serialize(){}_setRawAsset(t,e=!0){this._native=!1!==e?t||"":`/${t}`}get _nativeDep(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}get refCount(){return this._ref}addRef(){return this._ref++,this}decRef(t=!0){return this._ref>0&&this._ref--,t&&l.assetManager._releaseManager.tryRelease(this),this}onLoaded(){}initDefault(t){t&&(this._uuid=t),this.isDefault=!0}validate(){return!0}destroy(){return C(N(12101,this._uuid)),super.destroy()}},mh=sc((dh=ph).prototype,"_native",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sc(dh.prototype,"_nativeAsset",[gc],Object.getOwnPropertyDescriptor(dh.prototype,"_nativeAsset"),dh.prototype),uh=dh))||uh);var gh,vh,yh;fh.prototype.createNode=null,l.Asset=fh;let xh=t("Script",dc("cc.Script")(gh=class extends fh{})||gh);l._Script=xh;let Sh=t("JavaScript",dc("cc.JavaScript")(vh=class extends xh{})||vh);l._JavaScript=Sh;let Ch=t("TypeScript",dc("cc.TypeScript")(yh=class extends xh{})||yh);var Ah,bh,Th,Eh,Ph,wh,Ih,Rh,Dh,Mh,Oh;l._TypeScript=Ch;const Bh=new et("Comp"),Nh=il.Flags.IsOnLoadCalled;let Lh=t("Component",(Ah=dc("cc.Component"),bh=Nc(),Th=Kc(xh),Eh=Lc(),Ah((Oh=Mh=class extends il{constructor(...t){super(...t),nc(this,"node",Ih,this),nc(this,"_enabled",Rh,this),nc(this,"__prefab",Dh,this),this._sceneGetter=null,this._id=Bh.getNewId()}get name(){if(this._name)return this._name;let t=dt(this);const e=t.lastIndexOf(".");return e>=0&&(t=t.slice(e+1)),this.node?`${this.node.name}<${t}>`:t}set name(t){this._name=t}get uuid(){return this._id}get __scriptAsset(){return null}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&(this._enabled=t,this.node.activeInHierarchy)){const e=l.director._compScheduler;t?e.enableComp(this):e.disableComp(this)}}get enabledInHierarchy(){return this._enabled&&this.node&&this.node.activeInHierarchy}get _isOnLoadCalled(){return this._objFlags&Nh}_getRenderScene(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene}addComponent(t){return this.node.addComponent(t)}getComponent(t){return this.node.getComponent(t)}getComponents(t){return this.node.getComponents(t)}getComponentInChildren(t){return this.node.getComponentInChildren(t)}getComponentsInChildren(t){return this.node.getComponentsInChildren(t)}destroy(){return!!super.destroy()&&(this._enabled&&this.node.activeInHierarchy&&l.director._compScheduler.disableComp(this),!0)}_onPreDestroy(){this.unscheduleAllCallbacks(),l.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}_instantiate(t){return t||(t=l.instantiate._clone(this,this)),t&&(t.node=null),t}schedule(t,e=0,i=l.macro.REPEAT_FOREVER,n=0){O(t,1619),O((e=e||0)>=0,1620),i=Number.isNaN(i)?l.macro.REPEAT_FOREVER:i,n=n||0;const s=l.director.getScheduler(),r=s.isTargetPaused(this);s.schedule(t,this,e,i,n,r)}scheduleOnce(t,e=0){this.schedule(t,0,0,e)}unschedule(t){t&&l.director.getScheduler().unschedule(t,this)}unscheduleAllCallbacks(){l.director.getScheduler().unscheduleAllForTarget(this)}},Mh.system=null,sc((wh=Oh).prototype,"__scriptAsset",[bh,Th,Eh,jc],Object.getOwnPropertyDescriptor(wh.prototype,"__scriptAsset"),wh.prototype),Ih=sc(wh.prototype,"node",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Rh=sc(wh.prototype,"_enabled",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Dh=sc(wh.prototype,"__prefab",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ph=wh))||Ph));const Fh=Lh.prototype;var zh,Vh,Gh;Fh.update=null,Fh.lateUpdate=null,Fh.__preload=null,Fh.onLoad=null,Fh.start=null,Fh.onEnable=null,Fh.onDisable=null,Fh.onDestroy=null,Fh.onFocusInEditor=null,Fh.onLostFocusInEditor=null,Fh.resetInEditor=null,Fh._getLocalBounds=null,Fh.onRestore=null,Lh._requireComponent=null,Lh._executionOrder=0,ct(Lh,"_registerEditorProps",((t,e)=>{let i=e.requireComponent;i&&(Array.isArray(i)&&(i=i.filter(Boolean)),t._requireComponent=i);const n=e.executionOrder;n&&"number"==typeof n&&(t._executionOrder=n)})),l.Component=Lh;let Uh,kh=t("MissingScript",dc("cc.MissingScript")(zh=Ic()((Gh=sc((Vh=class extends Lh{static safeFindClass(t){const e=Lt(t);if(e)return e;l.deserialize.reportMissingClass(t)}constructor(){super(),nc(this,"_$erialized",Gh,this)}onLoad(){I(4600,this.node.name)}}).prototype,"_$erialized",[Sc,Ac],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zh=Vh))||zh)||zh);l._MissingScript=kh;try{const t=kh.__values__;0!==t.length&&"_$erialized"===t[t.length-1]||(x("The '_$erialized' prop in MissingScript is missing. Please contact jare."),x(`    Error props: ['${t}']`))}catch(zr){x(`Error when checking MissingScript 5, ${zr}`)}!function(t){t[t.PORTRAIT=1]="PORTRAIT",t[t.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",t[t.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",t[t.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",t[t.LANDSCAPE=12]="LANDSCAPE",t[t.AUTO=13]="AUTO"}(Uh||(Uh={}));const Hh={0:Uh.PORTRAIT,"-90":Uh.LANDSCAPE_LEFT,90:Uh.LANDSCAPE_RIGHT,180:Uh.PORTRAIT_UPSIDE_DOWN},jh=new class extends Hl{get supportFullScreen(){return!1}get isFullScreen(){return!1}get devicePixelRatio(){return jsb.device.getDevicePixelRatio()||1}get windowSize(){const t=this.devicePixelRatio,e=Math.round(window.innerWidth),i=Math.round(window.innerHeight);return new Gi(e*t,i*t)}set windowSize(t){console.warn("Setting window size is not supported yet.")}get resolution(){const t=this.windowSize,e=this.resolutionScale;return new Gi(t.width*e,t.height*e)}get resolutionScale(){return this._resolutionScale}set resolutionScale(t){var e;t!==this._resolutionScale&&(this._resolutionScale=t,null===(e=this._cbToUpdateFrameBuffer)||void 0===e||e.call(this))}get orientation(){return Hh[jsb.device.getDeviceOrientation()]}set orientation(t){console.warn("Setting orientation is not supported yet.")}get safeAreaEdge(){const t=jsb.device.getSafeAreaEdge(),e=this.devicePixelRatio;let i=t.x*e,n=t.z*e,s=t.y*e,r=t.w*e;return this.orientation===Uh.PORTRAIT?i<n?i=n:n=i:s<r?s=r:r=s,{top:i,bottom:n,left:s,right:r}}get isProportionalToFrame(){return this._isProportionalToFrame}set isProportionalToFrame(t){}constructor(){super(),this.isFrameRotated=!1,this.handleResizeEvent=!0,this._cbToUpdateFrameBuffer=void 0,this._resolutionScale=1,this._isProportionalToFrame=!1,this._registerEvent()}init(t,e){this._cbToUpdateFrameBuffer=e,this._cbToUpdateFrameBuffer()}requestFullScreen(){return Promise.reject(new Error("request fullscreen has not been supported yet on this platform."))}exitFullScreen(){return Promise.reject(new Error("exit fullscreen has not been supported yet on this platform."))}_registerEvent(){jsb.onResize=t=>{0!==t.width&&0!==t.height&&(t.width/=this.devicePixelRatio,t.height/=this.devicePixelRatio,window.resize(t.width,t.height),this.emit("window-resize"))},jsb.onOrientationChanged=()=>{this.emit("orientation-change")}}},Wh=t("screen",new class{_init(t){jh.init(t,(()=>{var t;const e=l.director;(null===(t=e.root)||void 0===t?void 0:t.pipeline)?e.root.pipeline.pipelineSceneData.shadingScale=jh.resolutionScale:I(1220)}))}get devicePixelRatio(){return jh.devicePixelRatio}get windowSize(){return jh.windowSize}set windowSize(t){jh.windowSize=t}get resolution(){return jh.resolution}get supportsFullScreen(){return jh.supportFullScreen}fullScreen(){return jh.isFullScreen}requestFullScreen(t,e,i){return arguments.length>0&&I(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),jh.requestFullScreen().then((()=>{null==e||e()})).catch((t=>{console.error(t),null==i||i()}))}exitFullScreen(){return jh.exitFullScreen()}autoFullScreen(t,e){var i;null===(i=this.requestFullScreen(t,e))||void 0===i||i.catch((()=>{}))}disableAutoFullScreen(t){}});l.screen=Wh;const qh=t("sys",{Feature:Kl,hasFeature:t=>Zl.hasFeature(t),NetworkType:ql,Language:Wl,OS:Xl,Platform:Yl,BrowserType:jl,isNative:Zl.isNative,isBrowser:Zl.isBrowser,isMobile:Zl.isMobile,isLittleEndian:Zl.isLittleEndian,platform:Zl.platform,language:Zl.language,languageCode:Zl.nativeLanguage,os:Zl.os,osVersion:Zl.osVersion,osMainVersion:Zl.osMainVersion,browserType:Zl.browserType,browserVersion:Zl.browserVersion,windowPixelResolution:Wh.windowSize,capabilities:{canvas:!0,opengl:!0,webp:Zl.hasFeature(Kl.WEBP),imageBitmap:Zl.hasFeature(Kl.IMAGE_BITMAP),touches:Zl.hasFeature(Kl.INPUT_TOUCH),mouse:Zl.hasFeature(Kl.EVENT_MOUSE),keyboard:Zl.hasFeature(Kl.EVENT_KEYBOARD),accelerometer:Zl.hasFeature(Kl.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:()=>Zl.networkType,getBatteryLevel:()=>Zl.getBatteryLevel(),garbageCollect(){Zl.triggerGC()},isObjectValid:t=>null!=t,dump(){let t="";t+=`isMobile : ${this.isMobile}\r\n`,t+=`language : ${this.language}\r\n`,t+=`browserType : ${this.browserType}\r\n`,t+=`browserVersion : ${this.browserVersion}\r\n`,t+=`capabilities : ${JSON.stringify(this.capabilities)}\r\n`,t+=`os : ${this.os}\r\n`,t+=`osVersion : ${this.osVersion}\r\n`,t+=`platform : ${this.platform}\r\n`,t+=`Using ${l.game.renderType===l.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS"} renderer.\r\n`,v(t)},openURL(t){Zl.openURL(t)},now:()=>Zl.now(),restartVM(){Zl.restartJSVM()},getSafeAreaRect(){const t=l.view,e=jh.safeAreaEdge,i=jh.windowSize,n=new Oi(e.left,e.bottom),s=new Oi(i.width-e.right,i.height-e.top);t._convertToUISpace(n),t._convertToUISpace(s);const r=n.x,o=n.y,a=s.x-n.x,c=s.y-n.y;return new ki(r,o,a,c)}});!function(){try{let t=qh.localStorage=window.localStorage;t.setItem("storage",""),t.removeItem("storage"),t=null}catch(t){const e=function(){I(5200)};qh.localStorage={getItem:e,setItem:e,clear:e,removeItem:e}}qh.__isWebIOS14OrIPadOS14Env=(qh.os===Xl.IOS||qh.os===Xl.OSX)&&Zl.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),l.sys=qh;const Xh=t("serializeTag",Symbol("[[Serialize]]")),Yh=t("deserializeTag",Symbol("[[Deserialize]]"));class Kh{constructor(t,e){this._document=void 0,this._chunks=void 0,this._document=t,this._chunks=e}get document(){return this._document}get chunks(){return this._chunks}}function Jh(t){const e=t;return{chunks:e.chunks,document:e.document}}function $h(t){if(t.length<16)throw new Zh(N(13102));const e=new DataView(t.buffer,t.byteOffset,t.byteLength);if(1313817411!==e.getUint32(0,!0))throw new Zh(N(13100));const i=e.getUint32(4,!0);if(1!==i)throw new Zh(N(13101,i));if(e.getUint32(8,!0)!==e.byteLength)throw new Zh(N(13102));let n=12;const s=e.getUint32(n,!0);n+=4;const r=new Uint8Array(e.buffer,n+e.byteOffset,s);n+=s;const o=function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);if("Buffer"in globalThis){const{Buffer:e}=globalThis;return e.from(t.buffer,t.byteOffset,t.byteLength).toString()}throw new Error(N(13104))}(r);let a;try{a=JSON.parse(o)}catch(t){throw new Zh(t)}const c=[];for(;n<e.byteLength;){n%8!=0&&(n+=8-n%8);const t=e.getUint32(n,!0);n+=4,c.push(new Uint8Array(e.buffer,n+e.byteOffset,t)),n+=t}if(n!==e.byteLength)throw new Zh(N(13102));return new Kh(a,c)}class Zh extends Error{}function Qh(t,e,i,n,s){if(e instanceof l.ValueType){s||t.push("if(prop){");const n=dt(e);t.push(`s._deserializeFastDefinedObject(o${i},prop,${n});`),s||t.push(`}else o${i}=null;`)}else t.push(`\nif (prop) {\n    s._deserializeAndAssignField(o, prop, ${n});\n} else {\n    o${i}=null;\n}\n`)}l.internal.parseCCONJson=Jh,l.internal.decodeCCONBinary=$h,l.internal.CCON=Kh;const t_="$_$type",e_="$_$default",i_="$_$formerlySerializedAs";class n_{constructor(t,e,i,n,s){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=t,this.customEnv=n,this.deserializedList=[],this.deserializedData=null,this._classFinder=e,this._reportMissingClass=i,this._onDereferenced=null==e?void 0:e.onDereferenced}reset(t,e,i,n,s){this.result=t,this.customEnv=n,this._classFinder=e,this._reportMissingClass=i,this._onDereferenced=null==e?void 0:e.onDereferenced}clear(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null}deserialize(t){let e,i=!1;t instanceof Kh?(i=!0,e=t.document,t.chunks.length>0&&(t.chunks.length,this._mainBinChunk=t.chunks[0])):e=t,this._serializedData=e,this._context={fromCCON:i};const n=Array.isArray(e)?e[0]:e;return this.deserializedData=this._deserializeObject(n,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData}_deserializeObject(t,e,i,n){switch(t.__type__){case"TypedArray":return this._deserializeTypedArrayView(t);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(t);default:return t.__type__?this._deserializeTypeTaggedObject(t,e,i,n):Array.isArray(t)?this._deserializeArray(t):this._deserializePlainObject(t)}}_deserializeTypedArrayView(t){return globalThis[t.ctor].from(t.array)}_deserializeTypedArrayViewRef(t){const{offset:e,length:i,ctor:n}=t;return new globalThis[n](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+e,i)}_deserializeArray(t){const e=new Array(t.length);let i;for(let n=0;n<t.length;n++)i=t[n],"object"==typeof i&&i?this._deserializeAndAssignField(e,i,`${n}`)&&(e[n]=null):e[n]=i;return e}_deserializePlainObject(t){const e={};return this._fillPlainObject(e,t),e}_deserializeTypeTaggedObject(t,e,i,n){const s=t.__type__,r=this._classFinder(s,t,i,n);if(!r)return this._classFinder===Lt&&this._reportMissingClass(s),null;{const i=(t=>{const i=new t;return e>=0&&(this.deserializedList[e]=i),i})(r);return this._deserializeInto(t,i,r),i}}_deserializeInto(t,e,i,n=!1){n||!e[Yh]?e._deserialize?e._deserialize(t.content,this):l.Class._isCCClass(i)?this._deserializeFireClass(e,t,i):this._deserializeFastDefinedObject(e,t,i):this._runCustomizedDeserialize(t,e,i)}_runCustomizedDeserialize(t,e,i){const n={readProperty:e=>{const i=t[e];return"object"==typeof i&&i?this._deserializeObjectField(i):i},readThis:()=>{this._deserializeInto(t,e,i,!0)},readSuper:()=>{const n=Tt(i);n&&this._deserializeInto(t,e,n)}};e[Yh](n,this._context)}_deserializeFireClass(t,e,i){let n;if(i.hasOwnProperty("__deserialize__"))n=i.__deserialize__;else{n=function(t,e){const i=ue(e),n=e.__values__,s=["var prop;"],r=Jt.test(zt(e));for(let t=0;t<n.length;t++){const e=n[t];let o,a;Le.IDENTIFIER_RE.test(e)?(a=`"${e}"`,o=`.${e}`):(a=Le.escapeForJS(e),o=`[${a}]`);let c=o;if(i[e+i_]){const t=i[e+i_];c=Le.IDENTIFIER_RE.test(t)?`.${t}`:`[${Le.escapeForJS(t)}]`}s.push(`prop=d${c};`),s.push('if(typeof (prop)!=="undefined"){');const l=Le.getDefault(i[e+e_]);if(r){let t;const n=i[e+t_];if(void 0===l&&n)t=n instanceof me;else{const e=typeof l;t="string"===e||"number"===e||"boolean"===e}t?s.push(`o${o}=prop;`):Qh(s,l,o,a,!0)}else s.push(`if(typeof (prop)!=="object"){o${o}=prop;}else{`),Qh(s,l,o,a,!1),s.push("}");s.push("}")}return(l.js.isChildClassOf(e,l._BaseNode)||l.js.isChildClassOf(e,l.Component))&&s.push("d._id&&(o._id=d._id);"),"_$erialized"===n[n.length-1]&&(s.push("o._$erialized=JSON.parse(JSON.stringify(d));"),s.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",s.join(""))}(0,i);try{if(i===kh){const t=i.__values__;0!==t.length&&"_$erialized"===t[t.length-1]||(x("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),x(`    Error props: ['${t}']. Please contact jare.`));const e=n;n=function(t,i,n,s){e(t,i,n,s),i._$erialized||x(`Unable to stash previously serialized data. ${JSON.stringify(n)}`)}}}catch(t){x(`Error when checking MissingScript 6, ${t}`)}ct(i,"__deserialize__",n,!0)}n(this,t,e,i)}_deserializeAndAssignField(t,e,i){const n=e.__id__;if("number"==typeof n){const e=this.deserializedList[n];if(e)t[i]=e;else{var s;const e=this._serializedData[n];t[i]=this._deserializeObject(e,n,void 0,i),null===(s=this._onDereferenced)||void 0===s||s.call(this,this.deserializedList,n,t,i)}}else{const n=e.__uuid__;if(n){const s=e.__expectedType__;this.result.push(t,i,n,s)}else t[i]=this._deserializeObject(e,-1)}return!1}_deserializeObjectField(t){const e=t.__id__;if("number"==typeof e){const t=this.deserializedList[e];if(t)return t;{const t=this._serializedData[e];return this._deserializeObject(t,e,void 0,void 0)}}if(t.__uuid__)throw t.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(t,-1)}_fillPlainObject(t,e){for(const i in e){if(!e.hasOwnProperty(i))continue;const n=e[i];"object"!=typeof n?"__type__"!==i&&(t[i]=n):n?this._deserializeAndAssignField(t,n,i)&&(t[i]=null):t[i]=null}}_deserializeFastDefinedObject(t,e,i){if(i===l.Vec2)return t.x=e.x||0,void(t.y=e.y||0);if(i===l.Vec3)return t.x=e.x||0,t.y=e.y||0,void(t.z=e.z||0);if(i===l.Color){t.r=e.r||0,t.g=e.g||0,t.b=e.b||0;const i=e.a;return void(t.a=void 0===i?255:i)}if(i===l.Size)return t.width=e.width||0,void(t.height=e.height||0);const n=ue(i),s=i.__values__;for(let i=0;i<s.length;i++){const r=s[i];let o=e[r];void 0!==o||e.hasOwnProperty(r)||(o=Le.getDefault(n[r+e_])),"object"!=typeof o?t[r]=o:o?this._deserializeAndAssignField(t,o,r):t[r]=null}}}n_.pool=new class extends Vt{constructor(){super((t=>{t.clear()}),1)}get(t,e,i,n,s){const r=this._get();return r?(r.reset(t,e,i,n,s),r):new n_(t,e,i,n,s)}};const s_=[Oi,mi,Fi,Si,hi,Gi,ki,Ii];function r_(t,e){t.x=e[1],t.y=e[2],t.z=e[3],t.w=e[4]}const o_=[(t,e)=>{t.x=e[1],t.y=e[2]},(t,e)=>{t.x=e[1],t.y=e[2],t.z=e[3]},r_,r_,(t,e)=>{t._val=e[1]},(t,e)=>{t.width=e[1],t.height=e[2]},(t,e)=>{t.x=e[1],t.y=e[2],t.width=e[3],t.height=e[4]},(t,e)=>{Ii.fromArray(t,e,1)}];class a_{constructor(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}init(t){t?(this.uuidObjList=t[8],this.uuidPropList=t[9],this.uuidList=t[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])}reset(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)}push(t,e,i,n){this.uuidObjList.push(t),this.uuidPropList.push(e),this.uuidList.push(i),this.uuidTypeList.push(n||"")}}function c_(t,e){const i=t[4][e[0]],n=i[0],s=new(0,n[0]),r=n[1],o=n[2],a=i[i.length-1];let c=1;for(;c<a;++c)s[r[i[c]]]=e[c];for(;c<e.length;++c){const a=r[i[c]],l=n[i[c]+o];(0,m_[l])(t,s,a,e[c])}return s}function l_(t,e,i){const n=new e;return n._deserialize?n._deserialize(i,t[0]):D(5303,dt(e)),n}function h_(t,e,i,n){n>=0?e[i]=t[5][n]:t[7][3*~n]=e}function __(t){return(e,i,n,s)=>{i[n]=s;for(let i=0;i<s.length;++i)t(e,s,i,s[i])}}function u_(t,e,i,n){e[i]=null,t[8][n]=e}function d_(t,e,i,n){e[i]=c_(t,n)}t("Details",a_),a_.pool=new Vt((t=>{t.reset()}),5),a_.pool.get=function(){return this._get()||new a_};const m_=new Array(13);function p_(t,e,i){return t||i(e),Object}function f_(t,e,i,n,s,r,o){let a=t(e);if(!a){if(s)return void(i[n]=(c=i,l=n,h=e,function(){const e=t(h)||p_(r,h,o);return c[l]=e,new e}));a=p_(r,e,o)}var c,l,h;i[n]=a}function g_(t,e,i,n){const s=i||Lt,r=t[3];for(let t=0;t<r.length;++t){const o=r[t];"string"!=typeof o?f_(s,o[0],o,0,e,i,n):f_(s,o,r,t,e,i,n)}}function v_(t){const e=t[4];if(e){const i=t[3];for(let t=0;t<e.length;++t){const n=e[t];n[0]=i[n[0]]}}}function y_(t,e,i){"string"==typeof t&&(t=JSON.parse(t));const n=!e;let s;if(e=e||a_.pool.get(),function(t){if(Array.isArray(t)){const e=t[0];return"number"==typeof e||e instanceof x_}return!1}(t)){e.init(t),i=i||{};let n=t[0],o=!1;if("object"==typeof n&&(o=n.preprocessed,n=n.version),n<1)throw new Error(N(5304,n));var r;i._version=n,i.result=e,t[0]=i,o||(g_(t,!1,i.classFinder,null!==(r=i.reportMissingClass)&&void 0!==r?r:y_.reportMissingClass),v_(t)),l.game._isCloning=!0;const a=t[5],c=function(t){const e=t[5],i=t[6],n=0===i?0:i.length;let s=e[e.length-1],r=e.length-n;"number"!=typeof s?s=0:(s<0&&(s=~s),--r);let o=0;for(;o<r;++o)e[o]=c_(t,e[o]);const a=t[3];for(let s=0;s<n;++s,++o){let n=i[s];const r=e[o];if(n>=0){const i=a[n];e[o]=l_(t,i,r)}else n=~n,(0,m_[n])(t,e,o,r)}return s}(t);l.game._isCloning=!1,t[7]&&function(t,e,i){const n=t.length-1;let s=0;const r=3*t[n];for(;s<r;s+=3){const n=t[s],r=e[t[s+2]],o=t[s+1];o>=0?n[i[o]]=r:n[~o]=r}for(;s<n;s+=3){const n=e[t[s]],r=e[t[s+2]],o=t[s+1];o>=0?n[i[o]]=r:n[~o]=r}}(t[7],a,t[2]),function(t){const e=t[5],i=t[2],n=t[1],s=t[8],r=t[9],o=t[10];for(let t=0;t<s.length;++t){const a=s[t];"number"==typeof a&&(s[t]=e[a]);let c=r[t];"number"==typeof c&&(c=c>=0?i[c]:~c,r[t]=c);const l=o[t];"number"==typeof l&&(o[t]=n[l])}}(t),s=a[c]}else s=function(t,e,i){var n;const s=(i=i||{}).classFinder||Lt,r=i.createAssetRefs||qh.platform===Yl.EDITOR_CORE,o=i.customEnv,a=i.ignoreEditorOnly,c=null!==(n=i.reportMissingClass)&&void 0!==n?n:l.deserialize.reportMissingClass;e.init();const h=n_.pool.get(e,s,c,o,a);l.game._isCloning=!0;const _=h.deserialize(t);return l.game._isCloning=!1,n_.pool.put(h),r&&e.assignAssetsBy(EditorExtends.serialize.asAsset),_}(t,e,i);return n&&a_.pool.put(e),s}m_[0]=function(t,e,i,n){e[i]=n},m_[1]=h_,m_[2]=__(h_),m_[3]=__(u_),m_[4]=d_,m_[5]=function(t,e,i,n){o_[n[0]](e[i],n)},m_[6]=u_,m_[7]=function(t,e,i,n){e[i].set(n)},m_[8]=function(t,e,i,n){const s=new s_[n[0]];o_[n[0]](s,n),e[i]=s},m_[9]=__(d_),m_[10]=function(t,e,i,n){const s=t[3][n[0]];e[i]=l_(t,s,n[1])},m_[11]=function(t,e,i,n){const s=n[0];e[i]=s;for(let e=1;e<n.length;e+=3){const i=n[e],r=n[e+1],o=n[e+2];(0,m_[r])(t,s,i,o)}},m_[12]=function(t,e,i,n){const s=n[0];e[i]=s;for(let e=0;e<s.length;++e){const i=s[e],r=n[e+1];0!==r&&(0,m_[r])(t,s,e,i)}},y_.Details=a_,y_.reportMissingClass=function(t){D(5302,t)};class x_{constructor(t){this.preprocessed=!0,this.version=t}}function S_(t,e,i){return[1,0,0,[t],0,i?[e,-1]:[e],[0],0,[],[],[]]}l.deserialize=y_;const C_=il.Flags.Destroyed,A_=il.Flags.PersistentMask,b_=[];function T_(t){let e;if(t instanceof il){if(t._instantiate)return l.game._isCloning=!0,e=t._instantiate(null,!0),l.game._isCloning=!1,e;if(t instanceof l.Asset)throw new TypeError(N(6903))}return l.game._isCloning=!0,e=E_(t),l.game._isCloning=!1,e}function E_(t,e){let i;i=t._iN$t?t._iN$t:t.constructor?new(0,t.constructor):Object.create(null),P_(t,i,e);for(let t=0,e=b_.length;t<e;++t)b_[t]._iN$t=null;return b_.length=0,i}function P_(t,e,i){Ut.value(t,"_iN$t",e,!0),b_.push(t);const n=t.constructor;if(Fe(n))!function(t,e,i,n){const s=t.__values__;for(let t=0;t<s.length;t++){const r=s[t],o=e[r];if("object"==typeof o&&o){const t=i[r];t instanceof Yt&&t.constructor===o.constructor?t.set(o):i[r]=o._iN$t||w_(o,n)}else i[r]=o}}(n,t,e,i);else for(const n in t){if(!t.hasOwnProperty(n)||95===n.charCodeAt(0)&&95===n.charCodeAt(1)&&"__type__"!==n&&"__prefab"!==n)continue;const s=t[n];if("object"==typeof s&&s){if(s===e)continue;e[n]=s._iN$t||w_(s,i)}else e[n]=s}t instanceof il&&(e._objFlags&=A_)}function w_(t,e){if(t instanceof Yt)return t.clone();if(t instanceof l.Asset)return t;let i;if(ArrayBuffer.isView(t)){const e=t.length;i=new t.constructor(e),t._iN$t=i,b_.push(t);for(let n=0;n<e;++n)i[n]=t[n];return i}if(Array.isArray(t)){const n=t.length;i=new Array(n),t._iN$t=i,b_.push(t);for(let s=0;s<n;++s){const n=t[s];i[s]="object"==typeof n&&n?n._iN$t||w_(n,e):n}return i}if(t._objFlags&C_)return null;const n=t.constructor;if(Fe(n)){if(e)if(e instanceof l.Component){if(t instanceof l._BaseNode||t instanceof l.Component)return t}else if(e instanceof l._BaseNode)if(t instanceof l._BaseNode){if(!t.isChildOf(e))return t}else if(t instanceof l.Component&&t.node&&!t.node.isChildOf(e))return t;i=new n}else if(n===Object)i={};else{if(n)return t;i=Object.create(null)}return P_(t,i,e),i}var I_,R_,D_,M_,O_,B_,N_,L_;let F_,z_;function V_(t,e){return(e<<3)+t}function G_(t){return k_[t]}function U_(t){switch(t){case F_.Uint8:return Uint8Array;case F_.Uint16:return Uint16Array;case F_.Uint32:return Uint32Array;case F_.Int8:return Int8Array;case F_.Int16:return Int16Array;case F_.Int32:return Int32Array;case F_.Float32:return Float32Array;case F_.Float64:return Float64Array}}T_._clone=E_,l.instantiate=T_,function(t){t[t.Uint8=0]="Uint8",t[t.Uint16=1]="Uint16",t[t.Uint32=2]="Uint32",t[t.Int8=3]="Int8",t[t.Int16=4]="Int16",t[t.Int32=5]="Int32",t[t.Float32=6]="Float32",t[t.Float64=7]="Float64"}(F_||(F_={})),function(t){t[t.Scalar=0]="Scalar",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Quat=4]="Quat",t[t.Mat4=5]="Mat4"}(z_||(z_={})),t("CompactValueTypeArray",dc("cc.CompactValueTypeArray")((L_=N_=class t{constructor(){nc(this,"_byteOffset",D_,this),nc(this,"_unitCount",M_,this),nc(this,"_unitElement",O_,this),nc(this,"_length",B_,this)}static lengthFor(t,e,i){return G_(e).requiredUnits*t.length*U_(i).BYTES_PER_ELEMENT}static compress(e,i,n,s,r,o){const a=G_(i),c=U_(n),l=a.requiredUnits*e.length,h=new c(s,r,l);for(let t=0;t<e.length;++t)a.compress(h,t,e[t]);const _=new t;return _._unitElement=V_(n,i),_._byteOffset=o,_._unitCount=l,_._length=e.length,_}decompress(t){const{storageUnit:e,elementType:i}={storageUnit:7&(n=this._unitElement),elementType:n>>3};var n;const s=G_(i),r=new(U_(e))(t,this._byteOffset,this._unitCount),o=new Array(this._length);for(let t=0;t<this._length;++t)o[t]=s.decompress(r,t);return o}},N_.StorageUnit=F_,N_.ElementType=z_,D_=sc((R_=L_).prototype,"_byteOffset",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),M_=sc(R_.prototype,"_unitCount",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),O_=sc(R_.prototype,"_unitElement",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return V_(F_.Uint8,z_.Scalar)}}),B_=sc(R_.prototype,"_length",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),I_=R_))||I_);const k_={[z_.Scalar]:{requiredUnits:1,compress(t,e,i){t[e]=i},decompress:(t,e)=>t[e]},[z_.Vec2]:{requiredUnits:2,compress(t,e,i){t[2*e]=i.x,t[2*e+1]=i.y},decompress:(t,e)=>new mi(t[2*e],t[2*e+1])},[z_.Vec3]:{requiredUnits:3,compress(t,e,i){t[3*e]=i.x,t[3*e+1]=i.y,t[3*e+2]=i.z},decompress:(t,e)=>new mi(t[3*e],t[3*e+1],t[3*e+2])},[z_.Vec4]:{requiredUnits:4,compress(t,e,i){t[4*e]=i.x,t[4*e+1]=i.y,t[4*e+2]=i.z,t[4*e+3]=i.w},decompress:(t,e)=>new Fi(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])},[z_.Quat]:{requiredUnits:4,compress(t,e,i){t[4*e]=i.x,t[4*e+1]=i.y,t[4*e+2]=i.z,t[4*e+3]=i.w},decompress:(t,e)=>new Si(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])},[z_.Mat4]:{requiredUnits:16,compress(t,e,i){Ii.toArray(t,i,16*e)},decompress:(t,e)=>Ii.fromArray(new Ii,t,16*e)}};function H_(){return 0}function j_(t){return t}function W_(t){return t*t}function q_(t){return t*(2-t)}function X_(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}function Y_(t){return t*t*t}function K_(t){return--t*t*t+1}function J_(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}function $_(t){return t*t*t*t}function Z_(t){return 1- --t*t*t*t}function Q_(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}function tu(t){return t*t*t*t*t}function eu(t){return--t*t*t*t*t+1}function iu(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}function nu(t){return 1===t?1:1-Math.cos(t*Math.PI/2)}function su(t){return Math.sin(t*Math.PI/2)}function ru(t){return.5*(1-Math.cos(Math.PI*t))}function ou(t){return 0===t?0:Math.pow(1024,t-1)}function au(t){return 1===t?1:1-Math.pow(2,-10*t)}function cu(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}function lu(t){return 1-Math.sqrt(1-t*t)}function hu(t){return Math.sqrt(1- --t*t)}function _u(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}function uu(t){let e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4))}function du(t){let e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/.4)+1)}function mu(t){let e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),(t*=2)<1?i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*-.5:i*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*.5+1)}function pu(t){if(1===t)return 1;const e=1.70158;return t*t*((e+1)*t-e)}function fu(t){if(0===t)return 0;const e=1.70158;return--t*t*((e+1)*t+e)+1}function gu(t){const e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}function vu(t){return 1-yu(1-t)}function yu(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}function xu(t){return t<.5?.5*vu(2*t):.5*yu(2*t-1)+.5}function Su(t){return t<=0?0:t>=1?1:t*t*(3-2*t)}function Cu(t){return t<=0?0:t>=1?1:t*t*t*(t*(6*t-15)+10)}l._decorator=Qc;const Au=Ou(W_,q_),bu=Ou(Y_,K_),Tu=Ou($_,Z_),Eu=Ou(tu,eu),Pu=Ou(nu,su),wu=Ou(ou,au),Iu=Ou(lu,hu),Ru=Ou(uu,du),Du=Ou(pu,fu),Mu=Ou(vu,yu);function Ou(t,e){return i=>i<.5?e(2*i)/2:t(2*i-1)/2+.5}var Bu=Object.freeze({__proto__:null,constant:H_,linear:j_,quadIn:W_,quadOut:q_,quadInOut:X_,cubicIn:Y_,cubicOut:K_,cubicInOut:J_,quartIn:$_,quartOut:Z_,quartInOut:Q_,quintIn:tu,quintOut:eu,quintInOut:iu,sineIn:nu,sineOut:su,sineInOut:ru,expoIn:ou,expoOut:au,expoInOut:cu,circIn:lu,circOut:hu,circInOut:_u,elasticIn:uu,elasticOut:du,elasticInOut:mu,backIn:pu,backOut:fu,backInOut:gu,bounceIn:vu,bounceOut:yu,bounceInOut:xu,smooth:Su,fade:Cu,quadOutIn:Au,cubicOutIn:bu,quartOutIn:Tu,quintOutIn:Eu,sineOutIn:Pu,expoOutIn:wu,circOutIn:Iu,elasticOutIn:Ru,backOutIn:Du,bounceOutIn:Mu});let Nu;t("easing",Bu),function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.QUAD_IN=2]="QUAD_IN",t[t.QUAD_OUT=3]="QUAD_OUT",t[t.QUAD_IN_OUT=4]="QUAD_IN_OUT",t[t.QUAD_OUT_IN=5]="QUAD_OUT_IN",t[t.CUBIC_IN=6]="CUBIC_IN",t[t.CUBIC_OUT=7]="CUBIC_OUT",t[t.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",t[t.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",t[t.QUART_IN=10]="QUART_IN",t[t.QUART_OUT=11]="QUART_OUT",t[t.QUART_IN_OUT=12]="QUART_IN_OUT",t[t.QUART_OUT_IN=13]="QUART_OUT_IN",t[t.QUINT_IN=14]="QUINT_IN",t[t.QUINT_OUT=15]="QUINT_OUT",t[t.QUINT_IN_OUT=16]="QUINT_IN_OUT",t[t.QUINT_OUT_IN=17]="QUINT_OUT_IN",t[t.SINE_IN=18]="SINE_IN",t[t.SINE_OUT=19]="SINE_OUT",t[t.SINE_IN_OUT=20]="SINE_IN_OUT",t[t.SINE_OUT_IN=21]="SINE_OUT_IN",t[t.EXPO_IN=22]="EXPO_IN",t[t.EXPO_OUT=23]="EXPO_OUT",t[t.EXPO_IN_OUT=24]="EXPO_IN_OUT",t[t.EXPO_OUT_IN=25]="EXPO_OUT_IN",t[t.CIRC_IN=26]="CIRC_IN",t[t.CIRC_OUT=27]="CIRC_OUT",t[t.CIRC_IN_OUT=28]="CIRC_IN_OUT",t[t.CIRC_OUT_IN=29]="CIRC_OUT_IN",t[t.ELASTIC_IN=30]="ELASTIC_IN",t[t.ELASTIC_OUT=31]="ELASTIC_OUT",t[t.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",t[t.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",t[t.BACK_IN=34]="BACK_IN",t[t.BACK_OUT=35]="BACK_OUT",t[t.BACK_IN_OUT=36]="BACK_IN_OUT",t[t.BACK_OUT_IN=37]="BACK_OUT_IN",t[t.BOUNCE_IN=38]="BOUNCE_IN",t[t.BOUNCE_OUT=39]="BOUNCE_OUT",t[t.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",t[t.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",t[t.SMOOTH=42]="SMOOTH",t[t.FADE=43]="FADE"}(Nu||(Nu={}));const Lu={[Nu.CONSTANT]:H_,[Nu.LINEAR]:j_,[Nu.QUAD_IN]:W_,[Nu.QUAD_OUT]:q_,[Nu.QUAD_IN_OUT]:X_,[Nu.QUAD_OUT_IN]:Au,[Nu.CUBIC_IN]:Y_,[Nu.CUBIC_OUT]:K_,[Nu.CUBIC_IN_OUT]:J_,[Nu.CUBIC_OUT_IN]:bu,[Nu.QUART_IN]:$_,[Nu.QUART_OUT]:Z_,[Nu.QUART_IN_OUT]:Q_,[Nu.QUART_OUT_IN]:Tu,[Nu.QUINT_IN]:tu,[Nu.QUINT_OUT]:eu,[Nu.QUINT_IN_OUT]:iu,[Nu.QUINT_OUT_IN]:Eu,[Nu.SINE_IN]:nu,[Nu.SINE_OUT]:su,[Nu.SINE_IN_OUT]:ru,[Nu.SINE_OUT_IN]:Pu,[Nu.EXPO_IN]:ou,[Nu.EXPO_OUT]:au,[Nu.EXPO_IN_OUT]:cu,[Nu.EXPO_OUT_IN]:wu,[Nu.CIRC_IN]:lu,[Nu.CIRC_OUT]:hu,[Nu.CIRC_IN_OUT]:_u,[Nu.CIRC_OUT_IN]:Iu,[Nu.ELASTIC_IN]:uu,[Nu.ELASTIC_OUT]:du,[Nu.ELASTIC_IN_OUT]:mu,[Nu.ELASTIC_OUT_IN]:Ru,[Nu.BACK_IN]:pu,[Nu.BACK_OUT]:fu,[Nu.BACK_IN_OUT]:gu,[Nu.BACK_OUT_IN]:Du,[Nu.BOUNCE_IN]:vu,[Nu.BOUNCE_OUT]:yu,[Nu.BOUNCE_IN_OUT]:xu,[Nu.BOUNCE_OUT_IN]:Mu,[Nu.SMOOTH]:Su,[Nu.FADE]:Cu};function Fu(t){return Lu[t]}n(255),n(65280);const zu=Ja.LINEAR<<0|Za.NONE<<8|Nu.LINEAR<<16;class Vu extends Zc{constructor(...t){super(...t),this.value=0,this.rightTangent=0,this.rightTangentWeight=0,this.leftTangent=0,this.leftTangentWeight=0,this._flags=zu}get interpolationMode(){return(255&this._flags)>>0}set interpolationMode(t){this._flags&=-256,this._flags|=t<<0}get tangentWeightMode(){return(65280&this._flags)>>8}set tangentWeightMode(t){this._flags&=-65281,this._flags|=t<<8}get easingMethod(){return(16711680&this._flags)>>16}set easingMethod(t){this._flags&=-16711681,this._flags|=t<<16}}var Gu,Uu,ku,Hu;function ju(t){const e=new Vu;if("number"==typeof t)e.value=t;else{const{interpolationMode:i,tangentWeightMode:n,value:s,rightTangent:r,rightTangentWeight:o,leftTangent:a,leftTangentWeight:c,easingMethod:l,[$c]:h}=t;e.value=null!=s?s:e.value,e.rightTangent=null!=r?r:e.rightTangent,e.rightTangentWeight=null!=o?o:e.rightTangentWeight,e.leftTangent=null!=a?a:e.leftTangent,e.leftTangentWeight=null!=c?c:e.leftTangentWeight,e.interpolationMode=null!=i?i:e.interpolationMode,e.tangentWeightMode=null!=n?n:e.tangentWeightMode,e.easingMethod=null!=l?l:e.easingMethod,h&&(e[$c]=h)}return e}Le.fastDefine("cc.RealKeyframeValue",Vu,{interpolationMode:Ja.LINEAR,tangentWeightMode:Za.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:Nu.LINEAR,[$c]:void 0}),Le.Attr.setClassAttr(Vu,$c,"editorOnly",!0),(Gu=Vu,null!==(ku=(Uu=Gu)[xc])&&void 0!==ku?ku:Uu[xc]={}).uniquelyReferenced=!0;class Wu extends ec{constructor(...t){super(...t),this.preExtrapolation=$a.CLAMP,this.postExtrapolation=$a.CLAMP}evaluate(t){const{_times:e,_values:i}=this,n=e.length;if(0===n)return 0;const s=e[0],r=e[n-1];if(t<s){const{preExtrapolation:o}=this,a=i[0];if(o===$a.CLAMP||n<2)return a.value;switch(o){case $a.LINEAR:return od(s,i[0].value,e[1],i[1].value,t);case $a.LOOP:t=sd(t,s,r);break;case $a.PING_PONG:t=rd(t,s,r);break;default:return a.value}}else if(t>r){const{postExtrapolation:o}=this,a=i[n-1];if(o===$a.CLAMP||n<2)return a.value;switch(o){case $a.LINEAR:return od(r,a.value,e[n-2],i[n-2].value,t);case $a.LOOP:t=sd(t,s,r);break;case $a.PING_PONG:t=rd(t,s,r);break;default:return a.value}}const o=tc(e,t);if(o>=0)return i[o].value;const a=~o,c=a-1,l=e[c],h=i[c],_=e[a];return function(t,e,i,n,s){const r=i-t;switch(e.interpolationMode){default:case Ja.CONSTANT:return e.value;case Ja.LINEAR:{const t=e.easingMethod===Nu.LINEAR?s:Fu(e.easingMethod)(s);return Xe(e.value,n.value,t)}case Ja.CUBIC:{const o=1/3,{rightTangent:a,rightTangentWeight:c}=e,l=0!=(e.tangentWeightMode&Za.RIGHT),{leftTangent:h,leftTangentWeight:_}=n,u=0!=(n.tangentWeightMode&Za.LEFT);if(l||u){let d=0;if(l)d=c;else{const t=r,e=r*a;d=Math.sqrt(t*t+e*e)*o}const m=Math.atan(a),p=Math.cos(m)*d+t,f=Math.sin(m)*d+e.value;let g=0;if(u)g=_;else{const t=r,e=r*h;g=Math.sqrt(t*t+e*e)*o}const v=Math.atan(h),y=(p-t)/r,x=(-Math.cos(v)*g+i-t)/r,S=f,C=-Math.sin(v)*g+n.value,A=[0,0,0],b=function(t,e,i,n,s){const r=i/n,o=e/n,a=r*r,c=1/3*(-1/3*a+o),l=.5*(2/27*r*a-1/3*r*o+t/n),h=c*c*c,_=l*l+h;let u=0;if(ic(_)){if(ic(l))return s[0]=0,1;{const t=Math.cbrt(-l);return s[0]=2*t,s[1]=-t,2}}if(_<0){const t=1/3*Math.acos(-l/Math.sqrt(-h)),e=2*Math.sqrt(-c);s[0]=e*Math.cos(t),s[1]=-e*Math.cos(t+Math.PI/3),s[2]=-e*Math.cos(t-Math.PI/3),u=3}else{const t=Math.sqrt(_),e=Math.cbrt(t-l),i=-Math.cbrt(t+l);s[0]=e+i,u=1}const d=1/3*r;for(let t=0;t<u;++t)s[t]-=d;return u}(0-s,3*y,3*x-6*y,3*(y-x)+1,A),T=function(t,e,i){let n=i;if(1===e)n=t[0];else{n=-1/0;for(let i=0;i<e;++i){const e=t[i];e>=0&&e<=1&&e>n&&(n=e)}n===-1/0&&(n=0)}return n}(A,b,s);return ad(e.value,S,C,n.value,T)}{const t=e.value+o*a*r,i=n.value-o*h*r;return ad(e.value,t,i,n.value,s)}}}}(l,h,_,i[a],(t-l)/(_-l))}addKeyFrame(t,e){return super.addKeyFrame(t,ju(e))}assignSorted(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((t=>ju(t))));else{const e=Array.from(t);this.setKeyframes(e.map((([t])=>t)),e.map((([,t])=>ju(t))))}}isConstant(t){if(this._values.length<=1)return!0;const e=this._values[0].value;return this._values.every((i=>je(i.value,e,t)))}[Xh](t,e){if(!e.toCCON)return void t.writeThis();const{_times:i,_values:n}=this,s=i.length,r=new DataView(new ArrayBuffer(0+qu+qu+Xu+Yu*s+ed*s));let o=0;r.setUint8(o,this.preExtrapolation),o+=qu,r.setUint8(o,this.postExtrapolation),o+=qu,r.setUint32(o,s,!0),o+=Xu,i.forEach(((t,e)=>r.setFloat32(o+Yu*e,t,!0))),o+=Yu*s;for(const t of n)o=id(r,t,o);const a=new Uint8Array(r.buffer,0,o);t.writeProperty("bytes",a);const c=n.map((t=>t[$c]));c.some((t=>void 0!==t))&&t.writeProperty("keyframeValueEditorExtras",c)}[Yh](t,e){if(!e.fromCCON)return void t.readThis();const i=t.readProperty("bytes"),n=new DataView(i.buffer,i.byteOffset,i.byteLength);let s=0;this.preExtrapolation=n.getUint8(s),s+=qu,this.postExtrapolation=n.getUint8(s),s+=qu;const r=n.getUint32(s,!0);s+=Xu;const o=Array.from({length:r},((t,e)=>n.getFloat32(s+Yu*e,!0)));s+=Yu*r;const a=new Array(r);for(let t=0;t<r;++t){const e=ju({});s=nd(n,e,s),a[t]=e}i.byteLength;const c=t.readProperty("keyframeValueEditorExtras");c&&(c.length,c.forEach(((t,e)=>a[e][$c]=t))),this._times=o,this._values=a}}t("RealCurve",Wu),Le.fastDefine("cc.RealCurve",Wu,{_times:[],_values:[],preExtrapolation:$a.CLAMP,postExtrapolation:$a.CLAMP}),function(t){t[t.VALUE=1]="VALUE",t[t.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",t[t.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",t[t.LEFT_TANGENT=8]="LEFT_TANGENT",t[t.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",t[t.RIGHT_TANGENT=32]="RIGHT_TANGENT",t[t.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(Hu||(Hu={}));const qu=1,Xu=4,Yu=4,{interpolationMode:Ku,tangentWeightMode:Ju,leftTangent:$u,leftTangentWeight:Zu,rightTangent:Qu,rightTangentWeight:td}=ju({}),ed=26;function id(t,e,i){let n=0,s=i;const r=s;s+=4;const{value:o,interpolationMode:a,tangentWeightMode:c,rightTangent:l,rightTangentWeight:h,leftTangent:_,leftTangentWeight:u,easingMethod:d}=e;return t.setFloat32(s,o,!0),s+=4,a!==Ku&&(n|=Hu.INTERPOLATION_MODE,t.setUint8(s,a),s+=1),c!==Ju&&(n|=Hu.TANGENT_WEIGHT_MODE,t.setUint8(s,c),s+=1),_!==$u&&(n|=Hu.LEFT_TANGENT,t.setFloat32(s,_,!0),s+=4),u!==Zu&&(n|=Hu.LEFT_TANGENT_WEIGHT,t.setFloat32(s,u,!0),s+=4),l!==Qu&&(n|=Hu.RIGHT_TANGENT,t.setFloat32(s,l,!0),s+=4),h!==td&&(n|=Hu.RIGHT_TANGENT_WEIGHT,t.setFloat32(s,h,!0),s+=4),n|=d<<8,t.setUint32(r,n,!0),s}function nd(t,e,i){let n=i;const s=t.getUint32(n,!0);n+=4,e.value=t.getFloat32(n,!0),n+=4,s&Hu.INTERPOLATION_MODE&&(e.interpolationMode=t.getUint8(n),n+=1),s&Hu.TANGENT_WEIGHT_MODE&&(e.tangentWeightMode=t.getUint8(n),n+=1),s&Hu.LEFT_TANGENT&&(e.leftTangent=t.getFloat32(n,!0),n+=4),s&Hu.LEFT_TANGENT_WEIGHT&&(e.leftTangentWeight=t.getFloat32(n,!0),n+=4),s&Hu.RIGHT_TANGENT&&(e.rightTangent=t.getFloat32(n,!0),n+=4),s&Hu.RIGHT_TANGENT_WEIGHT&&(e.rightTangentWeight=t.getFloat32(n,!0),n+=4);const r=(65280&s)>>8;return e.easingMethod=r,n}function sd(t,e,i){return e+ni(t-e,i-e)}function rd(t,e,i){return e+si(t-e,i-e)}function od(t,e,i,n,s){return e+(n-e)/(i-t)*(s-t)}function ad(t,e,i,n,s){const r=1-s;return r*r*r*t+3*r*r*s*e+3*r*s*s*i+s*s*s*n}function cd(t,e,i,n,s){const r=1-s;return r*(r*(t+(3*e-t)*s)+3*i*s*s)+n*s*s*s}l.bezier=cd;const ld=Math.cos,hd=Math.acos,_d=Math.max,ud=2*Math.PI,dd=Math.sqrt;function md(t){return t<0?-Math.pow(-t,1/3):Math.pow(t,1/3)}function pd(t,e){const i=function(t,e){const i=e-0,n=e-t[0],s=3*i,r=3*n,o=3*(e-t[2]),a=1/(-i+r-o+(e-1)),c=1/3,l=(s-6*n+o)*a,h=l*c,_=(-s+r)*a,u=(3*_-l*l)*c,d=u*c,m=(2*l*l*l-9*l*_+i*a*27)/27,p=m/2,f=p*p+d*d*d;let g,v,y,x,S;if(f<0){const t=-u*c,e=dd(t*t*t),i=-m/(2*e),n=hd(i<-1?-1:i>1?1:i),s=2*md(e);return y=s*ld(n*c)-h,x=s*ld((n+ud)*c)-h,S=s*ld((n+2*ud)*c)-h,y>=0&&y<=1?x>=0&&x<=1?S>=0&&S<=1?_d(y,x,S):_d(y,x):S>=0&&S<=1?_d(y,S):y:x>=0&&x<=1?S>=0&&S<=1?_d(x,S):x:S}if(0===f)return g=p<0?md(-p):-md(p),y=2*g-h,x=-g-h,y>=0&&y<=1?x>=0&&x<=1?_d(y,x):y:x;{const t=dd(f);return g=md(-p+t),v=md(p+t),y=g-v-h,y}}(t,e),n=t[1];return((1-i)*(n+(t[3]-n)*i)*3+i*i)*i}var fd,gd,vd,yd,xd,Sd,Cd,Ad,bd;let Td;l.bezierByTime=pd,function(t){t[t.SLERP=0]="SLERP",t[t.CONSTANT=1]="CONSTANT"}(Td||(Td=t("QuatInterpolationMode",{})));let Ed=dc("cc.QuatKeyframeValue")(fd=Tc((vd=sc((gd=class{constructor({value:t,interpolationMode:e,easingMethod:i}={}){nc(this,"interpolationMode",vd,this),nc(this,"value",yd,this),nc(this,"easingMethod",xd,this),this.value=t?Si.clone(t):this.value,this.interpolationMode=null!=e?e:this.interpolationMode,this.easingMethod=null!=i?i:this.easingMethod}}).prototype,"interpolationMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Td.SLERP}}),yd=sc(gd.prototype,"value",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Si.clone(Si.IDENTITY)}}),xd=sc(gd.prototype,"easingMethod",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nu.LINEAR}}),fd=gd))||fd)||fd;function Pd(t){return new Ed(t)}let wd=t("QuatCurve",dc("cc.QuatCurve")((Ad=sc((Cd=class extends ec{constructor(...t){super(...t),nc(this,"preExtrapolation",Ad,this),nc(this,"postExtrapolation",bd,this)}evaluate(t,e){var i;null!==(i=e)&&void 0!==i||(e=new Si);const{_times:n,_values:s,postExtrapolation:r,preExtrapolation:o}=this,a=n.length;if(0===a)return e;const c=n[0],l=n[a-1];if(t<c){const i=s[0];switch(o){case $a.LOOP:t=c+ni(t-c,l-c);break;case $a.PING_PONG:t=c+si(t-c,l-c);break;case $a.CLAMP:default:return Si.copy(e,i.value)}}else if(t>l){const i=s[a-1];switch(r){case $a.LOOP:t=c+ni(t-c,l-c);break;case $a.PING_PONG:t=c+si(t-c,l-c);break;case $a.CLAMP:default:return Si.copy(e,i.value)}}const h=tc(n,t);if(h>=0)return Si.copy(e,s[h].value);const _=~h,u=_-1,d=n[u],m=s[u],p=n[_],f=s[_],g=(t-d)/(p-d);switch(m.interpolationMode){default:case Td.CONSTANT:return Si.copy(e,m.value);case Td.SLERP:{const{easingMethod:t}=m,i=t===Nu.LINEAR?g:Array.isArray(t)?pd(t,g):Fu(t)(g);return Si.slerp(e,m.value,f.value,i)}}}addKeyFrame(t,e){const i=new Ed(e);return super.addKeyFrame(t,i)}assignSorted(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((t=>Pd(t))));else{const e=Array.from(t);this.setKeyframes(e.map((([t])=>t)),e.map((([,t])=>Pd(t))))}}[Xh](t,e){if(!e.toCCON)return void t.writeThis();const{_times:i,_values:n}=this;let s=!0;n.forEach(((t,e,[i])=>{s&&t.interpolationMode!==i.interpolationMode&&(s=!1)}));const r=i.length,o=Bd*(s?1:r),a=n.reduce(((t,{easingMethod:e})=>t+(Array.isArray(e)?Nd+4*Fd:Nd)),0);let c=0;c+=Rd+Dd+Md*r+4*Od*r+a+o+0;const l=new DataView(new ArrayBuffer(c));let h=0,_=0;s&&(_|=Id.INTERPOLATION_MODE),l.setUint32(h,_,!0),h+=Rd,l.setUint32(h,r,!0),h+=Dd,i.forEach(((t,e)=>l.setFloat32(h+Md*e,t,!0))),h+=Md*r,n.forEach((({value:{x:t,y:e,z:i,w:n}},s)=>{const r=h+4*Od*s;l.setFloat32(r+0*Od,t,!0),l.setFloat32(r+1*Od,e,!0),l.setFloat32(r+2*Od,i,!0),l.setFloat32(r+3*Od,n,!0)})),h+=4*Od*r,n.forEach((({easingMethod:t})=>{Array.isArray(t)?(l.setUint8(h,Ld),++h,l.setFloat32(h+0*Fd,t[0],!0),l.setFloat32(h+1*Fd,t[1],!0),l.setFloat32(h+2*Fd,t[2],!0),l.setFloat32(h+3*Fd,t[3],!0),h+=4*Fd):(l.setUint8(h,t),++h)}));const u=h;h+=o;let d=u;n.forEach((({interpolationMode:t})=>{l.setUint8(d,t),s||(d+=Bd)}));const m=new Uint8Array(l.buffer);t.writeProperty("bytes",m)}[Yh](t,e){if(!e.fromCCON)return void t.readThis();const i=t.readProperty("bytes"),n=new DataView(i.buffer,i.byteOffset,i.byteLength);let s=0;const r=n.getUint32(s,!0);s+=Rd;const o=r&Id.INTERPOLATION_MODE,a=n.getUint32(s,!0);s+=Dd;const c=Array.from({length:a},((t,e)=>n.getFloat32(s+Md*e,!0)));s+=Md*a;const l=s;s+=4*Od*a;const h=Array.from({length:a},((t,e)=>{const i=l+4*Od*e,r=n.getFloat32(i+0*Od,!0),o=n.getFloat32(i+1*Od,!0),a=n.getFloat32(i+2*Od,!0),c=n.getFloat32(i+3*Od,!0),h=n.getUint8(s);++s;const _=Pd({value:{x:r,y:o,z:a,w:c}});return h!==Ld?_.easingMethod=h:(_.easingMethod=[n.getFloat32(s+0*Fd,!0),n.getFloat32(s+1*Fd,!0),n.getFloat32(s+2*Fd,!0),n.getFloat32(s+3*Fd,!0)],s+=4*Fd),_}));if(o){const t=n.getUint8(s);++s;for(let e=0;e<a;++e)h[e].interpolationMode=t}else{for(let t=0;t<a;++t){const e=n.getUint8(s+t);h[t].interpolationMode=e}s+=a}this._times=c,this._values=h}}).prototype,"preExtrapolation",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $a.CLAMP}}),bd=sc(Cd.prototype,"postExtrapolation",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $a.CLAMP}}),Sd=Cd))||Sd);var Id;!function(t){t[t.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(Id||(Id={}));const Rd=1,Dd=4,Md=4,Od=4,Bd=1,Nd=1,Ld=255,Fd=4;var zd;let Vd=t("ObjectCurve",dc("cc.ObjectCurve")(zd=class extends ec{evaluate(t){const e=this.searchKeyframe(t);if(e>=0)return this._values[e];const i=We(~e-1,0,this._values.length-1);return this._values[i]}})||zd);class Gd{constructor(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}}Le.fastDefine("cc.Keyframe",Gd,{time:0,value:0,inTangent:0,outTangent:0});class Ud{constructor(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}evaluate(t){return e=t-this.time,i=this.coefficient,e*(e*(e*i[0]+i[1])+i[2])+i[3];var e,i}}class kd{get _internalCurve(){return this._curve}get keyFrames(){return Array.from(this._curve.keyframes()).map((([t,e])=>{const i=new Gd;return i.time=t,i.value=e.value,i.inTangent=e.leftTangent,i.outTangent=e.rightTangent,i}))}set keyFrames(t){this._curve.assignSorted(t.map((t=>[t.time,{interpolationMode:Ja.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}])))}get preWrapMode(){return jd(this._curve.preExtrapolation)}set preWrapMode(t){this._curve.preExtrapolation=Hd(t)}get postWrapMode(){return jd(this._curve.postExtrapolation)}set postWrapMode(t){this._curve.postExtrapolation=Hd(t)}constructor(t=null){if(this.cachedKey=void 0,t instanceof Wu)this._curve=t;else{const e=new Wu;this._curve=e,e.preExtrapolation=$a.LOOP,e.postExtrapolation=$a.CLAMP,t?e.assignSorted(t.map((t=>[t.time,{interpolationMode:Ja.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]))):e.assignSorted([[0,{interpolationMode:Ja.CUBIC,value:1}],[1,{interpolationMode:Ja.CUBIC,value:1}]])}this.cachedKey=new Ud}addKey(t){t?this._curve.addKeyFrame(t.time,{interpolationMode:Ja.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}):this._curve.clear()}evaluate_slow(t){return this._curve.evaluate(t)}evaluate(t){const{cachedKey:e,_curve:i}=this,n=i.keyFramesCount-1;let s=t;const r=t<0?i.preExtrapolation:i.postExtrapolation,o=i.getKeyframeTime(0),a=i.getKeyframeTime(n);switch(r){case $a.LOOP:s=ni(t-o,a-o)+o;break;case $a.PING_PONG:s=si(t-o,a-o)+o;break;case $a.CLAMP:default:s=We(t,o,a)}if(s>=e.time&&s<e.endTime)return e.evaluate(s);const c=this.findIndex(e,s),l=Math.min(c+1,n);return this.calcOptimizedKey(e,c,l),e.evaluate(s)}calcOptimizedKey(t,e,i){const n=this._curve.getKeyframeTime(e),s=this._curve.getKeyframeTime(i),{value:r,leftTangent:o}=this._curve.getKeyframeValue(e),{value:a,rightTangent:c}=this._curve.getKeyframeValue(i);t.index=e,t.time=n,t.endTime=s;const l=s-n,h=a-r,_=1/(l*l),u=o*l,d=c*l;t.coefficient[0]=(u+d-h-h)*_/l,t.coefficient[1]=(h+h+h-u-u-d)*_,t.coefficient[2]=o,t.coefficient[3]=r}findIndex(t,e){const{_curve:i}=this,n=i.keyFramesCount,s=t.index;if(-1!==s)if(e>i.getKeyframeTime(s))for(let t=0;t<3;t++){const r=s+t;if(r+1<n&&i.getKeyframeTime(r+1)>e)return r}else for(let t=0;t<3;t++){const n=s-t;if(n>=0&&i.getKeyframeTime(n-1)<=e)return n-1}let r,o=0,a=n;for(;a-o>1;)r=Math.floor((o+a)/2),i.getKeyframeTime(r)>=e?a=r:o=r;return o}}function Hd(t){switch(t){default:case Xa.Default:case Xa.Normal:case Xa.Clamp:return $a.CLAMP;case Xa.PingPong:return $a.PING_PONG;case Xa.Loop:return $a.LOOP}}function jd(t){switch(t){default:case $a.LINEAR:case $a.CLAMP:return Xa.Clamp;case $a.PING_PONG:return Xa.PingPong;case $a.LOOP:return Xa.Loop}}function Wd(t,e){console.warn(`${t} is deprecated, please use ${e} instead.`)}kd.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Le.fastDefine("cc.AnimationCurve",kd,{_curve:null}),V(zo,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var qd=Object.freeze({__proto__:null,distance:kr,enums:Hr,intersect:zo,Line:jr,Plane:Ho,Ray:Wr,Triangle:Zr,Sphere:$r,AABB:La,OBB:Ga,Capsule:Ua,Frustum:qa,Keyframe:Gd,AnimationCurve:kd,get ERaycastMode(){return Qr},line:class extends jr{constructor(){super(),Wd("line","Line")}},plane:class extends Ho{constructor(){super(),Wd("plane","Plane")}},ray:class extends Wr{constructor(){super(),Wd("ray","Ray")}},triangle:class extends Zr{constructor(){super(),Wd("triangle","Triangle")}},sphere:class extends $r{constructor(){super(),Wd("sphere","Sphere")}},aabb:class extends La{constructor(){super(),Wd("aabb","AABB")}},obb:class extends Ga{constructor(){super(),Wd("obb","OBB")}},capsule:class extends Ua{constructor(){super(),Wd("capsule","Capsule")}},frustum:class extends qa{constructor(){super(),Wd("frustum","Frustum")}}});t("geometry",qd);const Xd={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295};class Yd{static makeMaskInclude(t){let e=0;for(const i of t)e|=i;return e}static makeMaskExclude(t){return~Yd.makeMaskInclude(t)}static addLayer(t,e){if(void 0===e)return void console.warn("bitNum can't be undefined");if(e>19||e<0)return void console.warn("maximum layers reached.");const i=1<<e;Yd.Enum[t],N(2104,t),Yd.Enum[t]=i,Ut.value(Yd.Enum,String(i),t),Yd.BitMask[t]=i,Ut.value(Yd.BitMask,String(i),t)}static deleteLayer(t){if(t>19||t<0)return void console.warn("do not change buildin layers.");const e=1<<t;delete Yd.Enum[Yd.Enum[e]],delete Yd.Enum[e],delete Yd.BitMask[Yd.BitMask[e]],delete Yd.BitMask[e]}static nameToLayer(t){return void 0===t?(console.warn("name can't be undefined"),-1):i(Yd.Enum[t])}static layerToName(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):Yd.Enum[1<<t]}}let Kd,Jd;t("Layers",Yd),Yd.Enum=jt(Xd),Yd.BitMask=kt({...Xd}),l.Layers=Yd,function(t){t[t.DEFAULT=100]="DEFAULT",t[t.UI=200]="UI"}(Kd||(Kd={})),l.RenderPassStage=Kd,function(t){t[t.MIN=0]="MIN",t[t.MAX=255]="MAX",t[t.DEFAULT=128]="DEFAULT"}(Jd||(Jd={}));const $d={bindings:[],layouts:{}},Zd={bindings:[],layouts:{}};let Qd;!function(t){t[t.UBO_GLOBAL=0]="UBO_GLOBAL",t[t.UBO_CAMERA=1]="UBO_CAMERA",t[t.UBO_SHADOW=2]="UBO_SHADOW",t[t.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",t[t.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",t[t.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",t[t.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",t[t.COUNT=7]="COUNT"}(Qd||(Qd={}));const tm=Qd.SAMPLER_SHADOWMAP,em=Qd.COUNT-tm;let im;!function(t){t[t.UBO_LOCAL=0]="UBO_LOCAL",t[t.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",t[t.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",t[t.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",t[t.UBO_MORPH=4]="UBO_MORPH",t[t.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",t[t.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",t[t.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",t[t.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",t[t.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",t[t.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",t[t.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",t[t.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",t[t.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",t[t.COUNT=14]="COUNT"}(im||(im={}));const nm=im.SAMPLER_JOINTS,sm=im.STORAGE_REFLECTION-nm,rm=im.COUNT-nm-sm;let om;!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.MATERIAL=1]="MATERIAL",t[t.LOCAL=2]="LOCAL"}(om||(om={}));const am=new Kn([tm,0,nm],[em,0,sm],[0,0,0],[0,0,0],[0,0,0],[0,0,rm],[0,0,0],[0,2,1]);class cm{}cm.TIME_OFFSET=0,cm.NATIVE_SIZE_OFFSET=cm.TIME_OFFSET+4,cm.SCREEN_SIZE_OFFSET=cm.NATIVE_SIZE_OFFSET+4,cm.COUNT=cm.SCREEN_SIZE_OFFSET+4,cm.SIZE=4*cm.COUNT,cm.NAME="CCGlobal",cm.BINDING=Qd.UBO_GLOBAL,cm.DESCRIPTOR=new Ps(cm.BINDING,Dn.UNIFORM_BUFFER,1,yn.ALL),cm.LAYOUT=new cs(om.GLOBAL,cm.BINDING,cm.NAME,[new as("cc_time",tn.FLOAT4,1),new as("cc_screenSize",tn.FLOAT4,1),new as("cc_nativeSize",tn.FLOAT4,1)],1),$d.layouts[cm.NAME]=cm.LAYOUT,$d.bindings[cm.BINDING]=cm.DESCRIPTOR;class lm{}lm.MAT_VIEW_OFFSET=0,lm.MAT_VIEW_INV_OFFSET=lm.MAT_VIEW_OFFSET+16,lm.MAT_PROJ_OFFSET=lm.MAT_VIEW_INV_OFFSET+16,lm.MAT_PROJ_INV_OFFSET=lm.MAT_PROJ_OFFSET+16,lm.MAT_VIEW_PROJ_OFFSET=lm.MAT_PROJ_INV_OFFSET+16,lm.MAT_VIEW_PROJ_INV_OFFSET=lm.MAT_VIEW_PROJ_OFFSET+16,lm.CAMERA_POS_OFFSET=lm.MAT_VIEW_PROJ_INV_OFFSET+16,lm.SCREEN_SCALE_OFFSET=lm.CAMERA_POS_OFFSET+4,lm.EXPOSURE_OFFSET=lm.SCREEN_SCALE_OFFSET+4,lm.MAIN_LIT_DIR_OFFSET=lm.EXPOSURE_OFFSET+4,lm.MAIN_LIT_COLOR_OFFSET=lm.MAIN_LIT_DIR_OFFSET+4,lm.AMBIENT_SKY_OFFSET=lm.MAIN_LIT_COLOR_OFFSET+4,lm.AMBIENT_GROUND_OFFSET=lm.AMBIENT_SKY_OFFSET+4,lm.GLOBAL_FOG_COLOR_OFFSET=lm.AMBIENT_GROUND_OFFSET+4,lm.GLOBAL_FOG_BASE_OFFSET=lm.GLOBAL_FOG_COLOR_OFFSET+4,lm.GLOBAL_FOG_ADD_OFFSET=lm.GLOBAL_FOG_BASE_OFFSET+4,lm.NEAR_FAR_OFFSET=lm.GLOBAL_FOG_ADD_OFFSET+4,lm.VIEW_PORT_OFFSET=lm.NEAR_FAR_OFFSET+4,lm.COUNT=lm.VIEW_PORT_OFFSET+4,lm.SIZE=4*lm.COUNT,lm.NAME="CCCamera",lm.BINDING=Qd.UBO_CAMERA,lm.DESCRIPTOR=new Ps(lm.BINDING,Dn.UNIFORM_BUFFER,1,yn.ALL),lm.LAYOUT=new cs(om.GLOBAL,lm.BINDING,lm.NAME,[new as("cc_matView",tn.MAT4,1),new as("cc_matViewInv",tn.MAT4,1),new as("cc_matProj",tn.MAT4,1),new as("cc_matProjInv",tn.MAT4,1),new as("cc_matViewProj",tn.MAT4,1),new as("cc_matViewProjInv",tn.MAT4,1),new as("cc_cameraPos",tn.FLOAT4,1),new as("cc_screenScale",tn.FLOAT4,1),new as("cc_exposure",tn.FLOAT4,1),new as("cc_mainLitDir",tn.FLOAT4,1),new as("cc_mainLitColor",tn.FLOAT4,1),new as("cc_ambientSky",tn.FLOAT4,1),new as("cc_ambientGround",tn.FLOAT4,1),new as("cc_fogColor",tn.FLOAT4,1),new as("cc_fogBase",tn.FLOAT4,1),new as("cc_fogAdd",tn.FLOAT4,1),new as("cc_nearFar",tn.FLOAT4,1),new as("cc_viewPort",tn.FLOAT4,1)],1),$d.layouts[lm.NAME]=lm.LAYOUT,$d.bindings[lm.BINDING]=lm.DESCRIPTOR;class hm{}hm.MAT_LIGHT_PLANE_PROJ_OFFSET=0,hm.MAT_LIGHT_VIEW_OFFSET=hm.MAT_LIGHT_PLANE_PROJ_OFFSET+16,hm.MAT_LIGHT_VIEW_PROJ_OFFSET=hm.MAT_LIGHT_VIEW_OFFSET+16,hm.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=hm.MAT_LIGHT_VIEW_PROJ_OFFSET+16,hm.SHADOW_PROJ_DEPTH_INFO_OFFSET=hm.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+4,hm.SHADOW_PROJ_INFO_OFFSET=hm.SHADOW_PROJ_DEPTH_INFO_OFFSET+4,hm.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=hm.SHADOW_PROJ_INFO_OFFSET+4,hm.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=hm.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+4,hm.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=hm.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+4,hm.SHADOW_COLOR_OFFSET=hm.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+4,hm.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=hm.SHADOW_COLOR_OFFSET+4,hm.COUNT=hm.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+4,hm.SIZE=4*hm.COUNT,hm.NAME="CCShadow",hm.BINDING=Qd.UBO_SHADOW,hm.DESCRIPTOR=new Ps(hm.BINDING,Dn.UNIFORM_BUFFER,1,yn.ALL),hm.LAYOUT=new cs(om.GLOBAL,hm.BINDING,hm.NAME,[new as("cc_matLightPlaneProj",tn.MAT4,1),new as("cc_matLightView",tn.MAT4,1),new as("cc_matLightViewProj",tn.MAT4,1),new as("cc_shadowInvProjDepthInfo",tn.FLOAT4,1),new as("cc_shadowProjDepthInfo",tn.FLOAT4,1),new as("cc_shadowProjInfo",tn.FLOAT4,1),new as("cc_shadowNFLSInfo",tn.FLOAT4,1),new as("cc_shadowWHPBInfo",tn.FLOAT4,1),new as("cc_shadowLPNNInfo",tn.FLOAT4,1),new as("cc_shadowColor",tn.FLOAT4,1),new as("cc_planarNDInfo",tn.FLOAT4,1)],1),$d.layouts[hm.NAME]=hm.LAYOUT,$d.bindings[hm.BINDING]=hm.DESCRIPTOR;const _m=Qd.SAMPLER_SHADOWMAP,um=new Ps(_m,Dn.SAMPLER_TEXTURE,1,yn.FRAGMENT),dm=new ls(om.GLOBAL,_m,"cc_shadowMap",tn.SAMPLER2D,1);$d.layouts.cc_shadowMap=dm,$d.bindings[_m]=um;const mm=Qd.SAMPLER_ENVIRONMENT,pm=new Ps(mm,Dn.SAMPLER_TEXTURE,1,yn.FRAGMENT),fm=new ls(om.GLOBAL,mm,"cc_environment",tn.SAMPLER_CUBE,1);$d.layouts.cc_environment=fm,$d.bindings[mm]=pm;const gm=Qd.SAMPLER_DIFFUSEMAP,vm=new Ps(gm,Dn.SAMPLER_TEXTURE,1,yn.FRAGMENT),ym=new ls(om.GLOBAL,gm,"cc_diffuseMap",tn.SAMPLER_CUBE,1);$d.layouts.cc_diffuseMap=ym,$d.bindings[gm]=vm;const xm=Qd.SAMPLER_SPOT_LIGHTING_MAP,Sm=new Ps(xm,Dn.SAMPLER_TEXTURE,1,yn.FRAGMENT),Cm=new ls(om.GLOBAL,xm,"cc_spotLightingMap",tn.SAMPLER2D,1);$d.layouts.cc_spotLightingMap=Cm,$d.bindings[xm]=Sm;class Am{}Am.MAT_WORLD_OFFSET=0,Am.MAT_WORLD_IT_OFFSET=Am.MAT_WORLD_OFFSET+16,Am.LIGHTINGMAP_UVPARAM=Am.MAT_WORLD_IT_OFFSET+16,Am.LOCAL_SHADOW_BIAS=Am.LIGHTINGMAP_UVPARAM+4,Am.COUNT=Am.LOCAL_SHADOW_BIAS+4,Am.SIZE=4*Am.COUNT,Am.NAME="CCLocal",Am.BINDING=im.UBO_LOCAL,Am.DESCRIPTOR=new Ps(Am.BINDING,Dn.UNIFORM_BUFFER,1,yn.VERTEX|yn.COMPUTE),Am.LAYOUT=new cs(om.LOCAL,Am.BINDING,Am.NAME,[new as("cc_matWorld",tn.MAT4,1),new as("cc_matWorldIT",tn.MAT4,1),new as("cc_lightingMapUVParam",tn.FLOAT4,1),new as("cc_localShadowBias",tn.FLOAT4,1)],1),Zd.layouts[Am.NAME]=Am.LAYOUT,Zd.bindings[Am.BINDING]=Am.DESCRIPTOR;class bm{}bm.WORLD_BOUND_CENTER=0,bm.WORLD_BOUND_HALF_EXTENTS=bm.WORLD_BOUND_CENTER+4,bm.COUNT=bm.WORLD_BOUND_HALF_EXTENTS+4,bm.SIZE=4*bm.COUNT,bm.NAME="CCWorldBound",bm.BINDING=im.UBO_LOCAL,bm.DESCRIPTOR=new Ps(bm.BINDING,Dn.UNIFORM_BUFFER,1,yn.VERTEX|yn.COMPUTE),bm.LAYOUT=new cs(om.LOCAL,bm.BINDING,bm.NAME,[new as("cc_worldBoundCenter",tn.FLOAT4,1),new as("cc_worldBoundHalfExtents",tn.FLOAT4,1)],1),Zd.layouts[bm.NAME]=bm.LAYOUT,Zd.bindings[bm.BINDING]=bm.DESCRIPTOR;class Tm{}Tm.BATCHING_COUNT=10,Tm.MAT_WORLDS_OFFSET=0,Tm.COUNT=16*Tm.BATCHING_COUNT,Tm.SIZE=4*Tm.COUNT,Tm.NAME="CCLocalBatched",Tm.BINDING=im.UBO_LOCAL,Tm.DESCRIPTOR=new Ps(Tm.BINDING,Dn.UNIFORM_BUFFER,1,yn.VERTEX|yn.COMPUTE),Tm.LAYOUT=new cs(om.LOCAL,Tm.BINDING,Tm.NAME,[new as("cc_matWorlds",tn.MAT4,Tm.BATCHING_COUNT)],1),Zd.layouts[Tm.NAME]=Tm.LAYOUT,Zd.bindings[Tm.BINDING]=Tm.DESCRIPTOR;class Em{}Em.LIGHTS_PER_PASS=1,Em.LIGHT_POS_OFFSET=0,Em.LIGHT_COLOR_OFFSET=Em.LIGHT_POS_OFFSET+4*Em.LIGHTS_PER_PASS,Em.LIGHT_SIZE_RANGE_ANGLE_OFFSET=Em.LIGHT_COLOR_OFFSET+4*Em.LIGHTS_PER_PASS,Em.LIGHT_DIR_OFFSET=Em.LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*Em.LIGHTS_PER_PASS,Em.COUNT=Em.LIGHT_DIR_OFFSET+4*Em.LIGHTS_PER_PASS,Em.SIZE=4*Em.COUNT,Em.NAME="CCForwardLight",Em.BINDING=im.UBO_FORWARD_LIGHTS,Em.DESCRIPTOR=new Ps(Em.BINDING,Dn.DYNAMIC_UNIFORM_BUFFER,1,yn.FRAGMENT),Em.LAYOUT=new cs(om.LOCAL,Em.BINDING,Em.NAME,[new as("cc_lightPos",tn.FLOAT4,Em.LIGHTS_PER_PASS),new as("cc_lightColor",tn.FLOAT4,Em.LIGHTS_PER_PASS),new as("cc_lightSizeRangeAngle",tn.FLOAT4,Em.LIGHTS_PER_PASS),new as("cc_lightDir",tn.FLOAT4,Em.LIGHTS_PER_PASS)],1),Zd.layouts[Em.NAME]=Em.LAYOUT,Zd.bindings[Em.BINDING]=Em.DESCRIPTOR;class Pm{}Pm.JOINTS_TEXTURE_INFO_OFFSET=0,Pm.COUNT=Pm.JOINTS_TEXTURE_INFO_OFFSET+4,Pm.SIZE=4*Pm.COUNT,Pm.NAME="CCSkinningTexture",Pm.BINDING=im.UBO_SKINNING_TEXTURE,Pm.DESCRIPTOR=new Ps(Pm.BINDING,Dn.UNIFORM_BUFFER,1,yn.VERTEX),Pm.LAYOUT=new cs(om.LOCAL,Pm.BINDING,Pm.NAME,[new as("cc_jointTextureInfo",tn.FLOAT4,1)],1),Zd.layouts[Pm.NAME]=Pm.LAYOUT,Zd.bindings[Pm.BINDING]=Pm.DESCRIPTOR;class wm{}wm.JOINTS_ANIM_INFO_OFFSET=0,wm.COUNT=wm.JOINTS_ANIM_INFO_OFFSET+4,wm.SIZE=4*wm.COUNT,wm.NAME="CCSkinningAnimation",wm.BINDING=im.UBO_SKINNING_ANIMATION,wm.DESCRIPTOR=new Ps(wm.BINDING,Dn.UNIFORM_BUFFER,1,yn.VERTEX),wm.LAYOUT=new cs(om.LOCAL,wm.BINDING,wm.NAME,[new as("cc_jointAnimInfo",tn.FLOAT4,1)],1),Zd.layouts[wm.NAME]=wm.LAYOUT,Zd.bindings[wm.BINDING]=wm.DESCRIPTOR;class Im{}Im.JOINTS_OFFSET=0,Im.COUNT=Im.JOINTS_OFFSET+360,Im.SIZE=4*Im.COUNT,Im.NAME="CCSkinning",Im.BINDING=im.UBO_SKINNING_TEXTURE,Im.DESCRIPTOR=new Ps(Im.BINDING,Dn.UNIFORM_BUFFER,1,yn.VERTEX),Im.LAYOUT=new cs(om.LOCAL,Im.BINDING,Im.NAME,[new as("cc_joints",tn.FLOAT4,90)],1),Zd.layouts[Im.NAME]=Im.LAYOUT,Zd.bindings[Im.BINDING]=Im.DESCRIPTOR;class Rm{}Rm.MAX_MORPH_TARGET_COUNT=60,Rm.OFFSET_OF_WEIGHTS=0,Rm.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Rm.MAX_MORPH_TARGET_COUNT,Rm.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=Rm.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH+4,Rm.OFFSET_OF_VERTICES_COUNT=Rm.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT+4,Rm.COUNT_BASE_4_BYTES=4*Math.ceil(Rm.MAX_MORPH_TARGET_COUNT/4)+4,Rm.SIZE=4*Rm.COUNT_BASE_4_BYTES,Rm.NAME="CCMorph",Rm.BINDING=im.UBO_MORPH,Rm.DESCRIPTOR=new Ps(Rm.BINDING,Dn.UNIFORM_BUFFER,1,yn.VERTEX),Rm.LAYOUT=new cs(om.LOCAL,Rm.BINDING,Rm.NAME,[new as("cc_displacementWeights",tn.FLOAT4,Rm.MAX_MORPH_TARGET_COUNT/4),new as("cc_displacementTextureInfo",tn.FLOAT4,1)],1),Zd.layouts[Rm.NAME]=Rm.LAYOUT,Zd.bindings[Rm.BINDING]=Rm.DESCRIPTOR;class Dm{}Dm.NAME="CCUILocal",Dm.BINDING=im.UBO_UI_LOCAL,Dm.DESCRIPTOR=new Ps(Dm.BINDING,Dn.DYNAMIC_UNIFORM_BUFFER,1,yn.VERTEX),Dm.LAYOUT=new cs(om.LOCAL,Dm.BINDING,Dm.NAME,[new as("cc_local_data",tn.FLOAT4,1)],1),Zd.layouts[Dm.NAME]=Dm.LAYOUT,Zd.bindings[Dm.BINDING]=Dm.DESCRIPTOR;const Mm=im.SAMPLER_JOINTS,Om=new Ps(Mm,Dn.SAMPLER_TEXTURE,1,yn.VERTEX),Bm=new ls(om.LOCAL,Mm,"cc_jointTexture",tn.SAMPLER2D,1);Zd.layouts.cc_jointTexture=Bm,Zd.bindings[Mm]=Om;const Nm=im.SAMPLER_MORPH_POSITION,Lm=new Ps(Nm,Dn.SAMPLER_TEXTURE,1,yn.VERTEX),Fm=new ls(om.LOCAL,Nm,"cc_PositionDisplacements",tn.SAMPLER2D,1);Zd.layouts.cc_PositionDisplacements=Fm,Zd.bindings[Nm]=Lm;const zm=im.SAMPLER_MORPH_NORMAL,Vm=new Ps(zm,Dn.SAMPLER_TEXTURE,1,yn.VERTEX),Gm=new ls(om.LOCAL,zm,"cc_NormalDisplacements",tn.SAMPLER2D,1);Zd.layouts.cc_NormalDisplacements=Gm,Zd.bindings[zm]=Vm;const Um=im.SAMPLER_MORPH_TANGENT,km=new Ps(Um,Dn.SAMPLER_TEXTURE,1,yn.VERTEX),Hm=new ls(om.LOCAL,Um,"cc_TangentDisplacements",tn.SAMPLER2D,1);Zd.layouts.cc_TangentDisplacements=Hm,Zd.bindings[Um]=km;const jm=im.SAMPLER_LIGHTMAP,Wm=new Ps(jm,Dn.SAMPLER_TEXTURE,1,yn.FRAGMENT),qm=new ls(om.LOCAL,jm,"cc_lightingMap",tn.SAMPLER2D,1);Zd.layouts.cc_lightingMap=qm,Zd.bindings[jm]=Wm;const Xm=im.SAMPLER_SPRITE,Ym=new Ps(Xm,Dn.SAMPLER_TEXTURE,1,yn.FRAGMENT),Km=new ls(om.LOCAL,Xm,"cc_spriteTexture",tn.SAMPLER2D,1);Zd.layouts.cc_spriteTexture=Km,Zd.bindings[Xm]=Ym;const Jm=im.SAMPLER_REFLECTION,$m=new Ps(Jm,Dn.SAMPLER_TEXTURE,1,yn.FRAGMENT),Zm=new ls(om.LOCAL,Jm,"cc_reflectionTexture",tn.SAMPLER2D,1);Zd.layouts.cc_reflectionTexture=Zm,Zd.bindings[Jm]=$m;const Qm=im.STORAGE_REFLECTION,tp=new Ps(Qm,Dn.STORAGE_IMAGE,1,yn.COMPUTE),ep=new us(om.LOCAL,Qm,"cc_reflectionStorage",tn.IMAGE2D,1);Zd.layouts.cc_reflectionStorage=ep,Zd.bindings[Qm]=tp;const ip=Yd.makeMaskExclude([Yd.BitMask.UI_2D,Yd.BitMask.GIZMOS,Yd.BitMask.EDITOR,Yd.BitMask.SCENE_GIZMO,Yd.BitMask.PROFILER]);function np(t){return(t.getFormatFeatures(Zi.R32F)&(ln.RENDER_TARGET|ln.SAMPLED_TEXTURE))==(ln.RENDER_TARGET|ln.SAMPLED_TEXTURE)}Yd.makeMaskExclude([Yd.BitMask.UI_2D,Yd.BitMask.PROFILER]),Yd.Enum.ALL;const sp=4227858432,rp=66060288,op=1044480,ap=(t,e,i,n=0)=>e<<26&sp|t<<20&rp|i<<12&op|4095&n,cp=t=>(t&sp)>>>26,lp=t=>(t&rp)>>>20,hp=t=>(t&op)>>>12,_p=t=>4095&t,up=(t,e)=>67108863&t|e<<26&sp,dp={[tn.UNKNOWN]:()=>console.warn("illegal uniform handle"),[tn.INT]:(t,e,i=0)=>t[i],[tn.INT2]:(t,e,i=0)=>Oi.fromArray(e,t,i),[tn.INT3]:(t,e,i=0)=>mi.fromArray(e,t,i),[tn.INT4]:(t,e,i=0)=>Fi.fromArray(e,t,i),[tn.FLOAT]:(t,e,i=0)=>t[i],[tn.FLOAT2]:(t,e,i=0)=>Oi.fromArray(e,t,i),[tn.FLOAT3]:(t,e,i=0)=>mi.fromArray(e,t,i),[tn.FLOAT4]:(t,e,i=0)=>Fi.fromArray(e,t,i),[tn.MAT3]:(t,e,i=0)=>vi.fromArray(e,t,i),[tn.MAT4]:(t,e,i=0)=>Ii.fromArray(e,t,i)},mp={[tn.UNKNOWN]:()=>console.warn("illegal uniform handle"),[tn.INT]:(t,e,i=0)=>t[i]=e,[tn.INT2]:(t,e,i=0)=>Oi.toArray(t,e,i),[tn.INT3]:(t,e,i=0)=>mi.toArray(t,e,i),[tn.INT4]:(t,e,i=0)=>Fi.toArray(t,e,i),[tn.FLOAT]:(t,e,i=0)=>t[i]=e,[tn.FLOAT2]:(t,e,i=0)=>Oi.toArray(t,e,i),[tn.FLOAT3]:(t,e,i=0)=>mi.toArray(t,e,i),[tn.FLOAT4]:(t,e,i=0)=>Fi.toArray(t,e,i),[tn.MAT3]:(t,e,i=0)=>vi.toArray(t,e,i),[tn.MAT4]:(t,e,i=0)=>Ii.toArray(t,e,i)},pp=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function fp(t){switch(t){case tn.BOOL:case tn.INT:case tn.UINT:case tn.FLOAT:return pp[0];case tn.BOOL2:case tn.INT2:case tn.UINT2:case tn.FLOAT2:return pp[1];case tn.BOOL4:case tn.INT4:case tn.UINT4:case tn.FLOAT4:return pp[2];case tn.MAT4:return pp[3];case tn.SAMPLER2D:return"default-texture";case tn.SAMPLER_CUBE:return"default-cube-texture"}return pp[0]}function gp(t,e){const i=Object.entries(e);let n=!1;for(let e=0;e<i.length;e++)t[i[e][0]]!==i[e][1]&&(t[i[e][0]]=i[e][1],n=!0);return n}const vp=new ws;function yp(t){return Math.ceil(Math.log2(Math.max(t,2)))}function xp(t,e){switch(t.type){case"boolean":return"number"==typeof e?e.toString():e?"1":"0";case"string":return void 0!==e?e:t.options[0];case"number":return void 0!==e?e.toString():t.range[0].toString();default:return console.warn(`unknown define type '${t.type}'`),"-1"}}function Sp(t,e,i,n,s){const r=t.builtins[n],o=[];for(let t=0;t<r.blocks.length;t++){const e=r.blocks[t],n=i.layouts[e.name],a=n&&i.bindings.find((t=>t.binding===n.binding));n&&a&&a.descriptorType&Us?(o.push(n),s&&!s.includes(a)&&s.push(a)):console.warn(`builtin UBO '${e.name}' not available!`)}Array.prototype.unshift.apply(e.shaderInfo.blocks,o);const a=[];for(let t=0;t<r.samplerTextures.length;t++){const e=r.samplerTextures[t],n=i.layouts[e.name],o=n&&i.bindings.find((t=>t.binding===n.binding));n&&o&&o.descriptorType&ks?(a.push(n),s&&!s.includes(o)&&s.push(o)):console.warn(`builtin samplerTexture '${e.name}' not available!`)}Array.prototype.unshift.apply(e.shaderInfo.samplerTextures,a),s&&s.sort(((t,e)=>t.binding-e.binding))}function Cp(t){return t.members.reduce(((t,e)=>t+Ys(e.type)*e.count),0)}function Ap(t,e){for(let i=0;i<t.length;i++){const n=t[i];if("!"===n[0]){if(e[n.slice(1)])return!1}else if(!e[n])return!1}return!0}function bp(t){switch(t.gfxAPI){case Ki.GLES2:case Ki.WEBGL:return"glsl1";case Ki.GLES3:case Ki.WEBGL2:return"glsl3";default:return"glsl4"}}const Tp=new class{constructor(){this._templates={},this._cache={},this._templateInfos={}}register(t){for(let e=0;e<t.shaders.length;e++)this.define(t.shaders[e]).effectName=t.name;for(let e=0;e<t.techniques.length;e++){const i=t.techniques[e];for(let t=0;t<i.passes.length;t++){const e=i.passes[t];void 0!==e.propertyIndex&&void 0===e.properties&&(e.properties=i.passes[e.propertyIndex].properties)}}}define(t){const e=this._templates[t.name];if(e&&e.hash===t.hash)return e;const i={...t};let n=0;for(let t=0;t<i.defines.length;t++){const e=i.defines[t];let s=1;if("number"===e.type){const t=e.range;s=yp(t[1]-t[0]+1),e._map=e=>e-t[0]}else"string"===e.type?(s=yp(e.options.length),e._map=t=>Math.max(0,e.options.findIndex((e=>e===t)))):"boolean"===e.type&&(e._map=t=>t?1:0);e._offset=n,n+=s}n>31&&(i.uber=!0),i.constantMacros="";for(const t in i.builtins.statistics)i.constantMacros+=`#define ${t} ${i.builtins.statistics[t]}\n`;if(this._templates[t.name]=i,!this._templateInfos[i.hash]){const t={};t.samplerStartBinding=i.blocks.length,t.shaderInfo=new gs,t.blockSizes=[],t.bindings=[];for(let e=0;e<i.blocks.length;e++){const n=i.blocks[e];t.blockSizes.push(Cp(n)),t.bindings.push(new Ps(n.binding,Dn.UNIFORM_BUFFER,1,n.stageFlags)),t.shaderInfo.blocks.push(new cs(om.MATERIAL,n.binding,n.name,n.members.map((t=>new as(t.name,t.type,t.count))),1))}for(let e=0;e<i.samplerTextures.length;e++){const n=i.samplerTextures[e];t.bindings.push(new Ps(n.binding,Dn.SAMPLER_TEXTURE,n.count,n.stageFlags)),t.shaderInfo.samplerTextures.push(new ls(om.MATERIAL,n.binding,n.name,n.type,n.count))}for(let e=0;e<i.samplers.length;e++){const n=i.samplers[e];t.bindings.push(new Ps(n.binding,Dn.SAMPLER,n.count,n.stageFlags)),t.shaderInfo.samplers.push(new hs(om.MATERIAL,n.binding,n.name,n.count))}for(let e=0;e<i.textures.length;e++){const n=i.textures[e];t.bindings.push(new Ps(n.binding,Dn.TEXTURE,n.count,n.stageFlags)),t.shaderInfo.textures.push(new _s(om.MATERIAL,n.binding,n.name,n.type,n.count))}for(let e=0;e<i.buffers.length;e++){const n=i.buffers[e];t.bindings.push(new Ps(n.binding,Dn.STORAGE_BUFFER,1,n.stageFlags)),t.shaderInfo.buffers.push(new ds(om.MATERIAL,n.binding,n.name,1,n.memoryAccess))}for(let e=0;e<i.images.length;e++){const n=i.images[e];t.bindings.push(new Ps(n.binding,Dn.STORAGE_IMAGE,n.count,n.stageFlags)),t.shaderInfo.images.push(new us(om.MATERIAL,n.binding,n.name,n.type,n.count,n.memoryAccess))}for(let e=0;e<i.subpassInputs.length;e++){const n=i.subpassInputs[e];t.bindings.push(new Ps(n.binding,Dn.INPUT_ATTACHMENT,n.count,n.stageFlags)),t.shaderInfo.subpassInputs.push(new ms(om.MATERIAL,n.binding,n.name,n.count))}t.gfxAttributes=[];for(let e=0;e<i.attributes.length;e++){const n=i.attributes[e];t.gfxAttributes.push(new fs(n.name,n.format,n.isNormalized,0,n.isInstanced,n.location))}Sp(i,t,Zd,"locals"),t.shaderInfo.stages.push(new ps(yn.VERTEX,"")),t.shaderInfo.stages.push(new ps(yn.FRAGMENT,"")),t.handleMap=function(t){const e={};for(let i=0;i<t.blocks.length;i++){const n=t.blocks[i],s=n.members;let r=0;for(let t=0;t<s.length;t++){const i=s[t];e[i.name]=ap(n.binding,i.type,i.count,r),r+=(Ys(i.type)>>2)*i.count}}for(let i=0;i<t.samplerTextures.length;i++){const n=t.samplerTextures[i];e[n.name]=ap(n.binding,n.type,n.count)}return e}(i),t.setLayouts=[],this._templateInfos[i.hash]=t}return i}getTemplate(t){return this._templates[t]}getTemplateInfo(t){const e=this._templates[t].hash;return this._templateInfos[e]}getDescriptorSetLayout(t,e,i=!1){const n=this._templates[e],s=this._templateInfos[n.hash];return s.setLayouts.length||(vp.bindings=s.bindings,s.setLayouts[om.MATERIAL]=t.createDescriptorSetLayout(vp),vp.bindings=Zd.bindings,s.setLayouts[om.LOCAL]=t.createDescriptorSetLayout(vp)),s.setLayouts[i?om.LOCAL:om.MATERIAL]}hasProgram(t){return void 0!==this._templates[t]}getKey(t,e){const i=this._templates[t],n=i.defines;if(i.uber){let t="";for(let i=0;i<n.length;i++){const s=n[i],r=e[s.name];if(!r||!s._map)continue;const o=s._map(r);t+=`${s._offset}${o}|`}return`${t}${i.hash}`}let s=0;for(let t=0;t<n.length;t++){const i=n[t],r=e[i.name];r&&i._map&&(s|=i._map(r)<<i._offset)}return`${s.toString(16)}|${i.hash}`}destroyShaderByDefines(t){const e=Object.keys(t);if(!e.length)return;const i=e.map((e=>{let i=t[e];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp(`${e}${i}`)})),n=Object.keys(this._cache).filter((t=>i.every((e=>e.test(this._cache[t].name)))));for(let t=0;t<n.length;t++){const e=n[t],i=this._cache[e];C(`destroyed shader ${i.name}`),i.destroy(),delete this._cache[e]}}getGFXShader(t,e,i,n,s){Object.assign(i,n.macros),s||(s=this.getKey(e,i));const r=this._cache[s];if(r)return r;const o=this._templates[e],a=this._templateInfos[o.hash];a.pipelineLayout||(this.getDescriptorSetLayout(t,e),Sp(o,a,$d,"globals"),a.setLayouts[om.GLOBAL]=n.descriptorSetLayout,a.pipelineLayout=t.createPipelineLayout(new Rs(a.setLayouts)));const c=function(t,e){const i=[];for(let n=0;n<e.length;n++){const s=e[n],r=s.name,o=t[r],a=xp(s,o),c=!o||"0"===o;i.push({name:r,value:a,isDefault:c})}return i}(i,o.defines),l=n.constantMacros+o.constantMacros+c.reduce(((t,e)=>`${t}#define ${e.name} ${e.value}\n`),"");let h=o.glsl3;const _=bp(t);return _?h=o[_]:console.error("Invalid GFX API!"),a.shaderInfo.stages[0].source=l+h.vert,a.shaderInfo.stages[1].source=l+h.frag,a.shaderInfo.attributes=function(t,e,i){const n=[],s=t.attributes,r=e.gfxAttributes;for(let t=0;t<s.length;t++)Ap(s[t].defines,i)&&n.push(r[t]);return n}(o,a,i),a.shaderInfo.name=function(t,e){return t+e.reduce(((t,e)=>e.isDefault?t:`${t}|${e.name}${e.value}`),"")}(e,c),this._cache[s]=t.createShader(a.shaderInfo)}};var Ep,Pp,wp,Ip,Rp,Dp,Mp,Op;l.programLib=Tp;let Bp=t("EffectAsset",dc("cc.EffectAsset")((Op=Mp=class t extends fh{constructor(...t){super(...t),nc(this,"techniques",wp,this),nc(this,"shaders",Ip,this),nc(this,"combinations",Rp,this),nc(this,"hideInEditor",Dp,this)}static register(e){t._effects[e.name]=e}static remove(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name]===e&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(const i in t._effects)if(t._effects[i]._uuid===e)return void delete t._effects[i]}}static get(e){if(t._effects[e])return t._effects[e];for(const i in t._effects)if(t._effects[i]._uuid===e)return t._effects[i];return null}static getAll(){return t._effects}onLoaded(){Tp.register(this),t.register(this),l.game.once(l.Game.EVENT_ENGINE_INITED,this._precompile,this)}_precompile(){const t=l.director.root;for(let e=0;e<this.shaders.length;e++){const i=this.shaders[e],n=this.combinations[e];n&&Object.keys(n).reduce(((t,e)=>t.reduce(((t,i)=>{const s=n[e];for(let n=0;n<s.length;++n){const r={...i};r[e]=s[n],t.push(r)}return t}),[])),[{}]).forEach((e=>Tp.getGFXShader(t.device,i.name,e,t.pipeline)))}}destroy(){return t.remove(this),super.destroy()}initDefault(e){super.initDefault(e);const i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques}validate(){return this.techniques.length>0&&this.shaders.length>0}},Mp._effects={},wp=sc((Pp=Op).prototype,"techniques",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ip=sc(Pp.prototype,"shaders",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rp=sc(Pp.prototype,"combinations",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dp=sc(Pp.prototype,"hideInEditor",[Sc,Ac],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ep=Pp))||Ep);l.EffectAsset=Bp;let Np,Lp,Fp,zp=1024;var Vp,Gp,Up,kp,Hp,jp,Wp,qp,Xp,Yp,Kp,Jp;!function(t){t[t.RGB565=Zi.R5G6B5]="RGB565",t[t.RGB5A1=Zi.RGB5A1]="RGB5A1",t[t.RGBA4444=Zi.RGBA4]="RGBA4444",t[t.RGB888=Zi.RGB8]="RGB888",t[t.RGB32F=Zi.RGB32F]="RGB32F",t[t.RGBA8888=Zi.RGBA8]="RGBA8888",t[t.RGBA32F=Zi.RGBA32F]="RGBA32F",t[t.A8=Zi.A8]="A8",t[t.I8=Zi.L8]="I8",t[t.AI8=Zi.LA8]="AI8",t[t.RGB_PVRTC_2BPPV1=Zi.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",t[t.RGBA_PVRTC_2BPPV1=Zi.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",t[t.RGB_A_PVRTC_2BPPV1=zp++]="RGB_A_PVRTC_2BPPV1",t[t.RGB_PVRTC_4BPPV1=Zi.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",t[t.RGBA_PVRTC_4BPPV1=Zi.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",t[t.RGB_A_PVRTC_4BPPV1=zp++]="RGB_A_PVRTC_4BPPV1",t[t.RGB_ETC1=Zi.ETC_RGB8]="RGB_ETC1",t[t.RGBA_ETC1=zp++]="RGBA_ETC1",t[t.RGB_ETC2=Zi.ETC2_RGB8]="RGB_ETC2",t[t.RGBA_ETC2=Zi.ETC2_RGBA8]="RGBA_ETC2",t[t.RGBA_ASTC_4x4=Zi.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",t[t.RGBA_ASTC_5x4=Zi.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",t[t.RGBA_ASTC_5x5=Zi.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",t[t.RGBA_ASTC_6x5=Zi.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",t[t.RGBA_ASTC_6x6=Zi.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",t[t.RGBA_ASTC_8x5=Zi.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",t[t.RGBA_ASTC_8x6=Zi.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",t[t.RGBA_ASTC_8x8=Zi.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",t[t.RGBA_ASTC_10x5=Zi.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",t[t.RGBA_ASTC_10x6=Zi.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",t[t.RGBA_ASTC_10x8=Zi.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",t[t.RGBA_ASTC_10x10=Zi.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",t[t.RGBA_ASTC_12x10=Zi.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",t[t.RGBA_ASTC_12x12=Zi.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(Np||(Np={})),function(t){t[t.REPEAT=dn.WRAP]="REPEAT",t[t.CLAMP_TO_EDGE=dn.CLAMP]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=dn.MIRROR]="MIRRORED_REPEAT",t[t.CLAMP_TO_BORDER=dn.BORDER]="CLAMP_TO_BORDER"}(Lp||(Lp={})),function(t){t[t.NONE=un.NONE]="NONE",t[t.LINEAR=un.LINEAR]="LINEAR",t[t.NEAREST=un.POINT]="NEAREST"}(Fp||(Fp={})),Xt(Zi);const $p=new et("Tex");let Zp=dc("cc.TextureBase")((Jp=Kp=class extends fh{get isCompressed(){return this._format>=Np.RGB_ETC1&&this._format<=Np.RGBA_ASTC_12x12||this._format>=Np.RGB_A_PVRTC_2BPPV1&&this._format<=Np.RGBA_ETC1}get width(){return this._width}get height(){return this._height}constructor(){super(),nc(this,"_format",Up,this),nc(this,"_minFilter",kp,this),nc(this,"_magFilter",Hp,this),nc(this,"_mipFilter",jp,this),nc(this,"_wrapS",Wp,this),nc(this,"_wrapT",qp,this),nc(this,"_wrapR",Xp,this),nc(this,"_anisotropy",Yp,this),this._width=1,this._height=1,this._id=void 0,this._samplerInfo=new os,this._gfxSampler=null,this._gfxDevice=null,this._textureHash=0,this._id=$p.getNewId(),this._gfxDevice=this._getGFXDevice(),this._textureHash=ur(this._id,666)}getId(){return this._id}getPixelFormat(){return this._format}getAnisotropy(){return this._anisotropy}setWrapMode(t,e,i){void 0===i&&(i=t),this._wrapS=t,this._samplerInfo.addressU=t,this._wrapT=e,this._samplerInfo.addressV=e,this._wrapR=i,this._samplerInfo.addressW=i,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}setFilters(t,e){this._minFilter=t,this._samplerInfo.minFilter=t,this._magFilter=e,this._samplerInfo.magFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}setMipFilter(t){this._mipFilter=t,this._samplerInfo.mipFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}setAnisotropy(t){this._anisotropy=t,this._samplerInfo.maxAnisotropy=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}destroy(){var t;const e=super.destroy();return e&&(null===(t=l.director.root)||void 0===t?void 0:t.batcher2D)&&l.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),e}getHash(){return this._textureHash}getGFXTexture(){return null}getSamplerInfo(){return this._samplerInfo}getGFXSampler(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):D(9302)),this._gfxSampler}_serialize(t){return""}_deserialize(t,e){const i=t.split(",");i.unshift(""),i.length>=5&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4]))),i.length>=7&&(this.setMipFilter(parseInt(i[5])),this.setAnisotropy(parseInt(i[6])))}_getGFXDevice(){return l.director.root?l.director.root.device:null}_getGFXFormat(){return this._getGFXPixelFormat(this._format)}_setGFXFormat(t){this._format=void 0===t?Np.RGBA8888:t}_getGFXPixelFormat(t){return t===Np.RGBA_ETC1?t=Np.RGB_ETC1:t===Np.RGB_A_PVRTC_4BPPV1?t=Np.RGB_PVRTC_4BPPV1:t===Np.RGB_A_PVRTC_2BPPV1&&(t=Np.RGB_PVRTC_2BPPV1),t}},Kp.PixelFormat=Np,Kp.WrapMode=Lp,Kp.Filter=Fp,Up=sc((Gp=Jp).prototype,"_format",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Np.RGBA8888}}),kp=sc(Gp.prototype,"_minFilter",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fp.LINEAR}}),Hp=sc(Gp.prototype,"_magFilter",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fp.LINEAR}}),jp=sc(Gp.prototype,"_mipFilter",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fp.NONE}}),Wp=sc(Gp.prototype,"_wrapS",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lp.REPEAT}}),qp=sc(Gp.prototype,"_wrapT",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lp.REPEAT}}),Xp=sc(Gp.prototype,"_wrapR",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lp.REPEAT}}),Yp=sc(Gp.prototype,"_anisotropy",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vp=Gp))||Vp;var Qp,tf,ef,nf;function sf(t){return!!(l.sys.hasFeature(l.sys.Feature.IMAGE_BITMAP)&&t instanceof ImageBitmap)}l.TextureBase=Zp;let rf=t("ImageAsset",dc("cc.ImageAsset")((nf=ef=class t extends fh{get _nativeAsset(){return this._nativeData}set _nativeAsset(t){t instanceof HTMLElement||sf(t)||(t.format=t.format||this._format),this.reset(t)}get data(){return this._nativeData&&!0!==(t=this._nativeData)._compressed&&(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||sf(t))?this._nativeData:this._nativeData&&this._nativeData._data;var t}get width(){return this._nativeData.width||this._width}get height(){return this._nativeData.height||this._height}get format(){return this._format}get isCompressed(){return this._format>=Np.RGB_ETC1&&this._format<=Np.RGBA_ASTC_12x12||this._format>=Np.RGB_A_PVRTC_2BPPV1&&this._format<=Np.RGBA_ETC1}get url(){return this.nativeUrl}constructor(t){super(),this._nativeData=void 0,this._exportedExts=void 0,this._format=Np.RGBA8888,this._width=0,this._height=0,this._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&this.reset(t)}reset(t){sf(t)||t instanceof HTMLElement?this._nativeData=t:(this._nativeData=t,this._format=t.format)}destroy(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset(""),this.data.destroy()):sf(this.data)&&this.data.close&&this.data.close(),super.destroy()}_serialize(){}_deserialize(e){let i="";"string"==typeof e?i=e:(this._width=e.w,this._height=e.h,i=e.fmt);const n=l.director.root?l.director.root.device:null,s=i.split("_");let r=Number.MAX_VALUE,o=this._format,a="";const c=l.macro.SUPPORT_TEXTURE_FORMATS;for(const e of s){const i=e.split("@"),s=parseInt(i[0],void 0),h=t.extnames[s]||i[0],_=c.indexOf(h);if(-1!==_&&_<r){const t=i[1]?parseInt(i[1]):this._format;if(!(".astc"!==h||n&&n.getFormatFeatures(Zi.ASTC_RGBA_4X4)&ln.SAMPLED_TEXTURE))continue;if(!(".pvr"!==h||n&&n.getFormatFeatures(Zi.PVRTC_RGBA4)&ln.SAMPLED_TEXTURE))continue;if(!(t!==Np.RGB_ETC1&&t!==Np.RGBA_ETC1||n&&n.getFormatFeatures(Zi.ETC_RGB8)&ln.SAMPLED_TEXTURE))continue;if(!(t!==Np.RGB_ETC2&&t!==Np.RGBA_ETC2||n&&n.getFormatFeatures(Zi.ETC2_RGB8)&ln.SAMPLED_TEXTURE))continue;if(".webp"===h&&!l.sys.hasFeature(l.sys.Feature.WEBP))continue;r=_,a=h,o=t}}a?(this._setRawAsset(a),this._format=o):I(3121)}initDefault(e){if(super.initDefault(e),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{const e=document.createElement("canvas"),i=e.getContext("2d"),n=e.width=e.height=2;i.fillStyle="#ff00ff",i.fillRect(0,0,n,n),this.reset(e),t._sharedPlaceHolderCanvas=e}}validate(){return!!this.data}},ef.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],ef._sharedPlaceHolderCanvas=null,sc((tf=nf).prototype,"_nativeAsset",[Jc],Object.getOwnPropertyDescriptor(tf.prototype,"_nativeAsset"),tf.prototype),Qp=tf))||Qp);l.ImageAsset=rf;const of=new WeakMap,af=new WeakSet,cf=new WeakSet;function lf(t,e){let i;i=kh.safeFindClass;const n=a_.pool.get();let s;try{s=y_(t,n,{classFinder:i,customEnv:e})}catch(t){throw x(t),a_.pool.put(n),t}s._uuid=e.__uuid__||"";const r=n.uuidList,o=n.uuidObjList,a=n.uuidPropList,c=n.uuidTypeList||[],l=[];for(let t=0;t<r.length;t++){const e=r[t];l[t]={uuid:Cl(e),owner:o[t],prop:a[t],type:Ut._getClassById(c[t])}}return of.set(s,l),s._native&&af.add(s),a_.pool.put(n),s}var hf,_f=new class{constructor(){this._depends=new rl}init(){this._depends.clear()}getNativeDep(t){const e=this._depends.get(t);return e&&e.nativeDep?{...e.nativeDep}:null}getDeps(t){return this._depends.has(t)?this._depends.get(t).deps:[]}getDepsRecursively(t){const e=Object.create(null),i=[];return this._descend(t,e,i),i}remove(t){this._depends.remove(t)}parse(t,e){let i=null;if(Array.isArray(e)||e.__type__||e instanceof Kh){if(this._depends.has(t))return this._depends.get(t);if(Array.isArray(e)&&!function(t){const e=t[5],i=e[e.length-1];return"number"==typeof i&&i<0}(e))i={deps:this._parseDepsFromJson(e)};else try{const n=lf(e,{__uuid__:t});i=this._parseDepsFromAsset(n),i.nativeDep&&(i.nativeDep.uuid=t),ll.add(`${t}@import`,n)}catch(e){cl.remove(`${t}@import`),i={deps:[]}}}else{if(this._depends.has(t)&&(i=this._depends.get(t),i.parsedFromExistAsset))return i;i=this._parseDepsFromAsset(e)}return this._depends.add(t,i),i}_parseDepsFromAsset(t){const e={deps:[],parsedFromExistAsset:!0},i=of.get(t);for(let t=0,n=i.length;t<n;t++)e.deps.push(i[t].uuid);return af.has(t)&&(e.nativeDep=t._nativeDep),e}_parseDepsFromJson(t){const e=function(t){const e=t[1];return t[10].map((t=>e[t]))}(t);return e.forEach(((t,i)=>e[i]=Cl(t))),e}_descend(t,e,i){const n=this.getDeps(t);for(let t=0;t<n.length;t++){const s=n[t];e[s]||(e[s]=!0,i.push(s),this._descend(s,e,i))}}};const uf=[new qn];function df(t){return t&&0==(t&t-1)}let mf=dc("cc.SimpleTexture")(hf=class extends Zp{constructor(...t){super(...t),this._gfxTexture=null,this._gfxTextureView=null,this._mipmapLevel=1,this._textureWidth=0,this._textureHeight=0,this._baseLevel=0,this._maxLevel=1e3}get mipmapLevel(){return this._mipmapLevel}getGFXTexture(){return this._gfxTextureView}destroy(){return this._tryDestroyTextureView(),this._tryDestroyTexture(),super.destroy()}updateImage(){this.updateMipmaps(0)}updateMipmaps(t=0,e){}uploadData(t,e=0,i=0){if(!this._gfxTexture||this._mipmapLevel<=e)return;const n=this._getGFXDevice();if(!n)return;const s=uf[0];s.texExtent.width=this._textureWidth>>e,s.texExtent.height=this._textureHeight>>e,s.texSubres.mipLevel=e,s.texSubres.baseArrayLayer=i,ArrayBuffer.isView(t)?n.copyBuffersToTexture([t],this._gfxTexture,uf):n.copyTexImagesToTexture([t],this._gfxTexture,uf)}_assignImage(t,e,i){const n=t.data;if(n&&(this.uploadData(n,e,i),this._checkTextureLoaded(),Kt.CLEANUP_IMAGE_CACHE)){const e=_f.getDeps(this._uuid),i=e.indexOf(t._uuid);-1!==i&&(J(e,i),t.decRef())}}_checkTextureLoaded(){this._textureReady()}_textureReady(){this.loaded=!0,this.emit("load")}_setMipmapLevel(t){this._mipmapLevel=t<1?1:t}_setMipRange(t,e){this._baseLevel=t<1?0:t,this._maxLevel=e<1?0:e}setMipRange(t,e){O(t<=e,3124),this._setMipRange(t,e);const i=this._getGFXDevice();if(!i)return;const n=this._createTextureView(i);this._tryDestroyTextureView(),this._gfxTextureView=n}_getGfxTextureCreateInfo(t){return null}_getGfxTextureViewCreateInfo(t){return null}_tryReset(){if(this._tryDestroyTextureView(),this._tryDestroyTexture(),0===this._mipmapLevel)return;const t=this._getGFXDevice();t&&(this._createTexture(t),this._gfxTextureView=this._createTextureView(t))}_createTexture(t){if(0===this._width||0===this._height)return;let e=cn.NONE;this._mipFilter!==Fp.NONE&&function(t,e,i){return!(t.gfxAPI===Ki.WEBGL)||df(e)&&df(i)}(t,this._width,this._height)&&(this._mipmapLevel=function(t,e){let i=Math.max(t,e),n=0;for(;i;)i>>=1,n++;return n}(this._width,this._height),e=cn.GEN_MIPMAP);const i=this._getGfxTextureCreateInfo({usage:an.SAMPLED|an.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:e});if(!i)return;const n=t.createTexture(i);this._textureWidth=i.width,this._textureHeight=i.height,this._gfxTexture=n}_createTextureView(t){if(!this._gfxTexture)return null;const e=this._maxLevel<this._mipmapLevel?this._maxLevel:this._mipmapLevel-1,i=this._getGfxTextureViewCreateInfo({texture:this._gfxTexture,format:this._getGFXFormat(),baseLevel:this._baseLevel,levelCount:e-this._baseLevel+1});return i?t.createTexture(i):null}_tryDestroyTexture(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)}_tryDestroyTextureView(){this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)}})||hf;var pf,ff,gf,vf,yf;l.SimpleTexture=mf;let xf=t("Texture2D",(pf=dc("cc.Texture2D"),ff=Kc([rf]),pf((yf=sc((vf=class extends mf{constructor(...t){super(...t),nc(this,"_mipmaps",yf,this)}get mipmaps(){return this._mipmaps}set mipmaps(t){if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const t=this._mipmaps[0];this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach(((t,e)=>{this._assignImage(t,e)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(t){this.mipmaps=t?[t]:[]}initialize(){this.mipmaps=this._mipmaps}onLoaded(){this.initialize()}reset(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format);const e=void 0===t.mipmapLevel?1:t.mipmapLevel;this._setMipmapLevel(e);const i=void 0===t.baseLevel?0:t.baseLevel,n=void 0===t.maxLevel?1e3:t.maxLevel;this._setMipRange(i,n),this._tryReset()}create(t,e,i=Np.RGBA8888,n=1,s=0,r=1e3){this.reset({width:t,height:e,format:i,mipmapLevel:n,baseLevel:s,maxLevel:r})}toString(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}updateMipmaps(t=0,e){if(t>=this._mipmaps.length)return;const i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t);for(let e=0;e<i;++e){const i=t+e;this._assignImage(this._mipmaps[i],i)}}getHtmlElementObj(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}destroy(){return this._mipmaps=[],super.destroy()}description(){return`<cc.Texture2D | Name = ${this._mipmaps[0]?this._mipmaps[0].url:""} | Dimension = ${this.width} x ${this.height}>`}releaseTexture(){this.destroy()}_serialize(t){return null}_deserialize(t,e){const i=t;super._deserialize(i.base,e),this._mipmaps=new Array(i.mipmaps.length);for(let t=0;t<i.mipmaps.length;++t){if(this._mipmaps[t]=new rf,!i.mipmaps[t])continue;const n=i.mipmaps[t];e.result.push(this._mipmaps,`${t}`,n,Ut._getClassId(rf))}}_getGfxTextureCreateInfo(t){const e=new ss(on.TEX2D);return e.width=this._width,e.height=this._height,Object.assign(e,t),e}_getGfxTextureViewCreateInfo(t){const e=new rs;return e.type=on.TEX2D,Object.assign(e,t),e}initDefault(t){super.initDefault(t);const e=new rf;e.initDefault(),this.image=e}validate(){return this.mipmaps&&0!==this.mipmaps.length}}).prototype,"_mipmaps",[ff],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gf=vf))||gf));var Sf,Cf,Af,bf,Tf,Ef,Pf;l.Texture2D=xf,function(t){t[t.right=0]="right",t[t.left=1]="left",t[t.top=2]="top",t[t.bottom=3]="bottom",t[t.front=4]="front",t[t.back=5]="back"}(Pf||(Pf={}));let wf=t("TextureCube",dc("cc.TextureCube")((Ef=Tf=class t extends mf{constructor(...t){super(...t),nc(this,"isRGBE",Af,this),nc(this,"_mipmaps",bf,this)}get mipmaps(){return this._mipmaps}set mipmaps(t){if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const t=this._mipmaps[0].front;this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach(((t,e)=>{If(t,((t,i)=>{this._assignImage(t,e,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(t){this.mipmaps=t?[t]:[]}static fromTexture2DArray(e,i){const n=[],s=e.length/6;for(let t=0;t<s;t++){const i=6*t;n.push({front:e[i+Pf.front].image,back:e[i+Pf.back].image,left:e[i+Pf.left].image,right:e[i+Pf.right].image,top:e[i+Pf.top].image,bottom:e[i+Pf.bottom].image})}return(i=i||new t).mipmaps=n,i}onLoaded(){this.mipmaps=this._mipmaps}reset(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format);const e=void 0===t.mipmapLevel?1:t.mipmapLevel;this._setMipmapLevel(e);const i=void 0===t.baseLevel?0:t.baseLevel,n=void 0===t.maxLevel?1e3:t.maxLevel;this._setMipRange(i,n),this._tryReset()}updateMipmaps(t=0,e){if(t>=this._mipmaps.length)return;const i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t);for(let e=0;e<i;++e){const i=t+e;If(this._mipmaps[i],((t,e)=>{this._assignImage(t,i,e)}))}}destroy(){return this._mipmaps=[],super.destroy()}releaseTexture(){this.mipmaps=[]}_serialize(t){return null}_deserialize(t,e){const i=t;super._deserialize(i.base,e),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(let t=0;t<i.mipmaps.length;++t){this._mipmaps[t]={front:new rf,back:new rf,left:new rf,right:new rf,top:new rf,bottom:new rf};const n=i.mipmaps[t],s=Ut._getClassId(rf);e.result.push(this._mipmaps[t],"front",n.front,s),e.result.push(this._mipmaps[t],"back",n.back,s),e.result.push(this._mipmaps[t],"left",n.left,s),e.result.push(this._mipmaps[t],"right",n.right,s),e.result.push(this._mipmaps[t],"top",n.top,s),e.result.push(this._mipmaps[t],"bottom",n.bottom,s)}}_getGfxTextureCreateInfo(t){const e=new ss(on.CUBE);return e.width=this._width,e.height=this._height,e.layerCount=6,Object.assign(e,t),e}_getGfxTextureViewCreateInfo(t){const e=new rs;return e.type=on.CUBE,e.baseLayer=0,e.layerCount=6,Object.assign(e,t),e}initDefault(t){super.initDefault(t);const e=new rf;e.initDefault(),this.mipmaps=[{front:e,back:e,top:e,bottom:e,left:e,right:e}]}validate(){return 0!==this._mipmaps.length&&!this._mipmaps.find((t=>!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)))}},Tf.FaceIndex=Pf,Af=sc((Cf=Ef).prototype,"isRGBE",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bf=sc(Cf.prototype,"_mipmaps",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sf=Cf))||Sf);function If(t,e){e(t.front,Pf.front),e(t.back,Pf.back),e(t.left,Pf.left),e(t.right,Pf.right),e(t.top,Pf.top),e(t.bottom,Pf.bottom)}l.TextureCube=wf;const Rf=t("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:3642336485,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:54,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"geometry-renderer",techniques:[{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]},{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]}],shaders:[{name:"geometry-renderer|line-vs:vert|line-fs:front",hash:3617431e3,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|line-vs:vert|line-fs:back",hash:4168905198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",hash:4034582016,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:back",hash:1762165009,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|triangle-vs:vert|triangle-fs:front",hash:4143142643,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:44,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|triangle-vs:vert|triangle-fs:back",hash:826026446,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:44,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:4284763886,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:851293782,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:64,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:2502358098,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:585841727,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:2499219289,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:67215139,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},specularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrength:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4079105024,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:223,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:75},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["CC_USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:14},{name:"a_texCoord1",defines:[],format:21,location:15}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3928335406,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:184,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:75},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3669699677,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:71,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:71},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["CC_USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:2218105608,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:69,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3152709001,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:198,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:14}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:837263906,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:682261797,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3663548873,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:670444562,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:2587574837,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:69},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2},{name:"depth_stencil",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:3}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:3542426468,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:217,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:2960965003,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:2207113861,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),Df={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 front() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 back() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_normal;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_normal;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\nuniform highp vec4 cc_localShadowBias;\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\nvec2 CCGetShadowBias()\n{\n#if USE_INSTANCING\nreturn vec2(a_localShadowBias.x + cc_shadowWHPBInfo.w, a_localShadowBias.y + cc_shadowLPNNInfo.z);\n#elif !USE_BATCHING\nreturn vec2(cc_localShadowBias.x + cc_shadowWHPBInfo.w, cc_localShadowBias.y + cc_shadowLPNNInfo.z);\n#else\nreturn vec2(cc_shadowWHPBInfo.w, cc_shadowLPNNInfo.z);\n#endif\n}\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying mediump vec3 v_normal;\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying mediump vec2 v_uv1;\n#endif\n#if CC_RECEIVE_SHADOW\nvarying mediump vec2 v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvarying mediump vec4 v_tangent;\n#endif\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.z;\nv_luv.z = cc_lightingMapUVParam.w;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.z;\nv_luv.z = a_lightingMapUVParam.w;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if CC_RECEIVE_SHADOW\nv_shadowBias = CCGetShadowBias();\n#endif\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent.xyz = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_tangent.w = In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying mediump vec2 v_uv1;\n#endif\nvarying mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nvarying mediump vec2 v_shadowBias;\n#endif\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying mediump vec4 v_tangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = lightColor.xyz * v_luv.z;\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\nvec3 bitangent = cross(v_normal, v_tangent.xyz) * v_tangent.w;\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent.xyz) +\n(nmmp.y * emissiveScaleParam.w) * normalize(bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.specularIntensity = 0.5;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying vec2 v_uv1;\n#endif\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying vec2 v_uv1;\n#endif\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\n#if CC_RECEIVE_SHADOW\nvarying vec2 v_shadowBias;\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if CC_USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.z;\nluv.z = lightMapUVParam.w;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if CC_RECEIVE_SHADOW\nv_shadowBias = vec2(0.0, 0.0);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nvarying vec2 v_shadowBias;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 tangent = vec3(1.0, 0.0, 0.0);\nvec3 binormal = vec3(0.0, 0.0, 1.0);\nbinormal = cross(tangent, v_normal);\ntangent = cross(v_normal, binormal);\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(tangent) +\nnmmp.y * normalize(binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#if LAYERS == 1\ns.specularIntensity = 0.5;\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = lightColor.xyz * luv.z;\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nuniform sampler2D depth_stencil;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragData[2];\nfloat depth = texture2D(depth_stencil, v_uv).x;\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\nfloat depth = texture2D(depth_stencil, v_uv).x;\n#endif\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.specularIntensity = 0.5;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\n#endif\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nout float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nin float v_distance;\nvec4 front() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nout float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nin float v_distance;\nvec4 back() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_normal;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_normal;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#if SAMPLE_FROM_RT\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\nvec2 CCGetShadowBias()\n{\n#if USE_INSTANCING\nreturn vec2(a_localShadowBias.x + cc_shadowWHPBInfo.w, a_localShadowBias.y + cc_shadowLPNNInfo.z);\n#elif !USE_BATCHING\nreturn vec2(cc_localShadowBias.x + cc_shadowWHPBInfo.w, cc_localShadowBias.y + cc_shadowLPNNInfo.z);\n#else\nreturn vec2(cc_shadowWHPBInfo.w, cc_shadowLPNNInfo.z);\n#endif\n}\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout lowp vec4 v_color;\n#endif\nout vec3 v_position;\nout mediump vec3 v_normal;\nout vec2 v_uv;\n#if HAS_SECOND_UV\nout mediump vec2 v_uv1;\n#endif\n#if CC_RECEIVE_SHADOW\nout mediump vec2 v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nout mediump vec4 v_tangent;\n#endif\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.z;\nv_luv.z = cc_lightingMapUVParam.w;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.z;\nv_luv.z = a_lightingMapUVParam.w;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if CC_RECEIVE_SHADOW\nv_shadowBias = CCGetShadowBias();\n#endif\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent.xyz = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_tangent.w = In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nin vec3 v_position;\nin vec2 v_uv;\n#if HAS_SECOND_UV\nin mediump vec2 v_uv1;\n#endif\nin mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nin mediump vec2 v_shadowBias;\n#endif\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin mediump vec4 v_tangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = lightColor.xyz * v_luv.z;\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\nvec3 bitangent = cross(v_normal, v_tangent.xyz) * v_tangent.w;\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent.xyz) +\n(nmmp.y * emissiveScaleParam.w) * normalize(bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.specularIntensity = 0.5;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\n#if HAS_SECOND_UV\nout vec2 v_uv1;\n#endif\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\n#if HAS_SECOND_UV\nin vec2 v_uv1;\n#endif\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\n#if CC_RECEIVE_SHADOW\nout vec2 v_shadowBias;\n#endif\nout highp vec3 v_position;\nout mediump vec3 v_normal;\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if CC_USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.z;\nluv.z = lightMapUVParam.w;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if CC_RECEIVE_SHADOW\nv_shadowBias = vec2(0.0, 0.0);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nin vec2 v_shadowBias;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 tangent = vec3(1.0, 0.0, 0.0);\nvec3 binormal = vec3(0.0, 0.0, 1.0);\nbinormal = cross(tangent, v_normal);\ntangent = cross(v_normal, binormal);\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(tangent) +\nnmmp.y * normalize(binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#if LAYERS == 1\ns.specularIntensity = 0.5;\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = lightColor.xyz * luv.z;\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\nfloat depth = texture(depth_stencil, v_uv).x;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\nfloat depth = texture(depth_stencil, v_uv).x;\n#endif\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.specularIntensity = 0.5;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\n#endif\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]],glsl4:[[{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(set = 1, binding = 1) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 3) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 2) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(location = 0) in vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) in highp vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nlayout(location = 0) in vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) in highp vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nlayout(location = 0) in vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"},{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) in highp vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nlayout(location = 1) out float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nlayout(location = 0) in vec4 v_color;\nlayout(location = 1) in float v_distance;\nvec4 front() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) in highp vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nlayout(location = 1) out float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nlayout(location = 0) in vec4 v_color;\nlayout(location = 1) in float v_distance;\nvec4 back() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"},{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) in highp vec3 a_position;\nlayout(location = 1) in vec4 a_normal;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nlayout(location = 0) in vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) in highp vec3 a_position;\nlayout(location = 1) in vec4 a_normal;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nlayout(location = 0) in vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nlayout(location = 2) in float a_dist;\nlayout(location = 1) out float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(location = 0) in vec4 v_color;\nlayout(location = 1) in float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(set = 2, binding = 0) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nlayout(location = 0) in vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(set = 1, binding = 1) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(set = 1, binding = 2) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nlayout(location = 0) in vec4 a_position_starttime;\nlayout(location = 1) in vec4 a_size_uv;\nlayout(location = 2) in vec4 a_rotation_uv;\nlayout(location = 3) in vec4 a_color;\nlayout(location = 4) in vec4 a_dir_life;\nlayout(location = 5) in float a_rndSeed;\n#if CC_RENDER_MODE == 4\nlayout(location = 6) in vec3 a_texCoord;\nlayout(location = 7) in vec3 a_texCoord3;\nlayout(location = 8) in vec3 a_normal;\nlayout(location = 9) in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 10) uniform sampler2D color_over_time_tex0;\nlayout(set = 1, binding = 3) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 11) uniform sampler2D rotation_over_time_tex0;\nlayout(set = 1, binding = 4) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 12) uniform sampler2D size_over_time_tex0;\nlayout(set = 1, binding = 5) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 13) uniform sampler2D force_over_time_tex0;\nlayout(set = 1, binding = 6) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 14) uniform sampler2D velocity_over_time_tex0;\nlayout(set = 1, binding = 7) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nlayout(set = 1, binding = 15) uniform sampler2D texture_animation_tex0;\nlayout(set = 1, binding = 8) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 16) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 9) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nlayout(location = 2) out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\n#if CC_DRAW_WIRE_FRAME\nlayout(location = 2) in vec3 vBarycentric;\n#endif\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_RENDER_MODE == 1\nlayout(location = 8) in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nlayout(location = 6) in vec3 a_texCoord3;\nlayout(location = 7) in vec3 a_normal;\nlayout(location = 8) in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 v_light;\nlayout(location = 1) out vec2 uv0;\n#if TWO_COLORED\nlayout(location = 3) in vec4 a_color2;\nlayout(location = 2) out vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(set = 1, binding = 0) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nlayout(location = 0) in vec4 v_light;\n#if TWO_COLORED\nlayout(location = 2) in vec4 v_dark;\n#endif\nlayout(location = 1) in vec2 uv0;\nlayout(set = 2, binding = 11) uniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#if SAMPLE_FROM_RT\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 color;\nlayout(location = 1) out vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(set = 1, binding = 0) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nlayout(location = 0) in vec4 color;\n#if USE_TEXTURE\nlayout(location = 1) in vec2 uv0;\nlayout(set = 2, binding = 11) uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nlayout(location = 6) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(location = 7) in vec4 a_matWorld0;\nlayout(location = 8) in vec4 a_matWorld1;\nlayout(location = 9) in vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nlayout(location = 10) in vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 11) in vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\n#endif\n#if CC_USE_MORPH\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 7) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 8) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 9) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 6) uniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nlayout(location = 0) out float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nlayout(location = 1) out highp vec4 v_shadowPos;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform highp sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\nvec2 CCGetShadowBias()\n{\n#if USE_INSTANCING\nreturn vec2(a_localShadowBias.x + cc_shadowWHPBInfo.w, a_localShadowBias.y + cc_shadowLPNNInfo.z);\n#elif !USE_BATCHING\nreturn vec2(cc_localShadowBias.x + cc_shadowWHPBInfo.w, cc_localShadowBias.y + cc_shadowLPNNInfo.z);\n#else\nreturn vec2(cc_shadowWHPBInfo.w, cc_shadowLPNNInfo.z);\n#endif\n}\n#endif\n#if USE_VERTEX_COLOR\nlayout(location = 14) in vec4 a_color;\nlayout(location = 2) out lowp vec4 v_color;\n#endif\nlayout(location = 3) out vec3 v_position;\nlayout(location = 4) out mediump vec3 v_normal;\nlayout(location = 5) out vec2 v_uv;\n#if HAS_SECOND_UV\nlayout(location = 6) out mediump vec2 v_uv1;\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 7) out mediump vec2 v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nlayout(location = 8) out mediump vec4 v_tangent;\n#endif\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nlayout(location = 15) in vec2 a_texCoord1;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 9) out vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.z;\nv_luv.z = cc_lightingMapUVParam.w;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.z;\nv_luv.z = a_lightingMapUVParam.w;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if CC_RECEIVE_SHADOW\nv_shadowBias = CCGetShadowBias();\n#endif\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent.xyz = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_tangent.w = In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nlayout(location = 0) in float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform highp sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nlayout(set = 0, binding = 6) uniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(location = 1) in highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 9) in vec3 v_luv;\nlayout(set = 2, binding = 10) uniform sampler2D cc_lightingMap;\n#endif\nlayout(location = 3) in vec3 v_position;\nlayout(location = 5) in vec2 v_uv;\n#if HAS_SECOND_UV\nlayout(location = 6) in mediump vec2 v_uv1;\n#endif\nlayout(location = 4) in mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nlayout(location = 7) in mediump vec2 v_shadowBias;\n#endif\n#if USE_VERTEX_COLOR\nlayout(location = 2) in lowp vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nlayout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nlayout(location = 8) in mediump vec4 v_tangent;\nlayout(set = 1, binding = 2) uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nlayout(set = 1, binding = 3) uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nlayout(set = 1, binding = 4) uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nlayout(set = 1, binding = 5) uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nlayout(set = 1, binding = 6) uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = lightColor.xyz * v_luv.z;\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\nvec3 bitangent = cross(v_normal, v_tangent.xyz) * v_tangent.w;\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent.xyz) +\n(nmmp.y * emissiveScaleParam.w) * normalize(bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.specularIntensity = 0.5;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(set = 1, binding = 7) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(set = 1, binding = 8) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(set = 1, binding = 9) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nlayout(location = 6) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(location = 7) in vec4 a_matWorld0;\nlayout(location = 8) in vec4 a_matWorld1;\nlayout(location = 9) in vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nlayout(location = 10) in vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 11) in vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\n#endif\n#if CC_USE_MORPH\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 7) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 8) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 9) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 6) uniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nlayout(location = 14) in vec2 a_texCoord1;\n#endif\nlayout(location = 0) out vec2 v_uv;\n#if HAS_SECOND_UV\nlayout(location = 1) out vec2 v_uv1;\n#endif\nlayout(location = 2) out vec4 v_worldPos;\nlayout(location = 3) out float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform highp sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform highp sampler2D cc_spotLightingMap;\n#endif\nlayout(location = 0) in vec2 v_uv;\n#if HAS_SECOND_UV\nlayout(location = 1) in vec2 v_uv1;\n#endif\nlayout(location = 2) in vec4 v_worldPos;\nlayout(location = 3) in float v_clip_depth;\n#if USE_ALBEDO_MAP\nlayout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nlayout(location = 0) out float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nlayout(location = 1) out highp vec4 v_shadowPos;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform highp sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\n#if CC_RECEIVE_SHADOW\nlayout(location = 2) out vec2 v_shadowBias;\n#endif\nlayout(location = 3) out highp vec3 v_position;\nlayout(location = 4) out mediump vec3 v_normal;\nlayout(location = 5) out mediump vec2 uvw;\nlayout(location = 6) out mediump vec2 uv0;\nlayout(location = 7) out mediump vec2 uv1;\nlayout(location = 8) out mediump vec2 uv2;\nlayout(location = 9) out mediump vec2 uv3;\nlayout(location = 10) out mediump vec3 luv;\nlayout(location = 11) out mediump vec3 diffuse;\nlayout(set = 1, binding = 0) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if CC_USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.z;\nluv.z = lightMapUVParam.w;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if CC_RECEIVE_SHADOW\nv_shadowBias = vec2(0.0, 0.0);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform highp sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nlayout(set = 0, binding = 6) uniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nlayout(location = 0) in float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nlayout(location = 1) in highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 12) in vec3 v_luv;\nlayout(set = 2, binding = 10) uniform sampler2D cc_lightingMap;\n#endif\nlayout(location = 3) in highp vec3 v_position;\nlayout(location = 4) in mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nlayout(location = 2) in vec2 v_shadowBias;\n#endif\nlayout(location = 5) in mediump vec2 uvw;\nlayout(location = 6) in mediump vec2 uv0;\nlayout(location = 7) in mediump vec2 uv1;\nlayout(location = 8) in mediump vec2 uv2;\nlayout(location = 9) in mediump vec2 uv3;\nlayout(location = 11) in mediump vec3 diffuse;\nlayout(location = 10) in mediump vec3 luv;\nlayout(set = 1, binding = 1) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nlayout(set = 1, binding = 2) uniform sampler2D weightMap;\nlayout(set = 1, binding = 3) uniform sampler2D detailMap0;\nlayout(set = 1, binding = 4) uniform sampler2D detailMap1;\nlayout(set = 1, binding = 5) uniform sampler2D detailMap2;\nlayout(set = 1, binding = 6) uniform sampler2D detailMap3;\nlayout(set = 1, binding = 7) uniform sampler2D normalMap0;\nlayout(set = 1, binding = 8) uniform sampler2D normalMap1;\nlayout(set = 1, binding = 9) uniform sampler2D normalMap2;\nlayout(set = 1, binding = 10) uniform sampler2D normalMap3;\nlayout(set = 1, binding = 11) uniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 tangent = vec3(1.0, 0.0, 0.0);\nvec3 binormal = vec3(0.0, 0.0, 1.0);\nbinormal = cross(tangent, v_normal);\ntangent = cross(v_normal, binormal);\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(tangent) +\nnmmp.y * normalize(binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#if LAYERS == 1\ns.specularIntensity = 0.5;\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = lightColor.xyz * luv.z;\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(set = 1, binding = 12) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(set = 1, binding = 13) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(set = 1, binding = 14) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(location = 0) in vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nlayout(location = 6) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(location = 7) in vec4 a_matWorld0;\nlayout(location = 8) in vec4 a_matWorld1;\nlayout(location = 9) in vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nlayout(location = 10) in vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 11) in vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\n#endif\n#if CC_USE_MORPH\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 7) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 8) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 9) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 6) uniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nlayout(location = 0) out float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nlayout(location = 14) in lowp vec4 a_color;\nlayout(location = 1) out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nlayout(location = 2) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nlayout(location = 0) in float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nlayout(location = 2) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\n#endif\nlayout(set = 1, binding = 1) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nlayout(location = 1) in lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nlayout(location = 6) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(location = 7) in vec4 a_matWorld0;\nlayout(location = 8) in vec4 a_matWorld1;\nlayout(location = 9) in vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nlayout(location = 10) in vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 11) in vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\n#endif\n#if CC_USE_MORPH\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 7) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 8) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 9) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 6) uniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 0) uniform BloomUBO {\nmediump vec4 texSize;\n};\nlayout(set = 1, binding = 1) uniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nlayout(location = 6) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(location = 7) in vec4 a_matWorld0;\nlayout(location = 8) in vec4 a_matWorld1;\nlayout(location = 9) in vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nlayout(location = 10) in vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 11) in vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\n#endif\n#if CC_USE_MORPH\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 7) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 8) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 9) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 6) uniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 0) uniform BloomUBO {\nmediump vec4 texSize;\n};\nlayout(set = 1, binding = 1) uniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nlayout(location = 6) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(location = 7) in vec4 a_matWorld0;\nlayout(location = 8) in vec4 a_matWorld1;\nlayout(location = 9) in vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nlayout(location = 10) in vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 11) in vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\n#endif\n#if CC_USE_MORPH\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 7) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 8) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 9) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 6) uniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 0) uniform BloomUBO {\nmediump vec4 texSize;\n};\nlayout(set = 1, binding = 1) uniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nlayout(location = 6) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(location = 7) in vec4 a_matWorld0;\nlayout(location = 8) in vec4 a_matWorld1;\nlayout(location = 9) in vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nlayout(location = 10) in vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 11) in vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\n#endif\n#if CC_USE_MORPH\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 7) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 8) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 9) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 6) uniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 0) uniform BloomUBO {\nmediump vec4 texSize;\n};\nlayout(set = 1, binding = 1) uniform sampler2D outputResultMap;\nlayout(set = 1, binding = 2) uniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nlayout(location = 6) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(location = 7) in vec4 a_matWorld0;\nlayout(location = 8) in vec4 a_matWorld1;\nlayout(location = 9) in vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nlayout(location = 10) in vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 11) in vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform highp sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nlayout(set = 0, binding = 6) uniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(set = 1, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(set = 1, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(set = 1, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\ncoord.z);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nlayout(location = 0) in vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(set = 1, binding = 0, input_attachment_index = 0) uniform subpassInput gbuffer_albedoMap;\nlayout(set = 1, binding = 1, input_attachment_index = 1) uniform subpassInput gbuffer_normalMap;\nlayout(set = 1, binding = 2, input_attachment_index = 2) uniform subpassInput gbuffer_emissiveMap;\nlayout(set = 1, binding = 3, input_attachment_index = 3) uniform subpassInput depth_stencil;\n#else\nlayout(set = 1, binding = 0) uniform sampler2D gbuffer_albedoMap;\nlayout(set = 1, binding = 1) uniform sampler2D gbuffer_normalMap;\nlayout(set = 1, binding = 2) uniform sampler2D gbuffer_emissiveMap;\nlayout(set = 1, binding = 3) uniform sampler2D depth_stencil;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = subpassLoad(gbuffer_albedoMap);\nvec4 normalMap = subpassLoad(gbuffer_normalMap);\nvec4 emissiveMap = subpassLoad(gbuffer_emissiveMap);\nfloat depth = subpassLoad(depth_stencil).x;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\nfloat depth = texture(depth_stencil, v_uv).x;\n#endif\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.specularIntensity = 0.5;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nfragColor = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nlayout(location = 6) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(location = 7) in vec4 a_matWorld0;\nlayout(location = 8) in vec4 a_matWorld1;\nlayout(location = 9) in vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nlayout(location = 10) in vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 11) in vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\n#endif\n#if CC_USE_MORPH\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 7) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 8) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 9) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 6) uniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(location = 0) out float v_dist;\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nlayout(location = 0) in float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nlayout(location = 6) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(location = 7) in vec4 a_matWorld0;\nlayout(location = 8) in vec4 a_matWorld1;\nlayout(location = 9) in vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nlayout(location = 10) in vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 11) in vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\n#endif\n#if CC_USE_MORPH\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 7) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 8) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 9) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 6) uniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 0) uniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nlayout(location = 6) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(location = 7) in vec4 a_matWorld0;\nlayout(location = 8) in vec4 a_matWorld1;\nlayout(location = 9) in vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nlayout(location = 10) in vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 11) in vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\n#endif\nlayout(location = 0) out mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(location = 0) in mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 offset;\n};\nlayout(set = 1, binding = 1) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(location = 0) in vec2 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 1) uniform Factor {\nfloat u_percent;\n};\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},Mf=t("builtinResMgr",l.builtinResMgr=new class{constructor(){this._device=null,this._resources={}}initBuiltinRes(t){this._device=t;const e=this._resources,i=new Uint8Array(16),n=new Uint8Array(16),s=new Uint8Array(16),r=new Uint8Array(16),o=new Uint8Array(16);let a=0;for(let t=0;t<4;t++)i[a]=0,i[a+1]=0,i[a+2]=0,i[a+3]=255,n[a]=0,n[a+1]=0,n[a+2]=0,n[a+3]=0,s[a]=119,s[a+1]=119,s[a+2]=119,s[a+3]=255,r[a]=255,r[a+1]=255,r[a+2]=255,r[a+3]=255,o[a]=127,o[a+1]=127,o[a+2]=255,o[a+3]=255,a+=4;const c=new Uint8Array(1024);a=0;for(let t=0;t<256;t++)c[a]=221,c[a+1]=221,c[a+2]=221,c[a+3]=255,a+=4;a=0;for(let t=0;t<8;t++){for(let t=0;t<8;t++)c[a]=85,c[a+1]=85,c[a+2]=85,c[a+3]=255,a+=4;a+=32}a+=32;for(let t=0;t<8;t++){for(let t=0;t<8;t++)c[a]=85,c[a+1]=85,c[a+2]=85,c[a+3]=255,a+=4;a+=32}const h={width:2,height:2,_data:i,_compressed:!1,format:xf.PixelFormat.RGBA8888},_={width:2,height:2,_data:n,_compressed:!1,format:xf.PixelFormat.RGBA8888},u={width:2,height:2,_data:s,_compressed:!1,format:xf.PixelFormat.RGBA8888},d={width:2,height:2,_data:r,_compressed:!1,format:xf.PixelFormat.RGBA8888},m={width:2,height:2,_data:o,_compressed:!1,format:xf.PixelFormat.RGBA8888},p={width:16,height:16,_data:c,_compressed:!1,format:xf.PixelFormat.RGBA8888},f=new rf(h),g=new xf;g._uuid="black-texture",g.image=f,e[g._uuid]=g;const v=new rf(_),y=new xf;y._uuid="empty-texture",y.image=v,e[y._uuid]=y;const x=new wf;x._uuid="black-cube-texture",x.setMipFilter(wf.Filter.NEAREST),x.image={front:new rf(h),back:new rf(h),left:new rf(h),right:new rf(h),top:new rf(h),bottom:new rf(h)},e[x._uuid]=x;const S=new rf(u),C=new xf;C._uuid="grey-texture",C.image=S,e[C._uuid]=C;const A=new rf(d),b=new xf;b._uuid="white-texture",b.image=A,e[b._uuid]=b;const T=new wf;T._uuid="white-cube-texture",T.setMipFilter(wf.Filter.NEAREST),T.image={front:new rf(d),back:new rf(d),left:new rf(d),right:new rf(d),top:new rf(d),bottom:new rf(d)},e[T._uuid]=T;const E=new rf(m),P=new xf;P._uuid="normal-texture",P.image=E,e[P._uuid]=P;const w=new rf(p),I=new xf;I._uuid="default-texture",I.image=w,e[I._uuid]=I;const R=new wf;if(R.setMipFilter(wf.Filter.NEAREST),R._uuid="default-cube-texture",R.image={front:new rf(p),back:new rf(p),left:new rf(p),right:new rf(p),top:new rf(p),bottom:new rf(p)},e[R._uuid]=R,l.SpriteFrame){const t=new l.SpriteFrame,i=f,n=new xf;n.image=i,t.texture=n,t._uuid="default-spriteframe",e[t._uuid]=t}const D=bp(t);if(!D)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));const M=Df[D];return M?Promise.resolve().then((()=>{Rf.forEach(((t,e)=>{const i=Object.assign(new l.EffectAsset,t);i.shaders.forEach(((t,i)=>{const n=M[e][i];n&&(t[D]=n)})),i.hideInEditor=!0,i.onLoaded()})),this._initMaterials()})):Promise.reject(Error(`Current device is requiring builtin shaders of version ${D} but shaders of that version are not assembled in this build.`))}get(t){return this._resources[t]}_initMaterials(){const t=this._resources,e=[],i=new l.Material;i._uuid="standard-material",i.initialize({effectName:"standard"}),t[i._uuid]=i,e.push(i);const n=new l.Material;n._uuid="missing-effect-material",n.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),n.setProperty("mainColor",l.color("#ffff00")),t[n._uuid]=n,e.push(n);const s=new l.Material;s._uuid="missing-material",s.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),s.setProperty("mainColor",l.color("#ff00ff")),t[s._uuid]=s,e.push(s);const r=new l.Material;r._uuid="default-clear-stencil",r.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),t[r._uuid]=r,e.push(r);const o=new l.Material;o._uuid="ui-base-material",o.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),t[o._uuid]=o,e.push(o);const a=new l.Material;a._uuid="ui-sprite-material",a.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[a._uuid]=a,e.push(a);const c=new l.Material;c._uuid="ui-alpha-test-material",c.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[c._uuid]=c,e.push(c);const h=new l.Material;h._uuid="ui-sprite-gray-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),t[h._uuid]=h,e.push(h);const _=new l.Material;_._uuid="ui-sprite-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),t[_._uuid]=_,e.push(_);const u=new l.Material;u._uuid="ui-sprite-gray-alpha-sep-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),t[u._uuid]=u,e.push(u);const d=new l.Material;d._uuid="ui-graphics-material",d.initialize({effectName:"graphics"}),t[d._uuid]=d,e.push(d);const m=new l.Material;m._uuid="default-particle-material",m.initialize({effectName:"particle"}),t[m._uuid]=m,e.push(m);{const i=new l.Material;i._uuid="default-particle-gpu-material",i.initialize({effectName:"particle-gpu"}),t[i._uuid]=i,e.push(i)}const p=new l.Material;p._uuid="default-trail-material",p.initialize({effectName:"particle-trail"}),t[p._uuid]=p,e.push(p);const f=new l.Material;f._uuid="default-billboard-material",f.initialize({effectName:"billboard"}),t[f._uuid]=f,e.push(f);const g=new l.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),t[g._uuid]=g,e.push(g),l.game.on(l.Game.EVENT_GAME_INITED,(()=>{for(let t=0;t<e.length;++t){const i=e[t];for(let t=0;t<i.passes.length;++t)i.passes[t].tryCompile()}}))}}),Of=(()=>{const t=new Map;let e=0;return i=>"number"==typeof i?i:(t.has(i)||(t.set(i,1<<e),e++),t.get(i))})();class Bf{constructor(t){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}destroy(){for(let t=0;t<this.instances.length;++t){const e=this.instances[t];e.vb.destroy(),e.ia.destroy()}this.instances.length=0}merge(t,e,i,n=null){const s=e.buffer.length;if(!s)return;const r=t.inputAssembler,o=t.descriptorSet.getTexture(jm);let a=n;a||(a=t.shaders[i]);const c=t.descriptorSet;for(let t=0;t<this.instances.length;++t){const i=this.instances[t];if(!(i.ia.indexBuffer!==r.indexBuffer||i.count>=1024)&&i.lightingMap===o&&i.stride===s){if(i.count>=i.capacity){i.capacity<<=1;const t=i.stride*i.capacity,e=i.data;i.data=new Uint8Array(t),i.data.set(e),i.vb.resize(t)}return i.shader!==a&&(i.shader=a),i.descriptorSet!==c&&(i.descriptorSet=c),i.data.set(e.buffer,i.stride*i.count++),void(this.hasPendingModels=!0)}}const l=this._device.createBuffer(new Zn(en.VERTEX|en.TRANSFER_DST,rn.HOST|rn.DEVICE,32*s,s)),h=new Uint8Array(32*s),_=r.vertexBuffers.slice(),u=r.attributes.slice(),d=r.indexBuffer;for(let t=0;t<e.attributes.length;t++){const i=e.attributes[t],n=new fs(i.name,i.format,i.isNormalized,_.length,!0);u.push(n)}h.set(e.buffer),_.push(l);const m=new vs(u,_,d),p=this._device.createInputAssembler(m);this.instances.push({count:1,capacity:32,vb:l,data:h,ia:p,stride:s,shader:a,descriptorSet:c,lightingMap:o}),this.hasPendingModels=!0}uploadBuffers(t){for(let e=0;e<this.instances.length;++e){const i=this.instances[e];i.count&&(i.ia.instanceCount=i.count,t.updateBuffer(i.vb,i.data))}}clear(){for(let t=0;t<this.instances.length;++t)this.instances[t].count=0;this.hasPendingModels=!1}}class Nf{constructor(t){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=t.device}destroy(){for(let t=0;t<this.batches.length;++t){const e=this.batches[t];for(let t=0;t<e.vbs.length;++t)e.vbs[t].destroy();e.vbIdx.destroy(),e.ia.destroy(),e.ubo.destroy()}this.batches.length=0}merge(t,e,i){const n=t.subMesh.flatBuffers;if(0===n.length)return;let s=0,r=0;const o=n[0].count,a=t.passes[e],c=t.shaders[e],l=t.descriptorSet;let h=!1;for(let t=0;t<this.batches.length;++t){const e=this.batches[t];if(e.vbs.length===n.length&&e.mergeCount<Tm.BATCHING_COUNT){h=!0;for(let t=0;t<e.vbs.length;++t)if(e.vbs[t].stride!==n[t].stride){h=!1;break}if(h){for(let t=0;t<e.vbs.length;++t){const i=n[t],r=e.vbs[t],a=e.vbDatas[t];s=(o+e.vbCount)*i.stride,s>r.size&&(r.resize(s),e.vbDatas[t]=new Uint8Array(s),e.vbDatas[t].set(a)),e.vbDatas[t].set(i.buffer,e.vbCount*i.stride)}let t=e.vbIdxData;r=4*(o+e.vbCount),r>e.vbIdx.size&&(e.vbIdx.resize(r),e.vbIdxData=new Float32Array(r/Float32Array.BYTES_PER_ELEMENT),e.vbIdxData.set(t),t=e.vbIdxData);const h=e.vbCount,_=h+o,u=e.mergeCount;if(t[h]!==u||t[_-1]!==u)for(let e=h;e<_;e++)t[e]=u+.1;return Ii.toArray(e.uboData,i.transform.worldMatrix,Tm.MAT_WORLDS_OFFSET+16*e.mergeCount),e.mergeCount||(l.bindBuffer(Tm.BINDING,e.ubo),l.update(),e.pass=a,e.shader=c,e.descriptorSet=l),++e.mergeCount,e.vbCount+=o,void(e.ia.vertexCount+=o)}}}const _=[],u=[],d=[];for(let t=0;t<n.length;++t){const e=n[t],i=this._device.createBuffer(new Zn(en.VERTEX|en.TRANSFER_DST,rn.HOST|rn.DEVICE,e.count*e.stride,e.stride));i.update(e.buffer.buffer),_.push(i),u.push(new Uint8Array(i.size)),d.push(i)}const m=this._device.createBuffer(new Zn(en.VERTEX|en.TRANSFER_DST,rn.HOST|rn.DEVICE,4*o,4)),p=new Float32Array(o);p.fill(0),m.update(p),d.push(m);const f=t.inputAssembler.attributes,g=new Array(f.length+1);for(let t=0;t<f.length;++t)g[t]=f[t];g[f.length]=new fs("a_dyn_batch_id",Zi.R32F,!1,n.length);const v=new vs(g,d),y=this._device.createInputAssembler(v),x=this._device.createBuffer(new Zn(en.UNIFORM|en.TRANSFER_DST,rn.HOST|rn.DEVICE,Tm.SIZE,Tm.SIZE));l.bindBuffer(Tm.BINDING,x),l.update();const S=new Float32Array(Tm.COUNT);Ii.toArray(S,i.transform.worldMatrix,Tm.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:_,vbDatas:u,vbIdx:m,vbIdxData:p,vbCount:o,ia:y,ubo:x,uboData:S,pass:a,shader:c,descriptorSet:l})}clear(){for(let t=0;t<this.batches.length;++t){const e=this.batches[t];e.vbCount=0,e.mergeCount=0,e.ia.vertexCount=0}}}const Lf=new Zn(en.UNIFORM|en.TRANSFER_DST,rn.DEVICE),Ff=new Qn(null),zf=new Is(null);let Vf;!function(t){t[t.NONE=0]="NONE",t[t.INSTANCING=1]="INSTANCING",t[t.VB_MERGING=2]="VB_MERGING"}(Vf||(Vf={}));class Gf{static fillPipelineInfo(t,e){void 0!==e.priority&&t._setPriority(e.priority),void 0!==e.primitive&&t._setPrimitive(e.primitive),void 0!==e.stage&&t._setStage(e.stage),void 0!==e.dynamicStates&&t._setDynamicState(e.dynamicStates),void 0!==e.phase&&t._setPhase(Of(e.phase));const i=t._bs;if(e.blendState){const t=e.blendState,{targets:n}=t;n&&n.forEach(((t,e)=>{i.setTarget(e,t)})),void 0!==t.isA2C&&(i.isA2C=t.isA2C),void 0!==t.isIndepend&&(i.isIndepend=t.isIndepend),void 0!==t.blendColor&&(i.blendColor=t.blendColor)}t._rs.assign(e.rasterizerState),t._dss.assign(e.depthStencilState)}static getPassHash(t){let e=`${Tp.getKey(t.program,t.defines)},${t._primitive},${t._dynamicStates}`;var i;return e+=function(t){let e=`,bs,${t.isA2C}`;for(const i of t.targets)e+=`,bt,${i.blend},${i.blendEq},${i.blendAlphaEq},${i.blendColorMask}`,e+=`,${i.blendSrc},${i.blendDst},${i.blendSrcAlpha},${i.blendDstAlpha}`;return e}(t._bs),e+=function(t){let e=`,dss,${t.depthTest},${t.depthWrite},${t.depthFunc}`;return e+=`,${t.stencilTestFront},${t.stencilFuncFront},${t.stencilRefFront},${t.stencilReadMaskFront}`,e+=`,${t.stencilFailOpFront},${t.stencilZFailOpFront},${t.stencilPassOpFront},${t.stencilWriteMaskFront}`,e+=`,${t.stencilTestBack},${t.stencilFuncBack},${t.stencilRefBack},${t.stencilReadMaskBack}`,e+=`,${t.stencilFailOpBack},${t.stencilZFailOpBack},${t.stencilPassOpBack},${t.stencilWriteMaskBack}`,e}(t._dss),e+=`,rs,${(i=t._rs).cullMode},${i.depthBias},${i.isFrontFaceCCW}`,ur(e,666)}get native(){return this._nativeObj}constructor(t){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new Er,this._dss=new wr,this._rs=new Pr,this._priority=Jd.DEFAULT,this._stage=Kd.DEFAULT,this._phase=Of("default"),this._primitive=Tn.TRIANGLE_LIST,this._batchingScheme=Vf.NONE,this._dynamicStates=In.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=t,this._device=t.device}initialize(t){this._doInit(t),this.resetUBOs(),this.resetTextures(),this.tryCompile()}getHandle(t,e=0,i=tn.UNKNOWN){let n=this._propertyHandleMap[t];return n?(i?n=up(n,i):e&&(n=up(n,cp(n)-e)),n+e):0}getBinding(t){const e=this.getHandle(t);return e?Gf.getBindingFromHandle(e):-1}setUniform(t,e){const i=Gf.getBindingFromHandle(t),n=Gf.getTypeFromHandle(t),s=Gf.getOffsetFromHandle(t),r=this._getBlockView(n,i);mp[n](r,e,s),this._setRootBufferDirty(!0)}getUniform(t,e){const i=Gf.getBindingFromHandle(t),n=Gf.getTypeFromHandle(t),s=Gf.getOffsetFromHandle(t),r=this._getBlockView(n,i);return dp[n](r,e,s)}setUniformArray(t,e){const i=Gf.getBindingFromHandle(t),n=Gf.getTypeFromHandle(t),s=Ys(n)>>2,r=this._getBlockView(n,i);let o=Gf.getOffsetFromHandle(t);for(let t=0;t<e.length;t++,o+=s)null!==e[t]&&mp[n](r,e[t],o);this._setRootBufferDirty(!0)}bindTexture(t,e,i){this._descriptorSet.bindTexture(t,e,i||0)}bindSampler(t,e,i){this._descriptorSet.bindSampler(t,e,i||0)}setDynamicState(t,e){const i=this._dynamics[t];i&&i.value===e||(i.value=e,i.dirty=!0)}overridePipelineStates(t,e){console.warn("base pass cannot override states, please use pass instance instead.")}_setRootBufferDirty(t){this._rootBufferDirty=t,this._nativeObj.setRootBufferDirty(t)}update(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update(),this._nativeObj.update()):D(12006)}getInstancedBuffer(t=0){return this._instancedBuffers[t]||(this._instancedBuffers[t]=new Bf(this))}getBatchedBuffer(t=0){return this._batchedBuffers[t]||(this._batchedBuffers[t]=new Nf(this))}_initNative(){this._nativeObj||(this._nativeObj=new ba,this._passHandle=ea.alloc(),this._nativePriority=ea.getTypedArray(this._passHandle,Zo.PRIORITY),this._nativeStage=ea.getTypedArray(this._passHandle,Zo.STAGE),this._nativePhase=ea.getTypedArray(this._passHandle,Zo.PHASE),this._nativePrimitive=ea.getTypedArray(this._passHandle,Zo.PRIMITIVE),this._nativeBatchingScheme=ea.getTypedArray(this._passHandle,Zo.BATCHING_SCHEME),this._nativeDynamicStates=ea.getTypedArray(this._passHandle,Zo.DYNAMIC_STATE),this._nativeHash=ea.getTypedArray(this._passHandle,Zo.HASH),this._nativeObj.initWithData(ea.getBuffer(this._passHandle)))}_destroy(){this._nativeObj=null,this._passHandle&&ea.free(this._passHandle)}destroy(){for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t];this._buffers[e.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null);for(const t in this._instancedBuffers)this._instancedBuffers[t].destroy();for(const t in this._batchedBuffers)this._batchedBuffers[t].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()}resetUniform(t){const e=this.getHandle(t);if(!e)return;const i=Gf.getTypeFromHandle(e),n=Gf.getBindingFromHandle(e),s=Gf.getOffsetFromHandle(e),r=Gf.getCountFromHandle(e),o=this._getBlockView(i,n),a=this._properties[t],c=a&&a.value||fp(i),l=(Ys(i)>>2)*r;for(let t=0;t+c.length<=l;t+=c.length)o.set(c,s+t);this._setRootBufferDirty(!0)}resetTexture(t,e){const i=this.getHandle(t);if(!i)return;const n=Gf.getTypeFromHandle(i),s=Gf.getBindingFromHandle(i),r=this._properties[t],o=r&&r.value,a=o?`${o}-texture`:fp(n),c=Mf.get(a),l=c&&c.getGFXTexture(),h=r&&void 0!==r.samplerHash?xr.unpackFromHash(r.samplerHash):c&&c.getSamplerInfo(),_=this._device.getSampler(h);this._descriptorSet.bindSampler(s,_,e),this._descriptorSet.bindTexture(s,l,e)}resetUBOs(){for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t];let i=0;for(let t=0;t<e.members.length;t++){const n=e.members[t],s=this._getBlockView(n.type,e.binding),r=this._properties[n.name],o=r&&r.value||fp(n.type),a=(Ys(n.type)>>2)*n.count;for(let t=0;t+o.length<=a;t+=o.length)s.set(o,i+t);i+=a}}this._setRootBufferDirty(!0)}resetTextures(){for(let t=0;t<this._shaderInfo.samplerTextures.length;t++){const e=this._shaderInfo.samplerTextures[t];for(let t=0;t<e.count;t++)this.resetTexture(e.name,t)}}tryCompile(){const{pipeline:t}=this._root;if(!t)return!1;this._syncBatchingScheme();const e=Tp.getGFXShader(this._device,this._programName,this._defines,t);return e?(this._shader=e,this._setPipelineLayout(Tp.getTemplateInfo(this._programName).pipelineLayout),this._setHash(Gf.getPassHash(this)),!0):(console.warn(`create shader ${this._programName} failed`),!1)}getShaderVariant(t=null){if(!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!t)return this._shader;const{pipeline:e}=this._root;for(let e=0;e<t.length;e++){const i=t[e];this._defines[i.name]=i.value}const i=Tp.getGFXShader(this._device,this._programName,this._defines,e);for(let e=0;e<t.length;e++){const i=t[e];delete this._defines[i.name]}return i}beginChangeStatesSilently(){}endChangeStatesSilently(){}_setPriority(t){this._priority=t,this._nativePriority[0]=t}_setStage(t){this._stage=t,this._nativeStage[0]=t}_setPhase(t){this._phase=t,this._nativePhase[0]=t}_setPrimitive(t){this._primitive=t,this._nativePrimitive[0]=t}_setState(t,e,i,n){this._bs=t,this._dss=e,this._rs=i,this._descriptorSet=n,this._nativeObj.blendState=t.native,this._nativeObj.depthStencilState=e.native,this._nativeObj.rasterizerState=i.native,this._nativeObj.descriptorSet=n}_doInit(t,e=!1){this._initNative(),this._setPriority(Jd.DEFAULT),this._setStage(Kd.DEFAULT),this._setPhase(Of("default")),this._setPrimitive(Tn.TRIANGLE_LIST),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=e?{...t.defines}:t.defines,this._shaderInfo=Tp.getTemplate(t.program),this._properties=t.properties||this._properties;const i=this._device;Gf.fillPipelineInfo(this,t),t.stateOverrides&&Gf.fillPipelineInfo(this,t.stateOverrides),zf.layout=Tp.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(zf),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);const n=this._shaderInfo.blocks,s=Tp.getTemplateInfo(t.program),{blockSizes:r,handleMap:o}=s,a=i.capabilities.uboOffsetAlignment,c=[];let l=0,h=0;for(let t=0;t<n.length;t++){const e=r[t];c.push(h),h+=Math.ceil(e/a)*a,l=e}const _=c[c.length-1]+l;_&&(Lf.size=16*Math.ceil(_/16),this._rootBuffer=i.createBuffer(Lf),this._rootBlock=new ArrayBuffer(_),this._nativeObj.setRootBufferAndBlock(this._rootBuffer,this._rootBlock));for(let t=0,e=0;t<n.length;t++){const{binding:s}=n[t],o=r[t];Ff.buffer=this._rootBuffer,Ff.offset=c[e++],Ff.range=16*Math.ceil(o/16);const a=this._buffers[s]=i.createBuffer(Ff);this._blocks[s]=new Float32Array(this._rootBlock,Ff.offset,o/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[s]=new Int32Array(this._blocks[s].buffer,this._blocks[s].byteOffset,this._blocks[s].length),this._descriptorSet.bindBuffer(s,a)}const u=this._propertyHandleMap=o,d={};for(const t in this._properties){const e=this._properties[t];e.handleInfo&&(d[t]=this.getHandle.apply(this,e.handleInfo))}Object.assign(u,d)}_syncBatchingScheme(){this._defines.USE_INSTANCING?this._device.hasFeature($i.INSTANCED_ARRAYS)?this._setBatchingScheme(Vf.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Vf.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(Vf.VB_MERGING):this._setBatchingScheme(Vf.NONE)}_setBatchingScheme(t){this._batchingScheme=t,this._nativeBatchingScheme[0]=t}_setDynamicState(t){this._dynamicStates=t,this._nativeDynamicStates[0]=t}_setHash(t){this._hash=t,this._nativeHash[0]=t}_getBlockView(t,e){return t<tn.FLOAT?this._blocksInt[e]:this._blocks[e]}_setPipelineLayout(t){this._pipelineLayout=t,this._nativeObj.setPipelineLayout(t)}_initPassFromTarget(t,e,i,n){this._initNative(),this._setPriority(t.priority),this._setStage(t.stage),this._setPhase(t.phase),this._setBatchingScheme(t.batchingScheme),this._setPrimitive(t.primitive),this._setDynamicState(t.dynamicStates),this._setState(i,e,t.rasterizerState,t.descriptorSet),this._passIndex=t.passIndex,this._propertyIndex=t.propertyIndex,this._programName=t.program,this._defines=t.defines,this._shaderInfo=t._shaderInfo,this._properties=t._properties,this._blocks=t._blocks,this._blocksInt=t._blocksInt,this._dynamics=t._dynamics,this._shader=t._shader,this._setPipelineLayout(Tp.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t._hash^n)}get root(){return this._root}get device(){return this._device}get shaderInfo(){return this._shaderInfo}get localSetLayout(){return Tp.getDescriptorSetLayout(this._device,this._programName,!0)}get program(){return this._programName}get properties(){return this._properties}get defines(){return this._defines}get passIndex(){return this._passIndex}get propertyIndex(){return this._propertyIndex}get dynamics(){return this._dynamics}get blocks(){return this._blocks}get blocksInt(){return this._blocksInt}get rootBufferDirty(){return this._rootBufferDirty}get priority(){return this._priority}get primitive(){return this._primitive}get stage(){return this._stage}get phase(){return this._phase}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get dynamicStates(){return this._dynamicStates}get batchingScheme(){return this._batchingScheme}get descriptorSet(){return this._descriptorSet}get hash(){return this._hash}get pipelineLayout(){return this._pipelineLayout}}Gf.getTypeFromHandle=cp,Gf.getBindingFromHandle=lp,Gf.getCountFromHandle=hp,Gf.getOffsetFromHandle=_p;class Uf{static getOrCreatePipelineState(t,e,i,n,s){const r=e.hash^n.hash^s.attributesHash^i.typedID;let o=this._PSOHashMap.get(r);if(!o){const a=e.pipelineLayout,c=new Ds(s.attributes),l=new Rr(i,a,n,c,e.rasterizerState,e.depthStencilState,e.blendState,e.primitive,e.dynamicStates);o=t.createPipelineState(l),this._PSOHashMap.set(r,o)}return o}}function kf(t,e){t.x=e.x*e.x,t.y=e.y*e.y,t.z=e.z*e.z}var Hf,jf,Wf,qf,Xf,Yf,Kf,Jf,$f;Uf._PSOHashMap=new Map;const Zf=new Fi;let Qf,tg,eg,ig,ng,sg=t("Material",(Hf=dc("cc.Material"),jf=Kc(Bp),Hf((Xf=sc((qf=class t extends fh{static getHash(t){let e=0;for(const i of t.passes)e^=i.hash;return e}constructor(){super(),nc(this,"_effectAsset",Xf,this),nc(this,"_techIdx",Yf,this),nc(this,"_defines",Kf,this),nc(this,"_states",Jf,this),nc(this,"_props",$f,this),this._passes=[],this._hash=0}get effectAsset(){return this._effectAsset}get effectName(){return this._effectAsset?this._effectAsset.name:""}get technique(){return this._techIdx}get passes(){return this._passes}get hash(){return this._hash}get parent(){return null}get owner(){return null}initialize(t){this._passes.length?I(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(t),this._update())}reset(t){this.initialize(t)}destroy(){return this._doDestroy(),super.destroy()}recompileShaders(t,e){console.warn(`Shaders in material asset '${this.name}' cannot be modified at runtime, please instantiate the material first.`)}overridePipelineStates(t,e){console.warn(`Pipeline states in material asset '${this.name}' cannot be modified at runtime, please instantiate the material first.`)}onLoaded(){this._update()}resetUniforms(t=!0){this._props.length=this._passes.length;for(let t=0;t<this._props.length;t++)this._props[t]={};if(t)for(const t of this._passes)t.resetUBOs(),t.resetTextures()}setProperty(t,e,i){let n=!1;if(void 0===i){const i=this._passes,s=i.length;for(let r=0;r<s;r++){const s=i[r];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,n=!0)}}else{if(i>=this._passes.length)return void console.warn(`illegal pass index: ${i}.`);const s=this._passes[i];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,n=!0)}n||console.warn(`illegal property name: ${t}.`)}getProperty(t,e){if(void 0===e){const e=this._props,i=e.length;for(let n=0;n<i;n++){const i=e[n];if(t in i)return i[t]}}else{if(e>=this._props.length)return console.warn(`illegal pass index: ${e}.`),null;const i=this._props[this._passes[e].propertyIndex];if(t in i)return i[t]}return null}copy(t,e){this._techIdx=t._techIdx,this._props.length=t._props.length;for(let e=0;e<t._props.length;e++)this._props[e]={...t._props[e]};this._defines.length=t._defines.length;for(let e=0;e<t._defines.length;e++)this._defines[e]={...t._defines[e]};this._states.length=t._states.length;for(let e=0;e<t._states.length;e++)this._states[e]={...t._states[e]};this._effectAsset=t._effectAsset,e&&this._fillInfo(e),this._update()}_fillInfo(t){void 0!==t.technique&&(this._techIdx=t.technique),t.effectAsset?this._effectAsset=t.effectAsset:t.effectName&&(this._effectAsset=Bp.get(t.effectName)),t.defines&&this._prepareInfo(t.defines,this._defines),t.states&&this._prepareInfo(t.states,this._states)}_prepareInfo(t,e){let i=t;if(!Array.isArray(i)){const t=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;i=Array(t).fill(i)}for(let t=0;t<i.length;++t)Object.assign(e[t]||(e[t]={}),i[t])}_createPasses(){const t=this._effectAsset.techniques[this._techIdx||0];if(!t)return[];const e=t.passes.length,i=[];for(let n=0;n<e;++n){const e=t.passes[n],s=e.passIndex=n,r=e.defines=this._defines[s]||(this._defines[s]={});if(e.stateOverrides=this._states[s]||(this._states[s]={}),void 0!==e.propertyIndex&&Object.assign(r,this._defines[e.propertyIndex]),void 0!==e.embeddedMacros&&Object.assign(r,e.embeddedMacros),e.switch&&!r[e.switch])continue;const o=new Gf(l.director.root);o.initialize(e),i.push(o)}return i}_update(e=!0){if(this._effectAsset){this._passes=this._createPasses();const t=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=t,e)this._passes.forEach(((t,e)=>{let i=this._props[e];i||(i=this._props[e]={}),void 0!==t.propertyIndex&&Object.assign(i,this._props[t.propertyIndex]);for(const e in i)this._uploadProperty(t,e,i[e])}));else for(let t=0;t<this._props.length;t++)this._props[t]={}}this._hash=t.getHash(this)}_uploadProperty(t,e,i){const n=t.getHandle(e);if(!n)return!1;if(Gf.getTypeFromHandle(n)<tn.SAMPLER1D)if(Array.isArray(i))t.setUniformArray(n,i);else if(null!==i){var s;if(null===(s=t.properties[e])||void 0===s?void 0:s.linear){const t=i;kf(Zf,t),Zf.w=t.w,i=Zf}t.setUniform(n,i)}else t.resetUniform(e);else if(Array.isArray(i))for(let e=0;e<i.length;e++)this._bindTexture(t,n,i[e],e);else i?this._bindTexture(t,n,i):t.resetTexture(e);return!0}_bindTexture(t,e,i,n){const s=Gf.getBindingFromHandle(e);if(i instanceof yr)t.bindTexture(s,i,n);else if(i instanceof Zp){const e=i.getGFXTexture();if(!e||!e.width||!e.height)return;t.bindTexture(s,e,n),t.bindSampler(s,i.getGFXSampler(),n)}}_doDestroy(){if(this._passes&&this._passes.length)for(const t of this._passes)t.destroy();this._passes.length=0}initDefault(t){super.initDefault(t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0},technique:0}),this.setProperty("mainColor",new hi("#ff00ff"))}validate(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0}}).prototype,"_effectAsset",[jf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yf=sc(qf.prototype,"_techIdx",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kf=sc(qf.prototype,"_defines",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jf=sc(qf.prototype,"_states",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$f=sc(qf.prototype,"_props",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wf=qf))||Wf));l.Material=sg,function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(Qf||(Qf={})),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}(tg||(tg={})),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}(eg||(eg={})),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(ig||(ig={})),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(ng||(ng={}));const rg=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],og=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],ag=[100,200,400,800],cg=new mi,lg=new mi,hg=new Ii,_g=Nn.STENCIL<<1,ug=[];class dg{static get standardExposureValue(){return 1/38400}static get standardLightMeterScale(){return 1e4}get name(){return this._name}get scene(){return this._scene}set node(t){this._node=t,this._nativeObj.node=this._node.native}get node(){return this._node}set window(t){this._window=t,t&&(this._nativeObj.window=this._window.native)}get window(){return this._window}set enabled(t){this._enabled=t}get enabled(){return this._enabled}set visibility(t){this._visibility=t,this._nativeObj.visibility=this._visibility}get visibility(){return this._visibility}get priority(){return this._priority}set priority(t){this._priority=t}get width(){return this._width}get height(){return this._height}set position(t){this._position=t,this._nativeObj.position=this._position}get position(){return this._position}set forward(t){this._forward=t,this._nativeObj.forward=this._forward}get forward(){return this._forward}set aperture(t){this._aperture=t,this._apertureValue=rg[this._aperture],this.updateExposure()}get aperture(){return this._aperture}get apertureValue(){return this._apertureValue}set shutter(t){this._shutter=t,this._shutterValue=og[this._shutter],this.updateExposure()}get shutter(){return this._shutter}get shutterValue(){return this._shutterValue}set iso(t){this._iso=t,this._isoValue=ag[this._iso],this.updateExposure()}get iso(){return this._iso}get isoValue(){return this._isoValue}get exposure(){return this._exposure}get clearFlag(){return this._clearFlag}set clearFlag(t){this._clearFlag=t,this._nativeObj.clearFlag=t}set clearColor(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w,this._nativeObj.clearColor=this._clearColor}get clearColor(){return this._clearColor}get clearDepth(){return this._clearDepth}set clearDepth(t){this._clearDepth=t,this._nativeObj.clearDepth=t}get clearStencil(){return this._clearStencil}set clearStencil(t){this._clearStencil=t,this._nativeObj.clearStencil=t}set projectionType(t){this._proj=t,this._isProjDirty=!0}get projectionType(){return this._proj}get aspect(){return this._aspect}set orthoHeight(t){this._orthoHeight=t,this._isProjDirty=!0}get orthoHeight(){return this._orthoHeight}set fovAxis(t){this._fovAxis=t,this._isProjDirty=!0}get fovAxis(){return this._fovAxis}set fov(t){this._fov=t,this._nativeObj.fov=t,this._isProjDirty=!0}get fov(){return this._fov}set nearClip(t){this._nearClip=t,this._nativeObj.nearClip=this._nearClip,this._isProjDirty=!0}get nearClip(){return this._nearClip}set farClip(t){this._farClip=t,this._nativeObj.farClip=this._farClip,this._isProjDirty=!0}get farClip(){return this._farClip}get viewport(){return this._viewport}set viewport(t){I(8302),this.setViewportInOrientedSpace(t)}set frustum(t){this._frustum=t,this._nativeObj.frustum=this._frustum}get frustum(){return this._frustum}get matView(){return this._matView}get matProj(){return this._matProj}get matProjInv(){return this._matProjInv}get matViewProj(){return this._matViewProj}get matViewProjInv(){return this._matViewProjInv}get native(){return this._nativeObj}constructor(t){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Qf.VERTICAL,this._fov=Ye(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new Yn(.2,.2,.2,1),this._viewport=new ki(0,0,1,1),this._orientedViewport=new ki(0,0,1,1),this._curTransform=Ji.IDENTITY,this._isProjDirty=!0,this._matView=new Ii,this._matProj=new Ii,this._matProjInv=new Ii,this._matViewProj=new Ii,this._matViewProjInv=new Ii,this._frustum=new qa,this._forward=new mi,this._position=new mi,this._priority=0,this._aperture=eg.F16_0,this._apertureValue=void 0,this._shutter=ng.D125,this._shutterValue=0,this._iso=ig.ISO100,this._isoValue=0,this._window=null,this._width=1,this._height=1,this._clearFlag=Nn.NONE,this._clearDepth=1,this._visibility=ip,this._exposure=0,this._clearStencil=0,this._device=t,this._apertureValue=rg[this._aperture],this._shutterValue=og[this._shutter],this._isoValue=ag[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!ug.length){const e=t.capabilities.clipSpaceSignY;ug[Ji.IDENTITY]=new Ii(1,0,0,0,0,e),ug[Ji.ROTATE_90]=new Ii(0,1,0,0,-e,0),ug[Ji.ROTATE_180]=new Ii(-1,0,0,0,0,-e),ug[Ji.ROTATE_270]=new Ii(0,-1,0,0,e,0)}}_setWidth(t){this._width=t,this._nativeObj.width=t}_setHeight(t){this._height=t,this._nativeObj.height=t}_setScene(t){this._scene=t,this._nativeObj.scene=t?t.native:null}_updateAspect(t=!0){if(this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),t){const t=this.window.swapchain;(t&&t.surfaceTransform||Ji.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0,this._nativeObj.aspect=this._aspect}_init(t){this._nativeObj=new xa,this._scene&&(this._nativeObj.scene=this._scene.native),this._nativeObj.frustum=this._frustum}_destroy(){this._nativeObj=null}initialize(t){this._init(t),this.node=t.node,this._setWidth(1),this._setHeight(1),this.clearFlag=Nn.NONE,this.clearDepth=1,this.visibility=ip,this._name=t.name,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(t.window)}destroy(){this._node=null,this.detachFromScene(),this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()}attachToScene(t){this._enabled=!0,this._setScene(t)}detachFromScene(){this._enabled=!1,this._setScene(null)}resize(t,e){this._window&&(this._setWidth(t),this._setHeight(e),this._updateAspect())}setFixedSize(t,e){this._setWidth(t),this._setHeight(e),this._updateAspect(!1),this.isWindowSize=!1}syncCameraEditor(t){}update(t=!1){var e;if(!this._node)return;let i=!1;(this._node.hasChangedFlags||t)&&(Ii.invert(this._matView,this._node.worldMatrix),this._nativeObj.matView=this._matView,this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),this._nativeObj.position=this._position,this._nativeObj.forward=this._forward,i=!0);const n=null===(e=this.window)||void 0===e?void 0:e.swapchain,s=n&&n.surfaceTransform||Ji.IDENTITY;if(this._isProjDirty||this._curTransform!==s){this._curTransform=s;const t=this._device.capabilities.clipSpaceSignY;if(this._proj===tg.PERSPECTIVE)Ii.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Qf.VERTICAL,this._device.capabilities.clipSpaceMinZ,t,s);else{const e=this._orthoHeight*this._aspect,i=this._orthoHeight;Ii.ortho(this._matProj,-e,e,-i,i,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,t,s)}this._nativeObj.aspect=this._aspect,Ii.invert(this._matProjInv,this._matProj),this._nativeObj.matProj=this._matProj,this._nativeObj.matProjInv=this._matProjInv,i=!0,this._isProjDirty=!1}i&&(Ii.multiply(this._matViewProj,this._matProj,this._matView),Ii.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv),this._nativeObj.matViewProj=this._matViewProj,this._nativeObj.matViewProjInv=this._matViewProjInv,this._nativeObj.frustum=this._frustum)}setViewportInOrientedSpace(t){var e;const{x:i,width:n,height:s}=t,r=this._device.capabilities.screenSpaceSignY<0?1-t.y-s:t.y,o=null===(e=this.window)||void 0===e?void 0:e.swapchain;switch(o&&o.surfaceTransform||Ji.IDENTITY){case Ji.ROTATE_90:this._viewport.x=1-r-s,this._viewport.y=i,this._viewport.width=s,this._viewport.height=n;break;case Ji.ROTATE_180:this._viewport.x=1-i-n,this._viewport.y=1-r-s,this._viewport.width=n,this._viewport.height=s;break;case Ji.ROTATE_270:this._viewport.x=r,this._viewport.y=1-i-n,this._viewport.width=s,this._viewport.height=n;break;case Ji.IDENTITY:this._viewport.x=i,this._viewport.y=r,this._viewport.width=n,this._viewport.height=s}this._orientedViewport.x=i,this._orientedViewport.y=r,this._orientedViewport.width=n,this._orientedViewport.height=s,this._nativeObj.viewPort=this._viewport,this.resize(this.width,this.height)}changeTargetWindow(t=null){this._window&&this._window.detachCamera(this);const e=t||l.director.root.mainWindow;if(e){e.attachCamera(this),this.window=e;const t=e.swapchain;(t&&t.surfaceTransform||Ji.IDENTITY)%2?this.resize(e.height,e.width):this.resize(e.width,e.height)}}detachCamera(){this._window&&this._window.detachCamera(this)}screenPointToRay(t,e,i){if(!this._node)return null;const n=this.width,s=this.height,r=this._orientedViewport.x*n,o=this._orientedViewport.y*s,a=this._orientedViewport.width*n,c=this._orientedViewport.height*s,l=this._proj===tg.PERSPECTIVE,h=this._device.capabilities.clipSpaceSignY,_=wi[this._curTransform];mi.set(cg,(e-r)/a*2-1,(i-o)/c*2-1,l?1:-1);const{x:u,y:d}=cg;return cg.x=u*_[0]+d*_[2]*h,cg.y=u*_[1]+d*_[3]*h,mi.transformMat4(l?cg:t.o,cg,this._matViewProjInv),l?(this._node.getWorldPosition(lg),Wr.fromPoints(t,lg,cg)):mi.transformQuat(t.d,mi.FORWARD,this._node.worldRotation),t}screenToWorld(t,e){const i=this.width,n=this.height,s=this._orientedViewport.x*i,r=this._orientedViewport.y*n,o=this._orientedViewport.width*i,a=this._orientedViewport.height*n,c=this._device.capabilities.clipSpaceSignY,l=wi[this._curTransform];if(this._proj===tg.PERSPECTIVE){mi.set(t,(e.x-s)/o*2-1,(e.y-r)/a*2-1,1);const{x:i,y:n}=t;t.x=i*l[0]+n*l[2]*c,t.y=i*l[1]+n*l[3]*c,mi.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(cg),mi.lerp(t,cg,t,Xe(this._nearClip/this._farClip,1,e.z))}else{mi.set(t,(e.x-s)/o*2-1,(e.y-r)/a*2-1,2*e.z-1);const{x:i,y:n}=t;t.x=i*l[0]+n*l[2]*c,t.y=i*l[1]+n*l[3]*c,mi.transformMat4(t,t,this._matViewProjInv)}return t}worldToScreen(t,e){const i=this._device.capabilities.clipSpaceSignY,n=wi[this._curTransform];mi.transformMat4(t,e,this._matViewProj);const{x:s,y:r}=t;t.x=s*n[0]+r*n[2]*i,t.y=s*n[1]+r*n[3]*i;const o=this.width,a=this.height,c=this._orientedViewport.x*o,l=this._orientedViewport.y*a,h=this._orientedViewport.width*o,_=this._orientedViewport.height*a;return t.x=c+.5*(t.x+1)*h,t.y=l+.5*(t.y+1)*_,t.z=.5*t.z+.5,t}worldMatrixToScreen(t,e,i,n){Ii.multiply(t,this._matViewProj,e),Ii.multiply(t,ug[this._curTransform],t);const s=i/2,r=n/2;return Ii.identity(hg),Ii.transform(hg,hg,mi.set(cg,s,r,0)),Ii.scale(hg,hg,mi.set(cg,s,r,1)),Ii.multiply(t,hg,t),t}setExposure(t){this._exposure=.833333/2**t,this._nativeObj.exposure=this._exposure}updateExposure(){const t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(t)}}const mg=jt({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),pg=jt({Planar:0,ShadowMap:1}),fg=jt({HARD:0,SOFT:1,SOFT_2X:2}),gg=pg.ShadowMap+1;class vg{get enabled(){return this._enabled}set enabled(t){this._setEnable(t),this.activate()}get type(){return this._type}set type(t){this._setType(t),this.activate()}get normal(){return this._normal}set normal(t){mi.copy(this._normal,t),this._nativeObj.normal=this._normal}get distance(){return this._distance}set distance(t){this._distance=t,this._nativeObj.distance=t}get shadowColor(){return this._shadowColor}set shadowColor(t){this._shadowColor=t,this._nativeObj.color=t}get size(){return this._size}set size(t){this._size.set(t),this._nativeObj.size=t}get shadowMapDirty(){return this._shadowMapDirty}set shadowMapDirty(t){this._shadowMapDirty=t,this._nativeObj.shadowMapDirty=t}get matLight(){return this._matLight}get material(){return this._material}get instancingMaterial(){return this._instancingMaterial}get native(){return this._nativeObj}constructor(){this.fixedSphere=new $r(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new Ii,this.matShadowProj=new Ii,this.matShadowViewProj=new Ii,this._enabled=!1,this._type=gg,this._distance=0,this._normal=new mi(0,1,0),this._shadowColor=new hi(0,0,0,76),this._size=new Oi(512,512),this._shadowMapDirty=!1,this._matLight=new Ii,this._material=null,this._instancingMaterial=null,this._nativeObj=new va}getPlanarShader(t){return this._material||(this._material=new sg,this._material.initialize({effectName:"planar-shadow"}),this._nativeObj.planarPass=this._material.passes[0].native),this._material.passes[0].getShaderVariant(t)}getPlanarInstanceShader(t){return this._instancingMaterial||(this._instancingMaterial=new sg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),this._nativeObj.instancePass=this._instancingMaterial.passes[0].native),this._instancingMaterial.passes[0].getShaderVariant(t)}_setEnable(t){this._enabled=t,this._nativeObj.enabled=t,t||this._setType(gg)}_setType(t){this._type=this.enabled?t:gg,this._nativeObj.shadowType=this._type}initialize(t){this._setEnable(t.enabled),this._setType(t.type),this.normal=t.planeDirection,this.distance=t.planeHeight,this.shadowColor=t.shadowColor,this.maxReceived=t.maxReceived,this.size=t.size}activate(){this.enabled&&this.type===pg.Planar&&this._updatePlanarInfo()}_updatePlanarInfo(){this._material||(this._material=new sg,this._material.initialize({effectName:"planar-shadow"}),this._nativeObj.planarPass=this._material.passes[0].native),this._instancingMaterial||(this._instancingMaterial=new sg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),this._nativeObj.instancePass=this._instancingMaterial.passes[0].native)}_destroy(){this._nativeObj=null}destroy(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()}}vg.MAX_FAR=2e3,vg.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),l.Shadows=vg;const yg=new mi,xg=(new mi,new mi,new mi),Sg=new Ii,Cg=new La,Ag=new La;let bg=!1;const Tg=$r.create(0,0,0,1),Eg=new $r,Pg=new qa;Pg.accurate=!0;let wg=new qa;wg.accurate=!0;const Ig=new qa,Rg=new Ii,Dg=new Ii,Mg=new Ii,Og=new Ii,Bg=new Ii,Ng=new Ii,Lg=new Ii,Fg=new mi,zg=new Oi,Vg=new mi,Gg=new mi,Ug=new mi(0,0,0),kg=(new La,new Ml((()=>({model:null,depth:0})),128)),Hg=new Ml((()=>({model:null,depth:0})),128),jg=new Ml((()=>({model:null,depth:0})),128);function Wg(t,e){let i=0;t.node&&(mi.subtract(yg,t.node.worldPosition,e.position),i=mi.dot(yg,e.forward));const n=kg.alloc();return n.model=t,n.depth=i,n}function qg(t,e){let i=0;t.node&&(mi.subtract(yg,t.node.worldPosition,e.position),i=mi.dot(yg,e.forward));const n=Hg.alloc();return n.model=t,n.depth=i,n}function Xg(t,e){let i=0;t.node&&(mi.subtract(yg,t.node.worldPosition,e.position),i=mi.dot(yg,e.forward));const n=jg.alloc();return n.model=t,n.depth=i,n}function Yg(t,e){const i=t.pipelineSceneData.validPunctualLights;i.length=0;const{spotLights:n}=e.scene;for(let t=0;t<n.length;t++){const s=n[t];s.baked||($r.set(Tg,s.position.x,s.position.y,s.position.z,s.range),zo.sphereFrustum(Tg,e.frustum)&&i.push(s))}const{sphereLights:s}=e.scene;for(let t=0;t<s.length;t++){const n=s[t];n.baked||($r.set(Tg,n.position.x,n.position.y,n.position.z,n.range),zo.sphereFrustum(Tg,e.frustum)&&i.push(n))}}function Kg(t,e){const i=e.scene,n=i.mainLight,s=t.pipelineSceneData,r=s.shadows,o=s.skybox,a=s.renderObjects;kg.freeArray(a),a.length=0;const c=s.castShadowObjects;jg.freeArray(c),c.length=0,bg=!1;let l=null;if(r.enabled&&(t.pipelineUBO.updateShadowUBORange(hm.SHADOW_COLOR_OFFSET,r.shadowColor),r.type===pg.ShadowMap))if(l=t.pipelineSceneData.dirShadowObjects,Hg.freeArray(l),l.length=0,n&&n.node)!function(t,e,i,n,s){const r=e.device;if(i.shadowFixedArea){const e=i.shadowOrthoSize,n=i.shadowOrthoSize,o=i.shadowNear,a=i.shadowFar;Ii.fromRT(Rg,i.node.getWorldRotation(),i.node.getWorldPosition()),Ii.invert(Dg,Rg),Ii.ortho(Og,-e,e,-n,n,o,a,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY),Ii.multiply(Bg,Og,Dg),Ii.invert(Mg,Dg),s.matShadowView=Dg,s.matShadowProj=Og,s.matShadowViewProj=Bg,qa.createOrtho(t,2*e,2*n,o,a,Mg)}else{const e=i.shadowInvisibleOcclusionRange,o=s.size.x;!function(t,e){if(!e.node)return;const i=e.node,n=i.getWorldPosition(),s=i.getWorldRotation();Ii.fromRT(t,s,n),t.m08*=-1,t.m09*=-1,t.m10*=-1}(Sg,n),qa.split(Pg,n,Sg,.1,i.shadowDistance),wg=qa.clone(Pg),Ii.fromRT(Rg,i.node.rotation,Ug),Ii.invert(Dg,Rg),Ii.invert(Mg,Dg);const a=Dg.clone();wg.transform(Dg),La.fromPoints(Cg,new mi(1e7,1e7,1e7),new mi(-1e7,-1e7,-1e7)),Cg.mergeFrustum(wg);const c=2*Cg.halfExtents.z;xg.set(Cg.center.x,Cg.center.y,Cg.center.z+Cg.halfExtents.z+e),mi.transformMat4(xg,xg,Mg),Ii.fromRT(Rg,i.node.rotation,xg),Ii.invert(Dg,Rg),Ii.invert(Mg,Dg);const l=mi.distance(Pg.vertices[0],Pg.vertices[6]);Eg.center.set(0,0,0),Eg.radius=-1,Eg.mergePoints(Pg.vertices);const h=.8*l+.4*Eg.radius;s.shadowCameraFar=c+e;const _=.5*h;if(Ii.ortho(Og,-_,_,-_,_,.1,s.shadowCameraFar,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY),o>0){Ii.multiply(Ng,Og,a),mi.transformMat4(Fg,xg,Ng);const e=2/o;zg.set(e,e);const n=Fg.x%zg.x,r=Fg.y%zg.y;Vg.set(Fg.x-n,Fg.y-r,Fg.z),Ii.invert(Lg,Ng),mi.transformMat4(Gg,Vg,Lg),Ii.fromRT(Rg,i.node.rotation,Gg),Ii.invert(Dg,Rg),Ii.invert(Mg,Dg),qa.createOrtho(t,h,h,.1,s.shadowCameraFar,Mg)}else{for(let e=0;e<8;e++)t.vertices[e].set(0,0,0);t.updatePlanes()}Ii.multiply(Bg,Og,Dg),s.matShadowView=Dg,s.matShadowProj=Og,s.matShadowViewProj=Bg}}(Ig,t,n,e,r);else{for(let t=0;t<8;t++)Ig.vertices[t].set(0,0,0);Ig.updatePlanes()}n&&r.type===pg.Planar&&function(t,e){const i=t.pipelineSceneData.shadows,n=e.direction,s=i.normal,r=i.distance+.001,o=1/mi.dot(s,n),a=n.x*o,c=n.y*o,l=n.z*o,h=s.x,_=s.y,u=s.z,d=i.matLight;d.m00=1-h*a,d.m01=-h*c,d.m02=-h*l,d.m03=0,d.m04=-_*a,d.m05=1-_*c,d.m06=-_*l,d.m07=0,d.m08=-u*a,d.m09=-u*c,d.m10=1-u*l,d.m11=0,d.m12=a*r,d.m13=c*r,d.m14=l*r,d.m15=1,t.pipelineUBO.updateShadowUBORange(hm.MAT_LIGHT_PLANE_PROJ_OFFSET,i.matLight)}(t,n),o.enabled&&o.model&&e.clearFlag&_g&&a.push(Wg(o.model,e));const h=i.models,_=e.visibility;for(let t=0;t<h.length;t++){const i=h[t];if(i.enabled&&(i.castShadow&&c.push(Xg(i,e)),r.firstSetCSM&&i.worldBounds&&(bg||(Ag.copy(i.worldBounds),bg=!0),La.merge(Ag,Ag,i.worldBounds)),i.node&&(_&i.node.layer)===i.node.layer||_&i.visFlags)){if(null!=l&&i.castShadow&&i.worldBounds&&zo.aabbFrustum(i.worldBounds,Ig)&&l.push(qg(i,e)),i.worldBounds&&!zo.aabbFrustum(i.worldBounds,e.frustum))continue;a.push(Wg(i,e))}}}const Jg=new os(un.LINEAR,un.LINEAR,un.NONE,dn.CLAMP,dn.CLAMP,dn.CLAMP),$g=new os(un.POINT,un.POINT,un.NONE,dn.CLAMP,dn.CLAMP,dn.CLAMP);class Zg{get descriptorSetMap(){return this._descriptorSetMap}get linearSampler(){return this._linearSampler}get pointSampler(){return this._pointSampler}get descriptorSetLayout(){return this._descriptorSetLayout}get globalDescriptorSet(){return this._globalDescriptorSet}constructor(t){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=t.device,this._linearSampler=this._device.getSampler(Jg),this._pointSampler=this._device.getSampler($g);const e=new ws($d.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new Is(this._descriptorSetLayout))}bindBuffer(t,e){this._globalDescriptorSet.bindBuffer(t,e);const i=this._descriptorSetMap.values();let n=i.next();for(;!n.done;)n.value.bindBuffer(t,e),n=i.next()}bindSampler(t,e){this._globalDescriptorSet.bindSampler(t,e);const i=this._descriptorSetMap.values();let n=i.next();for(;!n.done;)n.value.bindSampler(t,e),n=i.next()}bindTexture(t,e){this._globalDescriptorSet.bindTexture(t,e);const i=this._descriptorSetMap.values();let n=i.next();for(;!n.done;)n.value.bindTexture(t,e),n=i.next()}update(){this._globalDescriptorSet.update();const t=this._descriptorSetMap.values();let e=t.next();for(;!e.done;)e.value.update(),e=t.next()}getOrCreateDescriptorSet(t){const e=this._device;if(!this._descriptorSetMap.has(t)){const i=this._globalDescriptorSet,n=e.createDescriptorSet(new Is(this._descriptorSetLayout));this._descriptorSetMap.set(t,n);for(let t=Qd.UBO_GLOBAL;t<Qd.COUNT;t++)n.bindBuffer(t,i.getBuffer(t)),n.bindSampler(t,i.getSampler(t)),n.bindTexture(t,i.getTexture(t));const s=e.createBuffer(new Zn(en.UNIFORM|en.TRANSFER_DST,rn.HOST|rn.DEVICE,hm.SIZE,hm.SIZE));n.bindBuffer(hm.BINDING,s),n.update()}return this._descriptorSetMap.get(t)}destroy(){this._descriptorSetLayout.destroy()}}let Qg=0;const tv={};var ev={addStage(t){if(void 0!==tv[t])return;const e=1<<Qg;tv[t]=e,Qg+=1},stageID(t){const e=tv[t];return void 0===e?-1:e},stageIDs(t){let e=0;for(const i of t){const t=tv[i];void 0!==t&&(e|=t)}return e}};const iv=new Is(null);class nv{constructor(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=Jd.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}_destroyDescriptorSet(){this._descriptorSet.destroy(),this._nativeObj.setDescriptorSet(null),this._descriptorSet=null}_destroyWorldBoundDescriptorSet(){this._worldBoundDescriptorSet.destroy(),this._nativeObj.setWorldBoundDescriptorSet(null),this._worldBoundDescriptorSet=null}_destroyInputAssembler(){this._inputAssembler.destroy(),this._nativeObj.setInputAssembler(null),this._inputAssembler=null}_createDescriptorSet(t){this._descriptorSet=this._device.createDescriptorSet(t),this._nativeObj.setDescriptorSet(this._descriptorSet)}_createWorldBoundDescriptorSet(t){this._worldBoundDescriptorSet=this._device.createDescriptorSet(t),this._nativeObj.setWorldBoundDescriptorSet(this._worldBoundDescriptorSet)}set passes(t){t.length>8?D(12004,8):(this._passes=t,this._flushPassInfo(),this._passes[0].batchingScheme===Vf.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),iv.layout=t[0].localSetLayout,this._createDescriptorSet(iv)))}get passes(){return this._passes}get shaders(){return this._shaders}set subMesh(t){this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===Vf.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(t)}get subMesh(){return this._subMesh}set priority(t){this._priority=t,this._nativeObj.setPriority(t)}get priority(){return this._priority}get inputAssembler(){return this._inputAssembler}get descriptorSet(){return this._descriptorSet}get worldBoundDescriptorSet(){return this._worldBoundDescriptorSet}get patches(){return this._patches}get planarInstanceShader(){return this._planarInstanceShader}get planarShader(){return this._planarShader}_setInputAssembler(t){this._inputAssembler=this._device.createInputAssembler(t),this._nativeObj.setInputAssembler(this._inputAssembler)}_setSubMesh(t){this._subMesh=t,this._nativeObj.setSubMeshBuffers(t.flatBuffers)}get native(){return this._nativeObj}_init(){this._nativeObj=new Ta}initialize(t,e,i=null){const n=l.director.root;this._device=n.device,iv.layout=e[0].localSetLayout,this._init(),this._setInputAssembler(t.iaInfo),this._createDescriptorSet(iv);const s=l.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),r=new Is(null);if(r.layout=s.localSetLayout,this._createWorldBoundDescriptorSet(r),this._setSubMesh(t),this._patches=i,this._passes=e,this._flushPassInfo(),e[0].batchingScheme===Vf.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=Jd.DEFAULT,e[0].phase===Of("reflection")){let t=n.mainWindow.width,e=n.mainWindow.height;const i=512;e<t?(t=i*t/e,e=i):(t=i,e=i*e/t),this._reflectionTex=this._device.createTexture(new ss(on.TEX2D,an.STORAGE|an.TRANSFER_SRC|an.SAMPLED,Zi.RGBA8,t,e)),this.descriptorSet.bindTexture(Jm,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new os(un.LINEAR,un.LINEAR,un.NONE,dn.CLAMP,dn.CLAMP,dn.CLAMP)),this.descriptorSet.bindSampler(Jm,this._reflectionSampler),this.descriptorSet.bindTexture(Qm,this._reflectionTex)}}_initNativePlanarShadowShader(t){this._planarShader=t.getPlanarShader(this._patches),this._nativeObj.setPlanarShader(this._planarShader)}initPlanarShadowShader(){const t=l.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(t)}_initNativePlanarShadowInstanceShader(t){this._planarInstanceShader=t.getPlanarInstanceShader(this._patches),this._nativeObj.setPlanarInstanceShader(this._planarInstanceShader)}initPlanarShadowInstanceShader(){const t=l.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(t)}_destroy(){this._nativeObj=null}destroy(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=Jd.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()}update(){for(let t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()}onPipelineStateChanged(){const t=this._passes;if(t){for(let e=0;e<t.length;e++){const i=t[e];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}onMacroPatchesStateChanged(t){this._patches=t;const e=this._passes;if(e){for(let t=0;t<e.length;t++){const i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}_flushPassInfo(){const t=this._passes;if(t){this._shaders||(this._shaders=[]),this._shaders.length=t.length;for(let e=0,i=t.length;e<i;e++)this._shaders[e]=t[e].getShaderVariant(this.patches);{const e=t.map((t=>t.native));this._nativeObj.setPasses(e),this._nativeObj.setShaders(this._shaders)}}}}const sv=new Ii,rv=[{name:"CC_RECEIVE_SHADOW",value:!0}],ov=[{name:"CC_USE_LIGHTMAP",value:!0}];let av;!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(av||(av={}));const cv=new os(un.LINEAR,un.LINEAR,un.NONE,dn.CLAMP,dn.CLAMP,dn.CLAMP),lv=new os(un.LINEAR,un.LINEAR,un.LINEAR,dn.CLAMP,dn.CLAMP,dn.CLAMP);class hv{get subModels(){return this._subModels}get inited(){return this._inited}get worldBounds(){return this._worldBounds}get modelBounds(){return this._modelBounds}get localBuffer(){return this._localBuffer}get worldBoundBuffer(){return this._worldBoundBuffer}get updateStamp(){return this._updateStamp}get isInstancingEnabled(){return this._instMatWorldIdx>=0}get shadowBias(){return this._shadowBias}set shadowBias(t){this._shadowBias=t,this._nativeObj.setShadowBias(t)}get shadowNormalBias(){return this._shadowNormalBias}set shadowNormalBias(t){this._shadowNormalBias=t,this._nativeObj.setShadowNormalBias(t)}get receiveShadow(){return this._receiveShadow}set receiveShadow(t){this._setReceiveShadow(t),this.onMacroPatchesStateChanged()}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t,this._nativeObj.setCastShadow(t)}get node(){return this._node}set node(t){this._node=t,this._nativeObj.setNode(t.native)}get transform(){return this._transform}set transform(t){this._transform=t,this._nativeObj.setTransform(t.native)}get visFlags(){return this._visFlags}set visFlags(t){this._visFlags=t,this._nativeObj.seVisFlag(t)}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this._nativeObj.setEnabled(t)}get native(){return this._nativeObj}constructor(){this.type=av.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(Am.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Fi,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._shadowBias=0,this._shadowNormalBias=0,this._enabled=!0,this._visFlags=Yd.Enum.NONE,this._device=l.director.root.device}_setReceiveShadow(t){this._receiveShadow=t,this._nativeObj.setReceiveShadow(t)}_init(){this._nativeObj=new ca}initialize(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Yd.Enum.NONE,this._inited=!0)}_destroySubmodel(t){t.destroy()}_destroy(){this._nativeObj=null}destroy(){const t=this._subModels;for(let e=0;e<t.length;e++){const t=this._subModels[e];this._destroySubmodel(t)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()}attachToScene(t){this.scene=t,this._localDataUpdated=!0}detachFromScene(){this.scene=null}updateTransform(t){const e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._localDataUpdated=!0;const t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}}updateWorldBound(){const t=this.transform;if(null!==t){t.updateWorldTransform(),this._localDataUpdated=!0;const e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}}_applyLocalData(){}_applyLocalBuffer(){this._nativeObj.setLocalBuffer(this._localBuffer)}_applyWorldBoundBuffer(){this._nativeObj.setWorldBoundBuffer(this._worldBoundBuffer)}updateUBOs(t){const e=this._subModels;for(let t=0;t<e.length;t++)e[t].update();if(this._updateStamp=t,!this._localDataUpdated)return;this._localDataUpdated=!1;const i=this.transform._mat,n=this._instMatWorldIdx;if(n>=0){const t=this.instancedAttributes.views;!function(t,e,i,n){e[0]=t.m00,e[1]=t.m01,e[2]=t.m02,e[3]=t.m12,i[0]=t.m04,i[1]=t.m05,i[2]=t.m06,i[3]=t.m13,n[0]=t.m08,n[1]=t.m09,n[2]=t.m10,n[3]=t.m14}(i,t[n],t[n+1],t[n+2])}else this._localBuffer&&(Ii.toArray(this._localData,i,Am.MAT_WORLD_OFFSET),Ii.inverseTranspose(sv,i),Ii.toArray(this._localData,sv,Am.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer())}_updateNativeBounds(){this._nativeObj.setBounds(this._worldBounds.native)}createBoundingShape(t,e){t&&e&&(this._modelBounds=La.fromPoints(La.create(),t,e),this._worldBounds=La.clone(this._modelBounds),this._updateNativeBounds())}_createSubModel(){return new nv}initSubModel(t,e,i){this.initialize(),null==this._subModels[t]?this._subModels[t]=this._createSubModel():this._subModels[t].destroy(),this._subModels[t].initialize(e,i.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._subModels[t].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(t),this._nativeObj.setSubModel(t,this._subModels[t].native)}setSubModelMesh(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)}setSubModelMaterial(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))}onGlobalPipelineStateChanged(){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].onPipelineStateChanged()}onMacroPatchesStateChanged(){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))}updateLightingmap(t,e){Fi.toArray(this._localData,e,Am.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=t,this._lightmapUVParam=e,this.onMacroPatchesStateChanged(),null===t&&(t=Mf.get("empty-texture"));const i=t.getGFXTexture();if(i){const n=this._device.getSampler(t.mipmaps.length>1?lv:cv),s=this._subModels;for(let t=0;t<s.length;t++){const{descriptorSet:e}=s[t];e.bindTexture(jm,i),e.bindSampler(jm,n),e.update()}this._nativeObj.updateLightingmap(e,n,i)}}updateLocalShadowBias(){const t=this._localData;t[Am.LOCAL_SHADOW_BIAS+0]=this._shadowBias,t[Am.LOCAL_SHADOW_BIAS+1]=this._shadowNormalBias,t[Am.LOCAL_SHADOW_BIAS+2]=0,t[Am.LOCAL_SHADOW_BIAS+3]=0,this._localDataUpdated=!0}getMacroPatches(t){let e=this.receiveShadow?rv:null;return null!=this._lightmap&&(e=e?e.concat(ov):ov),e}_updateAttributesAndBinding(t){const e=this._subModels[t];if(!e)return;this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet),this._initWorldBoundDescriptors(t),this._updateWorldBoundDescriptors(t,e.worldBoundDescriptorSet);const i=e.passes[0].getShaderVariant(e.patches);this._updateInstancedAttributes(i.attributes,e.passes[0])}_getInstancedAttributeIndex(t){const{attributes:e}=this.instancedAttributes;for(let i=0;i<e.length;i++)if(e[i].name===t)return i;return-1}_setInstMatWorldIdx(t){this._instMatWorldIdx=t,this._nativeObj.setInstMatWorldIdx(t)}_updateInstancedAttributes(t,e){if(!e.device.hasFeature($i.INSTANCED_ARRAYS))return;let i=0;for(let e=0;e<t.length;e++){const n=t[e];n.isInstanced&&(i+=Gs[n.format].size)}const n=this.instancedAttributes;n.buffer=new Uint8Array(i),n.views.length=n.attributes.length=0;let s=0;for(let e=0;e<t.length;e++){const i=t[e];if(!i.isInstanced)continue;const r=new fs;r.format=i.format,r.name=i.name,r.isNormalized=i.isNormalized,r.location=i.location,n.attributes.push(r);const o=Gs[i.format],a=new(Ks(o))(n.buffer.buffer,s,o.count);n.views.push(a),s+=o.size}e.batchingScheme===Vf.INSTANCING&&e.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex("a_matWorld0")),this._localDataUpdated=!0,this._nativeObj.setInstancedAttrBlock(n.buffer.buffer,n.views,n.attributes)}_initLocalDescriptors(t){this._localBuffer||(this._localBuffer=this._device.createBuffer(new Zn(en.UNIFORM|en.TRANSFER_DST,rn.DEVICE,Am.SIZE,Am.SIZE)),this._applyLocalBuffer())}_initWorldBoundDescriptors(t){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new Zn(en.UNIFORM|en.TRANSFER_DST,rn.DEVICE,bm.SIZE,bm.SIZE)),this._applyWorldBoundBuffer())}_updateLocalDescriptors(t,e){this._localBuffer&&e.bindBuffer(Am.BINDING,this._localBuffer)}_updateWorldBoundDescriptors(t,e){this._worldBoundBuffer&&e.bindBuffer(bm.BINDING,this._worldBoundBuffer)}}class _v{set enabled(t){this._enabled=t,this._nativeObj.enabled=t}get enabled(){return this._enabled}get skyColor(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR}set skyColor(t){const e=l.director.root.pipeline.pipelineSceneData.isHDR;e?this._skyColorHDR.set(t):this._skyColorLDR.set(t),this._nativeObj.skyColor=e?this._skyColorHDR:this._skyColorLDR}get skyIllum(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR}set skyIllum(t){const e=l.director.root.pipeline.pipelineSceneData.isHDR;e?this._skyIllumHDR=t:this._skyIllumLDR=t,this._nativeObj.skyIllum=e?this._skyIllumHDR:this._skyIllumLDR}get groundAlbedo(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR}set groundAlbedo(t){const e=l.director.root.pipeline.pipelineSceneData.isHDR;e?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t),this._nativeObj.groundAlbedo=e?this._groundAlbedoHDR:this._groundAlbedoLDR}get native(){return this._nativeObj}constructor(){this._groundAlbedoHDR=new Fi(.2,.2,.2,1),this._skyColorHDR=new Fi(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new Fi(.2,.2,.2,1),this._skyColorLDR=new Fi(.2,.5,.8,1),this._skyIllumLDR=0,this._enabled=!1,this._nativeObj=new ga}initialize(t){this._skyColorHDR=t.skyColorHDR,this._groundAlbedoHDR.set(t.groundAlbedoHDR),this._skyIllumHDR=t.skyIllumHDR,this._skyColorLDR=t.skyColorLDR,this._groundAlbedoLDR.set(t.groundAlbedoLDR),this._skyIllumLDR=t.skyIllumLDR,this._nativeObj.skyIllum=this.skyIllum,this._nativeObj.skyColor=this.skyColor,this._nativeObj.groundAlbedo=this.groundAlbedo}_destroy(){this._nativeObj=null}destroy(){this._destroy()}}_v.SUN_ILLUM=65e3,_v.SKY_ILLUM=2e4,l.Ambient=_v;class uv extends Gf{get parent(){return this._parent}constructor(t,e){super(t.root),this._parent=void 0,this._owner=void 0,this._dontNotify=!1,this._parent=t,this._owner=e,this._doInit(this._parent,!0);for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t],i=this._blocks[e.binding],n=this._parent.blocks[e.binding];i.set(n)}this._setRootBufferDirty(!0);const i=this._parent;for(let t=0;t<this._shaderInfo.samplerTextures.length;t++){const e=this._shaderInfo.samplerTextures[t];for(let t=0;t<e.count;t++){const n=i._descriptorSet.getSampler(e.binding,t),s=i._descriptorSet.getTexture(e.binding,t);this._descriptorSet.bindSampler(e.binding,n,t),this._descriptorSet.bindTexture(e.binding,s,t)}}super.tryCompile()}overridePipelineStates(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),Gf.fillPipelineInfo(this,t),Gf.fillPipelineInfo(this,e),this._onStateChange()}tryCompile(t){if(t&&!gp(this._defines,t))return!1;const e=super.tryCompile();return this._onStateChange(),e}beginChangeStatesSilently(){this._dontNotify=!0}endChangeStatesSilently(){this._dontNotify=!1}_syncBatchingScheme(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Vf.NONE)}_onStateChange(){this._setHash(Gf.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)}}class dv extends sg{get parent(){return this._parent}get owner(){return this._owner}constructor(t){super(),this._passes=[],this._parent=void 0,this._owner=void 0,this._subModelIdx=0,this._parent=t.parent,this._owner=t.owner||null,this._subModelIdx=t.subModelIdx||0,this.copy(this._parent)}recompileShaders(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(const e of this._passes)e.tryCompile(t);else this._passes[e].tryCompile(t)}overridePipelineStates(t,e){if(!this._passes||!this.effectAsset)return;const i=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(let e=0;e<this._passes.length;e++){const n=this._passes[e],s=this._states[e]||(this._states[e]={});for(const e in t)s[e]=t[e];n.overridePipelineStates(i[n.passIndex],s)}else{const n=this._states[e]||(this._states[e]={});for(const e in t)n[e]=t[e];this._passes[e].overridePipelineStates(i[e],n)}}destroy(){return this._doDestroy(),!0}onPassStateChange(t){this._hash=sg.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}_createPasses(){const t=[],e=this._parent.passes;if(!e)return t;for(let i=0;i<e.length;++i)t.push(new uv(e[i],this));return t}}let mv=null,pv=null;const fv=jt({HEMISPHERE_DIFFUSE:0,AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION:1,DIFFUSEMAP_WITH_REFLECTION:2});class gv{get model(){return this._model}get enabled(){return this._enabled}set enabled(t){this._setEnabled(t),t?this.activate():this._updatePipeline()}get useHDR(){return this._useHDR}set useHDR(t){this._setUseHDR(t),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}get useIBL(){return this._useIBL}set useIBL(t){this._setUseIBL(t),this._updatePipeline()}get useDiffuseMap(){return this._useDiffuseMap}set useDiffuseMap(t){this._useDiffuseMap=t,this._updatePipeline()}get isRGBE(){return!!this.envmap&&this.envmap.isRGBE}get envmap(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR}set envmap(t){l.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(t,this._envmapLDR):this.setEnvMaps(this._envmapHDR,t)}get diffuseMap(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR}set diffuseMap(t){l.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(t,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,t)}get native(){return this._nativeObj}constructor(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1,this._nativeObj=new pa}_setEnabled(t){this._enabled=t,this._nativeObj.enabled=t}_setUseIBL(t){this._useIBL=t,this._nativeObj.useIBL=t}_setUseHDR(t){this._useHDR=t,this._nativeObj.useHDR=t}_setUseDiffuseMap(t){this._useDiffuseMap=t,this._nativeObj.useDiffuseMap=t}initialize(t){this._setEnabled(t.enabled),this._setUseIBL(t.useIBL),this._setUseDiffuseMap(t.applyDiffuseMap),this._setUseHDR(t.useHDR)}setEnvMaps(t,e){this._envmapHDR=t,this._envmapLDR=e,this._updateGlobalBinding(),this._updatePipeline()}setDiffuseMaps(t,e){this._diffuseMapHDR=t,this._diffuseMapLDR=e,this._updateGlobalBinding(),this._updatePipeline()}activate(){const t=l.director.root.pipeline;this._globalDSManager=t.globalDSManager,this._default=Mf.get("default-cube-texture"),this._model||(this._model=l.director.root.createModel(l.renderer.scene.Model),this._model._initLocalDescriptors=()=>{},this._model._initWorldBoundDescriptors=()=>{},this._nativeObj.model=this._model.native);let e=this._default.isRGBE;if(this.envmap&&(e=this.envmap.isRGBE),!pv){const t=new sg;t.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:e}}),pv=new dv({parent:t})}this.enabled&&(mv||(mv=l.utils.createMesh(l.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,mv.renderingSubMeshes[0],pv)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()}_updatePipeline(){this._nativeObj.isRGBE=this.isRGBE;const t=l.director.root,e=t.pipeline,i=this.useIBL?this.isRGBE?2:1:0,n=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,s=this.useHDR;e.macros.CC_USE_IBL===i&&e.macros.CC_USE_DIFFUSEMAP===n&&e.macros.CC_USE_HDR===s||(e.macros.CC_USE_IBL=i,e.macros.CC_USE_DIFFUSEMAP=n,e.macros.CC_USE_HDR=s,t.onGlobalPipelineStateChanged()),this.enabled&&pv&&pv.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,pv)}_updateGlobalBinding(){if(this._globalDSManager){const t=l.director.root.device,e=this.envmap?this.envmap:this._default;if(e){const i=e.getGFXTexture(),n=t.getSampler(e.getSamplerInfo());this._globalDSManager.bindSampler(mm,n),this._globalDSManager.bindTexture(mm,i)}const i=this.diffuseMap?this.diffuseMap:this._default;if(i){const e=i.getGFXTexture(),n=t.getSampler(i.getSamplerInfo());this._globalDSManager.bindSampler(gm,n),this._globalDSManager.bindTexture(gm,e)}this._globalDSManager.update()}}_destroy(){this._nativeObj=null}destroy(){this._destroy()}}l.Skybox=gv;const vv=new Fi,yv=jt({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),xv=yv.LAYERED+1;class Sv{set enabled(t){this._setEnable(t),t?this.activate():(this._type=xv,this._updatePipeline())}get enabled(){return this._enabled}set accurate(t){this._setAccurate(t),this._updatePipeline()}get accurate(){return this._accurate}set fogColor(t){this._fogColor.set(t),vv.set(t.x,t.y,t.z,t.w),kf(this._colorArray,vv),this._nativeObj.color=this._fogColor}get fogColor(){return this._fogColor}get type(){return this._type}set type(t){this._setType(t),this.enabled&&this._updatePipeline()}get fogDensity(){return this._fogDensity}set fogDensity(t){this._fogDensity=t,this._nativeObj.density=t}get fogStart(){return this._fogStart}set fogStart(t){this._fogStart=t,this._nativeObj.start=t}get fogEnd(){return this._fogEnd}set fogEnd(t){this._fogEnd=t,this._nativeObj.end=t}get fogAtten(){return this._fogAtten}set fogAtten(t){this._fogAtten=t,this._nativeObj.atten=t}get fogTop(){return this._fogTop}set fogTop(t){this._fogTop=t,this._nativeObj.top=t}get fogRange(){return this._fogRange}set fogRange(t){this._fogRange=t,this._nativeObj.range=t}get colorArray(){return this._colorArray}get native(){return this._nativeObj}constructor(){this._fogColor=new hi("#C8C8C8"),this._colorArray=new Fi(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2,this._nativeObj=new fa}_setType(t){this._type=this.enabled?t:xv,this._nativeObj.type=this._type}_setEnable(t){this._enabled=t,this._nativeObj.enabled=t}_setAccurate(t){this._accurate=t,this._nativeObj.accurate=t}initialize(t){this.fogColor=t.fogColor,this._setEnable(t.enabled),this._setAccurate(t.accurate),this._setType(t.type),this.fogDensity=t.fogDensity,this.fogStart=t.fogStart,this.fogEnd=t.fogEnd,this.fogAtten=t.fogAtten,this.fogTop=t.fogTop,this.fogRange=t.fogRange}activate(){this._updatePipeline()}_updatePipeline(){const t=l.director.root,e=this.enabled?this.type:xv,i=this.accurate?1:0,n=t.pipeline;n.macros.CC_USE_FOG===e&&n.macros.CC_USE_ACCURATE_FOG===i||(n.macros.CC_USE_FOG=e,n.macros.CC_USE_ACCURATE_FOG=i,t.onGlobalPipelineStateChanged())}_destroy(){this._nativeObj=null}destroy(){this._destroy()}}l.Fog=Sv;class Cv{set enabled(t){this._enabled=t,this._nativeObj.enabled=t}get enabled(){return this._enabled}get minPos(){return this._minPos}set minPos(t){this._minPos=t,this._nativeObj.minPos=t}get maxPos(){return this._maxPos}set maxPos(t){this._maxPos=t,this._nativeObj.maxPos=t}get depth(){return this._depth}set depth(t){this._depth=t,this._nativeObj.depth=t}get native(){return this._nativeObj}constructor(){this._enabled=!1,this._minPos=new mi(0,0,0),this._maxPos=new mi(0,0,0),this._depth=0,this._nativeObj=new ya}initialize(t){this._enabled=t.enabled,this._minPos=t.minPos,this._maxPos=t.maxPos,this._depth=t.depth,this._nativeObj.enabled=this._enabled,this._nativeObj.minPos=this._minPos,this._nativeObj.maxPos=this._maxPos,this._nativeObj.depth=this._depth}_destroy(){this._nativeObj=null}destroy(){this._destroy()}}let Av,bv,Tv;function Ev(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);const i=e*e,n=(.860117757+.000154118254*e+1.28641212e-7*i)/(1+.000842420235*e+7.08145163e-7*i),s=(.317398726+422806245e-13*e+4.20481691e-8*i)/(1-289741816e-13*e+1.61456053e-7*i),r=2*n-8*s+4,o=3*n/r,a=2*s/r,c=1/a*o,l=1/a*(1-o-a);t.x=3.2404542*c-1.5371385+-.4985314*l,t.y=-.969266*c+1.8760108+.041556*l,t.z=.0556434*c-.2040259+1.0572252*l}!function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(Av||(Av=t("NodeSpace",{}))),function(t){t[t.NONE=0]="NONE",t[t.POSITION=1]="POSITION",t[t.ROTATION=2]="ROTATION",t[t.SCALE=4]="SCALE",t[t.RS=t.ROTATION|t.SCALE]="RS",t[t.TRS=t.POSITION|t.ROTATION|t.SCALE]="TRS",t[t.TRS_MASK=~t.TRS]="TRS_MASK"}(bv||(bv=t("TransformBit",{}))),l.internal.TransformBit=bv,function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.UNKNOWN=3]="UNKNOWN"}(Tv||(Tv={}));const Pv=t=>4*Math.PI*Math.PI*t*t;class wv{constructor(){this._baked=!1,this._color=new mi(1,1,1),this._colorTemp=6550,this._colorTempRGB=new mi(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Tv.UNKNOWN}_init(){switch(this._type){case Tv.DIRECTIONAL:this._nativeObj=new ua;break;case Tv.SPHERE:this._nativeObj=new ma;break;case Tv.SPOT:this._nativeObj=new da}this._nativeObj.setType(this._type)}_destroy(){this._nativeObj=null}get baked(){return this._baked}set baked(t){this._baked=t,this._nativeObj.setBaked(t)}set color(t){this._color.set(t),this._nativeObj.setColor(t)}get color(){return this._color}set useColorTemperature(t){this._useColorTemperature=t,this._nativeObj.setUseColorTemperature(t)}get useColorTemperature(){return this._useColorTemperature}set colorTemperature(t){this._colorTemp=t,Ev(this._colorTempRGB,this._colorTemp),this._nativeObj.setColorTemperatureRGB(this._colorTempRGB)}get colorTemperature(){return this._colorTemp}get colorTemperatureRGB(){return this._colorTempRGB}set node(t){this._node=t,this._node&&(this._node.hasChangedFlags|=bv.ROTATION,this._nativeObj.setNode(t?t.native:null))}get node(){return this._node}get type(){return this._type}get name(){return this._name}set name(t){this._name=t}get scene(){return this._scene}get native(){return this._nativeObj}initialize(){this._init(),this.color=new mi(1,1,1),this.colorTemperature=6550}attachToScene(t){this._scene=t}detachFromScene(){this._scene=null}destroy(){this._name=null,this._node=null,this._destroy()}update(){}}const Iv=new mi(0,0,-1),Rv=new mi,Dv=new mi(0,0,-1),Mv=new Si,Ov=new Ii,Bv=new Ii,Nv=new Ii,Lv=new Ii;class Fv extends wv{_init(){super._init();{const t=this._nativeObj;t.setAABB(this._aabb.native),t.setFrustum(this._frustum),t.setDirection(this._dir),t.setPosition(this._pos)}}_destroy(){super._destroy()}_setDirection(t){this._dir.set(t),this._nativeObj.setDirection(t)}get position(){return this._pos}set size(t){this._size=t,this._nativeObj.setSize(t)}get size(){return this._size}set range(t){this._range=t,this._nativeObj.setRange(t),this._needUpdate=!0}get range(){return this._range}get luminance(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR}set luminance(t){l.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}get luminanceHDR(){return this._luminanceHDR}set luminanceHDR(t){this._luminanceHDR=t,this._nativeObj.setLuminanceHDR(t)}get luminanceLDR(){return this._luminanceLDR}set luminanceLDR(t){this._luminanceLDR=t,this._nativeObj.setLuminanceLDR(t)}get direction(){return this._dir}get spotAngle(){return this._spotAngle}set spotAngle(t){this._angle=t,this._spotAngle=Math.cos(.5*t),this._nativeObj.setAngle(this._spotAngle),this._needUpdate=!0}get angle(){return this._angle}get aabb(){return this._aabb}get frustum(){return this._frustum}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(t){this._shadowEnabled=t,this._nativeObj.setShadowEnabled(t)}get shadowPcf(){return this._shadowPcf}set shadowPcf(t){this._shadowPcf=t,this._nativeObj.setShadowPcf(t)}get shadowBias(){return this._shadowBias}set shadowBias(t){this._shadowBias=t,this._nativeObj.setShadowBias(t)}get shadowNormalBias(){return this._shadowNormalBias}set shadowNormalBias(t){this._shadowNormalBias=t,this._nativeObj.setShadowNormalBias(t)}constructor(){super(),this._dir=new mi(1,-1,-1),this._range=5,this._spotAngle=Math.cos(Math.PI/6),this._pos=void 0,this._aabb=void 0,this._frustum=void 0,this._angle=0,this._needUpdate=!1,this._size=.15,this._luminanceHDR=0,this._luminanceLDR=0,this._shadowEnabled=!1,this._shadowPcf=fg.HARD,this._shadowBias=1e-5,this._shadowNormalBias=0,this._aabb=La.create(),this._frustum=qa.create(),this._pos=new mi,this._type=Tv.SPOT}initialize(){super.initialize(),this.size=.15,this.luminanceHDR=1700/Pv(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new mi(1,-1,-1))}update(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),mi.transformQuat(this._dir,Dv,this._node.getWorldRotation(Mv)),mi.normalize(this._dir,this._dir),La.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Ov),Ii.invert(Ov,Ov),Ii.perspective(Bv,this._angle,1,.001,this._range),Ii.multiply(Nv,Bv,Ov),this._frustum.update(Nv,Lv),this._needUpdate=!1)}}class zv{get root(){return this._root}get name(){return this._name}get cameras(){return this._cameras}get mainLight(){return this._mainLight}get sphereLights(){return this._sphereLights}get spotLights(){return this._spotLights}get models(){return this._models}get batches(){return this._batches}get native(){return this._nativeObj}static registerCreateFunc(t){t._createSceneFun=t=>new zv(t)}constructor(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t,this._createNativeObject()}initialize(t){return this._name=t.name,!0}activate(){this._nativeObj.activate()}update(t){{const e=[];for(let t=0,i=this._batches.length;t<i;++t)e.push(this._batches[t].native);return this._nativeObj.updateBatches(e),void this._nativeObj.update(t)}}destroy(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()}addCamera(t){t.attachToScene(this),this._cameras.push(t)}removeCamera(t){for(let e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()}removeCameras(){for(const t of this._cameras)t.detachFromScene();this._cameras.splice(0)}setMainLight(t){this._mainLight=t,this._nativeObj.setMainLight(t?t.native:null)}unsetMainLight(t){if(this._mainLight===t){const t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=bv.ROTATION));this.setMainLight(null)}}addDirectionalLight(t){t.attachToScene(this),this._directionalLights.push(t)}removeDirectionalLight(t){for(let e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)}addSphereLight(t){t.attachToScene(this),this._sphereLights.push(t),this._nativeObj.addSphereLight(t.native)}removeSphereLight(t){for(let e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),this._sphereLights.splice(e,1),void this._nativeObj.removeSphereLight(t.native)}addSpotLight(t){t.attachToScene(this),this._spotLights.push(t),this._nativeObj.addSpotLight(t.native)}removeSpotLight(t){for(let e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),this._spotLights.splice(e,1),void this._nativeObj.removeSpotLight(t.native)}removeSphereLights(){for(let t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0,this._nativeObj.removeSphereLights()}removeSpotLights(){for(let t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[],this._nativeObj.removeSpotLights()}addModel(t){switch(t.attachToScene(this),this._models.push(t),t.type){case av.SKINNING:this._nativeObj.addSkinningModel(t.native);break;case av.BAKED_SKINNING:this._nativeObj.addBakedSkinningModel(t.native);break;case av.DEFAULT:default:this._nativeObj.addModel(t.native)}}removeModel(t){for(let e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),this._models.splice(e,1),void this._nativeObj.removeModel(e)}removeModels(){for(const t of this._models)t.detachFromScene(),t.destroy();this._models.length=0,this._nativeObj.removeModels()}addBatch(t){this._batches.push(t)}removeBatch(t){for(let e=0;e<this._batches.length;++e)if(this._batches[e]===t)return this._batches.splice(e,1),void this._nativeObj.removeBatch(e)}removeBatches(){this._batches.length=0,this._nativeObj.removeBatches()}onGlobalPipelineStateChanged(){for(const t of this._models)t.onGlobalPipelineStateChanged()}generateModelId(){return this._modelId++}_destroy(){this._nativeObj=null}_createNativeObject(){this._nativeObj||(this._nativeObj=new Ca)}}var Vv=Object.freeze({__proto__:null,get CameraFOVAxis(){return Qf},get CameraProjection(){return tg},get CameraAperture(){return eg},get CameraISO(){return ig},get CameraShutter(){return ng},SKYBOX_FLAG:_g,Camera:dg,get ModelType(){return av},Model:hv,SubModel:nv,Ambient:_v,EnvironmentLightingType:fv,Skybox:gv,ShadowSize:mg,ShadowType:pg,PCFType:fg,Shadows:vg,FogType:yv,Fog:Sv,Octree:Cv,ColorTemperatureToRGB:Ev,get LightType(){return Tv},nt2lm:Pv,Light:wv,DirectionalLight:class extends wv{set direction(t){mi.normalize(this._dir,t),this._nativeObj.setDirection(t)}get direction(){return this._dir}get illuminance(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR}set illuminance(t){l.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=t:this.illuminanceLDR=t}get illuminanceHDR(){return this._illuminanceHDR}set illuminanceHDR(t){this._illuminanceHDR=t,this._nativeObj.setIlluminanceHDR(t)}get illuminanceLDR(){return this._illuminanceLDR}set illuminanceLDR(t){this._illuminanceLDR=t,this._nativeObj.setIlluminanceLDR(t)}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(t){this._shadowEnabled=t,this._nativeObj.setShadowEnabled(t)}get shadowPcf(){return this._shadowPcf}set shadowPcf(t){this._shadowPcf=t,this._nativeObj.setShadowPcf(t)}get shadowBias(){return this._shadowBias}set shadowBias(t){this._shadowBias=t,this._nativeObj.setShadowBias(t)}get shadowNormalBias(){return this._shadowNormalBias}set shadowNormalBias(t){this._shadowNormalBias=t,this._nativeObj.setShadowNormalBias(t)}get shadowSaturation(){return this._shadowSaturation}set shadowSaturation(t){this._shadowSaturation=t,this._nativeObj.setShadowSaturation(this._shadowSaturation)}get shadowDistance(){return this._shadowDistance}set shadowDistance(t){this._shadowDistance=Math.min(t,vg.MAX_FAR),this._nativeObj.setShadowDistance(t)}get shadowInvisibleOcclusionRange(){return this._shadowInvisibleOcclusionRange}set shadowInvisibleOcclusionRange(t){this._shadowInvisibleOcclusionRange=Math.min(t,vg.MAX_FAR),this._nativeObj.setShadowInvisibleOcclusionRange(t)}get shadowFixedArea(){return this._shadowFixedArea}set shadowFixedArea(t){this._shadowFixedArea=t,this._nativeObj.setShadowFixedArea(t)}get shadowNear(){return this._shadowNear}set shadowNear(t){this._shadowNear=t,this._nativeObj.setShadowNear(t)}get shadowFar(){return this._shadowFar}set shadowFar(t){this._shadowFar=Math.min(t,vg.MAX_FAR),this._nativeObj.setShadowFar(t)}get shadowOrthoSize(){return this._shadowOrthoSize}set shadowOrthoSize(t){this._shadowOrthoSize=t,this._nativeObj.setShadowOrthoSize(t)}constructor(){super(),this._dir=new mi(1,-1,-1),this._illuminanceHDR=_v.SUN_ILLUM,this._illuminanceLDR=1,this._shadowEnabled=!1,this._shadowPcf=fg.HARD,this._shadowBias=1e-5,this._shadowNormalBias=0,this._shadowSaturation=1,this._shadowDistance=100,this._shadowInvisibleOcclusionRange=200,this._shadowFixedArea=!1,this._shadowNear=.1,this._shadowFar=10,this._shadowOrthoSize=5,this._type=Tv.DIRECTIONAL}initialize(){super.initialize(),this.illuminance=_v.SUN_ILLUM,this.direction=new mi(1,-1,-1)}update(){this._node&&this._node.hasChangedFlags&&(this.direction=mi.transformQuat(Rv,Iv,this._node.worldRotation))}},SphereLight:class extends wv{_init(){super._init(),this._nativeObj.setPosition(this._pos),this._nativeObj.setAABB(this._aabb.native)}_destroy(){super._destroy()}get position(){return this._pos}set size(t){this._size=t,this._nativeObj.setSize(t)}get size(){return this._size}set range(t){this._range=t,this._nativeObj.setRange(t),this._needUpdate=!0}get range(){return this._range}get luminance(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR}set luminance(t){l.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}get luminanceHDR(){return this._luminanceHDR}set luminanceHDR(t){this._luminanceHDR=t,this._nativeObj.setLuminanceHDR(t)}set luminanceLDR(t){this._luminanceLDR=t,this._nativeObj.setLuminanceLDR(t)}get aabb(){return this._aabb}constructor(){super(),this._needUpdate=!1,this._size=.15,this._range=1,this._luminanceHDR=0,this._luminanceLDR=0,this._pos=void 0,this._aabb=void 0,this._aabb=La.create(),this._pos=new mi,this._type=Tv.SPHERE}initialize(){super.initialize(),this.size=.15,this.range=1,this.luminanceHDR=1700/Pv(.15),this.luminanceLDR=1}update(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);const t=this._range;La.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1}}},SpotLight:Fv,RenderScene:zv});let Gv,Uv;function kv(t){return--t,t|=t>>16,t|=t>>8,t|=t>>4,t|=t>>2,t|=t>>1,++t}function Hv(t,e){return Math.ceil(t/e)*e}!function(t){t[t.OPAQUE=0]="OPAQUE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OVERLAY=2]="OVERLAY"}(Gv||(Gv={})),function(t){t[t.DEFAULT=1]="DEFAULT",t[t.FORWARD=2]="FORWARD",t[t.SHADOWCAST=4]="SHADOWCAST"}(Uv||(Uv={}));class jv{constructor(t){this._device=void 0,this._format=Zi.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new qn,this._region1=new qn,this._region2=new qn,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}initialize(t){const e=Gs[t.format];this._format=t.format,this._formatSize=e.size,this._channels=e.count,this._bufferViewCtor=Ks(e),this._roundUpFn=t.roundUpFn||null,this._alignment=t.alignment||1,t.inOrderFree&&(this.alloc=this._McDonaldAlloc)}destroy(){for(let t=0;t<this._chunkCount;++t)this._chunks[t].texture.destroy();this._chunks.length=0,this._handles.length=0}alloc(t,e){t=Hv(t,this._alignment);let i=-1,n=-1;if(void 0!==e&&(i=e,n=this._findAvailableSpace(t,i)),n<0)for(let e=0;e<this._chunkCount&&(i=e,n=this._findAvailableSpace(t,i),!(n>=0));++e);if(n>=0){const e=this._chunks[i];e.start+=t;const s={chunkIdx:i,start:n,end:n+t,texture:e.texture};return this._handles.push(s),s}const s=Math.sqrt(t/this._formatSize),r=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,kv(s)),o=this._chunks[this.createChunk(r)];o.start+=t;const a={chunkIdx:this._chunkCount-1,start:0,end:t,texture:o.texture};return this._handles.push(a),a}free(t){for(let e=0;e<this._handles.length;++e)if(this._handles[e]===t)return this._chunks[t.chunkIdx].end=t.end,void this._handles.splice(e,1)}createChunk(t){const e=t*t*this._formatSize;C(`TextureBufferPool: Allocate chunk ${this._chunkCount}, size: ${e}, format: ${this._format}`);const i={texture:this._device.createTexture(new ss(on.TEX2D,an.SAMPLED|an.TRANSFER_DST,this._format,t,t)),size:e,start:0,end:e};return this._chunks[this._chunkCount]=i,this._chunkCount++}update(t,e){const i=[],n=[],s=t.start/this._formatSize;let r=e.byteLength/this._formatSize,o=s%t.texture.width,a=Math.floor(s/t.texture.width),c=Math.min(t.texture.width-o,r),l=0;o>0&&(this._region0.texOffset.x=o,this._region0.texOffset.y=a,this._region0.texExtent.width=c,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),n.push(this._region0),o=0,a+=1,r-=c,l+=c),r>0&&(this._region1.texOffset.x=o,this._region1.texOffset.y=a,r>t.texture.width?(this._region1.texExtent.width=t.texture.width,this._region1.texExtent.height=Math.floor(r/t.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=r,this._region1.texExtent.width=c,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),n.push(this._region1),o=0,a+=this._region1.texExtent.height,r-=c,l+=c),r>0&&(this._region2.texOffset.x=o,this._region2.texOffset.y=a,this._region2.texExtent.width=r,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(e,l*this._formatSize,r*this._channels)),n.push(this._region2)),this._device.copyBuffersToTexture(i,t.texture,n)}_findAvailableSpace(t,e){const i=this._chunks[e];let n=!1,s=i.start;if(s+t<=i.size)n=!0;else{s=0;const r=this._handles.filter((t=>t.chunkIdx===e)).sort(((t,e)=>t.start-e.start));for(let e=0;e<r.length;e++){const i=r[e];if(s+t<=i.start){n=!0;break}s=i.end}!n&&s+t<=i.size&&(n=!0)}return n?s:-1}_McDonaldAlloc(t){t=Hv(t,this._alignment);for(let e=0;e<this._chunkCount;++e){const i=this._chunks[e];let n=!1,s=i.start;if(s+t<=i.end?n=!0:s>i.end?s+t<=i.size?n=!0:t<=i.end&&(i.start=s=0,n=!0):s===i.end&&(i.start=s=0,i.end=i.size,t<=i.end&&(n=!0)),n){i.start+=t;const n={chunkIdx:e,start:s,end:s+t,texture:i.texture};return this._handles.push(n),n}}const e=Math.sqrt(t/this._formatSize),i=this._roundUpFn&&this._roundUpFn(e,this._formatSize)||Math.max(1024,kv(e)),n=this._chunks[this.createChunk(i)];n.start+=t;const s={chunkIdx:this._chunkCount,start:0,end:t,texture:n.texture};return this._handles.push(s),s}}G(zv.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),G(zv.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);const Wv={};G(Wv,"CameraVisFlags",[{name:"GENERAL"}]),V(Wv,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Yd.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Yd.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Yd.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Yd.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Yd.BitMask,targetName:"UI_2D"}]),l.CameraVisFlags=Wv;const qv={};G(qv,"VisibilityFlags",[{name:"GENERAL"}]),V(qv,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Yd.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Yd.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Yd.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Yd.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Yd.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Yd.Enum,targetName:"UI_2D"}]),l.VisibilityFlags=qv,V(Gf.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),G(dg.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),G(vg.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"},{name:"fixedArea"},{name:"pcf"},{name:"bias"},{name:"normalBias"},{name:"near"},{name:"far"},{name:"shadowDistance"},{name:"invisibleOcclusionRange"},{name:"orthoSize"},{name:"saturation"}]),G(Fv.prototype,"SpotLight.prototype",[{name:"aspect"}]);const Xv=ev.addStage;var Yv=Object.freeze({__proto__:null,addStage:Xv,scene:Vv,createIA:function(t,e){if(!e.positions)return console.error("The data must have positions field"),null;const i=[],n=e.positions.length/3;for(let t=0;t<n;++t)i.push(e.positions[3*t],e.positions[3*t+1],e.positions[3*t+2]),e.normals&&i.push(e.normals[3*t],e.normals[3*t+1],e.normals[3*t+2]),e.uvs&&i.push(e.uvs[2*t],e.uvs[2*t+1]),e.colors&&i.push(e.colors[3*t],e.colors[3*t+1],e.colors[3*t+2]);const s=[];s.push(new fs(Ln.ATTR_POSITION,Zi.RGB32F)),e.normals&&s.push(new fs(Ln.ATTR_NORMAL,Zi.RGB32F)),e.uvs&&s.push(new fs(Ln.ATTR_TEX_COORD,Zi.RG32F)),e.colors&&s.push(new fs(Ln.ATTR_COLOR,Zi.RGB32F));const r=t.createBuffer(new Zn(en.VERTEX|en.TRANSFER_DST,rn.DEVICE,4*i.length,4*i.length/n));r.update(new Float32Array(i));let o=null;return e.indices&&(o=t.createBuffer(new Zn(en.INDEX|en.TRANSFER_DST,rn.DEVICE,2*e.indices.length,2)),o.update(new Uint16Array(e.indices))),t.createInputAssembler(new vs(s,[r],o))},get RenderQueue(){return Gv},get PassStage(){return Uv},genHandle:ap,getTypeFromHandle:cp,getBindingFromHandle:lp,getCountFromHandle:hp,getOffsetFromHandle:_p,customizeType:up,type2reader:dp,type2writer:mp,getDefaultFromType:fp,overrideMacros:gp,get BatchingSchemes(){return Vf},Pass:Gf,getDeviceShaderVersion:bp,programLib:Tp,nearestPOT:kv,TextureBufferPool:jv,MaterialInstance:dv,PassInstance:uv,get PoolType(){return Xo},NULL_HANDLE:0,get NodeView(){return Yo},NodePool:$o,get PassView(){return Zo},PassPool:ea,get AABBView(){return ia},AABBPool:ra,RenderScene:zv,NativeNode:oa,NativeScene:aa,NativeModel:ca,NativeSkinningModel:la,NativeBakedSkinningModel:ha,NativeLight:_a,NativeDirectionalLight:ua,NativeSpotLight:da,NativeSphereLight:ma,NaitveSkybox:pa,NativeFog:fa,NativeAmbient:ga,NativeShadow:va,NativeOctree:ya,NativeCamera:xa,NativeRenderWindow:Sa,NativeRenderScene:Ca,NativeDrawBatch2D:Aa,NativePass:ba,NativeSubModel:Ta,NativeRoot:Ea,NativePipelineSharedSceneData:Pa,NativeAABB:wa,NativeGeometryRenderer:Ia,CameraVisFlags:Wv,VisibilityFlags:qv});t("renderer",Yv);const Kv=new mi,Jv=new mi,$v=new mi,Zv=new mi,Qv=new mi,ty=new mi,ey=new mi,iy=new mi,ny=new mi,sy=new mi;var ry;!function(t){t[t.LINE=0]="LINE",t[t.DASHED_LINE=1]="DASHED_LINE",t[t.TRIANGLE=2]="TRIANGLE"}(ry||(ry={}));class oy{constructor(){this._maxVertices=0,this._vertexCount=0,this._stride=0}init(t,e,i,n){this._maxVertices=e,this._vertexCount=0,this._stride=i,this._vertices=new Float32Array(e*i/Float32Array.BYTES_PER_ELEMENT)}empty(){return 0===this._vertexCount}reset(){this._vertexCount=0}update(){if(!this.empty()){const t=Math.min(this._vertexCount,this._maxVertices)*this._stride;this._buffer.update(this._vertices,t)}}destroy(){this._inputAssembler&&this._inputAssembler.destroy(),this._buffer&&this._buffer.destroy()}}class ay{constructor(){this.lines=[],this.dashedLines=[],this.triangles=[];for(let t=0;t<2;t++)this.lines[t]=new oy,this.dashedLines[t]=new oy,this.triangles[t]=new oy}}class cy{constructor(){this._device=null,this._pipeline=null,this._buffers=void 0,this._nativeObj=null,this._buffers=new ay,this._nativeObj=new Ia}get native(){return this._nativeObj}activate(t,e,i){this._device=t,this._pipeline=e;const n=[new fs(Ln.ATTR_POSITION,Zi.RGB32F),new fs(Ln.ATTR_COLOR,Zi.RGBA32F)],s=[new fs(Ln.ATTR_POSITION,Zi.RGB32F),new fs(Ln.ATTR_NORMAL,Zi.RGBA32F),new fs(Ln.ATTR_COLOR,Zi.RGBA32F)],r=i?i.maxLines:1e5,o=i?i.maxDashedLines:1e4,a=i?i.maxTriangles:1e4,c=Float32Array.BYTES_PER_ELEMENT*(mi.length+hi.length),l=Float32Array.BYTES_PER_ELEMENT*(mi.length+Fi.length+hi.length);for(let t=0;t<2;t++)this._buffers.lines[t].init(this._device,2*r,c,n),this._buffers.dashedLines[t].init(this._device,2*o,c,n),this._buffers.triangles[t].init(this._device,3*a,l,s)}flush(){for(let t=0;t<2;t++){const e=this._buffers.lines[t];e.empty()||(this._nativeObj.flushFromJSB(ry.LINE,t,e._vertices,e._vertexCount),e.reset());const i=this._buffers.dashedLines[t];i.empty()||(this._nativeObj.flushFromJSB(ry.DASHED_LINE,t,i._vertices,i._vertexCount),i.reset());const n=this._buffers.triangles[t];n.empty()||(this._nativeObj.flushFromJSB(ry.TRIANGLE,t,n._vertices,n._vertexCount),n.reset())}}render(t,e){this.update();const i=this._pipeline.pipelineSceneData.geometryRendererPasses,n=this._pipeline.pipelineSceneData.geometryRendererShaders;let s=0;const r=[1,2];for(let o=0;o<2;o++){const a=this._buffers.lines[o];if(!a.empty()){const c=new ts;c.vertexCount=a._vertexCount;for(let l=0;l<r[o];l++){const r=i[s+l],o=n[s+l],h=Uf.getOrCreatePipelineState(this._device,r,o,t,a._inputAssembler);e.bindPipelineState(h),e.bindDescriptorSet(om.MATERIAL,r.descriptorSet),e.bindInputAssembler(a._inputAssembler),e.draw(c)}}s+=r[o]}for(let o=0;o<2;o++){const a=this._buffers.dashedLines[o];if(!a.empty()){const c=new ts;c.vertexCount=a._vertexCount;for(let l=0;l<r[o];l++){const r=i[s+l],o=n[s+l],h=Uf.getOrCreatePipelineState(this._device,r,o,t,a._inputAssembler);e.bindPipelineState(h),e.bindDescriptorSet(om.MATERIAL,r.descriptorSet),e.bindInputAssembler(a._inputAssembler),e.draw(c)}}s+=r[o]}for(let o=0;o<2;o++){const a=this._buffers.triangles[o];if(!a.empty()){const c=new ts;c.vertexCount=a._vertexCount;for(let l=0;l<r[o];l++){const r=i[s+l],o=n[s+l],h=Uf.getOrCreatePipelineState(this._device,r,o,t,a._inputAssembler);e.bindPipelineState(h),e.bindDescriptorSet(om.MATERIAL,r.descriptorSet),e.bindInputAssembler(a._inputAssembler),e.draw(c)}}s+=r[o]}this.reset()}destroy(){this._nativeObj=null}empty(){for(let t=0;t<2;t++)if(!this._buffers.lines[t].empty()||!this._buffers.dashedLines[t].empty()||!this._buffers.triangles[t].empty())return!1;return!0}update(){for(let t=0;t<2;t++)this._buffers.lines[t].update(),this._buffers.dashedLines[t].update(),this._buffers.triangles[t].update()}reset(){for(let t=0;t<2;t++)this._buffers.lines[t].reset(),this._buffers.dashedLines[t].reset(),this._buffers.triangles[t].reset()}addDashedLine(t,e,i,n=!0){const s=this._buffers.dashedLines[n?1:0];if(s._vertexCount+2>s._maxVertices)return void I(12008);let r=s._vertexCount*(mi.length+hi.length);mi.toArray(s._vertices,t,r),r+=mi.length,hi.toArray(s._vertices,i,r),r+=hi.length,mi.toArray(s._vertices,e,r),r+=mi.length,hi.toArray(s._vertices,i,r),s._vertexCount+=2}addLine(t,e,i,n=!0){const s=this._buffers.lines[n?1:0];if(s._vertexCount+2>s._maxVertices)return void I(12008);let r=s._vertexCount*(mi.length+hi.length);mi.toArray(s._vertices,t,r),r+=mi.length,hi.toArray(s._vertices,i,r),r+=hi.length,mi.toArray(s._vertices,e,r),r+=mi.length,hi.toArray(s._vertices,i,r),s._vertexCount+=2}addTriangle(t,e,i,n,s=!0,r=!0,o=!1){if(s)return this.addLine(t,e,n,r),this.addLine(e,i,n,r),void this.addLine(i,t,n,r);const a=this._buffers.triangles[r?1:0];if(a._vertexCount+3>a._maxVertices)return void I(12009);const c=new Fi(Fi.ZERO);if(!o){const n=new mi(e.x-t.x,e.y-t.y,e.z-t.z),s=new mi(i.x-t.x,i.y-t.y,i.z-t.z),r=new mi;mi.normalize(r,mi.cross(r,n,s)),c.set(r.x,r.y,r.z,1)}let l=a._vertexCount*(mi.length+Fi.length+hi.length);mi.toArray(a._vertices,t,l),l+=mi.length,Fi.toArray(a._vertices,c,l),l+=Fi.length,hi.toArray(a._vertices,n,l),l+=hi.length,mi.toArray(a._vertices,e,l),l+=mi.length,Fi.toArray(a._vertices,c,l),l+=Fi.length,hi.toArray(a._vertices,n,l),l+=hi.length,mi.toArray(a._vertices,i,l),l+=mi.length,Fi.toArray(a._vertices,c,l),l+=Fi.length,hi.toArray(a._vertices,n,l),a._vertexCount+=3}addQuad(t,e,i,n,s,r=!0,o=!0,a=!1){r?(this.addLine(t,e,s,o),this.addLine(e,i,s,o),this.addLine(i,n,s,o),this.addLine(n,t,s,o)):(this.addTriangle(t,e,i,s,r,o,a),this.addTriangle(t,i,n,s,r,o,a))}addBoundingBox(t,e,i=!0,n=!0,s=!1,r=!1,o=new Ii){Kv.set(t.center.x-t.halfExtents.x,t.center.y-t.halfExtents.y,t.center.z-t.halfExtents.z),Jv.set(t.center.x+t.halfExtents.x,t.center.y+t.halfExtents.y,t.center.z+t.halfExtents.z),$v.set(Kv.x,Kv.y,Kv.z),Zv.set(Jv.x,Kv.y,Kv.z),Qv.set(Kv.x,Jv.y,Kv.z),ty.set(Jv.x,Jv.y,Kv.z),ey.set(Kv.x,Kv.y,Jv.z),iy.set(Jv.x,Kv.y,Jv.z),ny.set(Kv.x,Jv.y,Jv.z),sy.set(Jv.x,Jv.y,Jv.z),r&&(mi.transformMat4($v,$v,o),mi.transformMat4(Zv,Zv,o),mi.transformMat4(Qv,Qv,o),mi.transformMat4(ty,ty,o),mi.transformMat4(ey,ey,o),mi.transformMat4(iy,iy,o),mi.transformMat4(ny,ny,o),mi.transformMat4(sy,sy,o)),i?(this.addLine(ny,sy,e,n),this.addLine(sy,ty,e,n),this.addLine(ty,Qv,e,n),this.addLine(Qv,ny,e,n),this.addLine(ey,iy,e,n),this.addLine(iy,Zv,e,n),this.addLine(Zv,$v,e,n),this.addLine($v,ey,e,n),this.addLine(ny,ey,e,n),this.addLine(sy,iy,e,n),this.addLine(ty,Zv,e,n),this.addLine(Qv,$v,e,n)):(this.addQuad(ey,iy,sy,ny,e,i,n,s),this.addQuad(iy,Zv,ty,sy,e,i,n,s),this.addQuad(Zv,$v,Qv,ty,e,i,n,s),this.addQuad($v,ey,ny,Qv,e,i,n,s),this.addQuad(ny,sy,ty,Qv,e,i,n,s),this.addQuad($v,Zv,iy,ey,e,i,n,s))}addCross(t,e,i,n=!0){const s=.5*e,r=new mi(t.x-s,t.y,t.z),o=new mi(t.x+s,t.y,t.z);this.addLine(r,o,i,n),r.set(t.x,t.y-s,t.z),o.set(t.x,t.y+s,t.z),this.addLine(r,o,i,n),r.set(t.x,t.y,t.z-s),o.set(t.x,t.y,t.z+s),this.addLine(r,o,i,n)}addFrustum(t,e,i=!0){const n=t.vertices;this.addLine(n[0],n[1],e,i),this.addLine(n[1],n[2],e,i),this.addLine(n[2],n[3],e,i),this.addLine(n[3],n[0],e,i),this.addLine(n[4],n[5],e,i),this.addLine(n[5],n[6],e,i),this.addLine(n[6],n[7],e,i),this.addLine(n[7],n[4],e,i),this.addLine(n[0],n[4],e,i),this.addLine(n[1],n[5],e,i),this.addLine(n[2],n[6],e,i),this.addLine(n[3],n[7],e,i)}addCapsule(t,e,i,n,s=32,r=8,o=!0,a=!0,c=!1,l=!1,h=new Ii){const _=2*Math.PI/s,u=Math.PI/2/r,d=new mi(t.x,t.y-i/2,t.z),m=new mi(t.x,t.y+i/2,t.z),p=new Array,f=new Array;for(let t=0;t<r+1;t++){const i=new Array,n=new Array,r=t*u,o=Math.sin(r),a=Math.cos(r);for(let t=0;t<s+1;t++){const s=t*_,r=Math.sin(s),c=Math.cos(s),l=new mi(e*o*c,e*a,e*o*r),h=new mi(d.x+l.x,d.y-l.y,d.z+l.z),u=new mi(m.x+l.x,m.y+l.y,m.z+l.z);i.push(h),n.push(u)}p.push(i),f.push(n)}if(l)for(let t=0;t<r+1;t++)for(let e=0;e<s+1;e++)mi.transformMat4(p[t][e],p[t][e],h),mi.transformMat4(f[t][e],f[t][e],h);for(let t=0;t<r;t++)for(let e=0;e<s;e++)this.addTriangle(p[t+1][e],p[t][e+1],p[t][e],n,o,a,c),this.addTriangle(p[t+1][e],p[t+1][e+1],p[t][e+1],n,o,a,c),this.addTriangle(f[t][e],f[t+1][e+1],f[t+1][e],n,o,a,c),this.addTriangle(f[t][e],f[t][e+1],f[t+1][e+1],n,o,a,c);const g=p[r],v=f[r];for(let t=0;t<s;t++)this.addTriangle(v[t],g[t+1],g[t],n,o,a,c),this.addTriangle(v[t],v[t+1],g[t+1],n,o,a,c)}addCylinder(t,e,i,n,s=32,r=!0,o=!0,a=!1,c=!1,l=new Ii){const h=2*Math.PI/s,_=new mi(t.x,t.y-i/2,t.z),u=new mi(t.x,t.y+i/2,t.z),d=new Array,m=new Array;for(let t=0;t<s+1;t++){const i=t*h,n=new mi(e*Math.cos(i),0,e*Math.sin(i)),s=new mi(n.x+_.x,n.y+_.y,n.z+_.z),r=new mi(n.x+u.x,n.y+u.y,n.z+u.z);d.push(s),m.push(r)}if(c){mi.transformMat4(_,_,l),mi.transformMat4(u,u,l);for(let t=0;t<s+1;t++)mi.transformMat4(d[t],d[t],l),mi.transformMat4(m[t],m[t],l)}for(let t=0;t<s;t++)this.addTriangle(u,m[t+1],m[t],n,r,o,a),this.addTriangle(_,d[t],d[t+1],n,r,o,a),this.addTriangle(m[t],d[t+1],d[t],n,r,o,a),this.addTriangle(m[t],m[t+1],d[t+1],n,r,o,a)}addCone(t,e,i,n,s=32,r=!0,o=!0,a=!1,c=!1,l=new Ii){const h=2*Math.PI/s,_=new mi(t.x,t.y-i/2,t.z),u=new mi(t.x,t.y+i/2,t.z),d=new Array;for(let t=0;t<s+1;t++){const i=new mi(e*Math.cos(t*h),0,e*Math.sin(t*h)),n=new mi(i.x+_.x,i.y+_.y,i.z+_.z);d.push(n)}if(c){mi.transformMat4(_,_,l),mi.transformMat4(u,u,l);for(let t=0;t<s+1;t++)mi.transformMat4(d[t],d[t],l)}for(let t=0;t<s;t++)this.addTriangle(u,d[t+1],d[t],n,r,o,a),this.addTriangle(_,d[t],d[t+1],n,r,o,a)}addCircle(t,e,i,n=32,s=!0,r=!1,o=new Ii){const a=2*Math.PI/n,c=new Array;for(let i=0;i<n+1;i++){const n=new mi(e*Math.cos(i*a),0,e*Math.sin(i*a)),s=new mi(n.x+t.x,n.y+t.y,n.z+t.z);c.push(s)}if(r)for(let t=0;t<n+1;t++)mi.transformMat4(c[t],c[t],o);for(let t=0;t<n;t++)this.addLine(c[t],c[t+1],i,s)}addArc(t,e,i,n,s,r=32,o=!0,a=!1,c=new Ii){const l=Ye(n),h=(Ye(s)-l)/r,_=new Array;for(let i=0;i<r+1;i++){const n=new mi(e*Math.cos(i*h+l),0,e*Math.sin(i*h+l)),s=new mi(n.x+t.x,n.y+t.y,n.z+t.z);_.push(s)}if(a)for(let t=0;t<r+1;t++)mi.transformMat4(_[t],_[t],c);for(let t=0;t<r;t++)this.addLine(_[t],_[t+1],i,o)}addPolygon(t,e,i,n=6,s=!0,r=!0,o=!1,a=!1,c=new Ii){s?this.addCircle(t,e,i,n,r,a,c):this.addDisc(t,e,i,n,s,r,o,a,c)}addDisc(t,e,i,n=32,s=!0,r=!0,o=!1,a=!1,c=new Ii){const l=2*Math.PI/n,h=new Array,_=new mi(t);for(let t=0;t<n+1;t++){const i=new mi(e*Math.cos(t*l),0,e*Math.sin(t*l)),n=new mi(i.x+_.x,i.y+_.y,i.z+_.z);h.push(n)}if(a){mi.transformMat4(_,_,c);for(let t=0;t<n+1;t++)mi.transformMat4(h[t],h[t],c)}for(let t=0;t<n;t++)this.addTriangle(_,h[t],h[t+1],i,s,r,o);if(!s)for(let t=0;t<n;t++)this.addTriangle(_,h[t+1],h[t],i,s,r,o)}addSector(t,e,i,n,s,r=32,o=!0,a=!0,c=!1,l=!1,h=new Ii){const _=Ye(n),u=(Ye(s)-_)/r,d=new Array,m=new mi(t);for(let t=0;t<r+1;t++){const i=new mi(e*Math.cos(t*u),0,e*Math.sin(t*u)),n=new mi(i.x+m.x,i.y+m.y,i.z+m.z);d.push(n)}if(l){mi.transformMat4(m,m,h);for(let t=0;t<r+1;t++)mi.transformMat4(d[t],d[t],h)}for(let t=0;t<r;t++)this.addTriangle(m,d[t],d[t+1],i,o,a,c);if(!o)for(let t=0;t<r;t++)this.addTriangle(m,d[t+1],d[t],i,o,a,c)}addSphere(t,e,i,n=32,s=16,r=!0,o=!0,a=!1,c=!1,l=new Ii){const h=2*Math.PI/n,_=Math.PI/s,u=new Array;for(let i=0;i<s+1;i++){const s=new Array,r=i*_,o=Math.sin(r),a=Math.cos(r);for(let i=0;i<n+1;i++){const n=i*h,r=Math.sin(n),c=Math.cos(n),l=new mi(e*o*c,e*a,e*o*r),_=new mi(t.x+l.x,t.y+l.y,t.z+l.z);s.push(_)}u.push(s)}if(c)for(let t=0;t<s+1;t++)for(let e=0;e<n+1;e++)mi.transformMat4(u[t][e],u[t][e],l);for(let t=0;t<s;t++)for(let e=0;e<n;e++)this.addTriangle(u[t][e],u[t+1][e+1],u[t+1][e],i,r,o,a),this.addTriangle(u[t][e],u[t][e+1],u[t+1][e+1],i,r,o,a)}addTorus(t,e,i,n,s=32,r=16,o=!0,a=!0,c=!1,l=!1,h=new Ii){const _=2*Math.PI/s,u=2*Math.PI/r,d=new Array;for(let n=0;n<s+1;n++){const s=new Array,o=n*_,a=Math.sin(o),c=Math.cos(o);for(let n=0;n<r+1;n++){const r=n*u,o=Math.sin(r),l=Math.cos(r),h=new mi((e+i*l)*c,i*o,(e+i*l)*a),_=new mi(t.x+h.x,t.y+h.y,t.z+h.z);s.push(_)}d.push(s)}if(l)for(let t=0;t<s+1;t++)for(let e=0;e<r+1;e++)mi.transformMat4(d[t][e],d[t][e],h);for(let t=0;t<s;t++)for(let e=0;e<r;e++)this.addTriangle(d[t][e+1],d[t+1][e],d[t][e],n,o,a,c),this.addTriangle(d[t][e+1],d[t+1][e+1],d[t+1][e],n,o,a,c)}addOctahedron(t,e,i,n=!0,s=!0,r=!1,o=!1,a=new Ii){const c=new Array;if(c.push(new mi(e+t.x,t.y,t.z)),c.push(new mi(t.x,t.y,t.z-e)),c.push(new mi(-e+t.x,t.y,t.z)),c.push(new mi(t.x,t.y,t.z+e)),c.push(new mi(t.x,t.y+e,t.z)),c.push(new mi(t.x,t.y-e,t.z)),o)for(let t=0;t<c.length;t++)mi.transformMat4(c[t],c[t],a);n?(this.addLine(c[0],c[1],i,s),this.addLine(c[1],c[2],i,s),this.addLine(c[2],c[3],i,s),this.addLine(c[3],c[0],i,s),this.addLine(c[0],c[4],i,s),this.addLine(c[1],c[4],i,s),this.addLine(c[2],c[4],i,s),this.addLine(c[3],c[4],i,s),this.addLine(c[0],c[5],i,s),this.addLine(c[1],c[5],i,s),this.addLine(c[2],c[5],i,s),this.addLine(c[3],c[5],i,s)):(this.addTriangle(c[0],c[1],c[4],i,n,s,r),this.addTriangle(c[1],c[2],c[4],i,n,s,r),this.addTriangle(c[2],c[3],c[4],i,n,s,r),this.addTriangle(c[3],c[0],c[4],i,n,s,r),this.addTriangle(c[0],c[3],c[5],i,n,s,r),this.addTriangle(c[3],c[2],c[5],i,n,s,r),this.addTriangle(c[2],c[1],c[5],i,n,s,r),this.addTriangle(c[1],c[0],c[5],i,n,s,r))}addBezier(t,e,i,n,s,r=32,o=!0,a=!1,c=new Ii){const l=1/r,h=new Array,_=new mi(t),u=new mi(e),d=new mi(i),m=new mi(n);a&&(mi.transformMat4(_,_,c),mi.transformMat4(u,u,c),mi.transformMat4(d,d,c),mi.transformMat4(m,m,c));for(let t=0;t<r+1;t++){const e=t*l,i=(1-e)*(1-e)*(1-e),n=3*e*(1-e)*(1-e),s=3*e*e*(1-e),r=e*e*e,o=new mi(i*_.x+n*u.x+s*d.x+r*m.x,i*_.y+n*u.y+s*d.y+r*m.y,i*_.z+n*u.z+s*d.z+r*m.z);h.push(o)}for(let t=0;t<r;t++)this.addLine(h[t],h[t+1],s,o)}addMesh(t,e,i,n=!0,s=!1,r=new Ii){for(let o=0;o<e.length;o+=3){const a=new mi(t.x+e[o].x,t.y+e[o].y,t.z+e[o].z),c=new mi(t.x+e[o+1].x,t.y+e[o+1].y,t.z+e[o+1].z),l=new mi(t.x+e[o+2].x,t.y+e[o+2].y,t.z+e[o+2].z);s&&(mi.transformMat4(a,a,r),mi.transformMat4(c,c,r),mi.transformMat4(l,l,r)),this.addLine(a,c,i,n),this.addLine(c,l,i,n),this.addLine(l,a,i,n)}}addIndexedMesh(t,e,i,n,s=!0,r=!1,o=new Ii){for(let a=0;a<i.length;a+=3){const c=new mi(t.x+e[i[a]].x,t.y+e[i[a]].y,t.z+e[i[a]].z),l=new mi(t.x+e[i[a+1]].x,t.y+e[i[a+1]].y,t.z+e[i[a+1]].z),h=new mi(t.x+e[i[a+2]].x,t.y+e[i[a+2]].y,t.z+e[i[a+2]].z);r&&(mi.transformMat4(c,c,o),mi.transformMat4(l,l,o),mi.transformMat4(h,h,o)),this.addLine(c,l,n,s),this.addLine(l,h,n,s),this.addLine(h,c,n,s)}}}const ly=new Ii,hy=new Ii,_y=new Ii,uy=new Fi,dy=new Fi(0,0,1,0);class my{constructor(){this._globalUBO=new Float32Array(cm.COUNT),this._cameraUBO=new Float32Array(lm.COUNT),this._shadowUBO=new Float32Array(hm.COUNT)}static updateGlobalUBOView(t,e){const i=l.director.root,n=e,s=Math.floor(t.width),r=Math.floor(t.height);n[cm.TIME_OFFSET]=i.cumulativeTime,n[cm.TIME_OFFSET+1]=i.frameTime,n[cm.TIME_OFFSET+2]=l.director.getTotalFrames(),n[cm.SCREEN_SIZE_OFFSET]=s,n[cm.SCREEN_SIZE_OFFSET+1]=r,n[cm.SCREEN_SIZE_OFFSET+2]=1/s,n[cm.SCREEN_SIZE_OFFSET+3]=1/r,n[cm.NATIVE_SIZE_OFFSET]=s,n[cm.NATIVE_SIZE_OFFSET+1]=r,n[cm.NATIVE_SIZE_OFFSET+2]=1/n[cm.NATIVE_SIZE_OFFSET],n[cm.NATIVE_SIZE_OFFSET+3]=1/n[cm.NATIVE_SIZE_OFFSET+1]}static updateCameraUBOView(t,e,i){var n;const s=(i.scene?i.scene:l.director.getScene().renderScene).mainLight,r=t.pipelineSceneData,o=r.ambient,a=r.skybox,c=r.fog,h=r.shadows,_=e,u=i.exposure,d=r.isHDR;if(_[lm.SCREEN_SCALE_OFFSET]=r.shadingScale,_[lm.SCREEN_SCALE_OFFSET+1]=r.shadingScale,_[lm.SCREEN_SCALE_OFFSET+2]=1/_[lm.SCREEN_SCALE_OFFSET],_[lm.SCREEN_SCALE_OFFSET+3]=1/_[lm.SCREEN_SCALE_OFFSET+1],_[lm.EXPOSURE_OFFSET]=u,_[lm.EXPOSURE_OFFSET+1]=1/u,_[lm.EXPOSURE_OFFSET+2]=d?1:0,_[lm.EXPOSURE_OFFSET+3]=1/dg.standardExposureValue,s){const t=s.shadowEnabled&&h.type===pg.ShadowMap?1:0,e=s.direction;if(dy.set(e.x,e.y,e.z,t),Fi.toArray(_,dy,lm.MAIN_LIT_DIR_OFFSET),mi.toArray(_,s.color,lm.MAIN_LIT_COLOR_OFFSET),s.useColorTemperature){const t=s.colorTemperatureRGB;_[lm.MAIN_LIT_COLOR_OFFSET]*=t.x,_[lm.MAIN_LIT_COLOR_OFFSET+1]*=t.y,_[lm.MAIN_LIT_COLOR_OFFSET+2]*=t.z}_[lm.MAIN_LIT_COLOR_OFFSET+3]=d?s.illuminance*u:s.illuminance}else dy.set(0,0,1,0),Fi.toArray(_,dy,lm.MAIN_LIT_DIR_OFFSET),Fi.toArray(_,Fi.ZERO,lm.MAIN_LIT_COLOR_OFFSET);const m=o.skyColor;m.w=d?o.skyIllum*u:o.skyIllum,_[lm.AMBIENT_SKY_OFFSET+0]=m.x,_[lm.AMBIENT_SKY_OFFSET+1]=m.y,_[lm.AMBIENT_SKY_OFFSET+2]=m.z,_[lm.AMBIENT_SKY_OFFSET+3]=m.w,_[lm.AMBIENT_GROUND_OFFSET+0]=o.groundAlbedo.x,_[lm.AMBIENT_GROUND_OFFSET+1]=o.groundAlbedo.y,_[lm.AMBIENT_GROUND_OFFSET+2]=o.groundAlbedo.z,_[lm.AMBIENT_GROUND_OFFSET+3]=a.envmap?null===(n=a.envmap)||void 0===n?void 0:n.mipmapLevel:1,Ii.toArray(_,i.matView,lm.MAT_VIEW_OFFSET),Ii.toArray(_,i.node.worldMatrix,lm.MAT_VIEW_INV_OFFSET),mi.toArray(_,i.position,lm.CAMERA_POS_OFFSET),Ii.toArray(_,i.matProj,lm.MAT_PROJ_OFFSET),Ii.toArray(_,i.matProjInv,lm.MAT_PROJ_INV_OFFSET),Ii.toArray(_,i.matViewProj,lm.MAT_VIEW_PROJ_OFFSET),Ii.toArray(_,i.matViewProjInv,lm.MAT_VIEW_PROJ_INV_OFFSET),_[lm.CAMERA_POS_OFFSET+3]=this.getCombineSignY();const p=c.colorArray;_[lm.GLOBAL_FOG_COLOR_OFFSET]=p.x,_[lm.GLOBAL_FOG_COLOR_OFFSET+1]=p.y,_[lm.GLOBAL_FOG_COLOR_OFFSET+2]=p.z,_[lm.GLOBAL_FOG_COLOR_OFFSET+3]=p.z,_[lm.GLOBAL_FOG_BASE_OFFSET]=c.fogStart,_[lm.GLOBAL_FOG_BASE_OFFSET+1]=c.fogEnd,_[lm.GLOBAL_FOG_BASE_OFFSET+2]=c.fogDensity,_[lm.GLOBAL_FOG_ADD_OFFSET]=c.fogTop,_[lm.GLOBAL_FOG_ADD_OFFSET+1]=c.fogRange,_[lm.GLOBAL_FOG_ADD_OFFSET+2]=c.fogAtten,_[lm.NEAR_FAR_OFFSET]=i.nearClip,_[lm.NEAR_FAR_OFFSET+1]=i.farClip,_[lm.VIEW_PORT_OFFSET]=r.shadingScale*i.window.width*i.viewport.x,_[lm.VIEW_PORT_OFFSET+1]=r.shadingScale*i.window.height*i.viewport.y,_[lm.VIEW_PORT_OFFSET+2]=r.shadingScale*i.window.width*i.viewport.z,_[lm.VIEW_PORT_OFFSET+3]=r.shadingScale*i.window.height*i.viewport.w}static updateShadowUBOView(t,e,i){const n=t.device,s=i.scene.mainLight,r=t.pipelineSceneData.shadows,o=e;if(r.enabled){if(s&&s.shadowEnabled&&r.type===pg.ShadowMap){let t=.1,i=0;const a=r.matShadowView,c=r.matShadowProj,l=r.matShadowViewProj;s.shadowFixedArea?(t=s.shadowNear,i=s.shadowFar):(t=.1,i=r.shadowCameraFar),Ii.toArray(e,a,hm.MAT_LIGHT_VIEW_OFFSET),o[hm.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=c.m10,o[hm.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=c.m14,o[hm.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=c.m11,o[hm.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=c.m15,o[hm.SHADOW_PROJ_INFO_OFFSET+0]=c.m00,o[hm.SHADOW_PROJ_INFO_OFFSET+1]=c.m05,o[hm.SHADOW_PROJ_INFO_OFFSET+2]=1/c.m00,o[hm.SHADOW_PROJ_INFO_OFFSET+3]=1/c.m05,Ii.toArray(e,l,hm.MAT_LIGHT_VIEW_PROJ_OFFSET);const h=0,_=np(n)?0:1;o[hm.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=t,o[hm.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=i,o[hm.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=h,o[hm.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-s.shadowSaturation,o[hm.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,o[hm.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,o[hm.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=s.shadowPcf,o[hm.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=s.shadowBias,o[hm.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,o[hm.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=_,o[hm.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=s.shadowNormalBias,o[hm.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else s&&r.type===pg.Planar&&(function(t,e,i){const n=e.direction,s=t.normal,r=t.distance+.001,o=1/mi.dot(s,n),a=n.x*o,c=n.y*o,l=n.z*o,h=s.x,_=s.y,u=s.z,d=t.matLight;d.m00=1-h*a,d.m01=-h*c,d.m02=-h*l,d.m03=0,d.m04=-_*a,d.m05=1-_*c,d.m06=-_*l,d.m07=0,d.m08=-u*a,d.m09=-u*c,d.m10=1-u*l,d.m11=0,d.m12=a*r,d.m13=c*r,d.m14=l*r,d.m15=1,Ii.toArray(i,d,hm.MAT_LIGHT_PLANE_PROJ_OFFSET)}(r,s,o),function(t,e){mi.normalize(yg,t.normal),e[hm.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=yg.x,e[hm.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=yg.y,e[hm.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=yg.z,e[hm.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=t.distance}(r,o));hi.toArray(o,r.shadowColor,hm.SHADOW_COLOR_OFFSET)}}static updateShadowUBOLightView(t,e,i){const n=t.device,s=t.pipelineSceneData.shadows,r=e,o=np(n)?0:1;let a=.1,c=0;const l=s.matShadowView,h=s.matShadowProj,_=s.matShadowViewProj;switch(i.type){case Tv.DIRECTIONAL:{const t=i;t.shadowFixedArea?(a=t.shadowNear,c=t.shadowFar):(a=.1,c=s.shadowCameraFar),Ii.toArray(e,l,hm.MAT_LIGHT_VIEW_OFFSET),r[hm.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=h.m10,r[hm.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=h.m14,r[hm.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=h.m11,r[hm.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=h.m15,r[hm.SHADOW_PROJ_INFO_OFFSET+0]=h.m00,r[hm.SHADOW_PROJ_INFO_OFFSET+1]=h.m05,r[hm.SHADOW_PROJ_INFO_OFFSET+2]=1/h.m00,r[hm.SHADOW_PROJ_INFO_OFFSET+3]=1/h.m05,Ii.toArray(e,_,hm.MAT_LIGHT_VIEW_PROJ_OFFSET),uy.set(a,c,0,1-t.shadowSaturation),Fi.toArray(r,uy,hm.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),uy.set(0,o,t.shadowNormalBias,0),Fi.toArray(r,uy,hm.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),uy.set(s.size.x,s.size.y,t.shadowPcf,t.shadowBias),Fi.toArray(r,uy,hm.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET);break}case Tv.SPOT:{const t=i;Ii.invert(ly,i.node.getWorldMatrix()),Ii.toArray(r,ly,hm.MAT_LIGHT_VIEW_OFFSET),Ii.perspective(hy,i.angle,1,.001,i.range),Ii.multiply(_y,hy,ly),Ii.toArray(r,_y,hm.MAT_LIGHT_VIEW_PROJ_OFFSET),uy.set(.01,i.range,0,0),Fi.toArray(r,uy,hm.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),uy.set(1,o,t.shadowNormalBias,0),Fi.toArray(r,uy,hm.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),uy.set(s.size.x,s.size.y,t.shadowPcf,t.shadowBias),Fi.toArray(r,uy,hm.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET);break}}hi.toArray(r,s.shadowColor,hm.SHADOW_COLOR_OFFSET)}static getCombineSignY(){return my._combineSignY}_initCombineSignY(){const t=this._device;my._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5}activate(t,e){this._device=t,this._pipeline=e;const i=this._pipeline.descriptorSet;this._initCombineSignY();const n=t.createBuffer(new Zn(en.UNIFORM|en.TRANSFER_DST,rn.HOST|rn.DEVICE,cm.SIZE,cm.SIZE));i.bindBuffer(cm.BINDING,n);const s=t.createBuffer(new Zn(en.UNIFORM|en.TRANSFER_DST,rn.HOST|rn.DEVICE,lm.SIZE,lm.SIZE));i.bindBuffer(lm.BINDING,s);const r=t.createBuffer(new Zn(en.UNIFORM|en.TRANSFER_DST,rn.HOST|rn.DEVICE,hm.SIZE,hm.SIZE));i.bindBuffer(hm.BINDING,r)}updateGlobalUBO(t){const e=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers;i.update(),my.updateGlobalUBOView(t,this._globalUBO),n[0].updateBuffer(i.getBuffer(cm.BINDING),this._globalUBO),e.bindBuffer(cm.BINDING,i.getBuffer(cm.BINDING)),e.update()}updateCameraUBO(t){const e=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers;my.updateCameraUBOView(this._pipeline,this._cameraUBO,t),n[0].updateBuffer(i.getBuffer(lm.BINDING),this._cameraUBO),e.bindBuffer(lm.BINDING,i.getBuffer(lm.BINDING)),e.update()}updateShadowUBO(t){const e=this._pipeline.pipelineSceneData;if(!e.shadows.enabled)return;const i=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers,s=e.shadowFrameBufferMap,r=t.scene.mainLight;r&&s.has(r)&&i.bindTexture(_m,s.get(r).colorTextures[0]),my.updateShadowUBOView(this._pipeline,this._shadowUBO,t),i.update(),n[0].updateBuffer(i.getBuffer(hm.BINDING),this._shadowUBO)}updateShadowUBOLight(t,e){my.updateShadowUBOLightView(this._pipeline,this._shadowUBO,e),t.bindTexture(_m,Mf.get("default-texture").getGFXTexture()),t.bindTexture(xm,Mf.get("default-texture").getGFXTexture()),t.update(),t.getBuffer(hm.BINDING).update(this._shadowUBO)}updateShadowUBORange(t,e){e instanceof Ii?Ii.toArray(this._shadowUBO,e,t):e instanceof hi&&hi.toArray(this._shadowUBO,e,t)}destroy(){}}var py,fy,gy,vy,yy,xy,Sy,Cy,Ay;my._combineSignY=0;let by=(py=dc("RenderStage"),fy=kc(),gy=kc(),vy=kc(),py((Sy=sc((xy=class{constructor(){nc(this,"_name",Sy,this),nc(this,"_priority",Cy,this),this._enabled=!0,nc(this,"_tag",Ay,this)}get name(){return this._name}get priority(){return this._priority}get tag(){return this._tag}set enabled(t){this._enabled=t}get enabled(){return this._enabled}initialize(t){return this._name=t.name,this._priority=t.priority,t.tag&&(this._tag=t.tag),!0}activate(t,e){this._pipeline=t,this._flow=e}}).prototype,"_name",[fy,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Cy=sc(xy.prototype,"_priority",[gy,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ay=sc(xy.prototype,"_tag",[vy,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yy=xy))||yy);var Ty,Ey,Py,wy,Iy,Ry,Dy,My,Oy,By,Ny,Ly;l.RenderStage=by;let Fy,zy=(Ty=dc("RenderFlow"),Ey=kc(),Py=kc(),wy=kc(),Iy=kc(),Ry=Kc([by]),Ty((Oy=sc((My=class{constructor(){nc(this,"_name",Oy,this),nc(this,"_priority",By,this),nc(this,"_tag",Ny,this),nc(this,"_stages",Ly,this)}get name(){return this._name}get priority(){return this._priority}get tag(){return this._tag}get stages(){return this._stages}get pipeline(){return this._pipeline}initialize(t){return this._name=t.name,this._priority=t.priority,this._stages=t.stages,t.tag&&(this._tag=t.tag),!0}activate(t){this._pipeline=t,this._stages.sort(((t,e)=>t.priority-e.priority));for(let e=0,i=this._stages.length;e<i;e++)this._stages[e].activate(t,this)}render(t){for(let e=0,i=this._stages.length;e<i;e++)this._stages[e].enabled&&this._stages[e].render(t)}destroy(){for(let t=0,e=this._stages.length;t<e;t++)this._stages[t].destroy();this._stages.length=0}}).prototype,"_name",[Ey,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),By=sc(My.prototype,"_priority",[Py,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ny=sc(My.prototype,"_tag",[wy,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ly=sc(My.prototype,"_stages",[Iy,Ry,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dy=My))||Dy);l.RenderFlow=zy,function(t){t.RENDER_FRAME_BEGIN="render-frame-begin",t.RENDER_FRAME_END="render-frame-end",t.RENDER_CAMERA_BEGIN="render-camera-begin",t.RENDER_CAMERA_END="render-camera-end",t.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(Fy||(Fy=t("PipelineEventType",{})));class Vy extends Hl{constructor(...t){super(...t),this.eventTargetOn=super.on,this.eventTargetOnce=super.once}on(t,e,i,n){return this.eventTargetOn(t,e,i,n)}once(t,e,i){return this.eventTargetOnce(t,e,i)}}var Gy,Uy,ky,Hy,jy,Wy,qy,Xy;t("PipelineEventProcessor",Vy);const Yy=new Gn,Ky=new Xn;class Jy{constructor(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null}}class $y{constructor(){this.quadIB=null,this.quadVB=null,this.quadIA=null}}let Zy=(Gy=dc("cc.RenderPipeline"),Uy=kc(),ky=kc(),Hy=Kc([zy]),Gy((qy=sc((Wy=class extends fh{constructor(...t){super(...t),nc(this,"_tag",qy,this),nc(this,"_flows",Xy,this),this._quadIB=null,this._quadVBOnscreen=null,this._quadVBOffscreen=null,this._quadIAOnscreen=null,this._quadIAOffscreen=null,this._eventProcessor=new Vy,this._commandBuffers=[],this._pipelineUBO=new my,this._macros={},this._constantMacros="",this._profiler=null,this._geometryRenderer=new cy,this._pipelineRenderData=null,this._renderPasses=new Map,this._width=0,this._height=0,this._lastUsedRenderArea=new Gn,this._clusterEnabled=!1,this._bloomEnabled=!1}get tag(){return this._tag}get flows(){return this._flows}get quadIAOnscreen(){return this._quadIAOnscreen}get quadIAOffscreen(){return this._quadIAOffscreen}getPipelineRenderData(){return this._pipelineRenderData}get constantMacros(){return this._constantMacros}get macros(){return this._macros}get device(){return this._device}get globalDSManager(){return this._globalDSManager}get descriptorSetLayout(){return this._globalDSManager.descriptorSetLayout}get descriptorSet(){return this._descriptorSet}get commandBuffers(){return this._commandBuffers}get pipelineUBO(){return this._pipelineUBO}get pipelineSceneData(){return this._pipelineSceneData}set profiler(t){this._profiler=t}get profiler(){return this._profiler}get geometryRenderer(){return this._geometryRenderer}set clusterEnabled(t){this._clusterEnabled=t}get clusterEnabled(){return this._clusterEnabled}set bloomEnabled(t){this._bloomEnabled=t}get bloomEnabled(){return this._bloomEnabled}initialize(t){return this._flows=t.flows,t.tag&&(this._tag=t.tag),!0}createRenderPass(t,e,i){const n=this._device,s=new ys,r=new xs;s.format=e,r.format=i,r.stencilStoreOp=Sn.DISCARD,r.depthStoreOp=Sn.DISCARD,t&Nn.COLOR||(t&_g?s.loadOp=xn.DISCARD:(s.loadOp=xn.LOAD,s.barrier=n.getGeneralBarrier(new bs(Cn.COLOR_ATTACHMENT_WRITE,Cn.COLOR_ATTACHMENT_WRITE)))),(t&Nn.DEPTH_STENCIL)!==Nn.DEPTH_STENCIL&&(t&Nn.DEPTH||(r.depthLoadOp=xn.LOAD),t&Nn.STENCIL||(r.stencilLoadOp=xn.LOAD)),r.barrier=n.getGeneralBarrier(new bs(Cn.DEPTH_STENCIL_ATTACHMENT_WRITE,Cn.DEPTH_STENCIL_ATTACHMENT_WRITE));const o=new As([s],r);return n.createRenderPass(o)}getRenderPass(t,e){let i=this._renderPasses.get(t);return i||(i=this.createRenderPass(t,e.colorTextures[0].format,e.depthStencilTexture.format),this._renderPasses.set(t,i),i)}applyFramebufferRatio(t){const e=this.pipelineSceneData,i=this._width*e.shadingScale,n=this._height*e.shadingScale,s=t.colorTextures;for(let t=0;t<s.length;t++)s[t].resize(i,n);t.depthStencilTexture&&t.depthStencilTexture.resize(i,n),t.destroy(),t.initialize(new Es(t.renderPass,s,t.depthStencilTexture))}generateRenderArea(t,e){const i=t.viewport,n=t.window.width,s=t.window.height;e.x=i.x*n,e.y=i.y*s,e.width=i.width*n,e.height=i.height*s}generateViewport(t,e){this.generateRenderArea(t,Yy),e||(e=Ky);const i=this.pipelineSceneData.shadingScale;return e.left=Yy.x*i,e.top=Yy.y*i,e.width=Yy.width*i,e.height=Yy.height*i,e}generateScissor(t,e){e||(e=Yy),this.generateRenderArea(t,e);const i=this.pipelineSceneData.shadingScale;return e.x*=i,e.y*=i,e.width*=i,e.height*=i,e}activate(t){const e=l.director.root;this._device=e.device,this._generateConstantMacros(),this._globalDSManager=new Zg(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this),this._geometryRenderer.activate(this._device,this);for(let t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0}_ensureEnoughSize(t){}render(t){if(0!==t.length){this._commandBuffers[0].begin(),this.emit(Fy.RENDER_FRAME_BEGIN,t),this._ensureEnoughSize(t),function(t){for(let e=t.length-1;e>=0;--e)if(t[e].window.swapchain)return}(t);for(let e=0;e<t.length;e++){const i=t[e];if(i.scene){this.emit(Fy.RENDER_CAMERA_BEGIN,i),Yg(this,i),Kg(this,i),this._pipelineUBO.updateGlobalUBO(i.window),this._pipelineUBO.updateCameraUBO(i);for(let t=0;t<this._flows.length;t++)this._flows[t].render(i);this.emit(Fy.RENDER_CAMERA_END,i)}}this.emit(Fy.RENDER_FRAME_END,t),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}}_destroyQuadInputAssembler(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)}_destroyBloomData(){var t;const e=this._pipelineRenderData.bloom;if(null!==e){e.prefiterTex&&e.prefiterTex.destroy(),e.prefilterFramebuffer&&e.prefilterFramebuffer.destroy();for(let t=0;t<e.downsampleTexs.length;++t)e.downsampleTexs[t].destroy(),e.downsampleFramebuffers[t].destroy();e.downsampleTexs.length=0,e.downsampleFramebuffers.length=0;for(let t=0;t<e.upsampleTexs.length;++t)e.upsampleTexs[t].destroy(),e.upsampleFramebuffers[t].destroy();e.upsampleTexs.length=0,e.upsampleFramebuffers.length=0,e.combineTex&&e.combineTex.destroy(),e.combineFramebuffer&&e.combineFramebuffer.destroy(),null===(t=e.renderPass)||void 0===t||t.destroy(),this._pipelineRenderData.bloom=null}}_genQuadVertexData(t,e){const i=new Float32Array(16),n=e.x/this._width,s=(e.x+e.width)/this._width;let r=e.y/this._height,o=(e.y+e.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){const t=o;o=r,r=t}let a=0;switch(t){case Ji.IDENTITY:a=0,i[a++]=-1,i[a++]=-1,i[a++]=n,i[a++]=o,i[a++]=1,i[a++]=-1,i[a++]=s,i[a++]=o,i[a++]=-1,i[a++]=1,i[a++]=n,i[a++]=r,i[a++]=1,i[a++]=1,i[a++]=s,i[a++]=r;break;case Ji.ROTATE_90:a=0,i[a++]=-1,i[a++]=-1,i[a++]=s,i[a++]=o,i[a++]=1,i[a++]=-1,i[a++]=s,i[a++]=r,i[a++]=-1,i[a++]=1,i[a++]=n,i[a++]=o,i[a++]=1,i[a++]=1,i[a++]=n,i[a++]=r;break;case Ji.ROTATE_180:a=0,i[a++]=-1,i[a++]=-1,i[a++]=n,i[a++]=r,i[a++]=1,i[a++]=-1,i[a++]=s,i[a++]=r,i[a++]=-1,i[a++]=1,i[a++]=n,i[a++]=o,i[a++]=1,i[a++]=1,i[a++]=s,i[a++]=o;break;case Ji.ROTATE_270:a=0,i[a++]=-1,i[a++]=-1,i[a++]=n,i[a++]=r,i[a++]=1,i[a++]=-1,i[a++]=n,i[a++]=o,i[a++]=-1,i[a++]=1,i[a++]=s,i[a++]=r,i[a++]=1,i[a++]=1,i[a++]=s,i[a++]=o}return i}_createQuadInputAssembler(){const t=new $y,e=4*Float32Array.BYTES_PER_ELEMENT,i=4*e,n=this._device.createBuffer(new Zn(en.VERTEX|en.TRANSFER_DST,rn.DEVICE|rn.HOST,i,e));if(!n)return t;const s=Uint8Array.BYTES_PER_ELEMENT,r=6*s,o=this._device.createBuffer(new Zn(en.INDEX|en.TRANSFER_DST,rn.DEVICE,r,s));if(!o)return t;const a=new Uint8Array(6);a[0]=0,a[1]=1,a[2]=2,a[3]=1,a[4]=3,a[5]=2,o.update(a);const c=new Array(2);c[0]=new fs("a_position",Zi.RG32F),c[1]=new fs("a_texCoord",Zi.RG32F);const l=this._device.createInputAssembler(new vs(c,[n],o));return t.quadIB=o,t.quadVB=n,t.quadIA=l,t}updateQuadVertexData(t,e){const i=this._lastUsedRenderArea;if(i.x===t.x&&i.y===t.y&&i.width===t.width&&i.height===t.height)return;const n=this._genQuadVertexData(Ji.IDENTITY,t);this._quadVBOffscreen.update(n);const s=this._genQuadVertexData(e.swapchain&&e.swapchain.surfaceTransform||Ji.IDENTITY,t);this._quadVBOnscreen.update(s),i.copy(t)}destroy(){var t,e;for(let t=0;t<this._flows.length;t++)this._flows[t].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(let t=0;t<this._commandBuffers.length;t++)this._commandBuffers[t].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(e=this._pipelineSceneData)||void 0===e||e.destroy(),this._geometryRenderer.destroy(),super.destroy()}_generateConstantMacros(){let t="";t+=`#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE ${this.device.getFormatFeatures(Zi.RGBA32F)&(ln.RENDER_TARGET|ln.SAMPLED_TEXTURE)?1:0}\n`,t+=`#define CC_ENABLE_CLUSTERED_LIGHT_CULLING ${this._clusterEnabled?1:0}\n`,t+=`#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS ${this.device.capabilities.maxVertexUniformVectors}\n`,t+=`#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS ${this.device.capabilities.maxFragmentUniformVectors}\n`,t+=`#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT ${this.device.hasFeature($i.INPUT_ATTACHMENT_BENEFIT)?1:0}\n`,t+=`#define CC_PLATFORM_ANDROID_AND_WEBGL ${Zl.os===Xl.ANDROID&&Zl.isBrowser?1:0}\n`,t+=`#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES ${Kt.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0}\n`,this._constantMacros=t}generateBloomRenderData(){if(null!=this._pipelineRenderData.bloom)return;const t=this._pipelineRenderData.bloom=new Jy,e=this.device,i=new ys;i.format=Zi.RGBA8,i.loadOp=xn.CLEAR,i.storeOp=Sn.STORE,i.barrier=e.getGeneralBarrier(new bs(Cn.NONE,Cn.COLOR_ATTACHMENT_WRITE)),t.renderPass=e.createRenderPass(new As([i]));let n=this._width,s=this._height;t.prefiterTex=e.createTexture(new ss(on.TEX2D,an.COLOR_ATTACHMENT|an.SAMPLED,Zi.RGBA8,n>>1,s>>1)),t.prefilterFramebuffer=e.createFramebuffer(new Es(t.renderPass,[t.prefiterTex])),n>>=1,s>>=1;for(let i=0;i<6;++i)t.downsampleTexs.push(e.createTexture(new ss(on.TEX2D,an.COLOR_ATTACHMENT|an.SAMPLED,Zi.RGBA8,n>>1,s>>1))),t.downsampleFramebuffers[i]=e.createFramebuffer(new Es(t.renderPass,[t.downsampleTexs[i]])),t.upsampleTexs.push(e.createTexture(new ss(on.TEX2D,an.COLOR_ATTACHMENT|an.SAMPLED,Zi.RGBA8,n,s))),t.upsampleFramebuffers[i]=e.createFramebuffer(new Es(t.renderPass,[t.upsampleTexs[i]])),n>>=1,s>>=1;t.combineTex=e.createTexture(new ss(on.TEX2D,an.COLOR_ATTACHMENT|an.SAMPLED,Zi.RGBA8,this._width,this._height)),t.combineFramebuffer=e.createFramebuffer(new Es(t.renderPass,[t.combineTex])),t.sampler=this.globalDSManager.linearSampler}on(t,e,i,n){return this._eventProcessor.on(t,e,i,n)}once(t,e,i){return this._eventProcessor.once(t,e,i)}off(t,e,i){this._eventProcessor.off(t,e,i)}emit(t,e,i,n,s,r){this._eventProcessor.emit(t,e,i,n,s,r)}targetOff(t){this._eventProcessor.targetOff(t)}removeAll(t){this._eventProcessor.removeAll(t)}hasEventListener(t,e,i){return this._eventProcessor.hasEventListener(t,e,i)}}).prototype,"_tag",[Uy,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xy=sc(Wy.prototype,"_flows",[ky,Hy,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jy=Wy))||jy);function Qy(t,e){for(const i of e)Array.isArray(i)?Qy(t,i):t.push(i)}function tx(t){const e=[];return Qy(e,t),e.join("")}l.RenderPipeline=Zy;const ex=il.Flags.Destroyed,ix=il.Flags.PersistentMask,nx=Le.IDENTIFIER_RE,sx="var ",rx="o",ox={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},ax=Le.escapeForJS;class cx{constructor(t,e){this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=e}toString(){return`${sx+this.varName}=${this.expression};`}}function lx(t,e){return e instanceof cx?new cx(e.varName,t+e.expression):t+e}function hx(t,e,i){Array.isArray(i)?(i[0]=lx(e,i[0]),t.push(i)):t.push(`${lx(e,i)};`)}class _x{constructor(t){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}append(t,e){this._exps.push([t,e])}writeCode(t){let e;if(this._exps.length>1)t.push(`t=${this._targetExp};`),e="t";else{if(1!==this._exps.length)return;e=this._targetExp}for(let i=0;i<this._exps.length;i++){const n=this._exps[i];hx(t,`${e+ux(n[0])}=`,n[1])}}}function ux(t){return nx.test(t)?`.${t}`:`[${ax(t)}]`}_x.pool=void 0,_x.pool=new Vt((t=>{t._exps.length=0,t._targetExp=null}),1),_x.pool.get=function(t){const e=this._get()||new _x;return e._targetExp=t,e};class dx{constructor(t,e){let i;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=e,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=ut(),At(this.funcModuleCache,ox),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{",`o=R=new ${this.getFuncModule(t.constructor,!0)}();`,"}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(i=`${sx+this.globalVariables.join(",")};`);const n=tx(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",n)(this.objs,this.funcs);for(let t=0,e=this.objsToClear_iN$t.length;t<e;++t)this.objsToClear_iN$t[t]._iN$t=null;this.objsToClear_iN$t.length=0}getFuncModule(t,e){const i=dt(t);if(i){const e=this.funcModuleCache[i];if(e)return e;if(void 0===e){let e=-1!==i.indexOf(".");if(e)try{if(e=t===Function(`return ${i}`)(),e)return this.funcModuleCache[i]=i,i}catch(t){}}}let n=this.funcs.indexOf(t);n<0&&(n=this.funcs.length,this.funcs.push(t));let s=`F[${n}]`;return e&&(s=`(${s})`),this.funcModuleCache[i]=s,s}getObjRef(t){let e=this.objs.indexOf(t);return e<0&&(e=this.objs.length,this.objs.push(t)),`O[${e}]`}setValueType(t,e,i,n){const s=_x.pool.get(n);let r=e.constructor.__props__;r||(r=Object.keys(e));for(let t=0;t<r.length;t++){const n=r[t],o=i[n];if(e[n]===o)continue;const a=this.enumerateField(i,n,o);s.append(n,a)}s.writeCode(t),_x.pool.put(s)}enumerateCCClass(t,e,i){const n=i.__values__,s=ue(i);for(let i=0;i<n.length;i++){const r=n[i],o=e[r];let a=s[r+"$_$default"];if(!mx(a,o))if("object"==typeof o&&o instanceof l.ValueType&&(a=Le.getDefault(a),a&&a.constructor===o.constructor)){const e=rx+ux(r);this.setValueType(t,a,o,e)}else this.setObjProp(t,e,r,o)}}instantiateArray(t){if(0===t.length)return"[]";const e="a"+ ++this.localVariableId,i=[new cx(e,`new Array(${t.length})`)];t._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(t);for(let n=0;n<t.length;++n)hx(i,`${e}[${n}]=`,this.enumerateField(t,n,t[n]));return i}instantiateTypedArray(t){const e=t.constructor.name;if(0===t.length)return`new ${e}`;const i="a"+ ++this.localVariableId,n=[new cx(i,`new ${e}(${t.length})`)];t._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(t);for(let e=0;e<t.length;++e)0!==t[e]&&hx(n,`${i}[${e}]=`,t[e]);return n}enumerateField(t,e,i){if("object"==typeof i&&i){const t=i._iN$t;if(t){let e=t.globalVar;if(!e){e=t.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(e);const i=t.source[0];t.source[0]=lx(`${e}=`,i)}return e}return ArrayBuffer.isView(i)?this.instantiateTypedArray(i):Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?ax(i):("_objFlags"===e&&t instanceof il&&(i&=ix),i)}setObjProp(t,e,i,n){hx(t,`${rx+ux(i)}=`,this.enumerateField(e,i,n))}enumerateObject(t,e){const i=e.constructor;if(Fe(i))this.enumerateCCClass(t,e,i);else for(const i in e){if(!e.hasOwnProperty(i)||95===i.charCodeAt(0)&&95===i.charCodeAt(1)&&"__type__"!==i)continue;const n=e[i];"object"==typeof n&&n&&n===e._iN$t||this.setObjProp(t,e,i,n)}}instantiateObj(t){if(t instanceof l.ValueType)return Le.getNewValueTypeCode(t);if(t instanceof l.Asset)return this.getObjRef(t);if(t._objFlags&ex)return null;let e;const i=t.constructor;if(Fe(i)){if(this.parent)if(this.parent instanceof l.Component){if(t instanceof l._BaseNode||t instanceof l.Component)return this.getObjRef(t)}else if(this.parent instanceof l._BaseNode)if(t instanceof l._BaseNode){if(!t.isChildOf(this.parent))return this.getObjRef(t)}else if(t instanceof l.Component){var n;if(!(null===(n=t.node)||void 0===n?void 0:n.isChildOf(this.parent)))return this.getObjRef(t)}e=new cx(rx,`new ${this.getFuncModule(i,!0)}()`)}else if(i===Object)e=new cx(rx,"{}");else{if(i)return this.getObjRef(t);e=new cx(rx,"Object.create(null)")}const s=[e];return t._iN$t={globalVar:"",source:s},this.objsToClear_iN$t.push(t),this.enumerateObject(s,t),["(function(){",s,"return o;})();"]}}function mx(t,e){if("function"==typeof t)try{t=t()}catch(t){return!1}if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e&&t.constructor===e.constructor)if(t instanceof l.ValueType){if(t.equals(e))return!0}else{if(Array.isArray(t))return 0===t.length&&0===e.length;if(t.constructor===Object)return at(t)&&at(e)}return!1}class px{get uiTransformComp(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp}set uiTransformComp(t){this._uiTransformComp=t}get uiComp(){return this._uiComp}set uiComp(t){this._uiComp&&t?I(12002):this._uiComp=t}get opacity(){return this._opacity}get localOpacity(){return this._localOpacity}set localOpacity(t){this._localOpacity=t,this.colorDirty=!0}constructor(t){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=t}applyOpacity(t){this._opacity=this._localOpacity*t}static markOpacityTree(t,e=!0){}}let fx;var gx,vx,yx,xx,Sx,Cx,Ax,bx,Tx;il.Flags.Destroying,function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed",t.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(fx||(fx=t("NodeEventType",{})));const Ex=il.Flags.Destroying,Px=il.Flags.DontDestroy,wx=il.Flags.Deactivating,Ix=new et("Node");function Rx(t){return t?"string"==typeof t?Ft(t):t:(D(3804),null)}let Dx=t("BaseNode",dc("cc.BaseNode")((Tx=bx=class t extends il{get components(){return this._components}get _persistNode(){return(this._objFlags&Px)>0}set _persistNode(t){t?this._objFlags|=Px:this._objFlags&=~Px}get name(){return this._name}set name(t){this._name=t}get uuid(){return this._id}get children(){return this._children}get active(){return this._active}set active(t){if(t=!!t,this._active!==t){this._active=t;const e=this._parent;e&&e._activeInHierarchy&&l.director._nodeActivator.activateNode(this,t)}}get activeInHierarchy(){return this._activeInHierarchy}get parent(){return this._parent}set parent(t){this.setParent(t)}get scene(){return this._scene}get eventProcessor(){return this._eventProcessor}static _setScene(t){t._updateScene()}static _findComponent(t,e){const i=e,n=t._components;if(i._sealed)for(let t=0;t<n.length;++t){const i=n[t];if(i.constructor===e)return i}else for(let t=0;t<n.length;++t){const i=n[t];if(i instanceof e)return i}return null}static _findComponents(t,e,i){const n=e,s=t._components;if(n._sealed)for(let t=0;t<s.length;++t){const n=s[t];n.constructor===e&&i.push(n)}else for(let t=0;t<s.length;++t){const n=s[t];n instanceof e&&i.push(n)}}static _findChildComponent(e,i){for(let n=0;n<e.length;++n){const s=e[n];let r=t._findComponent(s,i);if(r)return r;if(s._children.length>0&&(r=t._findChildComponent(s._children,i),r))return r}return null}static _findChildComponents(e,i,n){for(let s=0;s<e.length;++s){const r=e[s];t._findComponents(r,i,n),r._children.length>0&&t._findChildComponents(r._children,i,n)}}_updateScene(){null==this._parent?x("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene}constructor(t){super(t),nc(this,"_parent",yx,this),nc(this,"_children",xx,this),nc(this,"_active",Sx,this),nc(this,"_components",Cx,this),nc(this,"_prefab",Ax,this),this._scene=null,this._activeInHierarchy=!1,this._id=Ix.getNewId(),this._name=void 0,this._eventProcessor=new l.NodeEventProcessor(this),this._eventMask=0,this._siblingIndex=0,this._originalSceneId="",this._registerIfAttached=void 0,this._name=void 0!==t?t:"New Node"}attr(t){At(this,t)}getParent(){return this._parent}setParent(t,e=!1){if(this._parent===t)return;const i=this._parent,n=t;if(this._parent=n,this._siblingIndex=0,this._onSetParent(i,e),this.emit&&this.emit(fx.PARENT_CHANGED,i),i&&!(i._objFlags&Ex)){const t=i._children.indexOf(this);i._children.splice(t,1),i._updateSiblingIndex(),i.emit&&i.emit(fx.CHILD_REMOVED,this)}n&&(n._children.push(this),this._siblingIndex=n._children.length-1,n.emit&&n.emit(fx.CHILD_ADDED,this)),this._onHierarchyChanged(i)}getChildByUuid(t){if(!t)return v("Invalid uuid"),null;const e=this._children;for(let i=0,n=e.length;i<n;i++)if(e[i]._id===t)return e[i];return null}getChildByName(t){if(!t)return v("Invalid name"),null;const e=this._children;for(let i=0,n=e.length;i<n;i++)if(e[i]._name===t)return e[i];return null}getChildByPath(t){const e=t.split("/");let i=this;for(let t=0;t<e.length;++t){const n=e[t];if(0===n.length)continue;const s=i.children.find((t=>t.name===n));if(!s)return null;i=s}return i}addChild(t){t.setParent(this)}insertChild(t,e){t.parent=this,t.setSiblingIndex(e)}getSiblingIndex(){return this._siblingIndex}setSiblingIndex(t){if(!this._parent)return;if(this._parent._objFlags&wx)return void D(3821);const e=this._parent._children;t=-1!==t?t:e.length-1;const i=e.indexOf(this);t!==i&&(e.splice(i,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t))}walk(e,i){let n=1,s=null,r=null,o=0,a=t._stacks[t._stackId];a||(a=[],t._stacks.push(a)),t._stackId++,a.length=0,a[0]=this;let c=null,l=!1;for(;n;)if(n--,r=a[n],r)if(!l&&e?e(r):l&&i&&i(r),a[n]=null,l){if(c===this._parent)break;if(l=!1,s)if(o++,s[o])a[n]=s[o],n++;else if(c&&(a[n]=c,n++,l=!0,c._parent?(s=c._parent._children,o=s.indexOf(c),c=c._parent):(c=null,s=null),o<0))break}else r._children.length>0?(c=r,s=r._children,o=0,a[n]=s[o],n++):(a[n]=r,n++,l=!0);a.length=0,t._stackId--}removeFromParent(){this._parent&&this._parent.removeChild(this)}removeChild(t){this._children.indexOf(t)>-1&&(t.parent=null)}removeAllChildren(){const t=this._children;for(let e=t.length-1;e>=0;e--){const i=t[e];i&&(i.parent=null)}this._children.length=0}isChildOf(t){let e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1}getComponent(e){const i=Rx(e);return i?t._findComponent(this,i):null}getComponents(e){const i=Rx(e),n=[];return i&&t._findComponents(this,i,n),n}getComponentInChildren(e){const i=Rx(e);return i?t._findChildComponent(this._children,i):null}getComponentsInChildren(e){const i=Rx(e),n=[];return i&&(t._findComponents(this,i,n),t._findChildComponents(this._children,i,n)),n}addComponent(t){let e;if("string"==typeof t){if(e=Ft(t),!e)throw l._RF.peek()&&D(3808,t),TypeError(N(3807,t))}else{if(!t)throw TypeError(N(3804));e=t}if("function"!=typeof e)throw TypeError(N(3809));if(!Et(e,l.Component))throw TypeError(N(3810));const i=e._requireComponent;if(i)if(Array.isArray(i))for(let t=0;t<i.length;t++){const e=i[t];this.getComponent(e)||this.addComponent(e)}else{const t=i;this.getComponent(t)||this.addComponent(t)}const n=new e;return n.node=this,this._components.push(n),this._activeInHierarchy&&l.director._nodeActivator.activateComp(n),n}removeComponent(t){if(!t)return void D(3813);let e=null;e=t instanceof Lh?t:this.getComponent(t),e&&e.destroy()}on(t,e,i,n=!1){switch(t){case fx.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(t,e,i,n)}off(t,e,i,n=!1){if(this._eventProcessor.off(t,e,i,n),!this._eventProcessor.hasEventListener(t))switch(t){case fx.TRANSFORM_CHANGED:this._eventMask&=-2}}once(t,e,i,n){this._eventProcessor.once(t,e,i,n)}emit(t,e,i,n,s,r){this._eventProcessor.emit(t,e,i,n,s,r)}dispatchEvent(t){this._eventProcessor.dispatchEvent(t)}hasEventListener(t,e,i){return this._eventProcessor.hasEventListener(t,e,i)}targetOff(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener(fx.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}destroy(){return!!super.destroy()&&(this.active=!1,!0)}destroyAllChildren(){const t=this._children;for(let e=0;e<t.length;++e)t[e].destroy()}_removeComponent(t){if(t){if(!(this._objFlags&Ex)){const e=this._components.indexOf(t);-1!==e?this._components.splice(e,1):t.node!==this&&D(3815)}}else D(3814)}_updateSiblingIndex(){for(let t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit(fx.SIBLING_ORDER_CHANGED)}_onSetParent(e,i=!1){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(t._setScene))}_onPostActivated(t){}_onBatchCreated(t){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}_onPreDestroy(){this._onPreDestroyBase()}_onHierarchyChanged(t){return this._onHierarchyChangedBase(t)}_instantiate(t,e){return t||(t=l.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t}_onHierarchyChangedBase(t){const e=this._parent;!this._persistNode||e instanceof l.Scene||l.game.removePersistRootNode(this);const i=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==i&&l.director._nodeActivator.activateNode(this,i)}_onPreDestroyBase(){this._objFlags|=Ex;const t=this._parent,e=!!t&&0!=(t._objFlags&Ex);if(this._persistNode&&l.game.removePersistRootNode(this),!e&&t){this.emit(fx.PARENT_CHANGED,this);const e=t._children.indexOf(this);t._children.splice(e,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(fx.CHILD_REMOVED,this)}this.emit(fx.NODE_DESTROYED,this),this._eventProcessor.destroy();const i=this._children;for(let t=0;t<i.length;++t)i[t]._destroyImmediate();const n=this._components;for(let t=0;t<n.length;++t)n[t]._destroyImmediate();return e}},bx.idGenerator=Ix,bx._stacks=[[]],bx._stackId=0,sc((vx=Tx).prototype,"_persistNode",[gc],Object.getOwnPropertyDescriptor(vx.prototype,"_persistNode"),vx.prototype),sc(vx.prototype,"name",[Mc],Object.getOwnPropertyDescriptor(vx.prototype,"name"),vx.prototype),sc(vx.prototype,"children",[Mc],Object.getOwnPropertyDescriptor(vx.prototype,"children"),vx.prototype),sc(vx.prototype,"active",[Mc],Object.getOwnPropertyDescriptor(vx.prototype,"active"),vx.prototype),sc(vx.prototype,"activeInHierarchy",[Mc],Object.getOwnPropertyDescriptor(vx.prototype,"activeInHierarchy"),vx.prototype),sc(vx.prototype,"parent",[Mc],Object.getOwnPropertyDescriptor(vx.prototype,"parent"),vx.prototype),yx=sc(vx.prototype,"_parent",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xx=sc(vx.prototype,"_children",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sx=sc(vx.prototype,"_active",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Cx=sc(vx.prototype,"_components",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ax=sc(vx.prototype,"_prefab",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gx=vx))||gx);var Mx,Ox,Bx,Nx,Lx,Fx,zx,Vx,Gx,Ux,kx;l._BaseNode=Dx;const Hx=new mi,jx=new Si,Wx=new Si,qx=new Si,Xx=new vi,Yx=new vi,Kx=new Ii,Jx=[],$x=[],Zx=[];class Qx{constructor(){this._chunks=[],this._freelists=[],this._createChunk()}alloc(){const t=this._freelists.length;for(let e=0;e<t;++e)if(this._freelists[e].length)return this._createView(e);return this._createChunk(),this._createView(t)}free(t,e){const i=this._freelists.length;for(let n=0;n<i;++n)if(this._chunks[n]===t)return void this._freelists[n].push(e)}clear(){const t=this._chunks.length;for(let e=0;e<t;++e)this._chunks[e].fill(0)}_createChunk(){this._chunks.push(new Uint32Array(Qx.CAPACITY_PER_CHUNK));const t=[];for(let e=Qx.CAPACITY_PER_CHUNK-1;e>=0;e--)t.push(e);this._freelists.push(t)}_createView(t){return Zx[0]=this._chunks[t],Zx[1]=this._freelists[t].pop(),Zx}}Qx.CAPACITY_PER_CHUNK=256;const tS=new Qx,eS=Symbol("ReserveContentsForAllSyncablePrefab");let iS=t("Node",(Mx=dc("cc.Node"),Ox=Kc(mi),Mx((kx=Ux=class t extends Dx{get _dirtyFlags(){return this._nativeDirtyFlag[0]}set _dirtyFlags(t){this._dirtyFlagsPri=t,this._nativeDirtyFlag[0]=t}_init(){const[t,e]=tS.alloc();this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=e;const i=new Uint32Array(t.buffer,t.byteOffset+4*e,1);this._hasChangedFlags=i,this._nodeHandle=$o.alloc(),this._pos=new mi($o.getTypedArray(this._nodeHandle,Yo.WORLD_POSITION)),this._rot=new Si($o.getTypedArray(this._nodeHandle,Yo.WORLD_ROTATION)),this._scale=new mi($o.getTypedArray(this._nodeHandle,Yo.WORLD_SCALE)),this._lpos=new mi($o.getTypedArray(this._nodeHandle,Yo.LOCAL_POSITION)),this._lrot=new Si($o.getTypedArray(this._nodeHandle,Yo.LOCAL_ROTATION)),this._lscale=new mi($o.getTypedArray(this._nodeHandle,Yo.LOCAL_SCALE)),this._mat=new Ii($o.getTypedArray(this._nodeHandle,Yo.WORLD_MATRIX)),this._nativeLayer=$o.getTypedArray(this._nodeHandle,Yo.LAYER),this._nativeDirtyFlag=$o.getTypedArray(this._nodeHandle,Yo.DIRTY_FLAG),this._scale.set(1,1,1),this._lscale.set(1,1,1),this._nativeLayer[0]=this._layer,this._nativeObj=new oa,this._nativeObj.initWithData($o.getBuffer(this._nodeHandle),i,$x)}constructor(t){super(t),this._uiProps=new px(this),this._static=!1,nc(this,"_lpos",Lx,this),nc(this,"_lrot",Fx,this),nc(this,"_lscale",zx,this),nc(this,"_layer",Vx,this),nc(this,"_euler",Gx,this),this._dirtyFlagsPri=bv.NONE,this._eulerDirty=!1,this._nodeHandle=0,this._init()}static isNode(e){return e instanceof t&&(e.constructor===t||!(e instanceof l.Scene))}_onPreDestroy(){const t=this._onPreDestroyBase();return this._nodeHandle&&($o.free(this._nodeHandle),this._nodeHandle=0),this._nativeObj=null,tS.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),t}get native(){return this._nativeObj}get position(){return this._lpos}set position(t){this.setPosition(t)}get worldPosition(){return this.updateWorldTransform(),this._pos}set worldPosition(t){this.setWorldPosition(t)}get rotation(){return this._lrot}set rotation(t){this.setRotation(t)}set eulerAngles(t){this.setRotationFromEuler(t.x,t.y,t.z)}get eulerAngles(){return this._eulerDirty&&(Si.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}get angle(){return this._euler.z}set angle(t){mi.set(this._euler,0,0,t),Si.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren(bv.ROTATION),1&this._eventMask&&this.emit(fx.TRANSFORM_CHANGED,bv.ROTATION)}get worldRotation(){return this.updateWorldTransform(),this._rot}set worldRotation(t){this.setWorldRotation(t)}get scale(){return this._lscale}set scale(t){this.setScale(t)}get worldScale(){return this.updateWorldTransform(),this._scale}set worldScale(t){this.setWorldScale(t)}set matrix(t){Ii.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren(bv.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(fx.TRANSFORM_CHANGED,bv.TRS)}get worldMatrix(){return this.updateWorldTransform(),this._mat}get forward(){return mi.transformQuat(new mi,mi.FORWARD,this.worldRotation)}set forward(t){const e=t.length();mi.multiplyScalar(Hx,t,-1/e),Si.fromViewUp(jx,Hx),this.setWorldRotation(jx)}get up(){return mi.transformQuat(new mi,mi.UP,this.worldRotation)}get right(){return mi.transformQuat(new mi,mi.RIGHT,this.worldRotation)}set layer(t){this._layer=t,this._nativeLayer[0]=this._layer,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(fx.LAYER_CHANGED,this._layer)}get layer(){return this._layer}get hasChangedFlags(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]}set hasChangedFlags(t){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=t}[Xh](t,e){t.writeThis()}setParent(t,e=!1){e&&this.updateWorldTransform(),super.setParent(t,e),this._nativeObj.setParent(this.parent?this.parent.native:null)}_onSetParent(t,e){if(super._onSetParent(t,e),e){const t=this._parent;t?(t.updateWorldTransform(),je(Ii.determinant(t._mat),0,ke)?(I(14200),this._dirtyFlags|=bv.TRS,this.updateWorldTransform()):(Ii.multiply(Kx,Ii.invert(Kx,t._mat),this._mat),Ii.toRTS(Kx,this._lrot,this._lpos,this._lscale))):(mi.copy(this._lpos,this._pos),Si.copy(this._lrot,this._rot),mi.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(bv.TRS)}_onHierarchyChanged(t){this.eventProcessor.reattach(),super._onHierarchyChangedBase(t)}_onBatchCreated(t){var e;this._nativeLayer[0]=this._layer,this._nativeObj.setParent(null===(e=this.parent)||void 0===e?void 0:e.native),this.hasChangedFlags=bv.TRS,this._dirtyFlags|=bv.TRS;const i=this._children.length;for(let e=0;e<i;++e)this._children[e]._siblingIndex=e,this._children[e]._onBatchCreated(t)}_onBeforeSerialize(){this.eulerAngles}_onPostActivated(t){t?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(bv.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)}translate(t,e){const i=e||Av.LOCAL;if(i===Av.LOCAL)mi.transformQuat(Hx,t,this._lrot),this._lpos.x+=Hx.x,this._lpos.y+=Hx.y,this._lpos.z+=Hx.z;else if(i===Av.WORLD)if(this._parent){Si.invert(jx,this._parent.worldRotation),mi.transformQuat(Hx,t,jx);const e=this.worldScale;this._lpos.x+=Hx.x/e.x,this._lpos.y+=Hx.y/e.y,this._lpos.z+=Hx.z/e.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren(bv.POSITION),1&this._eventMask&&this.emit(fx.TRANSFORM_CHANGED,bv.POSITION)}rotate(t,e){const i=e||Av.LOCAL;if(Si.normalize(jx,t),i===Av.LOCAL)Si.multiply(this._lrot,this._lrot,jx);else if(i===Av.WORLD){const t=this.worldRotation;Si.multiply(Wx,jx,t),Si.invert(jx,t),Si.multiply(Wx,jx,Wx),Si.multiply(this._lrot,this._lrot,Wx)}this._eulerDirty=!0,this.invalidateChildren(bv.ROTATION),1&this._eventMask&&this.emit(fx.TRANSFORM_CHANGED,bv.ROTATION)}lookAt(t,e){this.getWorldPosition(Hx),mi.subtract(Hx,Hx,t),mi.normalize(Hx,Hx),Si.fromViewUp(jx,Hx,e),this.setWorldRotation(jx)}_setDirtyNode(t,e){Jx[t]=e,$x[t]=e.native}invalidateChildren(t){let e,i,n,s=0,r=0,o=0,a=0,c=0;const l=t|bv.POSITION;for(Jx[0]=this,$x[0]=this.native;s>=0;){if(e=Jx[s--],c=e._hasChangedFlags[0],a=e._dirtyFlagsPri,e.isValid&&(a&c&t)!==t)for(a|=t,e._dirtyFlagsPri=a,e._nativeDirtyFlag[0]=a,e._hasChangedFlags[0]=c|t,n=e._children,o=n.length,r=0;r<o;r++)i=n[r],Jx[++s]=i,$x[s]=i.native;t=l}}updateWorldTransform(){if(!this._dirtyFlags)return;let t,e=this,i=0;for(;e&&e._dirtyFlags;)this._setDirtyNode(i++,e),e=e._parent;let n=0;for(;i;)t=Jx[--i],n|=t._dirtyFlags,e?(n&bv.POSITION&&(mi.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),n&bv.RS&&(Ii.fromRTS(t._mat,t._lrot,t._lpos,t._lscale),Ii.multiply(t._mat,e._mat,t._mat),n&bv.ROTATION&&Si.multiply(t._rot,e._rot,t._lrot),vi.fromQuat(Xx,Si.conjugate(qx,t._rot)),vi.multiplyMat4(Xx,Xx,t._mat),t._scale.x=Xx.m00,t._scale.y=Xx.m04,t._scale.z=Xx.m08)):(n&bv.POSITION&&(mi.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),n&bv.RS&&(n&bv.ROTATION&&Si.copy(t._rot,t._lrot),n&bv.SCALE&&(mi.copy(t._scale,t._lscale),Ii.fromRTS(t._mat,t._rot,t._pos,t._scale)))),t._dirtyFlags=bv.NONE,e=t}setPosition(t,e,i){void 0===e&&void 0===i?mi.copy(this._lpos,t):void 0===i?mi.set(this._lpos,t,e,this._lpos.z):mi.set(this._lpos,t,e,i),this.invalidateChildren(bv.POSITION),1&this._eventMask&&this.emit(fx.TRANSFORM_CHANGED,bv.POSITION)}getPosition(t){return t?mi.set(t,this._lpos.x,this._lpos.y,this._lpos.z):mi.copy(new mi,this._lpos)}setRotation(t,e,i,n){void 0===e||void 0===i||void 0===n?Si.copy(this._lrot,t):Si.set(this._lrot,t,e,i,n),this._eulerDirty=!0,this.invalidateChildren(bv.ROTATION),1&this._eventMask&&this.emit(fx.TRANSFORM_CHANGED,bv.ROTATION)}setRotationFromEuler(t,e,i){const n=void 0===i?this._euler.z:i;void 0===e?(mi.copy(this._euler,t),Si.fromEuler(this._lrot,t.x,t.y,t.z)):(mi.set(this._euler,t,e,n),Si.fromEuler(this._lrot,t,e,n)),this._eulerDirty=!1,this.invalidateChildren(bv.ROTATION),1&this._eventMask&&this.emit(fx.TRANSFORM_CHANGED,bv.ROTATION)}getRotation(t){return t?Si.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Si.copy(new Si,this._lrot)}setScale(t,e,i){void 0===e&&void 0===i?mi.copy(this._lscale,t):void 0===i?mi.set(this._lscale,t,e,this._lscale.z):mi.set(this._lscale,t,e,i),this.invalidateChildren(bv.SCALE),1&this._eventMask&&this.emit(fx.TRANSFORM_CHANGED,bv.SCALE)}getScale(t){return t?mi.set(t,this._lscale.x,this._lscale.y,this._lscale.z):mi.copy(new mi,this._lscale)}inverseTransformPoint(t,e){mi.copy(t,e);let i=this,n=0;for(;i._parent;)this._setDirtyNode(n++,i),i=i._parent;for(;n>=0;)mi.transformInverseRTS(t,t,i._lrot,i._lpos,i._lscale),i=Jx[--n];return t}setWorldPosition(t,e,i){void 0===e||void 0===i?mi.copy(this._pos,t):mi.set(this._pos,t,e,i);const n=this._parent,s=this._lpos;n?(n.updateWorldTransform(),mi.transformMat4(s,this._pos,Ii.invert(Kx,n._mat))):mi.copy(s,this._pos),this.invalidateChildren(bv.POSITION),1&this._eventMask&&this.emit(fx.TRANSFORM_CHANGED,bv.POSITION)}getWorldPosition(t){return this.updateWorldTransform(),t?mi.copy(t,this._pos):mi.copy(new mi,this._pos)}setWorldRotation(t,e,i,n){void 0===e||void 0===i||void 0===n?Si.copy(this._rot,t):Si.set(this._rot,t,e,i,n),this._parent?(this._parent.updateWorldTransform(),Si.multiply(this._lrot,Si.conjugate(this._lrot,this._parent._rot),this._rot)):Si.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(bv.ROTATION),1&this._eventMask&&this.emit(fx.TRANSFORM_CHANGED,bv.ROTATION)}setWorldRotationFromEuler(t,e,i){Si.fromEuler(this._rot,t,e,i),this._parent?(this._parent.updateWorldTransform(),Si.multiply(this._lrot,Si.conjugate(this._lrot,this._parent._rot),this._rot)):Si.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(bv.ROTATION),1&this._eventMask&&this.emit(fx.TRANSFORM_CHANGED,bv.ROTATION)}getWorldRotation(t){return this.updateWorldTransform(),t?Si.copy(t,this._rot):Si.copy(new Si,this._rot)}setWorldScale(t,e,i){void 0===e||void 0===i?mi.copy(this._scale,t):mi.set(this._scale,t,e,i);const n=this._parent;n?(n.updateWorldTransform(),vi.fromQuat(Xx,Si.conjugate(qx,n._rot)),vi.multiplyMat4(Xx,Xx,n._mat),Yx.m00=this._scale.x,Yx.m04=this._scale.y,Yx.m08=this._scale.z,vi.multiply(Xx,Yx,vi.invert(Xx,Xx)),this._lscale.x=mi.set(Hx,Xx.m00,Xx.m01,Xx.m02).length(),this._lscale.y=mi.set(Hx,Xx.m03,Xx.m04,Xx.m05).length(),this._lscale.z=mi.set(Hx,Xx.m06,Xx.m07,Xx.m08).length()):mi.copy(this._lscale,this._scale),this.invalidateChildren(bv.SCALE),1&this._eventMask&&this.emit(fx.TRANSFORM_CHANGED,bv.SCALE)}getWorldScale(t){return this.updateWorldTransform(),t?mi.copy(t,this._scale):mi.copy(new mi,this._scale)}getWorldMatrix(t){this.updateWorldTransform();const e=t||new Ii;return Ii.copy(e,this._mat)}getWorldRS(t){this.updateWorldTransform();const e=t||new Ii;return Ii.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}getWorldRT(t){this.updateWorldTransform();const e=t||new Ii;return Ii.fromRT(e,this._rot,this._pos)}setRTS(t,e,i){let n=0;t&&(n|=bv.ROTATION,void 0!==t.w?(Si.copy(this._lrot,t),this._eulerDirty=!0):(mi.copy(this._euler,t),Si.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&(mi.copy(this._lpos,e),n|=bv.POSITION),i&&(mi.copy(this._lscale,i),n|=bv.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(fx.TRANSFORM_CHANGED,n))}pauseSystemEvents(t){this._eventProcessor.setEnabled(!1,t)}resumeSystemEvents(t){this._eventProcessor.setEnabled(!0,t)}static resetHasChangedFlags(){tS.clear()}static clearNodeArray(){t.ClearFrame<t.ClearRound?t.ClearFrame++:(t.ClearFrame=0,Jx.length=0,$x.length=0)}getPathInHierarchy(){let e=this.name,i=this.parent;for(;i&&i instanceof t;)e=`${i.name}/${e}`,i=i.parent;return e}},Ux.EventType=fx,Ux.NodeSpace=Av,Ux.TransformDirtyBit=bv,Ux.TransformBit=bv,Ux.reserveContentsForAllSyncablePrefabTag=eS,Ux.ClearFrame=0,Ux.ClearRound=1e3,Lx=sc((Nx=kx).prototype,"_lpos",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi}}),Fx=sc(Nx.prototype,"_lrot",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Si}}),zx=sc(Nx.prototype,"_lscale",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi(1,1,1)}}),Vx=sc(Nx.prototype,"_layer",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yd.Enum.DEFAULT}}),Gx=sc(Nx.prototype,"_euler",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi}}),sc(Nx.prototype,"eulerAngles",[Ox],Object.getOwnPropertyDescriptor(Nx.prototype,"eulerAngles"),Nx.prototype),sc(Nx.prototype,"angle",[Mc],Object.getOwnPropertyDescriptor(Nx.prototype,"angle"),Nx.prototype),sc(Nx.prototype,"layer",[Mc],Object.getOwnPropertyDescriptor(Nx.prototype,"layer"),Nx.prototype),Bx=Nx))||Bx));var nS,sS,rS,oS,aS,cS,lS,hS,_S,uS,dS,mS,pS,fS,gS,vS,yS,xS,SS,CS,AS,bS,TS,ES,PS,wS,IS,RS,DS,MS,OS,BS,NS,LS,FS,zS,VS,GS,US,kS,HS,jS,WS,qS,XS,YS,KS,JS,$S,ZS,QS,tC,eC,iC,nC,sC,rC,oC,aC,cC,lC,hC,_C,uC,dC;l.Node=iS;let mC=dc("cc.TargetInfo")((rS=sc((sS=class{constructor(){nc(this,"localID",rS,this)}}).prototype,"localID",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nS=sS))||nS,pC=(oS=dc("cc.TargetOverrideInfo"),aS=Kc(il),cS=Kc(mC),lS=Kc(iS),hS=Kc(mC),oS((dS=sc((uS=class{constructor(){nc(this,"source",dS,this),nc(this,"sourceInfo",mS,this),nc(this,"propertyPath",pS,this),nc(this,"target",fS,this),nc(this,"targetInfo",gS,this)}}).prototype,"source",[Sc,aS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mS=sc(uS.prototype,"sourceInfo",[Sc,cS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pS=sc(uS.prototype,"propertyPath",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fS=sc(uS.prototype,"target",[Sc,lS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gS=sc(uS.prototype,"targetInfo",[Sc,hS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_S=uS))||_S),fC=dc("cc.CompPrefabInfo")((xS=sc((yS=class{constructor(){nc(this,"fileId",xS,this)}}).prototype,"fileId",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),vS=yS))||vS,gC=(SS=dc("CCPropertyOverrideInfo"),CS=Kc(mC),SS((TS=sc((bS=class{constructor(){nc(this,"targetInfo",TS,this),nc(this,"propertyPath",ES,this),nc(this,"value",PS,this)}isTarget(t,e){}}).prototype,"targetInfo",[Sc,CS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ES=sc(bS.prototype,"propertyPath",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PS=sc(bS.prototype,"value",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),AS=bS))||AS),vC=(wS=dc("cc.MountedChildrenInfo"),IS=Kc(mC),RS=Kc([iS]),wS((OS=sc((MS=class{constructor(){nc(this,"targetInfo",OS,this),nc(this,"nodes",BS,this)}isTarget(t){}}).prototype,"targetInfo",[Sc,IS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BS=sc(MS.prototype,"nodes",[Sc,RS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DS=MS))||DS),yC=(NS=dc("cc.MountedComponentsInfo"),LS=Kc(mC),FS=Kc([Lh]),NS((GS=sc((VS=class{constructor(){nc(this,"targetInfo",GS,this),nc(this,"components",US,this)}isTarget(t){}}).prototype,"targetInfo",[Sc,LS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),US=sc(VS.prototype,"components",[Sc,FS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zS=VS))||zS),xC=(kS=dc("cc.PrefabInstance"),HS=Kc(iS),jS=Kc([vC]),WS=Kc([yC]),qS=Kc([gC]),XS=Kc([mC]),kS((JS=sc((KS=class{constructor(){nc(this,"fileId",JS,this),nc(this,"prefabRootNode",$S,this),nc(this,"mountedChildren",ZS,this),nc(this,"mountedComponents",QS,this),nc(this,"propertyOverrides",tC,this),nc(this,"removedComponents",eC,this),this.targetMap={}}findPropertyOverride(t,e){}removePropertyOverride(t,e){}}).prototype,"fileId",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$S=sc(KS.prototype,"prefabRootNode",[Sc,HS],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ZS=sc(KS.prototype,"mountedChildren",[Sc,jS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),QS=sc(KS.prototype,"mountedComponents",[Sc,WS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tC=sc(KS.prototype,"propertyOverrides",[Sc,qS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eC=sc(KS.prototype,"removedComponents",[Sc,XS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),YS=KS))||YS),SC=(iC=dc("cc.PrefabInfo"),nC=Kc(iS),sC=Kc(xC),rC=Kc([pC]),iC((cC=sc((aC=class{constructor(){nc(this,"root",cC,this),nc(this,"asset",lC,this),nc(this,"fileId",hC,this),nc(this,"instance",_C,this),nc(this,"targetOverrides",uC,this),nc(this,"nestedPrefabInstanceRoots",dC,this)}}).prototype,"root",[Sc,nC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lC=sc(aC.prototype,"asset",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),hC=sc(aC.prototype,"fileId",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_C=sc(aC.prototype,"instance",[Sc,sC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),uC=sc(aC.prototype,"targetOverrides",[Sc,rC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),dC=sc(aC.prototype,"nestedPrefabInstanceRoots",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),oC=aC))||oC);function CC(t){const e=t._prefab;if(!e)return;if(!e.instance)return;if(!e.asset)return D(3701,t.name),void(e.instance=void 0);const i=t._objFlags,n=t._parent,s=t._id,r=t._prefab;t[$c],l.game._isCloning=!0,e.asset._doInstantiate(t),l.game._isCloning=!1,t._objFlags=i,t._parent=n,t._id=s,t._prefab&&(t._prefab.instance=null==r?void 0:r.instance)}function AC(t,e,i){var n;if(!e)return;if(!t)return;let s=e;const r=null===(n=t._prefab)||void 0===n?void 0:n.instance;!i&&r&&(e[r.fileId]={},s=e[r.fileId]);const o=t._prefab;o&&(s[o.fileId]=t);const a=t.components;for(let t=0;t<a.length;t++){const e=a[t];e.__prefab&&(s[e.__prefab.fileId]=e)}for(let e=0;e<t.children.length;e++)AC(t.children[e],s,!1)}function bC(t,e){if(!t)return null;let i=null,n=e;for(let e=0;e<t.length;e++){if(!n)return null;n=n[t[e]]}return i=n,i}function TC(t,e,i){if(e)for(let t=0;t<e.length;t++){const n=e[t];if(n&&n.targetInfo){const t=bC(n.targetInfo.localID,i);if(!t)continue;let e=i;const s=n.targetInfo.localID;if(s.length>0)for(let t=0;t<s.length-1;t++)e=e[s[t]];if(n.nodes)for(let i=0;i<n.nodes.length;i++){const s=n.nodes[i];s&&!t._children.includes(s)&&(t._children.push(s),s._parent=t,AC(s,e,!1),s._siblingIndex=t._children.length-1,RC(s,!0))}}}}function EC(t,e,i){if(e)for(let t=0;t<e.length;t++){const n=e[t];if(n&&n.targetInfo){const t=bC(n.targetInfo.localID,i);if(!t)continue;if(n.components)for(let e=0;e<n.components.length;e++){const i=n.components[e];i&&(i.node=t,t._components.push(i))}}}}function PC(t,e,i){if(e)for(let t=0;t<e.length;t++){const n=e[t];if(n){const t=bC(n.localID,i);if(!t||!t.node)continue;const e=t.node.components.indexOf(t);e>=0&&t.node._components.splice(e,1)}}}function wC(t,e,i){if(e.length<=0)return;let n=null;for(let t=0;t<e.length;t++){const s=e[t];if(s&&s.targetInfo){if(n=bC(s.targetInfo.localID,i),!n)continue;let t=n;const e=s.propertyPath.slice();if(e.length>0){const i=e.pop();if(!i)continue;for(let i=0;i<e.length&&(t=t[e[i]],t);i++);if(!t)continue;if(Array.isArray(t))if("length"===i)t[i]=s.value;else{const e=Number.parseInt(i);Number.isInteger(e)&&e<t.length&&(t[i]=s.value)}else t[i]instanceof Yt?t[i].set(s.value):t[i]=s.value}}}}function IC(t){var e;const i=null===(e=t._prefab)||void 0===e?void 0:e.targetOverrides;if(i)for(let t=0;t<i.length;t++){var n,s;const e=i[t];let a=e.source;const c=e.sourceInfo;if(c){var r,o;const t=null===(r=e.source)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;t&&t.targetMap&&(a=bC(c.localID,t.targetMap))}if(!a)continue;let l=null;const h=e.targetInfo;if(!h)continue;const _=null===(n=e.target)||void 0===n||null===(s=n._prefab)||void 0===s?void 0:s.instance;if(!_||!_.targetMap)continue;if(l=bC(h.localID,_.targetMap),!l)continue;const u=e.propertyPath.slice();let d=a;if(u.length>0){const t=u.pop();if(!t)return;for(let t=0;t<u.length&&(d=d[u[t]],d);t++);if(!d)continue;d[t]=l}}}function RC(t,e=!1){const i=t._prefab,n=null==i?void 0:i.instance;if(n){CC(t);const e={};n.targetMap=e,AC(t,e,!0),TC(0,n.mountedChildren,e),PC(0,n.removedComponents,e),EC(0,n.mountedComponents,e),wC(0,n.propertyOverrides,e)}e&&t&&t.children&&t.children.forEach((t=>{RC(t,!0)}))}function DC(t){const e=t._prefab;e&&e.nestedPrefabInstanceRoots&&e.nestedPrefabInstanceRoots.forEach((t=>{RC(t)}))}l._PrefabInfo=SC;var MC,OC,BC,NC,LC,FC,zC,VC=Object.freeze({__proto__:null,TargetInfo:mC,TargetOverrideInfo:pC,CompPrefabInfo:fC,PropertyOverrideInfo:gC,MountedChildrenInfo:vC,MountedComponentsInfo:yC,PrefabInstance:xC,PrefabInfo:SC,createNodeWithPrefab:CC,generateTargetMap:AC,getTarget:bC,applyMountedChildren:TC,applyMountedComponents:EC,applyRemovedComponents:PC,applyPropertyOverrides:wC,applyTargetOverrides:IC,expandPrefabInstanceNode:RC,expandNestedPrefabInstanceNode:DC});const GC=jt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2});let UC=t("Prefab",dc("cc.Prefab")((zC=FC=class t extends fh{constructor(){super(),nc(this,"data",BC,this),nc(this,"optimizationPolicy",NC,this),nc(this,"persistent",LC,this),this._createFunction=void 0,this._instantiatedTimes=void 0,this._createFunction=null,this._instantiatedTimes=0}createNode(t){const e=l.instantiate(this);e.name=this.name,t(null,e)}compileCreateFunction(){this._createFunction=function(t){const e=t instanceof l._BaseNode&&t;return new dx(t,e).result}(this.data)}_doInstantiate(t){return this.data._prefab||I(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(t)}_instantiate(){let e,i=!1;return i=this.optimizationPolicy!==GC.SINGLE_INSTANCE&&(this.optimizationPolicy===GC.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold),i?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e}initDefault(t){super.initDefault(t),this.data=new iS,this.data.name="(Missing Node)";const e=new l._PrefabInfo;e.asset=this,e.root=this.data,this.data._prefab=e}validate(){return!!this.data}onLoaded(){const t=this.data;DC(t),IC(t)}},FC.OptimizationPolicy=GC,FC.OptimizationPolicyThreshold=3,BC=sc((OC=zC).prototype,"data",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NC=sc(OC.prototype,"optimizationPolicy",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GC.AUTO}}),LC=sc(OC.prototype,"persistent",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),MC=OC))||MC);var kC,HC,jC,WC,qC,XC;Ut.value(UC,"_utils",VC),l.Prefab=UC,mt(l,"cc._Prefab","Prefab"),t("PrefabLink",(kC=dc("cc.PrefabLink"),HC=Kc(UC),jC=Oc(),kC((XC=sc((qC=class extends Lh{constructor(...t){super(...t),nc(this,"prefab",XC,this)}}).prototype,"prefab",[HC,Sc,jC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WC=qC))||WC));const YC=new mi;function KC(t,e,i,n){n||(n=new mi),t.convertToUINode(e,i,n);const s=i.position;return n.add(s),n}function JC(t,e,i){return i||(i=new mi),t.worldToScreen(e,i),i.x/=l.view.getScaleX(),i.y/=l.view.getScaleY(),i}const $C=t("convertUtils",{WorldNode3DToLocalNodeUI:KC,WorldNode3DToWorldNodeUI:JC});var ZC;l.pipelineUtils=$C,V(l.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction(...t){const e=t[0],i=t[3]||YC;return e.convertToUINode(t[1],t[2],i),i.add(t[2].position),t[3]||i.clone()}}]);const QC=new ys;QC.format=Zi.RGBA8;const tA=new xs;tA.format=Zi.DEPTH_STENCIL;const eA=new As([QC],tA),iA={width:1,height:1,renderPassInfo:eA};let nA=t("RenderTexture",dc("cc.RenderTexture")(ZC=class extends Zp{constructor(...t){super(...t),this._window=null}get window(){return this._window}initialize(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)}reset(t){this.initialize(t)}destroy(){if(this._window){const t=l.director.root;null==t||t.destroyWindow(this._window),this._window=null}return super.destroy()}resize(t,e){this._width=Math.floor(We(t,1,2048)),this._height=Math.floor(We(e,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)}_serialize(t){return{}}_deserialize(t,e){const i=t;this._width=i.w,this._height=i.h,this._name=i.n,super._deserialize(i.base,e)}getGFXTexture(){return this._window&&this._window.framebuffer.colorTextures[0]}onLoaded(){this._initWindow()}_initWindow(t){const e=l.director.root;iA.title=this._name,iA.width=this._width,iA.height=this._height,iA.renderPassInfo=t&&t.passInfo?t.passInfo:eA,QC.barrier=e.device.getGeneralBarrier(new bs(Cn.FRAGMENT_SHADER_READ_TEXTURE,Cn.FRAGMENT_SHADER_READ_TEXTURE)),this._window?(this._window.destroy(),this._window.initialize(e.device,iA)):this._window=e.createWindow(iA)}initDefault(t){super.initDefault(t),this._width=this._height=1,this._initWindow()}validate(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048}readPixels(t=0,e=0,i,n,s){i=i||this.width,n=n||this.height;const r=this.getGFXTexture();if(!r)return D(7606),null;const o=4*i*n;if(void 0===s)s=new Uint8Array(o);else if(s.length<o)return D(7607,o),null;const a=this._getGFXDevice(),c=[],l=[],h=new qn;return h.texOffset.x=t,h.texOffset.y=e,h.texExtent.width=i,h.texExtent.height=n,l.push(h),c.push(s),null==a||a.copyTextureToBuffers(r,c,l),s}})||ZC);var sA,rA;l.RenderTexture=nA,G(Zp.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),V(nA.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction(){return this._window}}]);let oA=t("BufferAsset",dc("cc.BufferAsset")((sc((rA=class extends fh{constructor(...t){super(...t),this._buffer=null}get _nativeAsset(){return this._buffer}set _nativeAsset(t){t instanceof ArrayBuffer?this._buffer=t:this._buffer=t.buffer}buffer(){return this._buffer}validate(){return!!this.buffer}}).prototype,"_nativeAsset",[Jc],Object.getOwnPropertyDescriptor(rA.prototype,"_nativeAsset"),rA.prototype),sA=rA))||sA);l.BufferAsset=oA;const aA={[Qi.UNORM]:"Uint",[Qi.SNORM]:"Int",[Qi.UINT]:"Uint",[Qi.INT]:"Int",[Qi.UFLOAT]:"Float",[Qi.FLOAT]:"Float",default:"Uint"};function cA(t){return`${aA[t.type]||aA.default}${t.size/t.count*8}`}function lA(t,e,i=Zi.R32F,n=0,s=0){const r=Gs[i];s||(s=r.size);const o=`set${cA(r)}`,a=r.size/r.count,c=Math.floor(e.length/r.count),l=qh.isLittleEndian;for(let i=0;i<c;++i){const c=n+s*i;for(let n=0;n<r.count;++n){const s=c+a*n;t[o](s,e[r.count*i+n],l)}}}function hA(t,e=Zi.R32F,i=0,n=t.byteLength-i,s=0,r=[]){const o=Gs[e];s||(s=o.size);const a=`get${cA(o)}`,c=o.size/o.count,l=Math.floor(n/s),h=qh.isLittleEndian;for(let e=0;e<l;++e){const n=i+s*e;for(let i=0;i<o.count;++i){const s=n+c*i;r[o.count*e+i]=t[a](s,h)}}return r}function _A(t,e,i=Zi.R32F,n=0,s=t.byteLength-n,r=0,o){o||(o=new DataView(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)));const a=Gs[i];r||(r=a.size);const c=`set${cA(a)}`,l=`get${cA(a)}`,h=a.size/a.count,_=Math.floor(s/r),u=qh.isLittleEndian;for(let i=0;i<_;++i){const s=n+r*i;for(let i=0;i<a.count;++i){const n=s+h*i,r=t[l](n,u);o[c](n,e(r,i,t),u)}}return o}class uA{_init(){}constructor(t,e,i,n=null,s=null,r=!0){this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._isOwnerOfIndexBuffer=!0,this._attributes=e,this._vertexBuffers=t,this._indexBuffer=n,this._indirectBuffer=s,this._primitiveMode=i,this._iaInfo=new vs(e,t,n,s),this._isOwnerOfIndexBuffer=r,this._init()}get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get indirectBuffer(){return this._indirectBuffer}get primitiveMode(){return this._primitiveMode}get geometricInfo(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:mi.ZERO,max:mi.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:mi.ZERO,max:mi.ZERO}};const{mesh:t}=this,e=this.subMeshIdx,i=t.readAttribute(e,Ln.ATTR_POSITION),n=t.readIndices(e),s=new mi,r=new mi,o=this.attributes.find((t=>t.name===Ln.ATTR_POSITION));if(o){const t=Gs[o.format].count;2===t?(s.set(i[0],i[1],0),r.set(i[0],i[1],0)):(s.set(i[0],i[1],i[2]),r.set(i[0],i[1],i[2]));for(let e=0;e<i.length;e+=t)2===t?(s.x=i[e]>s.x?i[e]:s.x,s.y=i[e+1]>s.y?i[e+1]:s.y,r.x=i[e]<r.x?i[e]:r.x,r.y=i[e+1]<r.y?i[e+1]:r.y):(s.x=i[e]>s.x?i[e]:s.x,s.y=i[e+1]>s.y?i[e+1]:s.y,s.z=i[e+2]>s.z?i[e+2]:s.z,r.x=i[e]<r.x?i[e]:r.x,r.y=i[e+1]<r.y?i[e+1]:r.y,r.z=i[e+2]<r.z?i[e+2]:r.z)}return this._geometricInfo={positions:i,indices:n,boundingBox:{max:s,min:r}},this._geometricInfo}get flatBuffers(){return this._flatBuffers}genFlatBuffers(){if(this._flatBuffers.length||!this.mesh||void 0===this.subMeshIdx)return;const{mesh:t}=this;let e=0;const i=t.struct.primitives[this.subMeshIdx];i.indexView&&(e=i.indexView.count);for(let n=0;n<i.vertexBundelIndices.length;n++){const s=i.vertexBundelIndices[n],r=t.struct.vertexBundles[s],o=i.indexView?i.indexView.count:r.view.count,a=r.view.stride,c=a*o,l=new Uint8Array(t.data.buffer,r.view.offset,r.view.length),h=new Uint8Array(i.indexView?c:r.view.length);if(!i.indexView){h.set(t.data.subarray(r.view.offset,r.view.offset+r.view.length)),this._flatBuffers.push({stride:a,count:o,buffer:h});continue}const _=t.readIndices(this.subMeshIdx);for(let t=0;t<e;++t){const e=t*a,i=_[t]*a;for(let t=0;t<a;++t)h[e+t]=l[i+t]}this._flatBuffers.push({stride:a,count:o,buffer:h})}}get jointMappedBuffers(){if(this._jointMappedBuffers)return this._jointMappedBuffers;const t=this._jointMappedBuffers=[],e=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;const{struct:i}=this.mesh,n=i.primitives[this.subMeshIdx];if(!i.jointMaps||void 0===n.jointMapIndex||!i.jointMaps[n.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;let s,r;const{device:o}=l.director.root;for(let a=0;a<n.vertexBundelIndices.length;a++){const c=i.vertexBundles[n.vertexBundelIndices[a]];r=0,s=Zi.UNKNOWN;for(let t=0;t<c.attributes.length;t++){const e=c.attributes[t];if(e.name===Ln.ATTR_JOINTS){s=e.format;break}r+=Gs[e.format].size}if(s){const l=new Uint8Array(this.mesh.data.buffer,c.view.offset,c.view.length),h=new DataView(l.slice().buffer),_=i.jointMaps[n.jointMapIndex];_A(h,(t=>_.indexOf(t)),s,r,c.view.length,c.view.stride,h);const u=o.createBuffer(new Zn(en.VERTEX|en.TRANSFER_DST,rn.DEVICE,c.view.length,c.view.stride));u.update(h.buffer),t.push(u),e.push(a)}else t.push(this.vertexBuffers[n.vertexBundelIndices[a]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(o)),t}get iaInfo(){return this._iaInfo}destroy(){for(let t=0;t<this.vertexBuffers.length;t++)this.vertexBuffers[t].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._isOwnerOfIndexBuffer&&this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(let t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)}enableVertexIdChannel(t){if(this._vertexIdChannel)return;const e=this.vertexBuffers.length,i=this.attributes.length,n=this._allocVertexIdBuffer(t);this._vertexBuffers.push(n),this._attributes.push(new fs("a_vertexId",Zi.R32F,!1,e)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:e,index:i}}_allocVertexIdBuffer(t){const e=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(e);for(let t=0;t<e;++t)i[t]=t+.5;const n=t.createBuffer(new Zn(en.VERTEX|en.TRANSFER_DST,rn.DEVICE,i.byteLength,i.BYTES_PER_ELEMENT));return n.update(i),n}}let dA,mA;t("RenderingSubMesh",uA),function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed"}(dA||(dA=t("SystemEventType",{}))),function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.KEY_DOWN="keydown",t.KEY_PRESSING="key-pressing",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion"}(mA||(mA={})),l.SystemEventType=dA;const pA=new Array(16);let fA=null;const gA=new Oi,vA=[fx.TOUCH_START,fx.TOUCH_MOVE,fx.TOUCH_END,fx.TOUCH_CANCEL],yA=[fx.MOUSE_DOWN,fx.MOUSE_ENTER,fx.MOUSE_MOVE,fx.MOUSE_LEAVE,fx.MOUSE_UP,fx.MOUSE_WHEEL];let xA;!function(t){t[t.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",t[t.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",t[t.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(xA||(xA={}));class SA{get isEnabled(){return this._isEnabled}get node(){return this._node}constructor(t){this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._isEnabled=!1,this._node=void 0,this._node=t}setEnabled(t,e=!1){if(this._isEnabled===t)return;this._isEnabled=t;const i=this.node.children;if(t&&this._attachMask(),SA.callbacksInvoker.emit(xA.MARK_LIST_DIRTY),e&&i.length>0)for(let e=0;e<i.length;++e)i[e]._eventProcessor.setEnabled(t,!0)}reattach(){let t;this.node.walk((e=>{t||(t=this._searchComponentsInParent(SA._maskComp)),e.eventProcessor.maskList=t}))}destroy(){fA===this._node&&(fA=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),SA.callbacksInvoker.emit(xA.REMOVE_POINTER_EVENT_PROCESSOR,this)}on(t,e,i,n){let s;var r,o;return this._tryEmittingAddEvent(t),s=(n=!!n)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker(),s.on(t,e,i),e}once(t,e,i,n){let s;var r,o;return this._tryEmittingAddEvent(t),s=(n=!!n)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker(),s.on(t,e,i,!0),e}off(t,e,i,n){var s;let r;r=(n=!!n)?this.capturingTarget:this.bubblingTarget,null===(s=r)||void 0===s||s.off(t,e,i)}targetOff(t){var e,i;null===(e=this.capturingTarget)||void 0===e||e.removeAll(t),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||SA.callbacksInvoker.emit(xA.REMOVE_POINTER_EVENT_PROCESSOR,this)}emit(t,e,i,n,s,r){var o;null===(o=this.bubblingTarget)||void 0===o||o.emit(t,e,i,n,s,r)}dispatchEvent(t){const e=this.node;let i,n=0;for(t.target=e,pA.length=0,this.getCapturingTargets(t.type,pA),t.eventPhase=1,n=pA.length-1;n>=0;--n)if(i=pA[n],i.eventProcessor.capturingTarget&&(t.currentTarget=i,i.eventProcessor.capturingTarget.emit(t.type,t,pA),t.propagationStopped))return void(pA.length=0);if(pA.length=0,t.eventPhase=2,t.currentTarget=e,this.capturingTarget&&this.capturingTarget.emit(t.type,t),!t.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(this.getBubblingTargets(t.type,pA),t.eventPhase=3,n=0;n<pA.length;++n)if(i=pA[n],i.eventProcessor.bubblingTarget&&(t.currentTarget=i,i.eventProcessor.bubblingTarget.emit(t.type,t),t.propagationStopped))return void(pA.length=0);pA.length=0}hasEventListener(t,e,i){let n=!1;return this.bubblingTarget&&(n=this.bubblingTarget.hasEventListener(t,e,i)),!n&&this.capturingTarget&&(n=this.capturingTarget.hasEventListener(t,e,i)),n}getCapturingTargets(t,e){let i=this._node.parent;for(;i;){var n;(null===(n=i.eventProcessor.capturingTarget)||void 0===n?void 0:n.hasEventListener(t))&&e.push(i),i=i.parent}}getBubblingTargets(t,e){let i=this._node.parent;for(;i;){var n;(null===(n=i.eventProcessor.bubblingTarget)||void 0===n?void 0:n.hasEventListener(t))&&e.push(i),i=i.parent}}_searchComponentsInParent(t){const e=this.node;if(t){let i=0,n=[];for(let s=e;s&&iS.isNode(s);s=s.parent,++i){const e=s.getComponent(t);if(e){const t={index:i,comp:e};n?n.push(t):n=[t]}}return n.length>0?n:null}return null}_attachMask(){this.maskList=this._searchComponentsInParent(SA._maskComp)}_isTouchEvent(t){return-1!==vA.indexOf(t)}_isMouseEvent(t){return-1!==yA.indexOf(t)}_hasTouchListeners(){for(let t=0;t<vA.length;++t){const e=vA[t];if(this.hasEventListener(e))return!0}return!1}_hasMouseListeners(){for(let t=0;t<yA.length;++t){const e=yA[t];if(this.hasEventListener(e))return!0}return!1}_hasPointerListeners(){return!!this._hasTouchListeners()||this._hasMouseListeners()}_tryEmittingAddEvent(t){const e=this._isTouchEvent(t),i=this._isMouseEvent(t);e?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!e&&!i||this._hasPointerListeners()||SA.callbacksInvoker.emit(xA.ADD_POINTER_EVENT_PROCESSOR,this)}_newCallbacksInvoker(){const t=new Ul;return t._registerOffCallback((()=>{this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||SA.callbacksInvoker.emit(xA.REMOVE_POINTER_EVENT_PROCESSOR,this)})),t}_handleEventMouse(t){switch(t.type){case mA.MOUSE_DOWN:return this._handleMouseDown(t);case mA.MOUSE_MOVE:return this._handleMouseMove(t);case mA.MOUSE_UP:return this._handleMouseUp(t);case mA.MOUSE_WHEEL:return this._handleMouseWheel(t);default:return!1}}_handleMouseDown(t){const e=this._node;return!(!e||!e._uiProps.uiTransformComp||(t.getLocation(gA),!e._uiProps.uiTransformComp.hitTest(gA)||(t.type=fx.MOUSE_DOWN,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))}_handleMouseMove(t){const e=this._node;return!(!e||!e._uiProps.uiTransformComp)&&(t.getLocation(gA),e._uiProps.uiTransformComp.hitTest(gA)?(this.previousMouseIn||(fA&&fA!==e&&(t.type=fx.MOUSE_LEAVE,fA.dispatchEvent(t),fA.eventProcessor.previousMouseIn=!1),fA=e,t.type=fx.MOUSE_ENTER,e.dispatchEvent(t),this.previousMouseIn=!0),t.type=fx.MOUSE_MOVE,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,!0):(this.previousMouseIn&&(t.type=fx.MOUSE_LEAVE,e.dispatchEvent(t),this.previousMouseIn=!1,fA=null),!1))}_handleMouseUp(t){const e=this._node;return!(!e||!e._uiProps.uiTransformComp||(t.getLocation(gA),!e._uiProps.uiTransformComp.hitTest(gA)||(t.type=fx.MOUSE_UP,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))}_handleMouseWheel(t){const e=this._node;return!(!e||!e._uiProps.uiTransformComp||(t.getLocation(gA),!e._uiProps.uiTransformComp.hitTest(gA)||(t.type=fx.MOUSE_WHEEL,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))}_handleEventTouch(t){switch(t.type){case mA.TOUCH_START:return this._handleTouchStart(t);case mA.TOUCH_MOVE:return this._handleTouchMove(t);case mA.TOUCH_END:return this._handleTouchEnd(t);case mA.TOUCH_CANCEL:return this._handleTouchCancel(t);default:return!1}}_handleTouchStart(t){const e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.getLocation(gA),!e._uiProps.uiTransformComp.hitTest(gA)||(t.type=fx.TOUCH_START,t.bubbles=!0,e.dispatchEvent(t),0)))}_handleTouchMove(t){const e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.type=fx.TOUCH_MOVE,t.bubbles=!0,e.dispatchEvent(t),0))}_handleTouchEnd(t){const e=this.node;e&&e._uiProps.uiTransformComp&&(t.getLocation(gA),e._uiProps.uiTransformComp.hitTest(gA)?t.type=fx.TOUCH_END:t.type=fx.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))}_handleTouchCancel(t){const e=this.node;e&&e._uiProps.uiTransformComp&&(t.type=fx.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))}}var CA,AA,bA,TA,EA,PA,wA,IA,RA,DA,MA,OA,BA,NA,LA,FA,zA,VA,GA,UA,kA,HA,jA,WA,qA,XA,YA,KA,JA,$A,ZA,QA,tb,eb,ib,nb,sb,rb,ob,ab,cb,lb,hb,_b,ub,db,mb,pb,fb,gb,vb,yb,xb,Sb,Cb,Ab,bb,Tb,Eb,Pb,wb,Ib,Rb,Db,Mb,Ob,Bb,Nb,Lb,Fb,zb,Vb,Gb,Ub,kb,Hb,jb,Wb,qb,Xb,Yb,Kb,Jb,$b,Zb,Qb,tT,eT,iT,nT,sT,rT,oT,aT,cT,lT,hT,_T,uT,dT,mT,pT,fT,gT,vT,yT,xT,ST,CT,AT,bT,TT,ET,PT,wT,IT,RT,DT,MT,OT,BT,NT,LT,FT,zT,VT,GT,UT,kT,HT,jT,WT,qT,XT,YT,KT,JT,$T,ZT;SA._maskComp=null,SA.callbacksInvoker=new Ul,l.NodeEventProcessor=SA;const QT=new mi(0,1,0),tE=new mi,eE=new Fi,iE=new hi,nE=new Si,sE=t=>{const e=1/Math.max(Math.max(Math.max(t.x,t.y),t.z),1e-4);e<1&&(t.x*=e,t.y*=e,t.z*=e)};let rE=t("AmbientInfo",(CA=dc("cc.AmbientInfo"),AA=Oc(),bA=Lc(),TA=Kc(fe),EA=Lc(),PA=Oc(),wA=Lc(),IA=Cc("_skyColor"),RA=Cc("_skyIllum"),DA=Cc("_groundAlbedo"),CA((sc((OA=class{constructor(){nc(this,"_skyColorHDR",BA,this),nc(this,"_skyIllumHDR",NA,this),nc(this,"_groundAlbedoHDR",LA,this),nc(this,"_skyColorLDR",FA,this),nc(this,"_skyIllumLDR",zA,this),nc(this,"_groundAlbedoLDR",VA,this),this._resource=null}get skyColorHDR(){return this._skyColorHDR}get groundAlbedoHDR(){return this._groundAlbedoHDR}get skyIllumHDR(){return this._skyIllumHDR}get skyColorLDR(){return this._skyColorLDR}get groundAlbedoLDR(){return this._groundAlbedoLDR}get skyIllumLDR(){return this._skyIllumLDR}set skyLightingColor(t){eE.set(t.x,t.y,t.z,t.w),l.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(eE):this._skyColorLDR.set(eE),this._resource&&this._resource.skyColor.set(eE)}get skyLightingColor(){const t=l.director.root.pipeline.pipelineSceneData.isHDR;return eE.set(t?this._skyColorHDR:this._skyColorLDR),sE(eE),iE.set(255*eE.x,255*eE.y,255*eE.z,255)}set skyColor(t){l.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t),this._resource&&this._resource.skyColor.set(t)}set skyIllum(t){l.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t,this._resource&&(this._resource.skyIllum=t)}get skyIllum(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR}set groundLightingColor(t){eE.set(t.x,t.y,t.z,t.w),l.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(eE):this._groundAlbedoLDR.set(eE),this._resource&&this._resource.groundAlbedo.set(eE)}get groundLightingColor(){const t=l.director.root.pipeline.pipelineSceneData.isHDR;return eE.set(t?this._groundAlbedoHDR:this._groundAlbedoLDR),sE(eE),iE.set(255*eE.x,255*eE.y,255*eE.z,255)}set groundAlbedo(t){l.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t),this._resource&&this._resource.groundAlbedo.set(t)}activate(t){this._resource=t,this._resource.initialize(this)}}).prototype,"skyLightingColor",[AA,Mc,bA],Object.getOwnPropertyDescriptor(OA.prototype,"skyLightingColor"),OA.prototype),sc(OA.prototype,"skyIllum",[Mc,TA,EA],Object.getOwnPropertyDescriptor(OA.prototype,"skyIllum"),OA.prototype),sc(OA.prototype,"groundLightingColor",[PA,Mc,wA],Object.getOwnPropertyDescriptor(OA.prototype,"groundLightingColor"),OA.prototype),BA=sc(OA.prototype,"_skyColorHDR",[Sc,IA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(.2,.5,.8,1)}}),NA=sc(OA.prototype,"_skyIllumHDR",[Sc,RA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _v.SKY_ILLUM}}),LA=sc(OA.prototype,"_groundAlbedoHDR",[Sc,DA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(.2,.2,.2,1)}}),FA=sc(OA.prototype,"_skyColorLDR",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(.2,.5,.8,1)}}),zA=sc(OA.prototype,"_skyIllumLDR",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _v.SKY_ILLUM}}),VA=sc(OA.prototype,"_groundAlbedoLDR",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(.2,.2,.2,1)}}),MA=OA))||MA));l.AmbientInfo=rE;let oE=t("SkyboxInfo",(GA=dc("cc.SkyboxInfo"),UA=Lc(),kA=Kc(fv),HA=Lc(),jA=Lc(),WA=Kc(wf),qA=Lc(),XA=Oc(),YA=Kc(wf),KA=kc(),JA=Kc(wf),$A=Cc("_envmap"),ZA=Kc(wf),QA=Kc(wf),tb=Kc(wf),GA((sc((ib=class{constructor(){nc(this,"_envLightingType",nb,this),nc(this,"_envmapHDR",sb,this),nc(this,"_envmapLDR",rb,this),nc(this,"_diffuseMapHDR",ob,this),nc(this,"_diffuseMapLDR",ab,this),nc(this,"_enabled",cb,this),nc(this,"_useHDR",lb,this),this._resource=null}set applyDiffuseMap(t){this._resource&&(this._resource.useDiffuseMap=t)}get applyDiffuseMap(){return fv.DIFFUSEMAP_WITH_REFLECTION===this._envLightingType}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=this._enabled))}get enabled(){return this._enabled}set envLightingType(t){this.envmap||fv.HEMISPHERE_DIFFUSE===t?(fv.HEMISPHERE_DIFFUSE===t?(this.useIBL=!1,this.applyDiffuseMap=!1):fv.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION===t?(this.useIBL=!0,this.applyDiffuseMap=!1):fv.DIFFUSEMAP_WITH_REFLECTION===t&&(this.useIBL=!0,this.applyDiffuseMap=!0),this._envLightingType=t):(this.useIBL=!1,this.applyDiffuseMap=!1,this._envLightingType=fv.HEMISPHERE_DIFFUSE,I(15001))}get envLightingType(){return this._envLightingType}set useIBL(t){this._resource&&(this._resource.useIBL=t)}get useIBL(){return fv.HEMISPHERE_DIFFUSE!==this._envLightingType}set useHDR(t){l.director.root.pipeline.pipelineSceneData.isHDR=t,this._useHDR=t,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,this.envLightingType===fv.DIFFUSEMAP_WITH_REFLECTION&&(null===this.diffuseMap?(this.envLightingType=fv.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION,I(15e3)):this.diffuseMap.isDefault&&I(15002))),this._resource&&(this._resource.useHDR=this._useHDR)}get useHDR(){return l.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR}set envmap(t){const e=l.director.root.pipeline.pipelineSceneData.isHDR;e?this._envmapHDR=t:this._envmapLDR=t,t||(e?this._diffuseMapHDR=null:this._diffuseMapLDR=null,this.applyDiffuseMap=!1,this.useIBL=!1,this.envLightingType=fv.HEMISPHERE_DIFFUSE,I(15001)),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this.applyDiffuseMap,this._resource.envmap=t)}get envmap(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR}set diffuseMap(t){l.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=t:this._diffuseMapLDR=t,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}get diffuseMap(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR}activate(t){this.envLightingType=this._envLightingType,this._resource=t,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()}}).prototype,"enabled",[Mc,UA],Object.getOwnPropertyDescriptor(ib.prototype,"enabled"),ib.prototype),sc(ib.prototype,"envLightingType",[Mc,kA,HA],Object.getOwnPropertyDescriptor(ib.prototype,"envLightingType"),ib.prototype),sc(ib.prototype,"useHDR",[Mc,jA],Object.getOwnPropertyDescriptor(ib.prototype,"useHDR"),ib.prototype),sc(ib.prototype,"envmap",[Mc,WA,qA],Object.getOwnPropertyDescriptor(ib.prototype,"envmap"),ib.prototype),sc(ib.prototype,"diffuseMap",[XA,Mc,Bc,YA,KA],Object.getOwnPropertyDescriptor(ib.prototype,"diffuseMap"),ib.prototype),nb=sc(ib.prototype,"_envLightingType",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fv.HEMISPHERE_DIFFUSE}}),sb=sc(ib.prototype,"_envmapHDR",[Sc,JA,$A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rb=sc(ib.prototype,"_envmapLDR",[Sc,ZA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ob=sc(ib.prototype,"_diffuseMapHDR",[Sc,QA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ab=sc(ib.prototype,"_diffuseMapLDR",[Sc,tb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cb=sc(ib.prototype,"_enabled",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lb=sc(ib.prototype,"_useHDR",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eb=ib))||eb));l.SkyboxInfo=oE;let aE=t("FogInfo",(hb=dc("cc.FogInfo"),_b=Lc(),ub=kc(),db=Lc(),mb=kc(),pb=Lc(),fb=Kc(yv),gb=kc(),vb=Lc(),yb=Oc(),xb=Kc(fe),Sb=Fc(),Cb=Gc(),Ab=Lc(),bb=Oc(),Tb=Kc(fe),Eb=Gc(),Pb=Lc(),wb=Oc(),Ib=Kc(fe),Rb=Gc(),Db=Lc(),Mb=Oc(),Ob=Kc(fe),Bb=zc(),Nb=Gc(),Lb=Lc(),Fb=Oc(),zb=Kc(fe),Vb=Gc(),Gb=Lc(),Ub=Oc(),kb=Kc(fe),Hb=Gc(),jb=Lc(),hb((sT=nT=class{constructor(){nc(this,"_type",Xb,this),nc(this,"_fogColor",Yb,this),nc(this,"_enabled",Kb,this),nc(this,"_fogDensity",Jb,this),nc(this,"_fogStart",$b,this),nc(this,"_fogEnd",Zb,this),nc(this,"_fogAtten",Qb,this),nc(this,"_fogTop",tT,this),nc(this,"_fogRange",eT,this),nc(this,"_accurate",iT,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set accurate(t){this._accurate!==t&&(this._accurate=t,this._resource&&(this._resource.accurate=t,t&&(this._resource.type=this._type)))}get accurate(){return this._accurate}set fogColor(t){this._fogColor.set(t),this._resource&&(this._resource.fogColor=this._fogColor)}get fogColor(){return this._fogColor}get type(){return this._type}set type(t){this._type=t,this._resource&&(this._resource.type=t)}get fogDensity(){return this._fogDensity}set fogDensity(t){this._fogDensity=t,this._resource&&(this._resource.fogDensity=t)}get fogStart(){return this._fogStart}set fogStart(t){this._fogStart=t,this._resource&&(this._resource.fogStart=t)}get fogEnd(){return this._fogEnd}set fogEnd(t){this._fogEnd=t,this._resource&&(this._resource.fogEnd=t)}get fogAtten(){return this._fogAtten}set fogAtten(t){this._fogAtten=t,this._resource&&(this._resource.fogAtten=t)}get fogTop(){return this._fogTop}set fogTop(t){this._fogTop=t,this._resource&&(this._resource.fogTop=t)}get fogRange(){return this._fogRange}set fogRange(t){this._fogRange=t,this._resource&&(this._resource.fogRange=t)}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}},nT.FogType=yv,sc((qb=sT).prototype,"enabled",[Mc,_b,ub],Object.getOwnPropertyDescriptor(qb.prototype,"enabled"),qb.prototype),sc(qb.prototype,"accurate",[Mc,db,mb],Object.getOwnPropertyDescriptor(qb.prototype,"accurate"),qb.prototype),sc(qb.prototype,"fogColor",[Mc,pb],Object.getOwnPropertyDescriptor(qb.prototype,"fogColor"),qb.prototype),sc(qb.prototype,"type",[Mc,fb,gb,vb],Object.getOwnPropertyDescriptor(qb.prototype,"type"),qb.prototype),sc(qb.prototype,"fogDensity",[yb,xb,Sb,Cb,Uc,Ab],Object.getOwnPropertyDescriptor(qb.prototype,"fogDensity"),qb.prototype),sc(qb.prototype,"fogStart",[bb,Tb,Eb,Pb],Object.getOwnPropertyDescriptor(qb.prototype,"fogStart"),qb.prototype),sc(qb.prototype,"fogEnd",[wb,Ib,Rb,Db],Object.getOwnPropertyDescriptor(qb.prototype,"fogEnd"),qb.prototype),sc(qb.prototype,"fogAtten",[Mb,Ob,Bb,Nb,Lb],Object.getOwnPropertyDescriptor(qb.prototype,"fogAtten"),qb.prototype),sc(qb.prototype,"fogTop",[Fb,zb,Vb,Gb],Object.getOwnPropertyDescriptor(qb.prototype,"fogTop"),qb.prototype),sc(qb.prototype,"fogRange",[Ub,kb,Hb,jb],Object.getOwnPropertyDescriptor(qb.prototype,"fogRange"),qb.prototype),Xb=sc(qb.prototype,"_type",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yv.LINEAR}}),Yb=sc(qb.prototype,"_fogColor",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi("#C8C8C8")}}),Kb=sc(qb.prototype,"_enabled",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jb=sc(qb.prototype,"_fogDensity",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),$b=sc(qb.prototype,"_fogStart",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Zb=sc(qb.prototype,"_fogEnd",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),Qb=sc(qb.prototype,"_fogAtten",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),tT=sc(qb.prototype,"_fogTop",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),eT=sc(qb.prototype,"_fogRange",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),iT=sc(qb.prototype,"_accurate",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wb=qb))||Wb)),cE=t("ShadowsInfo",(rT=dc("cc.ShadowsInfo"),oT=Lc(),aT=Kc(pg),cT=Oc(),lT=Oc(),hT=Lc(),_T=Kc(fe),uT=Oc(),dT=Lc(),mT=Kc(pe),pT=Lc(),fT=Oc(),gT=Kc(mg),vT=Lc(),yT=Oc(),rT((sc((ST=class{constructor(){nc(this,"_enabled",CT,this),nc(this,"_type",AT,this),nc(this,"_normal",bT,this),nc(this,"_distance",TT,this),nc(this,"_shadowColor",ET,this),nc(this,"_maxReceived",PT,this),nc(this,"_size",wT,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set type(t){this._type=t,this._resource&&(this._resource.type=t)}get type(){return this._type}set shadowColor(t){this._shadowColor.set(t),this._resource&&(this._resource.shadowColor=t)}get shadowColor(){return this._shadowColor}set planeDirection(t){mi.copy(this._normal,t),this._resource&&(this._resource.normal=t)}get planeDirection(){return this._normal}set planeHeight(t){this._distance=t,this._resource&&(this._resource.distance=-t)}get planeHeight(){return this._distance}set maxReceived(t){this._maxReceived=t,this._resource&&(this._resource.maxReceived=t)}get maxReceived(){return this._maxReceived}set shadowMapSize(t){this._size.set(t,t),this._resource&&(this._resource.size.set(t,t),this._resource.shadowMapDirty=!0)}get shadowMapSize(){return this._size.x}get size(){return this._size}setPlaneFromNode(t){t.getWorldRotation(nE),this.planeDirection=mi.transformQuat(tE,QT,nE),t.getWorldPosition(tE),this.planeHeight=mi.dot(this._normal,tE)}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}}).prototype,"enabled",[Mc,oT],Object.getOwnPropertyDescriptor(ST.prototype,"enabled"),ST.prototype),sc(ST.prototype,"type",[Mc,aT],Object.getOwnPropertyDescriptor(ST.prototype,"type"),ST.prototype),sc(ST.prototype,"shadowColor",[cT],Object.getOwnPropertyDescriptor(ST.prototype,"shadowColor"),ST.prototype),sc(ST.prototype,"planeDirection",[lT,hT],Object.getOwnPropertyDescriptor(ST.prototype,"planeDirection"),ST.prototype),sc(ST.prototype,"planeHeight",[Mc,_T,uT,dT],Object.getOwnPropertyDescriptor(ST.prototype,"planeHeight"),ST.prototype),sc(ST.prototype,"maxReceived",[mT,pT,fT],Object.getOwnPropertyDescriptor(ST.prototype,"maxReceived"),ST.prototype),sc(ST.prototype,"shadowMapSize",[gT,vT,yT],Object.getOwnPropertyDescriptor(ST.prototype,"shadowMapSize"),ST.prototype),CT=sc(ST.prototype,"_enabled",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),AT=sc(ST.prototype,"_type",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pg.Planar}}),bT=sc(ST.prototype,"_normal",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi(0,1,0)}}),TT=sc(ST.prototype,"_distance",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ET=sc(ST.prototype,"_shadowColor",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(0,0,0,76)}}),PT=sc(ST.prototype,"_maxReceived",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),wT=sc(ST.prototype,"_size",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi(512,512)}}),xT=ST))||xT));l.ShadowsInfo=cE;const lE=t("DEFAULT_WORLD_MIN_POS",new mi(-1024,-1024,-1024)),hE=t("DEFAULT_WORLD_MAX_POS",new mi(1024,1024,1024)),_E=t("DEFAULT_OCTREE_DEPTH",8);let uE=t("OctreeInfo",(IT=dc("cc.OctreeInfo"),RT=Lc(),DT=Lc(),MT=Nc(),OT=Lc(),BT=Nc(),NT=Fc(),LT=Kc(pe),FT=Lc(),IT((sc((VT=class{constructor(){nc(this,"_enabled",GT,this),nc(this,"_minPos",UT,this),nc(this,"_maxPos",kT,this),nc(this,"_depth",HT,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t))}get enabled(){return this._enabled}set minPos(t){this._minPos=t,this._resource&&(this._resource.minPos=t)}get minPos(){return this._minPos}set maxPos(t){this._maxPos=t,this._resource&&(this._resource.maxPos=t)}get maxPos(){return this._maxPos}set depth(t){this._depth=t,this._resource&&(this._resource.depth=t)}get depth(){return this._depth}activate(t){this._resource=t,this._resource.initialize(this)}}).prototype,"enabled",[Mc,RT],Object.getOwnPropertyDescriptor(VT.prototype,"enabled"),VT.prototype),sc(VT.prototype,"minPos",[Mc,DT,MT],Object.getOwnPropertyDescriptor(VT.prototype,"minPos"),VT.prototype),sc(VT.prototype,"maxPos",[Mc,OT,BT],Object.getOwnPropertyDescriptor(VT.prototype,"maxPos"),VT.prototype),sc(VT.prototype,"depth",[Mc,NT,Uc,LT,FT],Object.getOwnPropertyDescriptor(VT.prototype,"depth"),VT.prototype),GT=sc(VT.prototype,"_enabled",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UT=sc(VT.prototype,"_minPos",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi(lE)}}),kT=sc(VT.prototype,"_maxPos",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi(hE)}}),HT=sc(VT.prototype,"_depth",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _E}}),zT=VT))||zT)),dE=t("SceneGlobals",(jT=dc("cc.SceneGlobals"),WT=Kc(oE),jT((YT=sc((XT=class{constructor(){nc(this,"ambient",YT,this),nc(this,"shadows",KT,this),nc(this,"_skybox",JT,this),nc(this,"fog",$T,this),nc(this,"octree",ZT,this)}get skybox(){return this._skybox}set skybox(t){this._skybox=t}activate(){const t=l.director.root.pipeline.pipelineSceneData;this.skybox.activate(t.skybox),this.ambient.activate(t.ambient),this.shadows.activate(t.shadows),this.fog.activate(t.fog),this.octree.activate(t.octree)}}).prototype,"ambient",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rE}}),KT=sc(XT.prototype,"shadows",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new cE}}),JT=sc(XT.prototype,"_skybox",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oE}}),$T=sc(XT.prototype,"fog",[Mc,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new aE}}),sc(XT.prototype,"skybox",[Mc,WT],Object.getOwnPropertyDescriptor(XT.prototype,"skybox"),XT.prototype),ZT=sc(XT.prototype,"octree",[Mc,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uE}}),qT=XT))||qT));l.SceneGlobals=dE;class mE{constructor(t,e){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!e}unuse(){this.type=mE.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=mE.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}reuse(t,e){this.type=t,this.bubbles=e||!1}isStopped(){return this.propagationStopped||this.propagationImmediateStopped}getCurrentTarget(){return this.currentTarget}getType(){return this.type}}t("Event",mE),mE.NO_TYPE="no_type",mE.TOUCH="touch",mE.MOUSE="mouse",mE.KEYBOARD="keyboard",mE.ACCELERATION="acceleration",mE.NONE=0,mE.CAPTURING_PHASE=1,mE.AT_TARGET=2,mE.BUBBLING_PHASE=3,l.Event=mE;class pE extends mE{constructor(t,e){super(dA.DEVICEMOTION,e),this.acc=void 0,this.acc=t}}t("EventAcceleration",pE),mE.EventAcceleration=pE;class fE extends mE{get isPressed(){return this._isPressed}constructor(t,e,i){"boolean"==typeof e&&(e=e?dA.KEY_DOWN:dA.KEY_UP),super(e,i),this.keyCode=void 0,this.rawEvent=void 0,this._isPressed=void 0,this._isPressed=e!==dA.KEY_UP,"number"==typeof t?this.keyCode=t:(this.keyCode=t.keyCode,this.rawEvent=t)}}t("EventKeyboard",fE),mE.EventKeyboard=fE;class gE extends mE{get eventType(){return this._eventType}constructor(t,e,i){super(t,e),this.movementX=0,this.movementY=0,this.preventSwallow=!1,this._eventType=void 0,this._button=gE.BUTTON_MISSING,this._x=0,this._y=0,this._prevX=0,this._prevY=0,this._scrollX=0,this._scrollY=0,this._eventType=t,i&&(this._prevX=i.x,this._prevY=i.y)}setScrollData(t,e){this._scrollX=t,this._scrollY=e}getScrollX(){return this._scrollX}getScrollY(){return this._scrollY}setLocation(t,e){this._x=t,this._y=e}getLocation(t){return t||(t=new Oi),Oi.set(t,this._x,this._y),t}getLocationInView(t){return t||(t=new Oi),Oi.set(t,this._x,l.view._designResolutionSize.height-this._y),t}getUILocation(t){return t||(t=new Oi),Oi.set(t,this._x,this._y),l.view._convertToUISpace(t),t}getPreviousLocation(t){return t||(t=new Oi),Oi.set(t,this._prevX,this._prevY),t}getUIPreviousLocation(t){return t||(t=new Oi),Oi.set(t,this._prevX,this._prevY),l.view._convertToUISpace(t),t}getDelta(t){return t||(t=new Oi),Oi.set(t,this._x-this._prevX,this._y-this._prevY),t}getDeltaX(){return this._x-this._prevX}getDeltaY(){return this._y-this._prevY}getUIDelta(t){return t||(t=new Oi),Oi.set(t,(this._x-this._prevX)/l.view.getScaleX(),(this._y-this._prevY)/l.view.getScaleY()),t}getUIDeltaX(){return(this._x-this._prevX)/l.view.getScaleX()}getUIDeltaY(){return(this._y-this._prevY)/l.view.getScaleY()}setButton(t){this._button=t}getButton(){return this._button}getLocationX(){return this._x}getLocationY(){return this._y}getUILocationX(){const t=l.view.getViewportRect();return(this._x-t.x)/l.view.getScaleX()}getUILocationY(){const t=l.view.getViewportRect();return(this._y-t.y)/l.view.getScaleY()}}t("EventMouse",gE),gE.BUTTON_MISSING=-1,gE.BUTTON_LEFT=0,gE.BUTTON_RIGHT=2,gE.BUTTON_MIDDLE=1,gE.BUTTON_4=3,gE.BUTTON_5=4,gE.BUTTON_6=5,gE.BUTTON_7=6,gE.BUTTON_8=7,mE.EventMouse=gE;const vE=new Oi;class yE extends mE{constructor(t,e,i,n=[]){super(i,e),this.touch=null,this.simulate=!1,this.preventSwallow=!1,this._eventCode=void 0,this._touches=void 0,this._allTouches=void 0,this._eventCode=i,this._touches=t||[],this._allTouches=n}getEventCode(){return this._eventCode}getTouches(){return this._touches}getAllTouches(){return this._allTouches}setLocation(t,e){this.touch&&this.touch.setTouchInfo(this.touch.getID(),t,e)}getLocation(t){return this.touch?this.touch.getLocation(t):new Oi}getUILocation(t){return this.touch?this.touch.getUILocation(t):new Oi}getLocationInView(t){return this.touch?this.touch.getLocationInView(t):new Oi}getPreviousLocation(t){return this.touch?this.touch.getPreviousLocation(t):new Oi}getStartLocation(t){return this.touch?this.touch.getStartLocation(t):new Oi}getUIStartLocation(t){return this.touch?this.touch.getUIStartLocation(t):new Oi}getID(){return this.touch?this.touch.getID():null}getDelta(t){return this.touch?this.touch.getDelta(t):new Oi}getUIDelta(t){return this.touch?this.touch.getUIDelta(t):new Oi}getDeltaX(){return this.touch?this.touch.getDelta(vE).x:0}getDeltaY(){return this.touch?this.touch.getDelta(vE).y:0}getLocationX(){return this.touch?this.touch.getLocationX():0}getLocationY(){return this.touch?this.touch.getLocationY():0}}t("EventTouch",yE),yE.MAX_TOUCHES=5,mE.EventTouch=yE;class xE{constructor(t=0,e=0,i=0,n=0){this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=e,this.z=i,this.timestamp=n}}let SE;t("Acceleration",xE),function(t){t[t.NONE=0]="NONE",t[t.MOBILE_BACK=6]="MOBILE_BACK",t[t.BACKSPACE=8]="BACKSPACE",t[t.TAB=9]="TAB",t[t.ENTER=13]="ENTER",t[t.SHIFT_LEFT=16]="SHIFT_LEFT",t[t.CTRL_LEFT=17]="CTRL_LEFT",t[t.ALT_LEFT=18]="ALT_LEFT",t[t.PAUSE=19]="PAUSE",t[t.CAPS_LOCK=20]="CAPS_LOCK",t[t.ESCAPE=27]="ESCAPE",t[t.SPACE=32]="SPACE",t[t.PAGE_UP=33]="PAGE_UP",t[t.PAGE_DOWN=34]="PAGE_DOWN",t[t.END=35]="END",t[t.HOME=36]="HOME",t[t.ARROW_LEFT=37]="ARROW_LEFT",t[t.ARROW_UP=38]="ARROW_UP",t[t.ARROW_RIGHT=39]="ARROW_RIGHT",t[t.ARROW_DOWN=40]="ARROW_DOWN",t[t.INSERT=45]="INSERT",t[t.DELETE=46]="DELETE",t[t.DIGIT_0=48]="DIGIT_0",t[t.DIGIT_1=49]="DIGIT_1",t[t.DIGIT_2=50]="DIGIT_2",t[t.DIGIT_3=51]="DIGIT_3",t[t.DIGIT_4=52]="DIGIT_4",t[t.DIGIT_5=53]="DIGIT_5",t[t.DIGIT_6=54]="DIGIT_6",t[t.DIGIT_7=55]="DIGIT_7",t[t.DIGIT_8=56]="DIGIT_8",t[t.DIGIT_9=57]="DIGIT_9",t[t.KEY_A=65]="KEY_A",t[t.KEY_B=66]="KEY_B",t[t.KEY_C=67]="KEY_C",t[t.KEY_D=68]="KEY_D",t[t.KEY_E=69]="KEY_E",t[t.KEY_F=70]="KEY_F",t[t.KEY_G=71]="KEY_G",t[t.KEY_H=72]="KEY_H",t[t.KEY_I=73]="KEY_I",t[t.KEY_J=74]="KEY_J",t[t.KEY_K=75]="KEY_K",t[t.KEY_L=76]="KEY_L",t[t.KEY_M=77]="KEY_M",t[t.KEY_N=78]="KEY_N",t[t.KEY_O=79]="KEY_O",t[t.KEY_P=80]="KEY_P",t[t.KEY_Q=81]="KEY_Q",t[t.KEY_R=82]="KEY_R",t[t.KEY_S=83]="KEY_S",t[t.KEY_T=84]="KEY_T",t[t.KEY_U=85]="KEY_U",t[t.KEY_V=86]="KEY_V",t[t.KEY_W=87]="KEY_W",t[t.KEY_X=88]="KEY_X",t[t.KEY_Y=89]="KEY_Y",t[t.KEY_Z=90]="KEY_Z",t[t.NUM_0=96]="NUM_0",t[t.NUM_1=97]="NUM_1",t[t.NUM_2=98]="NUM_2",t[t.NUM_3=99]="NUM_3",t[t.NUM_4=100]="NUM_4",t[t.NUM_5=101]="NUM_5",t[t.NUM_6=102]="NUM_6",t[t.NUM_7=103]="NUM_7",t[t.NUM_8=104]="NUM_8",t[t.NUM_9=105]="NUM_9",t[t.NUM_MULTIPLY=106]="NUM_MULTIPLY",t[t.NUM_PLUS=107]="NUM_PLUS",t[t.NUM_SUBTRACT=109]="NUM_SUBTRACT",t[t.NUM_DECIMAL=110]="NUM_DECIMAL",t[t.NUM_DIVIDE=111]="NUM_DIVIDE",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.NUM_LOCK=144]="NUM_LOCK",t[t.SCROLL_LOCK=145]="SCROLL_LOCK",t[t.SEMICOLON=186]="SEMICOLON",t[t.EQUAL=187]="EQUAL",t[t.COMMA=188]="COMMA",t[t.DASH=189]="DASH",t[t.PERIOD=190]="PERIOD",t[t.SLASH=191]="SLASH",t[t.BACK_QUOTE=192]="BACK_QUOTE",t[t.BRACKET_LEFT=219]="BRACKET_LEFT",t[t.BACKSLASH=220]="BACKSLASH",t[t.BRACKET_RIGHT=221]="BRACKET_RIGHT",t[t.QUOTE=222]="QUOTE",t[t.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",t[t.CTRL_RIGHT=2001]="CTRL_RIGHT",t[t.ALT_RIGHT=2002]="ALT_RIGHT",t[t.NUM_ENTER=2003]="NUM_ENTER"}(SE||(SE=t("KeyCode",{})));const CE=new Oi;class AE{get lastModified(){return this._lastModified}constructor(t,e,i=0){this._point=new Oi,this._prevPoint=new Oi,this._lastModified=0,this._id=0,this._startPoint=new Oi,this._startPointCaptured=!1,this.setTouchInfo(i,t,e)}getLocation(t){return t||(t=new Oi),t.set(this._point.x,this._point.y),t}getLocationX(){return this._point.x}getLocationY(){return this._point.y}getUILocation(t){return t||(t=new Oi),t.set(this._point.x,this._point.y),l.view._convertToUISpace(t),t}getUILocationX(){const t=l.view.getViewportRect();return(this._point.x-t.x)/l.view.getScaleX()}getUILocationY(){const t=l.view.getViewportRect();return(this._point.y-t.y)/l.view.getScaleY()}getPreviousLocation(t){return t||(t=new Oi),t.set(this._prevPoint.x,this._prevPoint.y),t}getUIPreviousLocation(t){return t||(t=new Oi),t.set(this._prevPoint.x,this._prevPoint.y),l.view._convertToUISpace(t),t}getStartLocation(t){return t||(t=new Oi),t.set(this._startPoint.x,this._startPoint.y),t}getUIStartLocation(t){return t||(t=new Oi),t.set(this._startPoint.x,this._startPoint.y),l.view._convertToUISpace(t),t}getDelta(t){return t||(t=new Oi),t.set(this._point),t.subtract(this._prevPoint),t}getUIDelta(t){return t||(t=new Oi),CE.set(this._point),CE.subtract(this._prevPoint),t.set(l.view.getScaleX(),l.view.getScaleY()),Oi.divide(t,CE,t),t}getLocationInView(t){return t||(t=new Oi),t.set(this._point.x,l.view._designResolutionSize.height-this._point.y),t}getPreviousLocationInView(t){return t||(t=new Oi),t.set(this._prevPoint.x,l.view._designResolutionSize.height-this._prevPoint.y),t}getStartLocationInView(t){return t||(t=new Oi),t.set(this._startPoint.x,l.view._designResolutionSize.height-this._startPoint.y),t}getID(){return this._id}setTouchInfo(t=0,e,i){this._prevPoint=this._point,this._point=new Oi(e||0,i||0),this._id=t,this._startPointCaptured||(this._startPoint=new Oi(this._point),this._startPointCaptured=!0)}setPoint(t,e){"object"==typeof t?(this._point.x=t.x,this._point.y=t.y):(this._point.x=t||0,this._point.y=e||0),this._lastModified=l.game.frameStartTime}setPrevPoint(t,e){this._prevPoint="object"==typeof t?new Oi(t.x,t.y):new Oi(t||0,e||0),this._lastModified=l.game.frameStartTime}}t("Touch",AE),l.Touch=AE;class bE{constructor(){this._intervalInSeconds=.2,this._intervalId=void 0,this._isEnabled=!1,this._eventTarget=new Hl,this._didAccelerateFunc=void 0,this._didAccelerateFunc=this._didAccelerate.bind(this)}_didAccelerate(){const t=jsb.device.getDeviceMotionValue();let e=.1*t[3],i=.1*t[4];const n=.1*t[5],s=jh.orientation,r=e;s===Uh.LANDSCAPE_RIGHT?(e=-i,i=r):s===Uh.LANDSCAPE_LEFT?(e=i,i=-r):s===Uh.PORTRAIT_UPSIDE_DOWN&&(e=-e,i=-i),Zl.os!==Xl.ANDROID&&Zl.os!==Xl.OHOS||(e=-e,i=-i);const o=performance.now(),a=new xE(e,i,n,o),c=new pE(a);this._eventTarget.emit(mA.DEVICEMOTION,c)}start(){this._intervalId&&clearInterval(this._intervalId),this._intervalId=setInterval(this._didAccelerateFunc,1e3*this._intervalInSeconds),jsb.device.setAccelerometerInterval(this._intervalInSeconds),jsb.device.setAccelerometerEnabled(!0),this._isEnabled=!0}stop(){this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),jsb.device.setAccelerometerEnabled(!1),this._isEnabled=!1}setInterval(t){this._intervalInSeconds=t/1e3,jsb.device.setAccelerometerInterval(this._intervalInSeconds),this._isEnabled&&(jsb.device.setAccelerometerEnabled(!1),jsb.device.setAccelerometerEnabled(!0))}on(t,e,i){this._eventTarget.on(t,e,i)}}const TE={12:SE.NUM_LOCK,10048:SE.NUM_0,10049:SE.NUM_1,10050:SE.NUM_2,10051:SE.NUM_3,10052:SE.NUM_4,10053:SE.NUM_5,10054:SE.NUM_6,10055:SE.NUM_7,10056:SE.NUM_8,10057:SE.NUM_9,20013:SE.NUM_ENTER,20016:SE.SHIFT_RIGHT,20017:SE.CTRL_RIGHT,20018:SE.ALT_RIGHT};function EE(t){return TE[t]||t}class PE{constructor(){this._eventTarget=new Hl,this._keyStateMap={},this._registerEvent()}_registerEvent(){jsb.onKeyDown=t=>{const e=EE(t.keyCode);if(this._keyStateMap[e]){const e=this._getInputEvent(t,mA.KEY_PRESSING);this._eventTarget.emit(mA.KEY_PRESSING,e)}else{const e=this._getInputEvent(t,mA.KEY_DOWN);this._eventTarget.emit(mA.KEY_DOWN,e)}this._keyStateMap[e]=!0},jsb.onKeyUp=t=>{const e=EE(t.keyCode),i=this._getInputEvent(t,mA.KEY_UP);this._keyStateMap[e]=!1,this._eventTarget.emit(mA.KEY_UP,i)}}_getInputEvent(t,e){const i=EE(t.keyCode);return new fE(i,e)}on(t,e,i){this._eventTarget.on(t,e,i)}}class wE{constructor(){this._eventTarget=new Hl,this._preMousePos=new Oi,this._isPressed=!1,this._registerEvent()}_getLocation(t){const e=jh.windowSize,i=jh.devicePixelRatio,n=t.x*i,s=e.height-t.y*i;return new Oi(n,s)}_registerEvent(){jsb.onMouseDown=this._createCallback(mA.MOUSE_DOWN),jsb.onMouseMove=this._createCallback(mA.MOUSE_MOVE),jsb.onMouseUp=this._createCallback(mA.MOUSE_UP),jsb.onMouseWheel=this._handleMouseWheel.bind(this)}_createCallback(t){return e=>{const i=this._getLocation(e);let n=e.button;switch(t){case mA.MOUSE_DOWN:this._isPressed=!0;break;case mA.MOUSE_UP:this._isPressed=!1;break;case mA.MOUSE_MOVE:this._isPressed||(n=gE.BUTTON_MISSING)}const s=new gE(t,!1,this._preMousePos);s.setLocation(i.x,i.y),s.setButton(n),s.movementX=i.x-this._preMousePos.x,s.movementY=this._preMousePos.y-i.y,this._preMousePos.set(i.x,i.y),this._eventTarget.emit(t,s)}}_handleMouseWheel(t){const e=mA.MOUSE_WHEEL,i=this._getLocation(t),n=t.button,s=new gE(e,!1,this._preMousePos);s.setLocation(i.x,i.y),s.setButton(n),s.movementX=i.x-this._preMousePos.x,s.movementY=this._preMousePos.y-i.y,s.setScrollData(120*t.wheelDeltaX,120*t.wheelDeltaY),this._preMousePos.set(i.x,i.y),this._eventTarget.emit(e,s)}on(t,e,i){this._eventTarget.on(t,e,i)}}const IE=new Oi,RE=new class{constructor(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}_cloneTouch(t){const e=t.getID();t.getStartLocation(IE);const i=new AE(IE.x,IE.y,e);return t.getLocation(IE),i.setPoint(IE.x,IE.y),t.getPreviousLocation(IE),i.setPrevPoint(IE),i}_createTouch(t,e,i){if(this._touchMap.has(t))return void console.log("Cannot create the same touch object.");if(this._checkTouchMapSizeMoreThanMax(t))return void console.log("The touches is more than MAX_TOUCHES.");const n=new AE(e,i,t);return this._touchMap.set(t,n),this._updateTouch(n,e,i),this._cloneTouch(n)}releaseTouch(t){this._touchMap.has(t)&&this._touchMap.delete(t)}getTouch(t,e,i){let n=this._touchMap.get(t);return n?this._updateTouch(n,e,i):n=this._createTouch(t,e,i),n?this._cloneTouch(n):void 0}getAllTouches(){const t=[];return this._touchMap.forEach((e=>{if(e){const i=this._cloneTouch(e);t.push(i)}})),t}_updateTouch(t,e,i){t.getLocation(IE),t.setPrevPoint(IE),t.setPoint(e,i)}_checkTouchMapSizeMoreThanMax(t){if(this._touchMap.has(t))return!1;const e=Kt.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<e)return!1;const i=performance.now();return this._touchMap.forEach((t=>{i-t.lastModified>Kt.TOUCH_TIMEOUT&&(console.log(`The touches is more than MAX_TOUCHES, release touch id ${t.getID()}.`),this.releaseTouch(t.getID()))})),e>=this._touchMap.size}};class DE{constructor(){this._eventTarget=new Hl,this._registerEvent()}_registerEvent(){jsb.onTouchStart=this._createCallback(mA.TOUCH_START),jsb.onTouchMove=this._createCallback(mA.TOUCH_MOVE),jsb.onTouchEnd=this._createCallback(mA.TOUCH_END),jsb.onTouchCancel=this._createCallback(mA.TOUCH_CANCEL)}_createCallback(t){return e=>{const i=[],n=e.length,s=jh.windowSize;for(let r=0;r<n;++r){const n=e[r],o=n.identifier;if(null===o)continue;const a=this._getLocation(n,s),c=RE.getTouch(o,a.x,a.y);c&&(t!==mA.TOUCH_END&&t!==mA.TOUCH_CANCEL||RE.releaseTouch(o),i.push(c))}if(i.length>0){const e=new yE(i,!1,t,Kt.ENABLE_MULTI_TOUCH?RE.getAllTouches():i);this._eventTarget.emit(t,e)}}}_getLocation(t,e){const i=jh.devicePixelRatio,n=t.clientX*i,s=e.height-t.clientY*i;return new Oi(n,s)}on(t,e,i){this._eventTarget.on(t,e,i)}}let ME;!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.UI=1]="UI"}(ME||(ME={}));class OE{constructor(t){this.priority=ME.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=t}dispatchEvent(t){return this._inputEventTarget.emit(t.type,t),!0}}const BE={[mA.MOUSE_DOWN]:mA.TOUCH_START,[mA.MOUSE_MOVE]:mA.TOUCH_MOVE,[mA.MOUSE_UP]:mA.TOUCH_END};class NE{constructor(){this._dispatchImmediately=!1,this._eventTarget=new Hl,this._touchInput=new DE,this._mouseInput=new wE,this._keyboardInput=new PE,this._accelerometerInput=new bE,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new OE(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}on(t,e,i){return this._eventTarget.on(t,e,i),e}once(t,e,i){return this._eventTarget.once(t,e,i),e}off(t,e,i){this._eventTarget.off(t,e,i)}setAccelerometerEnabled(t){t?this._accelerometerInput.start():this._accelerometerInput.stop()}setAccelerometerInterval(t){this._accelerometerInput.setInterval(t)}_simulateEventTouch(t){const e=BE[t.type],i=RE.getTouch(0,t.getLocationX(),t.getLocationY());if(!i)return;const n=[i],s=new yE(n,!1,e,n);e===mA.TOUCH_END&&RE.releaseTouch(0),this._dispatchOrPushEventTouch(s,this._eventTouchList)}_registerEventDispatcher(t){this._eventDispatcherList.push(t),this._eventDispatcherList.sort(((t,e)=>e.priority-t.priority))}_emitEvent(t){const e=this._eventDispatcherList.length;for(let i=0;i<e&&this._eventDispatcherList[i].dispatchEvent(t);++i);}_registerEvent(){if(qh.hasFeature(qh.Feature.INPUT_TOUCH)){const t=this._eventTouchList;this._touchInput.on(mA.TOUCH_START,(e=>{this._dispatchOrPushEventTouch(e,t)})),this._touchInput.on(mA.TOUCH_MOVE,(e=>{this._dispatchOrPushEventTouch(e,t)})),this._touchInput.on(mA.TOUCH_END,(e=>{this._dispatchOrPushEventTouch(e,t)})),this._touchInput.on(mA.TOUCH_CANCEL,(e=>{this._dispatchOrPushEventTouch(e,t)}))}if(qh.hasFeature(qh.Feature.EVENT_MOUSE)){const t=this._eventMouseList;this._mouseInput.on(mA.MOUSE_DOWN,(e=>{this._needSimulateTouchMoveEvent=!0,this._simulateEventTouch(e),this._dispatchOrPushEvent(e,t)})),this._mouseInput.on(mA.MOUSE_MOVE,(e=>{this._needSimulateTouchMoveEvent&&this._simulateEventTouch(e),this._dispatchOrPushEvent(e,t)})),this._mouseInput.on(mA.MOUSE_UP,(e=>{this._needSimulateTouchMoveEvent=!1,this._simulateEventTouch(e),this._dispatchOrPushEvent(e,t)})),this._mouseInput.on(mA.MOUSE_WHEEL,(e=>{this._dispatchOrPushEvent(e,t)}))}if(qh.hasFeature(qh.Feature.EVENT_KEYBOARD)){const t=this._eventKeyboardList;this._keyboardInput.on(mA.KEY_DOWN,(e=>{this._dispatchOrPushEvent(e,t)})),this._keyboardInput.on(mA.KEY_PRESSING,(e=>{this._dispatchOrPushEvent(e,t)})),this._keyboardInput.on(mA.KEY_UP,(e=>{this._dispatchOrPushEvent(e,t)}))}if(qh.hasFeature(qh.Feature.EVENT_ACCELEROMETER)){const t=this._eventAccelerationList;this._accelerometerInput.on(mA.DEVICEMOTION,(e=>{this._dispatchOrPushEvent(e,t)}))}}_clearEvents(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0}_dispatchOrPushEvent(t,e){this._dispatchImmediately?this._emitEvent(t):e.push(t)}_dispatchOrPushEventTouch(t,e){if(this._dispatchImmediately){const e=t.getTouches(),i=e.length;for(let n=0;n<i;++n)t.touch=e[n],t.propagationStopped=t.propagationImmediateStopped=!1,this._emitEvent(t)}else e.push(t)}_frameDispatchEvents(){const t=this._eventMouseList;for(let e=0,i=t.length;e<i;++e){const i=t[e];this._emitEvent(i)}const e=this._eventTouchList;for(let t=0,i=e.length;t<i;++t){const i=e[t],n=i.getTouches(),s=n.length;for(let t=0;t<s;++t)i.touch=n[t],i.propagationStopped=i.propagationImmediateStopped=!1,this._emitEvent(i)}const i=this._eventKeyboardList;for(let t=0,e=i.length;t<e;++t){const e=i[t];this._emitEvent(e)}const n=this._eventAccelerationList;for(let t=0,e=n.length;t<e;++t){const e=n[t];this._emitEvent(e)}this._clearEvents()}}t("Input",NE),NE.EventType=mA;const LE=t("input",new NE);class FE extends Hl{constructor(){super(),LE.on(mA.MOUSE_DOWN,(t=>{this.emit(dA.MOUSE_DOWN,t)})),LE.on(mA.MOUSE_MOVE,(t=>{this.emit(dA.MOUSE_MOVE,t)})),LE.on(mA.MOUSE_UP,(t=>{this.emit(dA.MOUSE_UP,t)})),LE.on(mA.MOUSE_WHEEL,(t=>{this.emit(dA.MOUSE_WHEEL,t)})),LE.on(mA.TOUCH_START,(t=>{this.emit(dA.TOUCH_START,t.touch,t)})),LE.on(mA.TOUCH_MOVE,(t=>{this.emit(dA.TOUCH_MOVE,t.touch,t)})),LE.on(mA.TOUCH_END,(t=>{this.emit(dA.TOUCH_END,t.touch,t)})),LE.on(mA.TOUCH_CANCEL,(t=>{this.emit(dA.TOUCH_CANCEL,t.touch,t)})),LE.on(mA.KEY_DOWN,(t=>{this.emit(dA.KEY_DOWN,t)})),LE.on(mA.KEY_PRESSING,(t=>{this.emit(dA.KEY_DOWN,t)})),LE.on(mA.KEY_UP,(t=>{this.emit(dA.KEY_UP,t)})),LE.on(mA.DEVICEMOTION,(t=>{this.emit(dA.DEVICEMOTION,t)}))}setAccelerometerEnabled(t){LE.setAccelerometerEnabled(t)}setAccelerometerInterval(t){LE.setAccelerometerInterval(t)}on(t,e,i,n){return super.on(t,e,i,n),e}off(t,e,i){super.off(t,e,i)}}t("SystemEvent",FE),FE.EventType=dA,l.SystemEvent=FE;const zE=t("systemEvent",new FE);var VE;l.systemEvent=zE,V(dA,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),V(mE,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:FE.EventType,targetName:"SystemEvent.EventType"}]),U(mE,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),V(gE,"EventMouse",["DOWN","UP","MOVE"].map((t=>({name:t,newName:`MOUSE_${t}`,target:FE.EventType,targetName:"SystemEvent.EventType"})))),V(gE,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:FE.EventType,targetName:"SystemEvent.EventType"}]),U(gE.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),V(yE,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:FE.EventType,targetName:"SystemEvent.EventType"}]),V(yE,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:FE.EventType,targetName:"SystemEvent.EventType"}]),V(yE,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:FE.EventType,targetName:"SystemEvent.EventType"}]),V(yE,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:FE.EventType,targetName:"SystemEvent.EventType"}]),U(yE.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),V(yE.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:yE,targetName:"EventTouch"}]),U(Kt.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((t=>({name:t})))),U(Kt.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),U(Kt.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),U(Kt.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),U(Kt,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),V(Dx.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter(){return this.children.length}}]),V(iS.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.width},customSetter(t){this._uiProps.uiTransformComp.width=t}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.height},customSetter(t){this._uiProps.uiTransformComp.height=t}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.anchorX},customSetter(t){this._uiProps.uiTransformComp.anchorX=t}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.anchorY},customSetter(t){this._uiProps.uiTransformComp.anchorY=t}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction(t){return t||(t=new Oi),t.set(this._uiProps.uiTransformComp.anchorPoint),t}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction(t,e){this._uiProps.uiTransformComp.setAnchorPoint(t,e)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction(t){return t||(t=new Gi),t.set(this._uiProps.uiTransformComp.contentSize),t}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction(t,e){"number"==typeof t?this._uiProps.uiTransformComp.setContentSize(t,e):this._uiProps.uiTransformComp.setContentSize(t)}}]),G(dE.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"},{name:"fixedArea"},{name:"pcf"},{name:"bias"},{name:"normalBias"},{name:"near"},{name:"far"},{name:"shadowDistance"},{name:"invisibleOcclusionRange"},{name:"orthoSize"},{name:"saturation"}]),V(dE.prototype,"SceneGlobals.prototype",[{name:"distance",newName:"planeHeight"},{name:"normal",newName:"planeDirection"}]),G(iS.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),V(px.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),G(Yd,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),V(Yd,"Layers",[{name:"Default",newName:"DEFAULT",target:Yd.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Yd.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Yd.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Yd.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Yd.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Yd.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Yd.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Yd.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Yd,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Yd,targetName:"Layers"}]),G(Yd.Enum,"Layers.Enum",[{name:"ALWAYS"}]),G(Yd.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);const GE=il.Flags.HideInHierarchy,UE=il.Flags.DontSave;let kE=t("PrivateNode",dc("cc.PrivateNode")(VE=class extends iS{constructor(t){super(t),I(12003,this.name),this.hideFlags|=UE|GE}})||VE);var HE,jE,WE,qE;V(dA,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((t=>({name:t,target:iS.EventType,targetName:"Node.EventType"})))),V(iS.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:FE.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:FE.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:FE.EventType,targetName:"SystemEvent.EventType"}]),l.PrivateNode=kE;let XE=t("Scene",dc("cc.Scene")((sc((jE=class extends Dx{get renderScene(){return this._renderScene}get globals(){return this._globals}_updateScene(){this._scene=this}get native(){return this._nativeObj}_init(){this._nativeObj=new aa}constructor(t){super(t),nc(this,"autoReleaseAssets",WE,this),nc(this,"_globals",qE,this),this.dependAssets=null,this._renderScene=null,this._inited=void 0,this._prefabSyncedInLiveReload=!1,this._pos=mi.ZERO,this._rot=Si.IDENTITY,this._scale=mi.ONE,this._mat=Ii.IDENTITY,this._dirtyFlags=0,this._lpos=mi.ZERO,this._lrot=Si.IDENTITY,this._lscale=mi.ONE,this._activeInHierarchy=!1,l.director&&l.director.root&&(this._renderScene=l.director.root.createScene({})),this._inited=!l.game||!l.game._isCloning,this._init()}destroy(){const t=il.prototype.destroy.call(this);if(t){const t=this._children;for(let e=0;e<t.length;++e)t[e].active=!1}return this._renderScene&&l.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,t}addComponent(){throw new Error(N(3822))}_onHierarchyChanged(){}_onBatchCreated(t){super._onBatchCreated(t);const e=this._children.length;for(let i=0;i<e;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)}getPosition(t){return mi.copy(t||new mi,mi.ZERO)}getRotation(t){return Si.copy(t||new Si,Si.IDENTITY)}getScale(t){return mi.copy(t||new mi,mi.ONE)}getWorldPosition(t){return mi.copy(t||new mi,mi.ZERO)}getWorldRotation(t){return Si.copy(t||new Si,Si.IDENTITY)}getWorldScale(t){return mi.copy(t||new mi,mi.ONE)}getWorldMatrix(t){return Ii.copy(t||new Ii,Ii.IDENTITY)}getWorldRS(t){return Ii.copy(t||new Ii,Ii.IDENTITY)}getWorldRT(t){return Ii.copy(t||new Ii,Ii.IDENTITY)}get position(){return mi.ZERO}get worldPosition(){return mi.ZERO}get rotation(){return Si.IDENTITY}get worldRotation(){return Si.IDENTITY}get scale(){return mi.ONE}get worldScale(){return mi.ONE}get eulerAngles(){return mi.ZERO}get worldMatrix(){return Ii.IDENTITY}updateWorldTransform(){}_instantiate(){}_load(){this._inited||(DC(this),IC(this),this._onBatchCreated(false),this._inited=!0),this.walk(Dx._setScene)}_activate(t){t=!1!==t,l.director._nodeActivator.activateNode(this,t),this._globals.activate(),this._renderScene&&this._renderScene.activate()}}).prototype,"globals",[Mc],Object.getOwnPropertyDescriptor(jE.prototype,"globals"),jE.prototype),WE=sc(jE.prototype,"autoReleaseAssets",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qE=sc(jE.prototype,"_globals",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dE}}),HE=jE))||HE);function YE(t,e){if(!e){const t=l.director.getScene();if(!t)return null;e=t}return e.getChildByPath(t)}l.Scene=XE,l.find=YE;const KE=Gt.fastRemoveAt,JE=il.Flags.IsStartCalled,$E=il.Flags.IsOnEnableCalled;function ZE(t,e){const i=e.constructor._executionOrder,n=e._id;let s=0;for(let e=t.length-1,r=e>>>1;s<=e;r=s+e>>>1){const o=t[r],a=o.constructor._executionOrder;if(a>i)e=r-1;else if(a<i)s=r+1;else{const t=o._id;if(t>n)e=r-1;else{if(!(t<n))return r;s=r+1}}}return~s}function QE(t,e){const i=t.array;let n=t.i+1;for(;n<i.length;){const s=i[n];s.node._activeInHierarchy?++n:(t.removeAt(n),e&&(s._objFlags&=~e))}}il.Flags.IsEditorOnEnableCalled;class tP{constructor(t){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;const e=Y;this._zero=new e([]),this._neg=new e([]),this._pos=new e([]),this._invoke=t}}function eP(t,e){return t.constructor._executionOrder-e.constructor._executionOrder}tP.stableRemoveInactive=QE;class iP extends tP{add(t){const e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).array.push(t)}remove(t){const e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).fastRemove(t)}cancelInactive(t){QE(this._zero,t),QE(this._neg,t),QE(this._pos,t)}invoke(){const t=this._neg;t.array.length>0&&(t.array.sort(eP),this._invoke(t),t.array.length=0),this._invoke(this._zero),this._zero.array.length=0;const e=this._pos;e.array.length>0&&(e.array.sort(eP),this._invoke(e),e.array.length=0)}}class nP extends tP{add(t){const e=t.constructor._executionOrder;if(0===e)this._zero.array.push(t);else{const i=e<0?this._neg.array:this._pos.array,n=ZE(i,t);n<0&&i.splice(~n,0,t)}}remove(t){const e=t.constructor._executionOrder;if(0===e)this._zero.fastRemove(t);else{const i=e<0?this._neg:this._pos,n=ZE(i.array,t);n>=0&&i.removeAt(n)}}invoke(t){this._neg.array.length>0&&this._invoke(this._neg,t),this._invoke(this._zero,t),this._pos.array.length>0&&this._invoke(this._pos,t)}}function sP(t,e,i){const n=`var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];${t}}`,s=e?Function("it","dt",n):Function("it",n);return function(t,e,i){return(n,s)=>{try{e(n,s)}catch(e){l._throw(e);const r=n.array;for(i&&(r[n.i]._objFlags|=i),++n.i;n.i<r.length;++n.i)try{t(r[n.i],s)}catch(t){l._throw(t),i&&(r[n.i]._objFlags|=i)}}}}(Function("c","dt",t),s,i)}const rP=sP(`c.start();c._objFlags|=${JE}`,!1,JE),oP=sP("c.update(dt)",!0),aP=sP("c.lateUpdate(dt)",!0),cP=t=>{const e=l.director._compScheduler,i=t.array;for(t.i=0;t.i<i.length;++t.i){const n=i[t.i];n._enabled&&(n.onEnable(),!n.node._activeInHierarchy||e._onEnabled(n))}};class lP{constructor(){this._deferredComps=[],this.unscheduleAll()}unscheduleAll(){this.startInvoker=new iP(rP),this.updateInvoker=new nP(oP),this.lateUpdateInvoker=new nP(aP),this._updating=!1}_onEnabled(t){l.director.getScheduler().resumeTarget(t),t._objFlags|=$E,this._updating?this._deferredComps.push(t):this._scheduleImmediate(t)}_onDisabled(t){l.director.getScheduler().pauseTarget(t),t._objFlags&=~$E;const e=this._deferredComps.indexOf(t);e>=0?KE(this._deferredComps,e):(!t.start||t._objFlags&JE||this.startInvoker.remove(t),t.update&&this.updateInvoker.remove(t),t.lateUpdate&&this.lateUpdateInvoker.remove(t))}enableComp(t,e){if(!(t._objFlags&$E)){if(t.onEnable){if(e)return void e.add(t);if(t.onEnable(),!t.node._activeInHierarchy)return}this._onEnabled(t)}}disableComp(t){t._objFlags&$E&&(t.onDisable&&t.onDisable(),this._onDisabled(t))}startPhase(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}updatePhase(t){this.updateInvoker.invoke(t)}lateUpdatePhase(t){this.lateUpdateInvoker.invoke(t),this._updating=!1,this._startForNewComps()}_startForNewComps(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}_scheduleImmediate(t){"function"!=typeof t.start||t._objFlags&JE||this.startInvoker.add(t),"function"==typeof t.update&&this.updateInvoker.add(t),"function"==typeof t.lateUpdate&&this.lateUpdateInvoker.add(t)}_deferredSchedule(){const t=this._deferredComps;for(let e=0,i=t.length;e<i;e++)this._scheduleImmediate(t[e]);t.length=0}}const hP=il.Flags.IsPreloadStarted,_P=il.Flags.IsOnLoadStarted,uP=il.Flags.IsOnLoadCalled,dP=il.Flags.Deactivating;class mP extends tP{add(t){this._zero.array.push(t)}remove(t){this._zero.fastRemove(t)}cancelInactive(t){tP.stableRemoveInactive(this._zero,t)}invoke(){this._invoke(this._zero),this._zero.array.length=0}}const pP=sP("c.__preload();"),fP=sP(`c.onLoad();c._objFlags|=${uP}`,!1,uP),gP=new Vt(4);function vP(t,e,i){D(3817,t.name,i),console.log("Corrupted component value:",e),e?t._removeComponent(e):Gt.removeAt(t._components,i)}gP.get=function(){const t=this._get()||{preload:new mP(pP),onLoad:new iP(fP),onEnable:new iP(cP)};t.preload._zero.i=-1;let e=t.onLoad;return e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,e=t.onEnable,e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,t};class yP{constructor(){this.resetComp=void 0,this.reset()}reset(){this._activatingStack=[]}activateNode(t,e){if(e){const e=gP.get();this._activatingStack.push(e),this._activateNodeRecursively(t,e.preload,e.onLoad,e.onEnable),e.preload.invoke(),e.onLoad.invoke(),e.onEnable.invoke(),this._activatingStack.pop(),gP.put(e)}else{this._deactivateNodeRecursively(t);const e=this._activatingStack;for(const t of e)t.preload.cancelInactive(hP),t.onLoad.cancelInactive(_P),t.onEnable.cancelInactive()}t.emit(fx.ACTIVE_IN_HIERARCHY_CHANGED,t)}activateComp(t,e,i,n){if(sl(t,!0)&&(t._objFlags&hP||(t._objFlags|=hP,t.__preload&&(e?e.add(t):t.__preload())),t._objFlags&_P||(t._objFlags|=_P,t.onLoad?i?i.add(t):(t.onLoad(),t._objFlags|=uP):t._objFlags|=uP),t._enabled)){if(!t.node._activeInHierarchy)return;l.director._compScheduler.enableComp(t,n)}}destroyComp(t){l.director._compScheduler.disableComp(t),t.onDestroy&&t._objFlags&uP&&t.onDestroy()}_activateNodeRecursively(t,e,i,n){if(t._objFlags&dP)return void D(3816,t.name);t._activeInHierarchy=!0;let s=t._components.length;for(let r=0;r<s;++r){const o=t._components[r];o instanceof l.Component?this.activateComp(o,e,i,n):(vP(t,o,r),--r,--s)}for(let s=0,r=t._children.length;s<r;++s){const r=t._children[s];r._active&&this._activateNodeRecursively(r,e,i,n)}t._onPostActivated(!0)}_deactivateNodeRecursively(t){t._objFlags|=dP,t._activeInHierarchy=!1;const e=t._components.length;for(let i=0;i<e;++i){const e=t._components[i];if(e._enabled&&(l.director._compScheduler.disableComp(e),t._activeInHierarchy))return void(t._objFlags&=~dP)}for(let e=0,i=t._children.length;e<i;++e){const i=t._children[e];if(i._activeInHierarchy&&(this._deactivateNodeRecursively(i),t._activeInHierarchy))return void(t._objFlags&=~dP)}t._onPostActivated(!1),t._objFlags&=~dP}}var xP,SP,CP;t("NodeActivator",yP);let AP=t("SceneAsset",dc("cc.SceneAsset")((CP=sc((SP=class extends fh{constructor(...t){super(...t),nc(this,"scene",CP,this)}initDefault(t){super.initDefault(t),this.scene=new XE("New Scene")}validate(){return!!this.scene}}).prototype,"scene",[Mc,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xP=SP))||xP);var bP,TP,EP;l.SceneAsset=AP;let PP=t("TextAsset",dc("cc.TextAsset")((EP=sc((TP=class extends fh{constructor(...t){super(...t),nc(this,"text",EP,this)}toString(){return this.text}}).prototype,"text",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bP=TP))||bP);var wP,IP,RP;l.TextAsset=PP;let DP,MP=t("JsonAsset",dc("cc.JsonAsset")((RP=sc((IP=class extends fh{constructor(...t){super(...t),nc(this,"json",RP,this)}}).prototype,"json",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wP=IP))||wP);l.JsonAsset=MP;class OP{_init(){this._nativeObj=new Pa,this._nativeObj.fog=this.fog.native,this._nativeObj.ambient=this.ambient.native,this._nativeObj.skybox=this.skybox.native,this._nativeObj.shadow=this.shadows.native,this._nativeObj.octree=this.octree.native}get native(){return this._nativeObj}get isHDR(){return this._isHDR}set isHDR(t){this._isHDR=t,this._nativeObj.isHDR=t}get shadingScale(){return this._shadingScale}set shadingScale(t){this._shadingScale!==t&&(this._shadingScale=t,this._nativeObj.shadingScale=t,this._pipeline.emit(Fy.ATTACHMENT_SCALE_CAHNGED,t))}constructor(){this.fog=new Sv,this.ambient=new _v,this.skybox=new gv,this.shadows=new vg,this.octree=new Cv,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._geometryRendererMaterials=[],this._geometryRendererPasses=[],this._geometryRendererShaders=[],this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}activate(t,e){return this._device=t,this._pipeline=e,this.initGeometryRendererMaterials(),this.initOcclusionQuery(),!0}initGeometryRendererMaterials(){let t=0;for(let e=0;e<6;e++){this._geometryRendererMaterials[e]=new sg,this._geometryRendererMaterials[e]._uuid=`geometry-renderer-material-${e}`,this._geometryRendererMaterials[e].initialize({effectName:"geometry-renderer",technique:e});for(let i=0;i<this._geometryRendererMaterials[e].passes.length;++i)this._geometryRendererPasses[t]=this._geometryRendererMaterials[e].passes[i],this._geometryRendererShaders[t]=this._geometryRendererMaterials[e].passes[i].getShaderVariant(),t++}{const t=[],e=[];for(let i=0;i<this._geometryRendererPasses.length;++i)t.push(this._geometryRendererPasses[i].native),e.push(this._geometryRendererShaders[i]);this._nativeObj.geometryRendererPasses=t,this._nativeObj.geometryRendererShaders=e}}get geometryRendererPasses(){return this._geometryRendererPasses}get geometryRendererShaders(){return this._geometryRendererShaders}initOcclusionQuery(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA(),this._nativeObj.occlusionQueryInputAssembler=this._occlusionQueryInputAssembler),!this._occlusionQueryMaterial){const t=new sg;t._uuid="default-occlusion-query-material",t.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=t,this._occlusionQueryShader=t.passes[0].getShaderVariant(),this._nativeObj.occlusionQueryPass=this._occlusionQueryMaterial.passes[0].native,this._nativeObj.occlusionQueryShader=this._occlusionQueryShader}}getOcclusionQueryPass(){return this._occlusionQueryMaterial.passes[0]}onGlobalPipelineStateChanged(){}destroy(){var t,e,i;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(t=this._occlusionQueryInputAssembler)||void 0===t||t.destroy(),this._occlusionQueryInputAssembler=null,null===(e=this._occlusionQueryVertexBuffer)||void 0===e||e.destroy(),this._occlusionQueryVertexBuffer=null,null===(i=this._occlusionQueryIndicesBuffer)||void 0===i||i.destroy(),this._occlusionQueryIndicesBuffer=null,this._nativeObj=null}_createOcclusionQueryIA(){const t=this._device,e=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),i=3*Float32Array.BYTES_PER_ELEMENT,n=8*i;this._occlusionQueryVertexBuffer=t.createBuffer(new Zn(en.VERTEX|en.TRANSFER_DST,rn.DEVICE,n,i)),this._occlusionQueryVertexBuffer.update(e);const s=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),r=Uint16Array.BYTES_PER_ELEMENT,o=36*r;this._occlusionQueryIndicesBuffer=t.createBuffer(new Zn(en.INDEX|en.TRANSFER_DST,rn.DEVICE,o,r)),this._occlusionQueryIndicesBuffer.update(s);const a=[new fs("a_position",Zi.RGB32F)],c=new vs(a,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return t.createInputAssembler(c)}}!function(t){t[t.NONE=0]="NONE",t[t.FXAA=1]="FXAA"}(DP||(DP={}));class BP extends OP{constructor(...t){super(...t),this._antiAliasing=DP.NONE}set antiAliasing(t){if(this._antiAliasing=t,this._postprocessMaterial){const e=this._postprocessMaterial.passes[0].defines;Object.assign(e,{ANTIALIAS_TYPE:t});const i=new sg;i.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:e});for(let t=0;t<i.passes.length;++t)i.passes[t].tryCompile();this._postprocessMaterial=i}}get antiAliasing(){return this._antiAliasing}get bloomMaterial(){return this._bloomMaterial}set bloomMaterial(t){this._bloomMaterial!==t&&t&&(this._bloomMaterial=t,this.updatePipelinePassInfo())}get postprocessMaterial(){return this._postprocessMaterial}set postprocessMaterial(t){this._postprocessMaterial!==t&&t&&(this._postprocessMaterial=t,this.updatePipelinePassInfo())}onGlobalPipelineStateChanged(){this.updatePipelinePassInfo()}updateBloomPass(){if(!this._bloomMaterial)return;const t=this._bloomMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently();const e=[],i=[];for(let t=0;t<6;++t){const n=this._bloomMaterial.passes[1+t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently();const s=this._bloomMaterial.passes[7+t];s.beginChangeStatesSilently(),s.tryCompile(),s.endChangeStatesSilently(),e.push(n.native),i.push(s.native)}const n=this._bloomMaterial.passes[13];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently(),this._nativeObj.bloomPrefilterPassShader=t.getShaderVariant(),this._nativeObj.bloomPrefilterPass=t.native,this._nativeObj.bloomDownsamplePassShader=this._bloomMaterial.passes[1].getShaderVariant(),this._nativeObj.bloomDownsamplePass=e,this._nativeObj.bloomUpsamplePassShader=this._bloomMaterial.passes[7].getShaderVariant(),this._nativeObj.bloomUpsamplePass=i,this._nativeObj.bloomCombinePassShader=n.getShaderVariant(),this._nativeObj.bloomCombinePass=n.native}updatePostProcessPass(){if(!this.postprocessMaterial)return;const t=this.postprocessMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently(),this._nativeObj.pipelinePostPassShader=t.getShaderVariant(),this._nativeObj.pipelinePostPass=t.native}initPipelinePassInfo(){const t=new sg;t._uuid="builtin-deferred-material",t.initialize({effectName:"deferred-lighting"});for(let e=0;e<t.passes.length;++e)t.passes[e].tryCompile();this._deferredLightingMaterial=t;const e=new sg;e._uuid="builtin-bloom-material",e.initialize({effectName:"bloom"});for(let t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._bloomMaterial=e;const i=new sg;i._uuid="builtin-post-process-material",Kt.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=DP.FXAA),i.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(let t=0;t<i.passes.length;++t)i.passes[t].tryCompile();this._postprocessMaterial=i,this.updatePipelinePassInfo()}get deferredLightingMaterial(){return this._deferredLightingMaterial}set deferredLightingMaterial(t){this._deferredLightingMaterial!==t&&t&&(this._deferredLightingMaterial=t,this.updatePipelinePassInfo())}updatePipelinePassInfo(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()}activate(t,e){return super.activate(t,e),this.initPipelinePassInfo(),!0}updateDeferredPassInfo(){this.updateDeferredLightPass()}updateDeferredLightPass(){if(!this._deferredLightingMaterial)return;this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);const t=this._deferredLightingMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently(),this._nativeObj.deferredLightPassShader=t.getShaderVariant(),this._nativeObj.deferredLightPass=t.native}}nr.getPhaseID=Of;const NP=t("RenderPipeline",nr.RenderPipeline),LP=(t("RenderFlow",nr.RenderFlow),t("RenderStage",nr.RenderStage),t("InstancedBuffer",nr.InstancedBuffer),t("PipelineStateManager",nr.PipelineStateManager));nr.InstancedBuffer.get;let FP=nr.PipelineStateManager.getOrCreatePipelineState;function zP(){const t=new VP;return t.init(),t}nr.PipelineStateManager.getOrCreatePipelineState=function(t,e,i,n,s){return FP.call(t,e.native,i,n,s)};class VP extends nr.ForwardPipeline{constructor(){super(),this.pipelineSceneData=new OP,this.geometryRenderer=new cy,this._tag=0,this._flows=[],this.renderTextures=[],this.materials=[]}on(t,e,i,n){}once(t,e,i){}off(t,e,i){}emit(t,e,i,n,s,r){}targetOff(t){}removeAll(t){}hasEventListener(t,e,i){return!1}init(){this.setPipelineSharedSceneData(this.pipelineSceneData.native),this.setGeometryRenderer(this.geometryRenderer.native);for(let t=0;t<this._flows.length;t++)this._flows[t].init(this);const t=new nr.RenderPipelineInfo(this._tag,this._flows);this.initialize(t)}activate(t){return this.geometryRenderer.activate(l.director.root.device,this),super.activate(t)&&this.pipelineSceneData.activate(l.director.root.device,this)}render(t){this.geometryRenderer.flush();let e=[];for(let i=0,n=t.length;i<n;++i)e.push(t[i].native);super.render(e)}set profiler(t){this.setProfiler(t&&t.native)}destroy(){this.pipelineSceneData.destroy(),this.geometryRenderer.destroy(),super.destroy()}}t("ForwardPipeline",VP),Ct(VP.prototype,fh.prototype);const GP=VP.prototype.onLoaded;VP.prototype.onLoaded=function(){GP&&GP.call(this),this.init()};class UP extends nr.ForwardFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(t){for(let e=0;e<this._stages.length;e++)this._stages[e].init(t);const e=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(e)}}t("ForwardFlow",UP);class kP extends nr.ShadowFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(t){for(let e=0;e<this._stages.length;e++)this._stages[e].init(t);const e=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(e)}}t("ShadowFlow",kP);class HP extends nr.ForwardStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(t){const e=[];for(let t=0;t<this.renderQueues.length;t++)e.push(this.renderQueues[t].init());const i=new nr.RenderStageInfo(this._name,this._priority,this._tag,e);this.initialize(i)}}t("ForwardStage",HP);class jP extends nr.ShadowStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0}init(t){const e=new nr.RenderStageInfo(this._name,this._priority,this._tag,[]);this.initialize(e)}}t("ShadowStage",jP);class WP{constructor(){this.isTransparent=!1,this.sortMode=0,this.stages=[],this.isTransparent=!1,this.sortMode=0,this.stages=[]}init(){return new nr.RenderQueueDesc(this.isTransparent,this.sortMode,this.stages)}}t("RenderQueueDesc",WP);class qP extends nr.DeferredPipeline{constructor(){super(),this.pipelineSceneData=new BP,this.geometryRenderer=new cy,this._tag=0,this._flows=[],this.renderTextures=[],this.materials=[]}on(t,e,i,n){}once(t,e,i){}off(t,e,i){}emit(t,e,i,n,s,r){}targetOff(t){}removeAll(t){}hasEventListener(t,e,i){return!1}init(){this.setPipelineSharedSceneData(this.pipelineSceneData.native),this.setGeometryRenderer(this.geometryRenderer.native);for(let t=0;t<this._flows.length;t++)this._flows[t].init(this);let t=new nr.RenderPipelineInfo(this._tag,this._flows);this.initialize(t)}activate(t){return this.geometryRenderer.activate(l.director.root.device,this),super.activate(t)&&this.pipelineSceneData.activate(l.director.root.device,this)}render(t){this.geometryRenderer.flush();let e=[];for(let i=0,n=t.length;i<n;++i)e.push(t[i].native);super.render(e)}set profiler(t){this.setProfiler(t&&t.native)}destroy(){this.fog.destroy(),this.ambient.destroy(),this.skybox.destroy(),this.shadows.destroy(),this.pipelineSceneData.destroy(),this.geometryRenderer.destroy(),super.destroy()}}t("DeferredPipeline",qP),Ct(qP.prototype,fh.prototype);const XP=qP.prototype.onLoaded;qP.prototype.onLoaded=function(){XP&&XP.call(this),this.init()};class YP extends nr.MainFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(t){for(let e=0;e<this._stages.length;e++)this._stages[e].init(t);let e=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(e)}}t("MainFlow",YP);class KP extends nr.GbufferStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(t){const e=[];for(let t=0;t<this.renderQueues.length;t++)e.push(this.renderQueues[t].init());let i=new nr.RenderStageInfo(this._name,this._priority,this._tag,e);this.initialize(i)}}t("GbufferStage",KP);class JP extends nr.LightingStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[],this._deferredMaterial=null}init(t){const e=[];for(let t=0;t<this.renderQueues.length;t++)e.push(this.renderQueues[t].init());t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial;let i=new nr.RenderStageInfo(this._name,this._priority,this._tag,e);this.initialize(i)}}t("LightingStage",JP);class $P extends nr.BloomStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[],this._bloomMaterial=null}init(t){const e=[];for(let t=0;t<this.renderQueues.length;t++)e.push(this.renderQueues[t].init());t.pipelineSceneData.bloomMaterial=this._bloomMaterial;let i=new nr.RenderStageInfo(this._name,this._priority,this._tag,e);this.initialize(i)}}t("BloomStage",$P);class ZP extends nr.PostProcessStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[],this._postProcessMaterial=null}init(t){const e=[];for(let t=0;t<this.renderQueues.length;t++)e.push(this.renderQueues[t].init());t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial;let i=new nr.RenderStageInfo(this._name,this._priority,this._tag,e);this.initialize(i)}}t("PostProcessStage",ZP),Ot("DeferredPipeline",qP),Ot("MainFlow",YP),Ot("GbufferStage",KP),Ot("LightingStage",JP),Ot("BloomStage",$P),Ot("PostProcessStage",ZP),Ot("ForwardPipeline",VP),Ot("ForwardFlow",UP),Ot("ShadowFlow",kP),Ot("ForwardStage",HP),Ot("ShadowStage",jP),Ot("RenderQueueDesc",WP);const QP=new Oi;class tw{set splashFinish(t){this._splashFinish=t,this._tryToStart()}set loadFinish(t){this._loadFinish=t,this._tryToStart()}pauseRendering(){this.isPause=!0}resumeRendering(){this.isPause=!1}main(t){if(null!=t){if(window._CCSettings&&window._CCSettings.splashScreen){const t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new Yn(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new Yn(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{l.view.resizeWithBrowserSize(!0);const e=window._CCSettings.designResolution;e?l.view.setDesignResolutionSize(e.width,e.height,e.policy):l.view.setDesignResolutionSize(960,640,4),this.device=t.device,this.swapchain=t.mainWindow.swapchain,this.framebuffer=t.mainWindow.framebuffer,l.game.once(l.Game.EVENT_GAME_INITED,(()=>{l.director._lateUpdate=performance.now()}),l.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else x("RENDER ROOT IS NULL.")}setOnFinish(t){if(this._directCall&&t)return tw._ins=void 0,void t();this.callBack=t}_tryToStart(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),l.game.resume())}preInit(){const t=this.settings.clearColor;this.clearColors=[new Yn(t.x,t.y,t.z,t.w)];const{device:e,swapchain:i}=this;this.renderArea=new Gn(0,0,i.width,i.height),this.cmdBuff=e.commandBuffer;const n=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),s=4*Float32Array.BYTES_PER_ELEMENT,r=4*s;this.vertexBuffers=e.createBuffer(new Zn(en.VERTEX|en.TRANSFER_DST,rn.DEVICE,r,s)),this.vertexBuffers.update(n);const o=new Uint16Array([0,1,2,1,3,2]),a=Uint16Array.BYTES_PER_ELEMENT,c=6*a;this.indicesBuffers=e.createBuffer(new Zn(en.INDEX|en.TRANSFER_DST,rn.DEVICE,c,a)),this.indicesBuffers.update(o);const l=[new fs("a_position",Zi.RG32F),new fs("a_texCoord",Zi.RG32F)],h=new vs(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=e.createInputAssembler(h),this.projection=new Ii,Ii.ortho(this.projection,-1,1,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,i.surfaceTransform)}init(){this.initLogo(),this.settings.displayWatermark&&this.initWarterMark();const t=e=>{if(this.cancelAnimate)return;const i=this.settings,{device:n,swapchain:s}=this;Ii.ortho(this.projection,-1,1,-1,1,-1,1,n.capabilities.clipSpaceMinZ,n.capabilities.clipSpaceSignY,s.surfaceTransform);const r=s.width,o=s.height,a=r<o?r:o;this.startTime<0&&(this.startTime=e);const c=e-this.startTime;let l=K_(qe(c/i.totalTime));"NONE"===i.effect&&(l=1);const h=this.logoTexture.width,_=this.logoTexture.height,u=a*i.displayRatio;let d=u*h/_,m=u;if(s.surfaceTransform!==Ji.ROTATE_90&&s.surfaceTransform!==Ji.ROTATE_270||(d=u*r/o,m=u*_/h*o/r),this.logoMat.setProperty("resolution",QP.set(r,o),0),this.logoMat.setProperty("scale",QP.set(d,m),0),this.logoMat.setProperty("translate",QP.set(.5*r,.5*o),0),this.logoMat.setProperty("percent",l),this.logoMat.setProperty("u_projection",this.projection),this.logoMat.passes[0].update(),i.displayWatermark&&this.watermarkMat){const t=.5*a,e=this.watermarkTexture.width;let i=t,n=t*this.watermarkTexture.height/e;s.surfaceTransform!==Ji.ROTATE_90&&s.surfaceTransform!==Ji.ROTATE_270||(i=.5*t,n=t*r/o*.5),this.watermarkMat.setProperty("resolution",QP.set(r,o),0),this.watermarkMat.setProperty("scale",QP.set(i,n),0),this.watermarkMat.setProperty("translate",QP.set(.5*r,.1*o),0),this.watermarkMat.setProperty("percent",l),this.watermarkMat.setProperty("u_projection",this.projection),this.watermarkMat.passes[0].update()}this.isPause||(this.frame(),c>i.totalTime&&(this.splashFinish=!0)),requestAnimationFrame(t)};l.game.pause(),this.handle=requestAnimationFrame(t)}hide(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))}initLogo(){const t=this.device;this.logoMat=new sg,this.logoMat.initialize({effectName:"splash-screen"});const e=new os;e.addressU=dn.CLAMP,e.addressV=dn.CLAMP,e.addressW=dn.CLAMP,this.sampler=t.getSampler(e),this.logoTexture=t.createTexture(new ss(on.TEX2D,an.SAMPLED|an.TRANSFER_DST,Zi.RGBA8,this.logoImage.width,this.logoImage.height));const i=this.logoMat.passes[0],n=i.getBinding("mainTexture");i.bindTexture(n,this.logoTexture),this.shader=i.getShaderVariant();const s=i.descriptorSet;s.bindSampler(n,this.sampler),s.update();const r=new qn;r.texExtent.width=this.logoImage.width,r.texExtent.height=this.logoImage.height,r.texExtent.depth=1,t.copyTexImagesToTexture([this.logoImage],this.logoTexture,[r])}initWarterMark(){const t=document.createElement("canvas");t.width=330,t.height=30,t.style.width=`${t.width}`,t.style.height=`${t.height}`;const e=t.getContext("2d");e.font="18px Arial",e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`";const i="Powered by Cocos Creator",n=e.measureText(i);e.fillText(i,(330-n.width)/2,6);const s=new qn;s.texExtent.width=t.width,s.texExtent.height=t.height,s.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new ss(on.TEX2D,an.SAMPLED|an.TRANSFER_DST,Zi.RGBA8,t.width,t.height)),this.device.copyTexImagesToTexture([t],this.watermarkTexture,[s]),this.watermarkMat=new sg,this.watermarkMat.initialize({effectName:"splash-screen"});const r=this.watermarkMat.passes[0],o=r.getBinding("mainTexture");r.bindTexture(o,this.watermarkTexture),r.descriptorSet.update()}frame(){const{device:t,swapchain:e}=this;t.acquire([e]);const i=this.cmdBuff,n=this.framebuffer,s=this.renderArea;s.width=e.width,s.height=e.height,i.begin(),i.beginRenderPass(n.renderPass,n,s,this.clearColors,1,0);const r=this.logoMat.passes[0],o=LP.getOrCreatePipelineState(t,r,this.shader,n.renderPass,this.quadAssmebler);if(i.bindPipelineState(o),i.bindDescriptorSet(om.MATERIAL,r.descriptorSet),i.bindInputAssembler(this.quadAssmebler),i.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){const e=this.watermarkMat.passes[0],s=LP.getOrCreatePipelineState(t,e,this.shader,n.renderPass,this.quadAssmebler);i.bindPipelineState(s),i.bindDescriptorSet(om.MATERIAL,e.descriptorSet),i.bindInputAssembler(this.quadAssmebler),i.draw(this.quadAssmebler)}i.endRenderPass(),i.end(),t.flushCommands([i]),t.queue.submit([i]),t.present()}destroy(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,tw._ins=void 0}static get instance(){return tw._ins||(tw._ins=new tw),tw._ins}constructor(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}}tw._ins=void 0,l.internal.SplashScreen=tw;class ew{constructor(){this._id="",this._priority=0,this._executeInEditMode=!1}set priority(t){this._priority=t}get priority(){return this._priority}set id(t){this._id=t}get id(){return this._id}static sortByPriority(t,e){return t._priority<e._priority?1:t._priority>e.priority?-1:0}init(){}update(t){}postUpdate(t){}}t("System",ew),ew.Priority=jt({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});const iw=new et("Scheduler");class nw{constructor(t,e,i,n){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=e,this.paused=i,this.markedForDeletion=n}}nw.get=(t,e,i,n)=>{let s=nw._listEntries.pop();return s?(s.target=t,s.priority=e,s.paused=i,s.markedForDeletion=n):s=new nw(t,e,i,n),s},nw.put=t=>{nw._listEntries.length<20&&(t.target=null,nw._listEntries.push(t))},nw._listEntries=[];class sw{constructor(t,e,i,n){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=e,this.target=i,this.callback=n}}sw.get=(t,e,i,n)=>{let s=sw._hashUpdateEntries.pop();return s?(s.list=t,s.entry=e,s.target=i,s.callback=n):s=new sw(t,e,i,n),s},sw.put=t=>{sw._hashUpdateEntries.length<20&&(t.list=t.entry=t.target=t.callback=null,sw._hashUpdateEntries.push(t))},sw._hashUpdateEntries=[];class rw{constructor(t,e,i,n,s,r){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=e,this.timerIndex=i,this.currentTimer=n,this.currentTimerSalvaged=s,this.paused=r}}rw.get=(t,e,i,n,s,r)=>{let o=rw._hashTimerEntries.pop();return o?(o.timers=t,o.target=e,o.timerIndex=i,o.currentTimer=n,o.currentTimerSalvaged=s,o.paused=r):o=new rw(t,e,i,n,s,r),o},rw.put=t=>{rw._hashTimerEntries.length<20&&(t.timers=t.target=t.currentTimer=null,rw._hashTimerEntries.push(t))},rw._hashTimerEntries=[];class ow{constructor(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}initWithCallback(t,e,i,n,s,r){return this._lock=!1,this._scheduler=t,this._target=i,this._callback=e,this._elapsed=-1,this._interval=n,this._delay=r,this._useDelay=this._delay>0,this._repeat=s,this._runForever=this._repeat===l.macro.REPEAT_FOREVER,!0}getInterval(){return this._interval}setInterval(t){this._interval=t}update(t){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=t,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}getCallback(){return this._callback}trigger(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}cancel(){this._scheduler.unschedule(this._callback,this._target)}}ow._timers=[],ow.get=()=>ow._timers.pop()||new ow,ow.put=t=>{ow._timers.length<20&&!t._lock&&(t._scheduler=t._target=t._callback=null,ow._timers.push(t))};class aw extends ew{static enableForTarget(t){let e=!1;(t.uuid||t.id)&&(e=!0),e||(t.__instanceId?I(1513):t.id=iw.getNewId())}constructor(){super(),this._timeScale=void 0,this._updatesNegList=void 0,this._updates0List=void 0,this._updatesPosList=void 0,this._hashForUpdates=void 0,this._hashForTimers=void 0,this._currentTarget=void 0,this._currentTargetSalvaged=void 0,this._updateHashLocked=void 0,this._arrayForTimers=void 0,this._timeScale=1,this._updatesNegList=[],this._updates0List=[],this._updatesPosList=[],this._hashForUpdates=ut(!0),this._hashForTimers=ut(!0),this._currentTarget=null,this._currentTargetSalvaged=!1,this._updateHashLocked=!1,this._arrayForTimers=[]}setTimeScale(t){this._timeScale=t}getTimeScale(){return this._timeScale}update(t){let e,i,n,s,r;for(this._updateHashLocked=!0,1!==this._timeScale&&(t*=this._timeScale),e=0,i=this._updatesNegList,n=i.length;e<n;e++)s=i[e],s.paused||s.markedForDeletion||s.target.update(t);for(e=0,i=this._updates0List,n=i.length;e<n;e++)s=i[e],s.paused||s.markedForDeletion||s.target.update(t);for(e=0,i=this._updatesPosList,n=i.length;e<n;e++)s=i[e],s.paused||s.markedForDeletion||s.target.update(t);const o=this._arrayForTimers;for(e=0;e<o.length;e++){if(r=o[e],this._currentTarget=r,this._currentTargetSalvaged=!1,!r.paused)for(r.timerIndex=0;r.timerIndex<r.timers.length;++r.timerIndex)r.currentTimer=r.timers[r.timerIndex],r.currentTimerSalvaged=!1,r.currentTimer.update(t),r.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--e)}for(e=0,i=this._updatesNegList;e<i.length;)s=i[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;for(e=0,i=this._updates0List;e<i.length;)s=i[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;for(e=0,i=this._updatesPosList;e<i.length;)s=i[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;this._updateHashLocked=!1,this._currentTarget=null}schedule(t,e,i,n,s,r){if("function"!=typeof t){const i=t;t=e,e=i}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(r=!!n,n=l.macro.REPEAT_FOREVER,s=0),O(e,1502);const o=e.uuid||e.id;if(!o)return void D(1510);let a,c,h=this._hashForTimers[o];if(h?h.paused!==r&&I(1511):(h=rw.get(null,e,0,null,null,r),this._arrayForTimers.push(h),this._hashForTimers[o]=h),null==h.timers)h.timers=[];else for(c=0;c<h.timers.length;++c)if(a=h.timers[c],a&&t===a._callback)return P(1507,a.getInterval(),i),void(a._interval=i);a=ow.get(),a.initWithCallback(this,t,e,i,n,s),h.timers.push(a),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}scheduleUpdate(t,e,i){const n=t.uuid||t.id;if(!n)return void D(1510);const s=this._hashForUpdates[n];if(s&&s.entry){if(s.entry.priority===e)return s.entry.markedForDeletion=!1,void(s.entry.paused=i);if(this._updateHashLocked)return P(1506),s.entry.markedForDeletion=!1,void(s.entry.paused=i);this.unscheduleUpdate(t)}const r=nw.get(t,e,i,!1);let o;0===e?(o=this._updates0List,this._appendIn(o,r)):(o=e<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,r,e)),this._hashForUpdates[n]=sw.get(o,r,t,null)}unschedule(t,e){if(!e||!t)return;const i=e.uuid||e.id;if(!i)return void D(1510);const n=this._hashForTimers[i];if(n){const e=n.timers;for(let i=0,s=e.length;i<s;i++){const s=e[i];if(t===s._callback)return s!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),e.splice(i,1),ow.put(s),n.timerIndex>=i&&n.timerIndex--,void(0===e.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}}unscheduleUpdate(t){if(!t)return;const e=t.uuid||t.id;if(!e)return void D(1510);const i=this._hashForUpdates[e];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}unscheduleAllForTarget(t){if(!t)return;const e=t.uuid||t.id;if(!e)return void D(1510);const i=this._hashForTimers[e];if(i){const t=i.timers;t.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(let e=0,i=t.length;e<i;e++)ow.put(t[e]);t.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(t)}unscheduleAll(){this.unscheduleAllWithMinPriority(ew.Priority.SCHEDULER)}unscheduleAllWithMinPriority(t){let e,i;const n=this._arrayForTimers;for(e=n.length-1;e>=0;e--)i=n[e],this.unscheduleAllForTarget(i.target);let s,r=0;if(t<0)for(e=0;e<this._updatesNegList.length;)r=this._updatesNegList.length,s=this._updatesNegList[e],s&&s.priority>=t&&this.unscheduleUpdate(s.target),r===this._updatesNegList.length&&e++;if(t<=0)for(e=0;e<this._updates0List.length;)r=this._updates0List.length,s=this._updates0List[e],s&&this.unscheduleUpdate(s.target),r===this._updates0List.length&&e++;for(e=0;e<this._updatesPosList.length;)r=this._updatesPosList.length,s=this._updatesPosList[e],s&&s.priority>=t&&this.unscheduleUpdate(s.target),r===this._updatesPosList.length&&e++}isScheduled(t,e){O(t,1508),O(e,1509);const i=e.uuid||e.id;if(!i)return D(1510),!1;const n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;{const e=n.timers;for(let i=0;i<e.length;++i)if(t===e[i]._callback)return!0;return!1}}pauseAllTargets(){return this.pauseAllTargetsWithMinPriority(ew.Priority.SCHEDULER)}pauseAllTargetsWithMinPriority(t){const e=[];let i;const n=this._arrayForTimers;let s,r,o;for(s=0,r=n.length;s<r;s++)i=n[s],i&&(i.paused=!0,e.push(i.target));if(t<0)for(s=0;s<this._updatesNegList.length;s++)o=this._updatesNegList[s],o&&o.priority>=t&&(o.paused=!0,e.push(o.target));if(t<=0)for(s=0;s<this._updates0List.length;s++)o=this._updates0List[s],o&&(o.paused=!0,e.push(o.target));for(s=0;s<this._updatesPosList.length;s++)o=this._updatesPosList[s],o&&o.priority>=t&&(o.paused=!0,e.push(o.target));return e}resumeTargets(t){if(t)for(let e=0;e<t.length;e++)this.resumeTarget(t[e])}pauseTarget(t){O(t,1503);const e=t.uuid||t.id;if(!e)return void D(1510);const i=this._hashForTimers[e];i&&(i.paused=!0);const n=this._hashForUpdates[e];n&&(n.entry.paused=!0)}resumeTarget(t){O(t,1504);const e=t.uuid||t.id;if(!e)return void D(1510);const i=this._hashForTimers[e];i&&(i.paused=!1);const n=this._hashForUpdates[e];n&&(n.entry.paused=!1)}isTargetPaused(t){O(t,1505);const e=t.uuid||t.id;if(!e)return D(1510),!1;const i=this._hashForTimers[e];if(i)return i.paused;const n=this._hashForUpdates[e];return!!n&&n.entry.paused}_removeHashElement(t){const e=t.target.uuid||t.target.id;delete this._hashForTimers[e];const i=this._arrayForTimers;for(let e=0,n=i.length;e<n;e++)if(i[e]===t){i.splice(e,1);break}rw.put(t)}_removeUpdateFromHash(t){const e=t.target.uuid||t.target.id,i=this._hashForUpdates[e];if(i){const t=i.list,n=i.entry;for(let e=0,i=t.length;e<i;e++)if(t[e]===n){t.splice(e,1);break}delete this._hashForUpdates[e],nw.put(n),sw.put(i)}}_priorityIn(t,e,i){for(let n=0;n<t.length;n++)if(i<t[n].priority)return void t.splice(n,0,e);t.push(e)}_appendIn(t,e){t.push(e)}}t("Scheduler",aw),aw.ID="scheduler",l.Scheduler=aw;const cw={[Uh.PORTRAIT]:Ji.IDENTITY,[Uh.LANDSCAPE_RIGHT]:Ji.ROTATE_90,[Uh.PORTRAIT_UPSIDE_DOWN]:Ji.ROTATE_180,[Uh.LANDSCAPE_LEFT]:Ji.ROTATE_270};class lw{get width(){return this._width}get height(){return this._height}get swapchain(){return this._swapchain}get framebuffer(){return this._framebuffer}get cameras(){return this._cameras}static registerCreateFunc(t){t._createWindowFun=t=>new lw(t)}get native(){return this._nativeObj}constructor(t){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}initialize(t,e){if(this._init(),void 0!==e.title&&(this._title=e.title),void 0!==e.swapchain&&(this._swapchain=e.swapchain),this._width=e.width,this._height=e.height,this._renderPass=t.createRenderPass(e.renderPassInfo),e.swapchain)this._setSwapchain(e.swapchain),this._colorTextures.push(e.swapchain.colorTexture),this._depthStencilTexture=e.swapchain.depthStencilTexture;else{for(let i=0;i<e.renderPassInfo.colorAttachments.length;i++)this._colorTextures.push(t.createTexture(new ss(on.TEX2D,an.COLOR_ATTACHMENT|an.SAMPLED|an.TRANSFER_SRC,e.renderPassInfo.colorAttachments[i].format,this._width,this._height)));e.renderPassInfo.depthStencilAttachment.format!==Zi.UNKNOWN&&(this._depthStencilTexture=t.createTexture(new ss(on.TEX2D,an.DEPTH_STENCIL_ATTACHMENT|an.SAMPLED,e.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(t.createFramebuffer(new Es(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0}destroy(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(let t=0;t<this._colorTextures.length;t++){const e=this._colorTextures[t];e&&e.destroy()}this._colorTextures.length=0,this._destroy()}resize(t,e){if(this._swapchain)this._swapchain.resize(t,e,cw[jh.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(let i=0;i<this._colorTextures.length;i++)this._colorTextures[i].resize(t,e);this._depthStencilTexture&&this._depthStencilTexture.resize(t,e),this._width=t,this._height=e}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new Es(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(const i of this._cameras)i.resize(t,e)}extractRenderCameras(t){for(let e=0;e<this._cameras.length;e++){const i=this._cameras[e];i.enabled&&(i.update(),t.push(i))}}attachCamera(t){for(let e=0;e<this._cameras.length;e++)if(this._cameras[e]===t)return;this._cameras.push(t),this.sortCameras()}detachCamera(t){for(let e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return void this._cameras.splice(e,1)}clearCameras(){this._cameras.length=0}sortCameras(){this._cameras.sort(((t,e)=>t.priority-e.priority))}_init(){this._nativeObj=new Sa}_destroy(){this._nativeObj=null}_setSwapchain(t){this._swapchain=t,this._nativeObj.swapchain=t}_setFrameBuffer(t){this._framebuffer=t,this._nativeObj.frameBuffer=t}}class hw{get device(){return this._device}get mainWindow(){return this._mainWindow}set curWindow(t){this._curWindow=t}get curWindow(){return this._curWindow}set tempWindow(t){this._tempWindow=t}get tempWindow(){return this._tempWindow}get windows(){return this._windows}get pipeline(){return this._pipeline}get batcher2D(){return this._batcher}get scenes(){return this._scenes}get cumulativeTime(){return this._cumulativeTime}get frameTime(){return this._frameTime}get frameCount(){return this._frameCount}get fps(){return this._fps}set fixedFPS(t){t>0?(this._fixedFPS=t,this._fixedFPSFrameTime=1e3/t):this._fixedFPSFrameTime=0}get fixedFPS(){return this._fixedFPS}get dataPoolManager(){return this._dataPoolMgr}get useDeferredPipeline(){return this._useDeferredPipeline}constructor(t){this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=t,this._dataPoolMgr=l.internal.DataPoolManager&&new l.internal.DataPoolManager(t),zv.registerCreateFunc(this),lw.registerCreateFunc(this),this._cameraPool=new Ml((()=>new dg(this._device)),4,(t=>t.destroy()))}initialize(t){this._init();const e=l.game._swapchain,i=new ys;i.format=e.colorTexture.format;const n=new xs;n.format=e.depthStencilTexture.format,n.depthStoreOp=Sn.DISCARD,n.stencilStoreOp=Sn.DISCARD;const s=new As([i],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:e.width,height:e.height,renderPassInfo:s,swapchain:e}),this._curWindow=this._mainWindow,Promise.resolve(Mf.initBuiltinRes(this._device))}destroy(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()}resize(t,e){for(const i of this._windows)i.swapchain&&i.resize(t,e)}setRenderPipeline(t){t instanceof qP&&(this._useDeferredPipeline=!0);let e=!1;if(t||(t=zP(),e=!0),this._pipeline=t,this._useDeferredPipeline&&this.device.hasFeature($i.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return e&&this._pipeline.destroy(),this._pipeline=null,!1;const i=l.director.getScene();return i&&i.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&l.internal.Batcher2D&&(this._batcher=new l.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))}onGlobalPipelineStateChanged(){for(let t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()}activeWindow(t){this._curWindow=t}resetCumulativeTime(){this._setCumulativeTime(0)}frameMove(t){this._setFrameTime(t),++this._frameCount,this._setCumulativeTime(t),this._fpsTime+=t,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(let t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();const e=this._windows,i=[];for(let t=0;t<e.length;t++)e[t].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([l.game._swapchain]);const t=this._scenes,e=l.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(let i=0;i<t.length;i++)t[i].update(e);l.director.emit(l.Director.EVENT_BEFORE_COMMIT),i.sort(((t,e)=>t.priority-e.priority)),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()}createWindow(t){const e=this._createWindowFun(this);return e.initialize(this.device,t),this._windows.push(e),e}destroyWindow(t){for(let e=0;e<this._windows.length;++e)if(this._windows[e]===t)return t.destroy(),void this._windows.splice(e,1)}destroyWindows(){for(const t of this._windows)t.destroy();this._windows.length=0}createScene(t){const e=this._createSceneFun(this);return e.initialize(t),this._scenes.push(e),e}destroyScene(t){for(let e=0;e<this._scenes.length;++e)if(this._scenes[e]===t)return t.destroy(),void this._scenes.splice(e,1)}destroyScenes(){for(const t of this._scenes)t.destroy();this._scenes.length=0}createModel(t){let e=this._modelPools.get(t);e||(this._modelPools.set(t,new Ml((()=>new t),10,(t=>t.destroy()))),e=this._modelPools.get(t));const i=e.alloc();return i.initialize(),i}destroyModel(t){const e=this._modelPools.get(t.constructor);e?(e.free(t),t.scene&&t.scene.removeModel(t)):I(1300,t.constructor.name),t.destroy()}createCamera(){return this._cameraPool.alloc()}createLight(t){let e=this._lightPools.get(t);e||(this._lightPools.set(t,new Ml((()=>new t),4,(t=>t.destroy()))),e=this._lightPools.get(t));const i=e.alloc();return i.initialize(),i}destroyLight(t){const e=this._lightPools.get(t.constructor);if(e&&(e.free(t),t.scene))switch(t.type){case Tv.SPHERE:t.scene.removeSphereLight(t);break;case Tv.SPOT:t.scene.removeSpotLight(t)}t.destroy()}_init(){this._naitveObj=new Ea}_destroy(){this._naitveObj=null}_setCumulativeTime(t){this._cumulativeTime+=t,this._naitveObj.cumulativeTime=this._cumulativeTime}_setFrameTime(t){this._frameTime=t,this._naitveObj.frameTime=t}}t("Root",hw),l.Root=hw;class _w extends Hl{constructor(...t){super(...t),this.frame=null,this.container=null,this.canvas=null,this.renderType=-1,this.eventTargetOn=super.on,this.eventTargetOnce=super.once,this.config={},this.onStart=null,this.frameTime=1e3/60,this.collisionMatrix=[],this.groupList=[],this._persistRootNodes={},this._gfxDevice=null,this._swapchain=null,this._configLoaded=!1,this._isCloning=!1,this._inited=!1,this._engineInited=!1,this._rendererInitialized=!1,this._paused=!0,this._frameRate=60,this._intervalId=0,this._initTime=0,this._startTime=0,this._deltaTime=0,this._onEngineInitedCallback=[]}get inited(){return this._inited}get frameRate(){return this._frameRate}set frameRate(t){"number"!=typeof t&&(t=parseInt(t,10),Number.isNaN(t)&&(t=60)),this._frameRate=t,this.frameTime=1e3/t,this._setAnimFrame()}get deltaTime(){return this._deltaTime}get totalTime(){return performance.now()-this._initTime}get frameStartTime(){return this._startTime}setFrameRate(t){this.frameRate=t}getFrameRate(){return this.frameRate}step(){l.director.tick(this.frameTime/1e3)}pause(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))}resume(){this._paused&&(LE._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))}isPaused(){return this._paused}restart(){return new Promise((t=>l.director.once(l.Director.EVENT_END_FRAME,(()=>t())))).then((()=>{for(const t in this._persistRootNodes)this.removePersistRootNode(this._persistRootNodes[t]);return l.director.getScene().destroy(),l.Object._deferredDestroy(),l.director.reset(),l.profiler.reset(),this.pause(),this._setRenderPipelineNShowSplash().then((()=>{this.resume(),this._safeEmit(_w.EVENT_RESTART)}))}))}end(){Zl.close()}on(t,e,i,n){return(this._engineInited&&t===_w.EVENT_ENGINE_INITED||this._inited&&t===_w.EVENT_GAME_INITED||this._rendererInitialized&&t===_w.EVENT_RENDERER_INITED)&&e.call(i),this.eventTargetOn(t,e,i,n)}once(t,e,i){return this._engineInited&&t===_w.EVENT_ENGINE_INITED?e.call(i):this.eventTargetOnce(t,e,i)}init(t){if(this._initConfig(t),this.config.assetOptions&&l.assetManager.init(this.config.assetOptions),this.config.layers){const t=this.config.layers;for(let e=0;e<t.length;e++){const n=t[e],s=i(n.value);Yd.addLayer(n.name,s)}}return this._initEngine().then((()=>(this._initEvents(),l.director.root&&l.director.root.dataPoolManager&&l.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(t.customJointTextureLayouts),this._engineInited)))}run(t,e){let i;return"function"!=typeof t&&t?(i=this.init(t),this.onStart=null!=e?e:null):this.onStart=null!=t?t:null,Wi.init(),Promise.resolve(i).then((()=>this._setRenderPipelineNShowSplash())).then((()=>{Wh._init({configOrientation:"auto",exactFitScreen:!0})}))}addPersistRootNode(t){if(!l.Node.isNode(t)||!t.uuid)return void I(3800);const e=t.uuid;if(!this._persistRootNodes[e]){const i=l.director._scene;if(l.isValid(i))if(t.parent){if(!(t.parent instanceof l.Scene))return void I(3801);if(t.parent!==i)return void I(3802);t._originalSceneId=i.uuid}else t.parent=i;this._persistRootNodes[e]=t,t._persistNode=!0,l.assetManager._releaseManager._addPersistNodeRef(t)}}removePersistRootNode(t){const e=t.uuid||"";t===this._persistRootNodes[e]&&(delete this._persistRootNodes[e],t._persistNode=!1,t._originalSceneId="",l.assetManager._releaseManager._removePersistNodeRef(t))}isPersistRootNode(t){return!!t._persistNode}onEngineInitedAsync(t){this._onEngineInitedCallback.push(t)}_initEngine(){this._initDevice();const t=l.director;return Promise.resolve(t._init()).then((()=>{l.view.init(),v(`Cocos Creator v${h}`),this.emit(_w.EVENT_ENGINE_INITED),this._engineInited=!0,l.internal.dynamicAtlasManager&&(l.internal.dynamicAtlasManager.enabled=!Kt.CLEANUP_IMAGE_CACHE)})).then((()=>{const t=this._onEngineInitedCallback.map((t=>t())).filter(Boolean);return this._onEngineInitedCallback.length=0,Promise.all(t)}))}_setAnimFrame(){const t=this._frameRate;jsb.setPreferredFramesPerSecond(t),window.rAF=window.requestAnimationFrame,window.cAF=window.cancelAnimationFrame}_stTime(t){const e=performance.now(),i=Math.max(0,e-this._startTime),n=Math.max(0,this.frameTime-i);return window.setTimeout(t,n)}_ctTime(t){window.clearTimeout(t)}_calculateDT(t){return t||(t=performance.now()),this._deltaTime=t>this._startTime?(t-this._startTime)/1e3:0,this._deltaTime>_w.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=t,this._deltaTime}_updateCallback(){const t=l.director;let e;e=e=>{t.tick(this._calculateDT(e)),this._intervalId=window.rAF(this._frameCB)},this._frameCB=e}_runMainLoop(){if(!this._inited)return;const t=this.config,e=l.director;F(!!t.showFPS),e.startAnimation(),this.resume()}_initConfig(t){"number"!=typeof t.debugMode&&(t.debugMode=B.NONE),t.exposeClassName=!!t.exposeClassName,"number"!=typeof t.frameRate&&(t.frameRate=60);const e=t.renderMode;("number"!=typeof e||e>3||e<0)&&(t.renderMode=0),t.showFPS=!!t.showFPS,A(t.debugMode),this.config=t,this._configLoaded=!0,this.frameRate=t.frameRate}_determineRenderType(){const t=this.config,e=parseInt(t.renderMode,10);this.renderType=_w.RENDER_TYPE_CANVAS;let i=!1;if(1===e?(this.renderType=_w.RENDER_TYPE_CANVAS,i=!0):0===e||2===e?(this.renderType=_w.RENDER_TYPE_WEBGL,i=!0):3===e&&(this.renderType=_w.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(N(3820,e))}_initDevice(){if(this._rendererInitialized)return;const t=this.config.adapter;if(t&&(this.canvas=t.canvas,this.frame=t.frame,this.container=t.container),this._determineRenderType(),this.renderType===_w.RENDER_TYPE_WEBGL){const t=new $n(am);if(window.gfx)this._gfxDevice=gfx.DeviceManager.create(t);else{let e=!!window.WebGL2RenderingContext;const i=window.navigator.userAgent.toLowerCase();(-1!==i.indexOf("safari")&&-1===i.indexOf("chrome")||qh.browserType===jl.UC)&&(e=!1);const n=[];e&&l.WebGL2Device&&n.push(l.WebGL2Device),l.WebGLDevice&&n.push(l.WebGLDevice),l.EmptyDevice&&n.push(l.EmptyDevice),ar.canvas=this.canvas;for(let e=0;e<n.length&&(this._gfxDevice=new n[e],!this._gfxDevice.initialize(t));e++);}}else this.renderType===_w.RENDER_TYPE_HEADLESS&&l.EmptyDevice&&(this._gfxDevice=new l.EmptyDevice,this._gfxDevice.initialize(new $n(am)));if(!this._gfxDevice)return x("can not support canvas rendering in 3D"),void(this.renderType=_w.RENDER_TYPE_CANVAS);const e=new Jn(this.canvas),i=Wh.windowSize;e.width=i.width,e.height=i.height,this._swapchain=this._gfxDevice.createSwapchain(e),this.canvas.oncontextmenu=()=>!1}_initEvents(){Zl.on("show",this._onShow,this),Zl.on("hide",this._onHide,this)}_onHide(){this.emit(_w.EVENT_HIDE),this.pause()}_onShow(){this.emit(_w.EVENT_SHOW),this.resume()}_setRenderPipelineNShowSplash(){return Promise.resolve(this._setupRenderPipeline()).then((()=>Promise.resolve(this._showSplashScreen()).then((()=>{this._inited=!0,this._initTime=performance.now(),this._runMainLoop(),this._safeEmit(_w.EVENT_GAME_INITED),this.onStart&&this.onStart()}))))}_setupRenderPipeline(){const{renderPipeline:t}=this.config;return t?new Promise(((e,i)=>{l.assetManager.loadAny(t,((t,n)=>!t&&n instanceof NP?e(n):i(t)))})).then((t=>{this._setRenderPipeline(t)})).catch((e=>{y(e),y(`Failed load render pipeline: ${t}, engine failed to initialize, will fallback to default pipeline`),this._setRenderPipeline()})):this._setRenderPipeline()}_showSplashScreen(){if(l.internal.SplashScreen){const t=l.internal.SplashScreen.instance;return t.main(l.director.root),new Promise((e=>{t.setOnFinish((()=>e())),t.loadFinish=!0}))}return null}_setRenderPipeline(t){l.director.root.setRenderPipeline(t)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(_w.EVENT_RENDERER_INITED)}_safeEmit(t){this.emit(t)}}t("Game",_w),_w.EVENT_HIDE="game_on_hide",_w.EVENT_SHOW="game_on_show",_w.EVENT_LOW_MEMORY="game_on_low_memory",_w.EVENT_GAME_INITED="game_inited",_w.EVENT_ENGINE_INITED="engine_inited",_w.EVENT_RENDERER_INITED="renderer_inited",_w.EVENT_RESTART="game_on_restart",_w.RENDER_TYPE_CANVAS=0,_w.RENDER_TYPE_WEBGL=1,_w.RENDER_TYPE_OPENGL=2,_w.RENDER_TYPE_HEADLESS=3,_w.DEBUG_DT_THRESHOLD=1,l.Game=_w;const uw=t("game",l.game=new _w);class dw extends Hl{constructor(){super(),this._compScheduler=void 0,this._nodeActivator=void 0,this._invalid=void 0,this._paused=void 0,this._root=void 0,this._loadingScene=void 0,this._scene=void 0,this._totalFrames=void 0,this._scheduler=void 0,this._systems=void 0,this._invalid=!1,this._paused=!1,this._root=null,this._loadingScene="",this._scene=null,this._totalFrames=0,this._scheduler=new aw,this._compScheduler=new lP,this._nodeActivator=new yP,this._systems=[],uw.once(_w.EVENT_RENDERER_INITED,this._initOnRendererInitialized,this)}calculateDeltaTime(t){}end(){this.once(dw.EVENT_END_FRAME,(()=>{this.purgeDirector()}))}pause(){this._paused||(this._paused=!0)}purgeDirector(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),l.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),l.assetManager.releaseAll()}reset(){this.purgeDirector(),this.emit(dw.EVENT_RESET),this.startAnimation()}runSceneImmediate(t,e,i){t instanceof AP&&(t=t.scene),O(t instanceof XE,1216),t._load();const n=Object.keys(uw._persistRootNodes).map((t=>uw._persistRootNodes[t]));for(let e=0;e<n.length;e++){const i=n[e];i.emit(l.Node.SCENE_CHANGED_FOR_PERSISTS,t.renderScene);const s=t.uuid===i._originalSceneId&&t.getChildByUuid(i.uuid);if(s){const e=s.getSiblingIndex();s._destroyImmediate(),t.insertChild(i,e)}else i.parent=t}const s=this._scene;l.isValid(s)&&s.destroy(),l.assetManager._releaseManager._autoRelease(s,t,uw._persistRootNodes),this._scene=null,il._deferredDestroy(),e&&e(),this.emit(l.Director.EVENT_BEFORE_SCENE_LAUNCH,t),this._scene=t,t._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,t),this.emit(l.Director.EVENT_AFTER_SCENE_LAUNCH,t)}runScene(t,e,i){t instanceof AP&&(t=t.scene),O(t,1205),O(t instanceof XE,1216),t._load(),this.once(l.Director.EVENT_END_FRAME,(()=>{this.runSceneImmediate(t,e,i)}))}loadScene(t,e,i){if(this._loadingScene)return I(1208,t,this._loadingScene),!1;const n=l.assetManager.bundles.find((e=>!!e.getSceneInfo(t)));return n?(this.emit(l.Director.EVENT_BEFORE_SCENE_LOADING,t),this._loadingScene=t,console.time(`LoadScene ${t}`),n.loadScene(t,((n,s)=>{console.timeEnd(`LoadScene ${t}`),this._loadingScene="",n?(x(n),e&&e(n)):this.runSceneImmediate(s,i,e)})),!0):(D(1209,t),!1)}preloadScene(t,e,i){const n=l.assetManager.bundles.find((e=>!!e.getSceneInfo(t)));if(n)n.preloadScene(t,null,e,i);else{const e=`Can not preload the scene "${t}" because it is not in the build settings.`;i&&i(new Error(e)),x(`preloadScene: ${e}`)}}resume(){this._paused&&(this._paused=!1)}get root(){return this._root}getScene(){return this._scene}getDeltaTime(){return uw.deltaTime}getTotalTime(){return uw.totalTime}getCurrentTime(){return uw.frameStartTime}getTotalFrames(){return this._totalFrames}isPaused(){return this._paused}getScheduler(){return this._scheduler}setScheduler(t){this._scheduler!==t&&(this.unregisterSystem(this._scheduler),this._scheduler=t,this.registerSystem(aw.ID,t,200))}registerSystem(t,e,i){e.id=t,e.priority=i,e.init(),this._systems.push(e),this._systems.sort(ew.sortByPriority)}unregisterSystem(t){Gt.fastRemove(this._systems,t),this._systems.sort(ew.sortByPriority)}getSystem(t){return this._systems.find((e=>e.id===t))}getAnimationManager(){return this.getSystem(l.AnimationManager.ID)}startAnimation(){this._invalid=!1}stopAnimation(){this._invalid=!0}mainLoop(t){let e;e=uw._calculateDT(t),this.tick(e)}tick(t){if(!this._invalid){if(this.emit(dw.EVENT_BEGIN_FRAME),LE._frameDispatchEvents(),!this._paused){this.emit(dw.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(let e=0;e<this._systems.length;++e)this._systems[e].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(dw.EVENT_AFTER_UPDATE),il._deferredDestroy();for(let e=0;e<this._systems.length;++e)this._systems[e].postUpdate(t)}this.emit(dw.EVENT_BEFORE_DRAW),this._root.frameMove(t),this.emit(dw.EVENT_AFTER_DRAW),iS.resetHasChangedFlags(),iS.clearNodeArray(),Rl.update(t),this.emit(dw.EVENT_END_FRAME),this._totalFrames++}}_initOnRendererInitialized(){this._totalFrames=0,this._paused=!1,this.registerSystem(aw.ID,this._scheduler,200),this.emit(dw.EVENT_INIT)}_init(){return this._root=new hw(uw._gfxDevice),this._root.initialize({}).catch((t=>(D(1217),Promise.reject(t))))}}t("Director",dw),dw.EVENT_INIT="director_init",dw.EVENT_RESET="director_reset",dw.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",dw.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",dw.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",dw.EVENT_BEFORE_UPDATE="director_before_update",dw.EVENT_AFTER_UPDATE="director_after_update",dw.EVENT_BEFORE_DRAW="director_before_draw",dw.EVENT_AFTER_DRAW="director_after_draw",dw.EVENT_BEFORE_COMMIT="director_before_commit",dw.EVENT_BEFORE_PHYSICS="director_before_physics",dw.EVENT_AFTER_PHYSICS="director_after_physics",dw.EVENT_BEGIN_FRAME="director_begin_frame",dw.EVENT_END_FRAME="director_end_frame",dw.instance=void 0,l.Director=dw;const mw=t("director",dw.instance=l.director=new dw),pw={};V(pw,"vmath",[{name:"vec2",newName:"Vec2",target:ji,targetName:"math"},{name:"vec3",newName:"Vec3",target:ji,targetName:"math"},{name:"vec4",newName:"Vec4",target:ji,targetName:"math"},{name:"quat",newName:"Quat",target:ji,targetName:"math"},{name:"mat3",newName:"Mat3",target:ji,targetName:"math"},{name:"mat4",newName:"Mat4",target:ji,targetName:"math"},{name:"color4",newName:"Color",target:ji,targetName:"math"},{name:"rect",newName:"Rect",target:ji,targetName:"math"},{name:"approx",newName:"approx",target:ji,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:ji,targetName:"math"},{name:"equals",newName:"equals",target:ji,targetName:"math"},{name:"clamp",newName:"clamp",target:ji,targetName:"math"},{name:"clamp01",newName:"clamp01",target:ji,targetName:"math"},{name:"lerp",newName:"lerp",target:ji,targetName:"math"},{name:"toRadian",newName:"toRadian",target:ji,targetName:"math"},{name:"toDegree",newName:"toDegree",target:ji,targetName:"math"},{name:"random",newName:"random",target:ji,targetName:"math"},{name:"randomRange",newName:"randomRange",target:ji,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:ji,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:ji,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:ji,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:ji,targetName:"math"},{name:"repeat",newName:"repeat",target:ji,targetName:"math"},{name:"pingPong",newName:"pingPong",target:ji,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:ji,targetName:"math"}]),l.vmath=pw,V(aw.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:aw,targetName:"Scheduler"}]),V(aw,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:()=>ew.Priority.SCHEDULER}]),G(aw,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),V(nv.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),G(nv.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),V(hw.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),U(uw,"game",[{name:"collisionMatrix"},{name:"groupList"}]),U(dw.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),G(dw.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);const fw={topLeft:l.v2(0,0),topRight:l.v2(0,0),top:l.v2(0,0),bottomLeft:l.v2(0,0),bottomRight:l.v2(0,0),bottom:l.v2(0,0),center:l.v2(0,0),left:l.v2(0,0),right:l.v2(0,0),width:0,height:0,init(t){const e=this.width=t.width,i=this.height=t.height,n=t.x,s=t.y,r=s+i,o=n+e;this.topLeft.x=n,this.topLeft.y=r,this.topRight.x=o,this.topRight.y=r,this.top.x=n+e/2,this.top.y=r,this.bottomLeft.x=n,this.bottomLeft.y=s,this.bottomRight.x=o,this.bottomRight.y=s,this.bottom.x=n+e/2,this.bottom.y=s,this.center.x=n+e/2,this.center.y=s+i/2,this.left.x=n,this.left.y=s+i/2,this.right.x=o,this.right.y=s+i/2}};l.visibleRect=fw;const gw=new Gi,vw={[Kt.ORIENTATION_AUTO]:Uh.AUTO,[Kt.ORIENTATION_LANDSCAPE]:Uh.LANDSCAPE,[Kt.ORIENTATION_PORTRAIT]:Uh.PORTRAIT};class yw extends Hl{constructor(){super(),this._designResolutionSize=void 0,this._scaleX=void 0,this._scaleY=void 0,this._viewportRect=void 0,this._visibleRect=void 0,this._autoFullScreen=void 0,this._retinaEnabled=void 0,this._resizeCallback=void 0,this._resolutionPolicy=void 0,this._rpExactFit=void 0,this._rpShowAll=void 0,this._rpNoBorder=void 0,this._rpFixedHeight=void 0,this._rpFixedWidth=void 0;const t=xw,e=Sw;this._designResolutionSize=new Gi(0,0),this._scaleX=1,this._scaleY=1,this._viewportRect=new ki(0,0,0,0),this._visibleRect=new ki(0,0,0,0),this._autoFullScreen=!1,this._retinaEnabled=!1,this._resizeCallback=null,this._rpExactFit=new Cw(t.EQUAL_TO_FRAME,e.EXACT_FIT),this._rpShowAll=new Cw(t.EQUAL_TO_FRAME,e.SHOW_ALL),this._rpNoBorder=new Cw(t.EQUAL_TO_FRAME,e.NO_BORDER),this._rpFixedHeight=new Cw(t.EQUAL_TO_FRAME,e.FIXED_HEIGHT),this._rpFixedWidth=new Cw(t.EQUAL_TO_FRAME,e.FIXED_WIDTH),this._resolutionPolicy=this._rpShowAll}init(){const t=Wh.windowSize,e=t.width,i=t.height;this._designResolutionSize.width=e,this._designResolutionSize.height=i,this._viewportRect.width=e,this._viewportRect.height=i,this._visibleRect.width=e,this._visibleRect.height=i,gw.width=this._visibleRect.width,gw.height=this._visibleRect.height,fw&&fw.init(this._visibleRect),jh.on("window-resize",this._updateAdaptResult,this),jh.on("orientation-change",this._updateAdaptResult,this),jh.on("fullscreen-change",this._updateAdaptResult,this)}resizeWithBrowserSize(t){jh.handleResizeEvent=t}setResizeCallback(t){"function"!=typeof t&&null!=t||(this._resizeCallback=t)}setOrientation(t){jh.orientation=vw[t]}adjustViewportMeta(t){}enableRetina(t){this._retinaEnabled=!!t}isRetinaEnabled(){return this._retinaEnabled}enableAutoFullScreen(t){t!==this._autoFullScreen&&(this._autoFullScreen=t,t&&Wh.requestFullScreen().catch((()=>{})))}isAutoFullScreenEnabled(){return this._autoFullScreen}setCanvasSize(t,e){jh.resolutionScale=1;const i=jh.devicePixelRatio,n=new Gi(t*i,e*i);Wh.windowSize=n}getCanvasSize(){return Wh.windowSize}getFrameSize(){const t=jh.devicePixelRatio,e=Wh.windowSize;return e.width/=t,e.height/=t,e}setFrameSize(t,e){const i=jh.devicePixelRatio;Wh.windowSize=new Gi(t*i,e*i)}getVisibleSize(){return new Gi(this._visibleRect.width,this._visibleRect.height)}getVisibleSizeInPixel(){return new Gi(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}getVisibleOrigin(){return new Oi(this._visibleRect.x,this._visibleRect.y)}getVisibleOriginInPixel(){return new Oi(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}getResolutionPolicy(){return this._resolutionPolicy}_updateResolutionPolicy(t){if(t instanceof Cw)this._resolutionPolicy=t;else{const e=Cw;t===e.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),t===e.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),t===e.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),t===e.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),t===e.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}}setResolutionPolicy(t){this._updateResolutionPolicy(t);const e=Aw.getDesignResolutionSize();Aw.setDesignResolutionSize(e.width,e.height,t)}setDesignResolutionSize(t,e,i){if(!(t>0&&e>0))return void D(2200);this._updateResolutionPolicy(i);const n=this._resolutionPolicy;n&&n.preApply(this),this._designResolutionSize.width=t,this._designResolutionSize.height=e;const s=n.apply(this,this._designResolutionSize);if(s.scale&&2===s.scale.length&&(this._scaleX=s.scale[0],this._scaleY=s.scale[1]),s.viewport){const t=this._viewportRect,e=this._visibleRect,i=s.viewport;t.x=i.x,t.y=i.y,t.width=i.width,t.height=i.height,e.x=0,e.y=0,e.width=i.width/this._scaleX,e.height=i.height/this._scaleY}n.postApply(this),gw.width=this._visibleRect.width,gw.height=this._visibleRect.height,fw&&fw.init(this._visibleRect),this.emit("design-resolution-changed")}getDesignResolutionSize(){return new Gi(this._designResolutionSize.width,this._designResolutionSize.height)}setRealPixelResolution(t,e,i){this.setDesignResolutionSize(t,e,i)}getViewportRect(){return this._viewportRect}getScaleX(){return this._scaleX}getScaleY(){return this._scaleY}getDevicePixelRatio(){return jh.devicePixelRatio}convertToLocationInView(t,e,i,n=new Oi){const s=jh.devicePixelRatio*(t-i.left),r=jh.devicePixelRatio*(i.top+i.height-e);return jh.isFrameRotated?(n.x=Wh.windowSize.width-r,n.y=s):(n.x=s,n.y=r),n}_convertToUISpace(t){const e=this._viewportRect;t.x=(t.x-e.x)/this._scaleX,t.y=(t.y-e.y)/this._scaleY}_updateAdaptResult(){var t;l.director.root.resize(Wh.windowSize.width,Wh.windowSize.height);const e=this._designResolutionSize.width,i=this._designResolutionSize.height;e>0&&this.setDesignResolutionSize(e,i,this._resolutionPolicy),this.emit("canvas-resize"),null===(t=this._resizeCallback)||void 0===t||t.call(this)}}t("View",yw),yw.instance=void 0;class xw{constructor(){this.name="ContainerStrategy"}preApply(t){}apply(t,e){}postApply(t){}_setupCanvas(){const t=uw.canvas;if(t){const e=Wh.windowSize;t.width=e.width,t.height=e.height}}}xw.EQUAL_TO_FRAME=void 0,xw.PROPORTION_TO_FRAME=void 0;class Sw{constructor(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}preApply(t){}apply(t,e){return{scale:[1,1]}}postApply(t){}_buildResult(t,e,i,n,s,r){Math.abs(t-i)<2&&(i=t),Math.abs(e-n)<2&&(n=e);const o=new ki(Math.round((t-i)/2),Math.round((e-n)/2),i,n);return this._result.scale=[s,r],this._result.viewport=o,this._result}}Sw.EXACT_FIT=void 0,Sw.SHOW_ALL=void 0,Sw.NO_BORDER=void 0,Sw.FIXED_HEIGHT=void 0,Sw.FIXED_WIDTH=void 0,xw.EQUAL_TO_FRAME=new class extends xw{constructor(...t){super(...t),this.name="EqualToFrame"}apply(t,e){jh.isProportionalToFrame=!1,this._setupCanvas()}},xw.PROPORTION_TO_FRAME=new class extends xw{constructor(...t){super(...t),this.name="ProportionalToFrame"}apply(t,e){jh.isProportionalToFrame=!0,this._setupCanvas()}},Sw.EXACT_FIT=new class extends Sw{constructor(...t){super(...t),this.name="ExactFit"}apply(t,e){const i=Wh.windowSize,n=i.width,s=i.height,r=n/e.width,o=s/e.height;return this._buildResult(n,s,n,s,r,o)}},Sw.SHOW_ALL=new class extends Sw{constructor(...t){super(...t),this.name="ShowAll"}apply(t,e){const i=Wh.windowSize,n=i.width,s=i.height,r=e.width,o=e.height,a=n/r,c=s/o;let l,h,_=0;return a<c?(_=a,l=n,h=o*_):(_=c,l=r*_,h=s),this._buildResult(n,s,l,h,_,_)}},Sw.NO_BORDER=new class extends Sw{constructor(...t){super(...t),this.name="NoBorder"}apply(t,e){const i=Wh.windowSize,n=i.width,s=i.height,r=e.width,o=e.height,a=n/r,c=s/o;let l,h,_;return a<c?(l=c,h=r*l,_=s):(l=a,h=n,_=o*l),this._buildResult(n,s,h,_,l,l)}},Sw.FIXED_HEIGHT=new class extends Sw{constructor(...t){super(...t),this.name="FixedHeight"}apply(t,e){const i=Wh.windowSize,n=i.width,s=i.height,r=s/e.height,o=n,a=s;return this._buildResult(n,s,o,a,r,r)}},Sw.FIXED_WIDTH=new class extends Sw{constructor(...t){super(...t),this.name="FixedWidth"}apply(t,e){const i=Wh.windowSize,n=i.width,s=i.height,r=n/e.width,o=n,a=s;return this._buildResult(n,s,o,a,r,r)}};class Cw{constructor(t,e){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(e)}get canvasSize(){return Wh.windowSize}preApply(t){this._contentStrategy.preApply(t)}apply(t,e){return this._containerStrategy.apply(t,e),this._contentStrategy.apply(t,e)}postApply(t){this._contentStrategy.postApply(t)}setContainerStrategy(t){t instanceof xw&&(this._containerStrategy=t)}setContentStrategy(t){t instanceof Sw&&(this._contentStrategy=t)}}t("ResolutionPolicy",Cw),Cw.EXACT_FIT=0,Cw.NO_BORDER=1,Cw.SHOW_ALL=2,Cw.FIXED_HEIGHT=3,Cw.FIXED_WIDTH=4,Cw.UNKNOWN=5,Cw.ContainerStrategy=xw,Cw.ContentStrategy=Sw,l.ResolutionPolicy=Cw;const Aw=t("view",yw.instance=l.view=new yw);l.winSize=gw,G(yw.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),U(yw.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),U(l,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),U(qh,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),V(qh,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((t=>({name:`LANGUAGE_${t}`,newName:t,target:qh.Language,targetName:"sys.Language"})))),V(qh,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((t=>({name:`OS_${t}`,newName:t,target:qh.OS,targetName:"sys.OS"})))),V(qh,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((t=>({name:`BROWSER_TYPE_${t}`,newName:t,target:qh.BrowserType,targetName:"sys.BrowserType"})))),V(qh,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:qh.BrowserType,targetName:"sys.BrowserType"}]),V(qh,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((t=>({name:t,target:qh.Platform,targetName:"sys.Platform"})))),V(qh,"sys",[{name:"IPHONE",newName:"IOS",target:qh.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:qh.Platform,targetName:"sys.Platform"}]),G(qh,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((t=>({name:t})))),V(qh,"sys",[{name:"windowPixelResolution",target:Wh,targetName:"screen",newName:"windowSize"}]),U(Wh,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);class bw{constructor(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new rl,this.scenes=new rl,this.paths=new rl}init(t){(t=>{let e=t.uuids;const i=t.paths,n=t.types,s=t.deps,r=t.paths=Object.create(null);if(!1===t.debug){for(let t=0,i=e.length;t<i;t++)e[t]=Cl(e[t]);for(const t in i){const e=i[t],s=e[1];e[1]=n[s]}}else{const t=Object.create(null);for(let i=0,n=e.length;i<n;i++){const n=e[i];e[i]=t[n]=Cl(n)}e=t}for(const t in i){const n=i[t];r[e[t]]=n}const o=t.scenes;for(const t in o){const i=o[t];o[t]=e[i]}const a=t.packs;for(const t in a){const i=a[t];for(let t=0;t<i.length;++t)i[t]=e[i[t]]}const c=t.versions;if(c)for(const t in c){const i=c[t];for(let t=0;t<i.length;t+=2){const n=i[t];i[t]=e[n]||n}}const l=t.redirect;if(l)for(let t=0;t<l.length;t+=2)l[t]=e[l[t]],l[t+1]=s[l[t+1]];if(t.extensionMap)for(const i in t.extensionMap)Object.prototype.hasOwnProperty.call(t.extensionMap,i)&&t.extensionMap[i].forEach(((n,s)=>{t.extensionMap[i][s]=e[n]||n}))})(t),this.importBase=t.importBase||"",this.nativeBase=t.nativeBase||"",this.base=t.base||"",this.name=t.name||"",this.deps=t.deps||[],this._initUuid(t.uuids),this._initPath(t.paths),this._initScene(t.scenes),this._initPackage(t.packs),this._initVersion(t.versions),this._initRedirect(t.redirect);for(const e in t.extensionMap)Object.prototype.hasOwnProperty.call(t.extensionMap,e)&&t.extensionMap[e].forEach((t=>{const i=this.assetInfos.get(t);i&&(i.extension=e)}))}getInfoWithPath(t,e){if(!t)return null;t=Pl(t);const i=this.paths.get(t);if(i){if(!e)return i[0];for(let t=0,n=i.length;t<n;t++){const n=i[t];if(Ut.isChildClassOf(n.ctor,e))return n}}return null}getDirWithPath(t,e,i){"/"===(t=Pl(t))[t.length-1]&&(t=t.slice(0,-1));const n=i||[];return this.paths.forEach(((i,s)=>{if(s.startsWith(t)&&((t,e)=>!(t.length>e.length)||47===t.charCodeAt(e.length))(s,t)||!t)for(let t=0,s=i.length;t<s;t++){const s=i[t];e&&!Ut.isChildClassOf(s.ctor,e)||n.push(s)}})),n}getAssetInfo(t){return this.assetInfos.get(t)||null}getSceneInfo(t){return t.endsWith(".scene")||(t+=".scene"),"/"===t[0]||t.startsWith("db://")||(t=`/${t}`),this.scenes.find(((e,i)=>i.endsWith(t)))}destroy(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()}_initUuid(t){if(t){this.assetInfos.clear();for(let e=0,i=t.length;e<i;e++){const i=t[e];this.assetInfos.add(i,{uuid:i})}}}_initPath(t){if(!t)return;const e=this.paths;e.clear();for(const i in t){const n=t[i],s=n[0],r=n[1],o=3===n.length,a=this.assetInfos.get(i);a.path=s,a.ctor=Ut._getClassById(r),e.has(s)?o?e.get(s).push(a):e.get(s).unshift(a):e.add(s,[a])}}_initScene(t){if(!t)return;const e=this.scenes;e.clear();const i=this.assetInfos;for(const n in t){const s=t[n],r=i.get(s);r.url=n,e.add(n,r)}}_initPackage(t){if(!t)return;const e=this.assetInfos;for(const i in t){const n=t[i],s={uuid:i,packedUuids:n,ext:".json"};e.add(i,s);for(let t=0,i=n.length;t<i;t++){const r=n[t],o=e.get(r),a=o.packs;a?1===i?a.unshift(s):a.push(s):o.packs=[s]}}}_initVersion(t){if(!t)return;const e=this.assetInfos;let i=t.import;if(i)for(let t=0,n=i.length;t<n;t+=2){const n=i[t];e.get(n).ver=i[t+1]}if(i=t.native,i)for(let t=0,n=i.length;t<n;t+=2){const n=i[t];e.get(n).nativeVer=i[t+1]}}_initRedirect(t){if(!t)return;const e=this.assetInfos;for(let i=0,n=t.length;i<n;i+=2){const n=t[i];e.get(n).redirect=t[i+1]}}}function Tw(t,e){t._uuid&&e.push(t._uuid)}function Ew(t,e){const i=Object.getOwnPropertyNames(t);for(let n=0;n<i.length;n++){const s=i[n];if("node"===s||"__eventTargets"===s)continue;const r=t[s];if("object"==typeof r&&r)if(Array.isArray(r))for(let t=0;t<r.length;t++){const i=r[t];i instanceof fh&&Tw(i,e)}else if(r.constructor&&r.constructor!==Object)r instanceof fh&&Tw(r,e);else{const t=Object.getOwnPropertyNames(r);for(let i=0;i<t.length;i++){const n=r[t[i]];n instanceof fh&&Tw(n,e)}}}}function Pw(t,e){for(let i=0;i<t._components.length;i++)Ew(t._components[i],e);for(let i=0;i<t._children.length;i++)Pw(t._children[i],e)}function ww(t,e,i,n){i.push(t._uuid);const s=_f.getDeps(t._uuid);for(let t=0,r=s.length;t<r;t++){const r=al.get(s[t]);if(!r)continue;const o=r._uuid;o in e?e[o]+=n:e[o]=r.refCount+n,i.includes(o)||ww(r,e,i,n)}}const Iw=[];var Rw=new class{constructor(){this._persistNodeDeps=new rl,this._toDelete=new rl,this._eventListener=!1}init(){this._persistNodeDeps.clear(),this._toDelete.clear()}_addPersistNodeRef(t){const e=[];Pw(t,e);for(let t=0,i=e.length;t<i;t++){const i=al.get(e[t]);i&&i.addRef()}this._persistNodeDeps.add(t.uuid,e)}_removePersistNodeRef(t){if(!this._persistNodeDeps.has(t.uuid))return;const e=this._persistNodeDeps.get(t.uuid);for(let t=0,i=e.length;t<i;t++){const i=al.get(e[t]);i&&i.decRef()}this._persistNodeDeps.remove(t.uuid)}_autoRelease(t,e,i){if(t){const i=_f.getDeps(t.uuid);for(let e=0,n=i.length;e<n;e++){const n=al.get(i[e]);n&&n.decRef(t.autoReleaseAssets)}const n=_f._depends.get(t.uuid);if(n&&n.persistDeps){const e=n.persistDeps;for(let i=0,n=e.length;i<n;i++){const n=al.get(e[i]);n&&n.decRef(t.autoReleaseAssets)}}t.uuid!==e.uuid&&_f.remove(t.uuid)}const n=_f._depends.get(e.uuid);n&&(n.persistDeps=[]);for(const t in i){const e=i[t],s=this._persistNodeDeps.get(e.uuid);for(const t of s){const e=al.get(t);e&&e.addRef()}n&&n.persistDeps.push(...s)}}tryRelease(t,e=!1){t instanceof fh&&(e?this._free(t,e):(this._toDelete.add(t._uuid,t),this._eventListener||(this._eventListener=!0,ne(this._freeAssets.bind(this)))))}_freeAssets(){this._eventListener=!1,this._toDelete.forEach((t=>{this._free(t)})),this._toDelete.clear()}_free(t,e=!1){const i=t._uuid;if(this._toDelete.remove(i),!sl(t,!0))return;if(!e&&t.refCount>0&&function(t){const e=Object.create(null);if(e[t._uuid]=t.refCount,ww(t,e,Iw,-1),Iw.length=0,0!==e[t._uuid])return e[t._uuid];for(const t in e)0!==e[t]&&ww(al.get(t),e,Iw,1);return Iw.length=0,e[t._uuid]}(t)>0)return;al.remove(i);const n=_f.getDeps(i);for(let t=0,e=n.length;t<e;t++){const e=al.get(n[t]);e&&(e.decRef(!1),this._free(e,!1))}t.destroy(),_f.remove(i)}};let Dw=null;function Mw(t,e){for(let i=0,n=t.input.length;i<n;i++){const n=t.input[i];e&&!n.isNative&&n.content instanceof fh&&n.content.decRef(!1),n.recycle()}t.input=null}function Ow(t,e){return e?/\?/.test(t)?`${t}&_t=${Date.now()}`:`${t}?_t=${Date.now()}`:t}function Bw(t,e,i,n,s=0){t(s,((r,o)=>{s++,!r||s>e?n&&n(r,o):setTimeout((()=>{Bw(t,e,i,n,s)}),i)}))}function Nw(t,e,i,n,s){try{const r=_f.parse(t,e);for(let t=0,e=r.deps.length;t<e;t++){const e=r.deps[t];e in i||(i[e]=!0,n.push({uuid:e,bundle:s&&s.name}))}r.nativeDep&&(s&&(r.nativeDep.bundle=s.name),n.push({...r.nativeDep}))}catch(t){x(t.message,t.stack)}}function Lw(t,e,i){e&&(i=void 0!==i?i:l.assetManager.cacheAsset,El(e)||!i||e.isDefault||al.add(t,e))}function Fw(t,e,i){let n=0;const s=[],r=t.length;0===r&&i&&i(s);const o=t=>{t&&s.push(t),n++,n===r&&i&&i(s)};for(let i=0;i<r;i++)e(t[i],o)}function zw(t,e,i){let n=t,s=e,r=i;if(void 0===i){const i="function"==typeof t;e?(r=e,i||(s=null)):void 0===e&&i&&(r=t,n=null,s=null),void 0!==e&&i&&(s=t,n=null)}return{options:n||Object.create(null),onProgress:s,onComplete:r}}function Vw(t,e,i){let n=t,s=e,r=i;if(void 0===i){const i=Ut.isChildClassOf(t,fh);e?(r=e,i&&(s=null)):void 0!==e||i||(r=t,s=null,n=null),void 0===e||i||(s=t,n=null)}return{type:n,onProgress:s||Dw,onComplete:r}}function Gw(t,e,i,n={}){if(!i[e]||n[e])return!1;n[e]=!0;let s=!1;const r=_f.getDeps(e);if(r)for(let e=0,o=r.length;e<o;e++){const o=r[e];if(o===t||Gw(t,o,i,n)){s=!0;break}}return s}function Uw(t){return(e,i)=>{if(!t)return;const n=[];Array.isArray(i)?i.forEach((t=>t instanceof fh&&n.push(t.addRef()))):i instanceof fh&&n.push(i.addRef()),ne((()=>{n.forEach((t=>t.decRef(!1))),t(e,i)}))}}class kw{constructor(){this._config=new bw}get config(){return this._config}get name(){return this._config.name}get deps(){return this._config.deps}get base(){return this._config.base}getInfoWithPath(t,e){return this._config.getInfoWithPath(t,e)}getDirWithPath(t,e,i){return this._config.getDirWithPath(t,e,i)}getAssetInfo(t){return this._config.getAssetInfo(t)}getSceneInfo(t){return this._config.getSceneInfo(t)}init(t){this._config.init(t),hl.add(t.name,this)}load(t,e,i,n){const{type:s,onProgress:r,onComplete:o}=Vw(e,i,n),a={__requestType__:ml.PATH,type:s,bundle:this.name,__outputAsArray__:Array.isArray(t)};l.assetManager.loadAny(t,a,r,o)}preload(t,e,i,n){const{type:s,onProgress:r,onComplete:o}=Vw(e,i,n);l.assetManager.preloadAny(t,{__requestType__:ml.PATH,type:s,bundle:this.name},r,o)}loadDir(t,e,i,n){const{type:s,onProgress:r,onComplete:o}=Vw(e,i,n);l.assetManager.loadAny(t,{__requestType__:ml.DIR,type:s,bundle:this.name,__outputAsArray__:!0},r,o)}preloadDir(t,e,i,n){const{type:s,onProgress:r,onComplete:o}=Vw(e,i,n);l.assetManager.preloadAny(t,{__requestType__:ml.DIR,type:s,bundle:this.name},r,o)}loadScene(t,e,i,n){const{options:s,onProgress:r,onComplete:o}=zw(e,i,n);s.preset=s.preset||"scene",s.bundle=this.name,l.assetManager.loadAny({scene:t},s,r,((t,e)=>{if(t)x(t.message,t.stack);else if(e instanceof AP&&e.scene){const t=e.scene;t._id=e._uuid,t.name=e.name}else t=new Error(`The asset ${e._uuid} is not a scene`);o&&o(t,e)}))}preloadScene(t,e,i,n){const{options:s,onProgress:r,onComplete:o}=zw(e,i,n);s.bundle=this.name,l.assetManager.preloadAny({scene:t},s,r,(e=>{e&&D(1210,t,e.message),o&&o(e)}))}get(t,e){const i=this.getInfoWithPath(t,e);return i&&al.get(i.uuid)||null}release(t,e){const i=this.get(t,e);i&&Rw.tryRelease(i,!0)}releaseUnusedAssets(){al.forEach((t=>{const e=this.getAssetInfo(t._uuid);e&&!e.redirect&&Rw.tryRelease(t)}))}releaseAll(){al.forEach((t=>{const e=this.getAssetInfo(t._uuid);e&&!e.redirect&&Rw.tryRelease(t,!0)}))}_destroy(){this._config.destroy()}}const Hw=t("resources",new kw);function jw(t,e,i){const n=new Image;function s(){n.removeEventListener("load",s),n.removeEventListener("error",r),i&&i(null,n)}function r(){n.removeEventListener("load",s),n.removeEventListener("error",r),i&&i(new Error(N(4930,t)))}return"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),n.addEventListener("load",s),n.addEventListener("error",r),n.src=t,n}function Ww(t,e,i,n){const s=new XMLHttpRequest,r=`download failed: ${t}, status: `;if(s.open("GET",t,!0),void 0!==e.xhrResponseType&&(s.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(s.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&s.overrideMimeType&&s.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(s.timeout=e.xhrTimeout),e.xhrHeader)for(const t in e.xhrHeader)s.setRequestHeader(t,e.xhrHeader[t]);return s.onload=()=>{200===s.status||0===s.status?n&&n(null,s.response):n&&n(new Error(`${r}${s.status}(no response)`))},i&&(s.onprogress=t=>{t.lengthComputable&&i(t.loaded,t.total)}),s.onerror=()=>{n&&n(new Error(`${r}${s.status}(error)`))},s.ontimeout=()=>{n&&n(new Error(`${r}${s.status}(time out)`))},s.onabort=()=>{n&&n(new Error(`${r}${s.status}(abort)`))},s.send(null),s}l.resources=Hw;const qw={};function Xw(t,e,i){if(qw[t])return i&&i(null),null;const n=document.createElement("script");function s(){n.parentNode.removeChild(n),n.removeEventListener("load",s,!1),n.removeEventListener("error",r,!1),qw[t]=!0,i&&i(null)}function r(){n.parentNode.removeChild(n),n.removeEventListener("load",s,!1),n.removeEventListener("error",r,!1),i&&i(new Error(N(4928,t)))}return"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),n.async=e.scriptAsyncLoading||!1,n.src=t,n.addEventListener("load",s,!1),n.addEventListener("error",r,!1),document.body.appendChild(n),n}const Yw=/^(?:\w+:\/\/|\.+\/).+/,Kw=(t,e,i)=>{(qh.hasFeature(qh.Feature.IMAGE_BITMAP)&&l.assetManager.allowImageBitmap?Jw:jw)(t,e,i)},Jw=(t,e,i)=>{e.xhrResponseType="blob",Ww(t,e,e.onFileProgress,i)},$w=(t,e,i)=>{e.xhrResponseType="json",Ww(t,e,e.onFileProgress,i)},Zw=(t,e,i)=>{e.xhrResponseType="arraybuffer",Ww(t,e,e.onFileProgress,i)},Qw=(t,e,i)=>{$w(t,e,((e,n)=>{if(e)return void i(e);const s=Jh(n);Promise.all(s.chunks.map((i=>new Promise(((n,s)=>{Zw(`${sh(t)}${i}`,{},((t,i)=>{e?s(e):n(new Uint8Array(i))}))}))))).then((t=>{const e=new Kh(s.document,t);i(null,e)})).catch((t=>{i(t)}))}))},tI=(t,e,i)=>{Zw(t,e,((t,e)=>{if(t)i(t);else try{const t=$h(new Uint8Array(e));i(null,t)}catch(t){i(t)}}))},eI=(t,e,i)=>{e.xhrResponseType="text",Ww(t,e,e.onFileProgress,i)},iI=(t,e,i)=>{const n=rh(t);let s=t;Yw.test(s)||(s=-1!==nI.remoteBundles.indexOf(n)?`${nI.remoteServerAddress}remote/${n}`:`assets/${n}`);const r=e.version||nI.bundleVers[n];let o=0,a=null,c=null;$w(`${s}/config.${r?`${r}.`:""}json`,e,((t,e)=>{c=t,a=e,a&&(a.base=`${s}/`),2==++o&&i(c,a)})),Xw(`${s}/index.${r?`${r}.`:""}js`,e,(t=>{c=t,2==++o&&i(t,a)}))},nI=new class{constructor(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=jw,this.downloadDomAudio=null,this.downloadFile=Ww,this.downloadScript=Xw,this._downloaders={".png":Kw,".jpg":Kw,".bmp":Kw,".jpeg":Kw,".gif":Kw,".ico":Kw,".tiff":Kw,".webp":Kw,".image":Kw,".pvr":Zw,".pkm":Zw,".astc":Zw,".txt":eI,".xml":eI,".vsh":eI,".fsh":eI,".atlas":eI,".tmx":eI,".tsx":eI,".json":$w,".ExportJson":$w,".plist":eI,".ccon":Qw,".cconb":tI,".fnt":eI,".binary":Zw,".bin":Zw,".dbbin":Zw,".skel":Zw,".js":Xw,bundle:iI,default:eI},this._downloading=new rl,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}get remoteServerAddress(){return this._remoteServerAddress}init(t="",e={},i=[]){this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=t,this.bundleVers=e,this.remoteBundles=i}register(t,e){"object"==typeof t?At(this._downloaders,t):this._downloaders[t]=e}download(t,e,i,n,s){const r=cl.get(t);if(r)return void s(null,r);const o=this._downloading.get(t);if(o){o.push(s);const e=this._queue.find((e=>e.id===t));if(!e)return;const i=n.priority||0;return void(e.priority<i&&(e.priority=i,this._queueDirty=!0))}const a=void 0!==n.maxRetryCount?n.maxRetryCount:this.maxRetryCount,c=void 0!==n.maxConcurrency?n.maxConcurrency:this.maxConcurrency,l=void 0!==n.maxRequestsPerFrame?n.maxRequestsPerFrame:this.maxRequestsPerFrame,h=this._downloaders[i]||this._downloaders.default;Bw(((i,r)=>{if(0===i&&this._downloading.add(t,[s]),!this.limited)return void h(Ow(e,this.appendTimeStamp),n,r);this._updateTime();const o=(t,e)=>{this._totalNum--,this._handleQueueInNextFrame(c,l),r(t,e)};this._totalNum<c&&this._totalNumThisPeriod<l?(h(Ow(e,this.appendTimeStamp),n,o),this._totalNum++,this._totalNumThisPeriod++):(this._queue.push({id:t,priority:n.priority||0,url:e,options:n,done:o,handler:h}),this._queueDirty=!0,this._totalNum<c&&this._handleQueueInNextFrame(c,l))}),a,this.retryInterval,((e,i)=>{e||cl.add(t,i);const n=this._downloading.remove(t);for(let t=0,s=n.length;t<s;t++)n[t](e,i)}))}loadSubpackage(t,e){l.assetManager.loadBundle(t,null,e)}_updateTime(){const t=performance.now(),e=l.game.deltaTime,i=e>this._maxInterval?this._maxInterval:e;t-this._lastDate>1e3*i&&(this._totalNumThisPeriod=0,this._lastDate=t)}_handleQueue(t,e){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<t&&this._totalNumThisPeriod<e;){this._queueDirty&&(this._queue.sort(((t,e)=>t.priority-e.priority)),this._queueDirty=!1);const t=this._queue.pop();if(!t)break;this._totalNum++,this._totalNumThisPeriod++,t.handler(Ow(t.url,this.appendTimeStamp),t.options,t.done)}this._handleQueueInNextFrame(t,e)}_handleQueueInNextFrame(t,e){!this._checkNextPeriod&&this._queue.length>0&&(ne(this._handleQueue.bind(this),t,e),this._checkNextPeriod=!0)}};function sI(t,e,i,n){let s=null,r=null;try{s=new rf,s._nativeUrl=t,s._nativeAsset=e}catch(t){r=t}n(r,s)}function rI(t,e,i,n){const s=new MP;s.json=e,n(null,s)}function oI(t,e,i,n){const s=new PP;s.text=e,n(null,s)}function aI(t,e,i,n){const s=new oA;s._nativeUrl=t,s._nativeAsset=e,n(null,s)}function cI(t,e,i,n){const s=new fh;s._nativeUrl=t,s._nativeAsset=e,n(null,s)}function lI(t,i,n,s){let r=hl.get(i.name);r||(r=i.name===fl.RESOURCES?Hw:new kw,i.base=i.base||`${t}/`,r.init(i)),e.import(`virtual:///prerequisite-imports/${r.name}`).then((()=>{s(null,r)})).catch(s)}var hI=new class{constructor(){this._creating=new rl,this._producers={".png":sI,".jpg":sI,".bmp":sI,".jpeg":sI,".gif":sI,".ico":sI,".tiff":sI,".webp":sI,".image":sI,".pvr":sI,".pkm":sI,".txt":oI,".xml":oI,".vsh":oI,".fsh":oI,".atlas":oI,".tmx":oI,".tsx":oI,".fnt":oI,".json":rI,".ExportJson":rI,".binary":aI,".bin":aI,".dbbin":aI,".skel":aI,bundle:lI,default:cI}}register(t,e){"object"==typeof t?Ut.mixin(this._producers,t):this._producers[t]=e}create(t,e,i,n,s){const r=this._producers[i]||this._producers.default,o=al.get(t);if(!n.reloadAsset&&o)return void s(null,o);const a=this._creating.get(t);a?a.push(s):(this._creating.add(t,[s]),r(t,e,n,((e,i)=>{!e&&i instanceof fh&&(i._uuid=t,Lw(t,i,n.cacheAsset));const s=this._creating.remove(t);for(let t=0,n=s.length;t<n;t++)s[t](e,i)})))}},_I=new class{constructor(){this._loading=new rl,this._unpackers={".json":this.unpackJson}}unpackJson(t,e,i,n){let s=Ut.createMap(!0),r=null;if(Array.isArray(e)){(e=function(t){if(t[0]<1)throw new Error(N(5304,t[0]));g_(t,!0,void 0,y_.reportMissingClass),v_(t);const e=new x_(t[0]),i=t[1],n=t[2],s=t[3],r=t[4],o=t[5];for(let t=0;t<o.length;++t)o[t].unshift(e,i,n,s,r);return o}(e)).length!==t.length&&D(4915);for(let i=0;i<t.length;i++)s[`${t[i]}@import`]=e[i]}else{const i=Ut._getClassId(xf),n=Ut._getClassId(rf);if(e.type===i&&e.data){const n=e.data;n.length!==t.length&&D(4915);for(let e=0;e<t.length;e++)s[`${t[e]}@import`]=S_(i,{base:n[e][0],mipmaps:n[e][1]})}else if(e.type===n&&e.data){const i=e.data;i.length!==t.length&&D(4915);for(let e=0;e<t.length;e++)s[`${t[e]}@import`]=i[e]}else r=new Error("unmatched type pack!"),s=null}n(r,s)}init(){this._loading.clear()}register(t,e){"object"==typeof t?Ut.mixin(this._unpackers,t):this._unpackers[t]=e}unpack(t,e,i,n,s){e?(0,this._unpackers[i])(t,e,n,s):s(new Error("package data is wrong!"))}load(t,e,i){if(t.isNative||!t.info||!t.info.packs)return void nI.download(t.id,t.url,t.ext,t.options,i);if(cl.has(t.id))return void i(null,cl.get(t.id));const n=t.info.packs;let s=n.find((t=>this._loading.has(t.uuid)));if(s)return void this._loading.get(s.uuid).push({onComplete:i,id:t.id});s=n[0],this._loading.add(s.uuid,[{onComplete:i,id:t.id}]);const r=wl(s.uuid,{ext:s.ext,bundle:t.config.name});nI.download(s.uuid,r,s.ext,t.options,((e,i)=>{cl.remove(s.uuid),e&&x(e.message,e.stack),this.unpack(s.packedUuids,i,s.ext,t.options,((t,i)=>{if(!t)for(const t in i)cl.add(t,i[t]);const n=this._loading.remove(s.uuid);for(let s=0,r=n.length;s<r;s++){const r=n[s];if(e||t){r.onComplete(e||t);continue}const o=i[r.id];o?r.onComplete(null,o):r.onComplete(new Error("can not retrieve data from package"))}}))}))}};function uI(t,e){let i=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},i=!0);const{options:n,progress:s}=t,r=[],o=s.total,a=n.__exclude__=n.__exclude__||Object.create(null);t.output=[],Fw(t.input,((n,c)=>{if(!n.isNative&&al.has(n.uuid)){const e=al.get(n.uuid);return n.content=e.addRef(),t.output.push(n),s.canInvoke&&t.dispatch("progress",++s.finish,s.total,n),void c()}_I.load(n,t.options,((h,_)=>{h?t.isFinish||(!l.assetManager.force||i?(x(h.message,h.stack),s.canInvoke=!1,e(h)):(t.output.push(n),s.canInvoke&&t.dispatch("progress",++s.finish,s.total,n))):t.isFinish||(n.file=_,t.output.push(n),n.isNative||(a[n.uuid]=!0,Nw(n.uuid,_,a,r,n.config),s.total=o+r.length),s.canInvoke&&t.dispatch("progress",++s.finish,s.total,n)),c()}))}),(()=>{if(t.isFinish)return Mw(t,!0),void t.dispatch("error");if(r.length>0){const o=gl.create({input:r,progress:s,options:n,onProgress:t.onProgress,onError:gl.prototype.recycle,onComplete:n=>{n||(t.output.push(...o.output),o.recycle()),i&&dI(t),e(n)}});ul.async(o)}else i&&dI(t),e()}))}function dI(t){const e=t.output;for(let t=0,i=e.length;t<i;t++)e[t].content&&e[t].content.decRef(!1)}class mI{constructor(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}parse(t){return this._parseXML(t)}_parseXML(t){if(this._parser)return this._parser.parseFromString(t,"text/xml");throw new Error("Dom parser is not supported in this platform!")}}const pI=new class extends mI{parse(t){const e=this._parseXML(t).documentElement;if("plist"!==e.tagName)return I(5100),{};let i=null;for(let t=0,n=e.childNodes.length;t<n&&(i=e.childNodes[t],1!==i.nodeType);t++);return this._parseNode(i)}_parseNode(t){let e=null;const i=t.tagName;if("dict"===i)e=this._parseDict(t);else if("array"===i)e=this._parseArray(t);else if("string"===i)if(1===t.childNodes.length)e=t.firstChild.nodeValue;else{e="";for(let i=0;i<t.childNodes.length;i++)e+=t.childNodes[i].nodeValue}else"false"===i?e=!1:"true"===i?e=!0:"real"===i?e=parseFloat(t.firstChild.nodeValue):"integer"===i&&(e=parseInt(t.firstChild.nodeValue,10));return e}_parseArray(t){const e=[];for(let i=0,n=t.childNodes.length;i<n;i++){const n=t.childNodes[i];1===n.nodeType&&e.push(this._parseNode(n))}return e}_parseDict(t){const e={};let i="";for(let n=0,s=t.childNodes.length;n<s;n++){const s=t.childNodes[n];1===s.nodeType&&("key"===s.tagName?i=s.firstChild.nodeValue:e[i]=this._parseNode(s))}return e}};function fI(t,e){return t[e]<<8|t[e+1]}var gI=new class{constructor(){this._parsing=new rl,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}parseImage(t,e,i){t instanceof HTMLImageElement?i(null,t):createImageBitmap(t,{premultiplyAlpha:"none"}).then((t=>{i(null,t)}),(t=>{i(t,null)}))}parsePVRTex(t,e,i){let n=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,i=new Int32Array(e,0,13);if(55727696===i[0]){const t=i[7],n=i[6],r=i[12]+52;s={_data:new Uint8Array(e,r),_compressed:!0,width:t,height:n,format:0}}else{if(559044176!==i[11])throw new Error("Invalid magic number in PVR header");{const t=i[0],n=i[1],r=i[2];s={_data:new Uint8Array(e,t),_compressed:!0,width:r,height:n,format:0}}}}catch(t){n=t}i(n,s)}parsePKMTex(t,e,i){let n=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,i=new Uint8Array(e),n=fI(i,6);if(0!==n&&1!==n&&3!==n)throw new Error("Invalid magic number in ETC header");const r=fI(i,12),o=fI(i,14);fI(i,8),fI(i,10),s={_data:new Uint8Array(e,16),_compressed:!0,width:r,height:o,format:0}}catch(t){n=t}i(n,s)}parseASTCTex(t,e,i){let n=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,i=new Uint8Array(e);if(1554098963!==i[0]+(i[1]<<8)+(i[2]<<16)+(i[3]<<24))throw new Error("Invalid magic number in ASTC header");const n=i[4],r=i[5],o=i[6];if((n<3||n>6||r<3||r>6||o<3||o>6)&&(n<4||7===n||9===n||11===n||n>12||r<4||7===r||9===r||11===r||r>12||1!==o))throw new Error("Invalid block number in ASTC header");const a=function(t,e){return 4===t?Np.RGBA_ASTC_4x4:5===t?4===e?Np.RGBA_ASTC_5x4:Np.RGBA_ASTC_5x5:6===t?5===e?Np.RGBA_ASTC_6x5:Np.RGBA_ASTC_6x6:8===t?5===e?Np.RGBA_ASTC_8x5:6===e?Np.RGBA_ASTC_8x6:Np.RGBA_ASTC_8x8:10===t?5===e?Np.RGBA_ASTC_10x5:6===e?Np.RGBA_ASTC_10x6:8===e?Np.RGBA_ASTC_10x8:Np.RGBA_ASTC_10x10:10===e?Np.RGBA_ASTC_12x10:Np.RGBA_ASTC_12x12}(n,r),c=i[7]+(i[8]<<8)+(i[9]<<16),l=i[10]+(i[11]<<8)+(i[12]<<16);i[13],i[14],i[15],s={_data:new Uint8Array(e,16),_compressed:!0,width:c,height:l,format:a}}catch(t){n=t}i(n,s)}parsePlist(t,e,i){let n=null;const s=pI.parse(t);s||(n=new Error("parse failed")),i(n,s)}parseImport(t,e,i){if(!t)return void i(new Error(`The json file of asset ${e.__uuid__} is empty or missing`));let n=null,s=null;try{n=lf(t,e)}catch(t){s=t}i(s,n)}init(){this._parsing.clear()}register(t,e){"object"==typeof t?At(this._parsers,t):this._parsers[t]=e}parse(t,e,i,n,s){const r=ll.get(t);if(r)return void s(null,r);const o=this._parsing.get(t);if(o)return void o.push(s);const a=this._parsers[i];a?(this._parsing.add(t,[s]),a(e,n,((e,i)=>{e?cl.remove(t):El(i)||ll.add(t,i);const n=this._parsing.remove(t);for(let t=0,s=n.length;t<s;t++)n[t](e,i)}))):s(null,e)}};function vI(t,e){let i=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},i=!0);const{options:n,progress:s}=t;n.__exclude__=n.__exclude__||Object.create(null),t.output=[],Fw(t.input,((r,o)=>{const a=gl.create({input:r,onProgress:t.onProgress,options:n,progress:s,onComplete:(n,c)=>{n&&!t.isFinish&&(!l.assetManager.force||i?(x(n.message,n.stack),s.canInvoke=!1,e(n)):s.canInvoke&&t.dispatch("progress",++s.finish,s.total,r)),t.output.push(c),a.recycle(),o(null)}});yI.async(a)}),(()=>{if(n.__exclude__=null,t.isFinish)return Mw(t,!0),void t.dispatch("error");!function(t){const e=t.source;if(t.options.__outputAsArray__||1!==e.length){const i=t.output=[];for(let t=0,n=e.length;t<n;t++)i.push(e[t].content)}else t.output=e[0].content}(t),Mw(t,!0),e()}))}const yI=new ol("loadOneAsset",[function(t,e){const i=t.output=t.input,{options:n,isNative:s,uuid:r,file:o}=i,{reloadAsset:a}=n;o||!a&&!s&&al.has(r)?e():_I.load(i,t.options,((t,n)=>{i.file=n,e(t)}))},function(t,e){const i=t.output=t.input,n=t.progress,s=t.options.__exclude__,{id:r,file:o,options:a}=i;if(i.isNative)gI.parse(r,o,i.ext,a,((s,o)=>{s?e(s):(i.content=o,n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),cl.remove(r),ll.remove(r),e())}));else{const{uuid:c}=i;if(c in s){const{finish:r,content:o,err:a,callbacks:l}=s[c];n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),r||Gw(c,c,s)?(o&&o.addRef(),i.content=o,e(a)):l.push({done:e,item:i})}else if(!a.reloadAsset&&al.has(c)){const s=al.get(c);i.content=s.addRef(),n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),e()}else a.__uuid__=c,gI.parse(r,o,"import",a,((i,n)=>{i?e(i):function(t,e,i){const{input:n,progress:s}=t,{uuid:r,id:o,options:a,config:c}=n,{cacheAsset:l}=a,h=[];e.addRef&&e.addRef(),Nw(r,e,Object.create(null),h,c),s.canInvoke&&t.dispatch("progress",++s.finish,s.total+=h.length,n);const _=t.options.__exclude__[r]={content:e,finish:!1,callbacks:[{done:i,item:n}]},u=gl.create({input:h,options:t.options,onProgress:t.onProgress,onError:gl.prototype.recycle,progress:s,onComplete:t=>{if(e.decRef&&e.decRef(!1),_.finish=!0,_.err=t,!t){const t=Array.isArray(u.output)?u.output:[u.output],i=Object.create(null);for(const e of t)e&&(i[e instanceof fh?`${e._uuid}@import`:`${r}@native`]=e);!function(t,e,i){let n=!1;const s=of.get(e);if(s){for(let t=0,e=s.length;t<e;t++){const e=s[t],r=i[`${e.uuid}@import`];if(r)e.owner[e.prop]=r.addRef();else{if(x(`The asset ${e.uuid} is missing!`),e.type&&e.type!==fh){const t=new e.type;t.initDefault(e.uuid),e.owner[e.prop]=t}n=!0}}of.delete(e)}af.has(e)&&(i[`${t}@native`]?e._nativeAsset=i[`${t}@native`]:(n=!0,console.error(`the native asset of ${t} is missing!`)),af.delete(e))}(r,e,i);try{"function"!=typeof e.onLoaded||cf.has(e)||af.has(e)||(e.onLoaded(),cf.add(e))}catch(t){x(`The asset ${r} is invalid for some reason, detail message: ${t.message}, stack: ${t.stack}`)}cl.remove(o),ll.remove(o),Lw(r,e,l),u.recycle()}const i=_.callbacks;for(let n=0,s=i.length;n<s;n++){const s=i[n];e.addRef&&e.addRef(),s.item.content=e,s.done(t)}i.length=0}});_l.async(u)}(t,n,e)}))}}]);function xI(t,e){const i=t.options,n=Object.create(null),s=Object.create(null);for(const t in i)switch(t){case ml.PATH:case ml.UUID:case ml.DIR:case ml.SCENE:case ml.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":n[t]=i[t];break;case"__exclude__":case"__outputAsArray__":s[t]=i[t];break;default:n[t]=i[t],s[t]=i[t]}t.options=s;const r=gl.create({input:t.input,options:n});let o=null;try{t.output=t.source=dl.sync(r)}catch(t){o=t;for(let t=0,e=r.output.length;t<e;t++)r.output[t].recycle()}r.recycle(),e(o)}class SI{constructor(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}get id(){return this._id||(this._id=`${this.uuid}@${this.isNative?"native":"import"}`),this._id}static create(){let t;return t=0!==SI._deadPool.length?SI._deadPool.pop():new SI,t}recycle(){SI._deadPool.length!==SI.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),SI._deadPool.push(this))}}SI.MAX_DEAD_NUM=500,SI._deadPool=[];const CI=[];function AI(t){var e;const i=t.options,n=Array.isArray(t.input)?t.input:[t.input];t.output=[];for(let r=0;r<n.length;r++){let o=n[r],a=SI.create(),c=null,l=null;if("string"==typeof o&&(o=Object.create(null),o[i.__requestType__||ml.UUID]=n[r]),"object"==typeof o){Ct(o,i),o.preset&&Ct(o,pl[o.preset]);for(const t in o){switch(t){case ml.UUID:{var s;const t=a.uuid=Cl(o.uuid);if(!o.bundle){const e=hl.find((e=>!!e.getAssetInfo(t)));o.bundle=e&&e.name}if(hl.has(o.bundle)){if(c=hl.get(o.bundle).config,l=c.getAssetInfo(t),l&&l.redirect){if(!hl.has(l.redirect))throw new Error(`Please load bundle ${l.redirect} first`);c=hl.get(l.redirect).config,l=c.getAssetInfo(t)}a.config=c,a.info=l}a.ext=o.ext||(null===(s=l)||void 0===s?void 0:s.extension)||".json";break}case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case ml.DIR:if(hl.has(o.bundle)){hl.get(o.bundle).config.getDirWithPath(o.dir,o.type,CI);for(const t of CI)n.push({uuid:t.uuid,__isNative__:!1,ext:t.extension||".json",bundle:o.bundle});CI.length=0}a.recycle(),a=null;break;case ml.PATH:if(hl.has(o.bundle)){if(c=hl.get(o.bundle).config,l=c.getInfoWithPath(o.path,o.type),l&&l.redirect){if(!hl.has(l.redirect))throw new Error(`you need to load bundle ${l.redirect} first`);c=hl.get(l.redirect).config,l=c.getAssetInfo(l.uuid)}if(!l)throw a.recycle(),new Error(`Bundle ${o.bundle} doesn't contain ${o.path}`);a.config=c,a.uuid=l.uuid,a.info=l}a.ext=o.ext||(null===(e=l)||void 0===e?void 0:e.extension)||".json";break;case ml.SCENE:if(!o.bundle){const t=hl.find((t=>!!t.getSceneInfo(o.scene)));o.bundle=t&&t.name}if(hl.has(o.bundle)){if(c=hl.get(o.bundle).config,l=c.getSceneInfo(o.scene),l&&l.redirect){if(!hl.has(l.redirect))throw new Error(`you need to load bundle ${l.redirect} first`);c=hl.get(l.redirect).config,l=c.getAssetInfo(l.uuid)}if(!l)throw a.recycle(),new Error(`Bundle ${c.name} doesn't contain scene ${o.scene}`);a.config=c,a.uuid=l.uuid,a.info=l}break;case"__isNative__":a.isNative=o.__isNative__;break;case ml.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||nh(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[t]=o[t]}if(!a)break}}if(a&&(t.output.push(a),!a.uuid&&!a.url))throw new Error(`Can not parse this input:${JSON.stringify(o)}`)}return null}function bI(t){const e=t.output=t.input;for(let t=0;t<e.length;t++){const i=e[t];if(i.url)continue;let n="",s="";const r=i.config;s=i.isNative?r&&r.nativeBase?r.base+r.nativeBase:l.assetManager.generalNativeBase:r&&r.importBase?r.base+r.importBase:l.assetManager.generalImportBase;const o=i.uuid;let a="";i.info&&(a=i.isNative?i.info.nativeVer?`.${i.info.nativeVer}`:"":i.info.ver?`.${i.info.ver}`:""),n=".ttf"===i.ext?`${s}/${o.slice(0,2)}/${o}${a}/${i.options.__nativeName__}`:`${s}/${o.slice(0,2)}/${o}${a}${i.ext}`,i.url=n}return null}class TI{constructor(){this.pipeline=_l.append(xI).append(vI),this.fetchPipeline=ul.append(xI).append(uI),this.transformPipeline=dl.append(AI).append(bI),this.bundles=hl,this.assets=al,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=_f,this.force=!1,this.allowImageBitmap=!qh.isMobile,this.utils=Il,this.downloader=nI,this.parser=gI,this.packManager=_I,this.cacheAsset=!0,this.cacheManager=null,this.presets=pl,this.factory=hI,this.preprocessPipe=xI,this.fetchPipe=uI,this.loadPipe=vI,this.references=null,this._releaseManager=Rw,this._files=cl,this._parsed=ll,this._parsePipeline=null}get main(){return hl.get(fl.MAIN)||null}get resources(){return hl.get(fl.RESOURCES)||null}init(t={}){this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(t.server,t.bundleVers,t.remoteBundles),this.parser.init(),this.dependUtil.init();let e=t.importBase||"";e&&e.endsWith("/")&&(e=e.substr(0,e.length-1));let i=t.nativeBase||"";i&&i.endsWith("/")&&(i=i.substr(0,i.length-1)),this.generalImportBase=e,this.generalNativeBase=i}getBundle(t){return hl.get(t)||null}removeBundle(t){t._destroy(),hl.remove(t.name)}loadAny(t,e,i,n){const{options:s,onProgress:r,onComplete:o}=zw(e,i,n);s.preset=s.preset||"default",t=Array.isArray(t)?t.slice():t;const a=gl.create({input:t,onProgress:r,onComplete:Uw(o),options:s});_l.async(a)}preloadAny(t,e,i,n){const{options:s,onProgress:r,onComplete:o}=zw(e,i,n);s.preset=s.preset||"preload",t=Array.isArray(t)?t.slice():t;const a=gl.create({input:t,onProgress:r,onComplete:Uw(o),options:s});ul.async(a)}loadRemote(t,e,i){const{options:n,onComplete:s}=zw(e,void 0,i);n.reloadAsset||!this.assets.has(t)?(n.__isNative__=!0,n.preset=n.preset||"remote",this.loadAny({url:t},n,null,((e,i)=>{e?(x(e.message,e.stack),s&&s(e,i)):hI.create(t,i,n.ext||nh(t),n,((t,e)=>{s&&s(t,e)}))}))):Uw(s)(null,this.assets.get(t))}loadBundle(t,e,i){const{options:n,onComplete:s}=zw(e,void 0,i),r=rh(t);this.bundles.has(r)?Uw(s)(null,this.getBundle(r)):(n.preset=n.preset||"bundle",n.ext="bundle",n.__isNative__=!0,this.loadAny({url:t},n,null,((e,i)=>{e?(x(e.message,e.stack),s&&s(e,i)):hI.create(t,i,"bundle",n,((t,e)=>{s&&s(t,e)}))})))}releaseAsset(t){Rw.tryRelease(t,!0)}releaseUnusedAssets(){al.forEach((t=>{Rw.tryRelease(t)}))}releaseAll(){al.forEach((t=>{Rw.tryRelease(t,!0)}))}loadWithJson(t,e,i,n){throw new Error("Only valid in Editor")}}t("AssetManager",TI),TI.Pipeline=ol,TI.Task=gl,TI.Cache=rl,TI.RequestItem=SI,TI.Bundle=kw,TI.BuiltinBundleName=fl;var EI=t("assetManager",l.assetManager=new TI);l.AssetManager=TI;const PI=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],wI=[".mp3",".ogg",".wav",".m4a"];function II(){return!0}const RI={transformURL(t){const e=bl(t);if(!e)return t;const i=hl.find((t=>!!t.getAssetInfo(e)));if(!i)return t;let n="";const s=i.getAssetInfo(e);if(n=t.startsWith(i.base+i.config.nativeBase)?s.nativeVer||"":s.ver||"",!n||-1!==t.indexOf(n))return t;let r=!1;if(".ttf"===nh(t)&&(r=!0),r){const e=oh(t),i=rh(t);t=`${e}.${n}/${i}`}else t=t.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(t=>`${t}.${n}`));return t}};class DI{constructor(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=Vw}set onProgress(t){Dw=t}get _cache(){if(al instanceof rl)return al._map;{const t={};return al.forEach(((e,i)=>{t[i]=e})),t}}load(t,e,i){void 0===i&&void 0!==e&&(i=e,e=null);const n=Array.isArray(t)?t:[t];for(let t=0;t<n.length;t++){const e=n[t];"string"==typeof e?n[t]={url:e,__isNative__:!0}:(e.type&&(e.ext=`.${e.type}`,e.type=void 0),e.url&&(e.__isNative__=!0))}const s=[],r=[];EI.loadAny(n,null,((t,i,n)=>{n.content&&(PI.includes(n.ext)?s.push(n.content):wI.includes(n.ext)&&r.push(n.content)),e&&e(t,i,n)}),((t,e)=>{let o=null;if(!t){e=Array.isArray(e)?e:[e];for(let t=0;t<e.length;t++){const i=e[t];if(!(i instanceof fh)){let o=i;const a=n[t].url;s.includes(o)?hI.create(a,i,".png",{},((i,n)=>{o=e[t]=n})):r.includes(o)&&hI.create(a,i,".mp3",{},((i,n)=>{o=e[t]=n})),al.add(a,o)}}if(e.length>1){const t=Object.create(null);e.forEach((e=>{t[e._uuid]=e})),o={isCompleted:II,_map:t}}else o=e[0]}i&&i(t,o)}))}getXMLHttpRequest(){return new XMLHttpRequest}getItem(t){return EI.assets.has(t)?{content:EI.assets.get(t)}:null}loadRes(t,e,i,n){const{type:s,onProgress:r,onComplete:o}=this._parseLoadResArgs(e,i,n),a=nh(t);a&&!Hw.getInfoWithPath(t,s)&&(t=t.slice(0,-a.length)),Hw.load(t,s,r,o)}loadResArray(t,e,i,n){const{type:s,onProgress:r,onComplete:o}=this._parseLoadResArgs(e,i,n);t.forEach(((e,i)=>{const n=nh(e);n&&!Hw.getInfoWithPath(e,s)&&(t[i]=e.slice(0,-n.length))})),Hw.load(t,s,r,o)}loadResDir(t,e,i,n){const{type:s,onProgress:r,onComplete:o}=this._parseLoadResArgs(e,i,n);Hw.loadDir(t,s,r,((e,i)=>{let n=[];e||(n=Hw.getDirWithPath(t,s).map((t=>t.path))),o&&o(e,i,n)}))}getRes(t,e){return al.has(t)?al.get(t):Hw.get(t,e)}getResCount(){return al.count}getDependsRecursively(t){if(!t)return[];const e="string"==typeof t?t:t._uuid;return _f.getDepsRecursively(e).concat([e])}get md5Pipe(){return RI}get downloader(){return nI}get loader(){return EI.parser}addDownloadHandlers(t){const e=Object.create(null);for(const i in t){const n=t[i];e[`.${i}`]=(t,e,i)=>{n({url:t},i)}}nI.register(e)}addLoadHandlers(t){const e=Object.create(null);for(const i in t){const n=t[i];e[`.${i}`]=(t,e,i)=>{n({content:t},i)}}gI.register(e)}release(t){if(Array.isArray(t))for(let e=0;e<t.length;e++){let i=t[e];"string"==typeof i&&(i=al.get(i)),EI.releaseAsset(i)}else t&&("string"==typeof t&&(t=al.get(t)),EI.releaseAsset(t))}releaseAsset(t){EI.releaseAsset(t)}releaseRes(t,e){Hw.release(t,e)}releaseAll(){EI.releaseAll(),al.clear()}removeItem(t){return!!al.remove(t)}setAutoRelease(t,e){"object"==typeof t&&(t=t._uuid),this._autoReleaseSetting[t]=!!e}setAutoReleaseRecursively(t,e){"object"==typeof t&&(t=t._uuid),e=!!e,this._autoReleaseSetting[t]=e;const i=_f.getDepsRecursively(t);for(let t=0;t<i.length;t++)this._autoReleaseSetting[i[t]]=e}isAutoRelease(t){return"object"==typeof t&&(t=t._uuid),!!this._autoReleaseSetting[t]}}t("CCLoader",DI);const MI=t("loader",new DI),OI=t("AssetLibrary",{init(t){t.importBase=t.libraryPath,t.nativeBase=t.rawAssetsBase,EI.init(t),t.rawAssets&&Hw.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:fl.RESOURCES,importBase:t.importBase,nativeBase:t.nativeBase,paths:t.rawAssets.assets,uuids:Object.keys(t.rawAssets.assets),extensionMap:{}})},loadAsset(t,e,i){EI.loadAny(t,e)}}),BI=t("url",{});V(BI,"url",[{name:"normalize",target:EI.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:t=>t.startsWith("resources/")?wl({path:ah(t.substr(10)),bundle:fl.RESOURCES,__isNative__:!0,ext:nh(t)}):""}]),G(OI,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),G(MI,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"loader.assetLoader was removed, assetLoader and md5Pipe were merged into assetManager.transformPipeline"}]),V(l,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:()=>MI},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:()=>OI},{name:"Pipeline",target:TI,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:()=>BI}]),G(l,"cc",[{name:"LoadingItems",suggest:N(1400,"LoadingItems","AssetManager.Task")}]),V(Kt,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:nI,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),V(mw,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:t=>{var e;return EI.main?null===(e=EI.main.getSceneInfo(t))||void 0===e?void 0:e.uuid:""}}]),V(uw,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:()=>{const t=[];return EI.main&&EI.main.config.scenes.forEach((e=>{t.push(e)})),t}}]);const NI=Rw._autoRelease;var LI,FI,zI,VI,GI,UI,kI,HI,jI,WI,qI,XI,YI;Rw._autoRelease=function(t,e,i){NI.call(Rw,t,e,i);const n=MI._autoReleaseSetting,s=Object.keys(n);for(let t=0;t<s.length;t++){const e=s[t];if(!0===n[e]){const t=al.get(e);t&&Rw.tryRelease(t)}}};let KI=t("EventHandler",(LI=dc("cc.ClickEvent"),FI=Kc(l.Node),zI=Lc(),VI=Lc(),GI=Lc(),UI=Lc(),LI((jI=sc((HI=class t{constructor(){nc(this,"target",jI,this),nc(this,"component",WI,this),nc(this,"_componentId",qI,this),nc(this,"handler",XI,this),nc(this,"customEventData",YI,this)}get _componentName(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)}set _componentName(t){this._componentId=this._compName2Id(t)}static emitEvents(e,...i){for(let n=0,s=e.length;n<s;n++){const s=e[n];s instanceof t&&s.emit(i)}}emit(t){const e=this.target;if(!l.isValid(e))return;this._genCompIdIfNeeded();const i=l.js._getClassById(this._componentId),n=e.getComponent(i);if(!l.isValid(n))return;const s=n[this.handler];"function"==typeof s&&(null!=this.customEventData&&""!==this.customEventData&&(t=t.slice()).push(this.customEventData),s.apply(n,t))}_compName2Id(t){const e=l.js.getClassByName(t);return l.js._getClassId(e)}_compId2Name(t){const e=l.js._getClassById(t);return l.js.getClassName(e)}_genCompIdIfNeeded(){this._componentId||(this._componentName=this.component,this.component="")}}).prototype,"target",[Sc,FI,Sc,zI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WI=sc(HI.prototype,"component",[Sc,Mc,VI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qI=sc(HI.prototype,"_componentId",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),XI=sc(HI.prototype,"handler",[Sc,Mc,GI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),YI=sc(HI.prototype,"customEventData",[Sc,Mc,UI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),kI=HI))||kI));var JI,$I,ZI,QI,tR,eR,iR,nR,sR,rR,oR,aR,cR,lR,hR,_R,uR,dR,mR,pR,fR,gR,vR,yR,xR,SR,CR,AR,bR,TR,ER,PR,wR,IR,RR,DR,MR,OR,BR,NR,LR,FR,zR,VR,GR,UR,kR,HR,jR,WR,qR,XR,YR,KR,JR,$R,ZR,QR,tD,eD,iD,nD,sD,rD,oD,aD,cD,lD,hD,_D;l.Component.EventHandler=KI;const uD=new mi,dD=jt(tg),mD=jt(Qf),pD=jt(eg),fD=jt(ng),gD=jt(ig),vD=jt({SKYBOX:_g|Nn.DEPTH_STENCIL,SOLID_COLOR:Nn.ALL,DEPTH_ONLY:Nn.DEPTH_STENCIL,DONT_CLEAR:Nn.NONE});let yD=(JI=dc("cc.Camera"),$I=Dc(),ZI=Pc(),QI=kc(),tR=Lc(),eR=Kc(Yd.BitMask),iR=kc(),nR=Lc(),sR=Kc(vD),rR=kc(),oR=Lc(),aR=kc(),cR=Lc(),lR=kc(),hR=Lc(),_R=kc(),uR=Lc(),dR=Kc(dD),mR=kc(),pR=Lc(),fR=Kc(mD),gR=kc(),vR=Oc(),yR=Lc(),xR=kc(),SR=Oc(),CR=Lc(),AR=kc(),bR=Oc(),TR=Lc(),ER=kc(),PR=Lc(),wR=kc(),IR=Lc(),RR=Kc(pD),DR=kc(),MR=Lc(),OR=Kc(fD),BR=kc(),NR=Lc(),LR=Kc(gD),FR=kc(),zR=Lc(),VR=kc(),GR=Lc(),UR=Kc(nA),kR=kc(),HR=Lc(),xD=JI(jR=$I(jR=ZI(jR=Ec((_D=hD=class t extends Lh{constructor(...t){super(...t),nc(this,"_projection",qR,this),nc(this,"_priority",XR,this),nc(this,"_fov",YR,this),nc(this,"_fovAxis",KR,this),nc(this,"_orthoHeight",JR,this),nc(this,"_near",$R,this),nc(this,"_far",ZR,this),nc(this,"_color",QR,this),nc(this,"_depth",tD,this),nc(this,"_stencil",eD,this),nc(this,"_clearFlags",iD,this),nc(this,"_rect",nD,this),nc(this,"_aperture",sD,this),nc(this,"_shutter",rD,this),nc(this,"_iso",oD,this),nc(this,"_screenScale",aD,this),nc(this,"_visibility",cD,this),nc(this,"_targetTexture",lD,this),this._camera=null,this._inEditorMode=!1,this._flows=void 0}get camera(){return this._camera}get priority(){return this._priority}set priority(t){this._priority=t,this._camera&&(this._camera.priority=t)}get visibility(){return this._visibility}set visibility(t){this._visibility=t,this._camera&&(this._camera.visibility=t)}get clearFlags(){return this._clearFlags}set clearFlags(t){this._clearFlags=t,this._camera&&(this._camera.clearFlag=t)}get clearColor(){return this._color}set clearColor(t){this._color.set(t),this._camera&&(this._camera.clearColor=this._color)}get clearDepth(){return this._depth}set clearDepth(t){this._depth=t,this._camera&&(this._camera.clearDepth=t)}get clearStencil(){return this._stencil}set clearStencil(t){this._stencil=t,this._camera&&(this._camera.clearStencil=t)}get projection(){return this._projection}set projection(t){this._projection=t,this._camera&&(this._camera.projectionType=t)}get fovAxis(){return this._fovAxis}set fovAxis(t){t!==this._fovAxis&&(this._fovAxis=t,this._camera&&(this._camera.fovAxis=t,t===Qf.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}get fov(){return this._fov}set fov(t){this._fov=t,this._camera&&(this._camera.fov=Ye(t))}get orthoHeight(){return this._orthoHeight}set orthoHeight(t){this._orthoHeight=t,this._camera&&(this._camera.orthoHeight=t)}get near(){return this._near}set near(t){this._near=t,this._camera&&(this._camera.nearClip=t)}get far(){return this._far}set far(t){this._far=t,this._camera&&(this._camera.farClip=t)}get aperture(){return this._aperture}set aperture(t){this._aperture=t,this._camera&&(this._camera.aperture=t)}get shutter(){return this._shutter}set shutter(t){this._shutter=t,this._camera&&(this._camera.shutter=t)}get iso(){return this._iso}set iso(t){this._iso=t,this._camera&&(this._camera.iso=t)}get rect(){return this._rect}set rect(t){this._rect=t,this._camera&&this._camera.setViewportInOrientedSpace(t)}get targetTexture(){return this._targetTexture}set targetTexture(e){if(this._targetTexture===e)return;const i=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(i),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(t.TARGET_TEXTURE_CHANGE,this)}get screenScale(){return this._screenScale}set screenScale(t){this._screenScale=t,this._camera&&(this._camera.screenScale=t)}get inEditorMode(){return this._inEditorMode}set inEditorMode(t){this._inEditorMode=t,this._camera&&this._camera.changeTargetWindow(t?l.director.root&&l.director.root.mainWindow:l.director.root&&l.director.root.tempWindow)}onLoad(){this._createCamera()}onEnable(){this.node.hasChangedFlags|=bv.POSITION,this._camera&&this._attachToScene()}onDisable(){this._camera&&this._detachFromScene()}onDestroy(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}screenPointToRay(t,e,i){return i||(i=Wr.create()),this._camera&&this._camera.screenPointToRay(i,t,e),i}worldToScreen(t,e){return e||(e=new mi),this._camera&&this._camera.worldToScreen(e,t),e}screenToWorld(t,e){return e||(e=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(e,t),e}convertToUINode(t,e,i){if(i||(i=new mi),!this._camera)return i;this.worldToScreen(t,uD);const n=e.getComponent("cc.UITransform"),s=Aw.getVisibleSize(),r=uD.x-.5*this._camera.width,o=uD.y-.5*this._camera.height;return uD.x=r/l.view.getScaleX()+.5*s.width,uD.y=o/l.view.getScaleY()+.5*s.height,n&&n.convertToNodeSpaceAR(uD,i),i}_createCamera(){this._camera||(this._camera=l.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?l.director.root&&l.director.root.mainWindow:l.director.root&&l.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=Ye(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()}_attachToScene(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))}_detachFromScene(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)}_checkTargetTextureEvent(t){t&&t.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(t=>{this._camera&&this._camera.setFixedSize(t.width,t.height)}),this)}_updateTargetTexture(){if(this._camera&&this._targetTexture){const t=this._targetTexture.window;this._camera.changeTargetWindow(t),this._camera.setFixedSize(t.width,t.height)}}},hD.ProjectionType=dD,hD.FOVAxis=mD,hD.ClearFlag=vD,hD.Aperture=pD,hD.Shutter=fD,hD.ISO=gD,hD.TARGET_TEXTURE_CHANGE="tex-change",qR=sc((WR=_D).prototype,"_projection",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dD.PERSPECTIVE}}),XR=sc(WR.prototype,"_priority",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YR=sc(WR.prototype,"_fov",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),KR=sc(WR.prototype,"_fovAxis",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mD.VERTICAL}}),JR=sc(WR.prototype,"_orthoHeight",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),$R=sc(WR.prototype,"_near",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ZR=sc(WR.prototype,"_far",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),QR=sc(WR.prototype,"_color",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi("#333333")}}),tD=sc(WR.prototype,"_depth",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),eD=sc(WR.prototype,"_stencil",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iD=sc(WR.prototype,"_clearFlags",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vD.SOLID_COLOR}}),nD=sc(WR.prototype,"_rect",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki(0,0,1,1)}}),sD=sc(WR.prototype,"_aperture",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pD.F16_0}}),rD=sc(WR.prototype,"_shutter",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fD.D125}}),oD=sc(WR.prototype,"_iso",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gD.ISO100}}),aD=sc(WR.prototype,"_screenScale",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),cD=sc(WR.prototype,"_visibility",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ip}}),lD=sc(WR.prototype,"_targetTexture",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sc(WR.prototype,"priority",[QI,tR],Object.getOwnPropertyDescriptor(WR.prototype,"priority"),WR.prototype),sc(WR.prototype,"visibility",[eR,iR,nR],Object.getOwnPropertyDescriptor(WR.prototype,"visibility"),WR.prototype),sc(WR.prototype,"clearFlags",[sR,rR,oR],Object.getOwnPropertyDescriptor(WR.prototype,"clearFlags"),WR.prototype),sc(WR.prototype,"clearColor",[aR,cR],Object.getOwnPropertyDescriptor(WR.prototype,"clearColor"),WR.prototype),sc(WR.prototype,"clearDepth",[lR,hR],Object.getOwnPropertyDescriptor(WR.prototype,"clearDepth"),WR.prototype),sc(WR.prototype,"clearStencil",[_R,uR],Object.getOwnPropertyDescriptor(WR.prototype,"clearStencil"),WR.prototype),sc(WR.prototype,"projection",[dR,mR,pR],Object.getOwnPropertyDescriptor(WR.prototype,"projection"),WR.prototype),sc(WR.prototype,"fovAxis",[fR,gR,vR,yR],Object.getOwnPropertyDescriptor(WR.prototype,"fovAxis"),WR.prototype),sc(WR.prototype,"fov",[xR,SR,CR],Object.getOwnPropertyDescriptor(WR.prototype,"fov"),WR.prototype),sc(WR.prototype,"orthoHeight",[AR,bR,TR],Object.getOwnPropertyDescriptor(WR.prototype,"orthoHeight"),WR.prototype),sc(WR.prototype,"near",[ER,PR],Object.getOwnPropertyDescriptor(WR.prototype,"near"),WR.prototype),sc(WR.prototype,"far",[wR,IR],Object.getOwnPropertyDescriptor(WR.prototype,"far"),WR.prototype),sc(WR.prototype,"aperture",[RR,DR,MR],Object.getOwnPropertyDescriptor(WR.prototype,"aperture"),WR.prototype),sc(WR.prototype,"shutter",[OR,BR,NR],Object.getOwnPropertyDescriptor(WR.prototype,"shutter"),WR.prototype),sc(WR.prototype,"iso",[LR,FR,zR],Object.getOwnPropertyDescriptor(WR.prototype,"iso"),WR.prototype),sc(WR.prototype,"rect",[VR,GR],Object.getOwnPropertyDescriptor(WR.prototype,"rect"),WR.prototype),sc(WR.prototype,"targetTexture",[UR,kR,HR],Object.getOwnPropertyDescriptor(WR.prototype,"targetTexture"),WR.prototype),jR=WR))||jR)||jR)||jR)||jR,t({Camera:xD,CameraComponent:xD}),xD);var xD,SD,CD,AD,bD,TD,ED,PD,wD,ID;l.Camera=yD;const RD={parent:null,owner:null,subModelIdx:0};let DD=t("RenderableComponent",(SD=dc("cc.RenderableComponent"),CD=Kc(sg),AD=kc(),bD=Nc(),TD=Kc([sg]),SD((sc((PD=class extends Lh{constructor(...t){super(...t),nc(this,"_visFlags",wD,this),nc(this,"_materials",ID,this),this._materialInstances=[],this._models=[]}get visibility(){return this._visFlags}set visibility(t){this._visFlags=t,this._onVisibilityChange(t)}get sharedMaterial(){return this.getMaterial(0)}get sharedMaterials(){return this._materials}set sharedMaterials(t){for(let e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(let e=t.length;e<this._materials.length;e++)this.setMaterial(null,e);this._materials.splice(t.length)}}get material(){return this.getMaterialInstance(0)}set material(t){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==t)&&this.setMaterialInstance(t,0)}get materials(){for(let t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances}set materials(t){const e=t.length,i=this._materials.length;for(let t=e;t<i;t++)this.setMaterialInstance(null,t);this._materials.length=e,this._materialInstances.length=e;for(let i=0;i<e;i++)this._materialInstances[i]!=t[i]&&this.setMaterialInstance(t[i],i)}getMaterial(t){return t<0||t>=this._materials.length?null:this._materials[t]}setMaterial(t,e){t&&t instanceof dv&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;const i=this._materialInstances[e];i&&(i.destroy(),this._materialInstances[e]=null),this._onMaterialModified(e,this._materials[e])}getMaterialInstance(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){RD.parent=this._materials[t],RD.owner=this,RD.subModelIdx=t;const e=new dv(RD);RD.parent=null,RD.owner=null,RD.subModelIdx=0,this.setMaterialInstance(e,t)}return this._materialInstances[t]}setMaterialInstance(t,e){if("number"==typeof t){I(12007);const i=t;t=e,e=i}const i=this._materialInstances[e];t&&t.parent?t!==i&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):(t!==this._materials[e]||i)&&this.setMaterial(t,e)}getRenderMaterial(t){return this._materialInstances[t]||this._materials[t]}_collectModels(){return this._models}_attachToScene(){}_detachFromScene(){}_onMaterialModified(t,e){}_onRebuildPSO(t,e){}_clearMaterials(){}_onVisibilityChange(t){}}).prototype,"sharedMaterials",[CD,AD,bD],Object.getOwnPropertyDescriptor(PD.prototype,"sharedMaterials"),PD.prototype),wD=sc(PD.prototype,"_visFlags",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yd.Enum.NONE}}),ID=sc(PD.prototype,"_materials",[TD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ED=PD))||ED));l.RenderableComponent=DD,V(yD,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),V(yD.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),l.CameraComponent=yD,Ut.setClassAlias(yD,"cc.CameraComponent"),l.math=ji,l.geometry=qd;const MD=new mi,OD=new Ii;function BD(t,e,i,n){const s=i.chunk,r=i.data,o=s.vb,a=i.vertexCount;t.getWorldMatrix(OD);let c=0;for(let t=0;t<a;t++){const e=r[t];mi.set(MD,e.x,e.y,0),mi.transformMat4(MD,MD,OD),o[c++]=MD.x,o[c++]=MD.y,o[c++]=MD.z,hi.toArray(o,n,c+2),c+=6}const l=s.bufferId,h=s.vertexOffset,_=s.vertexAccessor.getMeshBuffer(s.bufferId),u=s.vertexAccessor.getIndexBuffer(l);let d=_.indexOffset;for(let t=0,e=a/4;t<e;t++){const e=h+4*t;u[d++]=e,u[d++]=e+1,u[d++]=e+2,u[d++]=e+1,u[d++]=e+3,u[d++]=e+2}_.indexOffset+=i.indexCount,_.setDirty()}const ND={};class LD{constructor(t,e){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;const i=new FD;i.initWithSize(t,e),this._texture=i,this._width=t,this._height=e,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}insertSpriteFrame(t){const e=t.rect,i=t.texture,n=this._innerTextureInfos[i.getId()];let s=e.x,r=e.y;if(n)s+=n.x,r+=n.y;else{const t=i.width,e=i.height;if(this._x+t+2>this._width&&(this._x=2,this._y=this._nexty),this._y+e+2>this._nexty&&(this._nexty=this._y+e+2),this._nexty>this._height)return null;l.internal.dynamicAtlasManager.textureBleeding&&((t<=8||e<=8)&&(this._texture.drawTextureAt(i.image,this._x-1,this._y-1),this._texture.drawTextureAt(i.image,this._x-1,this._y+1),this._texture.drawTextureAt(i.image,this._x+1,this._y-1),this._texture.drawTextureAt(i.image,this._x+1,this._y+1)),this._texture.drawTextureAt(i.image,this._x-1,this._y),this._texture.drawTextureAt(i.image,this._x+1,this._y),this._texture.drawTextureAt(i.image,this._x,this._y-1),this._texture.drawTextureAt(i.image,this._x,this._y+1)),this._texture.drawTextureAt(i.image,this._x,this._y),this._innerTextureInfos[i.getId()]={x:this._x,y:this._y,texture:i},this._count++,s+=this._x,r+=this._y,this._x+=t+2}const o={x:s,y:r,texture:this._texture};return this._innerSpriteFrames.push(t),o}deleteInnerTexture(t){t&&this._innerTextureInfos[t.getId()]&&(delete this._innerTextureInfos[t.getId()],this._count--)}isEmpty(){return this._count<=0}reset(){this._x=2,this._y=2,this._nexty=2;const t=this._innerSpriteFrames;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}}destroy(){this.reset(),this._texture.destroy()}}class FD extends xf{initWithSize(t,e,i=Np.RGBA8888){this.reset({width:t,height:e,format:i})}drawTextureAt(t,e,i){const n=this.getGFXTexture();if(!t||!n)return;const s=this._getGFXDevice();if(!s)return void console.warn("Unable to get device");const r=new qn;r.texOffset.x=e,r.texOffset.y=i,r.texExtent.width=t.width,r.texExtent.height=t.height,s.copyTexImagesToTexture([t.data],n,[r])}}class zD{constructor(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){this._enabled!==t&&(t?(this.reset(),l.director.on(l.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),l.director.off(l.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=t)}get maxAtlasCount(){return this._maxAtlasCount}set maxAtlasCount(t){this._maxAtlasCount=t}get atlasCount(){return this._atlases.length}get textureBleeding(){return this._textureBleeding}set textureBleeding(t){this._textureBleeding=t}get textureSize(){return this._textureSize}set textureSize(t){this._textureSize=t}get maxFrameSize(){return this._maxFrameSize}set maxFrameSize(t){this._maxFrameSize=t}newAtlas(){let t=this._atlases[++this._atlasIndex];return t||(t=new LD(this._textureSize,this._textureSize),this._atlases.push(t)),t}beforeSceneLoad(){this.reset()}insertSpriteFrame(t){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!t||t._original)return null;if(!t.packable)return null;const e=t.texture.getSamplerInfo();if(e.minFilter!==Fp.LINEAR||e.magFilter!==Fp.LINEAR||e.mipFilter!==Fp.NONE)return null;let i=this._atlases[this._atlasIndex];i||(i=this.newAtlas());const n=i.insertSpriteFrame(t);return n||this._atlasIndex===this._maxAtlasCount?n:(i=this.newAtlas(),i.insertSpriteFrame(t))}reset(){for(let t=0,e=this._atlases.length;t<e;t++)this._atlases[t].destroy();this._atlases.length=0,this._atlasIndex=-1}deleteAtlasSpriteFrame(t){if(!t._original)return;let e;for(let i=this._atlases.length-1;i>=0;i--)e=this._atlases[i],Ut.array.fastRemove(e._innerSpriteFrames,t);const i=t._original._texture;this.deleteAtlasTexture(i)}deleteAtlasTexture(t){if(t)for(let e=this._atlases.length-1;e>=0;e--)this._atlases[e].deleteInnerTexture(t),this._atlases[e].isEmpty()&&(this._atlases[e].destroy(),this._atlases.splice(e,1),this._atlasIndex--)}packToDynamicAtlas(t,e){if(e&&!e._original&&e.packable&&e.texture&&e.texture.width>0&&e.texture.height>0){const t=this.insertSpriteFrame(e);t&&e._setDynamicAtlasFrame(t)}}}zD.instance=void 0;const VD=t("dynamicAtlasManager",zD.instance=new zD);var GD,UD,kD;l.internal.dynamicAtlasManager=VD;const HD=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}];let jD=t("SpriteFrame",dc("cc.SpriteFrame")((kD=UD=class t extends fh{static createWithImage(e){const i=e instanceof rf?e:new rf(e),n=new xf;n.image=i;const s=new t;return s.texture=n,s}get insetTop(){return this._capInsets[1]}set insetTop(t){this._capInsets[1]!==t&&(this._capInsets[1]=t,this._texture&&this._calculateSlicedUV())}get insetBottom(){return this._capInsets[3]}set insetBottom(t){this._capInsets[3]!==t&&(this._capInsets[3]=t,this._texture&&this._calculateSlicedUV())}get insetLeft(){return this._capInsets[0]}set insetLeft(t){this._capInsets[0]!==t&&(this._capInsets[0]=t,this._texture&&this._calculateSlicedUV())}get insetRight(){return this._capInsets[2]}set insetRight(t){this._capInsets[2]!==t&&(this._capInsets[2]=t,this._texture&&this._calculateSlicedUV())}get rect(){return this._rect}set rect(t){this._rect.equals(t)||(this._rect.set(t),this._texture&&this._calculateUV())}get originalSize(){return this._originalSize}set originalSize(t){this._originalSize.equals(t)||(this._originalSize.set(t),this._texture&&this._calculateUV())}get offset(){return this._offset}set offset(t){this._offset.set(t)}get rotated(){return this._rotated}set rotated(t){this._rotated!==t&&(this._rotated=t,this._texture&&this._calculateUV())}get texture(){return this._texture}set texture(t){t?t!==this._texture&&this.reset({texture:t},!0):I(3122,this.name)}get atlasUuid(){return this._atlasUuid}set atlasUuid(t){this._atlasUuid=t}get width(){return this._texture.width}get height(){return this._texture.height}set _textureSource(t){window.Build?this._texture=t:t&&(this._refreshTexture(t),this._calculateUV())}get flipUVX(){return this._isFlipUVX}set flipUVX(t){this._isFlipUVX=t,this._calculateUV()}get flipUVY(){return this._isFlipUVY}set flipUVY(t){this._isFlipUVY=t,this._calculateUV()}get packable(){return this._packable}set packable(t){this._packable=t}get original(){return this._original}constructor(){super(),this.vertices=null,this.uv=[],this.unbiasUV=[],this.uvSliced=[],this._rect=new ki,this._offset=new Oi,this._originalSize=new Gi,this._rotated=!1,this._capInsets=[0,0,0,0],this._atlasUuid="",this._texture=void 0,this._isFlipUVY=!1,this._isFlipUVX=!1,this._original=null,this._packable=!0}textureLoaded(){return!!this.texture}isRotated(){return this._rotated}setRotated(t){this.rotated=t}getRect(t){return t?(t.set(this._rect),t):this._rect.clone()}setRect(t){this.rect=t}getOriginalSize(t){return t?(t.set(this._originalSize),t):this._originalSize.clone()}setOriginalSize(t){this.originalSize=t}getOffset(t){return t?(t.set(this._offset),t):this._offset.clone()}setOffset(t){this.offset=t}getGFXTexture(){return this._texture.getGFXTexture()}getGFXSampler(){return this._texture.getGFXSampler()}getHash(){return this._texture.getHash()}getSamplerInfo(){return this._texture.getSamplerInfo()}reset(t,e=!1){let i=!1;e&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,i=!0),t&&(t.texture&&(this._rect.x=this._rect.y=0,this._rect.width=t.texture.width,this._rect.height=t.texture.height,this._refreshTexture(t.texture),this.checkRect(this._texture)),t.originalSize&&this._originalSize.set(t.originalSize),t.rect&&this._rect.set(t.rect),t.offset&&this._offset.set(t.offset),void 0!==t.borderTop&&(this._capInsets[1]=t.borderTop),void 0!==t.borderBottom&&(this._capInsets[3]=t.borderBottom),void 0!==t.borderLeft&&(this._capInsets[0]=t.borderLeft),void 0!==t.borderRight&&(this._capInsets[2]=t.borderRight),void 0!==t.isRotate&&(this._rotated=!!t.isRotate),void 0!==t.isFlipUv&&(this._isFlipUVY=!!t.isFlipUv),i=!0),i&&this.texture&&this._calculateUV()}checkRect(t){const e=this._rect;let i=e.x,n=e.y;return this._rotated?(i+=e.height,n+=e.width):(i+=e.width,n+=e.height),i>t.width?(D(3300,`${this.name}/${t.name}`,i,t.width),!1):!(n>t.height&&(D(3301,`${this.name}/${t.name}`,n,t.height),1))}destroy(){return this._packable&&VD&&VD.deleteAtlasSpriteFrame(this),super.destroy()}_calculateSlicedUV(){const e=this._rect,i=this.texture,n=i.width,s=i.height,r=this._capInsets[0],o=this._capInsets[2],a=e.width-r-o,c=this._capInsets[1],l=this._capInsets[3],h=e.height-c-l,_=this.uvSliced;if(_.length=0,this._rotated){HD[0].u=e.x/n,HD[1].u=(e.x+l)/n,HD[2].u=(e.x+l+h)/n,HD[3].u=(e.x+e.height)/n,HD[3].v=e.y/s,HD[2].v=(e.y+r)/s,HD[1].v=(e.y+r+a)/s,HD[0].v=(e.y+e.width)/s;for(let t=0;t<4;++t){const e=HD[t];for(let t=0;t<4;++t){const i=HD[3-t];_.push({u:e.u,v:i.v})}}}else{HD[0].u=e.x/n,HD[1].u=(e.x+r)/n,HD[2].u=(e.x+r+a)/n,HD[3].u=(e.x+e.width)/n,HD[3].v=e.y/s,HD[2].v=(e.y+c)/s,HD[1].v=(e.y+c+h)/s,HD[0].v=(e.y+e.height)/s;for(let t=0;t<4;++t){const e=HD[t];for(let t=0;t<4;++t){const i=HD[t];_.push({u:i.u,v:e.v})}}}this.emit(t.EVENT_UV_UPDATED,this)}_calculateUV(){const t=this._rect,e=this.uv,i=this.unbiasUV,n=this.texture,s=n.width,r=n.height;if(this._rotated){const n=0===s?0:t.x/s,o=0===s?1:(t.x+t.height)/s,a=0===r?0:t.y/r,c=0===r?1:(t.y+t.width)/r;this._isFlipUVX&&this._isFlipUVY?(e[0]=o,e[1]=c,e[2]=o,e[3]=a,e[4]=n,e[5]=c,e[6]=n,e[7]=a):this._isFlipUVX?(e[0]=o,e[1]=a,e[2]=o,e[3]=c,e[4]=n,e[5]=a,e[6]=n,e[7]=c):this._isFlipUVY?(e[0]=n,e[1]=c,e[2]=n,e[3]=a,e[4]=o,e[5]=c,e[6]=o,e[7]=a):(e[0]=n,e[1]=a,e[2]=n,e[3]=c,e[4]=o,e[5]=a,e[6]=o,e[7]=c);const l=0===s?0:t.x/s,h=0===s?1:(t.x+t.height)/s,_=0===r?0:t.y/r,u=0===r?1:(t.y+t.width)/r;this._isFlipUVX&&this._isFlipUVY?(i[0]=h,i[1]=u,i[2]=h,i[3]=_,i[4]=l,i[5]=u,i[6]=l,i[7]=_):this._isFlipUVX?(i[0]=h,i[1]=_,i[2]=h,i[3]=u,i[4]=l,i[5]=_,i[6]=l,i[7]=u):this._isFlipUVY?(i[0]=l,i[1]=u,i[2]=l,i[3]=_,i[4]=h,i[5]=u,i[6]=h,i[7]=_):(i[0]=l,i[1]=_,i[2]=l,i[3]=u,i[4]=h,i[5]=_,i[6]=h,i[7]=u)}else{const n=0===s?0:t.x/s,o=0===s?1:(t.x+t.width)/s,a=0===r?1:(t.y+t.height)/r,c=0===r?0:t.y/r;this._isFlipUVX&&this._isFlipUVY?(e[0]=o,e[1]=c,e[2]=n,e[3]=c,e[4]=o,e[5]=a,e[6]=n,e[7]=a):this._isFlipUVX?(e[0]=o,e[1]=a,e[2]=n,e[3]=a,e[4]=o,e[5]=c,e[6]=n,e[7]=c):this._isFlipUVY?(e[0]=n,e[1]=c,e[2]=o,e[3]=c,e[4]=n,e[5]=a,e[6]=o,e[7]=a):(e[0]=n,e[1]=a,e[2]=o,e[3]=a,e[4]=n,e[5]=c,e[6]=o,e[7]=c);const l=0===s?0:t.x/s,h=0===s?1:(t.x+t.width)/s,_=0===r?1:(t.y+t.height)/r,u=0===r?0:t.y/r;this._isFlipUVX&&this._isFlipUVY?(i[0]=h,i[1]=u,i[2]=l,i[3]=u,i[4]=h,i[5]=_,i[6]=l,i[7]=_):this._isFlipUVX?(i[0]=h,i[1]=_,i[2]=l,i[3]=_,i[4]=h,i[5]=u,i[6]=l,i[7]=u):this._isFlipUVY?(i[0]=l,i[1]=u,i[2]=h,i[3]=u,i[4]=l,i[5]=_,i[6]=h,i[7]=_):(i[0]=l,i[1]=_,i[2]=h,i[3]=_,i[4]=l,i[5]=u,i[6]=h,i[7]=u)}const o=this.vertices;if(o){o.nu.length=0,o.nv.length=0;for(let t=0;t<o.u.length;t++)o.nu[t]=o.u[t]/s,o.nv[t]=o.v[t]/r}this._calculateSlicedUV()}_setDynamicAtlasFrame(t){t&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=t.texture,this._rect.x=t.x,this._rect.y=t.y,this._calculateUV())}_resetDynamicAtlasFrame(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())}_checkPackable(){const t=VD;if(!t)return;const e=this._texture;if(!(e instanceof xf)||e.isCompressed)return void(this._packable=!1);const i=this.width,n=this.height;!e.image||i>t.maxFrameSize||n>t.maxFrameSize?this._packable=!1:e.image&&e.image instanceof HTMLCanvasElement&&(this._packable=!0)}_serialize(t){return null}_deserialize(t,e){const i=t,n=i.rect;n&&(this._rect=new ki(n.x,n.y,n.width,n.height));const s=i.offset;i.offset&&(this._offset=new Oi(s.x,s.y));const r=i.originalSize;i.originalSize&&(this._originalSize=new Gi(r.width,r.height)),this._rotated=!!i.rotated,this._name=i.name,this._packable=!!i.packable;const o=i.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}clone(){var e,i,n,s;const r=new t,o=this.vertices;return r.vertices=o?{x:o.x,y:o.y,triangles:o.triangles,nu:null===(e=o.nu)||void 0===e?void 0:e.slice(0),u:null===(i=o.u)||void 0===i?void 0:i.slice(0),nv:null===(n=o.nv)||void 0===n?void 0:n.slice(0),v:null===(s=o.v)||void 0===s?void 0:s.slice(0)}:null,r.uv.splice(0,r.uv.length,...this.uv),r.unbiasUV.splice(0,r.unbiasUV.length,...this.unbiasUV),r.uvSliced.splice(0,r.uvSliced.length,...this.uvSliced),r._rect.set(this._rect),r._offset.set(this._offset),r._originalSize.set(this._originalSize),r._rotated=this._rotated,r._capInsets.splice(0,r._capInsets.length,...this._capInsets),r._atlasUuid=this._atlasUuid,r._texture=this._texture,r._isFlipUVX=this._isFlipUVX,r._isFlipUVY=this._isFlipUVY,r}_refreshTexture(t){this._texture=t;const e=this._texture,i={};let n=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(i.rect=new ki(0,0,e.width,e.height),n=!0),(0===this._originalSize.width||0===this._originalSize.height||n)&&(i.originalSize=new Gi(e.width,e.height),n=!0),n&&(this.reset(i),this.onLoaded()),this._checkPackable()}initDefault(t){super.initDefault(t);const e=new xf;e.initDefault(),this._refreshTexture(e),this._calculateUV()}validate(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height}},UD.EVENT_UV_UPDATED="uv_updated",GD=kD))||GD);var WD,qD,XD;l.SpriteFrame=jD;let YD=t("SpriteAtlas",dc("cc.SpriteAtlas")((XD=sc((qD=class extends fh{constructor(...t){super(...t),nc(this,"spriteFrames",XD,this)}getTexture(){const t=Object.keys(this.spriteFrames);if(t.length>0){const e=this.spriteFrames[t[0]];return e&&e.texture}return null}getSpriteFrame(t){const e=this.spriteFrames[t];return e?(e.name||(e.name=t),e):null}getSpriteFrames(){const t=[],e=this.spriteFrames;for(const i of Object.keys(e))t.push(e[i]);return t}_serialize(t){}_deserialize(t,e){const i=t;this._name=i.name;const n=i.spriteFrames;this.spriteFrames=ut();for(let t=0;t<n.length;t+=2)e.result.push(this.spriteFrames,n[t],n[t+1],zt(jD))}}).prototype,"spriteFrames",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ut()}}),WD=qD))||WD);var KD;l.SpriteAtlas=YD;let JD=t("Font",dc("cc.Font")(KD=class extends fh{})||KD);var $D,ZD,QD;l.Font=JD;let tM=t("TTFFont",dc("cc.TTFFont")((QD=sc((ZD=class extends JD{constructor(...t){super(...t),nc(this,"_fontFamily",QD,this)}get _nativeAsset(){return this._fontFamily}set _nativeAsset(t){this._fontFamily=t||"Arial"}get _nativeDep(){return{uuid:this._uuid,__nativeName__:this._native,ext:nh(this._native),__isNative__:!0}}initDefault(t){this._fontFamily="Arial",super.initDefault(t)}}).prototype,"_fontFamily",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sc(ZD.prototype,"_nativeAsset",[Jc,Yc],Object.getOwnPropertyDescriptor(ZD.prototype,"_nativeAsset"),ZD.prototype),sc(ZD.prototype,"_nativeDep",[Jc],Object.getOwnPropertyDescriptor(ZD.prototype,"_nativeDep"),ZD.prototype),$D=ZD))||$D);var eM,iM,nM,sM,rM,oM,aM,cM;l.TTFFont=tM;class lM{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0}}class hM{constructor(t){this.letterDefinitions={},this.texture=t}addLetterDefinitions(t,e){this.letterDefinitions[t]=e}cloneLetterDefinition(){const t={};for(const e of Object.keys(this.letterDefinitions)){const i=new lM;At(i,this.letterDefinitions[e]),t[e]=i}return t}getTexture(){return this.texture}getLetter(t){return this.letterDefinitions[t]}getLetterDefinitionForChar(t,e){const i=t.charCodeAt(0);let n;return n=this.letterDefinitions.hasOwnProperty(i)?this.letterDefinitions[i]:null,n}clear(){this.letterDefinitions={}}}let _M=t("BitmapFont",(eM=dc("cc.BitmapFont"),iM=Kc(jD),eM((rM=sc((sM=class extends JD{constructor(...t){super(...t),nc(this,"fntDataStr",rM,this),nc(this,"spriteFrame",oM,this),nc(this,"fontSize",aM,this),nc(this,"fntConfig",cM,this)}onLoaded(){const t=this.spriteFrame;!this.fontDefDictionary&&t&&(this.fontDefDictionary=new hM(t.texture));const e=this.fntConfig;if(!e)return void y("The fnt config is not exists!");const i=e.fontDefDictionary;for(const t in i){const e=new lM,n=i[t].rect;e.offsetX=i[t].xOffset,e.offsetY=i[t].yOffset,e.w=n.width,e.h=n.height,e.u=n.x,e.v=n.y,e.textureID=0,e.valid=!0,e.xAdvance=i[t].xAdvance,this.fontDefDictionary.addLetterDefinitions(t,e)}}}).prototype,"fntDataStr",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),oM=sc(sM.prototype,"spriteFrame",[iM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aM=sc(sM.prototype,"fontSize",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),cM=sc(sM.prototype,"fntConfig",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nM=sM))||nM));var uM;l.BitmapFont=_M;let dM=t("LabelAtlas",dc("cc.LabelAtlas")(uM=class extends _M{})||uM);l.LabelAtlas=dM;const mM=t("BASELINE_RATIO",.26),pM=t("MIDDLE_RATIO",(mM+1)/2-mM);const fM=new Vt(2);fM.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};const gM=new class{constructor(t){this.count=0,this.limit=0,this.datas={},this.limit=t}moveToHead(t){t.next=this.head,t.prev=null,this.head&&(this.head.prev=t),this.head=t,this.tail||(this.tail=t),this.count++,this.datas[t.key]=t}put(t,e){const i=fM.get();if(i.key=t,i.value=e,this.count>=this.limit){const t=this.tail;delete this.datas[t.key],this.count--,this.tail=t.prev,this.tail.next=null,t.prev=null,t.next=null,fM.put(t)}this.moveToHead(i)}remove(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,delete this.datas[t.key],this.count--}get(t){const e=this.datas[t];return e?(this.remove(e),this.moveToHead(e),e.value):null}clear(){this.count=0,this.datas={},this.head=null,this.tail=null}has(t){return!!this.datas[t]}delete(t){const e=this.datas[t];this.remove(e)}}(100),vM=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,yM=/^[!,.:;'}\]%\?>、‘“》？。，！]/,xM=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁёáàảạãăắằẳẵặâấầẩẫậéèẻẽẹêếềểễệiíìỉĩịóòỏõọôốồổỗộơớờởỡợúùủũụưứừửữựýỳỷỹỵđÁÀẢẠÃĂẮẰẲẴẶÂẤẦẨẪẬÉÈẺẼẸÊẾỀỂỄỆIÍÌỈĨỊÓÒỎÕỌÔỐỒỔỖỘƠỚỜỞỠỢÚÙỦŨỤƯỨỪỬỮỰÝỲỶỸỴĐ]+|\S)$/,SM=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁёáàảạãăắằẳẵặâấầẩẫậéèẻẽẹêếềểễệiíìỉĩịóòỏõọôốồổỗộơớờởỡợúùủũụưứừửữựýỳỷỹỵđÁÀẢẠÃĂẮẰẲẴẶÂẤẦẨẪẬÉÈẺẼẸÊẾỀỂỄỆIÍÌỈĨỊÓÒỎÕỌÔỐỒỔỖỘƠỚỜỞỠỢÚÙỦŨỤƯỨỪỬỮỰÝỲỶỸỴĐ]+$/,CM=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁёáàảạãăắằẳẵặâấầẩẫậéèẻẽẹêếềểễệiíìỉĩịóòỏõọôốồổỗộơớờởỡợúùủũụưứừửữựýỳỷỹỵđÁÀẢẠÃĂẮẰẲẴẶÂẤẦẨẪẬÉÈẺẼẸÊẾỀỂỄỆIÍÌỈĨỊÓÒỎÕỌÔỐỒỔỖỘƠỚỜỞỠỢÚÙỦŨỤƯỨỪỬỮỰÝỲỶỸỴĐ]/;function AM(t){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(t)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(t)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(t)}function bM(t){const e=t.charCodeAt(0);return e>=9&&e<=13||32===e||133===e||160===e||5760===e||e>=8192&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e}function TM(t,e,i){const n=`${i||t.font}🎮${e}`,s=gM.get(n);if(null!==s)return s;const r=t.measureText(e),o=r&&r.width||0;return gM.put(n,o),o}function EM(t,e,i){let n=e,s=i;const r=t[e];if(r>="\udc00"&&r<="\udfff"&&n--,void 0!==i)if(i-1!==e){const e=t[i-1];e>="\ud800"&&e<="\udbff"&&s--}else r>="\ud800"&&r<="\udbff"&&s++;return t.substring(n,s)}function PM(t){return CM.exec(t)}function wM(t){return SM.exec(t)}function IM(t,e,i,n){const s=[];if(0===t.length||i<0)return s.push(""),s;let r=t;for(;e>i&&r.length>1;){let t=r.length*(i/e)|0,o=EM(r,t),a=e-n(o),c=o,l=0,h=0;const _=100;for(;a>i&&h++<_;)t*=i/a,t|=0,o=EM(r,t),a=e-n(o);for(h=0;o&&a<=i&&h++<_;){const i=vM.exec(o);l=i?i[0].length:1,c=o,t+=l,o=EM(r,t),a=e-n(o)}t-=l,0===t?(t=1,c=EM(r,1)):1===t&&r[0]>="\ud800"&&r[0]<="\udbff"&&(t=2,c=EM(r,2));let u,d=EM(r,0,t);yM.test(c||o)&&(u=xM.exec(d),t-=u?u[0].length:0,0===t&&(t=1),c=EM(r,t),d=EM(r,0,t)),CM.test(c)&&(u=SM.exec(d),u&&d!==u[0]&&(t-=u[0].length,c=EM(r,t),d=EM(r,0,t))),0===s.length?s.push(d):(d=d.trim(),d.length>0&&s.push(d)),r=c||o,e=n(r)}return 0===s.length?s.push(r):(r=r.trim(),r.length>0&&s.push(r)),s}let RM;class DM{constructor(){this.pool=[]}static getInstance(){return RM||(RM=new DM),RM}get(){let t=this.pool.pop();if(!t){const e=document.createElement("canvas"),i=e.getContext("2d");t={canvas:e,context:i}}return t}put(t){this.pool.length>=Kt.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(t)}}t("CanvasPool",DM);const MM=hi.WHITE.clone();class OM{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0}}const BM=`rgba(255, 255, 255, ${(1/255).toFixed(3)})`;class NM{constructor(t,e){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=t,this.labelInfo=e,this.hash=t.charCodeAt(0)+e.hash}updateRenderData(){this._updateProperties(),this._updateTexture()}destroy(){this.image=null}_updateProperties(){if(this.data=DM.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;const t=TM(this.context,this.char,this.labelInfo.fontDesc),e=2*this.labelInfo.margin+2;this.width=parseFloat(t.toFixed(2))+e,this.height=(1+mM)*this.labelInfo.fontSize+e,this.offsetY=-this.labelInfo.fontSize*mM/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new rf),this.image.reset(this.canvas)}_updateTexture(){if(!this.context||!this.canvas)return;const t=this.context,e=this.labelInfo,i=this.canvas.width,n=this.canvas.height;t.textAlign="center",t.textBaseline="alphabetic",t.clearRect(0,0,i,n),t.fillStyle=BM,t.fillRect(0,0,i,n),t.font=e.fontDesc;const s=e.fontSize,r=i/2,o=n/2+s*pM+0*s,a=e.color;if(t.lineJoin="round",t.fillStyle=`rgba(${a.r}, ${a.g}, ${a.b}, 1)`,e.isOutlined){const i=e.out||MM;t.strokeStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${i.a/255})`,t.lineWidth=2*e.margin,t.strokeText(this.char,r,o)}t.fillText(this.char,r,o)}}class LM extends xf{initWithSize(t,e,i=Np.RGBA8888){this.reset({width:t,height:e,format:i})}drawTextureAt(t,e,i){const n=this.getGFXTexture();if(!t||!n)return;const s=this._getGFXDevice();if(!s)return void console.warn("Unable to get device");const r=new qn;r.texOffset.x=e,r.texOffset.y=i,r.texExtent.width=t.width,r.texExtent.height=t.height,s.copyTexImagesToTexture([t.data],n,[r])}}class FM{get width(){return this._width}get height(){return this._height}constructor(t,e){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;const i=new LM;i.initWithSize(t,e),this.fontDefDictionary=new hM(i),this._halfBleed=1,this._width=t,this._height=e,mw.on(dw.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}insertLetterTexture(t){const e=t.image,i=mw.root.device;if(!e||!this.fontDefDictionary||!i)return null;const n=e.width,s=e.height;if(this._x+n+0>this._width&&(this._x=0,this._y=this._nextY),this._y+s>this._nextY&&(this._nextY=this._y+s+0),this._nextY>this._height)return I(12100),null;this.fontDefDictionary.texture.drawTextureAt(e,this._x,this._y),this._dirty=!0;const r=new OM;return r.u=this._x+this._halfBleed,r.v=this._y+this._halfBleed,r.texture=this.fontDefDictionary.texture,r.valid=!0,r.w=t.width-2,r.h=t.height-2,r.xAdvance=r.w,r.offsetY=t.offsetY,this._x+=n+0,this.fontDefDictionary.addLetterDefinitions(t.hash,r),r}update(){this._dirty&&(this._dirty=!1)}reset(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()}destroy(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)}getTexture(){return this.fontDefDictionary.getTexture()}beforeSceneLoad(){this.clearAllCache()}clearAllCache(){this.destroy();const t=new LM;t.initWithSize(this._width,this._height),this.fontDefDictionary.texture=t}getLetter(t){return this.fontDefDictionary.letterDefinitions[t]}getLetterDefinitionForChar(t,e){const i=t.charCodeAt(0)+e.hash;let n=this.fontDefDictionary.letterDefinitions[i];if(!n){const i=new NM(t,e);i.updateRenderData(),n=this.insertLetterTexture(i),i.destroy()}return n}}const zM={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:hi.WHITE.clone(),isOutlined:!1,out:hi.WHITE.clone(),margin:0},VM=[new fs(Ln.ATTR_POSITION,Zi.RGB32F)],GM=[new fs(Ln.ATTR_POSITION,Zi.RGB32F),new fs(Ln.ATTR_COLOR,Zi.RGBA32F)],UM=[new fs(Ln.ATTR_POSITION,Zi.RGB32F),new fs(Ln.ATTR_TEX_COORD,Zi.RG32F),new fs(Ln.ATTR_COLOR,Zi.RGBA32F)],kM=[new fs(Ln.ATTR_POSITION,Zi.RGB32F),new fs(Ln.ATTR_TEX_COORD,Zi.RG32F),new fs(Ln.ATTR_COLOR,Zi.RGBA32F),new fs(Ln.ATTR_COLOR2,Zi.RGBA32F)];function HM(t){let e=0;for(let i=0;i<t.length;i++){const n=t[i];e+=Gs[n.format].count}return e}function jM(t){let e=0;for(let i=0;i<t.length;i++){const n=t[i];e+=Gs[n.format].size}return e}l.internal.vfmtPosUvColor=UM,l.internal.vfmtPosUvTwoColor=kM,t("UIVertexFormat",Object.freeze({__proto__:null,vfmt:VM,vfmtPosColor:GM,vfmtPosUvColor:UM,vfmtPosUvTwoColor:kM,getComponentPerVertex:HM,getAttributeStride:jM}));const WM=jM(UM)>>2,qM=new Ml((()=>({x:0,y:0,z:0,u:0,v:0,color:hi.WHITE.clone()})),128);let XM=null;class YM{get vertexCount(){return this._vc}get indexCount(){return this._ic}get stride(){return this._floatStride<<2}get floatStride(){return this._floatStride}get vertexFormat(){return this._vertexFormat}constructor(t=UM){this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=UM,this._floatStride=t===UM?WM:jM(t)>>2,this._vertexFormat=t}isValid(){return this._ic>0&&this.chunk.vertexAccessor}}t("BaseRenderData",YM);class KM extends YM{static add(t=UM,e){XM||(XM=new Ol((()=>new KM),32));const i=XM.add();return i._floatStride=t===UM?WM:jM(t)>>2,i._vertexFormat=t,e||(e=mw.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=e,i}static remove(t){const e=XM.data.indexOf(t);-1!==e&&(t.clear(),t._accessor=null,XM.removeAt(e))}get dataLength(){return this._data.length}set dataLength(t){const e=this._data;if(e.length!==t){const i=e.length;let n=0;for(n=t;n<i;n++)qM.free(e[n]);for(n=i;n<t;n++)e[n]=qM.alloc();e.length=t}}get data(){return this._data}constructor(t=UM,e){super(t),this.indices=null,this.vertDirty=!0,this.frame=void 0,this.layer=0,this.blendHash=-1,this.textureHash=0,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this._data=[],this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this._accessor=null,e||(e=mw.root.batcher2D.switchBufferAccessor(this._vertexFormat)),this._accessor=e}resize(t,e){t===this._vc&&e===this._ic&&this.chunk||(this._vc=t,this._ic=e,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(t,e),this.updateHash())}resizeAndCopy(t,e){if(t===this._vc&&e===this._ic&&this.chunk)return;this._vc=t,this._ic=e;const i=this.chunk;this.chunk=this._accessor.allocateChunk(t,e),i&&(this.chunk.vb.set(i.vb),this._accessor.recycleChunk(i)),this.updateHash()}getMeshBuffer(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null}updateNode(t){this.layer=t.node.layer,this.nodeDirty=!1,this.hashDirty=!0}updatePass(t){this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0}updateTexture(t){this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0}updateHash(){const t=`${this.chunk?this.chunk.bufferId:-1}${this.layer} ${this.blendHash} ${this.textureHash}`;this.dataHash=ur(t,666),this.hashDirty=!1}updateRenderData(t,e){if(this.passDirty&&(this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){const e=t.node.scene?t._getRenderScene():null;this.layer=t.node.layer,null!==e&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()}updateSizeNPivot(t,e,i,n){t===this._width&&e===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=t,this._height=e,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}clear(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0}}t("RenderData",KM);class JM extends YM{static add(t=UM){const e=$M.add();return e._floatStride=t===UM?WM:jM(t)>>2,e._vertexFormat=t,e}static remove(t){const e=$M.data.indexOf(t);-1!==e&&($M.data[e].clear(),$M.removeAt(e))}set formatByte(t){}get formatByte(){return this.stride}get floatStride(){return this._floatStride}get vDataOffset(){return this._byteLength>>>2}constructor(t=UM){super(t),this.isMeshBuffer=!0,this.vData=void 0,this.iData=void 0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this._byteLength=0,this._vertexBuffers=[],this._indexBuffer=null,this._iaPool=null,this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)}request(t,e){const i=this._byteLength+t*this.stride;return!!this.reserve(t,e)&&(this._vc+=t,this._ic+=e,this._byteLength=i,this.vertexRange=this._vc,this.indexRange=this._ic,!0)}reserve(t,e){const i=this._byteLength+t*this.stride,n=this.indexCount+e;if(t+this.vertexCount>65535)return!1;let s=this.vData.byteLength,r=this.iData.length,o=this.vData.length,a=this.iData.length;if(i>s||n>r){for(;s<i||r<n;)o*=2,a*=2,s=4*o,r=a;this._reallocBuffer(o,a)}return!0}resize(t,e){const i=t*this.stride;t>=0&&e>=0&&i<=this.vData.byteLength&&this.iData.length,this._vc=t,this._ic=e,this._byteLength=i,this.updateRange(0,t,0,e)}updateRange(t,e,i,n){e>=0&&n>=0&&e<=this._vc&&this._ic,this.vertexStart=t,this.indexStart=i,this.vertexRange=e,this.indexRange=n}requestIA(t){this._initIAInfo(t);const e=this._iaPool.add();return e.firstIndex=this.indexStart,e.indexCount=this.indexRange,e}uploadBuffers(){if(0===this._byteLength||!this._vertexBuffers[0]||!this._indexBuffer)return;const t=this._ic,e=new Float32Array(this.vData.buffer,0,this._byteLength>>2),i=new Uint16Array(this.iData.buffer,0,t),n=this._vertexBuffers[0];this._byteLength>n.size&&n.resize(this._byteLength),n.update(e);const s=t<<1;s>this._indexBuffer.size&&this._indexBuffer.resize(s),this._indexBuffer.update(i)}freeIAPool(){this._iaPool&&this._iaPool.reset()}reset(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()}clear(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)}_initIAInfo(t){if(!this._iaInfo){const e=this.stride,i=this._vertexBuffers;i.length||i.push(t.createBuffer(new Zn(en.VERTEX|en.TRANSFER_DST,rn.DEVICE,e,e)));const n=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=t.createBuffer(new Zn(en.INDEX|en.TRANSFER_DST,rn.DEVICE,n,n))),this._iaInfo=new vs(this._vertexFormat,i,this._indexBuffer),this._iaPool=new Ol((()=>t.createInputAssembler(this._iaInfo)),1,(t=>{t.destroy()}))}}_reallocBuffer(t,e){const i=this.vData;this.vData=new Float32Array(t),i&&this.vData.set(i,0);const n=this.iData;this.iData=new Uint16Array(e),n&&this.iData.set(n,0)}}t("MeshRenderData",JM);const $M=new Ol((()=>new JM),32);var ZM,QM,tO,eO,iO,nO,sO,rO,oO,aO,cO,lO,hO,_O;const uO=new Oi,dO=new Oi,mO=new mi,pO=new Ii,fO=new Ii,gO=new Ii,vO=new Ii(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),yO=new ki;let xO,SO=function(e){return t({UITransform:e,UITransformComponent:e}),e}((ZM=dc("cc.UITransform"),QM=Dc(),tO=pc(110),eO=Pc(),iO=kc(),nO=Lc(),sO=kc(),rO=Lc(),ZM(oO=QM(oO=tO(oO=eO(oO=fc(oO=Ec((_O=hO=class t extends Lh{constructor(...t){super(...t),this._priority=0,nc(this,"_contentSize",cO,this),nc(this,"_anchorPoint",lO,this)}get contentSize(){return this._contentSize}set contentSize(t){this._contentSize.equals(t)||(this._contentSize.set(t),this.node.emit(fx.SIZE_CHANGED),this._markRenderDataDirty())}get width(){return this._contentSize.width}set width(t){this._contentSize.width!==t&&(this._contentSize.width=t,this.node.emit(fx.SIZE_CHANGED),this._markRenderDataDirty())}get height(){return this._contentSize.height}set height(t){this.contentSize.height!==t&&(this._contentSize.height=t,this.node.emit(fx.SIZE_CHANGED),this._markRenderDataDirty())}get anchorPoint(){return this._anchorPoint}set anchorPoint(t){this._anchorPoint.equals(t)||(this._anchorPoint.set(t),this.node.emit(fx.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}get anchorX(){return this._anchorPoint.x}set anchorX(t){this._anchorPoint.x!==t&&(this._anchorPoint.x=t,this.node.emit(fx.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}get anchorY(){return this._anchorPoint.y}set anchorY(t){this._anchorPoint.y!==t&&(this._anchorPoint.y=t,this.node.emit(fx.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}get priority(){return this._priority}set priority(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?I(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}get visibility(){const t=mw.root.batcher2D.getFirstRenderCamera(this.node);return t?t.visibility:0}get cameraPriority(){const t=mw.root.batcher2D.getFirstRenderCamera(this.node);return t?t.priority:0}__preload(){this.node._uiProps.uiTransformComp=this}onLoad(){this.node.parent&&t.insertChangeMap(this.node.parent)}onEnable(){this.node.on(fx.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()}onDisable(){this.node.off(fx.PARENT_CHANGED,this._parentChanged,this)}onDestroy(){this.node._uiProps.uiTransformComp=null}setContentSize(t,e){const i=this._contentSize;if(void 0===e){if(je((t=t).width,i.width,ke)&&je(t.height,i.height,ke))return;i.width=t.width,i.height=t.height}else{if(je(t=t,i.width,ke)&&je(e,i.height,ke))return;i.width=t,i.height=e}this.node.emit(fx.SIZE_CHANGED),this._markRenderDataDirty()}setAnchorPoint(t,e){const i=this._anchorPoint;if(void 0===e){if((t=t).x===i.x&&t.y===i.y)return;i.x=t.x,i.y=t.y}else{if(t===i.x&&e===i.y)return;i.x=t,i.y=e}this.node.emit(fx.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()}isHit(t){const e=this._contentSize.width,i=this._contentSize.height,n=uO,s=dO,r=this._getRenderScene().cameras;for(let o=0;o<r.length;o++){const a=r[o];if(!(a.visibility&this.node.layer))continue;a.node.getWorldRT(pO);const c=pO.m12,l=pO.m13,h=fw.center;if(pO.m12=h.x-(pO.m00*c+pO.m04*l),pO.m13=h.y-(pO.m01*c+pO.m05*l),Ii.invert(pO,pO),Oi.transformMat4(n,t,pO),this.node.getWorldMatrix(gO),Ii.invert(pO,gO),Ii.strictEquals(pO,vO))continue;Oi.transformMat4(s,n,pO),s.x+=this._anchorPoint.x*e,s.y+=this._anchorPoint.y*i;let _=!1;if(s.x>=0&&s.y>=0&&s.x<=e&&s.y<=i&&(_=this._maskTest(n)),_)return!0}return!1}hitTest(t){const e=this._contentSize.width,i=this._contentSize.height,n=mO,s=uO,r=dO,o=this._getRenderScene().cameras;for(let a=0;a<o.length;a++){const c=o[a];if(!(c.visibility&this.node.layer))continue;if(mi.set(n,t.x,t.y,0),c.screenToWorld(n,n),Oi.set(s,n.x,n.y),this.node.getWorldMatrix(gO),Ii.invert(pO,gO),Ii.strictEquals(pO,vO))continue;Oi.transformMat4(r,s,pO),r.x+=this._anchorPoint.x*e,r.y+=this._anchorPoint.y*i;let l=!1;if(r.x>=0&&r.y>=0&&r.x<=e&&r.y<=i&&(l=this._maskTest(s)),l)return!0}return!1}_maskTest(t){var e,i;const n=null===(e=this.node)||void 0===e||null===(i=e.eventProcessor)||void 0===i?void 0:i.maskList;if(n){let e=this.node;const i=n.length;for(let s=0,r=0;e&&r<i;++s,e=e.parent){const i=n[r];if(s===i.index){if(e!==i.comp.node){n.length=r;break}{const e=i.comp;if(e&&e._enabled&&!e.isHit(t))return!1;r++}}else if(s>i.index){n.length=r;break}}}return!0}convertToNodeSpaceAR(t,e){return this.node.getWorldMatrix(gO),Ii.invert(pO,gO),e||(e=new mi),mi.transformMat4(e,t,pO)}convertToWorldSpaceAR(t,e){return this.node.getWorldMatrix(gO),e||(e=new mi),mi.transformMat4(e,t,gO)}getBoundingBox(){Ii.fromRTS(fO,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const t=this._contentSize.width,e=this._contentSize.height,i=new ki(-this._anchorPoint.x*t,-this._anchorPoint.y*e,t,e);return i.transformMat4(fO),i}getBoundingBoxToWorld(){return this.node.parent?(this.node.parent.getWorldMatrix(gO),this.getBoundingBoxTo(gO)):this.getBoundingBox()}getBoundingBoxTo(e){Ii.fromRTS(fO,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const i=this._contentSize.width,n=this._contentSize.height,s=new ki(-this._anchorPoint.x*i,-this._anchorPoint.y*n,i,n);if(Ii.multiply(gO,e,fO),s.transformMat4(gO),!this.node.children)return s;const r=this.node.children;for(const i of r)if(i&&i.active){const n=i.getComponent(t);if(n){const t=n.getBoundingBoxTo(e);t&&ki.union(s,s,t)}}return s}getComputeAABB(t){const e=this._contentSize.width,i=this._contentSize.height;yO.set(-this._anchorPoint.x*e,-this._anchorPoint.y*i,e,i),yO.transformMat4(this.node.worldMatrix);const n=yO.x+.5*yO.width,s=yO.y+.5*yO.height,r=this.node.worldPosition.z,o=yO.width/2,a=yO.height/2;return null!=t?(La.set(t,n,s,r,o,a,.001),t):new La(n,s,r,o,a,.001)}_parentChanged(e){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)}_markRenderDataDirty(){const t=this.node._uiProps.uiComp;t&&(t.markForUpdateRenderData(),t.renderData&&(t.renderData.vertDirty=!0))}static insertChangeMap(e){const i=e.uuid;t.priorityChangeNodeMap.has(i)||t.priorityChangeNodeMap.set(i,e)}static _sortChildrenSibling(t){const e=t.children;e&&e.sort(((t,e)=>{const i=t._uiProps.uiTransformComp,n=e._uiProps.uiTransformComp,s=(i?i._priority:0)-(n?n._priority:0);return 0===s?t.getSiblingIndex()-e.getSiblingIndex():s}))}static _sortSiblings(){t.priorityChangeNodeMap.forEach((e=>{t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()}static _cleanChangeMap(){t.priorityChangeNodeMap.clear()}},hO.EventType=fx,hO.priorityChangeNodeMap=new Map,sc((aO=_O).prototype,"contentSize",[iO,nO],Object.getOwnPropertyDescriptor(aO.prototype,"contentSize"),aO.prototype),sc(aO.prototype,"anchorPoint",[sO,rO],Object.getOwnPropertyDescriptor(aO.prototype,"anchorPoint"),aO.prototype),cO=sc(aO.prototype,"_contentSize",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi(100,100)}}),lO=sc(aO.prototype,"_anchorPoint",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi(.5,.5)}}),oO=aO))||oO)||oO)||oO)||oO)||oO)||oO));mw.on(dw.EVENT_AFTER_UPDATE,SO._sortSiblings),mw.on(dw.EVENT_BEFORE_SCENE_LAUNCH,SO._cleanChangeMap),function(t){t[t.DISABLED=0]="DISABLED",t[t.CLEAR=1]="CLEAR",t[t.ENTER_LEVEL=2]="ENTER_LEVEL",t[t.ENABLED=3]="ENABLED",t[t.EXIT_LEVEL=4]="EXIT_LEVEL",t[t.CLEAR_INVERTED=5]="CLEAR_INVERTED",t[t.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(xO||(xO={}));class CO{constructor(){this.stage=xO.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:mn.ALWAYS,stencilMask:65535,writeMask:65535,failOp:pn.KEEP,zFailOp:pn.KEEP,passOp:pn.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}get pattern(){return this._stencilPattern}pushMask(t){this._maskStack.push(t)}clear(t){t.stencilStage=t.inverted?xO.CLEAR_INVERTED:xO.CLEAR}enterLevel(t){t.graphics.stencilStage=t.inverted?xO.ENTER_LEVEL_INVERTED:xO.ENTER_LEVEL}enableMask(){this.stage=xO.ENABLED}exitMask(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=xO.DISABLED:this.stage=xO.ENABLED)}getWriteMask(){return 1<<this._maskStack.length-1}getExitWriteMask(){return 1<<this._maskStack.length}getStencilRef(){let t=0;for(let e=0;e<this._maskStack.length;++e)t+=1<<e;return t}reset(){this._maskStack.length=0,this.stage=xO.DISABLED}destroy(){this.stencilStateMap.forEach((t=>{t.destroy()})),this.stencilStateMap.clear()}getStencilStage(t,e){let i=0,n=!1,s=!1,r=mn.LESS,o=this.stencilStateMap;if(e&&e.passes[0]){const a=e.passes[0].depthStencilState;let c=0,l=0;a.depthTest&&(c=1),a.depthWrite&&(l=1),i=c|l<<1|a.depthFunc<<2|t<<6|this._maskStack.length<<9,n=a.depthTest,s=a.depthWrite,r=a.depthFunc,o=this.stencilStateMapWithDepth}else i=t<<16|this._maskStack.length;if(o&&o.has(i))return o.get(i);this.setStateFromStage(t);const a=new wr(n,s,r,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return o.set(i,a),a}getStencilHash(t){return t<<8|this._maskStack.length}setStateFromStage(t){const e=this._stencilPattern;t===xO.DISABLED?(e.stencilTest=!1,e.func=mn.ALWAYS,e.failOp=pn.KEEP,e.stencilMask=e.writeMask=65535,e.ref=1):(e.stencilTest=!0,t===xO.ENABLED?(e.func=mn.EQUAL,e.failOp=pn.KEEP,e.stencilMask=e.ref=this.getStencilRef(),e.writeMask=this.getWriteMask()):t===xO.CLEAR?(e.func=mn.NEVER,e.failOp=pn.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===xO.CLEAR_INVERTED||t===xO.ENTER_LEVEL?(e.func=mn.NEVER,e.failOp=pn.REPLACE,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===xO.ENTER_LEVEL_INVERTED&&(e.func=mn.NEVER,e.failOp=pn.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()))}}var AO,bO,TO,EO,PO,wO,IO,RO,DO,MO,OO,BO,NO,LO,FO,zO,VO,GO,UO;let kO;t("StencilManager",CO),CO.sharedManager=null,CO.sharedManager=new CO,Xt(fn),function(t){t[t.ADD_COLOR=0]="ADD_COLOR",t[t.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",t[t.GRAYSCALE=2]="GRAYSCALE",t[t.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",t[t.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(kO||(kO=t("InstanceMaterialType",{})));let HO=function(e){return t({Renderable2D:e,RenderComponent:e,UIRenderable:e}),e}((AO=dc("cc.Renderable2D"),bO=mc(SO),TO=Oc(),EO=Kc(sg),PO=Kc(sg),wO=kc(),IO=Lc(),RO=Nc(),DO=kc(),MO=Lc(),AO(OO=bO(OO=fc(OO=Ec((UO=GO=class t extends DD{constructor(...t){super(...t),nc(this,"_materials",NO,this),nc(this,"_customMaterial",LO,this),this.stencilStage=xO.DISABLED,nc(this,"_srcBlendFactor",FO,this),nc(this,"_dstBlendFactor",zO,this),nc(this,"_color",VO,this),this._assembler=null,this._postAssembler=null,this._renderData=null,this._renderDataFlag=!0,this._renderFlag=!0,this._delegateSrc=null,this._instanceMaterialType=-1,this._blendState=new Er,this._blendHash=0,this._useVertexOpacity=!1,this._lastParent=null}get sharedMaterials(){return this._materials}set sharedMaterials(t){for(let e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(let e=t.length;e<this._materials.length;e++)this.setMaterial(null,e);this._materials.splice(t.length)}}get customMaterial(){return this._customMaterial}set customMaterial(t){this._customMaterial=t,this.updateMaterial()}get color(){return this._color}set color(t){this._color.equals(t)||(this._color.set(t),this._updateColor())}get renderData(){return this._renderData}set delegateSrc(t){this._delegateSrc=t}get blendHash(){return this._blendHash}get useVertexOpacity(){return this._useVertexOpacity}updateBlendHash(){const t=this._blendState.targets[0].blendDst<<4;this._blendHash=t|this._blendState.targets[0].blendSrc}__preload(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()}onEnable(){this.node.on(fx.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(fx.SIZE_CHANGED,this._nodeStateChange,this),this.node.on(fx.PARENT_CHANGED,this._colorDirty,this),this.updateMaterial(),this._renderFlag=this._canRender(),this._colorDirty()}onRestore(){this.updateMaterial(),this.markForUpdateRenderData()}onDisable(){this.node.off(fx.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(fx.SIZE_CHANGED,this._nodeStateChange,this),this.node.off(fx.PARENT_CHANGED,this._colorDirty,this),this._renderFlag=!1}onDestroy(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(let t=0;t<this._materialInstances.length;t++){const e=this._materialInstances[t];e&&e.destroy()}this._blendState&&this._blendState.destroy()}markForUpdateRenderData(t=!0){if(this._renderFlag=this._canRender(),t){const e=this._renderData;e&&(e.vertDirty=!0),this._renderDataFlag=t}else this._renderDataFlag=t}requestRenderData(){const t=KM.add();return this._renderData=t,t}destroyRenderData(){this._renderData&&(KM.remove(this._renderData),this._renderData=null)}updateAssembler(t){this._renderDataFlag&&(this._assembler.updateRenderData(this,t),this._renderDataFlag=!1),this._renderFlag&&this._render(t)}postUpdateAssembler(t){this._postAssembler&&this._renderFlag&&this._postRender(t)}_render(t){}_postRender(t){}_canRender(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0}_postCanRender(){}updateMaterial(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);const t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._renderData&&(this._renderData.material=t,this.markForUpdateRenderData()),this._updateBlendFunc()}_updateColor(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())}_updateBlendFunc(){let t=this._blendState.targets[0];t||(t=new Tr,this._blendState.setTarget(0,t)),t.blendDst===this._dstBlendFactor&&t.blendSrc===this._srcBlendFactor||(t.blend=!0,t.blendDstAlpha=fn.ONE_MINUS_SRC_ALPHA,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()}getBlendState(){return this._blendState}_nodeStateChange(e){this._renderData&&this.markForUpdateRenderData();for(let e=0;e<this.node.children.length;++e){const i=this.node.children[e].getComponent(t);i&&i.markForUpdateRenderData()}}_colorDirty(){this.node._uiProps.colorDirty=!0}_onMaterialModified(t,e){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),super._onMaterialModified(t,e)}_updateBuiltinMaterial(){let t;switch(this._instanceMaterialType){case kO.ADD_COLOR:t=Mf.get("ui-base-material");break;case kO.GRAYSCALE:t=Mf.get("ui-sprite-gray-material");break;case kO.USE_ALPHA_SEPARATED:t=Mf.get("ui-sprite-alpha-sep-material");break;case kO.USE_ALPHA_SEPARATED_AND_GRAY:t=Mf.get("ui-sprite-gray-alpha-sep-material");break;default:t=Mf.get("ui-sprite-material")}return t}setNodeDirty(){this.renderData&&(this.renderData.nodeDirty=!0)}setTextureDirty(){this.renderData&&(this.renderData.textureDirty=!0)}},GO.BlendState=fn,GO.Assembler=null,GO.PostAssembler=null,NO=sc((BO=UO).prototype,"_materials",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sc(BO.prototype,"sharedMaterials",[Jc,TO],Object.getOwnPropertyDescriptor(BO.prototype,"sharedMaterials"),BO.prototype),LO=sc(BO.prototype,"_customMaterial",[EO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sc(BO.prototype,"customMaterial",[PO,wO,IO,RO,jc],Object.getOwnPropertyDescriptor(BO.prototype,"customMaterial"),BO.prototype),sc(BO.prototype,"color",[DO,MO],Object.getOwnPropertyDescriptor(BO.prototype,"color"),BO.prototype),FO=sc(BO.prototype,"_srcBlendFactor",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fn.SRC_ALPHA}}),zO=sc(BO.prototype,"_dstBlendFactor",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fn.ONE_MINUS_SRC_ALPHA}}),VO=sc(BO.prototype,"_color",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hi.WHITE.clone()}}),OO=BO))||OO)||OO)||OO)||OO));var jO,WO,qO,XO,YO,KO,JO,$O,ZO,QO,tB,eB,iB,nB,sB,rB,oB,aB,cB,lB,hB,_B,uB,dB,mB,pB,fB,gB,vB,yB,xB,SB,CB,AB,bB,TB,EB,PB,wB,IB,RB,DB,MB,OB,BB,NB,LB,FB,zB,VB,GB,UB,kB,HB,jB,WB,qB,XB,YB,KB,JB,$B,ZB,QB,tN,eN;let iN,nN,sN,rN;l.internal.Renderable2D=HO,function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(iN||(iN=t("HorizontalTextAlignment",{}))),Xt(iN),function(t){t[t.TOP=0]="TOP",t[t.CENTER=1]="CENTER",t[t.BOTTOM=2]="BOTTOM"}(nN||(nN=t("VerticalTextAlignment",{}))),Xt(nN),function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.SHRINK=2]="SHRINK",t[t.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(sN||(sN=t("Overflow",{}))),Xt(sN),function(t){t[t.NONE=0]="NONE",t[t.BITMAP=1]="BITMAP",t[t.CHAR=2]="CHAR"}(rN||(rN=t("CacheMode",{}))),Xt(rN);let oN,aN,cN,lN=function(e){return t({Label:e,LabelComponent:e}),e}((jO=dc("cc.Label"),WO=Dc(),qO=pc(110),XO=Pc(),YO=kc(),KO=Lc(),JO=Kc(iN),$O=kc(),ZO=Lc(),QO=Kc(nN),tB=kc(),eB=Lc(),iB=kc(),nB=Lc(),sB=kc(),rB=Oc(),oB=Lc(),aB=kc(),cB=Lc(),lB=Oc(),hB=kc(),_B=Lc(),uB=Kc(sN),dB=kc(),mB=Lc(),pB=kc(),fB=Lc(),gB=Kc(JD),vB=kc(),yB=Oc(),xB=Lc(),SB=kc(),CB=Lc(),AB=Kc(rN),bB=kc(),TB=Lc(),EB=kc(),PB=Lc(),wB=kc(),IB=Lc(),RB=kc(),DB=Lc(),MB=Oc(),OB=kc(),BB=Lc(),jO(NB=WO(NB=qO(NB=XO((eN=tN=class t extends HO{get string(){return this._string}set string(t){t=null==t?"":t.toString(),this._string!==t&&(this._string=t,this.updateRenderData())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(t){this._horizontalAlign!==t&&(this._horizontalAlign=t,this.updateRenderData())}get verticalAlign(){return this._verticalAlign}set verticalAlign(t){this._verticalAlign!==t&&(this._verticalAlign=t,this.updateRenderData())}get actualFontSize(){return this._actualFontSize}set actualFontSize(t){this._actualFontSize=t}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this.updateRenderData())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this.updateRenderData())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this.updateRenderData())}get spacingX(){return this._spacingX}set spacingX(t){this._spacingX!==t&&(this._spacingX=t,this.updateRenderData())}get overflow(){return this._overflow}set overflow(t){this._overflow!==t&&(this._overflow=t,this.updateRenderData())}get enableWrapText(){return this._enableWrapText}set enableWrapText(t){this._enableWrapText!==t&&(this._enableWrapText=t,this.updateRenderData())}get font(){return this._font}set font(t){this._font!==t&&(this._isSystemFontUsed=!t,this._font=t,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(t){this._isSystemFontUsed!==t&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!t,t&&(this.font=null),this._flushAssembler(),this.updateRenderData())}get cacheMode(){return this._cacheMode}set cacheMode(t){this._cacheMode!==t&&(this._cacheMode!==rN.BITMAP||this._font instanceof _M||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===rN.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=t,this.updateRenderData(!0))}get isBold(){return this._isBold}set isBold(t){this._isBold!==t&&(this._isBold=t,this.updateRenderData())}get isItalic(){return this._isItalic}set isItalic(t){this._isItalic!==t&&(this._isItalic=t,this.updateRenderData())}get isUnderline(){return this._isUnderline}set isUnderline(t){this._isUnderline!==t&&(this._isUnderline=t,this.updateRenderData())}get underlineHeight(){return this._underlineHeight}set underlineHeight(t){this._underlineHeight!==t&&(this._underlineHeight=t,this.updateRenderData())}get spriteFrame(){return this._texture}get ttfSpriteFrame(){return this._ttfSpriteFrame}get assemblerData(){return this._assemblerData}get fontAtlas(){return this._fontAtlas}set fontAtlas(t){this._fontAtlas=t}get _bmFontOriginalSize(){return this._font instanceof _M?this._font.fontSize:-1}constructor(){super(),nc(this,"_string",FB,this),nc(this,"_horizontalAlign",zB,this),nc(this,"_verticalAlign",VB,this),nc(this,"_actualFontSize",GB,this),nc(this,"_fontSize",UB,this),nc(this,"_fontFamily",kB,this),nc(this,"_lineHeight",HB,this),nc(this,"_overflow",jB,this),nc(this,"_enableWrapText",WB,this),nc(this,"_font",qB,this),nc(this,"_isSystemFontUsed",XB,this),nc(this,"_spacingX",YB,this),nc(this,"_isItalic",KB,this),nc(this,"_isBold",JB,this),nc(this,"_isUnderline",$B,this),nc(this,"_underlineHeight",ZB,this),nc(this,"_cacheMode",QB,this),this._N$file=null,this._texture=null,this._ttfSpriteFrame=null,this._userDefinedFont=null,this._assemblerData=null,this._fontAtlas=null,this._letterTexture=null,this._ttfSpriteFrame=null}onEnable(){super.onEnable(),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()}onDestroy(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();const t=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),t){const e=t;e.image&&e.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,super.onDestroy()}updateRenderData(t=!1){this.markForUpdateRenderData(),t&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))}_render(t){t.commitComp(this,this.renderData,this._texture,this._assembler,null)}_updateColor(){super._updateColor(),this.updateRenderData(!1)}_canRender(){if(!super._canRender()||!this._string)return!1;const t=this._font;if(t&&t instanceof _M){const e=t.spriteFrame;if(!e||!e.texture)return!1}return!0}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)}_applyFontTexture(){this.markForUpdateRenderData();const t=this._font;if(t instanceof _M){const e=t.spriteFrame;e&&e.texture&&(this._texture=e,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===rN.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new jD,this._assemblerData=this._assembler.getAssemblerData();const t=new rf(this._assemblerData.canvas),e=new xf;e.image=t,this._ttfSpriteFrame.texture=e}this.cacheMode!==rN.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}}changeMaterialForDefine(){if(!this._texture)return;let t=!1;if(this.cacheMode!==rN.CHAR){const e=this._texture.texture;if(e instanceof Zp){const i=e.getPixelFormat();t=i===Np.RGBA_ETC1||i===Np.RGB_A_PVRTC_4BPPV1||i===Np.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=t?kO.USE_ALPHA_SEPARATED:kO.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}_updateBlendFunc(){super._updateBlendFunc()}},tN.HorizontalAlign=iN,tN.VerticalAlign=nN,tN.Overflow=sN,tN.CacheMode=rN,tN._canvasPool=DM.getInstance(),sc((LB=eN).prototype,"string",[YO,KO,Hc],Object.getOwnPropertyDescriptor(LB.prototype,"string"),LB.prototype),sc(LB.prototype,"horizontalAlign",[JO,$O,ZO],Object.getOwnPropertyDescriptor(LB.prototype,"horizontalAlign"),LB.prototype),sc(LB.prototype,"verticalAlign",[QO,tB,eB],Object.getOwnPropertyDescriptor(LB.prototype,"verticalAlign"),LB.prototype),sc(LB.prototype,"fontSize",[iB,nB],Object.getOwnPropertyDescriptor(LB.prototype,"fontSize"),LB.prototype),sc(LB.prototype,"fontFamily",[sB,rB,oB],Object.getOwnPropertyDescriptor(LB.prototype,"fontFamily"),LB.prototype),sc(LB.prototype,"lineHeight",[aB,cB],Object.getOwnPropertyDescriptor(LB.prototype,"lineHeight"),LB.prototype),sc(LB.prototype,"spacingX",[lB,hB,_B],Object.getOwnPropertyDescriptor(LB.prototype,"spacingX"),LB.prototype),sc(LB.prototype,"overflow",[uB,dB,mB],Object.getOwnPropertyDescriptor(LB.prototype,"overflow"),LB.prototype),sc(LB.prototype,"enableWrapText",[pB,fB],Object.getOwnPropertyDescriptor(LB.prototype,"enableWrapText"),LB.prototype),sc(LB.prototype,"font",[gB,vB,yB,xB],Object.getOwnPropertyDescriptor(LB.prototype,"font"),LB.prototype),sc(LB.prototype,"useSystemFont",[SB,CB],Object.getOwnPropertyDescriptor(LB.prototype,"useSystemFont"),LB.prototype),sc(LB.prototype,"cacheMode",[AB,bB,TB],Object.getOwnPropertyDescriptor(LB.prototype,"cacheMode"),LB.prototype),sc(LB.prototype,"isBold",[EB,PB],Object.getOwnPropertyDescriptor(LB.prototype,"isBold"),LB.prototype),sc(LB.prototype,"isItalic",[wB,IB],Object.getOwnPropertyDescriptor(LB.prototype,"isItalic"),LB.prototype),sc(LB.prototype,"isUnderline",[RB,DB],Object.getOwnPropertyDescriptor(LB.prototype,"isUnderline"),LB.prototype),sc(LB.prototype,"underlineHeight",[MB,Mc,OB,BB],Object.getOwnPropertyDescriptor(LB.prototype,"underlineHeight"),LB.prototype),FB=sc(LB.prototype,"_string",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),zB=sc(LB.prototype,"_horizontalAlign",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iN.CENTER}}),VB=sc(LB.prototype,"_verticalAlign",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nN.CENTER}}),GB=sc(LB.prototype,"_actualFontSize",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),UB=sc(LB.prototype,"_fontSize",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),kB=sc(LB.prototype,"_fontFamily",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),HB=sc(LB.prototype,"_lineHeight",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),jB=sc(LB.prototype,"_overflow",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sN.NONE}}),WB=sc(LB.prototype,"_enableWrapText",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qB=sc(LB.prototype,"_font",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XB=sc(LB.prototype,"_isSystemFontUsed",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),YB=sc(LB.prototype,"_spacingX",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KB=sc(LB.prototype,"_isItalic",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JB=sc(LB.prototype,"_isBold",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$B=sc(LB.prototype,"_isUnderline",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZB=sc(LB.prototype,"_underlineHeight",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),QB=sc(LB.prototype,"_cacheMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rN.NONE}}),NB=LB))||NB)||NB)||NB)||NB));l.Label=lN,function(t){t[t.BUTT=0]="BUTT",t[t.ROUND=1]="ROUND",t[t.SQUARE=2]="SQUARE"}(oN||(oN={})),Xt(oN),function(t){t[t.BEVEL=0]="BEVEL",t[t.ROUND=1]="ROUND",t[t.MITER=2]="MITER"}(aN||(aN={})),Xt(aN),function(t){t[t.PT_CORNER=1]="PT_CORNER",t[t.PT_LEFT=2]="PT_LEFT",t[t.PT_BEVEL=4]="PT_BEVEL",t[t.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(cN||(cN={})),Xt(cN);const hN=Math.PI,_N=Math.min,uN=Math.max,dN=Math.cos,mN=Math.sin,pN=Math.abs,fN=Math.sign,gN=.5522847493;function vN(t,e,i,n,s){t.moveTo(e-n,i),t.bezierCurveTo(e-n,i+s*gN,e-n*gN,i+s,e,i+s),t.bezierCurveTo(e+n*gN,i+s,e+n,i+s*gN,e+n,i),t.bezierCurveTo(e+n,i-s*gN,e+n*gN,i-s,e,i-s),t.bezierCurveTo(e-n*gN,i-s,e-n,i-s*gN,e-n,i),t.close()}function yN(t,e,i,n,s,r,o,a,c,l,h){let _=0,u=0,d=0,m=0,p=0,f=0,g=0,v=0,y=0,x=0,S=0,C=0,A=0,b=0,T=0,E=0;l>10||(_=.5*(e+n),u=.5*(i+s),d=.5*(n+r),m=.5*(s+o),p=.5*(r+a),f=.5*(o+c),g=.5*(_+d),v=.5*(u+m),A=a-e,b=c-i,T=pN((n-a)*b-(s-c)*A),E=pN((r-a)*b-(o-c)*A),(T+E)*(T+E)<t.tessTol*(A*A+b*b)?t.addPoint(a,c,0===h?h|cN.PT_BEVEL:h):(y=.5*(d+p),x=.5*(m+f),S=.5*(g+y),C=.5*(v+x),yN(t,e,i,_,u,g,v,S,C,l+1,0),yN(t,S,C,y,x,p,f,a,c,l+1,h)))}class xN extends Oi{constructor(t,e){super(t,e),this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0,this.reset()}reset(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}class SN{constructor(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}reset(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}class CN{constructor(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=hi.WHITE.clone(),this.lineCap=oN.BUTT,this.strokeColor=hi.BLACK.clone(),this.lineJoin=aN.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}moveTo(t,e){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(t,e,cN.PT_CORNER),this._commandX=t,this._commandY=e}lineTo(t,e){this.addPoint(t,e,cN.PT_CORNER),this._commandX=t,this._commandY=e}bezierCurveTo(t,e,i,n,s,r){const o=this._curPath,a=o.points[o.points.length-1];a&&(a.x!==t||a.y!==e||i!==s||n!==r?(yN(this,a.x,a.y,t,e,i,n,s,r,0,cN.PT_CORNER),this._commandX=s,this._commandY=r):this.lineTo(s,r))}quadraticCurveTo(t,e,i,n){const s=this._commandX,r=this._commandY;this.bezierCurveTo(s+2/3*(t-s),r+2/3*(e-r),i+2/3*(t-i),n+2/3*(e-n),i,n)}arc(t,e,i,n,s,r){!function(t,e,i,n,s,r,o){let a=0,c=0,l=0,h=0,_=0,u=0,d=0,m=0,p=0,f=0,g=0,v=0,y=0,x=0,S=0,C=0;if(c=r-s,o=o||!1)if(pN(c)>=2*hN)c=2*hN;else for(;c<0;)c+=2*hN;else if(pN(c)>=2*hN)c=2*-hN;else for(;c>0;)c-=2*hN;for(C=0|uN(1,_N(pN(c)/(.5*hN)+.5,5)),l=c/C/2,h=pN(4/3*(1-dN(l))/mN(l)),o||(h=-h),S=0;S<=C;S++)a=s+c*(S/C),_=dN(a),u=mN(a),d=e+_*n,m=i+u*n,p=-u*n*h,f=_*n*h,0===S?t.moveTo(d,m):t.bezierCurveTo(g+y,v+x,d-p,m-f,d,m),g=d,v=m,y=p,x=f}(this,t,e,i,n,s,r)}ellipse(t,e,i,n){vN(this,t,e,i,n),this._curPath.complex=!1}circle(t,e,i){vN(this,t,e,i,i),this._curPath.complex=!1}rect(t,e,i,n){this.moveTo(t,e),this.lineTo(t+i,e),this.lineTo(t+i,e+n),this.lineTo(t,e+n),this.close(),this._curPath.complex=!1}roundRect(t,e,i,n,s){!function(t,e,i,n,s,r){if(r<.1)t.rect(e,i,n,s);else{const o=_N(r,.5*pN(n))*fN(n),a=_N(r,.5*pN(s))*fN(s);t.moveTo(e,i+a),t.lineTo(e,i+s-a),t.bezierCurveTo(e,i+s-a*(1-gN),e+o*(1-gN),i+s,e+o,i+s),t.lineTo(e+n-o,i+s),t.bezierCurveTo(e+n-o*(1-gN),i+s,e+n,i+s-a*(1-gN),e+n,i+s-a),t.lineTo(e+n,i+a),t.bezierCurveTo(e+n,i+a*(1-gN),e+n-o*(1-gN),i,e+n-o,i),t.lineTo(e+o,i),t.bezierCurveTo(e+o*(1-gN),i,e,i+a*(1-gN),e,i+a),t.close()}}(this,t,e,i,n,s),this._curPath.complex=!1}clear(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;const t=this._renderDataList;for(let e=0,i=t.length;e<i;e++){const i=t[e];i&&JM.remove(i)}this._renderDataList.length=0}close(){this._curPath.closed=!0}requestRenderData(){const t=JM.add();return this._renderDataList.push(t),t}getRenderDataList(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList}addPoint(t,e,i){const n=this._curPath;if(!n)return;const s=this._points,r=n.points;let o=s[this.pointsOffset++];o?(o.x=t,o.y=e):(o=new xN(t,e),s.push(o)),o.flags=i,r.push(o)}_addPath(){const t=this.pathLength;let e=this.paths[t];return e?e.reset():(e=new SN,this.paths.push(e)),this.pathLength++,this._curPath=e,e}}var AN,bN,TN,EN,PN,wN,IN,RN,DN,MN,ON,BN,NN,LN,FN,zN,VN,GN,UN,kN,HN,jN,WN;const qN=GM.concat([new fs("a_dist",Zi.R32F)]),XN=HM(qN),YN=jM(qN);let KN=function(e){return t({Graphics:e,GraphicsComponent:e}),e}((AN=dc("cc.Graphics"),bN=Dc(),TN=pc(110),EN=Pc(),PN=Lc(),wN=Kc(aN),IN=Lc(),RN=Kc(oN),DN=Lc(),MN=Lc(),ON=Lc(),BN=Lc(),NN=Oc(),AN(LN=bN(LN=TN(LN=EN((WN=jN=class t extends HO{get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.impl&&(this.impl.lineWidth=t)}get lineJoin(){return this._lineJoin}set lineJoin(t){this._lineJoin=t,this.impl&&(this.impl.lineJoin=t)}get lineCap(){return this._lineCap}set lineCap(t){this._lineCap=t,this.impl&&(this.impl.lineCap=t)}get strokeColor(){return this._strokeColor}set strokeColor(t){this.impl&&(this._strokeColor.set(t),this.impl.strokeColor=this._strokeColor)}get fillColor(){return this._fillColor}set fillColor(t){this.impl&&(this._fillColor.set(t),this.impl.fillColor=this._fillColor)}get miterLimit(){return this._miterLimit}set miterLimit(t){this._miterLimit=t}get color(){return this._color}set color(t){this._color!==t&&this._color.set(t)}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(t){}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(t){}constructor(){super(),this.impl=null,this.model=null,nc(this,"_lineWidth",zN,this),nc(this,"_strokeColor",VN,this),nc(this,"_lineJoin",GN,this),nc(this,"_lineCap",UN,this),nc(this,"_fillColor",kN,this),nc(this,"_miterLimit",HN,this),this._isDrawing=!1,this._isNeedUploadData=!0,this._graphicsUseSubMeshes=[],this._instanceMaterialType=kO.ADD_COLOR,this.impl=new CN}onRestore(){this.impl||this._flushAssembler()}onLoad(){this.model=mw.root.createModel(hv),this.model.node=this.model.transform=this.node,this._flushAssembler()}onEnable(){super.onEnable(),this._updateMtlForGraphics()}onDisable(){super.onDisable()}onDestroy(){this._sceneGetter=null,this.model&&(mw.root.destroyModel(this.model),this.model=null);const t=this._graphicsUseSubMeshes.length;if(t>0){for(let e=0;e<t;++e)this._graphicsUseSubMeshes[e].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),super.onDestroy()}moveTo(t,e){this.impl&&this.impl.moveTo(t,e)}lineTo(t,e){this.impl&&this.impl.lineTo(t,e)}bezierCurveTo(t,e,i,n,s,r){this.impl&&this.impl.bezierCurveTo(t,e,i,n,s,r)}quadraticCurveTo(t,e,i,n){this.impl&&this.impl.quadraticCurveTo(t,e,i,n)}arc(t,e,i,n,s,r){this.impl&&this.impl.arc(t,e,i,n,s,r)}ellipse(t,e,i,n){this.impl&&this.impl.ellipse(t,e,i,n)}circle(t,e,i){this.impl&&this.impl.circle(t,e,i)}rect(t,e,i,n){this.impl&&this.impl.rect(t,e,i,n)}roundRect(t,e,i,n,s){this.impl&&this.impl.roundRect(t,e,i,n,s)}fillRect(t,e,i,n){this.rect(t,e,i,n),this.fill()}clear(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(let t=0;t<this.model.subModels.length;t++)this.model.subModels[t].inputAssembler.indexCount=0;this.markForUpdateRenderData()}}close(){this.impl&&this.impl.close()}stroke(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)}fill(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)}_updateMtlForGraphics(){let t;this._customMaterial?t=this.getMaterialInstance(0):(t=Mf.get("ui-graphics-material"),this.setMaterial(t,0),t=this.getMaterialInstance(0),t.recompileShaders({USE_LOCAL:!0}))}activeSubModel(t){if(this.model){if(this.model.subModels.length<=t){const e=l.director.root.device,i=e.createBuffer(new Zn(en.VERTEX|en.TRANSFER_DST,rn.DEVICE,65535*YN,YN)),n=e.createBuffer(new Zn(en.INDEX|en.TRANSFER_DST,rn.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),s=new uA([i],qN,Tn.TRIANGLE_LIST,n);s.subMeshIdx=0,this.model.initSubModel(t,s,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(s)}}else I(4500,this.node.name)}_uploadData(){const t=this.impl;if(!t)return;const e=t&&t.getRenderDataList();if(e.length<=0||!this.model)return;const i=this.model.subModels;for(let t=0;t<e.length;t++){const n=e[t],s=i[t].inputAssembler;if(n.lastFilledVertex===n.vertexStart)continue;const r=new Float32Array(n.vData.buffer,0,n.vertexStart*XN);s.vertexBuffers[0].update(r),s.vertexCount=n.vertexStart;const o=new Uint16Array(n.iData.buffer,0,n.indexStart);s.indexBuffer.update(o),s.indexCount=n.indexStart,n.lastFilledVertex=n.vertexStart,n.lastFilledIndex=n.indexStart}this._isNeedUploadData=!1}_render(t){if(this._isNeedUploadData){if(this.impl){const t=this.impl.getRenderDataList(),e=this.model.subModels.length;if(t.length>e)for(let i=e;i<t.length;i++)this.activeSubModel(i)}this._uploadData()}t.commitModel(this,this.model,this.getMaterialInstance(0))}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}_canRender(){return!!super._canRender()&&!!this.model&&this._isDrawing}},jN.LineJoin=aN,jN.LineCap=oN,sc((FN=WN).prototype,"lineWidth",[Mc,PN],Object.getOwnPropertyDescriptor(FN.prototype,"lineWidth"),FN.prototype),sc(FN.prototype,"lineJoin",[wN,IN],Object.getOwnPropertyDescriptor(FN.prototype,"lineJoin"),FN.prototype),sc(FN.prototype,"lineCap",[RN,DN],Object.getOwnPropertyDescriptor(FN.prototype,"lineCap"),FN.prototype),sc(FN.prototype,"strokeColor",[MN],Object.getOwnPropertyDescriptor(FN.prototype,"strokeColor"),FN.prototype),sc(FN.prototype,"fillColor",[ON],Object.getOwnPropertyDescriptor(FN.prototype,"fillColor"),FN.prototype),sc(FN.prototype,"miterLimit",[BN],Object.getOwnPropertyDescriptor(FN.prototype,"miterLimit"),FN.prototype),sc(FN.prototype,"color",[Jc,NN],Object.getOwnPropertyDescriptor(FN.prototype,"color"),FN.prototype),zN=sc(FN.prototype,"_lineWidth",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),VN=sc(FN.prototype,"_strokeColor",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hi.BLACK.clone()}}),GN=sc(FN.prototype,"_lineJoin",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return aN.MITER}}),UN=sc(FN.prototype,"_lineCap",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oN.BUTT}}),kN=sc(FN.prototype,"_fillColor",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hi.WHITE.clone()}}),HN=sc(FN.prototype,"_miterLimit",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),LN=FN))||LN)||LN)||LN)||LN));var JN,$N,ZN,QN,tL,eL,iL,nL,sL,rL,oL,aL,cL,lL,hL,_L,uL,dL,mL,pL,fL,gL,vL,yL;l.Graphics=KN;const xL=new Ii,SL=new Oi,CL=new Ii,AL=[];let bL;!function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",t[t.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(bL||(bL={})),Xt(bL);let TL=function(e){return t({Mask:e,MaskComponent:e}),e}((JN=dc("cc.Mask"),$N=Dc(),ZN=pc(110),QN=Pc(),tL=Kc(bL),eL=Lc(),iL=kc(),nL=Lc(),sL=Oc(),rL=Kc(jD),oL=Oc(),aL=Oc(),cL=Fc(),lL=Oc(),hL=Oc(),JN(_L=$N(_L=ZN(_L=QN((yL=vL=class t extends HO{get type(){return this._type}set type(t){this._type!==t&&(this._type=t,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==bL.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}get inverted(){return this._inverted}set inverted(t){this._inverted=t,this.stencilStage=xO.DISABLED,this._graphics&&(this._graphics.stencilStage=xO.DISABLED)}get segments(){return this._segments}set segments(t){this._segments!==t&&(this._segments=We(t,3,1e4),this._updateGraphics())}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){if(this._spriteFrame===t)return;const e=this._spriteFrame;this._spriteFrame=t,this._type===bL.IMAGE_STENCIL&&!e&&t&&this.markForUpdateRenderData()}get alphaThreshold(){return this._alphaThreshold}set alphaThreshold(t){this._alphaThreshold!==t&&(this._alphaThreshold=t,this.type===bL.IMAGE_STENCIL&&this._graphics)&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold)}get graphics(){return this._graphics}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(t){this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(t){this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this.markForUpdateRenderData())}get customMaterial(){return this._customMaterial}set customMaterial(t){}constructor(){super(),this._clearStencilMtl=null,this._clearModel=null,nc(this,"_type",dL,this),nc(this,"_inverted",mL,this),nc(this,"_segments",pL,this),nc(this,"_spriteFrame",fL,this),nc(this,"_alphaThreshold",gL,this),this._graphics=null,this._clearModelMesh=null,this._instanceMaterialType=kO.ADD_COLOR}onLoad(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()}onEnable(){super.onEnable(),this._updateGraphics(),this._enableGraphics()}onRestore(){this._createGraphics(),super.updateMaterial(),this._updateGraphics(),this._renderFlag=this._canRender()}onDisable(){super.onDisable(),this._disableGraphics()}onDestroy(){this._clearModel&&this._clearModelMesh&&(mw.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics(),super.onDestroy()}isHit(t){const e=this.node._uiProps.uiTransformComp,i=e.contentSize,n=i.width,s=i.height,r=SL;this.node.getWorldMatrix(xL),Ii.invert(CL,xL),Oi.transformMat4(r,t,CL);const o=e.anchorPoint;r.x+=o.x*n,r.y+=o.y*s;let a=!1;if(this.type===bL.RECT||this.type===bL.GRAPHICS_STENCIL||this.type===bL.IMAGE_STENCIL)a=r.x>=0&&r.y>=0&&r.x<=n&&r.y<=s;else if(this.type===bL.ELLIPSE){const t=n/2,e=s/2,i=r.x-.5*n,o=r.y-.5*s;a=i*i/(t*t)+o*o/(e*e)<1}return this._inverted&&(a=!a),a}_render(t){t.commitComp(this,this.renderData,null,this._assembler,null)}_postRender(t){this._postAssembler&&t.commitComp(this,null,null,this._postAssembler,null)}_nodeStateChange(t){super._nodeStateChange(t),this._updateGraphics()}_canRender(){return!!super._canRender()&&null!==this._graphics&&(this._type!==bL.IMAGE_STENCIL||null!==this._spriteFrame)}_flushAssembler(){const e=t.Assembler.getAssembler(this),i=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==i&&(this._postAssembler=i),this._useRenderData()}_createGraphics(){if(!this._graphics){const t=this._graphics=new KN;t._objFlags|=il.Flags.IsOnLoadCalled,t.node=this.node,t.node.getWorldMatrix(),t.lineWidth=0;const e=hi.WHITE.clone();e.a=0,t.fillColor=e}this._updateMaterial()}_updateGraphics(){if(!this._graphics||this._type!==bL.RECT&&this._type!==bL.ELLIPSE)return;const t=this.node._uiProps.uiTransformComp,e=this._graphics;e.clear();const i=t.contentSize,n=i.width,s=i.height,r=t.anchorPoint,o=-n*r.x,a=-s*r.y;if(this._type===bL.RECT)e.rect(o,a,n,s);else if(this._type===bL.ELLIPSE){const t=function(t,e,i){AL.length=0;const n=2*Math.PI/i;for(let s=0;s<i;++s)AL.push(new mi(e.x*Math.cos(n*s)+t.x,e.y*Math.sin(n*s)+t.y,0));return AL}(new mi(o+n/2,a+s/2,0),new mi(n/2,s/2,0),this._segments);for(let i=0;i<t.length;++i){const n=t[i];0===i?e.moveTo(n.x,n.y):e.lineTo(n.x,n.y)}e.close()}e.fill()}_createClearModel(){if(!this._clearModel){const t=Mf.get("default-clear-stencil");this._clearStencilMtl=new dv({parent:t,owner:this,subModelIdx:0}),this._clearModel=mw.root.createModel(hv),this._clearModel.node=this._clearModel.transform=this.node;const e=jM(VM),i=l.director.root.device,n=i.createBuffer(new Zn(en.VERTEX|en.TRANSFER_DST,rn.DEVICE,4*e,e)),s=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);n.update(s);const r=i.createBuffer(new Zn(en.INDEX|en.TRANSFER_DST,rn.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),o=new Uint16Array([0,1,2,2,1,3]);r.update(o),this._clearModelMesh=new uA([n],VM,Tn.TRIANGLE_LIST,r),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}}_updateMaterial(){if(this._graphics){const t=this._graphics;let e;t.stencilStage=xO.DISABLED,this._type===bL.IMAGE_STENCIL?(e=Mf.get("ui-alpha-test-material"),t.setMaterial(e,0),e=t.getMaterialInstance(0),e.setProperty("alphaThreshold",this._alphaThreshold)):(e=Mf.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}}_enableGraphics(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())}_disableGraphics(){this._graphics&&this._graphics.onDisable()}_removeGraphics(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)}_useRenderData(){this._type!==bL.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())}},vL.Type=bL,sc((uL=yL).prototype,"type",[tL,eL],Object.getOwnPropertyDescriptor(uL.prototype,"type"),uL.prototype),sc(uL.prototype,"inverted",[iL,nL],Object.getOwnPropertyDescriptor(uL.prototype,"inverted"),uL.prototype),sc(uL.prototype,"segments",[sL],Object.getOwnPropertyDescriptor(uL.prototype,"segments"),uL.prototype),sc(uL.prototype,"spriteFrame",[rL,oL],Object.getOwnPropertyDescriptor(uL.prototype,"spriteFrame"),uL.prototype),sc(uL.prototype,"alphaThreshold",[aL,cL,Uc],Object.getOwnPropertyDescriptor(uL.prototype,"alphaThreshold"),uL.prototype),sc(uL.prototype,"color",[Jc,lL],Object.getOwnPropertyDescriptor(uL.prototype,"color"),uL.prototype),sc(uL.prototype,"customMaterial",[Jc,hL],Object.getOwnPropertyDescriptor(uL.prototype,"customMaterial"),uL.prototype),dL=sc(uL.prototype,"_type",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bL.RECT}}),mL=sc(uL.prototype,"_inverted",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pL=sc(uL.prototype,"_segments",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),fL=sc(uL.prototype,"_spriteFrame",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gL=sc(uL.prototype,"_alphaThreshold",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),_L=uL))||_L)||_L)||_L)||_L));SA._maskComp=TL,l.Mask=TL;const EL=/^(click)(\s)*=|(param)(\s)*=/,PL=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;class wL{constructor(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}parse(t){this._resultObjectArray.length=0,this._stack.length=0;let e=0;const i=t.length;for(;e<i;){let n=t.indexOf(">",e),s=-1;if(n>=0&&(s=t.lastIndexOf("<",n),s<e-1&&(s=t.indexOf("<",n+1),n=t.indexOf(">",s+1))),s<0)this._stack.pop(),this._processResult(t.substring(e)),e=i;else{let i=t.substring(e,s);const r=t.substring(s+1,n);""===r&&(i=t.substring(e,n+1)),this._processResult(i),-1===n?n=s:"/"===t.charAt(s+1)?this._stack.pop():this._addToStack(r),e=n+1}}return this._resultObjectArray}_attributeToObject(t){t=t.trim();const e={};let i=/^(color|size)(\s)*=/.exec(t),n="",s=0,r="";if(i){if(n=i[0],""===(t=t.substring(n.length).trim()))return e;switch(s=t.indexOf(" "),n[0]){case"c":e.color=s>-1?t.substring(0,s).trim():t;break;case"s":e.size=parseInt(t)}return s>-1&&(r=t.substring(s+1).trim(),e.event=this._processEventHandler(r)),e}if(i=/^(br(\s)*\/)/.exec(t),i&&i[0].length>0&&(n=i[0].trim(),n.startsWith("br")&&"/"===n[n.length-1]))return e.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),e;i=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(t);let o="",a=-1;if(i&&i[0].length>0&&(n=i[0].trim(),n.startsWith("img")&&"/"===n[n.length-1])){let r;i=PL.exec(t);let c=!1;for(;i;){n=(t=t.substring(t.indexOf(i[0]))).substr(0,i[0].length);const l=n.length;if(n=n.replace(/[^a-zA-Z]/g,"").trim(),n=n.toLowerCase(),o=t.substring(l).trim(),a="src"===n?this.getRightQuotationIndex(o):-1,s=o.indexOf(" ",a+1>=o.length?-1:a+1),r=s>-1?o.substr(0,s):o,t=o.substring(s).trim(),r.endsWith("/")&&(r=r.slice(0,-1)),"src"===n){switch(r.charCodeAt(0)){case 34:case 39:c=!0,r=r.slice(1,-1)}e.isImage=!0,e.src=r}else if("height"===n)e.imageHeight=parseInt(r);else if("width"===n)e.imageWidth=parseInt(r);else if("align"===n){switch(r.charCodeAt(0)){case 34:case 39:r=r.slice(1,-1)}e.imageAlign=r.toLowerCase()}else"offset"===n?e.imageOffset=r:"click"===n&&(e.event=this._processEventHandler(`${n}=${r}`));e.event&&"param"===n&&(e.event[n]=r.replace(/^"|"$/g,"")),i=PL.exec(t)}return c&&e.isImage&&this._resultObjectArray.push({text:"",style:e}),{}}if(i=/^(outline(\s)*[^>]*)/.exec(t),i){const r={color:"#ffffff",width:1};if(t=i[0].substring("outline".length).trim()){const a=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;let c;for(i=a.exec(t);i;)n=(t=t.substring(t.indexOf(i[0]))).substr(0,i[0].length),o=t.substring(n.length).trim(),s=o.indexOf(" "),c=s>-1?o.substr(0,s):o,n=n.replace(/[^a-zA-Z]/g,"").trim(),n=n.toLowerCase(),t=o.substring(s).trim(),"click"===n?e.event=this._processEventHandler(`${n}=${c}`):"color"===n?r.color=c:"width"===n&&(r.width=parseInt(c)),e.event&&"param"===n&&(e.event[n]=c.replace(/^"|"$/g,"")),i=a.exec(t)}e.outline=r}if(i=/^(on|u|b|i)(\s)*/.exec(t),i&&i[0].length>0){switch(n=i[0],t=t.substring(n.length).trim(),n[0]){case"u":e.underline=!0;break;case"i":e.italic=!0;break;case"b":e.bold=!0}if(""===t)return e;e.event=this._processEventHandler(t)}return e}getRightQuotationIndex(t){let e=-1,i=-1;const n=t.indexOf("'"),s=t.indexOf('"'),r=s>-1&&(s<n||-1===n);return n>-1&&(n<s||-1===s)?(e=n,i=t.indexOf("'",e+1>=t.length?-1:e+1)):r&&(e=s,i=t.indexOf('"',e+1>=t.length?-1:e+1)),i}_processEventHandler(t){const e={};let i=0,n=!1,s=EL.exec(t);for(;s;){let r=s[0],o="";if(n=!1,'"'===(t=t.substring(r.length).trim()).charAt(0))i=t.indexOf('"',1),i>-1&&(o=t.substring(1,i).trim(),n=!0),i++;else if("'"===t.charAt(0))i=t.indexOf("'",1),i>-1&&(o=t.substring(1,i).trim(),n=!0),i++;else{const e=/(\S)+/.exec(t);o=e?e[0]:"",i=o.length}n&&(r=r.substring(0,r.length-1).trim(),e[r]=o),t=t.substring(i).trim(),s=EL.exec(t)}return e}_addToStack(t){const e=this._attributeToObject(t);if(0===this._stack.length)this._stack.push(e);else{if(e.isNewLine||e.isImage)return;const t=this._stack[this._stack.length-1];for(const i in t)e[i]||(e[i]=t[i]);this._stack.push(e)}}_processResult(t){0!==t.length&&(t=this._escapeSpecialSymbol(t),this._stack.length>0?this._resultObjectArray.push({text:t,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:t}))}_escapeSpecialSymbol(t){for(const e of this._specialSymbolArray){const i=e[0],n=e[1];t=t.replace(i,n)}return t}}var IL,RL,DL,ML,OL,BL,NL,LL,FL,zL,VL;t("HtmlTextParser",wL);let GL=function(e){return t({LabelOutline:e,LabelOutlineComponent:e}),e}((IL=dc("cc.LabelOutline"),RL=Dc(),DL=pc(110),ML=Pc(),OL=mc(lN),BL=Lc(),NL=Lc(),IL(LL=RL(LL=DL(LL=ML(LL=OL(LL=Ec((zL=sc((FL=class extends Lh{constructor(...t){super(...t),nc(this,"_color",zL,this),nc(this,"_width",VL,this)}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}get width(){return this._width}set width(t){this._width!==t&&(this._width=t,this._updateRenderData())}onEnable(){this._updateRenderData()}onDisable(){this._updateRenderData()}_updateRenderData(){const t=this.node.getComponent(lN);t&&t.updateRenderData(!0)}}).prototype,"_color",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(0,0,0,255)}}),VL=sc(FL.prototype,"_width",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),sc(FL.prototype,"color",[BL],Object.getOwnPropertyDescriptor(FL.prototype,"color"),FL.prototype),sc(FL.prototype,"width",[NL],Object.getOwnPropertyDescriptor(FL.prototype,"width"),FL.prototype),LL=FL))||LL)||LL)||LL)||LL)||LL)||LL));var UL,kL,HL,jL,WL,qL,XL,YL,KL,JL,$L,ZL,QL,tF,eF,iF,nF,sF,rF,oF,aF,cF,lF,hF,_F,uF,dF,mF,pF,fF,gF,vF,yF,xF,SF,CF,AF,bF,TF,EF,PF,wF,IF,RF,DF,MF;let OF;var BF,NF,LF;l.LabelOutline=GL,function(t){t[t.SIMPLE=0]="SIMPLE",t[t.SLICED=1]="SLICED",t[t.TILED=2]="TILED",t[t.FILLED=3]="FILLED"}(OF||(OF={})),Xt(OF),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.RADIAL=2]="RADIAL"}(BF||(BF={})),Xt(BF),function(t){t[t.CUSTOM=0]="CUSTOM",t[t.TRIMMED=1]="TRIMMED",t[t.RAW=2]="RAW"}(NF||(NF={})),Xt(NF),function(t){t.SPRITE_FRAME_CHANGED="spriteframe-changed"}(LF||(LF={}));let FF=function(e){return t({Sprite:e,SpriteComponent:e}),e}((UL=dc("cc.Sprite"),kL=Dc(),HL=pc(110),jL=Pc(),WL=Kc(YD),qL=kc(),XL=Lc(),YL=Kc(jD),KL=kc(),JL=Lc(),$L=Kc(OF),ZL=kc(),QL=Lc(),tF=Kc(BF),eF=kc(),iF=Lc(),nF=kc(),sF=Lc(),rF=Fc(),oF=kc(),aF=Lc(),cF=Fc(),lF=kc(),hF=Lc(),_F=Oc(),uF=kc(),dF=Lc(),mF=kc(),pF=Lc(),fF=Kc(NF),gF=kc(),vF=Lc(),UL(yF=kL(yF=HL(yF=jL((MF=DF=class t extends HO{constructor(...t){super(...t),nc(this,"_spriteFrame",SF,this),nc(this,"_type",CF,this),nc(this,"_fillType",AF,this),nc(this,"_sizeMode",bF,this),nc(this,"_fillCenter",TF,this),nc(this,"_fillStart",EF,this),nc(this,"_fillRange",PF,this),nc(this,"_isTrimmedMode",wF,this),nc(this,"_useGrayscale",IF,this),nc(this,"_atlas",RF,this)}get spriteAtlas(){return this._atlas}set spriteAtlas(t){this._atlas!==t&&(this._atlas=t)}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){if(this._spriteFrame===t)return;const e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(!1),this._applySpriteFrame(e)}get type(){return this._type}set type(t){this._type!==t&&(this._type=t,this._flushAssembler())}get fillType(){return this._fillType}set fillType(t){this._fillType!==t&&(t===BF.RADIAL||this._fillType===BF.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=t,this._flushAssembler()}get fillCenter(){return this._fillCenter}set fillCenter(t){this._fillCenter.x=t.x,this._fillCenter.y=t.y,this._type===OF.FILLED&&this._renderData&&this.markForUpdateRenderData()}get fillStart(){return this._fillStart}set fillStart(t){this._fillStart=We(t,0,1),this._type===OF.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}get fillRange(){return this._fillRange}set fillRange(t){this._fillRange=We(t,-1,1),this._type===OF.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}get trim(){return this._isTrimmedMode}set trim(t){this._isTrimmedMode!==t&&(this._isTrimmedMode=t,this._type===OF.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}get grayscale(){return this._useGrayscale}set grayscale(t){this._useGrayscale!==t&&(this._useGrayscale=t,this.changeMaterialForDefine(),this.updateMaterial())}get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,t!==NF.CUSTOM&&this._applySpriteSize())}__preload(){this.changeMaterialForDefine(),super.__preload()}onEnable(){super.onEnable(),this._activateMaterial();const t=this._spriteFrame;t&&(this._updateUVs(),this._type===OF.SLICED&&t.on(jD.EVENT_UV_UPDATED,this._updateUVs,this))}onDisable(){this._spriteFrame&&this._type===OF.SLICED&&this._spriteFrame.off(jD.EVENT_UV_UPDATED,this._updateUVs,this)}onDestroy(){super.onDestroy()}changeSpriteFrameFromAtlas(t){if(!this._atlas)return void console.warn("SpriteAtlas is null.");const e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}changeMaterialForDefine(){let t;const e=this._instanceMaterialType;this._spriteFrame&&(t=this._spriteFrame.texture);let i=!1;if(t instanceof Zp){const e=t.getPixelFormat();i=e===Np.RGBA_ETC1||e===Np.RGB_A_PVRTC_4BPPV1||e===Np.RGB_A_PVRTC_2BPPV1}i&&this.grayscale?this._instanceMaterialType=kO.USE_ALPHA_SEPARATED_AND_GRAY:i?this._instanceMaterialType=kO.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=kO.GRAYSCALE:this._instanceMaterialType=kO.ADD_COLOR_AND_TEXTURE,e!==this._instanceMaterialType&&this.updateMaterial()}_updateBuiltinMaterial(){let t=super._updateBuiltinMaterial();if(this.spriteFrame&&this.spriteFrame.texture instanceof nA){const e={SAMPLE_FROM_RT:!0,...t.passes[0].defines},i=new sg;i.initialize({effectAsset:t.effectAsset,defines:e}),t=i}return t}_render(t){t.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)}_canRender(){if(!super._canRender())return!1;const t=this._spriteFrame;return!(!t||!t.texture)}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===OF.SLICED?this._spriteFrame.on(jD.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(jD.EVENT_UV_UPDATED,this._updateUVs,this))}_applySpriteSize(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(NF.RAW===this._sizeMode){const t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(NF.TRIMMED===this._sizeMode){const t=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}}_resized(){}_activateMaterial(){const t=this._spriteFrame,e=this.getRenderMaterial(0);t&&e&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=e)}_updateUVs(){this._assembler&&this._assembler.updateUVs(this)}_applySpriteFrame(t){const e=this._spriteFrame;t&&this._type===OF.SLICED&&t.off(jD.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();let i=!1;e&&(t&&t.texture===e.texture||(i=!0),i&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===OF.SLICED&&e.on(jD.EVENT_UV_UPDATED,this._updateUVs,this))}},DF.FillType=BF,DF.Type=OF,DF.SizeMode=NF,DF.EventType=LF,sc((xF=MF).prototype,"spriteAtlas",[WL,qL,XL],Object.getOwnPropertyDescriptor(xF.prototype,"spriteAtlas"),xF.prototype),sc(xF.prototype,"spriteFrame",[YL,KL,JL],Object.getOwnPropertyDescriptor(xF.prototype,"spriteFrame"),xF.prototype),sc(xF.prototype,"type",[$L,ZL,QL],Object.getOwnPropertyDescriptor(xF.prototype,"type"),xF.prototype),sc(xF.prototype,"fillType",[tF,eF,iF],Object.getOwnPropertyDescriptor(xF.prototype,"fillType"),xF.prototype),sc(xF.prototype,"fillCenter",[nF,sF],Object.getOwnPropertyDescriptor(xF.prototype,"fillCenter"),xF.prototype),sc(xF.prototype,"fillStart",[rF,oF,aF],Object.getOwnPropertyDescriptor(xF.prototype,"fillStart"),xF.prototype),sc(xF.prototype,"fillRange",[cF,lF,hF],Object.getOwnPropertyDescriptor(xF.prototype,"fillRange"),xF.prototype),sc(xF.prototype,"trim",[_F,uF,dF],Object.getOwnPropertyDescriptor(xF.prototype,"trim"),xF.prototype),sc(xF.prototype,"grayscale",[Mc,mF,pF],Object.getOwnPropertyDescriptor(xF.prototype,"grayscale"),xF.prototype),sc(xF.prototype,"sizeMode",[fF,gF,vF],Object.getOwnPropertyDescriptor(xF.prototype,"sizeMode"),xF.prototype),SF=sc(xF.prototype,"_spriteFrame",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),CF=sc(xF.prototype,"_type",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OF.SIMPLE}}),AF=sc(xF.prototype,"_fillType",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BF.HORIZONTAL}}),bF=sc(xF.prototype,"_sizeMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NF.TRIMMED}}),TF=sc(xF.prototype,"_fillCenter",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi(0,0)}}),EF=sc(xF.prototype,"_fillStart",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PF=sc(xF.prototype,"_fillRange",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wF=sc(xF.prototype,"_isTrimmedMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),IF=sc(xF.prototype,"_useGrayscale",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),RF=sc(xF.prototype,"_atlas",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yF=xF))||yF)||yF)||yF)||yF));var zF;l.Sprite=FF;let VF=t("RenderRoot2D",dc("cc.RenderRoot2D")(zF=pc(100)(zF=Pc()(zF=mc(SO)(zF=fc(zF=Ec(zF=class extends Lh{onEnable(){l.director.root.batcher2D.addScreen(this)}onDisable(){l.director.root.batcher2D.removeScreen(this)}onDestroy(){l.director.root.batcher2D.removeScreen(this)}})||zF)||zF)||zF)||zF)||zF)||zF);var GF,UF,kF,HF,jF,WF,qF,XF,YF,KF,JF,$F;const ZF=new mi,QF=jt({OVERLAY:0,INTERSPERSE:1});let tz=function(e){return t({Canvas:e,CanvasComponent:e}),e}((GF=dc("cc.Canvas"),UF=Dc(),kF=pc(100),HF=Pc(),jF=Kc(yD),WF=Lc(),qF=Lc(),XF=Kc(yD),GF(YF=UF(YF=kF(YF=HF(YF=Ec(YF=fc((sc((KF=class extends VF{get renderMode(){return this._renderMode}set renderMode(t){this._renderMode=t,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}get cameraComponent(){return this._cameraComponent}set cameraComponent(t){this._cameraComponent!==t&&(this._cameraComponent=t,this._onResizeCamera())}get alignCanvasWithScreen(){return this._alignCanvasWithScreen}set alignCanvasWithScreen(t){this._alignCanvasWithScreen=t,this._onResizeCamera()}constructor(){super(),nc(this,"_cameraComponent",JF,this),nc(this,"_alignCanvasWithScreen",$F,this),this._thisOnCameraResized=void 0,this._fitDesignResolution=void 0,this._pos=new mi,this._renderMode=QF.OVERLAY,this._thisOnCameraResized=this._onResizeCamera.bind(this)}__preload(){const t=this.getComponent("cc.Widget");t&&t.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(yD.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(fx.TRANSFORM_CHANGED,this._thisOnCameraResized)}onEnable(){super.onEnable(),this._cameraComponent&&this._cameraComponent.node.on(yD.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)}onDisable(){super.onDisable(),this._cameraComponent&&this._cameraComponent.node.off(yD.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)}onDestroy(){super.onDestroy(),this.node.off(fx.TRANSFORM_CHANGED,this._thisOnCameraResized)}_onResizeCamera(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=fw.height/2;else{const t=Wh.windowSize;this._cameraComponent.orthoHeight=t.height/Aw.getScaleY()/2}this.node.getWorldPosition(ZF),this._cameraComponent.node.setWorldPosition(ZF.x,ZF.y,1e3)}}_getViewPriority(){if(this._cameraComponent){var t;let e=null===(t=this.cameraComponent)||void 0===t?void 0:t.priority;return e=this._renderMode===QF.OVERLAY?e|1<<30:e&~(1<<30),e}return 0}}).prototype,"cameraComponent",[jF,WF],Object.getOwnPropertyDescriptor(KF.prototype,"cameraComponent"),KF.prototype),sc(KF.prototype,"alignCanvasWithScreen",[qF],Object.getOwnPropertyDescriptor(KF.prototype,"alignCanvasWithScreen"),KF.prototype),JF=sc(KF.prototype,"_cameraComponent",[XF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$F=sc(KF.prototype,"_alignCanvasWithScreen",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),YF=KF))||YF)||YF)||YF)||YF)||YF)||YF));var ez,iz,nz,sz,rz,oz,az,cz,lz,hz,_z,uz,dz,mz,pz,fz,gz,vz,yz,xz,Sz,Cz,Az,bz,Tz,Ez,Pz,wz,Iz,Rz,Dz,Mz,Oz,Bz,Nz,Lz,Fz,zz,Vz,Gz;l.Canvas=tz,G(t("UIComponent",dc("cc.UIComponent")(ez=mc(SO)(ez=pc(110)(ez=fc(ez=Ec(ez=class extends Lh{constructor(...t){super(...t),this._lastParent=null,this.stencilStage=xO.DISABLED}__preload(){this.node._uiProps.uiComp=this}onEnable(){}onDisable(){}onDestroy(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)}updateAssembler(t){}postUpdateAssembler(t){}markForUpdateRenderData(t=!0){}setNodeDirty(){}setTextureDirty(){}})||ez)||ez)||ez)||ez)||ez).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),G(HO.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor"},{name:"dstBlendFactor"}]),V(tz.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter(t){this._cameraComponent&&(this._cameraComponent.clearFlags=t)}},{name:"color",newName:"cameraComponent.clearColor",customGetter(){return this._cameraComponent?this._cameraComponent.clearColor:hi.BLACK},customSetter(t){this._cameraComponent&&(this._cameraComponent.clearColor=t)}},{name:"priority",newName:"cameraComponent.priority",customGetter(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter(t){this._cameraComponent&&(this._cameraComponent.priority=t)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter(t){this._cameraComponent&&(this._cameraComponent.targetTexture=t)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),U(SO.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),l.UITransformComponent=SO,Ut.setClassAlias(SO,"cc.UITransformComponent"),Ut.setClassAlias(HO,"cc.RenderComponent"),l.CanvasComponent=tz,Ut.setClassAlias(tz,"cc.CanvasComponent");const Uz=new wL,kz="RICHTEXT_CHILD",Hz="RICHTEXT_Image_CHILD",jz=new Vt((t=>{if(!l.isValid(t.node))return!1;{const e=t.node.getComponent(GL);e&&(e.width=0)}return!0}),20),Wz=new Vt((t=>l.isValid(t.node)),10);function qz(t){return{node:new iS(t),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:t}}function Xz(t,e){let i;t===kz?i=jz._get():t===Hz&&(i=Wz._get()),i=i||qz(t);let n=i.node;return n||(n=new iS(t)),n.hideFlags|=il.Flags.DontSave|il.Flags.HideInHierarchy,t===Hz?(i.comp=n.getComponent(FF)||n.addComponent(FF),i.comp.spriteFrame=e,i.comp.type=FF.Type.SLICED,i.comp.sizeMode=FF.SizeMode.CUSTOM):(i.comp=n.getComponent(lN)||n.addComponent(lN),i.comp.string=e,i.comp.horizontalAlign=iN.LEFT,i.comp.verticalAlign=nN.TOP,i.comp.underlineHeight=2),n.setPosition(0,0,0),n._uiProps.uiTransformComp.setAnchorPoint(.5,.5),i.node=n,i.lineCount=0,i.styleIndex=0,i.imageOffset="",i.clickParam="",i.clickHandler="",i}let Yz=function(e){return t({RichText:e,RichTextComponent:e}),e}((iz=dc("cc.RichText"),nz=Dc(),sz=pc(110),rz=Pc(),oz=Lc(),az=Kc(iN),cz=Lc(),lz=Kc(nN),hz=Lc(),_z=Lc(),uz=Lc(),dz=Kc(JD),mz=Lc(),pz=Lc(),fz=kc(),gz=Kc(rN),vz=Lc(),yz=Lc(),xz=Lc(),Sz=Kc(YD),Cz=Lc(),Az=Lc(),iz(bz=nz(bz=sz(bz=rz(bz=Ec((Gz=Vz=class extends Lh{get string(){return this._string}set string(t){this._string!==t&&(this._string=t,this._updateRichTextStatus())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(t){this.horizontalAlign!==t&&(this._horizontalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}get verticalAlign(){return this._verticalAlign}set verticalAlign(t){this._verticalAlign!==t&&(this._verticalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this._layoutDirty=!0,this._updateRichTextStatus())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this._layoutDirty=!0,this._updateRichTextStatus())}get font(){return this._font}set font(t){this._font!==t&&(this._font=t,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(t){this._isSystemFontUsed!==t&&(this._isSystemFontUsed=t,this._layoutDirty=!0,this._updateRichTextStatus())}get cacheMode(){return this._cacheMode}set cacheMode(t){this._cacheMode!==t&&(this._cacheMode=t,this._updateRichTextStatus())}get maxWidth(){return this._maxWidth}set maxWidth(t){this._maxWidth!==t&&(this._maxWidth=t,this._layoutDirty=!0,this._updateRichTextStatus())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this._layoutDirty=!0,this._updateRichTextStatus())}get imageAtlas(){return this._imageAtlas}set imageAtlas(t){this._imageAtlas!==t&&(this._imageAtlas=t,this._layoutDirty=!0,this._updateRichTextStatus())}get handleTouchEvent(){return this._handleTouchEvent}set handleTouchEvent(t){this._handleTouchEvent!==t&&(this._handleTouchEvent=t,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}constructor(){super(),nc(this,"_lineHeight",Ez,this),nc(this,"_string",Pz,this),nc(this,"_horizontalAlign",wz,this),nc(this,"_verticalAlign",Iz,this),nc(this,"_fontSize",Rz,this),nc(this,"_maxWidth",Dz,this),nc(this,"_fontFamily",Mz,this),nc(this,"_font",Oz,this),nc(this,"_isSystemFontUsed",Bz,this),nc(this,"_userDefinedFont",Nz,this),nc(this,"_cacheMode",Lz,this),nc(this,"_imageAtlas",Fz,this),nc(this,"_handleTouchEvent",zz,this),this._textArray=[],this._segments=[],this._labelSegmentsCache=[],this._linesWidth=[],this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0,this._lineOffsetX=0,this._updateRichTextStatus=void 0,this._labelChildrenNum=0,this._updateRichTextStatus=this._updateRichText}onLoad(){this.node.on(fx.LAYER_CHANGED,this._applyLayer,this)}onEnable(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}onDisable(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}start(){this._onTTFLoaded(),this.node.on(fx.ANCHOR_CHANGED,this._updateRichTextPosition,this)}onRestore(){}onDestroy(){for(const t of this._segments)t.node.removeFromParent(),t.type===kz?jz.put(t):t.type===Hz&&Wz.put(t);this.node.off(fx.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(fx.LAYER_CHANGED,this._applyLayer,this)}_addEventListeners(){this.node.on(fx.TOUCH_END,this._onTouchEnded,this)}_removeEventListeners(){this.node.off(fx.TOUCH_END,this._onTouchEnded,this)}_updateLabelSegmentTextAttributes(){this._segments.forEach((t=>{this._applyTextAttribute(t)}))}_createFontLabel(t){return Xz(kz,t)}_createImage(t){return Xz(Hz,t)}_onTTFLoaded(){this._font,this._layoutDirty=!0,this._updateRichText()}SplitLongStringApproximatelyIn2048(t,e){const i=[];if(this._calculateSize(e,t).x<2048)i.push(t);else{const n=t.split("\n");for(let t=0;t<n.length;t++)if(this._calculateSize(e,n[t]).x<2048)i.push(n[t]);else{const s=this.splitLongStringOver2048(n[t],e);i.push(...s)}}return i}splitLongStringOver2048(t,e){const i=[],n=t;let s=0,r=n.length/2,o=n.substring(s,r),a=n.substring(r),c=this._calculateSize(e,o),l=this._calculateSize(e,a);const h=1*this.maxWidth;for(;c.x>h;){if(r/=2,r<1){r*=2;break}o=o.substring(s,r),a=n.substring(r),c=this._calculateSize(e,o)}let _=1e3,u=1;for(;_&&s<t.length;){for(;_&&c.x<h;){const t=PM(a);t&&t.length>0&&(u=t[0].length),r+=u,o=n.substring(s,r),a=n.substring(r),c=this._calculateSize(e,o),_--}for(;_&&o.length>=2&&c.x>h;)r-=u,o=n.substring(s,r),c=this._calculateSize(e,o),u=1,_--;if(o.length>=2){const t=wM(o);t&&t.length>0&&o!==t[0]&&(r-=t[0].length,o=n.substring(s,r))}if(i.push(o),s=r,r+=o.length,o=n.substring(s,r),a=n.substring(r),l=this._calculateSize(e,a),_--,l.x<2048){s=t.length,r=t.length,o=a,i.push(o);break}c=this._calculateSize(e,o)}return i}_measureText(t,e){const i=e=>this._calculateSize(t,e).width;return e?i(e):i}_calculateSize(t,e){let i;return 0===this._labelSegmentsCache.length?(i=this._createFontLabel(e),this._labelSegmentsCache.push(i)):(i=this._labelSegmentsCache[0],i.node.getComponent(lN).string=e),i.styleIndex=t,this._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize}_onTouchEnded(t){const e=this.node.getComponents(Lh);for(const i of this._segments){const n=i.clickHandler,s=i.clickParam;n&&this._containsTouchLocation(i,t.touch.getUILocation())&&(e.forEach((e=>{const i=e[n];e.enabledInHierarchy&&i&&i.call(e,t,s)})),t.propagationStopped=!0)}}_containsTouchLocation(t,e){const i=t.node.getComponent(SO);return!!i&&i.getBoundingBoxToWorld().contains(e)}_resetState(){const t=this.node.children;for(let e=t.length-1;e>=0;e--){const i=t[e];if(i.name===kz||i.name===Hz){i.parent===this.node?i.parent=null:t.splice(e,1);const n=qz(i.name);n.node=i,i.name===kz?(n.comp=i.getComponent(lN),jz.put(n)):(n.comp=i.getComponent(FF),Wz.put(n)),this._labelChildrenNum--}}this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}_activateChildren(t){for(let e=this.node.children.length-1;e>=0;e--){const i=this.node.children[e];i.name!==kz&&i.name!==Hz||(i.active=t)}}_addLabelSegment(t,e){let i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(t);else{i=this._labelSegmentsCache.pop();const e=i.node.getComponent(lN);e&&(e.string=t)}const n=i.comp;return n.verticalAlign!==this._verticalAlign&&(n.verticalAlign=this._verticalAlign),i.styleIndex=e,i.lineCount=this._lineCount,i.node._uiProps.uiTransformComp.setAnchorPoint(0,0),i.node.layer=this.node.layer,this.node.insertChild(i.node,this._labelChildrenNum++),this._applyTextAttribute(i),this._segments.push(i),i}_updateRichTextWithMaxWidth(t,e,i){let n,s=e;if(this._lineOffsetX>0&&s+this._lineOffsetX>this._maxWidth){let e=0;for(;this._lineOffsetX<=this._maxWidth;){const n=this._getFirstWordLen(t,e,t.length),r=t.substr(e,n),o=this._measureText(i,r);if(!(this._lineOffsetX+o<=this._maxWidth)){if(e>0){const n=t.substr(0,e);this._addLabelSegment(n,i),t=t.substr(e,t.length),s=this._measureText(i,t)}this._updateLineInfo();break}this._lineOffsetX+=o,e+=n}}if(s>this._maxWidth){const e=IM(t,s,this._maxWidth,this._measureText(i));for(let t=0;t<e.length;++t){const s=e[t];n=this._addLabelSegment(s,i);const r=n.node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=r.width,e.length>1&&t<e.length-1&&this._updateLineInfo()}}else this._lineOffsetX+=s,this._addLabelSegment(t,i)}_isLastComponentCR(t){return t.length-1===t.lastIndexOf("\n")}_updateLineInfo(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}_needsUpdateTextLayout(t){if(this._layoutDirty||!this._textArray||!t)return!0;if(this._textArray.length!==t.length)return!0;for(let e=0;e<this._textArray.length;e++){const i=this._textArray[e],n=t[e];if(i.text!==n.text)return!0;{const t=i.style,e=n.style;if(t){if(e){if(!!e.outline!=!!t.outline)return!0;if(t.size!==e.size||t.italic!==e.italic||t.isImage!==e.isImage)return!0;if(t.src!==e.src||t.imageAlign!==e.imageAlign||t.imageHeight!==e.imageHeight||t.imageWidth!==e.imageWidth||t.imageOffset!==e.imageOffset)return!0}else if(t.size||t.italic||t.isImage||t.outline)return!0}else if(e&&(e.size||e.italic||e.isImage||e.outline))return!0}}return!1}_addRichTextImageElement(t){if(!t.style)return;const e=t.style,i=e.src,n=this._imageAtlas&&i&&this._imageAtlas.getSpriteFrame(i);if(n){const t=this._createImage(n);switch(t.comp,e.imageAlign){case"top":t.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":t.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:t.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}e.imageOffset&&(t.imageOffset=e.imageOffset),t.node.layer=this.node.layer,this.node.insertChild(t.node,this._labelChildrenNum++),this._segments.push(t);const i=n.rect.clone();let s=1,r=i.width,o=i.height;const a=e.imageWidth||0,c=e.imageHeight||0;c>0?(s=c/o,r*=s,o*=s):(s=this._lineHeight/o,r*=s,o*=s),a>0&&(r=a),this._maxWidth>0?(this._lineOffsetX+r>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=r):(this._lineOffsetX+=r,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),t.node._uiProps.uiTransformComp.setContentSize(r,o),t.lineCount=this._lineCount,t.clickHandler="",t.clickParam="";const l=e.event;l&&(t.clickHandler=l.click,t.clickParam=l.param)}else I(4400)}_updateRichText(){if(!this.enabledInHierarchy)return;const t=Uz.parse(this._string);if(!this._needsUpdateTextLayout(t))return this._textArray=t.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=t.slice(),this._resetState();let e,i=!1;for(let t=0;t<this._textArray.length;++t){const n=this._textArray[t];let s=n.text;if(void 0===s)continue;if(""===s){if(n.style&&n.style.isNewLine){this._updateLineInfo();continue}if(n.style&&n.style.isImage&&this._imageAtlas){this._addRichTextImageElement(n);continue}}s=this.SplitLongStringApproximatelyIn2048(s,t).join("\n");const r=s.split("\n");for(let n=0;n<r.length;++n){const o=r[n];if(""!==o)if(i=!1,this._maxWidth>0){const e=this._measureText(t,o);this._updateRichTextWithMaxWidth(o,e,t),r.length>1&&n<r.length-1&&this._updateLineInfo()}else e=this._addLabelSegment(o,t),this._lineOffsetX+=e.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),r.length>1&&n<r.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(s)&&n===r.length-1)continue;this._updateLineInfo(),i=!0}}}i||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+mM)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}_getFirstWordLen(t,e,i){let n=t.charAt(e);if(AM(n)||bM(n))return 1;let s=1;for(let r=e+1;r<i&&(n=t.charAt(r),!bM(n)&&!AM(n));++r)s++;return s}_updateRichTextPosition(){let t=0,e=1;const i=this._lineCount,n=this.node._uiProps.uiTransformComp,s=n.anchorX,r=n.anchorY;for(let n=0;n<this._segments.length;++n){const o=this._segments[n],a=o.lineCount;a>e&&(t=0,e=a);let c=this._labelWidth*(.5*this._horizontalAlign-s);switch(this._horizontalAlign){case iN.LEFT:break;case iN.CENTER:c-=this._linesWidth[a-1]/2;break;case iN.RIGHT:c-=this._linesWidth[a-1]}const l=o.node.position;if(o.node.setPosition(t+c,this._lineHeight*(i-a)-this._labelHeight*r,l.z),a===e&&(t+=o.node._uiProps.uiTransformComp.width),o.node.getComponent(FF)){const t=o.node.position.clone(),e=this._lineHeight,i=this._lineHeight*(1+mM);switch(o.node._uiProps.uiTransformComp.anchorY){case 1:t.y+=e+(i-e)/2;break;case.5:t.y+=i/2;break;default:t.y+=(i-e)/2}if(o.imageOffset){const e=o.imageOffset.split(",");if(1===e.length&&e[0]){const i=parseFloat(e[0]);Number.isInteger(i)&&(t.y+=i)}else if(2===e.length){const i=parseFloat(e[0]),n=parseFloat(e[1]);Number.isInteger(i)&&(t.x+=i),Number.isInteger(n)&&(t.y+=n)}}o.node.position=t}const h=o.node.getComponent(GL);if(h){const t=o.node.position.clone();t.y-=h.width,o.node.position=t}}}_convertLiteralColorValue(t){const e=t.toUpperCase();return hi[e]?hi[e]:(new hi).fromHEX(t)}_applyTextAttribute(t){const e=t.node.getComponent(lN);if(!e)return;this._resetLabelState(e);const i=t.styleIndex;let n;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(e.color=this._convertLiteralColorValue(n.color||"white"),e.isBold=!!n.bold,e.isItalic=!!n.italic,e.isUnderline=!!n.underline,n.outline){let e=t.node.getComponent(GL);e||(e=t.node.addComponent(GL)),e.color=this._convertLiteralColorValue(n.outline.color),e.width=n.outline.width}e.fontSize=n.size||this._fontSize,t.clickHandler="",t.clickParam="";const i=n.event;i&&(t.clickHandler=i.click||"",t.clickParam=i.param||"")}e.cacheMode=this._cacheMode,this._font instanceof JD&&!this._isSystemFontUsed?e.font=this._font:e.fontFamily=this._fontFamily,e.useSystemFont=this._isSystemFontUsed,e.lineHeight=this._lineHeight,e.updateRenderData(!0);const s=e._assembler;s&&s.updateRenderData(e)}_applyLayer(){for(const t of this._segments)t.node.layer=this.node.layer}_resetLabelState(t){t.fontSize=this._fontSize,t.color=hi.WHITE,t.isBold=!1,t.isItalic=!1,t.isUnderline=!1}},Vz.HorizontalAlign=iN,Vz.VerticalAlign=nN,sc((Tz=Gz).prototype,"string",[Hc,oz],Object.getOwnPropertyDescriptor(Tz.prototype,"string"),Tz.prototype),sc(Tz.prototype,"horizontalAlign",[az,cz],Object.getOwnPropertyDescriptor(Tz.prototype,"horizontalAlign"),Tz.prototype),sc(Tz.prototype,"verticalAlign",[lz,hz],Object.getOwnPropertyDescriptor(Tz.prototype,"verticalAlign"),Tz.prototype),sc(Tz.prototype,"fontSize",[_z],Object.getOwnPropertyDescriptor(Tz.prototype,"fontSize"),Tz.prototype),sc(Tz.prototype,"fontFamily",[uz],Object.getOwnPropertyDescriptor(Tz.prototype,"fontFamily"),Tz.prototype),sc(Tz.prototype,"font",[dz,mz],Object.getOwnPropertyDescriptor(Tz.prototype,"font"),Tz.prototype),sc(Tz.prototype,"useSystemFont",[pz,fz],Object.getOwnPropertyDescriptor(Tz.prototype,"useSystemFont"),Tz.prototype),sc(Tz.prototype,"cacheMode",[gz,vz],Object.getOwnPropertyDescriptor(Tz.prototype,"cacheMode"),Tz.prototype),sc(Tz.prototype,"maxWidth",[yz],Object.getOwnPropertyDescriptor(Tz.prototype,"maxWidth"),Tz.prototype),sc(Tz.prototype,"lineHeight",[xz],Object.getOwnPropertyDescriptor(Tz.prototype,"lineHeight"),Tz.prototype),sc(Tz.prototype,"imageAtlas",[Sz,Cz],Object.getOwnPropertyDescriptor(Tz.prototype,"imageAtlas"),Tz.prototype),sc(Tz.prototype,"handleTouchEvent",[Az],Object.getOwnPropertyDescriptor(Tz.prototype,"handleTouchEvent"),Tz.prototype),Ez=sc(Tz.prototype,"_lineHeight",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Pz=sc(Tz.prototype,"_string",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),wz=sc(Tz.prototype,"_horizontalAlign",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iN.LEFT}}),Iz=sc(Tz.prototype,"_verticalAlign",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nN.TOP}}),Rz=sc(Tz.prototype,"_fontSize",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Dz=sc(Tz.prototype,"_maxWidth",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mz=sc(Tz.prototype,"_fontFamily",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),Oz=sc(Tz.prototype,"_font",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bz=sc(Tz.prototype,"_isSystemFontUsed",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Nz=sc(Tz.prototype,"_userDefinedFont",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lz=sc(Tz.prototype,"_cacheMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rN.NONE}}),Fz=sc(Tz.prototype,"_imageAtlas",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zz=sc(Tz.prototype,"_handleTouchEvent",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bz=Tz))||bz)||bz)||bz)||bz)||bz));var Kz;l.RichText=Yz;let Jz=function(e){return t({UIMeshRenderer:e,UIModelComponent:e}),e}(dc("cc.UIMeshRenderer")(Kz=Dc()(Kz=pc(110)(Kz=Pc()(Kz=Ec(Kz=class extends Lh{constructor(...t){super(...t),this._modelComponent=null,this.stencilStage=xO.DISABLED}get modelComponent(){return this._modelComponent}__preload(){this.node._uiProps.uiComp=this}onLoad(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent||console.warn(`node '${this.node&&this.node.name}' doesn't have any renderable component`)}onDestroy(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null)}updateAssembler(t){if(this._modelComponent){const e=this._modelComponent._collectModels();this._modelComponent._detachFromScene();for(let i=0;i<e.length;i++)e[i].enabled&&t.commitModel(this,e[i],this._modelComponent.material);return!0}return!1}postUpdateAssembler(t){}update(){this._fitUIRenderQueue()}_fitUIRenderQueue(){if(!this._modelComponent)return;const t=this._modelComponent.sharedMaterials.length;for(let e=0;e<t;e++){const t=this._modelComponent.getMaterialInstance(e);if(null==t)continue;const i=t.passes,n=i.length;for(let e=0;e<n;e++)i[e]._priority=Jd.MAX-11,t.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},e)}}markForUpdateRenderData(t=!0){}setNodeDirty(){}setTextureDirty(){}})||Kz)||Kz)||Kz)||Kz)||Kz);l.UIMeshRenderer=Jz;const $z=Yd.Enum.NONE|Yd.Enum.UI_3D;class Zz{get native(){return this._nativeObj}get inputAssembler(){return this._inputAssembler}set inputAssembler(t){this._inputAssembler=t,this._nativeObj.inputAssembler=t}get descriptorSet(){return this._descriptorSet}set descriptorSet(t){this._descriptorSet=t,this._nativeObj.descriptorSet=t}get visFlags(){return this._visFlags}set visFlags(t){this._visFlags=t,this._nativeObj.visFlags=t}get passes(){return this._passes}get shaders(){return this._shaders}constructor(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=$z,this._inputAssembler=null,this._descriptorSet=null,this._nativeObj=new Aa,this._nativeObj.visFlags=this._visFlags}destroy(t){this._passes=[],this._nativeObj=null}clear(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=$z,this.renderScene=null}fillPasses(t,e,i,n,s,r,o){if(t){const o=t.passes;if(!o)return;let a=0,c=!1;this._shaders.length=o.length;for(let t=0;t<o.length;t++){this._passes[t]||(this._passes[t]=new Gf(l.director.root));const h=o[t],_=this._passes[t];h.update(),e||(e=h.depthStencilState,i=0),n||(n=h.blendState,s=0),-1===s&&(s=0),a=i<<16|s,_._initPassFromTarget(h,e,n,a),this._shaders[t]=_.getShaderVariant(r),c=!0}if(c){const t=[],e=this._passes;for(let i=0;i<e.length;i++)t.push(e[i].native);this._nativeObj.passes=t,this._nativeObj.shaders=this._shaders}}}}var Qz,tV,eV,iV,nV,sV,rV;t("UIDrawBatch",Zz);let oV=function(e){return t({UIStaticBatch:e,UIStaticBatchComponent:e}),e}((Qz=dc("cc.UIStaticBatch"),tV=Dc(),eV=Pc(),iV=pc(110),nV=Oc(),Qz(sV=tV(sV=eV(sV=iV((sc((rV=class extends HO{constructor(...t){super(...t),this._init=!1,this._bufferAccessor=null,this._dirty=!0,this._uiDrawBatchList=[]}get color(){return this._color}set color(t){this._color!==t&&this._color.set(t)}get drawBatchList(){return this._uiDrawBatchList}onLoad(){}onDestroy(){}updateAssembler(t){}postUpdateAssembler(t){}markAsDirty(){}_requireDrawBatch(){const t=new Zz;return t.isStatic=!0,this._uiDrawBatchList.push(t),t}_clearData(){if(this._bufferAccessor){this._bufferAccessor.reset();const t=this._getBatcher();for(let e=0;e<this._uiDrawBatchList.length;e++)this._uiDrawBatchList[e].destroy(t)}this._uiDrawBatchList.length=0,this._init=!1}_getBatcher(){return mw.root&&mw.root.batcher2D?mw.root.batcher2D:(I(9301),null)}}).prototype,"color",[Jc,nV],Object.getOwnPropertyDescriptor(rV.prototype,"color"),rV.prototype),sV=rV))||sV)||sV)||sV)||sV));var aV,cV,lV,hV,_V,uV,dV,mV,pV,fV,gV,vV,yV;let xV=t("LabelShadow",(aV=dc("cc.LabelShadow"),cV=Dc(),lV=pc(110),hV=Pc(),_V=mc(lN),uV=Lc(),dV=Lc(),mV=Lc(),aV(pV=cV(pV=lV(pV=hV(pV=_V(pV=Ec((gV=sc((fV=class extends Lh{constructor(...t){super(...t),nc(this,"_color",gV,this),nc(this,"_offset",vV,this),nc(this,"_blur",yV,this)}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}get offset(){return this._offset}set offset(t){this._offset=t,this._updateRenderData()}get blur(){return this._blur}set blur(t){this._blur=t,this._updateRenderData()}onEnable(){this._updateRenderData()}onDisable(){this._updateRenderData()}_updateRenderData(){const t=this.node.getComponent(lN);t&&t.updateRenderData(!0)}}).prototype,"_color",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(0,0,0,255)}}),vV=sc(fV.prototype,"_offset",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi(2,2)}}),yV=sc(fV.prototype,"_blur",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),sc(fV.prototype,"color",[uV],Object.getOwnPropertyDescriptor(fV.prototype,"color"),fV.prototype),sc(fV.prototype,"offset",[dV],Object.getOwnPropertyDescriptor(fV.prototype,"offset"),fV.prototype),sc(fV.prototype,"blur",[mV],Object.getOwnPropertyDescriptor(fV.prototype,"blur"),fV.prototype),pV=fV))||pV)||pV)||pV)||pV)||pV)||pV));var SV,CV,AV,bV,TV,EV,PV,wV;let IV=function(e){return t({UIOpacity:e,UIOpacityComponent:e}),e}((SV=dc("cc.UIOpacity"),CV=Dc(),AV=pc(110),bV=Pc(),TV=Lc(),SV(EV=CV(EV=AV(EV=bV(EV=Ec(EV=fc((sc((PV=class extends Lh{constructor(...t){super(...t),nc(this,"_opacity",wV,this)}get opacity(){return this._opacity}set opacity(t){this._opacity!==t&&(t=re(t,0,255),this._opacity=t,this.node._uiProps.localOpacity=t/255)}onEnable(){this.node._uiProps.localOpacity=this._opacity/255}onDisable(){this.node._uiProps.localOpacity=1}}).prototype,"opacity",[Mc,TV],Object.getOwnPropertyDescriptor(PV.prototype,"opacity"),PV.prototype),wV=sc(PV.prototype,"_opacity",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),EV=PV))||EV)||EV)||EV)||EV)||EV)||EV));l.MaskComponent=TL,Ut.setClassAlias(TL,"cc.MaskComponent"),l.LabelComponent=lN,Ut.setClassAlias(lN,"cc.LabelComponent"),l.LabelOutlineComponent=GL,Ut.setClassAlias(GL,"cc.LabelOutlineComponent"),l.RichTextComponent=Yz,Ut.setClassAlias(Yz,"cc.RichTextComponent"),l.SpriteComponent=FF,Ut.setClassAlias(FF,"cc.SpriteComponent"),l.UIModelComponent=Jz,Ut.setClassAlias(Jz,"cc.UIModelComponent"),l.GraphicsComponent=KN,Ut.setClassAlias(KN,"cc.GraphicsComponent"),Ut.setClassAlias(oV,"cc.UIStaticBatchComponent"),Ut.setClassAlias(IV,"cc.UIOpacityComponent");class RV{constructor(t,e,i){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=e,this.y=i}}function DV(t,e,i,n,s){let r=0,o=null;if(s===function(t,e,i,n){let s=0;for(let r=e,o=i-n;r<i;r+=n)s+=(t[o]-t[r])*(t[r+1]+t[o+1]),o=r;return s}(t,e,i,n)>0)for(r=e;r<i;r+=n)o=KV(r,t[r],t[r+1],o);else for(r=i-n;r>=e;r-=n)o=KV(r,t[r],t[r+1],o);return o&&WV(o,o.next)&&(JV(o),o=o.next),o}function MV(t,e=null){if(!t)return t;e||(e=t);let i=t,n=!1;do{if(n=!1,i.steiner||!WV(i,i.next)&&0!==jV(i.prev,i,i.next))i=i.next;else{if(JV(i),i=e=i.prev,i===i.next)return null;n=!0}}while(n||i!==e);return e}function OV(t,e,i,n,s,r,o=0){if(!t)return;!o&&r&&function(t,e,i,n){let s=t;do{null===s.z&&(s.z=GV(s.x,s.y,e,i,n)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==t);s.prevZ.nextZ=null,s.prevZ=null,function(t){let e=0,i=null,n=null,s=null,r=null,o=0,a=0,c=0,l=1;do{for(i=t,t=null,r=null,o=0;i;){for(o++,n=i,a=0,e=0;e<l&&(a++,n=n.nextZ,n);e++);for(c=l;a>0||c>0&&n;)0===a?(s=n,n=n.nextZ,c--):0!==c&&n?i.z<=n.z?(s=i,i=i.nextZ,a--):(s=n,n=n.nextZ,c--):(s=i,i=i.nextZ,a--),r?r.nextZ=s:t=s,s.prevZ=r,r=s;i=n}r.nextZ=null,l*=2}while(o>1)}(s)}(t,n,s,r);let a=t,c=null,l=null;for(;t.prev!==t.next;)if(c=t.prev,l=t.next,r?NV(t,n,s,r):BV(t))e.push(c.i/i),e.push(t.i/i),e.push(l.i/i),JV(t),t=l.next,a=l.next;else if((t=l)===a){o?1===o?OV(t=LV(t,e,i),e,i,n,s,r,2):2===o&&FV(t,e,i,n,s,r):OV(MV(t),e,i,n,s,r,1);break}}function BV(t){const e=t.prev,i=t,n=t.next;if(jV(e,i,n)>=0)return!1;let s=t.next.next;for(;s!==t.prev;){if(kV(e.x,e.y,i.x,i.y,n.x,n.y,s.x,s.y)&&jV(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function NV(t,e,i,n){const s=t.prev,r=t,o=t.next;if(jV(s,r,o)>=0)return!1;const a=s.x<r.x?s.x<o.x?s.x:o.x:r.x<o.x?r.x:o.x,c=s.y<r.y?s.y<o.y?s.y:o.y:r.y<o.y?r.y:o.y,l=s.x>r.x?s.x>o.x?s.x:o.x:r.x>o.x?r.x:o.x,h=s.y>r.y?s.y>o.y?s.y:o.y:r.y>o.y?r.y:o.y,_=GV(a,c,e,i,n),u=GV(l,h,e,i,n);let d=t.nextZ;for(;d&&d.z<=u;){if(d!==t.prev&&d!==t.next&&kV(s.x,s.y,r.x,r.y,o.x,o.y,d.x,d.y)&&jV(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(d=t.prevZ;d&&d.z>=_;){if(d!==t.prev&&d!==t.next&&kV(s.x,s.y,r.x,r.y,o.x,o.y,d.x,d.y)&&jV(d.prev,d,d.next)>=0)return!1;d=d.prevZ}return!0}function LV(t,e,i){let n=t;do{const s=n.prev,r=n.next.next;!WV(s,r)&&qV(s,n,n.next,r)&&XV(s,r)&&XV(r,s)&&(e.push(s.i/i),e.push(n.i/i),e.push(r.i/i),JV(n),JV(n.next),n=t=r),n=n.next}while(n!==t);return n}function FV(t,e,i,n,s,r){let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.i!==t.i&&HV(o,t)){let a=YV(o,t);return o=MV(o,o.next),a=MV(a,a.next),OV(o,e,i,n,s,r),void OV(a,e,i,n,s,r)}t=t.next}o=o.next}while(o!==t)}function zV(t,e){return t.x-e.x}function VV(t,e){if(e=function(t,e){let i=e;const n=t.x,s=t.y;let r=-1/0,o=null;do{if(s<=i.y&&s>=i.next.y){const t=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(t<=n&&t>r){if(r=t,t===n){if(s===i.y)return i;if(s===i.next.y)return i.next}o=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!o)return null;if(n===r)return o.prev;const a=o,c=o.x,l=o.y;let h,_=1/0;for(i=o.next;i!==a;)n>=i.x&&i.x>=c&&kV(s<l?n:r,s,c,l,s<l?r:n,s,i.x,i.y)&&(h=Math.abs(s-i.y)/(n-i.x),(h<_||h===_&&i.x>o.x)&&XV(i,t)&&(o=i,_=h)),i=i.next;return o}(t,e)){const i=YV(e,t);MV(i,i.next)}}function GV(t,e,i,n,s){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/s)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/s)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function UV(t){let e=t,i=t;do{e.x<i.x&&(i=e),e=e.next}while(e!==t);return i}function kV(t,e,i,n,s,r,o,a){return(s-o)*(e-a)-(t-o)*(r-a)>=0&&(t-o)*(n-a)-(i-o)*(e-a)>=0&&(i-o)*(r-a)-(s-o)*(n-a)>=0}function HV(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&qV(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&XV(t,e)&&XV(e,t)&&function(t,e){let i=t,n=!1;const s=(t.x+e.x)/2,r=(t.y+e.y)/2;do{i.y>r!=i.next.y>r&&s<(i.next.x-i.x)*(r-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}(t,e)}function jV(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function WV(t,e){return t.x===e.x&&t.y===e.y}function qV(t,e,i,n){return!!(WV(t,e)&&WV(i,n)||WV(t,n)&&WV(i,e))||jV(t,e,i)>0!=jV(t,e,n)>0&&jV(i,n,t)>0!=jV(i,n,e)>0}function XV(t,e){return jV(t.prev,t,t.next)<0?jV(t,e,t.next)>=0&&jV(t,t.prev,e)>=0:jV(t,e,t.prev)<0||jV(t,t.next,e)<0}function YV(t,e){const i=new RV(t.i,t.x,t.y),n=new RV(e.i,e.x,e.y),s=t.next,r=e.prev;return t.next=e,e.prev=t,i.next=s,s.prev=i,n.next=i,i.prev=n,r.next=n,n.prev=r,n}function KV(t,e,i,n){const s=new RV(t,e,i);return n?(s.next=n.next,s.prev=n,n.next.prev=s,n.next=s):(s.prev=s,s.next=s),s}function JV(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function $V(t,e,i){i=i||3;const n=e?e.length:0,s=n?e[0]*i:t.length;let r=DV(t,0,s,i,!0);const o=[];if(!r)return o;let a=0,c=0,l=0,h=0,_=0,u=0,d=0;if(n&&(r=function(t,e,i,n){const s=[];let r=0,o=0,a=0,c=0,l=null;for(r=0,o=e.length;r<o;r++)a=e[r]*n,c=r<o-1?e[r+1]*n:t.length,l=DV(t,a,c,n,!1),l&&(l===l.next&&(l.steiner=!0),s.push(UV(l)));if(s.sort(zV),!i)return i;for(r=0;r<s.length;r++)VV(s[r],i),i=MV(i,i.next);return i}(t,e,r,i)),t.length>80*i){a=l=t[0],c=h=t[1];for(let e=i;e<s;e+=i)_=t[e],u=t[e+1],_<a&&(a=_),u<c&&(c=u),_>l&&(l=_),u>h&&(h=u);d=Math.max(l-a,h-c)}return OV(r,o,i,a,c,d),o}const ZV=Math.PI,QV=Math.min,tG=Math.max,eG=Math.ceil,iG=Math.acos,nG=Math.cos,sG=Math.sin,rG=Math.atan2;let oG=null,aG=null;const cG=new hi,lG=[];for(let t=0;t<4;t++)lG.push(new mi);function hG(t,e,i){return t<e?e:t>i?i:t}const _G={useModel:!0,updateRenderData(t){},fillBuffers(t,e){},renderIA(t,e){},getRenderData(t,e){if(!aG)return null;const i=aG.getRenderDataList();let n=i[aG.dataOffset];if(!n)return null;let s=n;const r=s?s.vertexStart+e:0;return(r>65535||3*r>131070)&&(++aG.dataOffset,aG.dataOffset<i.length?n=i[aG.dataOffset]:(n=aG.requestRenderData(),i[aG.dataOffset]=n),s=n),s&&s.vertexCount<r&&s.request(e,3*e),n},stroke(t){hi.copy(cG,t.strokeColor),t.impl&&(this._flattenPaths(t.impl),this._expandStroke(t),t.impl.updatePathOffset=!0,this.end(t))},fill(t){hi.copy(cG,t.fillColor),this._expandFill(t),t.impl&&(t.impl.updatePathOffset=!0),this.end(t)},end(t){t.markForUpdateRenderData()},_expandStroke(t){const e=.5*t.lineWidth,i=t.lineCap,n=t.lineJoin,s=t.miterLimit;if(aG=t.impl,!aG)return;const r=function(t,e,i){const n=2*iG(t/(t+i));return tG(2,eG(e/n))}(e,ZV,aG.tessTol);this._calculateJoins(aG,e,n,s);const o=aG.paths;let a=0;for(let t=aG.pathOffset,e=aG.pathLength;t<e;t++){const e=o[t],s=e.points.length;n===aN.ROUND?a+=2*(s+e.bevel*(r+2)+1):a+=2*(s+5*e.bevel+1),e.closed||(i===oN.ROUND?a+=2*(2*r+2):a+=12)}const c=oG=this.getRenderData(t,a);if(!c)return;const l=c.vData,h=c.iData;for(let t=aG.pathOffset,s=aG.pathLength;t<s;t++){const s=o[t],a=s.points,_=a.length,u=c.vertexStart;let d,m,p=0,f=0;const g=s.closed;if(g?(d=a[_-1],m=a[0],p=0,f=_):(d=a[0],m=a[1],p=1,f=_-1),m=m||d,!g){const t=new xN(m.x,m.y);t.subtract(d),t.normalize();const n=t.x,s=t.y;i===oN.BUTT?this._buttCapStart(d,n,s,e,0):i===oN.SQUARE?this._buttCapStart(d,n,s,e,e):i===oN.ROUND&&this._roundCapStart(d,n,s,e,r)}for(let t=p;t<f;++t)n===aN.ROUND?this._roundJoin(d,m,e,e,r):0!=(m.flags&(cN.PT_BEVEL|cN.PT_INNERBEVEL))?this._bevelJoin(d,m,e,e):(this._vSet(m.x+m.dmx*e,m.y+m.dmy*e,1),this._vSet(m.x-m.dmx*e,m.y-m.dmy*e,-1)),d=m,m=a[t+1];if(g){const t=8*u;this._vSet(l[t],l[t+1],1),this._vSet(l[t+8],l[t+8+1],-1)}else{const t=new xN(m.x,m.y);t.subtract(d),t.normalize();const n=t.x,s=t.y;i===oN.BUTT?this._buttCapEnd(m,n,s,e,0):i===oN.SQUARE?this._buttCapEnd(m,n,s,e,e):i===oN.ROUND&&this._roundCapEnd(m,n,s,e,r)}let v=c.indexStart;for(let t=u+2,e=c.vertexStart;t<e;t++)h[v++]=t-2,h[v++]=t-1,h[v++]=t;c.indexStart=v}oG=null,aG=null},_expandFill(t){if(aG=t.impl,!aG)return;const e=aG.paths;let i=0;for(let t=aG.pathOffset,n=aG.pathLength;t<n;t++)i+=e[t].points.length;const n=oG=this.getRenderData(t,i);if(!n)return;const s=n,r=s.vData,o=s.iData;for(let t=aG.pathOffset,i=aG.pathLength;t<i;t++){const i=e[t],a=i.points,c=a.length;if(0===c)continue;const l=n.vertexStart;for(let t=0;t<c;++t)this._vSet(a[t].x,a[t].y);let h=n.indexStart;if(i.complex){const t=[];for(let e=l,i=n.vertexStart;e<i;e++){let i=8*e;t.push(r[i++]),t.push(r[i++]),t.push(r[i++])}const e=$V(t,null,3);if(!e||0===e.length)continue;for(let t=0,i=e.length;t<i;t++)o[h++]=e[t]+l}else{const t=l;for(let e=l+2,i=s.vertexStart;e<i;e++)o[h++]=t,o[h++]=e-1,o[h++]=e}s.indexStart=h}oG=null,aG=null},_calculateJoins(t,e,i,n){let s=0;e>0&&(s=1/e);const r=t.paths;for(let e=t.pathOffset,o=t.pathLength;e<o;e++){const t=r[e],o=t.points,a=o.length;let c=o[a-1],l=o[0];t.bevel=0;for(let e=0;e<a;e++){let r=0,a=0,h=0;const _=c.dy,u=-c.dx,d=l.dy,m=-l.dx;if(l.dmx=.5*(_+d),l.dmy=.5*(u+m),r=l.dmx*l.dmx+l.dmy*l.dmy,r>1e-6){let t=1/r;t>600&&(t=600),l.dmx*=t,l.dmy*=t}a=l.dx*c.dy-c.dx*l.dy,a>0&&(l.flags|=cN.PT_LEFT),h=tG(11,QV(c.len,l.len)*s),r*h*h<1&&(l.flags|=cN.PT_INNERBEVEL),l.flags&cN.PT_CORNER&&(r*n*n<1||i===aN.BEVEL||i===aN.ROUND)&&(l.flags|=cN.PT_BEVEL),0!=(l.flags&(cN.PT_BEVEL|cN.PT_INNERBEVEL))&&t.bevel++,c=l,l=o[e+1]}}},_flattenPaths(t){const e=t.paths;for(let i=t.pathOffset,n=t.pathLength;i<n;i++){const t=e[i],n=t.points;let s=n[n.length-1],r=n[0];n.length>2&&s.equals(r)&&(t.closed=!0,n.pop(),s=n[n.length-1]);for(let t=0,e=n.length;t<e;t++){const e=new xN(r.x,r.y);e.subtract(s),s.len=e.length(),(e.x||e.y)&&e.normalize(),s.dx=e.x,s.dy=e.y,s=r,r=n[t+1]}}},_chooseBevel(t,e,i,n){const s=i.x,r=i.y;let o=0,a=0,c=0,l=0;return 0!==t?(o=s+e.dy*n,a=r-e.dx*n,c=s+i.dy*n,l=r-i.dx*n):(o=c=s+i.dmx*n,a=l=r+i.dmy*n),[o,a,c,l]},_buttCapStart(t,e,i,n,s){const r=t.x-e*s,o=t.y-i*s,a=i,c=-e;this._vSet(r+a*n,o+c*n,1),this._vSet(r-a*n,o-c*n,-1)},_buttCapEnd(t,e,i,n,s){const r=t.x+e*s,o=t.y+i*s,a=i,c=-e;this._vSet(r+a*n,o+c*n,1),this._vSet(r-a*n,o-c*n,-1)},_roundCapStart(t,e,i,n,s){const r=t.x,o=t.y,a=i,c=-e;for(let t=0;t<s;t++){const l=t/(s-1)*ZV,h=nG(l)*n,_=sG(l)*n;this._vSet(r-a*h-e*_,o-c*h-i*_,1),this._vSet(r,o,0)}this._vSet(r+a*n,o+c*n,1),this._vSet(r-a*n,o-c*n,-1)},_roundCapEnd(t,e,i,n,s){const r=t.x,o=t.y,a=i,c=-e;this._vSet(r+a*n,o+c*n,1),this._vSet(r-a*n,o-c*n,-1);for(let t=0;t<s;t++){const l=t/(s-1)*ZV,h=nG(l)*n,_=sG(l)*n;this._vSet(r,o,0),this._vSet(r-a*h+e*_,o-c*h+i*_,1)}},_roundJoin(t,e,i,n,s){const r=t.dy,o=-t.dx,a=e.dy,c=-e.dx,l=e.x,h=e.y;if(0!=(e.flags&cN.PT_LEFT)){const _=this._chooseBevel(e.flags&cN.PT_INNERBEVEL,t,e,i),u=_[0],d=_[1],m=_[2],p=_[3],f=rG(-o,-r);let g=rG(-c,-a);g>f&&(g-=2*ZV),this._vSet(u,d,1),this._vSet(l-r*n,e.y-o*n,-1);const v=hG(eG((f-g)/ZV)*s,2,s);for(let t=0;t<v;t++){const e=f+t/(v-1)*(g-f),i=l+nG(e)*n,s=h+sG(e)*n;this._vSet(l,h,0),this._vSet(i,s,-1)}this._vSet(m,p,1),this._vSet(l-a*n,h-c*n,-1)}else{const _=this._chooseBevel(e.flags&cN.PT_INNERBEVEL,t,e,-n),u=_[0],d=_[1],m=_[2],p=_[3],f=rG(o,r);let g=rG(c,a);g<f&&(g+=2*ZV),this._vSet(l+r*n,h+o*n,1),this._vSet(u,d,-1);const v=hG(eG((g-f)/ZV)*s,2,s);for(let t=0;t<v;t++){const e=f+t/(v-1)*(g-f),n=l+nG(e)*i,s=h+sG(e)*i;this._vSet(n,s,1),this._vSet(l,h,0)}this._vSet(l+a*n,h+c*n,1),this._vSet(m,p,-1)}},_bevelJoin(t,e,i,n){let s=0,r=0,o=0,a=0,c=0,l=0,h=0,_=0;const u=t.dy,d=-t.dx,m=e.dy,p=-e.dx;if(e.flags&cN.PT_LEFT){const s=this._chooseBevel(e.flags&cN.PT_INNERBEVEL,t,e,i);c=s[0],l=s[1],h=s[2],_=s[3],this._vSet(c,l,1),this._vSet(e.x-u*n,e.y-d*n,-1),this._vSet(h,_,1),this._vSet(e.x-m*n,e.y-p*n,-1)}else{const c=this._chooseBevel(e.flags&cN.PT_INNERBEVEL,t,e,-n);s=c[0],r=c[1],o=c[2],a=c[3],this._vSet(e.x+u*i,e.y+d*i,1),this._vSet(s,r,-1),this._vSet(e.x+m*i,e.y+p*i,1),this._vSet(o,a,-1)}},_vSet(t,e,i=0){if(!oG)return;const n=oG;let s=8*n.vertexStart;const r=n.vData;r[s++]=t,r[s++]=e,r[s++]=0,hi.toArray(r,cG,s),s+=4,r[s++]=i,n.vertexStart++}},uG=t("graphicsAssembler",{getAssembler:()=>_G});KN.Assembler=uG;class dG{constructor(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""}}const mG=new ki;let pG=null,fG=null;const gG=[],vG=[],yG=[],xG=[],SG=new Gi,CG=new Gi,AG=new Oi;let bG=null,TG=0,EG=0,PG=0,wG=0,IG=0,RG=1,DG=null,MG="",OG=0,BG=0,NG=0,LG=0,FG=0,zG=0,VG=0,GG=!1,UG=0,kG=0,HG=0;const jG={updateRenderData(t){t.renderData&&pG!==t&&(t.renderData.vertDirty&&(pG=t,fG=pG.node._uiProps.uiTransformComp,this._updateFontFamily(t),this._updateProperties(t),this._updateLabelInfo(t),this._updateContent(),pG.actualFontSize=OG,fG.setContentSize(CG),this.updateUVs(t),pG.renderData.vertDirty=!1,pG.markForUpdateRenderData(!1),pG=null,this._resetProperties()),t.spriteFrame)&&t.renderData.updateRenderData(t,t.spriteFrame)},updateUVs(t){const e=t.renderData,i=e.chunk.vb,n=e.vertexCount,s=e.data;let r=3;for(let t=0;t<n;t++){const e=s[t];i[r]=e.u,i[r+1]=e.v,r+=9}},_updateFontScale(){RG=OG/BG},_updateFontFamily(t){const e=t.font;DG=e.spriteFrame,bG=e.fntConfig,zM.fontAtlas=e.fontDefDictionary,VD.packToDynamicAtlas(t,DG)},_updateLabelInfo(t){zM.hash="",zM.margin=0},_updateProperties(t){MG=t.string.toString(),OG=t.fontSize,BG=bG?bG.fontSize:t.fontSize,NG=t.horizontalAlign,LG=t.verticalAlign,FG=t.spacingX,VG=t.overflow,zG=t._lineHeight;const e=fG.contentSize;CG.width=e.width,CG.height=e.height,VG===sN.NONE?(GG=!1,CG.width+=2*zM.margin,CG.height+=2*zM.margin):VG===sN.RESIZE_HEIGHT?(GG=!0,CG.height+=2*zM.margin):GG=t.enableWrapText,zM.lineHeight=zG,zM.fontSize=OG,this._setupBMFontOverflowMetrics()},_resetProperties(){bG=null,DG=null,zM.hash="",zM.margin=0},_updateContent(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText(){const t=MG,e=t.length,i=bG.kerningDict,n=gG;let s=-1;for(let r=0;r<e;++r){const o=t.charCodeAt(r),a=i[s<<16|65535&o]||0;n[r]=r<e-1?a:0,s=o}},_multilineTextWrap(t){const e=MG.length;let i=0,n=0,s=0,r=0,o=0,a=0,c=0,l=null;for(let h=0;h<e;){let _=MG.charAt(h);if("\n"===_){yG.push(o),o=0,i++,n=0,s-=zG*this._getFontScale()+0,this._recordPlaceholderInfo(h,_),h++;continue}const u=t(MG,h,e);let d=a,m=c,p=o,f=n,g=!1;for(let t=0;t<u;++t){const r=h+t;if(_=MG.charAt(r),"\r"===_){this._recordPlaceholderInfo(r,_);continue}if(l=zM.fontAtlas.getLetterDefinitionForChar(_,zM),!l){this._recordPlaceholderInfo(r,_),console.log(`Can't find letter definition in texture atlas ${bG.atlasName} for letter:${_}`);continue}const a=f+l.offsetX*RG-zM.margin;if(GG&&HG>0&&n>0&&a+l.w*RG>HG&&!bM(_)){yG.push(o),o=0,i++,n=0,s-=zG*this._getFontScale()+0,g=!0;break}AG.x=a,AG.y=s-l.offsetY*RG,this._recordLetterInfo(AG,_,r,i),r+1<gG.length&&r<e-1&&(f+=gG[r+1]),f+=l.xAdvance*RG+FG,p=AG.x+l.w*RG,d<AG.y&&(d=AG.y),m>AG.y-l.h*RG&&(m=AG.y-l.h*RG)}g||(n=f,o=p,a<d&&(a=d),c>m&&(c=m),r<o&&(r=o),h+=u)}return yG.push(o),TG=i+1,EG=TG*zG*this._getFontScale(),TG>1&&(EG+=0*(TG-1)),CG.width=UG,CG.height=kG,UG<=0&&(CG.width=parseFloat(r.toFixed(2))+2*zM.margin),kG<=0&&(CG.height=parseFloat(EG.toFixed(2))+2*zM.margin),wG=CG.height,IG=0,a>0&&(wG=CG.height+a),c<-EG&&(IG=EG+c),!0},_getFirstCharLen:()=>1,_getFontScale:()=>VG===sN.SHRINK?RG:1,_getFirstWordLen(t,e,i){let n=t.charAt(e);if(AM(n)||"\n"===n||bM(n))return 1;let s=1,r=zM.fontAtlas.getLetterDefinitionForChar(n,zM);if(!r)return s;let o=r.xAdvance*RG+FG,a=0;for(let c=e+1;c<i&&(n=t.charAt(c),r=zM.fontAtlas.getLetterDefinitionForChar(n,zM),r);++c){if(a=o+r.offsetX*RG,a+r.w*RG>HG&&!bM(n)&&HG>0)return s;if(o+=r.xAdvance*RG+FG,"\n"===n||bM(n)||AM(n))break;s++}return s},_multilineTextWrapByWord(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo(t,e){if(t>=vG.length){const t=new dG;vG.push(t)}vG[t].char=e,vG[t].hash=`${e.charCodeAt(0)}${zM.hash}`,vG[t].valid=!1},_recordLetterInfo(t,e,i,n){if(i>=vG.length){const t=new dG;vG.push(t)}const s=`${e.charCodeAt(0)}${zM.hash}`;vG[i].line=n,vG[i].char=e,vG[i].hash=s,vG[i].valid=zM.fontAtlas.getLetter(s).valid,vG[i].x=t.x,vG[i].y=t.y},_alignText(){EG=0,yG.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),VG===sN.SHRINK&&OG>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||VG===sN.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown(t){let e=!0;t||(t=.1,e=!1),OG=t,e&&this._updateContent()},_shrinkLabelToContentSize(t){let e=0,i=0|OG,n=0;for(;e<i;){n=e+i+1>>1;const s=n;if(s<=0)break;RG=s/BG,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),t()?i=n-1:e=n}e>=0&&this._scaleFontSizeDown(e)},_isVerticalClamp:()=>EG>CG.height,_isHorizontalClamp(){let t=!1;for(let e=0,i=MG.length;e<i;++e){const i=vG[e];if(i.valid){const e=zM.fontAtlas.getLetterDefinitionForChar(i.char,zM);if(!e)continue;const n=i.x+e.w*RG,s=i.line;if(UG>0)if(GG){if(yG[s]>CG.width&&(n>CG.width||n<0)){t=!0;break}}else if(n>CG.width){t=!0;break}}}return t},_isHorizontalClamped(t,e){const i=yG[e],n=t>CG.width||t<0;return GG?i>CG.width&&n:n},_updateQuads(){if(!pG)return!1;const t=DG?DG.texture:zM.fontAtlas.getTexture(),e=pG.renderData;e.dataLength=0,e.resize(0,0);const i=fG.anchorPoint,n=CG,s=i.x*n.width,r=i.y*n.height;let o=!0;for(let e=0,i=MG.length;e<i;++e){const i=vG[e];if(!i.valid)continue;const n=zM.fontAtlas.getLetter(i.hash);if(!n){console.warn("Can't find letter in this bitmap-font");continue}mG.height=n.h,mG.width=n.w,mG.x=n.u,mG.y=n.v;let a=i.y+PG;if(kG>0){if(a>wG){const t=a-wG;mG.y+=t,mG.height-=t,a-=t}a-n.h*RG<IG&&VG===sN.CLAMP&&(mG.height=a<IG?0:(a-IG)/RG)}const c=i.line,l=i.x+n.w/2*RG+xG[c];if(UG>0&&this._isHorizontalClamped(l,c))if(VG===sN.CLAMP)mG.width=0;else if(VG===sN.SHRINK){if(CG.width>n.w){o=!1;break}mG.width=0}if(mG.height>0&&mG.width>0){const e=this._determineRect(),n=i.x+xG[i.line];this.appendQuad(pG,t,mG,e,n-s,a-r,RG)}}return o},appendQuad(t,e,i,n,s,r,o){},_determineRect(){const t=DG.isRotated(),e=DG.getOriginalSize(),i=DG.getRect(),n=DG.getOffset(),s=n.x+(e.width-i.width)/2,r=n.y-(e.height-i.height)/2;if(t){const t=mG.x;mG.x=i.x+i.height-mG.y-mG.height-r,mG.y=t+i.y-s,mG.y<0&&(mG.height+=r)}else mG.x+=i.x-s,mG.y+=i.y+r;return t},_computeAlignmentOffset(){switch(xG.length=0,NG){case iN.LEFT:for(let t=0;t<TG;++t)xG.push(0);break;case iN.CENTER:for(let t=0,e=yG.length;t<e;t++)xG.push((CG.width-yG[t])/2);break;case iN.RIGHT:for(let t=0,e=yG.length;t<e;t++)xG.push(CG.width-yG[t])}if(PG=CG.height,LG!==nN.TOP){const t=CG.height-EG+zG*this._getFontScale()-BG*RG;LG===nN.BOTTOM?PG-=t:PG-=t/2}},_setupBMFontOverflowMetrics(){let t=CG.width,e=CG.height;VG===sN.RESIZE_HEIGHT&&(e=0),VG===sN.NONE&&(t=0,e=0),UG=t,kG=e,SG.width=t,SG.height=e,HG=t}},WG=new hi(255,255,255,255),qG={createData:t=>t.requestRenderData(),fillBuffers(t,e){const i=t.node;WG.set(t.color),WG.a=255*i._uiProps.opacity,BD(i,0,t.renderData,WG)},appendQuad(t,e,i,n,s,r,o){const a=t.renderData;if(!a)return;const c=a.dataLength;a.dataLength+=4,a.resize(a.dataLength,a.dataLength/2*3);const l=a.data,h=e.width,_=e.height,u=i.width,d=i.height;let m=0,p=0,f=0,g=0;n?(m=i.x/h,g=(i.x+d)/h,p=(i.y+u)/_,f=i.y/_,l[c].u=m,l[c].v=f,l[c+1].u=m,l[c+1].v=p,l[c+2].u=g,l[c+2].v=f,l[c+3].u=g,l[c+3].v=p):(m=i.x/h,g=(i.x+u)/h,p=(i.y+d)/_,f=i.y/_,l[c].u=m,l[c].v=p,l[c+1].u=g,l[c+1].v=p,l[c+2].u=m,l[c+2].v=f,l[c+3].u=g,l[c+3].v=f),l[c].x=s,l[c].y=r-d*o,l[c+1].x=s+u*o,l[c+1].y=r-d*o,l[c+2].x=s,l[c+2].y=r,l[c+3].x=s+u*o,l[c+3].y=r},updateColor(t){}};Ct(qG,jG);let XG=null;const YG=At(jG,{getAssemblerData:()=>(XG||(XG=new FM(1024,1024)),XG.getTexture()),_updateFontFamily(t){zM.fontAtlas=XG,zM.fontFamily=this._getFontFamily(t);const e=t.getComponent(GL);e&&e.enabled?(zM.isOutlined=!0,zM.margin=e.width,zM.out=e.color.clone(),zM.out.a=e.color.a*t.color.a/255):(zM.isOutlined=!1,zM.margin=0)},_getFontFamily(t){let e="Arial";return t.useSystemFont?e=t.fontFamily||"Arial":t.font&&(e=t.font._nativeAsset||"Arial"),e},_updateLabelInfo(t){zM.fontDesc=this._getFontDesc(),zM.color=t.color,zM.hash=function(t){const e=t.color.toHEX();let i="";return t.isOutlined&&t.margin>0&&(i=i+t.margin+t.out.toHEX()),""+t.fontSize+t.fontFamily+e+i}(zM)},_getFontDesc(){let t=`${zM.fontSize.toString()}px `;return t+=zM.fontFamily,t},_computeHorizontalKerningForText(){},_determineRect:()=>!1}),KG=new hi(255,255,255,255),JG={createData:t=>t.requestRenderData(),fillBuffers(t,e){if(!t.renderData)return;const i=t.node;KG.a=255*i._uiProps.opacity,BD(i,0,t.renderData,KG)},updateColor(t){},appendQuad:qG.appendQuad};Ct(JG,YG);const $G=lN.Overflow,ZG=(1/255).toFixed(3);let QG=null,tU=null,eU=null,iU="",nU="",sU=0,rU=0,oU=[];const aU=new Gi;let cU=0,lU=0,hU=0,_U=new hi,uU=1,dU="",mU=$G.NONE,pU=!1,fU=null;const gU=hi.BLACK.clone();let vU=null;const yU=hi.BLACK.clone(),xU=new ki,SU=Gi.ZERO.clone(),CU=Gi.ZERO.clone(),AU=Oi.ZERO.clone(),bU=Oi.ZERO.clone();let TU=0,EU=0,PU=!1,wU=!1,IU=!1;const RU=["left","center","right"],DU={getAssemblerData:()=>lN._canvasPool.get(),resetAssemblerData(t){t&&lN._canvasPool.put(t)},updateRenderData(t){if(t.renderData){if(t.renderData.vertDirty){const e=t.node._uiProps.uiTransformComp;this._updateFontFamily(t),this._updateProperties(t,e),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(t),this._calDynamicAtlas(t),t.actualFontSize=sU,e.setContentSize(aU),this.updateVertexData(t),this.updateUVs(t),t.markForUpdateRenderData(!1),QG=null,tU=null,eU=null}t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame)}},updateVertexData(t){},updateUVs(t){},_updateFontFamily(t){dU=t.useSystemFont?t.fontFamily||"Arial":t.font&&t.font._nativeAsset||"Arial"},_updateProperties(t,e){const i=t.assemblerData;i&&(QG=i.context,tU=i.canvas,eU=t.spriteFrame,nU=t.string.toString(),sU=t.fontSize,rU=sU,mU=t.overflow,CU.width=aU.width=e.width,CU.height=aU.height=e.height,EU=t.underlineHeight,cU=t.lineHeight,lU=t.horizontalAlign,hU=t.verticalAlign,_U=t.color,uU=t.node._uiProps.opacity,PU=t.isBold,wU=t.isItalic,IU=t.isUnderline,pU=mU!==$G.NONE&&(mU===$G.RESIZE_HEIGHT||t.enableWrapText),fU=GL&&t.getComponent(GL),fU=fU&&fU.enabled&&fU.width>0?fU:null,fU&&gU.set(fU.color),vU=xV&&t.getComponent(xV),vU=vU&&vU.enabled?vU:null,vU&&yU.set(vU.color),this._updatePaddingRect())},_updatePaddingRect(){let t=0,e=0,i=0,n=0,s=0;if(SU.width=SU.height=0,fU&&(s=fU.width,t=e=i=n=s,SU.width=SU.height=2*s),vU){const r=vU.blur+s,o=vU.offset.x,a=vU.offset.y;i=Math.max(i,-o+r),n=Math.max(n,o+r),t=Math.max(t,a+r),e=Math.max(e,-a+r)}if(wU){const t=rU*Math.tan(.20943951);n+=t,SU.width+=t}xU.x=i,xU.y=t,xU.width=i+n,xU.height=t+e},_calculateFillTextStartPosition(){let t=0;lU===iN.RIGHT?t=aU.width-xU.width:lU===iN.CENTER&&(t=(aU.width-xU.width)/2);const e=this._getLineHeight()*(oU.length-1);let i=sU*(1-mM/2);if(hU!==nN.TOP){let t=e+xU.height+sU-aU.height;hU===nN.BOTTOM?(t+=mM/2*sU,i-=t):i-=t/2}i+=0*sU,AU.set(t+xU.x,i+xU.y)},_updateTexture(t){if(!QG||!tU)return;QG.clearRect(0,0,tU.width,tU.height),QG.font=iU,this._calculateFillTextStartPosition();const e=this._getLineHeight();QG.lineJoin="round",fU?(QG.fillStyle=`rgba(${gU.r}, ${gU.g}, ${gU.b}, ${ZG})`,QG.fillRect(0,0,tU.width,tU.height)):t._srcBlendFactor===fn.SRC_ALPHA&&(QG.fillStyle=`rgba(${_U.r}, ${_U.g}, ${_U.b}, ${ZG})`,QG.fillRect(0,0,tU.width,tU.height)),QG.fillStyle=`rgb(${_U.r}, ${_U.g}, ${_U.b})`;const i=AU.x;let n=0;this._drawTextEffect(AU,e);for(let t=0;t<oU.length;++t)n=AU.y+t*e,fU&&QG.strokeText(oU[t],i,n),QG.fillText(oU[t],i,n);vU&&(QG.shadowColor="transparent"),this._uploadTexture(t)},_uploadTexture(t){if(t.cacheMode===lN.CacheMode.BITMAP){const e=t.ttfSpriteFrame;VD.deleteAtlasSpriteFrame(e),e._resetDynamicAtlasFrame()}if(eU&&tU){let e;e=eU instanceof jD?eU.texture:eU,0!==tU.width&&0!==tU.height&&(e.reset({width:tU.width,height:tU.height,mipmapLevel:1}),e.uploadData(tU),e.setWrapMode(Lp.CLAMP_TO_EDGE,Lp.CLAMP_TO_EDGE),eU instanceof jD&&(eU.rect=new ki(0,0,tU.width,tU.height),eU._calculateUV()),t.renderData&&(t.renderData.textureDirty=!0),l.director.root&&l.director.root.batcher2D&&l.director.root.batcher2D._releaseDescriptorSetCache(e.getHash()))}},_calDynamicAtlas(t){if(t.cacheMode!==lN.CacheMode.BITMAP||!tU||tU.width<=0||tU.height<=0)return;const e=t.ttfSpriteFrame;VD.packToDynamicAtlas(t,e)},_setupOutline(){QG.strokeStyle=`rgba(${gU.r}, ${gU.g}, ${gU.b}, ${gU.a/255})`,QG.lineWidth=2*fU.width},_setupShadow(){QG.shadowColor=`rgba(${yU.r}, ${yU.g}, ${yU.b}, ${yU.a/255})`,QG.shadowBlur=vU.blur,QG.shadowOffsetX=vU.offset.x,QG.shadowOffsetY=-vU.offset.y},_drawTextEffect(t,e){if(!vU&&!fU&&!IU)return;const i=oU.length>1&&vU,n=this._measureText(QG,iU);let s=0,r=0;vU&&this._setupShadow(),fU&&this._setupOutline();for(let o=0;o<oU.length;++o)s=t.x,r=t.y+o*e,i&&(fU&&QG.strokeText(oU[o],s,r),QG.fillText(oU[o],s,r)),IU&&(TU=n(oU[o]),lU===iN.RIGHT?bU.x=t.x-TU:lU===iN.CENTER?bU.x=t.x-TU/2:bU.x=t.x,bU.y=r+rU/8,QG.fillRect(bU.x,bU.y,TU,EU));i&&(QG.shadowColor="transparent")},_updateLabelDimensions(){aU.width=Math.min(aU.width,2048),aU.height=Math.min(aU.height,2048);let t=!1;tU.width!==aU.width&&(tU.width=aU.width,t=!0),tU.height!==aU.height&&(tU.height=aU.height,t=!0),t&&(QG.font=iU),QG.textAlign=RU[lU],QG.textBaseline="alphabetic"},_getFontDesc(){let t=`${sU.toString()}px `;return t+=dU,PU&&(t=`bold ${t}`),wU&&(t=`italic ${t}`),t},_getLineHeight(){let t=cU;return t=0===t?sU:t*sU/rU,0|t},_calculateParagraphLength(t,e){const i=[];for(const n of t){const t=TM(e,n,iU);i.push(t)}return i},_measureText:(t,e)=>i=>TM(t,i,e),_calculateShrinkFont(t){if(!QG)return;const e=this._calculateParagraphLength(t,QG);let i=0,n=0,s=0;if(pU){const e=CU.width,s=CU.height;if(e<0||s<0)return;n=s+1;let r=[],o=0,a=0|sU+1,c=0;for(;o<a;){if(c=o+a+1>>1,c<=0){P(4003);break}sU=c,iU=this._getFontDesc(),QG.font=iU;const l=this._getLineHeight();for(n=0,i=0;i<t.length;++i){const s=TM(QG,t[i],iU);r=IM(t[i],s,e,this._measureText(QG,iU)),n+=r.length*l}n>s?a=c-1:o=c}0===o?P(4003):(sU=o,iU=this._getFontDesc(),QG.font=iU)}else{for(n=t.length*this._getLineHeight(),i=0;i<t.length;++i)s<e[i]&&(s=e[i]);const r=(aU.width-xU.width)/s,o=aU.height/n;sU=rU*Math.min(1,r,o)|0,iU=this._getFontDesc(),QG.font=iU}},_calculateWrapText(t){if(!pU||!QG)return;oU=[];const e=CU.width;for(let i=0;i<t.length;++i){const n=TM(QG,t[i],iU),s=IM(t[i],n,e,this._measureText(QG,iU));oU=oU.concat(s)}},_calculateLabelFont(){if(!QG)return;const t=nU.split("\n");switch(oU=t,iU=this._getFontDesc(),QG.font=iU,mU){case $G.NONE:{let e=0,i=0;for(let i=0;i<t.length;++i){const n=TM(QG,t[i],iU);e=e>n?e:n}i=(oU.length+mM)*this._getLineHeight();const n=parseFloat(e.toFixed(2)),s=parseFloat(i.toFixed(2));aU.width=n+xU.width,aU.height=s+xU.height,CU.width=n+SU.width,CU.height=s+SU.height;break}case $G.SHRINK:this._calculateShrinkFont(t),this._calculateWrapText(t);break;case $G.CLAMP:this._calculateWrapText(t);break;case $G.RESIZE_HEIGHT:{this._calculateWrapText(t);const e=(oU.length+mM)*this._getLineHeight();aU.height=e+xU.height,CU.height=e+SU.height;break}}}},MU=hi.WHITE.clone(),OU={createData(t){const e=t.requestRenderData();e.dataLength=2,e.resize(4,6);const i=e.chunk.vb;i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;let n=5;for(let t=0;t<4;t++)hi.toArray(i,MU,n),n+=9;return e},fillBuffers(t,e){const i=t.renderData.chunk,n=t.renderData.data,s=t.node,r=i.vb,o=n[0],a=n[1];s.updateWorldTransform();const c=s._pos,l=s._rot,h=s._scale,_=o.x*h.x,u=a.x*h.x,d=o.y*h.y,m=a.y*h.y,p=l.x,f=l.y,g=l.z,v=l.w,y=p*f,x=g*v,S=p*p-f*f,C=v*v-g*g,A=C+S,b=2*(y-x),T=C-S,E=2*(y+x),P=c.x,w=c.y;r[0]=A*_+b*d+P,r[1]=T*d+E*_+w,r[9]=A*u+b*d+P,r[10]=T*d+E*u+w,r[18]=A*_+b*m+P,r[19]=T*m+E*_+w,r[27]=A*u+b*m+P,r[28]=T*m+E*u+w;const I=i.bufferId,R=i.vertexOffset,D=i.vertexAccessor.getMeshBuffer(i.bufferId),M=i.vertexAccessor.getIndexBuffer(I);let O=D.indexOffset;M[O++]=R,M[O++]=R+1,M[O++]=R+2,M[O++]=R+2,M[O++]=R+1,M[O++]=R+3,D.indexOffset+=6},updateVertexData(t){const e=t.renderData;if(!e)return;const i=t.node._uiProps.uiTransformComp,n=i.width,s=i.height,r=i.anchorX*n,o=i.anchorY*s,a=e.data;a[0].x=-r,a[0].y=-o,a[1].x=n-r,a[1].y=s-o},updateUVs(t){const e=t.renderData;if(!e||!t.ttfSpriteFrame)return;const i=e.chunk.vb,n=t.ttfSpriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7]},updateColor(t){}};Ct(OU,DU);const BU=t("labelAssembler",{getAssembler(t){let e=OU;return t.font instanceof _M?e=qG:t.cacheMode===lN.CacheMode.CHAR&&(e=JG),e}});lN.Assembler=BU;const NU=FF.FillType,LU=new Ii,FU=new mi,zU={updateRenderData(t){const e=t.spriteFrame;VD.packToDynamicAtlas(t,e);const i=t.renderData;if(i&&e){if(i.updateRenderData(t,e),!i.vertDirty)return;let n=t.fillStart,s=t.fillRange;s<0&&(n+=s,s=-s),s=n+s,n=n>1?1:n,n=n<0?0:n,s=s>1?1:s,s=s<0?0:s,s-=n,s=s<0?0:s;let r=n+s;r=r>1?1:r,this.updateUVs(t,n,r),this.updateVertexData(t,n,r)}},updateUVs(t,e,i){const n=t.spriteFrame,s=t.renderData.chunk.vb,r=n.width,o=n.height,a=n.rect;let c=0,l=0,h=0,_=0,u=0,d=0,m=0,p=0,f=0,g=0,v=0,y=0;switch(n.isRotated()?(c=a.x/r,l=(a.y+a.width)/o,h=(a.x+a.height)/r,_=a.y/o,u=m=c,f=v=h,p=y=l,d=g=_):(c=a.x/r,l=(a.y+a.height)/o,h=(a.x+a.width)/r,_=a.y/o,u=f=c,m=v=h,d=p=l,g=y=_),t.fillType){case NU.HORIZONTAL:s[3]=u+(m-u)*e,s[4]=d+(p-d)*e,s[12]=u+(m-u)*i,s[13]=d+(p-d)*i,s[21]=f+(v-f)*e,s[22]=g+(y-g)*e,s[30]=f+(v-f)*i,s[31]=g+(y-g)*i;break;case NU.VERTICAL:s[3]=u+(f-u)*e,s[4]=d+(g-d)*e,s[12]=m+(v-m)*e,s[13]=p+(y-p)*e,s[21]=u+(f-u)*i,s[22]=d+(g-d)*i,s[30]=m+(v-m)*i,s[31]=p+(y-p)*i;break;default:D(2626)}},updateVertexData(t,e,i){const n=t.renderData.data,s=t.node._uiProps.uiTransformComp,r=s.width,o=s.height,a=s.anchorX*r,c=s.anchorY*o;let l=-a,h=-c,_=r-a,u=o-c,d=0,m=0;switch(t.fillType){case NU.HORIZONTAL:d=l+(_-l)*e,m=l+(_-l)*i,l=d,_=m;break;case NU.VERTICAL:d=h+(u-h)*e,m=h+(u-h)*i,h=d,u=m;break;default:D(2626)}n[0].x=l,n[0].y=h,n[1].x=_,n[1].y=h,n[2].x=l,n[2].y=u,n[3].x=_,n[3].y=u},createData(t){const e=t.requestRenderData();e.dataLength=4,e.resize(4,6);const i=e.data;for(const t of i)t.z=0;return e},updateWorldVertexData(t,e){t.node.getWorldMatrix(LU);const i=t.renderData.floatStride,n=t.renderData.data,s=e.vb;let r=0;for(let t=0;t<4;t++){const e=n[t];mi.transformMat4(FU,e,LU),r=t*i,s[r]=FU.x,s[r+1]=FU.y,s[r+2]=FU.z}},fillBuffers(t,e){const i=t.renderData,n=i.chunk;(t.node.hasChangedFlags||i.vertDirty)&&(this.updateWorldVertexData(t,n),i.vertDirty=!1);const s=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(s);let c=o.indexOffset;a[c++]=r,a[c++]=r+1,a[c++]=r+2,a[c++]=r+2,a[c++]=r+1,a[c++]=r+3,o.indexOffset+=6},updateColor(t){const e=t.renderData,i=e.chunk.vb,n=e.floatStride;let s=5;const r=t.color,o=r.r/255,a=r.g/255,c=r.b/255,l=t.node._uiProps.opacity;for(let t=0;t<4;t++)i[s]=o,i[s+1]=a,i[s+2]=c,i[s+3]=l,s+=n}},VU=2*Math.PI,GU=1e-6,UU=new Ii,kU=new mi,HU=[new Oi,new Oi,new Oi,new Oi],jU=new Array(4),WU=new Array(8),qU=[new Oi,new Oi,new Oi,new Oi],XU=[new Oi,new Oi,new Oi,new Oi],YU=new Oi,KU=[new Oi,new Oi,new Oi,new Oi];function JU(t,e,i,n,s,r,o){let a=Math.sin(r);a=Math.abs(a)>GU?a:0;let c=Math.cos(r);c=Math.abs(c)>GU?c:0;let l=0,h=0;if(0!==c){if(l=a/c,(t-s.x)*c>0){const e=s.y+l*(t-s.x);o[0].x=t,o[0].y=e}if((e-s.x)*c>0){const t=s.y+l*(e-s.x);o[2].x=e,o[2].y=t}}if(0!==a){if(h=c/a,(n-s.y)*a>0){const t=s.x+h*(n-s.y);o[3].x=t,o[3].y=n}if((i-s.y)*a>0){const t=s.x+h*(i-s.y);o[1].x=t,o[1].y=i}}}function $U(t,e){const i=e.x-t.x,n=e.y-t.y;if(0===i&&0===n)return 0;if(0===i)return n>0?.5*Math.PI:1.5*Math.PI;{let t=Math.atan(n/i);return i<0&&(t+=Math.PI),t}}function ZU(t,e,i,n,s){const r=jU,o=r[0],a=r[1],c=r[2],l=r[3];t[e].x=i.x,t[e].y=i.y,t[e+1].x=n.x,t[e+1].y=n.y,t[e+2].x=s.x,t[e+2].y=s.y;let h=0,_=0;h=(i.x-o)/(c-o),_=(i.y-a)/(l-a),QU(h,_,t,e),h=(n.x-o)/(c-o),_=(n.y-a)/(l-a),QU(h,_,t,e+1),h=(s.x-o)/(c-o),_=(s.y-a)/(l-a),QU(h,_,t,e+2)}function QU(t,e,i,n){const s=WU,r=s[0]+(s[2]-s[0])*t,o=s[4]+(s[6]-s[4])*t,a=s[1]+(s[3]-s[1])*t,c=s[5]+(s[7]-s[5])*t,l=i[n];l.u=r+(o-r)*e,l.v=a+(c-a)*e}const tk={useModel:!1,createData:t=>t.requestRenderData(),updateRenderData(t){const e=t.spriteFrame;VD.packToDynamicAtlas(t,e),this.updateUVs(t);const i=t.renderData;if(i&&e){if(!i.vertDirty)return;const n=i.data;let s=t.fillStart,r=t.fillRange;for(r<0&&(s+=r,r=-r);s>=1;)s-=1;for(;s<0;)s+=1;s*=VU,r*=VU;const o=s+r;!function(t){const e=t.node._uiProps.uiTransformComp,i=e.width,n=e.height,s=e.anchorX*i,r=e.anchorY*n,o=-s,a=-r,c=i-s,l=n-r,h=jU;h[0]=o,h[1]=a,h[2]=c,h[3]=l;const _=t.fillCenter,u=YU.x=Math.min(Math.max(0,_.x),1)*(c-o)+o,d=YU.y=Math.min(Math.max(0,_.y),1)*(l-a)+a;HU[0].x=HU[3].x=o,HU[1].x=HU[2].x=c,HU[0].y=HU[1].y=a,HU[2].y=HU[3].y=l;for(const t of KU)Oi.set(t,0,0);u!==h[0]&&Oi.set(KU[0],3,0),u!==h[2]&&Oi.set(KU[2],1,2),d!==h[1]&&Oi.set(KU[1],0,1),d!==h[3]&&Oi.set(KU[3],2,3)}(t),function(t){const e=t.width,i=t.height,n=t.getRect();let s=0,r=0,o=0,a=0;const c=WU;t.isRotated()?(s=n.x/e,r=(n.x+n.height)/e,o=n.y/i,a=(n.y+n.width)/i,c[0]=c[2]=s,c[4]=c[6]=r,c[3]=c[7]=a,c[1]=c[5]=o):(s=n.x/e,r=(n.x+n.width)/e,o=n.y/i,a=(n.y+n.height)/i,c[0]=c[4]=s,c[2]=c[6]=r,c[1]=c[3]=a,c[5]=c[7]=o)}(e),JU(jU[0],jU[2],jU[1],jU[3],YU,s,qU),JU(jU[0],jU[2],jU[1],jU[3],YU,s+r,XU);let a=0;for(let t=0;t<4;++t){const e=KU[t];if(!e)continue;if(r>=VU){i.dataLength=a+3,ZU(n,a,YU,HU[e.x],HU[e.y]),a+=3;continue}let c=$U(YU,HU[e.x]),l=$U(YU,HU[e.y]);l<c&&(l+=VU),c-=VU,l-=VU;for(let r=0;r<3;++r)c>=o||(c>=s?(i.dataLength=a+3,ZU(n,a,YU,HU[e.x],l>=o?XU[t]:HU[e.y]),a+=3):l>s&&(l<=o?(i.dataLength=a+3,ZU(n,a,YU,qU[t],HU[e.y]),a+=3):(i.dataLength=a+3,ZU(n,a,YU,qU[t],XU[t]),a+=3))),c+=VU,l+=VU}i.resize(a,a),i.updateRenderData(t,e)}},fillBuffers(t,e){const i=t.node,n=t.renderData,s=n.chunk;(i.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(t,s),n.vertDirty=!1),this.updataColorLate(t);const r=s.bufferId,o=s.vertexOffset,a=s.vertexAccessor.getMeshBuffer(s.bufferId),c=s.vertexAccessor.getIndexBuffer(r),l=a.indexOffset;for(let t=0;t<n.indexCount;t++)c[l+t]=o+t;a.indexOffset+=n.indexCount,a.setDirty()},updateWorldVertexAndUVData(t,e){t.node.getWorldMatrix(UU);const i=t.renderData,n=i.floatStride,s=t.renderData.data,r=e.vb,o=i.vertexCount;let a=0;for(let t=0;t<o;t++){const e=s[t];mi.set(kU,e.x,e.y,0),mi.transformMat4(kU,kU,UU),r[a+0]=kU.x,r[a+1]=kU.y,r[a+2]=kU.z,r[a+3]=e.u,r[a+4]=e.v,a+=n}},updateUVs(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},updataColorLate(t){const e=t.renderData,i=e.chunk.vb,n=e.floatStride,s=e.vertexCount;let r=5;const o=t.color,a=o.r/255,c=o.g/255,l=o.b/255,h=t.node._uiProps.opacity;for(let t=0;t<s;t++)i[r]=a,i[r+1]=c,i[r+2]=l,i[r+3]=h,r+=n},updateColor(t){}},ek=[];for(let t=0;t<4;t++)ek.push(new mi);const ik={createData(t){const e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData(t){const e=t.spriteFrame;VD.packToDynamicAtlas(t,e),this.updateUVs(t);const i=t.renderData;i&&e&&(i.vertDirty&&this.updateVertexData(t),i.updateRenderData(t,e))},updateWorldVerts(t,e){const i=t.renderData,n=e.vb,s=i.data,r=t.node,o=s[0],a=s[1],c=r.worldMatrix,l=c.m00,h=c.m01,_=c.m04,u=c.m05,d=1===l&&0===h&&0===_&&1===u,m=c.m12,p=c.m13,f=o.x,g=a.x,v=o.y,y=a.y;if(d){const t=f+m,e=g+m,i=v+p,s=y+p;n[0]=t,n[1]=i,n[9]=e,n[10]=i,n[18]=t,n[19]=s,n[27]=e,n[28]=s}else{const t=l*f,e=l*g,i=h*f,s=h*g,r=_*v+m,o=_*y+m,a=u*v+p,c=u*y+p;n[0]=t+r,n[1]=i+a,n[9]=e+r,n[10]=s+a,n[18]=t+o,n[19]=i+c,n[27]=e+o,n[28]=s+c}},fillBuffers(t,e){if(null===t)return;const i=t.renderData,n=i.chunk;(t.node.hasChangedFlags||i.vertDirty)&&(this.updateWorldVerts(t,n),i.vertDirty=!1);const s=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(s),a=n.vertexAccessor.getIndexBuffer(s);let c=o.indexOffset;a[c++]=r,a[c++]=r+1,a[c++]=r+2,a[c++]=r+2,a[c++]=r+1,a[c++]=r+3,o.indexOffset+=6},updateVertexData(t){const e=t.renderData;if(!e)return;const i=t.node._uiProps.uiTransformComp,n=e.data,s=i.width,r=i.height,o=i.anchorX*s,a=i.anchorY*r;let c=0,l=0,h=0,_=0;if(t.trim)c=-o,l=-a,h=s-o,_=r-a;else{const e=t.spriteFrame,i=e.getOriginalSize(),n=e.getRect(),u=i.width,d=i.height,m=n.width,p=n.height,f=e.getOffset(),g=s/u,v=r/d,y=f.x+(u-m)/2,x=f.x-(u-m)/2;c=y*g-o,l=(f.y+(d-p)/2)*v-a,h=s+x*g-o,_=r+(f.y-(d-p)/2)*v-a}n[0].x=c,n[0].y=l,n[1].x=h,n[1].y=_,e.vertDirty=!0},updateUVs(t){if(!t.spriteFrame)return;const e=t.renderData.chunk.vb,i=t.spriteFrame.uv;e[3]=i[0],e[4]=i[1],e[12]=i[2],e[13]=i[3],e[21]=i[4],e[22]=i[5],e[30]=i[6],e[31]=i[7]},updateColor(t){const e=t.renderData,i=e.chunk.vb;let n=5;const s=t.color,r=s.r/255,o=s.g/255,a=s.b/255,c=s.a/255;for(let t=0;t<4;t++,n+=e.floatStride)i[n]=r,i[n+1]=o,i[n+2]=a,i[n+3]=c}},nk=new mi,sk=new Ii,rk={createData(t){const e=t.requestRenderData();return e.dataLength=4,e.resize(16,54),e},updateRenderData(t){const e=t.spriteFrame;VD.packToDynamicAtlas(t,e),this.updateUVs(t);const i=t.renderData;i&&e&&(i.vertDirty&&this.updateVertexData(t),i.updateRenderData(t,e))},updateVertexData(t){const e=t.renderData.data,i=t.node._uiProps.uiTransformComp,n=i.width,s=i.height,r=i.anchorX*n,o=i.anchorY*s,a=t.spriteFrame,c=a.insetLeft,l=a.insetRight,h=a.insetTop,_=a.insetBottom;let u=n-c-l,d=s-h-_,m=n/(c+l),p=s/(h+_);m=Number.isNaN(m)||m>1?1:m,p=Number.isNaN(p)||p>1?1:p,u=u<0?0:u,d=d<0?0:d,e[0].x=-r,e[0].y=-o,e[1].x=c*m-r,e[1].y=_*p-o,e[2].x=e[1].x+u,e[2].y=e[1].y+d,e[3].x=n-r,e[3].y=s-o},fillBuffers(t,e){const i=t.renderData,n=i.chunk;(t.node.hasChangedFlags||i.vertDirty)&&(this.updateWorldVertexData(t,n),i.vertDirty=!1);const s=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(s);let c=o.indexOffset;for(let t=0;t<3;++t)for(let e=0;e<3;++e){const i=r+4*t+e;a[c++]=i,a[c++]=i+1,a[c++]=i+4,a[c++]=i+1,a[c++]=i+5,a[c++]=i+4}o.indexOffset=c},updateWorldVertexData(t,e){t.node.getWorldMatrix(sk);const i=t.renderData,n=i.floatStride,s=i.data,r=e.vb;let o=0;for(let t=0;t<4;++t){const e=s[t];for(let i=0;i<4;++i){const a=s[i];mi.set(nk,a.x,e.y,0),mi.transformMat4(nk,nk,sk),o=(4*t+i)*n,r[o++]=nk.x,r[o++]=nk.y,r[o++]=nk.z}}},updateUVs(t){if(!t.spriteFrame)return;const e=t.renderData,i=e.chunk.vb,n=e.floatStride,s=t.spriteFrame.uvSliced;let r=3;for(let t=0;t<16;t++)i[r]=s[t].u,i[r+1]=s[t].v,r+=n},updateColor(t){const e=t.renderData,i=e.chunk.vb,n=e.floatStride;let s=5;const r=t.color,o=r.r/255,a=r.g/255,c=r.b/255,l=t.node._uiProps.opacity;for(let t=0;t<16;t++)i[s]=o,i[s+1]=a,i[s+2]=c,i[s+3]=l,s+=n}},ok=[];for(let t=0;t<4;t++)ok.push(new mi);const ak=new Ii,ck={createData:t=>t.requestRenderData(),updateRenderData(t){const e=t.renderData,i=t.spriteFrame;if(!i||!e)return;if(e.updateRenderData(t,i),!e.vertDirty)return;const n=t.node._uiProps.uiTransformComp,s=Math.abs(n.width),r=Math.abs(n.height),o=i.getRect(),a=i.insetLeft,c=i.insetRight,l=o.width-a-c,h=i.insetTop,_=i.insetBottom,u=o.height-h-_;let d=s-a-c,m=r-h-_;d=d>0?d:0,m=m>0?m:0;const p=0===l?d:d/l,f=0===u?m:m/u,g=Math.ceil(f+2),v=Math.ceil(p+2);e.dataLength=Math.max(8,g+1,v+1),this.updateVerts(t,d,m,g,v),e.resize(g*v*4,g*v*6)},updateUVs(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},fillBuffers(t,e){const i=t.node,n=t.renderData,s=n.chunk;(i.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(t,s),n.vertDirty=!1),this.updataColorLate(t);const r=s.bufferId;let o=s.vertexOffset;const a=s.vertexAccessor.getMeshBuffer(s.bufferId),c=s.vertexAccessor.getIndexBuffer(r);let l=a.indexOffset;for(let t=0;t<n.indexCount;t+=6)c[l++]=o,c[l++]=o+1,c[l++]=o+2,c[l++]=o+1,c[l++]=o+3,c[l++]=o+2,o+=4,a.indexOffset+=6;a.setDirty()},updateWorldVertexAndUVData(t,e){const i=t.node;i.getWorldMatrix(ak);const n=t.renderData,s=n.floatStride,r=n.data,o=e.vb,a=i._uiProps.uiTransformComp,c=Math.abs(a.width),l=Math.abs(a.height),h=t.spriteFrame,_=h.rotated,u=h.uv,d=h.uvSliced,m=h.rect,p=h.insetLeft,f=h.insetRight,g=m.width-p-f,v=h.insetTop,y=h.insetBottom,x=m.height-v-y;let S=c-p-f,C=l-v-y;S=S>0?S:0,C=C>0?C:0;const A=0===g?S:S/g,b=0===x?C:C/x,T=Math.ceil(b+2),E=Math.ceil(A+2);let P=0,w=0,I=0,R=0,D=0;for(let t=0,e=T;t<e;++t){R=r[t].y,D=r[t+1].y;for(let t=0,e=E;t<e;++t){w=r[t].x,I=r[t+1].x,mi.set(ok[0],w,R,0),mi.set(ok[1],I,R,0),mi.set(ok[2],w,D,0),mi.set(ok[3],I,D,0);for(let t=0;t<4;t++){const e=ok[t];mi.transformMat4(e,e,ak);const i=t*s;o[P+i]=e.x,o[P+i+1]=e.y,o[P+i+2]=e.z}P+=4*s}}P=0;const M=s,O=2*s,B=3*s,N=4*s;let L=0,F=0;const z=[],V=[];for(let t=0,e=T;t<e;++t){F=C>x?C>=t*x?1:b%1:b;for(let e=0,i=E;e<i;++e){L=S>g?S>=e*g?1:A%1:A;const i=P+3,n=i+1;_?(0===t?(z[0]=d[0].u,z[1]=d[0].u,z[2]=d[4].u+(d[8].u-d[4].u)*F):t<T-1?(z[0]=d[4].u,z[1]=d[4].u,z[2]=d[4].u+(d[8].u-d[4].u)*F):t===T-1&&(z[0]=d[8].u,z[1]=d[8].u,z[2]=d[12].u),0===e?(V[0]=d[0].v,V[1]=d[1].v+(d[2].v-d[1].v)*L,V[2]=d[0].v):e<E-1?(V[0]=d[1].v,V[1]=d[1].v+(d[2].v-d[1].v)*L,V[2]=d[1].v):e===E-1&&(V[0]=d[2].v,V[1]=d[3].v,V[2]=d[2].v),z[3]=z[2],V[3]=V[1]):(0===e?(z[0]=d[0].u,z[1]=d[1].u+(d[2].u-d[1].u)*L,z[2]=u[0]):e<E-1?(z[0]=d[1].u,z[1]=d[1].u+(d[2].u-d[1].u)*L,z[2]=d[1].u):e===E-1&&(z[0]=d[2].u,z[1]=d[3].u,z[2]=d[2].u),0===t?(V[0]=d[0].v,V[1]=d[0].v,V[2]=d[4].v+(d[8].v-d[4].v)*F):t<T-1?(V[0]=d[4].v,V[1]=d[4].v,V[2]=d[4].v+(d[8].v-d[4].v)*F):t===T-1&&(V[0]=d[8].v,V[1]=d[8].v,V[2]=d[12].v),z[3]=z[1],V[3]=V[2]),o[i]=z[0],o[n]=V[0],o[i+M]=z[1],o[n+M]=V[1],o[i+O]=z[2],o[n+O]=V[2],o[i+B]=z[3],o[n+B]=V[3],P+=N}}},updateVerts(t,e,i,n,s){const r=t.node._uiProps.uiTransformComp,o=t.renderData.data,a=t.spriteFrame,c=a.rect,l=Math.abs(r.width),h=Math.abs(r.height),_=r.anchorX*l,u=r.anchorY*h,d=a.insetLeft,m=a.insetRight,p=c.width-d-m,f=a.insetTop,g=a.insetBottom,v=c.height-f-g,y=r.width/(d+m)>1?1:r.width/(d+m),x=r.height/(f+g)>1?1:r.height/(f+g);let S=0,C=0;S=p>0?Math.floor(1e3*e)/1e3%p==0?p:e%p:e,C=v>0?Math.floor(1e3*i)/1e3%v==0?v:i%v:i;for(let t=0;t<=s;t++)0===t?o[t].x=-_:t>0&&t<s?o[t].x=1===t?d*y+Math.min(p,e)-_:p>0?t===s-1?d+S+p*(t-2)-_:d+Math.min(p,e)+p*(t-2)-_:d+e-_:t===s&&(o[t].x=Math.min(d+e+m,l)-_);for(let t=0;t<=n;t++)0===t?o[t].y=-u:t>0&&t<n?o[t].y=1===t?g*x+Math.min(v,i)-u:v>0?t===n-1?g+C+(t-2)*v-u:g+Math.min(v,i)+(t-2)*v-u:g+i-u:t===n&&(o[t].y=Math.min(g+i+f,h)-u)},updataColorLate(t){const e=t.renderData,i=e.chunk.vb,n=e.floatStride,s=e.vertexCount;let r=5;const o=t.color,a=o.r/255,c=o.g/255,l=o.b/255,h=t.node._uiProps.opacity;for(let t=0;t<s;t++)i[r]=a,i[r+1]=c,i[r+2]=l,i[r+3]=h,r+=n},updateColor(t){}},lk=FF.Type,hk=FF.FillType,_k=t("spriteAssembler",{getAssembler(t){let e=ik;const i=t;switch(i.type){case lk.SLICED:e=rk;break;case lk.TILED:e=ck;break;case lk.FILLED:e=i.fillType===hk.RADIAL?tk:zU}return e}});FF.Assembler=_k;const uk=CO.sharedManager,dk={createData(t){const e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData(t){t.type===bL.IMAGE_STENCIL&&(ik.updateRenderData(t),ik.updateColor(t))},fillBuffers(t,e){(t.type!==bL.IMAGE_STENCIL||t.spriteFrame)&&(uk.pushMask(t),e.finishMergeBatches(),function(t,e){uk.clear(t),e.commitModel(t,t._clearModel,t._clearStencilMtl)}(t,e),function(t,e){if(uk.enterLevel(t),t.type===bL.IMAGE_STENCIL){ik.fillBuffers(t,e);const i=t.graphics.getMaterialInstance(0);e.forceMergeBatches(i,t.spriteFrame,t.graphics)}else t.graphics.updateAssembler(e)}(t,e),uk.enableMask())}},mk={fillBuffers(t,e){uk.exitMask()}},pk={getAssembler:()=>dk},fk={getAssembler:()=>mk};TL.Assembler=pk,TL.PostAssembler=fk;class gk{constructor(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}get attributes(){return this._attributes}get vertexFormatBytes(){return this._vertexFormatBytes}initialize(t,e,i,n){this._initVDataCount=i,this._initIDataCount=n,this._attributes=e,this._floatsPerVertex=HM(e),this._initVDataCount,this._floatsPerVertex,N(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(t))}reset(){this._nextFreeIAHandle=0,this._dirty=!1}destroy(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(let t=0;t<this._iaPool.length;++t){const e=this._iaPool[t];e.vertexBuffers[0]&&e.vertexBuffers[0].destroy(),e.indexBuffer&&e.indexBuffer.destroy(),e.ia.destroy()}this._iaPool.length=0}setDirty(){this._dirty=!0}request(t,e){return I(9002),!1}requireFreeIA(t){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(t)),this._iaPool[this._nextFreeIAHandle++].ia}recycleIA(t){const e=this._iaPool;for(let i=0;i<this._nextFreeIAHandle;++i)if(t===e[i].ia){const t=e[i];return e[i]=e[--this._nextFreeIAHandle],void(e[this._nextFreeIAHandle]=t)}}checkCapacity(t,e){const i=(this.vertexOffset+t)*this._floatsPerVertex,n=this.indexOffset+e;return!(i>this._initVDataCount||n>this._initIDataCount)}uploadBuffers(){if(0===this.byteOffset||!this._dirty)return;const t=qh.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,e=this.byteOffset,i=this.indexOffset;for(let n=0;n<t;++n){const t=this._iaPool[n],s=new Float32Array(this.vData.buffer,0,e>>2),r=new Uint16Array(this.iData.buffer,0,i),o=t.vertexBuffers[0];e>o.size&&o.resize(e),o.update(s),2*i>t.indexBuffer.size&&t.indexBuffer.resize(2*i),t.indexBuffer.update(r)}this._dirty=!1}createNewIA(t){let e,i,n;if(qh.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){const s=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,r=Uint16Array.BYTES_PER_ELEMENT,o=t.createBuffer(new Zn(en.VERTEX|en.TRANSFER_DST,rn.HOST|rn.DEVICE,s,s));n=t.createBuffer(new Zn(en.INDEX|en.TRANSFER_DST,rn.HOST|rn.DEVICE,r,r)),i=[o],this._iaInfo=new vs(this._attributes,i,n),e=t.createInputAssembler(this._iaInfo)}else e=t.createInputAssembler(this._iaInfo),i=this._iaInfo.vertexBuffers,n=this._iaInfo.indexBuffer;return{ia:e,vertexBuffers:i,indexBuffer:n}}}t("MeshBuffer",gk);const vk=[NE.EventType.MOUSE_DOWN,NE.EventType.MOUSE_MOVE,NE.EventType.MOUSE_UP,NE.EventType.MOUSE_WHEEL],yk=[NE.EventType.TOUCH_START,NE.EventType.TOUCH_MOVE,NE.EventType.TOUCH_END,NE.EventType.TOUCH_CANCEL];new class{constructor(){this.priority=ME.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],LE._registerEventDispatcher(this),SA.callbacksInvoker.on(xA.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),SA.callbacksInvoker.on(xA.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),SA.callbacksInvoker.on(xA.MARK_LIST_DIRTY,this._markListDirty,this)}dispatchEvent(t){const e=t.type;return yk.includes(e)?this.dispatchEventTouch(t):!vk.includes(e)||this.dispatchEventMouse(t)}addPointerEventProcessor(t){0===this._inDispatchCount?this._pointerEventProcessorList.includes(t)||(this._pointerEventProcessorList.push(t),this._isListDirty=!0):this._processorListToAdd.includes(t)||this._processorListToAdd.push(t),Ut.array.remove(this._processorListToRemove,t)}removePointerEventProcessor(t){0===this._inDispatchCount?(Ut.array.remove(this._pointerEventProcessorList,t),this._isListDirty=!0):this._processorListToRemove.includes(t)||this._processorListToRemove.push(t),Ut.array.remove(this._processorListToAdd,t)}dispatchEventMouse(t){this._inDispatchCount++,this._sortPointerEventProcessorList();const e=this._pointerEventProcessorList,i=e.length;let n=!0;for(let s=0;s<i;++s){const i=e[s];if(i.isEnabled&&i.shouldHandleEventMouse&&i._handleEventMouse(t)){if(n=!1,!t.preventSwallow)break;t.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),n}dispatchEventTouch(t){this._inDispatchCount++,this._sortPointerEventProcessorList();const e=this._pointerEventProcessorList,i=e.length,n=t.touch;let s=!0;for(let r=0;r<i;++r){const i=e[r];if(i.isEnabled&&i.shouldHandleEventTouch)if(t.type===mA.TOUCH_START){if(i._handleEventTouch(t)){if(i.claimedTouchIdList.push(n.getID()),s=!1,!t.preventSwallow)break;t.preventSwallow=!1}}else if(i.claimedTouchIdList.length>0){const e=i.claimedTouchIdList.indexOf(n.getID());if(-1!==e){if(i._handleEventTouch(t),t.type!==mA.TOUCH_END&&t.type!==mA.TOUCH_CANCEL||Ut.array.removeAt(i.claimedTouchIdList,e),s=!1,!t.preventSwallow)break;t.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),s}_updatePointerEventProcessorList(){const t=this._processorListToAdd,e=t.length;for(let i=0;i<e;++i)this.addPointerEventProcessor(t[i]);t.length=0;const i=this._processorListToRemove,n=i.length;for(let t=0;t<n;++t)this.removePointerEventProcessor(i[t]);i.length=0}_sortPointerEventProcessorList(){if(!this._isListDirty)return;const t=this._pointerEventProcessorList,e=t.length;for(let i=0;i<e;++i){const e=t[i],n=e.node;if(n._uiProps){const t=n._uiProps.uiTransformComp;e.cachedCameraPriority=t.cameraPriority}}t.sort(this._sortByPriority),this._isListDirty=!1}_sortByPriority(t,e){const i=t.node,n=e.node;if(!(e&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return-1;if(!(t&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return 1;if(t.cachedCameraPriority!==e.cachedCameraPriority)return e.cachedCameraPriority-t.cachedCameraPriority;let s=i,r=n,o=!1;for(;(null===(a=s.parent)||void 0===a?void 0:a._id)!==(null===(c=r.parent)||void 0===c?void 0:c._id);){var a,c,l,h,_,u;s=null===(null===(l=s)||void 0===l||null===(h=l.parent)||void 0===h?void 0:h.parent)?(o=!0)&&n:s&&s.parent,r=null===(null===(_=r)||void 0===_||null===(u=_.parent)||void 0===u?void 0:u.parent)?(o=!0)&&i:r&&r.parent}if(s._id===r._id){if(s._id===n._id)return-1;if(s._id===i._id)return 1}const d=s?s.getSiblingIndex():0,m=r?r.getSiblingIndex():0;return o?d-m:m-d}_markListDirty(){this._isListDirty=!0}};const xk=new Ml((()=>({offset:0,length:0})),32);class Sk{constructor(t,e,i,n,s){this.vertexAccessor=t,this.bufferId=e,this.vertexOffset=i,this.vb=n}}class Ck extends class{get attributes(){return this._attributes}get vertexFormatBytes(){return this._vertexFormatBytes}get floatsPerVertex(){return this._floatsPerVertex}constructor(t,e){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=t,this._attributes=e,this._floatsPerVertex=HM(e),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}initialize(){}reset(){}request(t=4,e=6){}appendBuffers(t,e){}uploadBuffers(){}destroy(){this._attributes.length=0}}{constructor(t,e,i,n){super(t,e),this._freeLists=[],this._vCount=0,this._iCount=0,this._vCount=i||Math.floor(1024*Kt.BATCHER2D_MEM_INCREMENT/this._vertexFormatBytes),this._iCount=n||this._vCount*Ck.IB_SCALE,this._allocateBuffer()}destroy(){for(let t=0;t<this._buffers.length;++t){this._buffers[t].destroy();const e=this._freeLists[t];for(let t=0;t<e.length;++t)xk.free(e[t])}this._buffers.length=0,this._freeLists.length=0,super.destroy()}reset(){for(let t=0;t<this._buffers.length;++t){const e=this._buffers[t];e.indexOffset=0,e.reset()}}getVertexBuffer(t){return this._buffers[t].vData}getIndexBuffer(t){return this._buffers[t].iData}getMeshBuffer(t){return this._buffers[t]}uploadBuffers(){for(let t=0;t<this._buffers.length;++t){const e=this._freeLists[t][0],i=this._buffers[t];(!e||e.length<i.vData.byteLength)&&i.uploadBuffers()}}appendIndices(t,e){const i=this._buffers[t];e.length&&(i.iData.set(e,i.indexOffset),i.indexOffset+=e.length)}allocateChunk(t,e){const i=t*this.vertexFormatBytes;let n,s=null,r=0,o=-1,a=null;for(let t=0;t<this._buffers.length;++t){s=this._buffers[t],n=this._freeLists[t];for(let e=0;e<n.length;++e)if(n[e].length>=i){a=n[e],r=t,o=e;break}if(a)break}if(a||(r=this._allocateBuffer(),s=this._buffers[r],s&&s.checkCapacity(t,e)&&(o=0,a=this._freeLists[r][o])),a){const t=a.offset/this.vertexFormatBytes,n=new Float32Array(s.vData.buffer,a.offset,i>>2).fill(0);return this._allocateChunkFromEntry(r,o,a,i),new Sk(this,r,t,n,e)}return D(9004,i),null}recycleChunk(t){const e=this._freeLists[t.bufferId],i=this._buffers[t.bufferId];let n=t.vertexOffset*this.vertexFormatBytes,s=t.vb.byteLength;if(0===s)return;let r=!1,o=0,a=null,c=e[o];for(;c&&c.offset<n;)a=c,c=e[++o];if(a&&0==n-(a.offset+a.length)&&(a.length+=s,n=a.offset,s=a.length,c&&c.offset-(n+s)==0&&(a.length+=c.length,e.splice(o,1),xk.free(c),c=null),r=!0),!r&&c){if(0==c.offset-(n+s))c.offset=n,c.length+=s;else{const t=xk.alloc();t.offset=n,t.length=s,e.splice(o,0,t)}r=!0}if(r)n+s===i.byteOffset&&(i.byteOffset=n);else{const t=xk.alloc();t.offset=n,t.length=s,e.push(t)}}_allocateChunkFromEntry(t,e,i,n){const s=i.length-n,r=i.offset+n,o=this._buffers[t];o.byteOffset<r&&(o.byteOffset=r),O(s>=0,9004,t,i.offset,i.length),0===s?(this._freeLists[t].splice(e,1),xk.free(i)):(i.offset+=n,i.length=s)}_allocateBuffer(){O(this._buffers.length===this._freeLists.length,9003);const t=new gk,e=this._vCount*this._floatsPerVertex;t.initialize(this._device,this._attributes,e,this._iCount),this._buffers.push(t);const i=xk.alloc();i.offset=0,i.length=t.vData.byteLength;const n=[i];return this._freeLists.push(n),this._buffers.length-1}}Ck.IB_SCALE=4;const Ak=new Is(null),bk=new Ii;class Tk{get currBufferAccessor(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}get batches(){return this._batches}set currStaticRoot(t){this._currStaticRoot=t}set currIsStatic(t){this._currIsStatic=t}constructor(t){this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new sg,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new Pk,this._meshDataArray=[],this._root=t,this.device=t.device,this._batches=new Bl(64),this._drawBatchPool=new Ml((()=>new Zz),128,(t=>t.destroy(this)))}initialize(){return!0}destroy(){for(let t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((t=>{t.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),CO.sharedManager.destroy()}addScreen(t){this._screens.push(t),this._screens.sort(this._screenSort)}removeScreen(t){const e=this._screens.indexOf(t);-1!==e&&this._screens.splice(e,1)}sortScreens(){this._screens.sort(this._screenSort)}getFirstRenderCamera(t){if(t.scene&&t.scene.renderScene){const e=t.scene.renderScene.cameras;for(let i=0;i<e.length;i++){const n=e[i];if(n.visibility&t.layer)return n}}return null}update(){const t=this._screens;let e=0;for(let i=0;i<t.length;++i){const n=t[i],s=n._getRenderScene();if(!n.enabledInHierarchy||!s)continue;this._opacityDirty=0,this._pOpacity=1,this.walk(n.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();let r=0;if(this._batches.length>e)for(;e<this._batches.length;++e){const t=this._batches.array[e];if(t.model){const e=t.model.subModels;for(let t=0;t<e.length;t++)e[t].priority=r++}else t.descriptorSet=this._descriptorSetCache.getDescriptorSet(t);s.addBatch(t)}}}uploadBuffers(){this._batches.length>0&&(this._meshDataArray.forEach((t=>{t.uploadBuffers()})),this._bufferAccessors.forEach((t=>{t.uploadBuffers(),t.reset()})),this._descriptorSetCache.update())}reset(){for(let t=0;t<this._batches.length;++t){const e=this._batches.array[t];e.isStatic||(e.clear(),this._drawBatchPool.free(e))}this._bufferAccessors.forEach((t=>{t.reset()})),this._meshDataArray.forEach((t=>{t.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),CO.sharedManager.reset()}switchBufferAccessor(t=UM){const e=t===UM?36:jM(t);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==e){let i=this._bufferAccessors.get(e);i||(i=new Ck(this.device,t),this._bufferAccessors.set(e,i)),this._staticVBBuffer=i,this._currBID=-1}return this._staticVBBuffer}registerBufferAccessor(t,e){this._bufferAccessors.set(t,e)}updateBuffer(t,e){const i=this.switchBufferAccessor(t);this._currBID!==e&&(this._currBID=e,this._indexStart=i.getMeshBuffer(e).indexOffset)}commitComp(t,e,i,n,s){let r,o=0,a=-1;if(e&&e.chunk){if(!e.isValid())return;o=e.dataHash,r=e.material,a=e.chunk.bufferId}t.stencilStage=CO.sharedManager.stage;const c=t.stencilStage;this._currHash===o&&0!==o&&this._currMaterial===r&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),e&&!e.isMeshBuffer&&this.updateBuffer(e.vertexFormat,a),this._currRenderData=e,this._currHash=e?e.dataHash:0,this._currComponent=t,this._currTransform=s,this._currMaterial=t.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=t.node.layer,i?(this._currTexture=i.getGFXTexture(),this._currSampler=i.getGFXSampler(),this._currTextureHash=i.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),n.fillBuffers(t,this)}commitIA(t,e,i,n,s){let r,o;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());let a=0,c=0;t&&(r=-1===t.blendHash?null:t.getBlendState(),c=t.blendHash,t.stencilStage=CO.sharedManager.stage,o=null!==t.customMaterial?CO.sharedManager.getStencilStage(t.stencilStage,n):CO.sharedManager.getStencilStage(t.stencilStage),a=CO.sharedManager.getStencilHash(t.stencilStage));const l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=t.node.layer,l.inputAssembler=e,l.useLocalData=s||null,i&&(l.texture=i.getGFXTexture(),l.sampler=i.getGFXSampler(),l.textureHash=i.getHash(),l.samplerHash=l.sampler.hash),l.fillPasses(n||null,o,a,r,c,null,this),this._batches.push(l)}commitModel(t,e,i){let n;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());let s=0;i&&(t.stencilStage!==xO.ENABLED&&t.stencilStage!==xO.DISABLED||(t.stencilStage=CO.sharedManager.stage),n=CO.sharedManager.getStencilStage(t.stencilStage,i),s=CO.sharedManager.getStencilHash(t.stencilStage));const r=l.director.getTotalFrames();e&&(e.updateTransform(r),e.updateUBOs(r));for(let r=0;r<e.subModels.length;r++){const o=this._drawBatchPool.alloc(),a=e.subModels[r];o.visFlags=t.node.layer,o.model=e,o.texture=null,o.sampler=null,o.useLocalData=null,n||(n=null),o.fillPasses(i,n,s,null,0,a.patches,this),o.inputAssembler=a.inputAssembler,o.model.visFlags=o.visFlags,o.descriptorSet=a.descriptorSet,this._batches.push(o)}}setupStaticBatch(t,e){this.finishMergeBatches(),this._staticVBBuffer=e,this.currStaticRoot=t}endStaticBatch(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()}commitStaticBatch(t){this._batches.concat(t.drawBatchList),this.finishMergeBatches()}autoMergeBatches(t){const e=this._currMaterial;if(!e)return;let i;const n=this._currRenderData,s=this._staticVBBuffer;if(n&&n.isMeshBuffer)i=n.requestIA(this.device),-1===this._meshDataArray.indexOf(n)&&this._meshDataArray.push(n);else if(s){const t=this._currBID,e=s.getMeshBuffer(t);if(!e)return;const n=e.indexOffset-this._indexStart;if(n<=0)return;this._indexStart,e.indexOffset,e.setDirty(),i=e.requireFreeIA(this.device),i.firstIndex=this._indexStart,i.indexCount=n,this._indexStart=e.indexOffset}if(this._currBID=-1,!i)return;let r,o,a=0,c=0;t&&(r=-1===t.blendHash?null:t.getBlendState(),c=t.blendHash,o=null!==t.customMaterial?CO.sharedManager.getStencilStage(t.stencilStage,e):CO.sharedManager.getStencilStage(t.stencilStage),a=CO.sharedManager.getStencilHash(t.stencilStage));const l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=this._currLayer,l.texture=this._currTexture,l.sampler=this._currSampler,l.inputAssembler=i,l.useLocalData=this._currTransform,l.textureHash=this._currTextureHash,l.samplerHash=this._currSamplerHash,l.fillPasses(e,o,a,r,c,null,this),this._batches.push(l)}forceMergeBatches(t,e,i){this._currMaterial=t,e?(this._currTexture=e.getGFXTexture(),this._currSampler=e.getGFXSampler(),this._currTextureHash=e.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=i.node.layer,this.autoMergeBatches(i)}resetRenderStates(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}finishMergeBatches(){this.autoMergeBatches(),this.resetRenderStates()}flushMaterial(t){this._currMaterial=t}walk(t,e=0){if(!t.activeInHierarchy)return;const i=t.children,n=t._uiProps,s=n.uiComp,r=this._pOpacity;let o=r;const a=s&&s.color?s.color.a/255:1;if(this._pOpacity=o*=a*n.localOpacity,n._opacity=o,n.colorDirty&&this._opacityDirty++,s&&s.enabledInHierarchy&&s.updateAssembler(this),this._opacityDirty&&s&&!s.useVertexOpacity&&s.renderData&&s.renderData.vertexCount>0){!function(t,e){const i=t.vertexFormat,n=t.chunk.vb;let s,r,o,a=0;for(let c=0;c<i.length;++c){if(s=i[c],r=Gs[s.format],r.hasAlpha)if(o=t.floatStride,r.size/r.count==1){const t=~~We(Math.round(255*e),0,255);for(let e=a;e<n.length;e+=o)n[e]=(4294967040&n[e]|t)>>>0}else if(r.size/r.count==4)for(let t=a+3;t<n.length;t+=o)n[t]=e;a+=r.size>>2}}(s.renderData,o);const t=s.renderData.getMeshBuffer();t&&t.setDirty()}if(i.length>0&&!t._static)for(let t=0;t<i.length;++t){const n=i[t];this.walk(n,e)}n.colorDirty&&(this._opacityDirty--,n.colorDirty=!1),this._pOpacity=r,s&&s.enabledInHierarchy&&s.postUpdateAssembler(this),e+=1}_screenSort(t,e){return t.node.getSiblingIndex()-e.node.getSiblingIndex()}_releaseDescriptorSetCache(t){this._descriptorSetCache.releaseDescriptorSetCache(t)}}t("UI",Tk);class Ek{get descriptorSet(){return this._descriptorSet}constructor(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;const t=l.director.root.device;this._localData=new Float32Array(Am.COUNT),this._localBuffer=t.createBuffer(new Zn(en.UNIFORM|en.TRANSFER_DST,rn.HOST|rn.DEVICE,Am.SIZE,Am.SIZE))}initialize(t){const e=l.director.root.device;this._transform=t.useLocalData,this._textureHash=t.textureHash,this._samplerHash=t.samplerHash,Ak.layout=t.passes[0].localSetLayout,this._descriptorSet=e.createDescriptorSet(Ak),this._descriptorSet.bindBuffer(Am.BINDING,this._localBuffer);const i=im.SAMPLER_SPRITE;this._descriptorSet.bindTexture(i,t.texture),this._descriptorSet.bindSampler(i,t.sampler),this._descriptorSet.update(),this._transformUpdate=!0}updateTransform(t){t!==this._transform&&(this._transform=t,this._transformUpdate=!0,this.uploadLocalData())}equals(t,e,i){return this._transform===t&&this._textureHash===e&&this._samplerHash===i}reset(){this._transform=null,this._textureHash=0,this._samplerHash=0}destroy(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null}isValid(){return this._transform&&this._transform.isValid}uploadLocalData(){const t=this._transform;if((t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){const e=t.worldMatrix;Ii.toArray(this._localData,e,Am.MAT_WORLD_OFFSET),Ii.inverseTranspose(bk,e),Ii.toArray(this._localData,bk,Am.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}}}class Pk{constructor(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Ml((()=>new Ek),16,(t=>t.destroy()))}getDescriptorSet(t){const e=l.director.root;let i;if(t.useLocalData){const e=this._localDescriptorSetCache;for(let i=0,n=e.length;i<n;i++){const n=e[i];if(n.equals(t.useLocalData,t.textureHash,t.samplerHash))return n.descriptorSet}const i=this._localCachePool.alloc();return i.initialize(t),this._localDescriptorSetCache.push(i),i.descriptorSet}if(i=t.textureHash^t.samplerHash,this._descriptorSetCache.has(i))return this._descriptorSetCache.get(i);{Ak.layout=t.passes[0].localSetLayout;const n=e.device.createDescriptorSet(Ak),s=im.SAMPLER_SPRITE;return n.bindTexture(s,t.texture),n.bindSampler(s,t.sampler),n.update(),this._descriptorSetCache.set(i,n),this._dsCacheHashByTexture.set(t.textureHash,i),n}}update(){const t=this._localDescriptorSetCache,e=[];t.forEach((i=>{if(i.isValid())i.uploadLocalData();else{i.reset();const n=t.indexOf(i);e.push(n)}}));for(let i=e.length-1;i>=0;i--)t.splice(e[i],1)}reset(){this._localDescriptorSetCache.forEach((t=>{this._localCachePool.free(t)})),this._localDescriptorSetCache.length=0}releaseDescriptorSetCache(t){const e=this._dsCacheHashByTexture.get(t);e&&this._descriptorSetCache.has(e)&&(this._descriptorSetCache.get(e).destroy(),this._descriptorSetCache.delete(e),this._dsCacheHashByTexture.delete(t))}destroy(){this._descriptorSetCache.forEach((t=>{t.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()}}l.internal.Batcher2D=Tk,U(gk.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((t=>({name:t,suggest:`please use meshBuffer.accessor.${t} instead`})))),V(gk.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),G(gk.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),V(Tk.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),G(JM.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),V(JM.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]),t("QuadRenderData",class extends JM{constructor(t){super(t),I(9006)}});let wk=null,Ik=-1;const Rk="BES bswy:->@123丁ぁᄁ",Dk=Object.create(null),Mk=[],Ok=3e3,Bk=(()=>{let t;return()=>{if(void 0===t)if("FontFace"in window){const e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),i=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);t=e?parseInt(e[1],10)>42:!i}else t=!1;return t}})();function Nk(){let t=!0;const e=Date.now();for(let i=Mk.length-1;i>=0;i--){const n=Mk[i],s=n.fontFamilyName;if(e-n.startTime>Ok){I(4933,s),n.onComplete(null,s),Mk.splice(i,1);continue}const r=n.refWidth,o=`40px ${s}`;wk.font=o,r!==TM(wk,Rk,o)?(Mk.splice(i,1),n.onComplete(null,s)):t=!1}t&&(clearInterval(Ik),Ik=-1)}function Lk(t,e,i){const n=function(t){const e=t.lastIndexOf(".ttf");if(-1===e)return t;const i=t.lastIndexOf("/");let n;return n=-1===i?`${t.substring(0,e)}_LABEL`:`${t.substring(i+1,e)}_LABEL`,-1!==n.indexOf(" ")&&(n=`"${n}"`),n}(t);if(Dk[n])return void i(null,n);if(!wk){const t=document.createElement("canvas");t.width=100,t.height=100,wk=t.getContext("2d")}const s=TM(wk,Rk,`40px ${n}`),r=document.createElement("style");r.type="text/css";let o="";Number.isNaN(n)?o+=`@font-face { font-family:${n}; src:`:o+=`@font-face { font-family:"${n}"; src:`,o+=`url("${t}");`,r.textContent=`${o}}`,document.body.appendChild(r);const a=document.createElement("div"),c=a.style;if(c.fontFamily=n,a.innerHTML=".",c.position="absolute",c.left="-100px",c.top="-100px",document.body.appendChild(a),Bk())!function(t,e,i){const n=new Promise(((i,n)=>{const s=()=>{Date.now()-t>=Ok?n():document.fonts.load(`40px ${e}`).then((t=>{t.length>=1?i():setTimeout(s,100)}),(()=>{n()}))};s()}));let s=null;const r=new Promise(((t,e)=>{s=setTimeout(e,Ok)}));Promise.race([r,n]).then((()=>{s&&(clearTimeout(s),s=null),i(null,e)}),(()=>{I(4933,e),i(null,e)}))}(Date.now(),n,i);else{const t={fontFamilyName:n,refWidth:s,onComplete:i,startTime:Date.now()};Mk.push(t),-1===Ik&&(Ik=setInterval(Nk,100))}Dk[n]=r}function Fk(t,e,i,n){const s=new tM;s._nativeUrl=t,s._nativeAsset=e,n(null,s)}var zk,Vk,Gk,Uk,kk,Hk;function jk(t){return"string"==typeof t||"number"==typeof t}nI.register({".font":Lk,".eot":Lk,".ttf":Lk,".woff":Lk,".svg":Lk,".ttc":Lk}),hI.register({".font":Fk,".eot":Fk,".ttf":Fk,".woff":Fk,".svg":Fk,".ttc":Fk}),l.UI={MeshBuffer:gk,spriteAssembler:_k,graphicsAssembler:uG,labelAssembler:BU,RenderData:KM,MeshRenderData:JM};let Wk=dc("cc.animation.HierarchyPath")((Gk=sc((Vk=class{constructor(t){nc(this,"path",Gk,this),this.path=t||""}get(t){if(!(t instanceof iS))return I(3925),null;return t.getChildByPath(this.path)||(I(3926,t.name,this.path),null)}}).prototype,"path",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zk=Vk))||zk,qk=dc("cc.animation.ComponentPath")((Hk=sc((kk=class{constructor(t){nc(this,"component",Hk,this),this.component=t||""}get(t){if(!(t instanceof iS))return I(3927),null;return t.getComponent(this.component)||(I(3928,t.name,this.component),null)}}).prototype,"component",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Uk=kk))||Uk;var Xk,Yk,Kk,Jk,$k;let Zk=dc("cc.animation.UniformProxyFactory")((Kk=sc((Yk=class{constructor(t,e){nc(this,"passIndex",Kk,this),nc(this,"uniformName",Jk,this),nc(this,"channelIndex",$k,this),this.passIndex=e||0,this.uniformName=t||""}forTarget(t){const e=t.passes[this.passIndex],i=e.getHandle(this.uniformName);if(!i)throw new Error(`Material "${t.name}" has no uniform "${this.uniformName}"`);if(Gf.getTypeFromHandle(i)<tn.SAMPLER1D){const n=void 0===this.channelIndex?i:e.getHandle(this.uniformName,this.channelIndex,tn.FLOAT);if(!n)throw new Error(`Uniform "${this.uniformName} (in material ${t.name}) has no channel ${this.channelIndex}"`);return function(t,e){for(const i of t.shaderInfo.blocks)for(const t of i.members)if(t.name===e)return t.count>1;return!1}(e,this.uniformName)?{set:t=>{e.setUniformArray(n,t)}}:{set:t=>{e.setUniform(n,t)}}}{const t=Gf.getBindingFromHandle(i),n=e.properties[this.uniformName],s=n&&n.value?`${n.value}-texture`:fp(n.type);let r=Mf.get(s);return r||(y(`Illegal texture default value: ${s}.`),r=Mf.get("default-texture")),{set:i=>{i||(i=r);const n=i.getGFXTexture();n&&n.width&&n.height&&(e.bindTexture(t,n),i instanceof Zp&&e.bindSampler(t,l.game._gfxDevice.getSampler(i.getSamplerInfo())))}}}}}).prototype,"passIndex",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jk=sc(Yk.prototype,"uniformName",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$k=sc(Yk.prototype,"channelIndex",[qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),Xk=Yk))||Xk;var Qk,tH,eH,iH,nH,sH,rH,oH;let aH=dc("cc.animation.MorphWeightValueProxy")((eH=sc((tH=class{constructor(){nc(this,"subMeshIndex",eH,this),nc(this,"shapeIndex",iH,this)}forTarget(t){return{set:e=>{t.setWeight(e,this.subMeshIndex,this.shapeIndex)}}}}).prototype,"subMeshIndex",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iH=sc(tH.prototype,"shapeIndex",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qk=tH))||Qk,cH=dc("cc.animation.MorphWeightsValueProxy")((rH=sc((sH=class{constructor(){nc(this,"subMeshIndex",rH,this)}forTarget(t){return{set:e=>{t.setWeights(e,this.subMeshIndex)}}}}).prototype,"subMeshIndex",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nH=sH))||nH,lH=dc("cc.animation.MorphWeightsAllValueProxy")(oH=class{forTarget(t){return{set:e=>{var i,n;const s=null!==(i=null===(n=t.mesh)||void 0===n?void 0:n.struct.primitives.length)&&void 0!==i?i:0;for(let i=0;i<s;++i)t.setWeights(e,i)}}}})||oH;var hH,_H,uH,dH,mH;function pH(t,e,i,n){var s,r,o,a,c;let l=new e,h=new e,_=new e,u=dc(t)((o=sc((r=class{constructor(t,i,n){nc(this,"dataPoint",o,this),nc(this,"inTangent",a,this),nc(this,"outTangent",c,this),this.dataPoint=t||new e,this.inTangent=i||new e,this.outTangent=n||new e}lerp(t,e,s){const r=this.dataPoint,o=t.dataPoint;h=i(h,this.inTangent,s),_=i(_,t.outTangent,s);const a=e*e*e,c=e*e,u=a-2*c+e,d=-2*a+3*c,m=a-c;return l=i(l,r,2*a-3*c+1),l=n(l,l,h,u),l=n(l,l,o,d),l=n(l,l,_,m),l}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),a=sc(r.prototype,"inTangent",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),c=sc(r.prototype,"outTangent",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),s=r))||s;if(e===Si){const t=u.prototype.lerp;u.prototype.lerp=function(e,i,n){const s=t.call(this,e,i,n);return Si.normalize(s,s),s}}return u}const fH=pH("cc.CubicSplineVec2Value",Oi,Oi.multiplyScalar,Oi.scaleAndAdd),gH=pH("cc.CubicSplineVec3Value",mi,mi.multiplyScalar,mi.scaleAndAdd),vH=pH("cc.CubicSplineVec4Value",Fi,Fi.multiplyScalar,Fi.scaleAndAdd),yH=pH("cc.CubicSplineQuatValue",Si,Si.multiplyScalar,Si.scaleAndAdd);let xH=dc("cc.CubicSplineNumberValue")((uH=sc((_H=class{constructor(t,e,i){nc(this,"dataPoint",uH,this),nc(this,"inTangent",dH,this),nc(this,"outTangent",mH,this),this.dataPoint=t,this.inTangent=e,this.outTangent=i}lerp(t,e,i){const n=this.dataPoint,s=t.dataPoint,r=e*e*e,o=e*e;return n*(2*r-3*o+1)+this.outTangent*i*(r-2*o+e)+s*(-2*r+3*o)+t.inTangent*i*(r-o)}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dH=sc(_H.prototype,"inTangent",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mH=sc(_H.prototype,"outTangent",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hH=_H))||hH;const SH=Symbol("CreateEval");var CH,AH,bH,TH,EH,PH,wH,IH,RH,DH,MH,OH,BH,NH,LH,FH;const zH=Symbol("NormalizedFollow"),VH=Symbol("ConvertAsTrsPath"),GH=Symbol("TrackBinding");let UH=dc("cc.animation.TrackPath")((bH=sc((AH=class t{constructor(){nc(this,"_paths",bH,this)}get length(){return this._paths.length}toProperty(t){return this._paths.push(t),this}toElement(t){return this._paths.push(t),this}toHierarchy(t){return this._paths.push(new Wk(t)),this}toComponent(t){const e=new qk("string"==typeof t?t:Ut.getClassName(t));return this._paths.push(e),this}toCustomized(t){return this._paths.push(t),this}append(...t){const e=this._paths.concat(...t.map((t=>t._paths)));return this._paths=e,this}isPropertyAt(t){return"string"==typeof this._paths[t]}parsePropertyAt(t){return this._paths[t]}isElementAt(t){return"number"==typeof this._paths[t]}parseElementAt(t){return this._paths[t]}isHierarchyAt(t){return this._paths[t]instanceof Wk}parseHierarchyAt(t){return this.isHierarchyAt(t),this._paths[t].path}isComponentAt(t){return this._paths[t]instanceof qk}parseComponentAt(t){return this.isComponentAt(t),this._paths[t].component}slice(e,i){const n=new t;return n._paths=this._paths.slice(e,i),n}trace(t,e,i){var n,s;return null!==(n=e)&&void 0!==n||(e=0),null!==(s=i)&&void 0!==s||(i=this._paths.length),this[zH](t,e,i)}[VH](){const{_paths:t}=this,e=t.length;let i,n=0,s="";for(;n<e;++n){const e=t[n];if(!(e instanceof Wk))break;e.path&&(s?s+=`/${e.path}`:s=e.path)}if(n===e)return null;if(n!==e-1)return null;switch(t[n]){case"position":case"scale":case"rotation":case"eulerAngles":i=t[n];break;default:return null}return{node:s,property:i}}[zH](t,e,i){const{_paths:n}=this;let s=t;for(let t=e;t<i;++t){const e=n[t];if(jk(e)){if(!(e in s))return I(3929,e),null;s=s[e]}else s=e.get(s);if(null===s)break}return s}}).prototype,"_paths",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CH=AH))||CH,kH=dc("cc.animation.TrackBinding")(TH=Tc((PH=sc((EH=class{constructor(){nc(this,"path",PH,this),nc(this,"proxy",wH,this)}parseTrsPath(){return this.proxy?null:this.path[VH]()}createRuntimeBinding(t,e,i){const{path:n,proxy:s}=this,r=n.length,o=r-1;if(0===r||!n.isPropertyAt(o)&&!n.isElementAt(o)||s){if(s){const e=n[zH](t,0,r);if(null===e)return null;const i=s.forTarget(e),o={setValue:t=>{i.set(t)}},a=i.get;return a&&(o.getValue=()=>a.call(i)),o}return D(3921),null}{const s=n.isPropertyAt(o)?n.parsePropertyAt(o):n.parseElementAt(o),a=n[zH](t,0,r-1);return null===a?null:e&&a instanceof iS&&function(t){return"position"===t||"rotation"===t||"scale"===t||"eulerAngles"===t}(s)?e.createPoseWriter(a,s,i):{setValue:t=>{a[s]=t},getValue:()=>a[s]}}}isMaskedOff(t){const e=this.parseTrsPath();if(!e)return!1;const i=t.joints[Symbol.iterator]();for(let t=i.next();!t.done;t=i.next()){const{value:i}=t;if(i.path===e.node)return!i.enabled}return!1}}).prototype,"path",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new UH}}),wH=sc(EH.prototype,"proxy",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),TH=EH))||TH)||TH,HH=dc("cc.animation.Track")((DH=sc((RH=class{constructor(){nc(this,"_binding",DH,this)}get path(){return this._binding.path}set path(t){this._binding.path=t}get proxy(){return this._binding.proxy}set proxy(t){this._binding.proxy=t}get[GH](){return this._binding}channels(){return[]}range(){const t={min:1/0,max:-1/0};for(const e of this.channels())t.min=Math.min(t.min,e.curve.rangeMin),t.max=Math.max(t.max,e.curve.rangeMax);return t}}).prototype,"_binding",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kH}}),IH=RH))||IH,jH=dc("cc.animation.Channel")((BH=sc((OH=class{constructor(t){this.name="",nc(this,"_curve",BH,this),this._curve=t}get curve(){return this._curve}}).prototype,"_curve",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),MH=OH))||MH,WH=dc("cc.animation.SingleChannelTrack")((FH=sc((LH=class extends HH{constructor(){super(),nc(this,"_channel",FH,this),this._channel=new jH(this.createCurve())}get channel(){return this._channel}channels(){return[this._channel]}createCurve(){throw new Error("Not impl")}[SH](t){const{curve:e}=this._channel;return new qH(e)}}).prototype,"_channel",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),NH=LH))||NH;class qH{constructor(t){this._curve=t}evaluate(t){return this._curve.evaluate(t)}}var XH;let YH=dc("cc.animation.RealTrack")(XH=class extends WH{createCurve(){return new Wu}})||XH;function KH(t){return 0===t.keyFramesCount?void 0:t}var JH,$H,ZH,QH;const tj=["X","Y","Z","W"];let ej=dc("cc.animation.VectorTrack")((ZH=sc(($H=class extends HH{constructor(){super(),nc(this,"_channels",ZH,this),nc(this,"_nComponents",QH,this),this._channels=new Array(4);for(let t=0;t<this._channels.length;++t){const e=new jH(new Wu);e.name=tj[t],this._channels[t]=e}}get componentsCount(){return this._nComponents}set componentsCount(t){this._nComponents=t}channels(){return this._channels}[SH](){switch(this._nComponents){default:case 2:return new ij(KH(this._channels[0].curve),KH(this._channels[1].curve));case 3:return new nj(KH(this._channels[0].curve),KH(this._channels[1].curve),KH(this._channels[2].curve));case 4:return new sj(KH(this._channels[0].curve),KH(this._channels[1].curve),KH(this._channels[2].curve),KH(this._channels[3].curve))}}}).prototype,"_channels",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),QH=sc($H.prototype,"_nComponents",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),JH=$H))||JH;class ij{constructor(t,e){this._result=new Oi,this._x=t,this._y=e}evaluate(t,e){return this._x&&this._y||!e.getValue||Oi.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._result}}class nj{constructor(t,e,i){this._result=new mi,this._x=t,this._y=e,this._z=i}evaluate(t,e){return this._x&&this._y&&this._z||!e.getValue||mi.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._result}}class sj{constructor(t,e,i,n){this._result=new Fi,this._x=t,this._y=e,this._z=i,this._w=n}evaluate(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||Fi.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._w&&(this._result.w=this._w.evaluate(t)),this._result}}var rj;let oj=dc("cc.animation.QuatTrack")(rj=class extends WH{createCurve(){return new wd}[SH](){return new aj(this.channels()[0].curve)}})||rj;class aj{constructor(t){this._result=new Si,this._curve=t}evaluate(t){return this._curve.evaluate(t,this._result),this._result}}var cj,lj,hj;const _j=["Red","Green","Blue","Alpha"];let uj=dc("cc.animation.ColorTrack")((hj=sc((lj=class extends HH{constructor(){super(),nc(this,"_channels",hj,this),this._channels=new Array(4);for(let t=0;t<this._channels.length;++t){const e=new jH(new Wu);e.name=_j[t],this._channels[t]=e}}channels(){return this._channels}[SH](){return new dj(KH(this._channels[0].curve),KH(this._channels[1].curve),KH(this._channels[2].curve),KH(this._channels[3].curve))}}).prototype,"_channels",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),cj=lj))||cj;class dj{constructor(t,e,i,n){this._result=new hi,this._x=t,this._y=e,this._z=i,this._w=n}evaluate(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||hi.copy(this._result,e.getValue()),this._x&&(this._result.r=this._x.evaluate(t)),this._y&&(this._result.g=this._y.evaluate(t)),this._z&&(this._result.b=this._z.evaluate(t)),this._w&&(this._result.a=this._w.evaluate(t)),this._result}}var mj,pj,fj;const gj=["Width","Height"];let vj=dc("cc.animation.SizeTrack")((fj=sc((pj=class extends HH{constructor(){super(),nc(this,"_channels",fj,this),this._channels=new Array(2);for(let t=0;t<this._channels.length;++t){const e=new jH(new Wu);e.name=gj[t],this._channels[t]=e}}channels(){return this._channels}[SH](){return new yj(KH(this._channels[0].curve),KH(this._channels[1].curve))}}).prototype,"_channels",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),mj=pj))||mj;class yj{constructor(t,e){this._result=new Gi,this._width=t,this._height=e}evaluate(t,e){if((!this._width||!this._height)&&e.getValue){const t=e.getValue();this._result.x=t.x,this._result.y=t.y}return this._width&&(this._result.width=this._width.evaluate(t)),this._height&&(this._result.height=this._height.evaluate(t)),this._result}}var xj;let Sj=dc("cc.animation.ObjectTrack")(xj=class extends WH{createCurve(){return new Vd}})||xj;const Cj=Symbol("[[Owner]]");function Aj(t){t[Cj]}let bj,Tj;!function(t){t[t.FLOAT=0]="FLOAT",t[t.BOOLEAN=1]="BOOLEAN",t[t.TRIGGER=2]="TRIGGER",t[t.INTEGER=3]="INTEGER"}(bj||(bj={})),function(t){t[t.AFTER_CONSUMED=0]="AFTER_CONSUMED",t[t.NEXT_FRAME_OR_AFTER_CONSUMED=1]="NEXT_FRAME_OR_AFTER_CONSUMED"}(Tj||(Tj={}));class Ej{constructor(t,e){this.type=void 0,this.resetMode=Tj.AFTER_CONSUMED,this._value=void 0,this._refs=[],this.type=t,this._value=e}get value(){return this._value}set value(t){this._value=t;for(const{fn:e,thisArg:i,args:n}of this._refs)e.call(i,t,...n)}bind(t,e,...i){return this._refs.push({fn:t,thisArg:e,args:i}),this._value}}class Pj extends Error{constructor(t){super(`${t} transition is invalid`),this.name="TransitionRejectError"}}class wj extends Error{constructor(t){super(`Graph variable ${t} is not defined`)}}class Ij extends Error{constructor(t,e,i){super(`Expect graph variable ${t} to have type '${e}' instead of received '${null!=i?i:typeof i}'`)}}const Rj=Symbol("[[createEval]]");var Dj,Mj,Oj,Bj,Nj,Lj;const Fj=Symbol("[[Outgoing transitions]]"),zj=Symbol("[[Incoming transitions]]");let Vj=dc("cc.animation.State")((Oj=sc((Mj=class extends Zc{constructor(){super(),nc(this,"name",Oj,this),this[Fj]=[],this[zj]=[]}}).prototype,"name",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Dj=Mj))||Dj,Gj=dc("cc.animation.InteractiveState")((Lj=sc((Nj=class extends Vj{constructor(...t){super(...t),nc(this,"_components",Lj,this)}get components(){return this._components}addComponent(t){const e=new t;return this._components.push(e),e}removeComponent(t){$(this._components,t)}instantiateComponents(){return this._components.map((t=>T_(t)))}}).prototype,"_components",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Bj=Nj))||Bj;var Uj,kj,Hj,jj,Wj,qj;let Xj=dc("cc.animation.Motion")((Hj=sc((kj=class t extends Gj{constructor(...t){super(...t),nc(this,"motion",Hj,this),nc(this,"speed",jj,this),nc(this,"speedMultiplier",Wj,this),nc(this,"speedMultiplierEnabled",qj,this)}clone(){var e,i;const n=new t;return n.motion=null!==(e=null===(i=this.motion)||void 0===i?void 0:i.clone())&&void 0!==e?e:null,n.speed=this.speed,n.speedMultiplier=this.speedMultiplier,n.speedMultiplierEnabled=this.speedMultiplierEnabled,n}}).prototype,"motion",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jj=sc(kj.prototype,"speed",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Wj=sc(kj.prototype,"speedMultiplier",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qj=sc(kj.prototype,"speedMultiplierEnabled",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Uj=kj))||Uj;const Yj=Symbol("[[OnAfterDeserialized]]");var Kj,Jj,$j,Zj,Qj,tW,eW,iW,nW,sW,rW,oW,aW,cW,lW,hW,_W,uW,dW,mW,pW,fW,gW,vW,yW,xW,SW,CW,AW,bW,TW,EW,PW,wW,IW,RW,DW,MW,OW,BW,NW,LW;let FW,zW=dc("cc.animation.Transition")(($j=sc((Jj=class extends Zc{constructor(t,e,i){super(),nc(this,"from",$j,this),nc(this,"to",Zj,this),nc(this,"conditions",Qj,this),this[Cj]=void 0,this.from=t,this.to=e,i&&(this.conditions=i)}}).prototype,"from",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Zj=sc(Jj.prototype,"to",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Qj=sc(Jj.prototype,"conditions",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kj=Jj))||Kj,VW=dc("cc.animation.AnimationTransition")((iW=sc((eW=class extends zW{constructor(...t){super(...t),nc(this,"duration",iW,this),nc(this,"relativeDuration",nW,this),nc(this,"exitConditionEnabled",sW,this),nc(this,"_exitCondition",rW,this)}get exitCondition(){return this._exitCondition}set exitCondition(t){this._exitCondition=t}}).prototype,"duration",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),nW=sc(eW.prototype,"relativeDuration",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sW=sc(eW.prototype,"exitConditionEnabled",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),rW=sc(eW.prototype,"_exitCondition",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tW=eW))||tW,GW=dc("cc.animation.EmptyState")(oW=class extends Vj{})||oW,UW=dc("cc.animation.EmptyStateTransition")((lW=sc((cW=class extends zW{constructor(...t){super(...t),nc(this,"duration",lW,this)}}).prototype,"duration",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),aW=cW))||aW,kW=dc("cc.animation.StateMachine")((uW=sc((_W=class t extends Zc{__callOnAfterDeserializeRecursive(){this[Yj]();const t=this._states.length;for(let e=0;e<t;++e){const t=this._states[e];t instanceof HW&&t.stateMachine.__callOnAfterDeserializeRecursive()}}constructor(){super(),nc(this,"_states",uW,this),nc(this,"_transitions",dW,this),nc(this,"_entryState",mW,this),nc(this,"_exitState",pW,this),nc(this,"_anyState",fW,this),this._entryState=this._addState(new Vj),this._entryState.name="Entry",this._exitState=this._addState(new Vj),this._exitState.name="Exit",this._anyState=this._addState(new Vj),this._anyState.name="Any"}[Yj](){this._states.forEach((()=>{})),this._transitions.forEach((t=>{t.from[Fj].push(t),t.to[zj].push(t)}))}[Rj](t){throw new Error("Method not implemented.")}get entryState(){return this._entryState}get exitState(){return this._exitState}get anyState(){return this._anyState}states(){return this._states}transitions(){return this._transitions}getTransitionsBetween(t,e){return Aj(t),Aj(e),t[Fj].filter((t=>t.to===e))}getOutgoings(t){return Aj(t),t[Fj]}getIncomings(t){return Aj(t),t[zj]}addMotion(){return this._addState(new Xj)}addSubStateMachine(){return this._addState(new HW)}addEmpty(){return this._addState(new GW)}remove(t){Aj(t),t!==this.entryState&&t!==this.exitState&&t!==this.anyState&&(this.eraseTransitionsIncludes(t),$(this._states,t))}connect(t,e,i){if(Aj(t),Aj(e),e===this.entryState)throw new Pj("to-entry");if(e===this.anyState)throw new Pj("to-any");if(t===this.exitState)throw new Pj("from-exit");const n=t instanceof Xj||t===this._anyState?new VW(t,e,i):t instanceof GW?new UW(t,e,i):new zW(t,e,i);return this._transitions.push(n),t[Fj].push(n),e[zj].push(n),n}disconnect(t,e){Aj(t),Aj(e);const i=t[Fj],n=e[zj],s=this._transitions,r=i.filter((t=>t.to===e)),o=r.length;for(let t=0;t<o;++t){const e=r[t];$(i,e),$(s,e),Z(n,(t=>t===e))}}removeTransition(t){$(this._transitions,t),Z(t.from[Fj],(e=>e===t)),Z(t.to[zj],(e=>e===t))}eraseOutgoings(t){Aj(t);const e=t[Fj];for(let t=0;t<e.length;++t){const i=e[t],n=i.to;$(this._transitions,i),Z(n[zj],(t=>t===i))}e.length=0}eraseIncomings(t){Aj(t);const e=t[zj];for(let t=0;t<e.length;++t){const i=e[t],n=i.from;$(this._transitions,i),Z(n[Fj],(t=>t===i))}e.length=0}eraseTransitionsIncludes(t){this.eraseIncomings(t),this.eraseOutgoings(t)}clone(){const e=new t,i=new Map;for(const t of this._states)switch(t){case this._entryState:i.set(t,e._entryState);break;case this._exitState:i.set(t,e._exitState);break;case this._anyState:i.set(t,e._anyState);break;default:if(t instanceof Xj||t instanceof HW){const n=t.clone();e._addState(n),i.set(t,n)}}for(const t of this._transitions){const n=i.get(t.from),s=i.get(t.to),r=e.connect(n,s);r.conditions=t.conditions.map((t=>t.clone())),r instanceof VW&&(r.duration=t.duration,r.exitConditionEnabled=t.exitConditionEnabled,r.exitCondition=t.exitCondition)}return e}_addState(t){return this._states.push(t),t}}).prototype,"_states",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dW=sc(_W.prototype,"_transitions",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mW=sc(_W.prototype,"_entryState",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),pW=sc(_W.prototype,"_exitState",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),fW=sc(_W.prototype,"_anyState",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),hW=_W))||hW,HW=dc("cc.animation.SubStateMachine")((yW=sc((vW=class t extends Gj{constructor(...t){super(...t),nc(this,"_stateMachine",yW,this)}get stateMachine(){return this._stateMachine}clone(){const e=new t;return e._stateMachine=this._stateMachine.clone(),e}}).prototype,"_stateMachine",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kW}}),gW=vW))||gW,jW=dc("cc.animation.Layer")((CW=sc((SW=class{constructor(){this[Cj]=void 0,nc(this,"_stateMachine",CW,this),nc(this,"name",AW,this),nc(this,"weight",bW,this),nc(this,"mask",TW,this),this._stateMachine=new kW}get stateMachine(){return this._stateMachine}}).prototype,"_stateMachine",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),AW=sc(SW.prototype,"name",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bW=sc(SW.prototype,"weight",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),TW=sc(SW.prototype,"mask",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xW=SW))||xW;!function(t){t[t.override=0]="override",t[t.additive=1]="additive"}(FW||(FW={})),Tj.AFTER_CONSUMED;let WW=dc("cc.animation.PlainVariable")((wW=sc((PW=class{constructor(t){if(nc(this,"_type",wW,this),nc(this,"_value",IW,this),void 0!==t)switch(this._type=t,t){default:break;case bj.FLOAT:case bj.INTEGER:this._value=0;break;case bj.BOOLEAN:this._value=!1}}get type(){return this._type}get value(){return this._value}set value(t){this._value=t}}).prototype,"_type",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bj.FLOAT}}),IW=sc(PW.prototype,"_value",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EW=PW))||EW,qW=dc("cc.animation.TriggerVariable")((MW=sc((DW=class{constructor(){nc(this,"_flags",MW,this)}get type(){return bj.TRIGGER}get value(){return!!((1&this._flags)>>0)}set value(t){t?this._flags|=1:this._flags&=-2}get resetMode(){return(6&this._flags)>>1}set resetMode(t){this._flags&=-7,this._flags|=t<<1}}).prototype,"_flags",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RW=DW))||RW,XW=dc("cc.animation.AnimationGraph")((NW=sc((BW=class extends fh{constructor(){super(),nc(this,"_layers",NW,this),nc(this,"_variables",LW,this)}onLoaded(){const{_layers:t}=this,e=t.length;for(let i=0;i<e;++i)t[i].stateMachine.__callOnAfterDeserializeRecursive()}get layers(){return this._layers}get variables(){return Object.entries(this._variables)}addLayer(){const t=new jW;return this._layers.push(t),t}removeLayer(t){Gt.removeAt(this._layers,t)}moveLayer(t,e){!function(t,e,i){if(Ht(t,e),Ht(t,i),e===i)return t;const n=t[e];if(e<i)for(let n=e+1;n<=i;++n)t[n-1]=t[n];else for(let n=e;n!==i;--n)t[n]=t[n-1];t[i]=n}(this._layers,t,e)}addBoolean(t,e=!1){const i=new WW(bj.BOOLEAN);i.value=e,this._variables[t]=i}addFloat(t,e=0){const i=new WW(bj.FLOAT);i.value=e,this._variables[t]=i}addInteger(t,e=0){const i=new WW(bj.INTEGER);i.value=e,this._variables[t]=i}addTrigger(t,e=!1,i=Tj.AFTER_CONSUMED){const n=new qW;n.resetMode=i,n.value=e,this._variables[t]=n}removeVariable(t){delete this._variables[t]}getVariable(t){return this._variables[t]}}).prototype,"_layers",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),LW=sc(BW.prototype,"_variables",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),OW=BW))||OW;const YW=Symbol("BakeNodeCurves");class KW{static getOrExtract(t){let e=KW.pool.get(t);if(!e||e.samples!==t.sample){e&&l.director.root.dataPoolManager.releaseAnimationClip(t);const i=Math.ceil(t.sample*t.duration)+1,n=t.sample;e=t[YW](0,n,i),KW.pool.set(t,e)}return e}static destroy(t){KW.pool.delete(t)}}t("SkelAnimDataHub",KW),KW.pool=new Map;class JW{constructor(t){let e,i;this.ratios=void 0,this._findRatio=void 0,this.ratios=t;let n=!0;for(let s=1,r=t.length;s<r;s++)if(e=t[s]-t[s-1],1===s)i=e;else if(Math.abs(e-i)>1e-6){n=!1;break}this._findRatio=n?tq:tc}sample(t){return this._findRatio(this.ratios,t)}}t("RatioSampler",JW),l.RatioSampler=JW;class $W{static Bezier(t){return t}constructor(t,e){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=e,this._values=t.values;const i=t=>"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?$W.Linear:$W.Bezier(t):$W.Linear;if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(const e of Object.keys(t.easingMethods))this.types[e]=i(t.easingMethods[e])}else this.type=null;const n=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=eq(n)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}hasLerp(){return!!this._lerp}valueAt(t){if(void 0===this._array){const e=this._values[t];return e&&e.getNoLerp?e.getNoLerp():e}for(let e=0;e<this._array.length;++e)this._array[e]=this._values[this._array.length*t+e];return this._array}valueBetween(t,e,i,n,s){if(this._lerp){const r=this.types?this.types[e]:this.type,o=s-i;let a=(t-i)/o;if(r&&(a=QW(a,r)),void 0===this._array){const t=this._values[e],i=this._values[n];return this._lerp(t,i,a,o*this._duration)}for(let t=0;t<this._array.length;++t){const i=this._values[this._array.length*e+t],s=this._values[this._array.length*n+t];this._array[t]=this._lerp(i,s,a,o*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(e);for(let t=0;t<this._array.length;++t)this._array[t]=this._values[this._array.length*e+t];return this._array}empty(){return 0===this._values.length}constant(){return 1===this._values.length}}function ZW(t,e,i){let n=e.sample(i);if(n<0)if(n=~n,n<=0)n=0;else{if(!(n>=e.ratios.length))return t.valueBetween(i,n-1,e.ratios[n-1],n,e.ratios[n]);n=e.ratios.length-1}return t.valueAt(n)}function QW(t,e){if("string"==typeof e){const i=Bu[e];i?t=i(t):D(3906,e)}else Array.isArray(e)&&(t=pd(e,t));return t}function tq(t,e){const i=t.length-1;if(0===i)return 0;const n=t[0];if(e<n)return 0;const s=t[i];if(e>s)return i;const r=(e=(e-n)/(s-n))/(1/i),o=0|r,a=1e-6;return r-o<a?o:o+1-r<a?o+1:~(o+1)}t("AnimCurve",$W),$W.Linear=null,l.AnimCurve=$W,t("EventInfo",class{constructor(){this.events=[]}add(t,e){this.events.push({func:t||"",params:e||[]})}}),l.sampleAnimationCurve=ZW;const eq=(()=>{function t(t,e,i,n){return t.lerp(e,i,n)}return e=>{if(null!==e){if("number"==typeof e)return Xe;if("object"==typeof e&&e.constructor){if(e instanceof Si)return function(){const t=new Si;return(e,i,n)=>Si.slerp(t,e,i,n)}();if(e instanceof Yt)return function(t){const e=new t;return(i,n,s)=>(t.lerp(e,i,n,s),e)}(e.constructor);if(e.constructor===Number)return Xe;if("function"==typeof e.lerp)return t}}}})();var iq,nq,sq,rq,oq,aq;let cq=dc("cc.animation.UntypedTrackChannel")((sq=sc((nq=class extends jH{constructor(){super(new Wu),nc(this,"property",sq,this)}}).prototype,"property",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),iq=nq))||iq,lq=dc("cc.animation.UntypedTrack")((aq=sc((oq=class extends HH{constructor(...t){super(...t),nc(this,"_channels",aq,this)}channels(){return this._channels}[SH](t){if(!t.getValue)throw new Error(N(3930));const e=t=>{var e;return null===(e=this._channels.find((e=>e.property===t)))||void 0===e?void 0:e.curve},i=t.getValue();switch(!0){default:throw new Error(N(3931));case i instanceof Oi:return new ij(e("x"),e("y"));case i instanceof mi:return new nj(e("x"),e("y"),e("z"));case i instanceof Fi:return new sj(e("x"),e("y"),e("z"),e("w"));case i instanceof hi:return new dj(e("r"),e("g"),e("b"),e("a"));case i instanceof Gi:return new yj(e("width"),e("height"))}}addChannel(t){const e=new cq;return e.property=t,this._channels.push(e),e}upgrade(t){const e=(t,e)=>{const i=this.channels().find((e=>e.property===t));i&&(e.name=i.name,e.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=t(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":{const t=new ej;t.path=this.path,t.proxy=this.proxy,t.componentsCount="vec2"===i?2:"vec3"===i?3:4;const[n,s,r,o]=t.channels();switch(i){case"vec4":e("w",o);case"vec3":e("z",r);default:case"vec2":e("x",n),e("y",s)}return t}case"color":{const t=new uj,[i,n,s,r]=t.channels();return e("r",i),e("g",n),e("b",s),e("a",r),e("x",i),e("y",n),e("z",s),e("w",r),t}case"size":}return null}}).prototype,"_channels",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rq=oq))||rq;class hq{constructor(t){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=t}get keys(){return this._keys}set keys(t){this._keys=t}get curves(){return this._curves}set curves(t){this._curves=t,delete this._runtimeCurves}get commonTargets(){return this._commonTargets}set commonTargets(t){this._commonTargets=t}get data(){return this._data}getPropertyCurves(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}toTracks(){const t=[],{keys:e,curves:i,commonTargets:n}=this,s=(t,e,i)=>{const n=new UH;for(const t of e)"string"==typeof t?n.toProperty(t):"number"==typeof t?n.toElement(t):t instanceof Wk?n.toHierarchy(t.path):t instanceof qk?n.toComponent(t.component):n.toCustomized(t);t.path=n,t.proxy=i},r=n.map((e=>{const i=new lq;return s(i,e.modifiers,e.valueAdapter),t.push(i),i}));for(const n of i){var o;const i=n.data,a=i.values;if(0===a.length)continue;const c=i.keys<0?[0]:e[i.keys],l=a[0],h=null===(o=i.interpolate)||void 0===o||o;i._arrayLength;const _=new uq(i,c.length),u=t=>{s(t,n.modifiers,n.valueAdapter)};let d;if("number"==typeof n.commonTarget){if(!a.every((t=>"number"==typeof t))){I(3932);continue}if(n.valueAdapter||1!==n.modifiers.length||"string"!=typeof n.modifiers[0]){I(3933);continue}const t=n.modifiers[0],e=r[n.commonTarget],{curve:i}=e.addChannel(t);d=i}(()=>{if("number"==typeof l){if(!a.every((t=>"number"==typeof t)))return void I(3934);let e;if(d)e=d;else{const i=new YH;u(i),t.push(i),e=i.channel.curve}const i=h?Ja.LINEAR:Ja.CONSTANT;return e.assignSorted(c,a.map((t=>({value:t,interpolationMode:i})))),void _.convert(e)}if("object"==typeof l)switch(!0){default:break;case _q(a,Oi):case _q(a,mi):case _q(a,Fi):{const e=l instanceof Oi?2:l instanceof mi?3:4,i=new ej;u(i),i.componentsCount=e;const[{curve:n},{curve:s},{curve:r},{curve:o}]=i.channels(),d=h?Ja.LINEAR:Ja.CONSTANT,m=t=>({value:t,interpolationMode:d});switch(e){case 4:o.assignSorted(c,a.map((t=>m(t.w)))),_.convert(o);case 3:r.assignSorted(c,a.map((t=>m(t.z)))),_.convert(r);default:n.assignSorted(c,a.map((t=>m(t.x)))),_.convert(n),s.assignSorted(c,a.map((t=>m(t.y)))),_.convert(s)}return void t.push(i)}case _q(a,Si):{const e=new oj;u(e);const i=h?Td.SLERP:Td.CONSTANT;return e.channel.curve.assignSorted(c,a.map((t=>({value:Si.clone(t),interpolationMode:i})))),_.convertQuatCurve(e.channel.curve),void t.push(e)}case _q(a,hi):{const e=new uj;u(e);const[{curve:i},{curve:n},{curve:s},{curve:r}]=e.channels(),o=h?Ja.LINEAR:Ja.CONSTANT,l=t=>({value:t,interpolationMode:o});return i.assignSorted(c,a.map((t=>l(t.r)))),_.convert(i),n.assignSorted(c,a.map((t=>l(t.g)))),_.convert(n),s.assignSorted(c,a.map((t=>l(t.b)))),_.convert(s),r.assignSorted(c,a.map((t=>l(t.a)))),_.convert(r),void t.push(e)}case _q(a,Gi):{const e=new vj;u(e);const[{curve:i},{curve:n}]=e.channels(),s=h?Ja.LINEAR:Ja.CONSTANT,r=t=>({value:t,interpolationMode:s});return i.assignSorted(c,a.map((t=>r(t.width)))),_.convert(i),n.assignSorted(c,a.map((t=>r(t.height)))),_.convert(n),void t.push(e)}case _q(a,xH):{const e=new YH;u(e);const i=h?Ja.CUBIC:Ja.CONSTANT;return e.channel.curve.assignSorted(c,a.map((t=>({value:t.dataPoint,leftTangent:t.inTangent,rightTangent:t.outTangent,interpolationMode:i})))),void t.push(e)}case _q(a,fH):case _q(a,gH):case _q(a,vH):{const e=l instanceof fH?2:l instanceof gH?3:4,i=new ej;u(i),i.componentsCount=e;const[n,s,r,o]=i.channels(),_=h?Ja.LINEAR:Ja.CONSTANT,d=(t,e,i)=>({value:t,leftTangent:e,rightTangent:i,interpolationMode:_});switch(e){case 4:o.curve.assignSorted(c,a.map((t=>d(t.dataPoint.w,t.inTangent.w,t.outTangent.w))));case 3:r.curve.assignSorted(c,a.map((t=>d(t.dataPoint.z,t.inTangent.z,t.outTangent.z))));default:n.curve.assignSorted(c,a.map((t=>d(t.dataPoint.y,t.inTangent.y,t.outTangent.y)))),s.curve.assignSorted(c,a.map((t=>d(t.dataPoint.x,t.inTangent.x,t.outTangent.x))))}return void t.push(i)}case a.every((t=>t instanceof yH)):I(3935)}const e=new Sj;u(e),e.channel.curve.assignSorted(c,a),t.push(e)})()}return t}_createPropertyCurves(){this._ratioSamplers=this._keys.map((t=>new JW(t.map((t=>t/this._duration))))),this._runtimeCurves=this._curves.map((t=>({curve:new $W(t.data,this._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:this._ratioSamplers[t.data.keys],commonTarget:t.commonTarget})))}}function _q(t,e){return t.every((t=>t instanceof e))}class uq{constructor(t,e){this._easingMethods=void 0;const{easingMethods:i}=t;Array.isArray(i)?0===i.length&&0!==e?this._easingMethods=new Array(e).fill(null):this._easingMethods=i:this._easingMethods=void 0===i?new Array(e).fill(t.easingMethod):Array.from({length:e},((t,e)=>{var n;return null!==(n=i[e])&&void 0!==n?n:null}))}get nil(){return!this._easingMethods||this._easingMethods.every((t=>null==t))}convert(t){const{_easingMethods:e}=this;if(!e)return;const i=t.keyFramesCount;if(t.keyFramesCount<2)return;Array.isArray(e)&&e.length;const n=i-1;for(let i=0;i<n;++i){const n=e[i];n&&(Array.isArray(n)?fq(n,t.getKeyframeTime(i),t.getKeyframeValue(i),t.getKeyframeTime(i+1),t.getKeyframeValue(i+1)):dq(n,t,i))}}convertQuatCurve(t){const{_easingMethods:e}=this;if(!e)return;const i=t.keyFramesCount;if(t.keyFramesCount<2)return;Array.isArray(e)&&e.length;const n=i-1;for(let i=0;i<n;++i){const n=e[i];n&&(Array.isArray(n)?t.getKeyframeValue(i).easingMethod=n.slice():mq(n,t,i))}}}function dq(t,e,i){e.keyFramesCount;const n=e.getKeyframeValue(i),s=pq[t];s===Nu.CONSTANT?n.interpolationMode=Ja.CONSTANT:(n.interpolationMode=Ja.LINEAR,n.easingMethod=s)}function mq(t,e,i){e.keyFramesCount;const n=e.getKeyframeValue(i),s=pq[t];n.easingMethod=s}const pq={constant:Nu.CONSTANT,linear:Nu.LINEAR,quadIn:Nu.QUAD_IN,quadOut:Nu.QUAD_OUT,quadInOut:Nu.QUAD_IN_OUT,quadOutIn:Nu.QUAD_OUT_IN,cubicIn:Nu.CUBIC_IN,cubicOut:Nu.CUBIC_OUT,cubicInOut:Nu.CUBIC_IN_OUT,cubicOutIn:Nu.CUBIC_OUT_IN,quartIn:Nu.QUART_IN,quartOut:Nu.QUART_OUT,quartInOut:Nu.QUART_IN_OUT,quartOutIn:Nu.QUART_OUT_IN,quintIn:Nu.QUINT_IN,quintOut:Nu.QUINT_OUT,quintInOut:Nu.QUINT_IN_OUT,quintOutIn:Nu.QUINT_OUT_IN,sineIn:Nu.SINE_IN,sineOut:Nu.SINE_OUT,sineInOut:Nu.SINE_IN_OUT,sineOutIn:Nu.SINE_OUT_IN,expoIn:Nu.EXPO_IN,expoOut:Nu.EXPO_OUT,expoInOut:Nu.EXPO_IN_OUT,expoOutIn:Nu.EXPO_OUT_IN,circIn:Nu.CIRC_IN,circOut:Nu.CIRC_OUT,circInOut:Nu.CIRC_IN_OUT,circOutIn:Nu.CIRC_OUT_IN,elasticIn:Nu.ELASTIC_IN,elasticOut:Nu.ELASTIC_OUT,elasticInOut:Nu.ELASTIC_IN_OUT,elasticOutIn:Nu.ELASTIC_OUT_IN,backIn:Nu.BACK_IN,backOut:Nu.BACK_OUT,backInOut:Nu.BACK_IN_OUT,backOutIn:Nu.BACK_OUT_IN,bounceIn:Nu.BOUNCE_IN,bounceOut:Nu.BOUNCE_OUT,bounceInOut:Nu.BOUNCE_IN_OUT,bounceOutIn:Nu.BOUNCE_OUT_IN,smooth:Nu.SMOOTH,fade:Nu.FADE};function fq(t,e,i,n,s){const[r,o,a,c]=t,{value:l}=i,{value:h}=s,_=3*(n-e),u=3*(h-l),d=r*_,m=o*u,p=(1-a)*_,f=(1-c)*u,g=1/3,v=m/d,y=Math.sqrt(d*d+m*m)*g,x=f/p,S=Math.sqrt(p*p+f*f)*g;var C;i.interpolationMode=Ja.CUBIC,i.tangentWeightMode=(C=i.tangentWeightMode)===Za.NONE?Za.RIGHT:C===Za.LEFT?Za.BOTH:C,i.rightTangent=v,i.rightTangentWeight=y,s.tangentWeightMode=function(t){return t===Za.NONE?Za.LEFT:t===Za.RIGHT?Za.BOTH:t}(s.tangentWeightMode),s.leftTangent=x,s.leftTangentWeight=S}var gq,vq,yq,xq,Sq,Cq,Aq,bq,Tq,Eq,Pq,wq,Iq,Rq,Dq,Mq,Oq,Bq,Nq,Lq,Fq,zq,Vq,Gq;function Uq(){throw new Error("split() only valid in Editor.")}dc("cc.animation.ExoticAnimation")((vq=sc((gq=class{constructor(){nc(this,"_nodeAnimations",vq,this)}createEvaluator(t){return new Kq(this._nodeAnimations,t)}addNodeAnimation(t){const e=new kq(t);return this._nodeAnimations.push(e),e}collectAnimatedJoints(){return Array.from(new Set(this._nodeAnimations.map((({path:t})=>t))))}split(t,e){return Uq()}toHashString(){return this._nodeAnimations.map((t=>t.toHashString())).join("\n")}}).prototype,"_nodeAnimations",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gq));let kq=dc("cc.animation.ExoticNodeAnimation")((Sq=sc((xq=class{constructor(t){nc(this,"_path",Sq,this),nc(this,"_position",Cq,this),nc(this,"_rotation",Aq,this),nc(this,"_scale",bq,this),this._path=t}createPosition(t,e){this._position=new Yq(t,new qq(e))}createRotation(t,e){this._rotation=new Yq(t,new Xq(e))}createScale(t,e){this._scale=new Yq(t,new qq(e))}createEvaluator(t){return new Jq(this._path,this._position,this._rotation,this._scale,t)}split(t,e,i){return Uq()}get path(){return this._path}toHashString(){var t,e,i,n,s,r;return`${this._path}\n${null!==(t=null===(e=this._position)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:""}${null!==(i=null===(n=this._scale)||void 0===n?void 0:n.toHashString())&&void 0!==i?i:""}${null!==(s=null===(r=this._rotation)||void 0===r?void 0:r.toHashString())&&void 0!==s?s:""}`}}).prototype,"_path",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Cq=sc(xq.prototype,"_position",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Aq=sc(xq.prototype,"_rotation",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bq=sc(xq.prototype,"_scale",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yq=xq))||yq;function Hq(t){return t.toPrecision(2)}function jq(t){return t.map(Hq).join(" ")}let Wq=dc("cc.animation.ExoticVectorLikeTrackValues")((Pq=sc((Eq=class{constructor(t){nc(this,"_values",Pq,this),nc(this,"_isQuantized",wq,this),this._values=t,this._isQuantized=!1}get precision(){return this._isQuantized?this._values.originalPrecision:tX(this._values)}quantize(t){this._isQuantized,this._values=function(t,e){const i=Zq[e],n=1<<i.BYTES_PER_ELEMENT;let s=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;t.forEach((t=>{s=Math.min(t,s),r=Math.max(t,r)}));const o=r-s,a=i.from(t,(t=>(t-s)/o*n));return new eX(tX(t),a,o,s)}(this._values,t),this._isQuantized=!0}toHashString(){const{_isQuantized:t,_values:e}=this;return`${t} ${t?e.toHashString():jq(e)}`}}).prototype,"_values",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),wq=sc(Eq.prototype,"_isQuantized",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Tq=Eq))||Tq,qq=dc("cc.animation.ExoticVec3TrackValues")(Iq=class t extends Wq{static imitate(e,i){const n=new t(e);return i._isQuantized&&n.quantize(i._values.quantizationType),n}get(t,e){const{_values:i,_isQuantized:n}=this;n?sX(i,t,e):mi.fromArray(e,i,3*t)}lerp(t,e,i,n,s,r){const{_values:o,_isQuantized:a}=this;a?(sX(o,t,n),sX(o,e,s)):(mi.fromArray(n,o,3*t),mi.fromArray(s,o,3*e)),mi.lerp(r,n,s,i)}})||Iq,Xq=dc("cc.animation.ExoticQuatTrackValues")(Rq=class t extends Wq{static imitate(e,i){const n=new t(e);return i._isQuantized&&n.quantize(i._values.quantizationType),n}get(t,e){const{_values:i,_isQuantized:n}=this;n?rX(i,t,e):Si.fromArray(e,i,4*t)}lerp(t,e,i,n,s,r){const{_values:o,_isQuantized:a}=this;a?(rX(o,t,n),rX(o,e,s)):(Si.fromArray(n,o,4*t),Si.fromArray(s,o,4*e)),Si.slerp(r,n,s,i)}})||Rq,Yq=dc("cc.animation.ExoticTrack")((Oq=sc((Mq=class{constructor(t,e){nc(this,"times",Oq,this),nc(this,"values",Bq,this),this.times=t,this.values=e}toHashString(){const{times:t,values:e}=this;return`times: ${jq(t)}; values: ${e.toHashString()}`}}).prototype,"times",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Bq=sc(Mq.prototype,"values",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Dq=Mq))||Dq;class Kq{constructor(t,e){this._nodeEvaluations=void 0,this._nodeEvaluations=t.map((t=>t.createEvaluator(e)))}evaluate(t){this._nodeEvaluations.forEach((e=>{e.evaluate(t)}))}}class Jq{constructor(t,e,i,n,s){this._position=null,this._rotation=null,this._scale=null,e&&(this._position=nX(e.times,e.values,mi,t,"position",s)),i&&(this._rotation=nX(i.times,i.values,Si,t,"rotation",s)),n&&(this._scale=nX(n.times,n.values,mi,t,"scale",s))}evaluate(t){if(this._position){const e=this._position.evaluator.evaluate(t);this._position.runtimeBinding.setValue(e)}if(this._rotation){const e=this._rotation.evaluator.evaluate(t);this._rotation.runtimeBinding.setValue(e)}if(this._scale){const e=this._scale.evaluator.evaluate(t);this._scale.runtimeBinding.setValue(e)}}}class $q{constructor(t,e,i){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=t,this._values=e,this._prevValue=new i,this._nextValue=new i,this._resultValue=new i}evaluate(t){const{_times:e,_values:i,_resultValue:n}=this;if(0===e.length)return n;const s=function(t,e,i){const n=t.length,s=t[0],r=t[n-1];if(e<s)i.just=!0,i.index=0;else if(e>r)i.just=!0,i.index=n-1;else{const n=tc(t,e);if(n>=0)i.just=!0,i.index=n;else{const s=~n,r=s-1,o=t[r],a=t[s],c=(e-t[r])/(a-o);i.just=!1,i.index=r,i.nextIndex=s,i.ratio=c}}return i}(e,t,this._inputSampleResultCache);return s.just?i.get(s.index,n):i.lerp(s.index,s.nextIndex,s.ratio,this._prevValue,this._nextValue,n),n}}const Zq={uint8:Uint8Array,uint16:Uint16Array};var Qq;function tX(t){switch(t.BYTES_PER_ELEMENT){default:case 4:return Qq.FLOAT_32;case 8:return Qq.FLOAT_64}}!function(t){t[t.FLOAT_32=0]="FLOAT_32",t[t.FLOAT_64=1]="FLOAT_64"}(Qq||(Qq={}));let eX=dc("cc.animation.QuantizedFloatArray")((Fq=sc((Lq=class{get quantizationType(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}constructor(t,e,i,n=0){nc(this,"originalPrecision",Fq,this),nc(this,"min",zq,this),nc(this,"extent",Vq,this),nc(this,"values",Gq,this),this.originalPrecision=t,this.values=e,this.extent=i,this.min=n}toHashString(){const{originalPrecision:t,min:e,extent:i,values:n}=this;return`${t} ${Hq(e)} ${Hq(i)} ${n.join(" ")}`}}).prototype,"originalPrecision",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),zq=sc(Lq.prototype,"min",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Vq=sc(Lq.prototype,"extent",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Gq=sc(Lq.prototype,"values",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Nq=Lq))||Nq;function iX(t,e){return t.values[e]/(1<<t.values.BYTES_PER_ELEMENT)*t.extent+t.min}function nX(t,e,i,n,s,r){const o=new kH;o.path=(new UH).toHierarchy(n).toProperty(s);const a=r(o);return a?{runtimeBinding:a,evaluator:new $q(t,e,i)}:null}function sX(t,e,i){mi.set(i,iX(t,3*e+0),iX(t,3*e+1),iX(t,3*e+2))}function rX(t,e,i){Si.set(i,iX(t,4*e+0),iX(t,4*e+1),iX(t,4*e+2),iX(t,4*e+3))}function oX(){return l.director.getAnimationManager()}var aX,cX,lX,hX,_X,uX,dX,mX,pX,fX,gX,vX,yX;const xX=Symbol("SearchForRootBonePath"),SX=Symbol("ExoticAnimation");let CX=t("AnimationClip",dc("cc.AnimationClip")((yX=vX=class t extends fh{constructor(...t){super(...t),nc(this,"sample",lX,this),nc(this,"speed",hX,this),nc(this,"wrapMode",_X,this),nc(this,"enableTrsBlending",uX,this),nc(this,"_duration",dX,this),nc(this,"_hash",mX,this),this.frameRate=0,nc(this,"_tracks",pX,this),nc(this,"_exoticAnimation",fX,this),this._legacyData=void 0,this._legacyDataDirty=!1,nc(this,"_events",gX,this),this._runtimeEvents={ratios:[],eventGroups:[]}}static createWithSpriteFrames(e,i){const n=new t;n.sample=i||n.sample,n.duration=e.length/n.sample;const s=1/n.sample,r=new Sj;return r.path=(new UH).toComponent("cc.Sprite").toProperty("spriteFrame"),r.channels()[0].curve.assignSorted(e.map(((t,e)=>[s*e,t]))),n.addTrack(r),n}get duration(){return this._duration}set duration(t){this._duration=t}get tracksCount(){return this._tracks.length}get tracks(){return this._tracks}get hash(){var t,e;if(this._hash)return this._hash;const i=`Exotic:${null!==(t=null===(e=this._exoticAnimation)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:""}`;return this._hash=ur(i,666)}get events(){return this._events}set events(t){this._events=t;const e=[],i=[],n=this.events.sort(((t,e)=>t.frame-e.frame)),s=n.length;for(let t=0;t<s;++t){const s=n[t],r=s.frame/this._duration;let o=e.findIndex((t=>t===r));o<0&&(o=e.length,e.push(r),i.push({events:[]})),i[o].events.push({functionName:s.func,parameters:s.params})}this._runtimeEvents={ratios:e,eventGroups:i}}get[SX](){return this._exoticAnimation}set[SX](t){this._exoticAnimation=t}onLoaded(){this.frameRate=this.sample,this.events=this._events}range(){const t={min:1/0,max:-1/0},{_tracks:e}=this,i=e.length;for(let n=0;n<i;++n){const i=e[n].range();t.min=Math.min(t.min,i.min),t.max=Math.max(t.max,i.max)}return t}getTrack(t){return this._tracks[t]}addTrack(t){const e=this._tracks.length;return this._tracks.push(t),e}removeTrack(t){this._tracks.splice(t,1)}clearTracks(){this._tracks.length=0}createEventEvaluator(t){return new RX(t,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)}createEvaluator(t){const{target:e}=t;return this._createEvalWithBinder(e,(i=>{if(t.mask&&i.isMaskedOff(t.mask))return;const n=i.createRuntimeBinding(e,this.enableTrsBlending?t.pose:void 0,!1);return null!=n?n:void 0}),t.rootMotion)}destroy(){var t;return(null===(t=l.director.root)||void 0===t?void 0:t.dataPoolManager)&&l.director.root.dataPoolManager.releaseAnimationClip(this),KW.destroy(this),super.destroy()}[YW](t,e,i){const n=1/e,s=this._collectAnimatedJoints(),r=s.length,o={};for(let t=0;t<r;++t)o[s[t]]={transforms:Array.from({length:i},(()=>new Ii))};const a=s.reduce(((t,e)=>(t[e]=new TX,t)),{});for(const t in a){const e=a[t],i=t.lastIndexOf("/");if(i>=0){const n=t.substring(0,i),s=a[n];s&&(e.parent=s)}}const c=this._createEvalWithBinder(void 0,(t=>{const e=t.parseTrsPath();if(!e)return;const i=a[e.node];return i?IX(i,e.property):void 0}),void 0);for(let e=0;e<i;++e){const i=t+n*e;c.evaluate(i);for(let t=0;t<r;++t){const i=s[t];Ii.copy(o[i].transforms[e],a[i].globalTransform)}for(let t=0;t<r;++t){const e=s[t];a[e].invalidate()}}return{samples:e,frames:i,joints:o}}upgradeUntypedTracks(t){const e=[],i=[],{_tracks:n}=this,s=n.length;for(let r=0;r<s;++r){const s=n[r];if(!(s instanceof lq))continue;const o=s.upgrade(t);o&&(e.push(o),i.push(s))}const r=i.length;for(let t=0;t<r;++t)Gt.remove(n,i[t]);n.push(...e)}[xX](){return this._searchForRootBonePath()}get keys(){return this._getLegacyData().keys}set keys(t){this._legacyDataDirty=!0,this._getLegacyData().keys=t}get curves(){return this._legacyDataDirty=!0,this._getLegacyData().curves}set curves(t){this._getLegacyData().curves=t}get commonTargets(){return this._getLegacyData().commonTargets}set commonTargets(t){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=t}get data(){return this._getLegacyData().data}getPropertyCurves(){return this._getLegacyData().getPropertyCurves()}get eventGroups(){return this._runtimeEvents.eventGroups}updateEventDatas(){this.events=this._events}hasEvents(){return 0!==this.events.length}syncLegacyData(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)}_createEvalWithBinder(t,e,i){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());const n=[];let s;i&&(s=this._createRootMotionEvaluation(t,i,n));const r=[];let o;const{_tracks:a}=this,c=a.length;for(let t=0;t<c;++t){const i=a[t];if(n.includes(i))continue;if(Array.from(i.channels()).every((({curve:t})=>0===t.keyFramesCount)))continue;const s=e(i[GH]);if(!s)continue;const o=i[SH](s);r.push({binding:s,trackEval:o})}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(e)),new AX(r,o,s)}_createRootMotionEvaluation(t,e,i){if(!(t instanceof iS))return void D(3920);const n=this._searchForRootBonePath();if(!n)return void I(3923);const s=t.getChildByPath(n);if(!s)return void I(3924);const r=new bX,o=[],{_tracks:a}=this,c=a.length;for(let t=0;t<c;++t){const e=a[t],{[GH]:s}=e,c=s.parseTrsPath();if(!c)continue;if(c.node!==n)continue;i.push(e);const l=IX(r,c.property);if(!l)continue;const h=e[SH](l);o.push({binding:l,trackEval:h})}return new PX(s,this._duration,r,o)}_searchForRootBonePath(){const t=this._tracks.map((t=>{const e=t[GH].parseTrsPath();if(e){const t=e.node;return{path:t,rank:t.split("/").length}}return{path:"",rank:0}}));t.sort(((t,e)=>t.rank-e.rank));const e=t.findIndex((t=>0!==t.rank));if(e<0)return"";const i=t.length,n=t[e];let s=!0;for(let r=e+1;r<i;++r){const e=t[r];if(e.rank!==n.rank)break;if(e.path!==n.path){s=!1;break}}return s?n.path:""}_getLegacyData(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData}_toLegacy(){const t=new hq(this._duration);return t.keys=[],t.curves=[],t.commonTargets=[],t}_fromLegacy(t){const e=t.toTracks(),i=e.length;for(let t=0;t<i;++t)this.addTrack(e[t])}_collectAnimatedJoints(){const t=new Set,{_tracks:e}=this,i=e.length;for(let n=0;n<i;++n){const i=e[n][GH].parseTrsPath();i&&t.add(i.node)}if(this._exoticAnimation){const e=this._exoticAnimation.collectAnimatedJoints(),i=e.length;for(let n=0;n<i;++n)t.add(e[n])}return Array.from(t)}},vX.WrapMode=Ya,lX=sc((cX=yX).prototype,"sample",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),hX=sc(cX.prototype,"speed",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_X=sc(cX.prototype,"wrapMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ya.Normal}}),uX=sc(cX.prototype,"enableTrsBlending",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dX=sc(cX.prototype,"_duration",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mX=sc(cX.prototype,"_hash",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pX=sc(cX.prototype,"_tracks",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fX=sc(cX.prototype,"_exoticAnimation",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gX=sc(cX.prototype,"_events",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aX=cX))||aX);l.AnimationClip=CX;class AX{constructor(t,e,i){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=t,this._exoticAnimationEvaluator=e,this._rootMotionEvaluation=i}evaluate(t){const{_trackEvalStatues:e,_exoticAnimationEvaluator:i}=this,n=e.length;for(let i=0;i<n;++i){const{trackEval:n,binding:s}=e[i],r=n.evaluate(t,s);s.setValue(r)}i&&i.evaluate(t)}evaluateRootMotion(t,e){const{_rootMotionEvaluation:i}=this;i&&i.evaluate(t,e)}}class bX{constructor(){this.position=new mi,this.scale=new mi(1,1,1),this.rotation=new Si,this.eulerAngles=new mi}getTransform(t){Ii.fromRTS(t,this.rotation,this.position,this.scale)}}class TX extends bX{constructor(...t){super(...t),this.parent=null,this._dirty=!0,this._transform=new Ii}get globalTransform(){const t=this._transform;return this._dirty&&(this._dirty=!1,Ii.fromRTS(t,this.rotation,this.position,this.scale),this.parent&&Ii.multiply(t,this.parent.globalTransform,t)),this._transform}invalidate(){this._dirty=!0}}const EX=new Ii;class PX{constructor(t,e,i,n){this._initialTransformCache=new Ii,this._clipEndTransformCache=new Ii,this._startTransformCache=new Ii,this._endTransformCache=new Ii,this._motionTransformCache=new Ii,this._translationMotionCache=new mi,this._rotationMotionCache=new Si,this._scaleMotionCache=new mi,this._rootBone=t,this._duration=e,this._boneTransform=i,this._trackEvalStatuses=n}evaluate(t,e){const i=this._calcMotionTransform(t,e,this._motionTransformCache),{_translationMotionCache:n,_rotationMotionCache:s,_scaleMotionCache:r,_rootBone:o}=this;Ii.toRTS(i,s,n,r),mi.add(n,n,o.position),o.setPosition(n),Si.multiply(s,s,o.rotation),o.setRotation(s),mi.multiply(r,r,o.scale),o.setScale(r)}_calcMotionTransform(t,e,i){const{_duration:n}=this,s=n-t,r=this._evaluateAt(t,this._startTransformCache);if(e<s){const n=this._evaluateAt(t+e,this._endTransformCache);wX(i,r,n)}else{Ii.identity(i);const t=(t,e)=>{wX(EX,t,e),Ii.multiply(i,i,EX)},o=e-s,a=Math.floor(o/n),c=o-a*n,l=this._evaluateAt(0,this._initialTransformCache),h=this._evaluateAt(n,this._clipEndTransformCache),_=this._evaluateAt(c,this._endTransformCache);t(r,h),wX(EX,l,h);for(let t=0;t<a;++t)Ii.multiply(i,i,EX);t(l,_)}return i}_evaluateAt(t,e){const{_trackEvalStatuses:i}=this,n=i.length;for(let e=0;e<n;++e){const{trackEval:n,binding:s}=i[e],r=n.evaluate(t,s);s.setValue(r)}return this._boneTransform.getTransform(e),e}}function wX(t,e,i){Ii.invert(t,e),Ii.multiply(t,i,t)}function IX(t,e){switch(e){default:return;case"position":return{setValue(e){mi.copy(t.position,e)}};case"rotation":return{setValue(e){Si.copy(t.rotation,e)}};case"scale":return{setValue(e){mi.copy(t.scale,e)}};case"eulerAngles":return{setValue(e){mi.copy(t.eulerAngles,e)}}}}class RX{constructor(t,e,i,n){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=t,this._ratios=e,this._eventGroups=i,this._wrapMode=n}setWrapMode(t){this._wrapMode=t}ignore(t,e){this._ignoreIndex=-1,this._sampled=!1;let i=MX(t,this._ratios);i<0&&(i=~i-1,e<0&&(i+=1),this._ignoreIndex=i)}sample(t,e,i){const n=this._eventGroups.length;let s=MX(t,this._ratios);if(s<0&&(s=~s-1,e<0&&(s+=1)),this._ignoreIndex!==s&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(s,!1),this._lastFrameIndex=s,this._lastIterations=i,void(this._lastDirection=e);const r=this._wrapMode,o=DX(i);let a=DX(this._lastIterations),c=this._lastFrameIndex;const l=this._lastDirection,h=-1!==a&&o!==a;if(c===s&&h&&1===n)this._doFire(0,!1);else if(c!==s||h){e=l;do{if(c!==s){if(-1===e&&0===c&&s>0?((r&Xa.PingPong)===Xa.PingPong?e*=-1:c=n,a++):1===e&&c===n-1&&s<n-1&&((r&Xa.PingPong)===Xa.PingPong?e*=-1:c=-1,a++),c===s)break;if(a>o)break}c+=e,this._doFire(c,!0)}while(c!==s&&c>-1&&c<n)}this._lastFrameIndex=s,this._lastIterations=i,this._lastDirection=e}_doFire(t,e){e?oX().pushDelayEvent(this._checkAndFire,this,[t]):this._checkAndFire(t)}_checkAndFire(t){if(!this._targetNode||!this._targetNode.isValid)return;const{_eventGroups:e}=this;if(t<0||t>=e.length||this._ignoreIndex===t)return;const i=e[t],n=this._targetNode.components,s=i.events.length;for(let t=0;t<s;++t){const e=i.events[t],{functionName:s}=e,r=n.length;for(let t=0;t<r;++t){const i=n[t],r=i[s];"function"==typeof r&&r.apply(i,e.parameters)}}}}function DX(t){return t-(0|t)==0&&(t-=1),0|t}function MX(t,e){return tc(e,t)}class OX{constructor(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get isMotionless(){return!this.isPlaying||this.isPaused}play(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(N(3912)):(this._isPlaying=!0,this.onPlay())}stop(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}pause(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}resume(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}step(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}update(t){}onPlay(){}onPause(){}onResume(){}onStop(){}onError(t){}}class BX{constructor(t){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=t}destroy(){for(let t=0;t<this._blendStateWriters.length;++t)this._pose.destroyWriter(this._blendStateWriters[t]);this._blendStateWriters.length=0}createPoseWriter(t,e,i){const n=this._pose.createWriter(t,e,this,i);return this._blendStateWriters.push(n),n}}let NX;!function(t){t.PLAY="play",t.STOP="stop",t.PAUSE="pause",t.RESUME="resume",t.LASTFRAME="lastframe",t.FINISHED="finished"}(NX||(NX={})),Xt(NX);class LX extends OX{get clip(){return this._clip}get name(){return this._name}get length(){return this.duration}get wrapMode(){return this._wrapMode}set wrapMode(t){var e;this._wrapMode=t,this.time=0,t&Xa.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(e=this._clipEventEval)||void 0===e||e.setWrapMode(t)}get repeatCount(){return this._repeatCount}set repeatCount(t){this._repeatCount=t;const e=this._wrapMode&Xa.ShouldWrap,i=(this.wrapMode&Xa.Reverse)===Xa.Reverse;this._useSimpleProcess=t===1/0&&!e&&!i}get delay(){return this._delay}set delay(t){this._delayTime=this._delay=t}get playbackRange(){return this._playbackRange}set playbackRange(t){t.max,t.min,this._playbackRange.min=Math.max(t.min,0),this._playbackRange.max=Math.min(t.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}get current(){return this.getWrappedInfo(this.time).time}get ratio(){return this.current/this.duration}get weight(){return this._weight}set weight(t){this._weight=t,this._poseOutput&&(this._poseOutput.weight=t)}constructor(t,e=""){super(),this.duration=1,this.speed=1,this.time=0,this.frameRate=0,this._targetNode=null,this._curveLoaded=!1,this._clip=void 0,this._useSimpleProcess=!1,this._target=null,this._wrapMode=Ya.Normal,this._repeatCount=1,this._delay=0,this._delayTime=0,this._currentFramePlayed=!1,this._name=void 0,this._lastIterations=NaN,this._lastWrapInfo=null,this._wrappedInfo=new Qa,this._allowLastFrame=!1,this._blendStateWriterHost={weight:0},this._playbackDuration=0,this._invDuration=1,this._poseOutput=null,this._weight=1,this._clipEval=void 0,this._clipEventEval=void 0,this._doNotCreateEval=!1,this._clip=t,this._name=e||t&&t.name,this._playbackRange={min:0,max:t.duration},this._playbackDuration=t.duration,t.duration||C(`Clip ${t.name} has zero duration.`)}get curveLoaded(){return this._curveLoaded}initialize(t,e,i){if(this._curveLoaded)return;this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=t;const n=this._clip;if(this.duration=n.duration,this._invDuration=1/this.duration,this.speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,this._playbackRange.min=0,this._playbackRange.max=n.duration,this._playbackDuration=n.duration,(this.wrapMode&Xa.Loop)===Xa.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var s,r,o;const a=null!==(s=null!=e?e:null===(r=oX())||void 0===r?void 0:r.blendState)&&void 0!==s?s:null;a&&(this._poseOutput=new BX(a)),this._clipEval=n.createEvaluator({target:t,pose:null!==(o=this._poseOutput)&&void 0!==o?o:void 0,mask:i})}this._clipEventEval=n.createEventEvaluator(this._targetNode)}destroy(){this.isMotionless||oX().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0}emit(...t){oX().pushDelayEvent(this._emit,this,t)}on(t,e,i){return this._target&&this._target.isValid?this._target.on(t,e,i):null}once(t,e,i){return this._target&&this._target.isValid?this._target.once(t,e,i):null}off(t,e,i){this._target&&this._target.isValid&&this._target.off(t,e,i)}allowLastFrameEvent(t){this._allowLastFrame=t}_setEventTarget(t){this._target=t}setTime(t){this._currentFramePlayed=!1,this.time=t||0;{var e;const i=this.getWrappedInfo(t,this._wrappedInfo);null===(e=this._clipEventEval)||void 0===e||e.ignore(i.ratio,i.direction)}}update(t){this._delayTime>0&&(this._delayTime-=t,this._delayTime>0)||(this._currentFramePlayed?this.time+=t*this.speed:this._currentFramePlayed=!0,this._process())}sample(){const t=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(t.time),this._sampleEvents(t),t}onPlay(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(NX.PLAY,this)}onStop(){this.isPaused||this._onPauseOrStop(),this.emit(NX.STOP,this)}onResume(){this._onReplayOrResume(),this.emit(NX.RESUME,this)}onPause(){this._onPauseOrStop(),this.emit(NX.PAUSE,this)}_sampleCurves(t){const{_poseOutput:e,_clipEval:i}=this;e&&(e.weight=this.weight),i&&i.evaluate(t)}_process(){this._useSimpleProcess?this.simpleProcess():this.process()}process(){const t=this.sample();if(this._allowLastFrame){let e;e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new Qa(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(NX.LASTFRAME,this),e.set(t)}t.stopped&&(this.stop(),this.emit(NX.FINISHED,this))}simpleProcess(){const t=this._playbackRange.min,e=this._playbackDuration;let i=this.time%e;i<0&&(i+=e);const n=(t+i)*this._invDuration;this._sampleCurves(t+i),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=n),(this.time>0&&this._lastIterations>n||this.time<0&&this._lastIterations<n)&&this.emit(NX.LASTFRAME,this),this._lastIterations=n)}_needReverse(t){const e=this.wrapMode;let i=!1;return(e&Xa.PingPong)===Xa.PingPong&&(t-(0|t)==0&&t>0&&(t-=1),1&t&&(i=!i)),(e&Xa.Reverse)===Xa.Reverse&&(i=!i),i}getWrappedInfo(t,e){e=e||new Qa;const i=this._getPlaybackStart(),n=this._getPlaybackEnd()-i;let s=!1;const r=this.repeatCount;let o=(t-=i)>0?t/n:-t/n;if(o>=r){o=r,s=!0;let e=r-(0|r);0===e&&(e=1),t=e*n*(t>0?1:-1)}if(t>n){const e=t%n;t=0===e?n:e}else t<0&&0!=(t%=n)&&(t+=n);let a=!1;const c=this._wrapMode&Xa.ShouldWrap;c&&(a=this._needReverse(o));let l=a?-1:1;return this.speed<0&&(l*=-1),c&&a&&(t=n-t),e.time=i+t,e.ratio=e.time/this.duration,e.direction=l,e.stopped=s,e.iterations=o,e}_getPlaybackStart(){return this._playbackRange.min}_getPlaybackEnd(){return this._playbackRange.max}_sampleEvents(t){var e;null===(e=this._clipEventEval)||void 0===e||e.sample(t.ratio,t.direction,t.iterations)}_emit(t,e){this._target&&this._target.isValid&&this._target.emit(t,t,e)}_onReplayOrResume(){oX().addAnimation(this)}_onPauseOrStop(){oX().removeAnimation(this)}}t("AnimationState",LX),l.AnimationState=LX;const FX=VX,zX=VX;function VX(){}var GX,UX,kX,HX,jX,WX,qX,XX,YX,KX,JX,$X;GX=dc("cc.animation.ClipMotion"),UX=Kc(CX),GX((HX=sc((kX=class t extends Zc{constructor(...t){super(...t),nc(this,"clip",HX,this)}[Rj](t){return this.clip?new ZX(t,this.clip):null}clone(){const e=new t;return e.clip=this.clip,e}}).prototype,"clip",[UX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kX));class ZX{constructor(t,e){this.duration=e.duration/e.speed,this._state=new LX(e),this._state.initialize(t.node,t.blendBuffer,t.mask)}getClipStatuses(t){let e=!1;return{next:()=>e?{done:!0,value:void 0}:(e=!0,{done:!1,value:{__DEBUG_ID__:this.__DEBUG__ID__,clip:this._state.clip,weight:t}})}}get progress(){return this._state.time/this.duration}sample(t,e){if(0===e)return;const i=this._state.duration*t;this._state.time=i,this._state.weight=e,this._state.sample(),this._state.weight=0}}let QX=dc("cc.animation.BindableNumber")((qX=sc((WX=class t{constructor(t=0){nc(this,"variable",qX,this),nc(this,"value",XX,this),this.value=t}clone(){const e=new t;return e.value=this.value,e.variable=this.variable,e}}).prototype,"variable",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),XX=sc(WX.prototype,"value",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jX=WX))||jX,tY=dc("cc.animation.BindableBoolean")((JX=sc((KX=class t{constructor(t=!1){nc(this,"variable",JX,this),nc(this,"value",$X,this),this.value=t}clone(){const e=new t;return e.value=this.value,e.variable=this.variable,e}}).prototype,"variable",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$X=sc(KX.prototype,"value",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),YX=KX))||YX;function eY(t,e,i,n,s,...r){const{variable:o,value:a}=e;if(!o)return a;const c=t.getVar(o);if(!nY(c,o))return a;if(c.type!==i)throw new Ij(o,"number");return c.bind(n,s,...r)}function iY(t,e,i,n,s,...r){const{variable:o,value:a}=e;if(!o)return a;const c=t.getVar(o);if(!nY(c,o))return a;if(i!==bj.FLOAT&&i!==bj.INTEGER)throw new Ij(o,"number or integer");return c.bind(n,s,...r)}function nY(t,e){if(t)return!0;throw new wj(e)}var sY,rY,oY,aY,cY,lY;let hY=dc("cc.animation.AnimationBlendItem")((oY=sc((rY=class t{constructor(){nc(this,"motion",oY,this)}clone(){const e=new t;return this._assign(e),e}_assign(t){var e,i;return t.motion=null!==(e=null===(i=this.motion)||void 0===i?void 0:i.clone())&&void 0!==e?e:null,t}}).prototype,"motion",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sY=rY))||sY,_Y=dc("cc.animation.AnimationBlend")((lY=sc((cY=class extends Zc{constructor(...t){super(...t),nc(this,"name",lY,this)}}).prototype,"name",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),aY=cY))||aY;class uY{constructor(t,e,i,n){this._childEvaluators=i.map((e=>{var i,n;return null!==(i=null===(n=e.motion)||void 0===n?void 0:n[Rj](t))&&void 0!==i?i:null})),this._weights=new Array(this._childEvaluators.length).fill(0),this._inputs=[...n]}get childCount(){return this._weights.length}getChildWeight(t){return this._weights[t]}getChildMotionEval(t){return this._childEvaluators[t]}get duration(){let t=0;for(let n=0;n<this._childEvaluators.length;++n){var e,i;t+=(null!==(e=null===(i=this._childEvaluators[n])||void 0===i?void 0:i.duration)&&void 0!==e?e:0)*this._weights[n]}return t}getClipStatuses(t){const{_childEvaluators:e,_weights:i}=this,n=e.length;let s,r=0;return{next(){for(;;){if(s){const t=s.next();if(!t.done)return t}if(r>=n)return{done:!0,value:void 0};{const n=e[r];s=null==n?void 0:n.getClipStatuses(t*i[r]),++r}}}}}sample(t,e){for(let n=0;n<this._childEvaluators.length;++n){var i;null===(i=this._childEvaluators[n])||void 0===i||i.sample(t,e*this._weights[n])}}setInput(t,e){this._inputs[e]=t,this.doEval()}doEval(){this.eval(this._weights,this._inputs)}eval(t,e){}}var dY,mY,pY,fY,gY,vY,yY,xY;let SY=dc("cc.animation.AnimationBlend1DItem")((pY=sc((mY=class t extends hY{constructor(...t){super(...t),nc(this,"threshold",pY,this)}clone(){const e=new t;return this._assign(e),e}_assign(t){return super._assign(t),t.threshold=this.threshold,t}}).prototype,"threshold",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dY=mY))||dY;dc("cc.animation.AnimationBlend1D")((xY=yY=class t extends _Y{constructor(...t){super(...t),nc(this,"_items",gY,this),nc(this,"param",vY,this)}get items(){return this._items}set items(t){this._items=Array.from(t).sort((({threshold:t},{threshold:e})=>t-e))}clone(){const e=new t;return e._items=this._items.map((t=>t.clone())),e.param=this.param.clone(),e}[Rj](t){const e=new CY(t,this,this._items,this._items.map((({threshold:t})=>t)),0),i=eY(t,this.param,bj.FLOAT,e.setInput,e,0);return e.setInput(i,0),e}},yY.Item=SY,gY=sc((fY=xY).prototype,"_items",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vY=sc(fY.prototype,"param",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new QX}}),fY));class CY extends uY{constructor(t,e,i,n,s){super(t,e,i,[s]),this._thresholds=n,this.doEval()}eval(t,[e]){!function(t,e,i){if(t.fill(0),0===e.length);else if(i<=e[0])t[0]=1;else if(i>=e[e.length-1])t[t.length-1]=1;else{let n=0;for(let t=1;t<e.length;++t)if(e[t]>i){n=t;break}const s=e[n-1],r=e[n],o=r-s;t[n-1]=(r-i)/o,t[n]=(i-s)/o}}(t,this._thresholds,e)}}const AY=(()=>{const t=new Oi,e={wA:0,wB:0};return function(i,n,s){if(i.length,n.length,0===n.length)return;if(1===n.length)return void(i[0]=1);if(Oi.strictEquals(s,Oi.ZERO)){const t=n.findIndex((t=>Oi.strictEquals(t,Oi.ZERO)));return void(t>=0?i[t]=1:i.fill(1/n.length))}let r=-1,o=-1,a=-1,c=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;const{x:h,y:_}=s;for(let e=0;e<n.length;++e){const i=n[e];if(Oi.equals(i,Oi.ZERO)){a=e;continue}const u=Oi.normalize(t,i),d=Oi.dot(u,s);u.x*_-u.y*h>0?d>=l&&(l=d,r=e):d>=c&&(c=d,o=e)}let u=0;if(r<0||o<0)u=1;else{const{wA:t,wB:a}=function(t,e,i,n){const s=Oi.cross(t,e);return s?(n.wA=Oi.cross(i,e)/s,n.wB=Oi.cross(i,t)/-s):(n.wA=0,n.wB=0),n}(n[r],n[o],s,e);let c=0,l=0;const h=t+a;h>1?(c=t/h,l=a/h):h<0?(c=0,l=0,u=1):(c=t,l=a,u=1-h),i[r]=c,i[o]=l}if(u>0)if(a>=0)i[a]=u;else{const t=u/i.length;for(let e=0;e<i.length;++e)i[e]+=t}}})();function bY(t,e,i,n){t.fill(0);const s=new Oi(0,0),r=new Oi(0,0);let o=0;const a=e.length;for(let c=0;c<a;++c){let l=Number.MAX_VALUE,h=!1;for(let t=0;t<a;++t){if(c===t)continue;n(e[c],e[t],i,s,r);const o=1-Oi.dot(s,r)/Oi.lengthSqr(r);if(o<0){h=!0;break}l=Math.min(l,o)}h||(t[c]=l,o+=l)}o>0&&t.forEach(((e,i)=>t[i]=e/o))}const TY=(t,e,i,n,s)=>{Oi.subtract(n,i,t),Oi.subtract(s,e,t)},EY=(()=>{const t=new mi(0,0,0),e=new mi(0,0,0),i=new mi(0,0,0),n=new mi(0,0,0),s=new mi(0,0,0),r=new mi(0,0,0);return(o,a,c,l,h)=>{let _=0,u=0,d=2;mi.set(i,c.x,c.y,0),Oi.equals(o,Oi.ZERO)?(_=Oi.angle(c,a),u=0,d=1):Oi.equals(a,Oi.ZERO)?(_=Oi.angle(c,o),u=_,d=1):(_=Oi.angle(o,a),_<=0?u=0:Oi.equals(c,Oi.ZERO)?u=_:(mi.set(n,o.x,o.y,0),mi.set(s,a.x,a.y,0),mi.set(r,c.x,c.y,0),mi.cross(t,n,s),mi.projectOnPlane(i,r,t),u=mi.angle(n,i),_<.99*Math.PI&&mi.dot(mi.cross(e,n,i),t)<0&&(u=-u)));const m=Oi.len(o),p=Oi.len(a),f=(p+m)/2;Oi.set(h,(p-m)/f,_*d),Oi.set(l,(mi.len(i)-m)/f,u*d)}})();var PY,wY,IY,RY,DY,MY,OY,BY,NY,LY,FY;!function(t){t[t.SIMPLE_DIRECTIONAL=0]="SIMPLE_DIRECTIONAL",t[t.FREEFORM_CARTESIAN=1]="FREEFORM_CARTESIAN",t[t.FREEFORM_DIRECTIONAL=2]="FREEFORM_DIRECTIONAL"}(FY||(FY={})),Xt(FY);let zY=dc("cc.animation.AnimationBlend2DItem")((IY=sc((wY=class t extends hY{constructor(...t){super(...t),nc(this,"threshold",IY,this)}clone(){const e=new t;return this._assign(e),e}_assign(t){return super._assign(t),Oi.copy(t.threshold,this.threshold),t}}).prototype,"threshold",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi}}),PY=wY))||PY;dc("cc.animation.AnimationBlend2D")((LY=NY=class t extends _Y{constructor(...t){super(...t),nc(this,"algorithm",DY,this),nc(this,"_items",MY,this),nc(this,"paramX",OY,this),nc(this,"paramY",BY,this)}get items(){return this._items}set items(t){this._items=Array.from(t)}clone(){const e=new t;return e._items=this._items.map((t=>{var e;return null!==(e=null==t?void 0:t.clone())&&void 0!==e?e:null})),e.paramX=this.paramX.clone(),e.paramY=this.paramY.clone(),e}[Rj](t){const e=new VY(t,this,this._items,this._items.map((({threshold:t})=>t)),this.algorithm,[0,0]),i=eY(t,this.paramX,bj.FLOAT,e.setInput,e,0),n=eY(t,this.paramY,bj.FLOAT,e.setInput,e,1);return e.setInput(i,0),e.setInput(n,1),e}},NY.Algorithm=FY,NY.Item=zY,DY=sc((RY=LY).prototype,"algorithm",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FY.SIMPLE_DIRECTIONAL}}),MY=sc(RY.prototype,"_items",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OY=sc(RY.prototype,"paramX",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new QX}}),BY=sc(RY.prototype,"paramY",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new QX}}),RY));class VY extends uY{constructor(t,e,i,n,s,r){super(t,e,i,r),this._thresholds=void 0,this._algorithm=void 0,this._value=new Oi,this._thresholds=n,this._algorithm=s,this.doEval()}eval(t,[e,i]){switch(Oi.set(this._value,e,i),t.fill(0),this._algorithm){case FY.SIMPLE_DIRECTIONAL:AY(t,this._thresholds,this._value);break;case FY.FREEFORM_CARTESIAN:!function(t,e,i){bY(t,e,i,TY)}(t,this._thresholds,this._value);break;case FY.FREEFORM_DIRECTIONAL:!function(t,e,i){bY(t,e,i,EY)}(t,this._thresholds,this._value)}}}var GY,UY,kY,HY,jY,WY,qY;let XY=dc("cc.animation.AnimationBlendDirectItem")((kY=sc((UY=class t extends hY{constructor(...t){super(...t),nc(this,"weight",kY,this)}clone(){const e=new t;return this._assign(e),e}_assign(t){return super._assign(t),t.weight=this.weight,t}}).prototype,"weight",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GY=UY))||GY;dc("cc.animation.AnimationBlendDirect")((qY=WY=class t extends _Y{constructor(...t){super(...t),nc(this,"_items",jY,this)}get items(){return this._items}set items(t){this._items=Array.from(t)}clone(){const e=new t;return e._items=this._items.map((t=>{var e;return null!==(e=null==t?void 0:t.clone())&&void 0!==e?e:null})),e}[Rj](t){return new YY(t,this,this._items,this._items.map((({weight:t})=>t)))}},WY.Item=XY,jY=sc((HY=qY).prototype,"_items",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HY));class YY extends uY{constructor(...t){super(...t),this.doEval()}eval(t,e){const i=t.length;for(let n=0;n<i;++n)t[n]=e[n]}}var KY,JY,$Y,ZY,QY,tK;dc("cc.animation.AnimationMask")((JY=sc((KY=class extends fh{constructor(...t){super(...t),nc(this,"_jointMasks",JY,this)}get joints(){return this._jointMasks}set joints(t){this.clear();for(const e of t)this.addJoint(e.path,e.enabled)}addJoint(t,e){const i=new eK;i.path=t,i.enabled=e,this._jointMasks.push(i)}removeJoint(t){Z(this._jointMasks,(({path:e})=>e===t))}clear(){this._jointMasks.length=0}filterDisabledNodes(t){const{_jointMasks:e}=this,i=e.length,n=new Set;for(let s=0;s<i;++s){const{path:i,enabled:r}=e[s];if(r)continue;const o=t.getChildByPath(i);o&&n.add(o)}return n}}).prototype,"_jointMasks",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sc(KY.prototype,"joints",[Mc],Object.getOwnPropertyDescriptor(KY.prototype,"joints"),KY.prototype),KY));let eK=dc("cc.JointMask")((QY=sc((ZY=class{constructor(){nc(this,"path",QY,this),nc(this,"enabled",tK,this)}}).prototype,"path",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),tK=sc(ZY.prototype,"enabled",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$Y=ZY))||$Y;var iK,nK,sK,rK,oK,aK,cK,lK,hK,_K,uK,dK,mK,pK,fK,gK;!function(t){t[t.EQUAL_TO=0]="EQUAL_TO",t[t.NOT_EQUAL_TO=1]="NOT_EQUAL_TO",t[t.LESS_THAN=2]="LESS_THAN",t[t.LESS_THAN_OR_EQUAL_TO=3]="LESS_THAN_OR_EQUAL_TO",t[t.GREATER_THAN=4]="GREATER_THAN",t[t.GREATER_THAN_OR_EQUAL_TO=5]="GREATER_THAN_OR_EQUAL_TO"}(fK||(fK={})),dc("cc.animation.BinaryCondition")((aK=oK=class t{constructor(){nc(this,"operator",nK,this),nc(this,"lhs",sK,this),nc(this,"rhs",rK,this)}clone(){const e=new t;return e.operator=this.operator,e.lhs=this.lhs.clone(),e.rhs=this.rhs.clone(),e}[Rj](t){const{operator:e,lhs:i,rhs:n}=this,s=new vK(e,0,0),r=iY(t,i,bj.FLOAT,s.setLhs,s),o=iY(t,n,bj.FLOAT,s.setRhs,s);return s.reset(r,o),s}},oK.Operator=fK,nK=sc((iK=aK).prototype,"operator",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fK.EQUAL_TO}}),sK=sc(iK.prototype,"lhs",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new QX}}),rK=sc(iK.prototype,"rhs",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new QX}}),iK));class vK{constructor(t,e,i){this._operator=t,this._lhs=e,this._rhs=i,this._eval()}reset(t,e){this._lhs=t,this._rhs=e,this._eval()}setLhs(t){this._lhs=t,this._eval()}setRhs(t){this._rhs=t,this._eval()}eval(){return this._result}_eval(){const{_lhs:t,_rhs:e}=this;switch(this._operator){default:case fK.EQUAL_TO:this._result=t===e;break;case fK.NOT_EQUAL_TO:this._result=t!==e;break;case fK.LESS_THAN:this._result=t<e;break;case fK.LESS_THAN_OR_EQUAL_TO:this._result=t<=e;break;case fK.GREATER_THAN:this._result=t>e;break;case fK.GREATER_THAN_OR_EQUAL_TO:this._result=t>=e}}}!function(t){t[t.TRUTHY=0]="TRUTHY",t[t.FALSY=1]="FALSY"}(gK||(gK={})),dc("cc.animation.UnaryCondition")((uK=_K=class t{constructor(){nc(this,"operator",lK,this),nc(this,"operand",hK,this)}clone(){const e=new t;return e.operator=this.operator,e.operand=this.operand.clone(),e}[Rj](t){const{operator:e,operand:i}=this,n=new yK(e,!1),s=eY(t,i,bj.BOOLEAN,n.setOperand,n);return n.reset(s),n}},_K.Operator=gK,lK=sc((cK=uK).prototype,"operator",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gK.TRUTHY}}),hK=sc(cK.prototype,"operand",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tY}}),cK));class yK{constructor(t,e){this._operator=t,this._operand=e,this._eval()}reset(t){this.setOperand(t)}setOperand(t){this._operand=t,this._eval()}eval(){return this._result}_eval(){const{_operand:t}=this;switch(this._operator){default:case gK.TRUTHY:this._result=!!t;break;case gK.FALSY:this._result=!t}}}let xK=dc("cc.animation.TriggerCondition")((pK=sc((mK=class t{constructor(){nc(this,"trigger",pK,this)}clone(){const e=new t;return e.trigger=this.trigger,e}[Rj](t){const e=new SK(!1),i=t.getVar(this.trigger);return nY(i,this.trigger)&&(function(t,e){if(t!==bj.TRIGGER)throw new Ij(e,"trigger")}(i.type,this.trigger),e.setTrigger(i.bind(e.setTrigger,e))),e}}).prototype,"trigger",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dK=mK))||dK;class SK{constructor(t){this._triggered=!1,this._triggered=t}setTrigger(t){this._triggered=t}eval(){return this._triggered}}class CK{constructor(){this._nodeBlendStates=new Map}createWriter(t,e,i,n){const s=this.ref(t,e);return new AK(t,e,s,i,n)}destroyWriter(t){const e=t;this.deRef(e.node,e.property)}ref(t,e){let i=this._nodeBlendStates.get(t);return i||(i=this.createNodeBlendState(),this._nodeBlendStates.set(t,i)),i.refProperty(t,e)}deRef(t,e){const i=this._nodeBlendStates.get(t);i&&(i.deRefProperty(e),i.empty&&this._nodeBlendStates.delete(t))}apply(){this._nodeBlendStates.forEach(((t,e)=>{t.apply(e)}))}}class AK{constructor(t,e,i,n,s){this._node=t,this._property=e,this._propertyBlendState=i,this._host=n,this._constants=s}get node(){return this._node}get property(){return this._property}getValue(){return this._node[this._property]}setValue(t){const{_propertyBlendState:e,_host:i}=this,n=i.weight;e.blend(t,n)}}var bK;!function(t){t[t.POSITION=1]="POSITION",t[t.ROTATION=2]="ROTATION",t[t.SCALE=4]="SCALE",t[t.EULER_ANGLES=8]="EULER_ANGLES"}(bK||(bK={}));const TK=bK.POSITION|bK.ROTATION|bK.SCALE|bK.EULER_ANGLES;class EK{constructor(){this.refCount=0,this.accumulatedWeight=0,this.result=new mi}blend(t,e){this.accumulatedWeight=NK(this.result,this.result,this.accumulatedWeight,t,e)}reset(){this.accumulatedWeight=0,mi.zero(this.result)}}class PK{constructor(){this.refCount=0,this.accumulatedWeight=0,this.result=new Si}blend(t,e){this.accumulatedWeight=LK(this.result,this.result,this.accumulatedWeight,t,e)}reset(){this.accumulatedWeight=0,Si.identity(this.result)}}class wK{constructor(){this._transformApplyFlags=0,this._properties={}}get empty(){const{_properties:t}=this;return!(t.position||t.rotation||t.eulerAngles||t.scale)}refProperty(t,e){var i,n;const{_properties:s}=this;let r;switch(e){default:case"position":case"scale":case"eulerAngles":r=null!==(i=s[e])&&void 0!==i?i:s[e]=this._createVec3BlendState(t[e]);break;case"rotation":r=null!==(n=s[e])&&void 0!==n?n:s[e]=this._createQuatBlendState(t.rotation)}return++r.refCount,r}deRefProperty(t){const{_properties:e}=this,i=e[t];i&&(--i.refCount,i.refCount>0||delete e[t])}apply(t){const{_transformApplyFlags:e,_properties:{position:i,scale:n,rotation:s,eulerAngles:r}}=this;if(!e)return;let o,a,c;i&&e&bK.POSITION&&(o=i.result),n&&e&bK.SCALE&&(a=n.result),r&&e&bK.EULER_ANGLES&&(c=r.result),s&&e&bK.ROTATION&&(c=s.result),(c||o||a)&&t.setRTS(c,o,a),this._transformApplyFlags=0}}class IK extends wK{apply(t){const{_properties:{position:e,scale:i,rotation:n,eulerAngles:s}}=this;e&&e.accumulatedWeight&&(this._transformApplyFlags|=bK.POSITION,e.accumulatedWeight<1&&e.blend(t.position,1-e.accumulatedWeight)),i&&i.accumulatedWeight&&(this._transformApplyFlags|=bK.SCALE,i.accumulatedWeight<1&&i.blend(t.scale,1-i.accumulatedWeight)),s&&s.accumulatedWeight&&(this._transformApplyFlags|=bK.EULER_ANGLES,s.accumulatedWeight<1&&s.blend(t.eulerAngles,1-s.accumulatedWeight)),n&&n.accumulatedWeight&&(this._transformApplyFlags|=bK.ROTATION,n.accumulatedWeight<1&&n.blend(t.rotation,1-n.accumulatedWeight)),super.apply(t),null==e||e.reset(),null==i||i.reset(),null==n||n.reset(),null==s||s.reset()}_createVec3BlendState(t){return new EK}_createQuatBlendState(t){return new PK}}class RK extends CK{createNodeBlendState(){return new IK}}class DK{constructor(t){this.refCount=0,this.result=new mi,this._defaultValue=new mi,this._clipBlendResult=new mi,this._accumulatedWeight=0,mi.copy(this._defaultValue,t),mi.copy(this.result,t)}blend(t,e){this._accumulatedWeight=NK(this._clipBlendResult,this._clipBlendResult,this._accumulatedWeight,t,e)}commitLayerChange(t){const{result:e,_clipBlendResult:i,_accumulatedWeight:n}=this;n<1&&this.blend(this._defaultValue,1-n),mi.lerp(e,e,i,t),mi.zero(this._clipBlendResult),this._accumulatedWeight=0}reset(){mi.copy(this.result,this._defaultValue)}}class MK{constructor(t){this.refCount=0,this.result=new Si,this._defaultValue=new Si,this._clipBlendResult=new Si,this._accumulatedWeight=0,Si.copy(this._defaultValue,t),Si.copy(this.result,t)}blend(t,e){this._accumulatedWeight=LK(this._clipBlendResult,this._clipBlendResult,this._accumulatedWeight,t,e)}commitLayerChange(t){const{result:e,_clipBlendResult:i,_accumulatedWeight:n}=this;n<1&&this.blend(this._defaultValue,1-n),Si.slerp(e,e,i,t),Si.identity(this._clipBlendResult),this._accumulatedWeight=0}reset(){Si.copy(this.result,this._defaultValue)}}class OK extends wK{constructor(...t){super(...t),this._layerMask=-1>>>0}setLayerMask(t){this._layerMask&=~(1<<t)}commitLayerChanges(t,e){if(!(this._layerMask&1<<t))return;const{_properties:{position:i,scale:n,rotation:s,eulerAngles:r}}=this;i&&i.commitLayerChange(e),n&&n.commitLayerChange(e),s&&s.commitLayerChange(e),r&&r.commitLayerChange(e)}apply(t){this._transformApplyFlags=TK,super.apply(t);const{_properties:{position:e,scale:i,rotation:n,eulerAngles:s}}=this;null==e||e.reset(),null==i||i.reset(),null==n||n.reset(),null==s||s.reset()}_createVec3BlendState(t){return new DK(t)}_createQuatBlendState(t){return new MK(t)}}class BK extends CK{setMask(t,e){this._nodeBlendStates.forEach(((i,n)=>{e.has(n)&&i.setLayerMask(t)}))}commitLayerChanges(t,e){this._nodeBlendStates.forEach((i=>{i.commitLayerChanges(t,e)}))}createNodeBlendState(){return new OK}}function NK(t,e,i,n,s){const r=i+s;if(1!==s||i){if(r){const e=s/r;mi.lerp(t,t,n,e)}}else mi.copy(t,n);return r}function LK(t,e,i,n,s){const r=i+s;if(1!==s||i){if(r){const i=s/r;Si.slerp(t,e,n,i)}}else Si.copy(t,n);return r}var FK;let zK=dc("cc.animation.StateMachineComponent")(FK=class{onMotionStateEnter(t,e){}onMotionStateExit(t,e){}onMotionStateUpdate(t,e){}onStateMachineEnter(t){}onStateMachineExit(t){}})||FK;class VK{constructor(t,e,i){this._blendBuffer=new BK,this._currentTransitionCache={duration:0,time:0},this._varInstances={},this._hasAutoTrigger=!1;for(const[e,i]of t.variables){const t=this._varInstances[e]=new Ej(i.type,i.value);if(i.type===bj.TRIGGER){const{resetMode:e}=i;t.resetMode=e,e===Tj.NEXT_FRAME_OR_AFTER_CONSUMED&&(this._hasAutoTrigger=!0)}}const n={controller:i,blendBuffer:this._blendBuffer,node:e,getVar:t=>this._varInstances[t],triggerResetFn:t=>{this.setValue(t,!1)}},s=(this._layerEvaluations=t.layers.map((t=>{var e;return new GK(t,{...n,mask:null!==(e=t.mask)&&void 0!==e?e:void 0})}))).length;for(let e=0;e<s;++e){const i=t.layers[e].mask;if(i){const t=i.filterDisabledNodes(n.node);this._blendBuffer.setMask(e,t)}}}update(t){const{_blendBuffer:e,_layerEvaluations:i}=this,n=i.length;for(let s=0;s<n;++s){const n=i[s];n.update(t),e.commitLayerChanges(s,n.weight*n.passthroughWeight)}if(this._hasAutoTrigger){const{_varInstances:t}=this;for(const e in t){const i=t[e];i.type===bj.TRIGGER&&i.resetMode===Tj.NEXT_FRAME_OR_AFTER_CONSUMED&&(i.value=!1)}}this._blendBuffer.apply()}getVariables(){return Object.entries(this._varInstances)}getCurrentStateStatus(t){return this._layerEvaluations[t].getCurrentStateStatus()}getCurrentClipStatuses(t){return this._layerEvaluations[t].getCurrentClipStatuses()}getCurrentTransition(t){const{_layerEvaluations:e,_currentTransitionCache:i}=this;return e[t].getCurrentTransition(i)?i:null}getNextStateStatus(t){return this._layerEvaluations[t].getNextStateStatus()}getNextClipStatuses(t){return this.getCurrentTransition(t),this._layerEvaluations[t].getNextClipStatuses()}getValue(t){const e=this._varInstances[t];return e?e.value:void 0}setValue(t,e){const i=this._varInstances[t];i&&(i.value=e)}setLayerWeight(t,e){this._layerEvaluations[t].weight=e}}class GK{constructor(t,e){this.passthroughWeight=1,this._nodes=[],this._topLevelEntry=void 0,this._topLevelExit=void 0,this._currentNode=void 0,this._currentTransitionToNode=null,this._currentTransitionPath=[],this._transitionProgress=0,this._fromWeight=0,this._toWeight=0,this._fromUpdated=!1,this._toUpdated=!1,this.name=t.name,this._controller=e.controller,this.weight=t.weight;const{entry:i,exit:n}=this._addStateMachine(t.stateMachine,null,{...e},t.name);this._topLevelEntry=i,this._topLevelExit=n,this._currentNode=i,this._resetTrigger=e.triggerResetFn}get exited(){return this._currentNode===this._topLevelExit}update(t){this.exited||(this._fromWeight=1,this._toWeight=0,this._eval(t),this._sample())}getCurrentStateStatus(){const{_currentNode:t}=this;return t.kind===XK.animation?t.getFromPortStatus():null}getCurrentClipStatuses(){const{_currentNode:t}=this;return t.kind===XK.animation?t.getClipStatuses(this._fromWeight):kK}getCurrentTransition(t){const{_currentTransitionPath:e}=this;if(0!==e.length){if(e[e.length-1].to.kind!==XK.animation)return!1;const{duration:i,normalizedDuration:n}=e[0],s=t.duration=n?i*(this._currentNode.kind===XK.animation?this._currentNode.duration:0):i;return t.time=this._transitionProgress*s,!0}return!1}getNextStateStatus(){return this._currentTransitionToNode&&(this._currentTransitionToNode.kind,XK.empty),this._currentTransitionToNode.getToPortStatus()}getNextClipStatuses(){var t;const{_currentTransitionPath:e}=this,i=e[e.length-1].to;return i.kind,XK.animation,null!==(t=i.getClipStatuses(this._toWeight))&&void 0!==t?t:kK}_addStateMachine(t,e,i,n){const s=Array.from(t.states());let r,o,a;const c=s.map((e=>e instanceof Xj?new iJ(e,i):e===t.entryState?r=new rJ(e,XK.entry,e.name):e===t.exitState?a=new rJ(e,XK.exit,e.name):e===t.anyState?o=new rJ(e,XK.any,e.name):e instanceof GW?new oJ(e):null)),l={components:null,parent:e,entry:r,exit:a,any:o};for(let t=0;t<s.length;++t){const e=c[t];e&&(e.stateMachine=l)}const h=s.map((t=>{if(t instanceof HW){const e=this._addStateMachine(t.stateMachine,l,i,`${n}/${t.name}`);return e.components=new eJ(t),e}return null}));for(let e=0;e<s.length;++e){const n=s[e],r=t.getOutgoings(n),o=[];let a;a=n instanceof HW?h[e].exit:c[e];for(const t of r){const e=t.to,n=s.findIndex((e=>e===t.to));let r;r=e instanceof HW?h[n].entry:c[n];const a={conditions:t.conditions.map((t=>t[Rj](i))),to:r,triggers:void 0,duration:0,normalizedDuration:!1,exitCondition:0,exitConditionEnabled:!1};t instanceof VW?(a.duration=t.duration,a.normalizedDuration=t.relativeDuration,a.exitConditionEnabled=t.exitConditionEnabled,a.exitCondition=t.exitCondition):t instanceof UW&&(a.duration=t.duration),a.conditions.forEach(((e,i)=>{const n=t.conditions[i];var s;n instanceof xK&&n.trigger&&(null!==(s=a.triggers)&&void 0!==s?s:a.triggers=[]).push(n.trigger)})),o.push(a)}a.outgoingTransitions=o}return l}_eval(t){if(this.exited,zX(`[Layer ${this.name}]: UpdateStart ${t}s`),this._continueDanglingTransition())return 0;let e=t;for(let t=!0,i=0;t||e>0;){if(t=!1,100===i){I(14e3,100);break}if(++i,this._currentTransitionPath.length>0){if(e-=this._updateCurrentTransition(e),this._currentNode.kind===XK.exit)break;0===this._currentTransitionPath.length&&(t=!0);continue}const{_currentNode:n}=this,s=this._matchCurrentNodeTransition(e);if(s){const{transition:i,requires:r}=s;if(FX(`[SubStateMachine ${this.name}]: CurrentNodeUpdate: ${n.name}`),e-=r,n.kind===XK.animation&&(n.updateFromPort(r),this._fromUpdated=!0),this._switchTo(i))break;t=!0}else FX(`[SubStateMachine ${this.name}]: CurrentNodeUpdate: ${n.name}`),n.kind===XK.animation?(n.updateFromPort(e),this._fromUpdated=!0,e=0):e=0}return FX(`[SubStateMachine ${this.name}]: UpdateEnd`),this._fromUpdated&&this._currentNode.kind===XK.animation&&(this._fromUpdated=!1,this._currentNode.triggerFromPortUpdate(this._controller)),this._currentTransitionToNode&&this._toUpdated&&this._currentTransitionToNode.kind===XK.animation&&(this._toUpdated=!1,this._currentTransitionToNode.triggerToPortUpdate(this._controller)),e}_sample(){const{_currentNode:t,_currentTransitionToNode:e,_fromWeight:i,_toWeight:n}=this;t.kind===XK.empty?(this.passthroughWeight=n,e&&e.kind===XK.animation&&e.sampleToPort(1)):e&&e.kind===XK.empty?(this.passthroughWeight=i,t.kind===XK.animation&&t.sampleFromPort(1)):(this.passthroughWeight=1,t.kind===XK.animation&&t.sampleFromPort(i),e&&e.kind===XK.animation&&e.sampleToPort(n))}_matchCurrentNodeTransition(t){const e=this._currentNode;let i=1/0,n=null;const s=this._matchTransition(e,e,t,WK);if(s&&({requires:i,transition:n}=s),e.kind===XK.animation)for(let s=e.stateMachine;null!==s;s=s.parent){const r=this._matchTransition(s.any,e,t,qK);r&&r.requires<i&&({requires:i,transition:n}=r)}return n?jK.set(n,i):null}_matchTransition(t,e,i,n){t===e||(t.kind,XK.any);const{outgoingTransitions:s}=t,r=s.length;let o=1/0,a=null;for(let c=0;c<r;++c){const r=s[c],{conditions:l}=r,h=l.length;if(0===h){if(t.kind===XK.entry||t.kind===XK.exit)return n.set(r,0);if(!r.exitConditionEnabled)continue}let _=0;if(e.kind===XK.animation&&r.exitConditionEnabled){const t=e.duration*r.exitCondition;if(_=Math.max(t-e.fromPortTime,0),_>i)continue}let u=!0;for(let t=0;t<h;++t)if(!l[t].eval()){u=!1;break}if(u){if(0===_)return n.set(r,0);_<o&&(o=_,a=r)}}return a?n.set(a,o):null}_switchTo(t){const{_currentNode:e}=this;zX(`[SubStateMachine ${this.name}]: STARTED ${e.name} -> ${t.to.name}.`);const{_currentTransitionPath:i}=this;this._consumeTransition(t),i.push(t);const n=this._matchTransitionPathUntilMotion();return!n||(this._doTransitionToMotion(n),!1)}_continueDanglingTransition(){const{_currentTransitionPath:t}=this,e=t.length;if(0===e)return!1;const i=t[e-1].to;if(i.kind!==XK.animation&&i.kind!==XK.empty){const t=this._matchTransitionPathUntilMotion();return!t||(this._doTransitionToMotion(t),!1)}return!1}_matchTransitionPathUntilMotion(){const{_currentTransitionPath:t}=this;let e=t[t.length-1].to;for(;e.kind!==XK.animation&&e.kind!==XK.empty;){const i=this._matchTransition(e,e,0,jK);if(!i)break;const n=i.transition;this._consumeTransition(n),t.push(n),e=n.to}return e.kind===XK.animation||e.kind===XK.empty?e:null}_consumeTransition(t){const{to:e}=t;e.kind===XK.entry&&this._callEnterMethods(e)}_resetTriggersAlongThePath(){const{_currentTransitionPath:t}=this,e=t.length;for(let i=0;i<e;++i){const e=t[i];this._resetTriggersOnTransition(e)}}_doTransitionToMotion(t){this._resetTriggersAlongThePath(),this._transitionProgress=0,this._currentTransitionToNode=t,this._toUpdated=!1,t.kind===XK.animation&&t.resetToPort(),this._callEnterMethods(t)}_updateCurrentTransition(t){var e;const{_currentTransitionPath:i,_currentTransitionToNode:n}=this;i.length;const s=i[0],{duration:r,normalizedDuration:o}=s,a=this._currentNode,c=n;let l=0,h=0;if(r<=0)l=0,h=1;else{a.kind===XK.animation||(a.kind,XK.empty);const{_transitionProgress:e}=this,i=a.kind===XK.empty?r:o?r*a.duration:r,n=e*i,s=i-n;l=Math.min(s,t),h=this._transitionProgress=(n+l)/i}const _=null!==(e=null==c?void 0:c.name)&&void 0!==e?e:"<Empty>";this._fromWeight=1-h,this._toWeight=h;const u=0!==l,d=1===h;if(a.kind===XK.animation&&u&&(zX(`Update ${a.name}`),a.updateFromPort(l),this._fromUpdated=!0),c.kind===XK.animation&&u&&(zX(`Update ${c.name}`),c.updateToPort(l),this._toUpdated=!0),d){FX(`[SubStateMachine ${this.name}]: Transition finished:  ${a.name} -> ${_}.`),this._callExitMethods(a);const{_currentTransitionPath:t}=this,e=t.length;for(let i=0;i<e;++i){const{to:e}=t[i];e.kind===XK.exit&&this._callExitMethods(e)}this._fromUpdated=this._toUpdated,this._toUpdated=!1,c.kind===XK.animation&&c.finishTransition(),this._currentNode=c,this._currentTransitionToNode=null,this._currentTransitionPath.length=0,this._fromWeight=1,this._toWeight=0}return l}_resetTriggersOnTransition(t){const{triggers:e}=t;if(e){const t=e.length;for(let i=0;i<t;++i){const t=e[i];this._resetTrigger(t)}}}_resetTrigger(t){const{_triggerReset:e}=this;e(t)}_callEnterMethods(t){var e;const{_controller:i}=this;switch(t.kind){default:break;case XK.animation:t.components.callMotionStateEnterMethods(i,t.getToPortStatus());break;case XK.entry:null===(e=t.stateMachine.components)||void 0===e||e.callStateMachineEnterMethods(i)}}_callExitMethods(t){var e;const{_controller:i}=this;switch(t.kind){default:break;case XK.animation:t.components.callMotionStateExitMethods(i,t.getFromPortStatus());break;case XK.exit:null===(e=t.stateMachine.components)||void 0===e||e.callStateMachineExitMethods(i)}}}const UK=Object.freeze({next:()=>({done:!0,value:void 0})}),kK=Object.freeze({[Symbol.iterator]:()=>UK});class HK{constructor(){this.transition=null,this.requires=0}set(t,e){return this.transition=t,this.requires=e,this}}const jK=new HK,WK=new HK,qK=new HK;var XK,YK,KK,JK,$K,ZK,QK;!function(t){t[t.entry=0]="entry",t[t.exit=1]="exit",t[t.any=2]="any",t[t.animation=3]="animation",t[t.empty=4]="empty"}(XK||(XK={}));class tJ{constructor(t){this.name=void 0,this.outgoingTransitions=[],this.name=t.name}}class eJ{constructor(t){this._components=t.instantiateComponents()}callMotionStateEnterMethods(t,e){this._callMotionStateCallbackIfNonDefault("onMotionStateEnter",t,e)}callMotionStateUpdateMethods(t,e){this._callMotionStateCallbackIfNonDefault("onMotionStateUpdate",t,e)}callMotionStateExitMethods(t,e){this._callMotionStateCallbackIfNonDefault("onMotionStateExit",t,e)}callStateMachineEnterMethods(t){this._callStateMachineCallbackIfNonDefault("onStateMachineEnter",t)}callStateMachineExitMethods(t){this._callStateMachineCallbackIfNonDefault("onStateMachineExit",t)}_callMotionStateCallbackIfNonDefault(t,e,i){const{_components:n}=this,s=n.length;for(let r=0;r<s;++r){const s=n[r];s[t]!==zK.prototype[t]&&s[t](e,i)}}_callStateMachineCallbackIfNonDefault(t,e){const{_components:i}=this,n=i.length;for(let s=0;s<n;++s){const n=i[s];n[t]!==zK.prototype[t]&&n[t](e)}}}class iJ extends tJ{constructor(t,e){var i,n;if(super(t),this.kind=XK.animation,this._source=null,this._baseSpeed=1,this._speed=1,this._fromPort={progress:0,statusCache:{progress:0}},this._toPort={progress:0,statusCache:{progress:0}},this._baseSpeed=t.speed,this._setSpeedMultiplier(1),t.speedMultiplierEnabled&&t.speedMultiplier){const i=t.speedMultiplier,n=e.getVar(i);if(nY(n,i)){!function(t,e,i){if(t!==e)throw new Ij(i,"number")}(n.type,bj.FLOAT,i),n.bind(this._setSpeedMultiplier,this);const t=n.value;this._setSpeedMultiplier(t)}}const s={...e},r=null!==(i=null===(n=t.motion)||void 0===n?void 0:n[Rj](s))&&void 0!==i?i:null;r&&Object.defineProperty(r,"__DEBUG_ID__",{value:this.name}),this._source=r,this.components=new eJ(t)}get duration(){var t,e;return null!==(t=null===(e=this._source)||void 0===e?void 0:e.duration)&&void 0!==t?t:0}get fromPortTime(){return this._fromPort.progress*this.duration}updateFromPort(t){this._fromPort.progress=nJ(this._fromPort.progress,this.duration,t*this._speed)}updateToPort(t){this._toPort.progress=nJ(this._toPort.progress,this.duration,t*this._speed)}triggerFromPortUpdate(t){this.components.callMotionStateUpdateMethods(t,this.getFromPortStatus())}triggerToPortUpdate(t){this.components.callMotionStateUpdateMethods(t,this.getToPortStatus())}getFromPortStatus(){const{statusCache:t}=this._fromPort;return t.progress=sJ(this._fromPort.progress),t}getToPortStatus(){const{statusCache:t}=this._toPort;return t.progress=sJ(this._toPort.progress),t}resetToPort(){this._toPort.progress=0}finishTransition(){this._fromPort.progress=this._toPort.progress}sampleFromPort(t){var e;null===(e=this._source)||void 0===e||e.sample(this._fromPort.progress,t)}sampleToPort(t){var e;null===(e=this._source)||void 0===e||e.sample(this._toPort.progress,t)}getClipStatuses(t){const{_source:e}=this;return e?{[Symbol.iterator]:()=>e.getClipStatuses(t)}:kK}_setSpeedMultiplier(t){this._speed=this._baseSpeed*t}}function nJ(t,e,i){return 0===e?0:t+i/e}function sJ(t){return t-Math.trunc(t)}class rJ extends tJ{constructor(t,e,i){super(t),this.kind=void 0,this.kind=e}}class oJ extends tJ{constructor(t){super(t),this.kind=XK.empty}}let aJ=(YK=dc("cc.animation.AnimationController"),KK=Pc(),JK=gc(XW),YK($K=KK((QK=sc((ZK=class extends Lh{constructor(...t){super(...t),nc(this,"graph",QK,this),this._graphEval=null}__preload(){this.graph&&(this._graphEval=new VK(this.graph,this.node,this))}update(t){var e;null===(e=this._graphEval)||void 0===e||e.update(t)}getVariables(){const{_graphEval:t}=this;return t.getVariables()}setValue(t,e){const{_graphEval:i}=this;i.setValue(t,e)}getValue(t){const{_graphEval:e}=this;return e.getValue(t)}getCurrentStateStatus(t){const{_graphEval:e}=this;return e.getCurrentStateStatus(t)}getCurrentClipStatuses(t){const{_graphEval:e}=this;return e.getCurrentClipStatuses(t)}getCurrentTransition(t){const{_graphEval:e}=this;return e.getCurrentTransition(t)}getNextStateStatus(t){const{_graphEval:e}=this;return e.getNextStateStatus(t)}getNextClipStatuses(t){const{_graphEval:e}=this;return e.getNextClipStatuses(t)}setLayerWeight(t,e){const{_graphEval:i}=this;return i.setLayerWeight(t,e)}}).prototype,"graph",[JK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$K=ZK))||$K)||$K);t("animation",Object.freeze({__proto__:null,UniformProxyFactory:Zk,MorphWeightValueProxy:aH,MorphWeightsValueProxy:cH,MorphWeightsAllValueProxy:lH,Track:HH,TrackPath:UH,RealTrack:YH,VectorTrack:ej,QuatTrack:oj,ColorTrack:uj,SizeTrack:vj,ObjectTrack:Sj,isPropertyPath:jk,isCustomPath:function(t,e){return t instanceof e},HierarchyPath:Wk,ComponentPath:qk,CubicSplineVec2Value:fH,CubicSplineVec3Value:gH,CubicSplineVec4Value:vH,CubicSplineQuatValue:yH,CubicSplineNumberValue:xH,AnimationController:aJ,get VariableType(){return bj},StateMachineComponent:zK}));const cJ=[],lJ=new Map;function hJ(t,e){let i=0,n=Ii.IDENTITY;for(;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){n=t.world,t.stamp=e;break}t.stamp=e,cJ[i++]=t,t=t.parent}for(;i>0;){t=cJ[--i],cJ[i]=null;const e=t.node;Ii.fromRTS(t.local,e.rotation,e.position,e.scale),n=Ii.multiply(t.world,n,t.local)}return n}function _J(t,e){let i,n=null,s=0;for(;t!==e;){const e=t.uuid;if(lJ.has(e)){n=lJ.get(e);break}n={node:t,local:new Ii,world:new Ii,stamp:-1,parent:null},lJ.set(e,n),cJ[s++]=n,t=t.parent,n=null}for(;s>0;)i=cJ[--s],cJ[s]=null,i.parent=n,n=i;return n}function uJ(t){let e=lJ.get(t.uuid)||null;for(;e;)lJ.delete(e.node.uuid),e=e.parent}var dJ,mJ,pJ;let fJ=t("AnimationManager",dc((pJ=mJ=class extends ew{constructor(...t){super(...t),this._anims=new Y([]),this._crossFades=new Y([]),this._delayEvents=[],this._blendStateBuffer=new RK,this._sockets=[]}get blendState(){return this._blendStateBuffer}addCrossFade(t){-1===this._crossFades.array.indexOf(t)&&this._crossFades.push(t)}removeCrossFade(t){const e=this._crossFades.array.indexOf(t);e>=0?this._crossFades.fastRemoveAt(e):D(3907)}update(t){const{_delayEvents:e,_crossFades:i,_sockets:n}=this;{const e=i.array;for(i.i=0;i.i<e.length;++i.i)e[i.i].update(t)}const s=this._anims,r=s.array;for(s.i=0;s.i<r.length;++s.i){const e=r[s.i];e.isMotionless||e.update(t)}this._blendStateBuffer.apply();const o=l.director.getTotalFrames();for(let t=0,e=n.length;t<e;t++){const{target:e,transform:i}=n[t];e.matrix=hJ(i,o)}for(let t=0,i=e.length;t<i;t++){const i=e[t];i.fn.apply(i.thisArg,i.args)}e.length=0}destruct(){}addAnimation(t){-1===this._anims.array.indexOf(t)&&this._anims.push(t)}removeAnimation(t){const e=this._anims.array.indexOf(t);e>=0?this._anims.fastRemoveAt(e):D(3907)}pushDelayEvent(t,e,i){this._delayEvents.push({fn:t,thisArg:e,args:i})}addSockets(t,e){for(let i=0;i<e.length;++i){const n=e[i];if(this._sockets.find((t=>t.target===n.target)))continue;const s=t.getChildByPath(n.path),r=n.target&&s&&_J(s,t);r&&this._sockets.push({target:n.target,transform:r})}}removeSockets(t,e){for(let t=0;t<e.length;++t){const i=e[t];for(let t=0;t<this._sockets.length;++t){const e=this._sockets[t];if(e.target===i.target){uJ(e.transform.node),this._sockets[t]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}}}},mJ.ID="animation",dJ=pJ))||dJ);mw.on(dw.EVENT_INIT,(()=>{const t=new fJ;mw.registerSystem(fJ.ID,t,ew.Priority.HIGH)})),l.AnimationManager=fJ;class gJ extends OX{constructor(t){super(),this._managedStates=[],this._fadings=[],this._scheduled=!1,this._scheduler=null!=t?t:oX()}update(t){if(this.isMotionless)return;const e=this._managedStates,i=this._fadings;if(1===e.length&&1===i.length){const t=e[0].state;t&&(t.weight=1)}else this._calculateWeights(t);1===e.length&&1===i.length&&this._unscheduleThis()}crossFade(t,e){var i;0===this._managedStates.length&&(e=0),0===e&&this.clear();let n=this._managedStates.find((e=>e.state===t));n?(null===(i=n.state)||void 0===i?void 0:i.isMotionless)&&n.state.play():(n={state:t,reference:0},t&&t.play(),this._managedStates.push(n)),++n.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:n}),this.isMotionless||this._scheduleThis()}clear(){for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.stop()}this._managedStates.length=0,this._fadings.length=0}onPlay(){super.onPlay(),this._scheduleThis()}onPause(){super.onPause();for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.pause()}this._unscheduleThis()}onResume(){super.onResume();for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.resume()}this._scheduleThis()}onStop(){super.onStop(),this.clear()}_calculateWeights(t){const e=this._managedStates,i=this._fadings;for(let t=0;t<e.length;++t){const i=e[t].state;i&&(i.weight=0)}let n=1,s=i.length;for(let e=0;e<i.length;++e){const r=i[e];r.easeTime+=t;const o=0===r.easeDuration?1:qe(r.easeTime/r.easeDuration),a=o*n;if(n*=1-o,r.target.state&&(r.target.state.weight+=a),r.easeTime>=r.easeDuration){s=e+1,r.easeTime=r.easeDuration;break}}if(s!==i.length){for(let t=s;t<i.length;++t){const e=i[t];--e.target.reference,e.target.reference<=0&&(e.target.state&&e.target.state.stop(),$(this._managedStates,e.target))}i.splice(s)}}_scheduleThis(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)}_unscheduleThis(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)}}var vJ,yJ,xJ,SJ,CJ,AJ,bJ,TJ,EJ,PJ,wJ,IJ,RJ,DJ,MJ,OJ,BJ;let NJ=function(e){return t({Animation:e,AnimationComponent:e}),e}((vJ=dc("cc.Animation"),yJ=Dc(),xJ=pc(99),SJ=Pc(),CJ=Kc([CX]),AJ=Lc(),bJ=Kc(CX),TJ=Lc(),EJ=Lc(),PJ=Kc([CX]),vJ(wJ=yJ(wJ=xJ(wJ=Ec(wJ=SJ((BJ=OJ=class extends(kl(Lh)){constructor(...t){super(...t),nc(this,"playOnLoad",RJ,this),this._crossFade=new gJ,this._nameToState=ut(!0),nc(this,"_clips",DJ,this),nc(this,"_defaultClip",MJ,this),this._hasBeenPlayed=!1}get clips(){return this._clips}set clips(t){this._crossFade&&this._crossFade.clear();for(const t of this._clips)t&&this._removeStateOfAutomaticClip(t);for(const e of t)e&&this.createState(e);const e=t.find((t=>LJ(t,this._defaultClip)));this._defaultClip=e||null,this._clips=t}get defaultClip(){return this._defaultClip}set defaultClip(t){this._defaultClip=t,t&&(this._clips.findIndex((e=>LJ(e,t)))>=0||(this._clips.push(t),this.createState(t)))}onLoad(){this.clips=this._clips;for(const t in this._nameToState)this._nameToState[t].initialize(this.node)}start(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}onEnable(){this._crossFade.resume()}onDisable(){this._crossFade.pause()}onDestroy(){this._crossFade.stop();for(const t in this._nameToState)this._nameToState[t].destroy();this._nameToState=ut(!0)}play(t){if(this._hasBeenPlayed=!0,!t){if(!this._defaultClip)return;t=this._defaultClip.name}this.crossFade(t,0)}crossFade(t,e=.3){this._hasBeenPlayed=!0;const i=this._nameToState[t];i&&this.doPlayOrCrossFade(i,e)}pause(){this._crossFade.pause()}resume(){this._crossFade.resume()}stop(){this._crossFade.stop()}getState(t){const e=this._nameToState[t];return e&&!e.curveLoaded&&e.initialize(this.node),e||null}createState(t,e){return e=e||t.name,this.removeState(e),this._doCreateState(t,e)}removeState(t){const e=this._nameToState[t];e&&(e.allowLastFrameEvent(!1),e.stop(),delete this._nameToState[t])}addClip(t,e){return Q(this._clips,t)||this._clips.push(t),this.createState(t,e)}removeClip(t,e){let i;for(const e in this._nameToState){const n=this._nameToState[e];if(n.clip===t){i=n;break}}if(t===this._defaultClip){if(!e)return void I(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!e)return void I(3903);i.stop()}this._clips=this._clips.filter((e=>e!==t)),i&&delete this._nameToState[i.name]}on(t,e,i,n){const s=super.on(t,e,i,n);return t===NX.LASTFRAME&&this._syncAllowLastFrameEvent(),s}once(t,e,i){const n=super.once(t,e,i);return t===NX.LASTFRAME&&this._syncAllowLastFrameEvent(),n}off(t,e,i){super.off(t,e,i),t===NX.LASTFRAME&&this._syncDisallowLastFrameEvent()}_createState(t,e){return new LX(t,e)}_doCreateState(t,e){const i=this._createState(t,e);return i._setEventTarget(this),i.allowLastFrameEvent(this.hasEventListener(NX.LASTFRAME)),this.node&&i.initialize(this.node),this._nameToState[i.name]=i,i}doPlayOrCrossFade(t,e){this._crossFade.play(),this._crossFade.crossFade(t,e)}_removeStateOfAutomaticClip(t){for(const e in this._nameToState){const i=this._nameToState[e];LJ(t,i.clip)&&(i.stop(),delete this._nameToState[e])}}_syncAllowLastFrameEvent(){if(this.hasEventListener(NX.LASTFRAME))for(const t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!0)}_syncDisallowLastFrameEvent(){if(!this.hasEventListener(NX.LASTFRAME))for(const t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!1)}},OJ.EventType=NX,sc((IJ=BJ).prototype,"clips",[CJ,AJ],Object.getOwnPropertyDescriptor(IJ.prototype,"clips"),IJ.prototype),sc(IJ.prototype,"defaultClip",[bJ,TJ],Object.getOwnPropertyDescriptor(IJ.prototype,"defaultClip"),IJ.prototype),RJ=sc(IJ.prototype,"playOnLoad",[Sc,EJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),DJ=sc(IJ.prototype,"_clips",[PJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),MJ=sc(IJ.prototype,"_defaultClip",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wJ=IJ))||wJ)||wJ)||wJ)||wJ)||wJ));function LJ(t,e){return t===e||!!t&&!!e&&t._uuid===e._uuid&&t._uuid}l.Animation=NJ,l.AnimationComponent=NJ,Ut.setClassAlias(NJ,"cc.AnimationComponent");const FJ=new Ii;function zJ(t,e,i){for(Ii.identity(i);t!==e;)Ii.fromRTS(FJ,t.rotation,t.position,t.scale),Ii.multiply(i,FJ,i),t=t.parent;return i}let VJ,GJ,UJ;l.easing=Bu,function(t){t.PLAYED="play",t.PAUSED="pause",t.STOPPED="stop",t.SEEKED="seeked",t.ENDED="ended",t.INTERRUPTION_BEGIN="interruptionBegin",t.INTERRUPTION_END="interruptionEnd",t.USER_GESTURE="on_gesture"}(VJ||(VJ={})),function(t){t[t.DOM_AUDIO=0]="DOM_AUDIO",t[t.WEB_AUDIO=1]="WEB_AUDIO",t[t.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",t[t.NATIVE_AUDIO=3]="NATIVE_AUDIO",t[t.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(GJ||(GJ={})),function(t){t[t.INIT=0]="INIT",t[t.PLAYING=1]="PLAYING",t[t.PAUSED=2]="PAUSED",t[t.STOPPED=3]="STOPPED",t[t.INTERRUPTED=4]="INTERRUPTED"}(UJ||(UJ={}));let kJ=0;function HJ(t,e){e.invoking||(e.invoking=!0,e.func.call(t,...e.args).then((()=>{e.invoking=!1,t._operationQueue.shift(),t._eventTarget.emit(e.id.toString());const i=t._operationQueue[0];i&&HJ(t,i)})).catch((()=>{})))}function jJ(t,e,i){const n=i.value;i.value=function(...t){return new Promise((e=>{const i=kJ++,s=this;s._operationQueue.push({id:i,func:n,args:t,invoking:!1}),s._eventTarget.once(i.toString(),e),HJ(s,s._operationQueue[0])}))}}var WJ,qJ,XJ;const YJ={},KJ=jsb.AudioEngine,JJ=-1;class $J{get onPlay(){return this._onPlayCb}set onPlay(t){this._onPlayCb=t}get onEnd(){return this._onEndCb}set onEnd(t){this._onEndCb=t}constructor(t,e){this._id=JJ,this._url=void 0,this._volume=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._url=t,this._volume=e}play(){var t;this._id=jsb.AudioEngine.play2d(this._url,!1,this._volume),jsb.AudioEngine.setFinishCallback(this._id,(()=>{var t;null===(t=this.onEnd)||void 0===t||t.call(this)})),null===(t=this.onPlay)||void 0===t||t.call(this)}stop(){this._id!==JJ&&jsb.AudioEngine.stop(this._id)}}let ZJ=(XJ=qJ=class t{constructor(t){this._url=void 0,this._id=JJ,this._state=UJ.INIT,this._eventTarget=new Hl,this._operationQueue=[],this._cachedState={duration:1,loop:!1,currentTime:0,volume:1},this._url=t,Zl.on("hide",this._onHide,this),Zl.on("show",this._onShow,this)}destroy(){Zl.on("hide",this._onHide,this),Zl.on("show",this._onShow,this),--YJ[this._url]<=0&&KJ.uncache(this._url)}_onHide(){this._state===UJ.PLAYING&&this.pause().then((()=>{this._state=UJ.INTERRUPTED,this._eventTarget.emit(VJ.INTERRUPTION_BEGIN)})).catch((()=>{}))}_onShow(){this._state===UJ.INTERRUPTED&&this.play().then((()=>{this._eventTarget.emit(VJ.INTERRUPTION_END)})).catch((()=>{}))}static load(e){return new Promise(((i,n)=>{t.loadNative(e).then((e=>{i(new t(e))})).catch((t=>n(t)))}))}static loadNative(t){return new Promise(((e,i)=>{Zl.platform===Yl.WIN32?e(t):KJ.preload(t,(n=>{n?e(t):i(new Error("load audio failed"))}))}))}static loadOneShotAudio(e,i){return new Promise(((n,s)=>{t.loadNative(e).then((t=>{n(new $J(t,i))})).catch(s)}))}get _isValid(){return this._id!==JJ}get src(){return this._url}get type(){return GJ.NATIVE_AUDIO}get state(){return this._state}get loop(){return this._isValid?KJ.isLoop(this._id):this._cachedState.loop}set loop(t){this._isValid&&KJ.setLoop(this._id,t),this._cachedState.loop=t}get volume(){return this._isValid?KJ.getVolume(this._id):this._cachedState.volume}set volume(t){t=qe(t),this._isValid&&KJ.setVolume(this._id,t),this._cachedState.volume=t}get duration(){return this._isValid?KJ.getDuration(this._id):this._cachedState.duration}get currentTime(){return this._isValid?KJ.getCurrentTime(this._id):this._cachedState.currentTime}seek(t){return new Promise((e=>(this._isValid&&KJ.setCurrentTime(this._id,t),this._cachedState.currentTime=t,e())))}play(){return new Promise((t=>{this._isValid?this._state===UJ.PAUSED||this._state===UJ.INTERRUPTED?KJ.resume(this._id):this._state===UJ.PLAYING&&(KJ.pause(this._id),KJ.setCurrentTime(this._id,0),KJ.resume(this._id)):(this._id=KJ.play2d(this._url,this._cachedState.loop,this._cachedState.volume),this._isValid&&(0!==this._cachedState.currentTime&&(KJ.setCurrentTime(this._id,this._cachedState.currentTime),this._cachedState.currentTime=0),KJ.setFinishCallback(this._id,(()=>{this._cachedState.currentTime=0,this._id=JJ,this._state=UJ.INIT,this._eventTarget.emit(VJ.ENDED)})))),this._state=UJ.PLAYING,t()}))}pause(){return new Promise((t=>{this._isValid&&KJ.pause(this._id),this._state=UJ.PAUSED,t()}))}stop(){return new Promise((t=>{this._isValid&&KJ.stop(this._id),this._state=UJ.STOPPED,this._id=JJ,this._cachedState.currentTime=0,t()}))}onInterruptionBegin(t){this._eventTarget.on(VJ.INTERRUPTION_BEGIN,t)}offInterruptionBegin(t){this._eventTarget.off(VJ.INTERRUPTION_BEGIN,t)}onInterruptionEnd(t){this._eventTarget.on(VJ.INTERRUPTION_END,t)}offInterruptionEnd(t){this._eventTarget.off(VJ.INTERRUPTION_END,t)}onEnded(t){this._eventTarget.on(VJ.ENDED,t)}offEnded(t){this._eventTarget.off(VJ.ENDED,t)}},qJ.maxAudioChannel=KJ.getMaxAudioInstance(),sc((WJ=XJ).prototype,"seek",[jJ],Object.getOwnPropertyDescriptor(WJ.prototype,"seek"),WJ.prototype),sc(WJ.prototype,"play",[jJ],Object.getOwnPropertyDescriptor(WJ.prototype,"play"),WJ.prototype),sc(WJ.prototype,"pause",[jJ],Object.getOwnPropertyDescriptor(WJ.prototype,"pause"),WJ.prototype),sc(WJ.prototype,"stop",[jJ],Object.getOwnPropertyDescriptor(WJ.prototype,"stop"),WJ.prototype),WJ);var QJ,t$,e$,i$,n$;l.AudioPlayer=ZJ;let s$=t("AudioClip",dc("cc.AudioClip")((n$=i$=class extends fh{constructor(...t){super(...t),nc(this,"_duration",e$,this),this._loadMode=GJ.UNKNOWN_AUDIO,this._meta=null,this._player=null}destroy(){var t;const e=super.destroy();return null===(t=this._player)||void 0===t||t.destroy(),this._player=null,this._meta&&(this._meta.player=null),e}set _nativeAsset(t){this._meta=t,t?(this._loadMode=t.type,this._player=t.player):(this._meta=null,this._loadMode=GJ.UNKNOWN_AUDIO,this._duration=0)}get _nativeAsset(){return this._meta}get _nativeDep(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}get loadMode(){return this._loadMode}validate(){return!!this._meta}getDuration(){return this._duration?this._duration:this._meta?this._meta.duration:0}get state(){return this._player?this._player.state:UJ.INIT}getCurrentTime(){return this._player?this._player.currentTime:0}getVolume(){return this._player?this._player.volume:0}getLoop(){return!!this._player&&this._player.loop}setCurrentTime(t){var e;null===(e=this._player)||void 0===e||e.seek(t).catch((()=>{}))}setVolume(t){this._player&&(this._player.volume=t)}setLoop(t){this._player&&(this._player.loop=t)}play(){var t;null===(t=this._player)||void 0===t||t.play().catch((()=>{}))}pause(){var t;null===(t=this._player)||void 0===t||t.pause().catch((()=>{}))}stop(){var t;null===(t=this._player)||void 0===t||t.stop().catch((()=>{}))}playOneShot(t=1){this._nativeAsset&&ZJ.loadOneShotAudio(this._nativeAsset.url,t).then((t=>{t.play()})).catch((()=>{}))}},i$.AudioType=GJ,e$=sc((t$=n$).prototype,"_duration",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sc(t$.prototype,"_nativeDep",[Jc],Object.getOwnPropertyDescriptor(t$.prototype,"_nativeDep"),t$.prototype),QJ=t$))||QJ);function r$(t,e,i){ZJ.load(t,{audioLoadMode:e.audioLoadMode}).then((e=>{const n={player:e,url:t,duration:e.duration,type:e.type};i(null,n)})).catch((t=>{i(t)}))}function o$(t,e,i,n){const s=new s$;s._nativeUrl=t,s._nativeAsset=e,s._duration=e.duration,n(null,s)}l.AudioClip=s$,nI.register({".mp3":r$,".ogg":r$,".wav":r$,".m4a":r$}),hI.register({".mp3":o$,".ogg":o$,".wav":o$,".m4a":o$});const a$=new class{constructor(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}_findIndex(t,e){return t.findIndex((t=>t.audio===e))}_tryAddPlaying(t,e){const i=this._findIndex(t,e);return i>-1?(t[i].playTime=performance.now(),!1):(t.push({audio:e,playTime:performance.now()}),!0)}addPlaying(t){if(t instanceof ZJ){if(this._tryAddPlaying(this._audioPlayerInfoList,t))return}else this._tryAddPlaying(this._oneShotAudioInfoList,t)}_tryRemovePlaying(t,e){const i=this._findIndex(t,e);return-1!==i&&(J(t,i),!0)}removePlaying(t){if(t instanceof ZJ){if(this._tryRemovePlaying(this._audioPlayerInfoList,t))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,t)}discardOnePlayingIfNeeded(){if(this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<ZJ.maxAudioChannel)return;let t;this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((e=>{(!t||e.playTime<t.playTime)&&(t=e)})):this._audioPlayerInfoList.forEach((e=>{(!t||e.playTime<t.playTime)&&(t=e)})),t&&(t.audio.stop(),this.removePlaying(t.audio))}};var c$,l$,h$,_$,u$,d$,m$,p$,f$,g$,v$,y$,x$,S$,C$,A$,b$,T$,E$;!function(t){t.STARTED="started",t.ENDED="ended"}(E$||(E$={}));let P$=function(e){return t({AudioSource:e,AudioSourceComponent:e}),e}((c$=dc("cc.AudioSource"),l$=Dc(),h$=Pc(),_$=Kc(s$),u$=Kc(s$),d$=Lc(),m$=Lc(),p$=Lc(),f$=Fc(),g$=Lc(),c$(v$=l$(v$=h$((T$=b$=class t extends Lh{constructor(...t){super(...t),nc(this,"_clip",x$,this),this._player=null,nc(this,"_loop",S$,this),nc(this,"_playOnAwake",C$,this),nc(this,"_volume",A$,this),this._cachedCurrentTime=0,this._operationsBeforeLoading=[],this._isLoaded=!1,this._lastSetClip=null}static get maxAudioChannel(){return ZJ.maxAudioChannel}set clip(t){t!==this._clip&&(this._clip=t,this._syncPlayer())}get clip(){return this._clip}_syncPlayer(){const t=this._clip;this._isLoaded=!1,this._lastSetClip!==t&&(t?t._nativeAsset?(this._lastSetClip=t,ZJ.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((e=>{this._lastSetClip===t?(this._isLoaded=!0,this._player&&(a$.removePlaying(this._player),this._player.offEnded(),this._player.offInterruptionBegin(),this._player.offInterruptionEnd(),this._player.destroy()),this._player=e,e.onEnded((()=>{a$.removePlaying(e),this.node.emit(E$.ENDED,this)})),e.onInterruptionBegin((()=>{a$.removePlaying(e)})),e.onInterruptionEnd((()=>{a$.addPlaying(e)})),this._syncStates()):e.destroy()})).catch((()=>{}))):console.error("Invalid audio clip"):this._lastSetClip=null)}set loop(t){this._loop=t,this._player&&(this._player.loop=t)}get loop(){return this._loop}set playOnAwake(t){this._playOnAwake=t}get playOnAwake(){return this._playOnAwake}set volume(t){Number.isNaN(t)?console.warn("illegal audio volume!"):(t=We(t,0,1),this._player?(this._player.volume=t,this._volume=this._player.volume):this._volume=t)}get volume(){return this._volume}onLoad(){this._syncPlayer()}onEnable(){this._playOnAwake&&!this.playing&&this.play()}onDisable(){const t=this._getRootNode();(null==t?void 0:t._persistNode)||this.pause()}onDestroy(){var t;this.stop(),null===(t=this._player)||void 0===t||t.destroy(),this._player=null}_getRootNode(){var t,e;let i=this.node,n=null===(t=i)||void 0===t||null===(e=t.parent)||void 0===e?void 0:e.parent;for(;n;){var s,r,o;i=null===(s=i)||void 0===s?void 0:s.parent,n=null===(r=i)||void 0===r||null===(o=r.parent)||void 0===o?void 0:o.parent}return i}play(){var t,e;this._isLoaded?(a$.discardOnePlayingIfNeeded(),this.state===UJ.PLAYING&&(null===(e=this._player)||void 0===e||e.stop().catch((()=>{}))),null===(t=this._player)||void 0===t||t.play().then((()=>{a$.addPlaying(this._player),this.node.emit(E$.STARTED,this)})).catch((()=>{}))):this._operationsBeforeLoading.push("play")}pause(){var t;this._isLoaded?null===(t=this._player)||void 0===t||t.pause().then((()=>{a$.removePlaying(this._player)})).catch((()=>{})):this._operationsBeforeLoading.push("pause")}stop(){var t;this._isLoaded?null===(t=this._player)||void 0===t||t.stop().then((()=>{a$.removePlaying(this._player)})).catch((()=>{})):this._operationsBeforeLoading.push("stop")}playOneShot(t,e=1){t._nativeAsset?ZJ.loadOneShotAudio(t._nativeAsset.url,this._volume*e,{audioLoadMode:t.loadMode}).then((t=>{a$.discardOnePlayingIfNeeded(),t.onPlay=()=>{a$.addPlaying(t)},t.onEnd=()=>{a$.removePlaying(t)},t.play()})).catch((()=>{})):console.error("Invalid audio clip")}_syncStates(){this._player&&this._player.seek(this._cachedCurrentTime).then((()=>{this._player&&(this._player.loop=this._loop,this._player.volume=this._volume,this._operationsBeforeLoading.forEach((t=>{var e;null===(e=this[t])||void 0===e||e.call(this)})),this._operationsBeforeLoading.length=0)})).catch((()=>{}))}set currentTime(t){var e;Number.isNaN(t)?console.warn("illegal audio time!"):(t=We(t,0,this.duration),this._cachedCurrentTime=t,null===(e=this._player)||void 0===e||e.seek(this._cachedCurrentTime).catch((()=>{})))}get currentTime(){return this._player?this._player.currentTime:this._cachedCurrentTime}get duration(){var t,e;return null!==(t=null===(e=this._clip)||void 0===e?void 0:e.getDuration())&&void 0!==t?t:this._player?this._player.duration:0}get state(){return this._player?this._player.state:UJ.INIT}get playing(){return this.state===t.AudioState.PLAYING}},b$.AudioState=UJ,b$.EventType=E$,x$=sc((y$=T$).prototype,"_clip",[_$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S$=sc(y$.prototype,"_loop",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),C$=sc(y$.prototype,"_playOnAwake",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),A$=sc(y$.prototype,"_volume",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sc(y$.prototype,"clip",[u$,d$],Object.getOwnPropertyDescriptor(y$.prototype,"clip"),y$.prototype),sc(y$.prototype,"loop",[m$],Object.getOwnPropertyDescriptor(y$.prototype,"loop"),y$.prototype),sc(y$.prototype,"playOnAwake",[p$],Object.getOwnPropertyDescriptor(y$.prototype,"playOnAwake"),y$.prototype),sc(y$.prototype,"volume",[f$,g$],Object.getOwnPropertyDescriptor(y$.prototype,"volume"),y$.prototype),v$=y$))||v$)||v$)||v$));V(s$,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:P$,targetName:"AudioSource"}]),U(s$.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((t=>({name:t,suggest:`please use AudioSource.prototype.${t} instead`})))),l.AudioSourceComponent=P$,Ut.setClassAlias(P$,"cc.AudioSourceComponent"),l.log=v,l.warn=y,l.error=x,l.assert=S,l._throw=b,l.logID=P,l.warnID=I,l.errorID=D,l.assertID=O,l.debug=z,l.path={join:ih,extname:nh,mainFileName:sh,basename:rh,dirname:oh,changeExtname:ah,changeBasename:ch,_normalize:lh,stripSep:hh,get sep(){return _h()}};class w${constructor(t){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}size(){return this._pool.length}clear(){const t=this._pool.length;for(let e=0;e<t;++e)this._pool[e].destroy();this._pool.length=0}put(t){if(t&&-1===this._pool.indexOf(t)){t.removeFromParent();const e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;e&&e.unuse&&e.unuse(),this._pool.push(t)}}get(...t){const e=this._pool.length-1;if(e<0)return null;{const t=this._pool[e];this._pool.length=e;const i=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;return i&&i.reuse&&i.reuse(arguments),t}}}t("NodePool",w$),l.NodePool=w$,l.renderer=Yv;var I$=Object.setPrototypeOf;let R$={};R$||(R$={}),function(t){var e=function(){function e(i){this._clock=new t.WorldClock,this._events=[],this._objects=[],this._eventManager=null,this._eventManager=i,console.info("DragonBones: "+e.VERSION+"\nWebsite: http://dragonbones.com/\nSource and Demo: https://github.com/DragonBones/")}return e.prototype.advanceTime=function(e){if(this._objects.length>0){for(var i=0,n=this._objects;i<n.length;i++)n[i].returnToPool();this._objects.length=0}if(this._clock.advanceTime(e),this._events.length>0){for(var s=0;s<this._events.length;++s){var r=this._events[s],o=r.armature;null!==o._armatureData&&(o.eventDispatcher.dispatchDBEvent(r.type,r),r.type===t.EventObject.SOUND_EVENT&&this._eventManager.dispatchDBEvent(r.type,r)),this.bufferObject(r)}this._events.length=0}},e.prototype.bufferEvent=function(t){this._events.indexOf(t)<0&&this._events.push(t)},e.prototype.bufferObject=function(t){this._objects.indexOf(t)<0&&this._objects.push(t)},Object.defineProperty(e.prototype,"clock",{get:function(){return this._clock},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"eventManager",{get:function(){return this._eventManager},enumerable:!0,configurable:!0}),e.VERSION="5.6.300",e.yDown=!1,e.debug=!1,e.debugDraw=!1,e.webAssembly=!1,e}();t.DragonBones=e}(R$||(R$={})),console.warn||(console.warn=function(){}),console.assert||(console.assert=function(){}),Date.now||(Date.now=function(){return(new Date).getTime()}),I$=function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},function(t){var e=function(){function t(){this.hashCode=t._hashCode++,this._isInPool=!1}return t._returnObject=function(e){var i=String(e.constructor),n=i in t._maxCountMap?t._maxCountMap[i]:t._defaultMaxCount,s=t._poolsMap[i]=t._poolsMap[i]||[];s.length<n&&(e._isInPool?console.warn("The object is already in the pool."):(e._isInPool=!0,s.push(e)))},t.toString=function(){throw new Error},t.setMaxCount=function(e,i){if((i<0||i!=i)&&(i=0),null!==e)null!==(s=(n=String(e))in t._poolsMap?t._poolsMap[n]:null)&&s.length>i&&(s.length=i),t._maxCountMap[n]=i;else for(var n in t._defaultMaxCount=i,t._poolsMap){var s;(s=t._poolsMap[n]).length>i&&(s.length=i),n in t._maxCountMap&&(t._maxCountMap[n]=i)}},t.clearPool=function(e){if(void 0===e&&(e=null),null!==e){var i=String(e);null!==(s=i in t._poolsMap?t._poolsMap[i]:null)&&s.length>0&&(s.length=0)}else for(var n in t._poolsMap){var s;(s=t._poolsMap[n]).length=0}},t.borrowObject=function(e){var i=String(e),n=i in t._poolsMap?t._poolsMap[i]:null;if(null!==n&&n.length>0){var s=n.pop();return s._isInPool=!1,s}var r=new e;return r._onClear(),r},t.prototype.returnToPool=function(){this._onClear(),t._returnObject(this)},t._hashCode=0,t._defaultMaxCount=3e3,t._maxCountMap={},t._poolsMap={},t}();t.BaseObject=e}(R$||(R$={})),function(t){var e=function(){function t(t,e,i,n,s,r){void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===s&&(s=0),void 0===r&&(r=0),this.a=t,this.b=e,this.c=i,this.d=n,this.tx=s,this.ty=r}return t.prototype.toString=function(){return"[object dragonBones.Matrix] a:"+this.a+" b:"+this.b+" c:"+this.c+" d:"+this.d+" tx:"+this.tx+" ty:"+this.ty},t.prototype.copyFrom=function(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.tx=t.tx,this.ty=t.ty,this},t.prototype.copyFromArray=function(t,e){return void 0===e&&(e=0),this.a=t[e],this.b=t[e+1],this.c=t[e+2],this.d=t[e+3],this.tx=t[e+4],this.ty=t[e+5],this},t.prototype.identity=function(){return this.a=this.d=1,this.b=this.c=0,this.tx=this.ty=0,this},t.prototype.concat=function(t){var e=this.a*t.a,i=0,n=0,s=this.d*t.d,r=this.tx*t.a+t.tx,o=this.ty*t.d+t.ty;return 0===this.b&&0===this.c||(e+=this.b*t.c,i+=this.b*t.d,n+=this.c*t.a,s+=this.c*t.b),0===t.b&&0===t.c||(i+=this.a*t.b,n+=this.d*t.c,r+=this.ty*t.c,o+=this.tx*t.b),this.a=e,this.b=i,this.c=n,this.d=s,this.tx=r,this.ty=o,this},t.prototype.invert=function(){var t=this.a,e=this.b,i=this.c,n=this.d,s=this.tx,r=this.ty;if(0===e&&0===i)return this.b=this.c=0,0===t||0===n?this.a=this.b=this.tx=this.ty=0:(t=this.a=1/t,n=this.d=1/n,this.tx=-t*s,this.ty=-n*r),this;var o=t*n-e*i;if(0===o)return this.a=this.d=1,this.b=this.c=0,this.tx=this.ty=0,this;o=1/o;var a=this.a=n*o;return e=this.b=-e*o,i=this.c=-i*o,n=this.d=t*o,this.tx=-(a*s+i*r),this.ty=-(e*s+n*r),this},t.prototype.transformPoint=function(t,e,i,n){void 0===n&&(n=!1),i.x=this.a*t+this.c*e,i.y=this.b*t+this.d*e,n||(i.x+=this.tx,i.y+=this.ty)},t.prototype.transformRectangle=function(t,e){void 0===e&&(e=!1);var i=this.a,n=this.b,s=this.c,r=this.d,o=e?0:this.tx,a=e?0:this.ty,c=t.x,l=t.y,h=c+t.width,_=l+t.height,u=i*c+s*l+o,d=n*c+r*l+a,m=i*h+s*l+o,p=n*h+r*l+a,f=i*h+s*_+o,g=n*h+r*_+a,v=i*c+s*_+o,y=n*c+r*_+a,x=0;u>m&&(x=u,u=m,m=x),f>v&&(x=f,f=v,v=x),t.x=Math.floor(u<f?u:f),t.width=Math.ceil((m>v?m:v)-t.x),d>p&&(x=d,d=p,p=x),g>y&&(x=g,g=y,y=x),t.y=Math.floor(d<g?d:g),t.height=Math.ceil((p>y?p:y)-t.y)},t}();t.Matrix=e}(R$||(R$={})),function(t){var e=function(){function t(t,e,i,n,s,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===s&&(s=1),void 0===r&&(r=1),this.x=t,this.y=e,this.skew=i,this.rotation=n,this.scaleX=s,this.scaleY=r}return t.normalizeRadian=function(t){return(t=(t+Math.PI)%(2*Math.PI))+(t>0?-Math.PI:Math.PI)},t.prototype.toString=function(){return"[object dragonBones.Transform] x:"+this.x+" y:"+this.y+" skewX:"+180*this.skew/Math.PI+" skewY:"+180*this.rotation/Math.PI+" scaleX:"+this.scaleX+" scaleY:"+this.scaleY},t.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.skew=t.skew,this.rotation=t.rotation,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this},t.prototype.identity=function(){return this.x=this.y=0,this.skew=this.rotation=0,this.scaleX=this.scaleY=1,this},t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this.skew+=t.skew,this.rotation+=t.rotation,this.scaleX*=t.scaleX,this.scaleY*=t.scaleY,this},t.prototype.minus=function(t){return this.x-=t.x,this.y-=t.y,this.skew-=t.skew,this.rotation-=t.rotation,this.scaleX/=t.scaleX,this.scaleY/=t.scaleY,this},t.prototype.fromMatrix=function(e){var i=this.scaleX,n=this.scaleY,s=t.PI_Q;this.x=e.tx,this.y=e.ty,this.rotation=Math.atan(e.b/e.a);var r=Math.atan(-e.c/e.d);return this.scaleX=this.rotation>-s&&this.rotation<s?e.a/Math.cos(this.rotation):e.b/Math.sin(this.rotation),this.scaleY=r>-s&&r<s?e.d/Math.cos(r):-e.c/Math.sin(r),i>=0&&this.scaleX<0&&(this.scaleX=-this.scaleX,this.rotation=this.rotation-Math.PI),n>=0&&this.scaleY<0&&(this.scaleY=-this.scaleY,r-=Math.PI),this.skew=r-this.rotation,this},t.prototype.toMatrix=function(t){return 0===this.rotation?(t.a=1,t.b=0):(t.a=Math.cos(this.rotation),t.b=Math.sin(this.rotation)),0===this.skew?(t.c=-t.b,t.d=t.a):(t.c=-Math.sin(this.skew+this.rotation),t.d=Math.cos(this.skew+this.rotation)),1!==this.scaleX&&(t.a*=this.scaleX,t.b*=this.scaleX),1!==this.scaleY&&(t.c*=this.scaleY,t.d*=this.scaleY),t.tx=this.x,t.ty=this.y,this},t.PI=Math.PI,t.PI_D=2*Math.PI,t.PI_H=Math.PI/2,t.PI_Q=Math.PI/4,t.RAD_DEG=180/Math.PI,t.DEG_RAD=Math.PI/180,t}();t.Transform=e}(R$||(R$={})),function(t){var e=function(){function t(t,e,i,n,s,r,o,a){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=1),void 0===n&&(n=1),void 0===s&&(s=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.alphaMultiplier=t,this.redMultiplier=e,this.greenMultiplier=i,this.blueMultiplier=n,this.alphaOffset=s,this.redOffset=r,this.greenOffset=o,this.blueOffset=a}return t.prototype.copyFrom=function(t){this.alphaMultiplier=t.alphaMultiplier,this.redMultiplier=t.redMultiplier,this.greenMultiplier=t.greenMultiplier,this.blueMultiplier=t.blueMultiplier,this.alphaOffset=t.alphaOffset,this.redOffset=t.redOffset,this.greenOffset=t.greenOffset,this.blueOffset=t.blueOffset},t.prototype.identity=function(){this.alphaMultiplier=this.redMultiplier=this.greenMultiplier=this.blueMultiplier=1,this.alphaOffset=this.redOffset=this.greenOffset=this.blueOffset=0},t}();t.ColorTransform=e}(R$||(R$={})),function(t){var e=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y},t.prototype.clear=function(){this.x=this.y=0},t}();t.Point=e}(R$||(R$={})),function(t){var e=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=t,this.y=e,this.width=i,this.height=n}return t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},t.prototype.clear=function(){this.x=this.y=0,this.width=this.height=0},t}();t.Rectangle=e}(R$||(R$={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.ints=[],e.floats=[],e.strings=[],e}return I$(e,t),e.toString=function(){return"[class dragonBones.UserData]"},e.prototype._onClear=function(){this.ints.length=0,this.floats.length=0,this.strings.length=0},e.prototype.addInt=function(t){this.ints.push(t)},e.prototype.addFloat=function(t){this.floats.push(t)},e.prototype.addString=function(t){this.strings.push(t)},e.prototype.getInt=function(t){return void 0===t&&(t=0),t>=0&&t<this.ints.length?this.ints[t]:0},e.prototype.getFloat=function(t){return void 0===t&&(t=0),t>=0&&t<this.floats.length?this.floats[t]:0},e.prototype.getString=function(t){return void 0===t&&(t=0),t>=0&&t<this.strings.length?this.strings[t]:""},e}(t.BaseObject);t.UserData=e;var i=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.data=null,e}return I$(e,t),e.toString=function(){return"[class dragonBones.ActionData]"},e.prototype._onClear=function(){null!==this.data&&this.data.returnToPool(),this.type=0,this.name="",this.bone=null,this.slot=null,this.data=null},e}(t.BaseObject);t.ActionData=i}(R$||(R$={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.frameIndices=[],e.cachedFrames=[],e.armatureNames=[],e.armatures={},e.userData=null,e}return I$(e,t),e.toString=function(){return"[class dragonBones.DragonBonesData]"},e.prototype._onClear=function(){for(var t in this.armatures)this.armatures[t].returnToPool(),delete this.armatures[t];null!==this.userData&&this.userData.returnToPool(),this.autoSearch=!1,this.frameRate=0,this.version="",this.name="",this.stage=null,this.frameIndices.length=0,this.cachedFrames.length=0,this.armatureNames.length=0,this.binary=null,this.intArray=null,this.floatArray=null,this.frameIntArray=null,this.frameFloatArray=null,this.frameArray=null,this.timelineArray=null,this.userData=null},e.prototype.addArmature=function(t){t.name in this.armatures?console.warn("Same armature: "+t.name):(t.parent=this,this.armatures[t.name]=t,this.armatureNames.push(t.name))},e.prototype.getArmature=function(t){return t in this.armatures?this.armatures[t]:null},e.prototype.dispose=function(){console.warn("已废弃"),this.returnToPool()},e}(t.BaseObject);t.DragonBonesData=e}(R$||(R$={})),function(t){var e=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.aabb=new t.Rectangle,i.animationNames=[],i.sortedBones=[],i.sortedSlots=[],i.defaultActions=[],i.actions=[],i.bones={},i.slots={},i.constraints={},i.skins={},i.animations={},i.canvas=null,i.userData=null,i}return I$(i,e),i.toString=function(){return"[class dragonBones.ArmatureData]"},i.prototype._onClear=function(){for(var t=0,e=this.defaultActions;t<e.length;t++)e[t].returnToPool();for(var i=0,n=this.actions;i<n.length;i++)n[i].returnToPool();for(var s in this.bones)this.bones[s].returnToPool(),delete this.bones[s];for(var s in this.slots)this.slots[s].returnToPool(),delete this.slots[s];for(var s in this.constraints)this.constraints[s].returnToPool(),delete this.constraints[s];for(var s in this.skins)this.skins[s].returnToPool(),delete this.skins[s];for(var s in this.animations)this.animations[s].returnToPool(),delete this.animations[s];null!==this.canvas&&this.canvas.returnToPool(),null!==this.userData&&this.userData.returnToPool(),this.type=0,this.frameRate=0,this.cacheFrameRate=0,this.scale=1,this.name="",this.aabb.clear(),this.animationNames.length=0,this.sortedBones.length=0,this.sortedSlots.length=0,this.defaultActions.length=0,this.actions.length=0,this.defaultSkin=null,this.defaultAnimation=null,this.canvas=null,this.userData=null,this.parent=null},i.prototype.sortBones=function(){var t=this.sortedBones.length;if(!(t<=0)){var e=this.sortedBones.concat(),i=0,n=0;for(this.sortedBones.length=0;n<t;){var s=e[i++];if(i>=t&&(i=0),!(this.sortedBones.indexOf(s)>=0)){var r=!1;for(var o in this.constraints){var a=this.constraints[o];if(a.root===s&&this.sortedBones.indexOf(a.target)<0){r=!0;break}}r||null!==s.parent&&this.sortedBones.indexOf(s.parent)<0||(this.sortedBones.push(s),n++)}}}},i.prototype.cacheFrames=function(t){if(!(this.cacheFrameRate>0))for(var e in this.cacheFrameRate=t,this.animations)this.animations[e].cacheFrames(this.cacheFrameRate)},i.prototype.setCacheFrame=function(t,e){var i=this.parent.cachedFrames,n=i.length;return i.length+=10,i[n]=t.a,i[n+1]=t.b,i[n+2]=t.c,i[n+3]=t.d,i[n+4]=t.tx,i[n+5]=t.ty,i[n+6]=e.rotation,i[n+7]=e.skew,i[n+8]=e.scaleX,i[n+9]=e.scaleY,n},i.prototype.getCacheFrame=function(t,e,i){var n=this.parent.cachedFrames;t.a=n[i],t.b=n[i+1],t.c=n[i+2],t.d=n[i+3],t.tx=n[i+4],t.ty=n[i+5],e.rotation=n[i+6],e.skew=n[i+7],e.scaleX=n[i+8],e.scaleY=n[i+9],e.x=t.tx,e.y=t.ty},i.prototype.addBone=function(t){t.name in this.bones?console.warn("Same bone: "+t.name):(this.bones[t.name]=t,this.sortedBones.push(t))},i.prototype.addSlot=function(t){t.name in this.slots?console.warn("Same slot: "+t.name):(this.slots[t.name]=t,this.sortedSlots.push(t))},i.prototype.addConstraint=function(t){t.name in this.constraints?console.warn("Same constraint: "+t.name):this.constraints[t.name]=t},i.prototype.addSkin=function(t){t.name in this.skins?console.warn("Same skin: "+t.name):(t.parent=this,this.skins[t.name]=t,null===this.defaultSkin&&(this.defaultSkin=t),"default"===t.name&&(this.defaultSkin=t))},i.prototype.addAnimation=function(t){t.name in this.animations?console.warn("Same animation: "+t.name):(t.parent=this,this.animations[t.name]=t,this.animationNames.push(t.name),null===this.defaultAnimation&&(this.defaultAnimation=t))},i.prototype.addAction=function(t,e){e?this.defaultActions.push(t):this.actions.push(t)},i.prototype.getBone=function(t){return t in this.bones?this.bones[t]:null},i.prototype.getSlot=function(t){return t in this.slots?this.slots[t]:null},i.prototype.getConstraint=function(t){return t in this.constraints?this.constraints[t]:null},i.prototype.getSkin=function(t){return t in this.skins?this.skins[t]:null},i.prototype.getMesh=function(t,e,i){var n=this.getSkin(t);return null===n?null:n.getDisplay(e,i)},i.prototype.getAnimation=function(t){return t in this.animations?this.animations[t]:null},i}(t.BaseObject);t.ArmatureData=e;var i=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.transform=new t.Transform,i.userData=null,i}return I$(i,e),i.toString=function(){return"[class dragonBones.BoneData]"},i.prototype._onClear=function(){null!==this.userData&&this.userData.returnToPool(),this.inheritTranslation=!1,this.inheritRotation=!1,this.inheritScale=!1,this.inheritReflection=!1,this.type=0,this.length=0,this.name="",this.transform.identity(),this.userData=null,this.parent=null},i}(t.BaseObject);t.BoneData=i;var n=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.vertices=[],e}return I$(e,t),e.toString=function(){return"[class dragonBones.SurfaceData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=1,this.segmentX=0,this.segmentY=0,this.vertices.length=0},e}(i);t.SurfaceData=n;var s=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t.color=null,t.userData=null,t}return I$(i,e),i.createColor=function(){return new t.ColorTransform},i.toString=function(){return"[class dragonBones.SlotData]"},i.prototype._onClear=function(){null!==this.userData&&this.userData.returnToPool(),this.blendMode=0,this.displayIndex=0,this.zOrder=0,this.name="",this.color=null,this.userData=null,this.parent=null},i.DEFAULT_COLOR=new t.ColorTransform,i}(t.BaseObject);t.SlotData=s}(R$||(R$={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.prototype._onClear=function(){this.order=0,this.name="",this.type=0,this.target=null,this.root=null,this.bone=null},e}(t.BaseObject);t.ConstraintData=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.toString=function(){return"[class dragonBones.IKConstraintData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.scaleEnabled=!1,this.bendPositive=!1,this.weight=1},e}(e);t.IKConstraintData=i;var n=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.bones=[],e}return I$(e,t),e.toString=function(){return"[class dragonBones.PathConstraintData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.pathSlot=null,this.pathDisplayData=null,this.bones.length=0,this.positionMode=0,this.spacingMode=1,this.rotateMode=1,this.position=0,this.spacing=0,this.rotateOffset=0,this.rotateMix=0,this.translateMix=0},e.prototype.AddBone=function(t){this.bones.push(t)},e}(e);t.PathConstraintData=n}(R$||(R$={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.toString=function(){return"[class dragonBones.CanvasData]"},e.prototype._onClear=function(){this.hasBackground=!1,this.color=0,this.x=0,this.y=0,this.width=0,this.height=0},e}(t.BaseObject);t.CanvasData=e}(R$||(R$={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.displays={},e}return I$(e,t),e.toString=function(){return"[class dragonBones.SkinData]"},e.prototype._onClear=function(){for(var t in this.displays){for(var e=0,i=this.displays[t];e<i.length;e++){var n=i[e];null!==n&&n.returnToPool()}delete this.displays[t]}this.name="",this.parent=null},e.prototype.addDisplay=function(t,e){t in this.displays||(this.displays[t]=[]),null!==e&&(e.parent=this),this.displays[t].push(e)},e.prototype.getDisplay=function(t,e){var i=this.getDisplays(t);if(null!==i)for(var n=0,s=i;n<s.length;n++){var r=s[n];if(null!==r&&r.name===e)return r}return null},e.prototype.getDisplays=function(t){return t in this.displays?this.displays[t]:null},e}(t.BaseObject);t.SkinData=e}(R$||(R$={})),function(t){var e=function(){function t(){this.weight=null}return t.prototype.clear=function(){this.isShared||null===this.weight||this.weight.returnToPool(),this.isShared=!1,this.inheritDeform=!1,this.offset=0,this.data=null,this.weight=null},t.prototype.shareFrom=function(t){this.isShared=!0,this.offset=t.offset,this.weight=t.weight},t}();t.VerticesData=e;var i=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.transform=new t.Transform,i}return I$(i,e),i.prototype._onClear=function(){this.name="",this.path="",this.transform.identity(),this.parent=null},i}(t.BaseObject);t.DisplayData=i;var n=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.pivot=new t.Point,i}return I$(i,e),i.toString=function(){return"[class dragonBones.ImageDisplayData]"},i.prototype._onClear=function(){e.prototype._onClear.call(this),this.type=0,this.pivot.clear(),this.texture=null},i}(i);t.ImageDisplayData=n;var s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.actions=[],e}return I$(e,t),e.toString=function(){return"[class dragonBones.ArmatureDisplayData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this);for(var e=0,i=this.actions;e<i.length;e++)i[e].returnToPool();this.type=1,this.inheritAnimation=!1,this.actions.length=0,this.armature=null},e.prototype.addAction=function(t){this.actions.push(t)},e}(i);t.ArmatureDisplayData=s;var r=function(t){function i(){var i=null!==t&&t.apply(this,arguments)||this;return i.vertices=new e,i}return I$(i,t),i.toString=function(){return"[class dragonBones.MeshDisplayData]"},i.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=2,this.vertices.clear(),this.texture=null},i}(i);t.MeshDisplayData=r;var o=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.boundingBox=null,e}return I$(e,t),e.toString=function(){return"[class dragonBones.BoundingBoxDisplayData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),null!==this.boundingBox&&this.boundingBox.returnToPool(),this.type=3,this.boundingBox=null},e}(i);t.BoundingBoxDisplayData=o;var a=function(t){function i(){var i=null!==t&&t.apply(this,arguments)||this;return i.vertices=new e,i.curveLengths=[],i}return I$(i,t),i.toString=function(){return"[class dragonBones.PathDisplayData]"},i.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=4,this.closed=!1,this.constantSpeed=!1,this.vertices.clear(),this.curveLengths.length=0},i}(i);t.PathDisplayData=a;var c=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.bones=[],e}return I$(e,t),e.toString=function(){return"[class dragonBones.WeightData]"},e.prototype._onClear=function(){this.count=0,this.offset=0,this.bones.length=0},e.prototype.addBone=function(t){this.bones.push(t)},e}(t.BaseObject);t.WeightData=c}(R$||(R$={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.prototype._onClear=function(){this.color=0,this.width=0,this.height=0},e}(t.BaseObject);t.BoundingBoxData=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.toString=function(){return"[class dragonBones.RectangleBoundingBoxData]"},e._computeOutCode=function(t,e,i,n,s,r){var o=0;return t<i?o|=1:t>s&&(o|=2),e<n?o|=4:e>r&&(o|=8),o},e.rectangleIntersectsSegment=function(t,i,n,s,r,o,a,c,l,h,_){void 0===l&&(l=null),void 0===h&&(h=null),void 0===_&&(_=null);var u=t>r&&t<a&&i>o&&i<c,d=n>r&&n<a&&s>o&&s<c;if(u&&d)return-1;for(var m=0,p=e._computeOutCode(t,i,r,o,a,c),f=e._computeOutCode(n,s,r,o,a,c);;){if(0==(p|f)){m=2;break}if(0!=(p&f))break;var g=0,v=0,y=0,x=0!==p?p:f;0!=(4&x)?(g=t+(n-t)*(o-i)/(s-i),v=o,null!==_&&(y=.5*-Math.PI)):0!=(8&x)?(g=t+(n-t)*(c-i)/(s-i),v=c,null!==_&&(y=.5*Math.PI)):0!=(2&x)?(v=i+(s-i)*(a-t)/(n-t),g=a,null!==_&&(y=0)):0!=(1&x)&&(v=i+(s-i)*(r-t)/(n-t),g=r,null!==_&&(y=Math.PI)),x===p?(t=g,i=v,p=e._computeOutCode(t,i,r,o,a,c),null!==_&&(_.x=y)):(n=g,s=v,f=e._computeOutCode(n,s,r,o,a,c),null!==_&&(_.y=y))}return m&&(u?(m=2,null!==l&&(l.x=n,l.y=s),null!==h&&(h.x=n,h.y=n),null!==_&&(_.x=_.y+Math.PI)):d?(m=1,null!==l&&(l.x=t,l.y=i),null!==h&&(h.x=t,h.y=i),null!==_&&(_.y=_.x+Math.PI)):(m=3,null!==l&&(l.x=t,l.y=i),null!==h&&(h.x=n,h.y=s))),m},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=0},e.prototype.containsPoint=function(t,e){var i=.5*this.width;if(t>=-i&&t<=i){var n=.5*this.height;if(e>=-n&&e<=n)return!0}return!1},e.prototype.intersectsSegment=function(t,i,n,s,r,o,a){void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null);var c=.5*this.width,l=.5*this.height;return e.rectangleIntersectsSegment(t,i,n,s,-c,-l,c,l,r,o,a)},e}(e);t.RectangleBoundingBoxData=i;var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.toString=function(){return"[class dragonBones.EllipseData]"},e.ellipseIntersectsSegment=function(t,e,i,n,s,r,o,a,c,l,h){void 0===c&&(c=null),void 0===l&&(l=null),void 0===h&&(h=null);var _=o/a,u=_*_,d=i-t,m=(n*=_)-(e*=_),p=Math.sqrt(d*d+m*m),f=d/p,g=m/p,v=(s-t)*f+(r-e)*g,y=o*o,x=y-(t*t+e*e)+v*v,S=0;if(x>=0){var C=Math.sqrt(x),A=v-C,b=v+C,T=A<0?-1:A<=p?0:1,E=b<0?-1:b<=p?0:1,P=T*E;if(P<0)return-1;0===P&&(-1===T?(S=2,i=t+b*f,n=(e+b*g)/_,null!==c&&(c.x=i,c.y=n),null!==l&&(l.x=i,l.y=n),null!==h&&(h.x=Math.atan2(n/y*u,i/y),h.y=h.x+Math.PI)):1===E?(S=1,t+=A*f,e=(e+A*g)/_,null!==c&&(c.x=t,c.y=e),null!==l&&(l.x=t,l.y=e),null!==h&&(h.x=Math.atan2(e/y*u,t/y),h.y=h.x+Math.PI)):(S=3,null!==c&&(c.x=t+A*f,c.y=(e+A*g)/_,null!==h&&(h.x=Math.atan2(c.y/y*u,c.x/y))),null!==l&&(l.x=t+b*f,l.y=(e+b*g)/_,null!==h&&(h.y=Math.atan2(l.y/y*u,l.x/y)))))}return S},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=1},e.prototype.containsPoint=function(t,e){var i=.5*this.width;if(t>=-i&&t<=i){var n=.5*this.height;if(e>=-n&&e<=n)return e*=i/n,Math.sqrt(t*t+e*e)<=i}return!1},e.prototype.intersectsSegment=function(t,i,n,s,r,o,a){return void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null),e.ellipseIntersectsSegment(t,i,n,s,0,0,.5*this.width,.5*this.height,r,o,a)},e}(e);t.EllipseBoundingBoxData=n;var s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.vertices=[],e}return I$(e,t),e.toString=function(){return"[class dragonBones.PolygonBoundingBoxData]"},e.polygonIntersectsSegment=function(t,e,i,n,s,r,o,a){void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null),t===i&&(t=i+1e-6),e===n&&(e=n+1e-6);for(var c=s.length,l=t-i,h=e-n,_=t*n-e*i,u=0,d=s[c-2],m=s[c-1],p=0,f=0,g=0,v=0,y=0,x=0,S=0;S<c;S+=2){var C=s[S],A=s[S+1];d===C&&(d=C+1e-4),m===A&&(m=A+1e-4);var b=d-C,T=m-A,E=d*A-m*C,P=l*T-h*b,w=(_*b-l*E)/P;if((w>=d&&w<=C||w>=C&&w<=d)&&(0===l||w>=t&&w<=i||w>=i&&w<=t)){var I=(_*T-h*E)/P;if((I>=m&&I<=A||I>=A&&I<=m)&&(0===h||I>=e&&I<=n||I>=n&&I<=e)){if(null===o){g=w,v=I,y=w,x=I,u++,null!==a&&(a.x=Math.atan2(A-m,C-d)-.5*Math.PI,a.y=a.x);break}var R=w-t;R<0&&(R=-R),0===u?(p=R,f=R,g=w,v=I,y=w,x=I,null!==a&&(a.x=Math.atan2(A-m,C-d)-.5*Math.PI,a.y=a.x)):(R<p&&(p=R,g=w,v=I,null!==a&&(a.x=Math.atan2(A-m,C-d)-.5*Math.PI)),R>f&&(f=R,y=w,x=I,null!==a&&(a.y=Math.atan2(A-m,C-d)-.5*Math.PI))),u++}}d=C,m=A}return 1===u?(null!==r&&(r.x=g,r.y=v),null!==o&&(o.x=g,o.y=v),null!==a&&(a.y=a.x+Math.PI)):u>1&&(u++,null!==r&&(r.x=g,r.y=v),null!==o&&(o.x=y,o.y=x)),u},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=2,this.x=0,this.y=0,this.vertices.length=0},e.prototype.containsPoint=function(t,e){var i=!1;if(t>=this.x&&t<=this.width&&e>=this.y&&e<=this.height)for(var n=0,s=this.vertices.length,r=s-2;n<s;n+=2){var o=this.vertices[r+1],a=this.vertices[n+1];if(a<e&&o>=e||o<e&&a>=e){var c=this.vertices[r],l=this.vertices[n];(e-a)*(c-l)/(o-a)+l<t&&(i=!i)}r=n}return i},e.prototype.intersectsSegment=function(t,n,s,r,o,a,c){void 0===o&&(o=null),void 0===a&&(a=null),void 0===c&&(c=null);var l=0;return 0!==i.rectangleIntersectsSegment(t,n,s,r,this.x,this.y,this.x+this.width,this.y+this.height,null,null,null)&&(l=e.polygonIntersectsSegment(t,n,s,r,this.vertices,o,a,c)),l},e}(e);t.PolygonBoundingBoxData=s}(R$||(R$={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.cachedFrames=[],e.boneTimelines={},e.surfaceTimelines={},e.slotTimelines={},e.constraintTimelines={},e.animationTimelines={},e.boneCachedFrameIndices={},e.slotCachedFrameIndices={},e.actionTimeline=null,e.zOrderTimeline=null,e}return I$(e,t),e.toString=function(){return"[class dragonBones.AnimationData]"},e.prototype._onClear=function(){for(var t in this.boneTimelines){for(var e=0,i=this.boneTimelines[t];e<i.length;e++)i[e].returnToPool();delete this.boneTimelines[t]}for(var t in this.surfaceTimelines){for(var n=0,s=this.surfaceTimelines[t];n<s.length;n++)s[n].returnToPool();delete this.surfaceTimelines[t]}for(var t in this.slotTimelines){for(var r=0,o=this.slotTimelines[t];r<o.length;r++)o[r].returnToPool();delete this.slotTimelines[t]}for(var t in this.constraintTimelines){for(var a=0,c=this.constraintTimelines[t];a<c.length;a++)c[a].returnToPool();delete this.constraintTimelines[t]}for(var t in this.animationTimelines){for(var l=0,h=this.animationTimelines[t];l<h.length;l++)h[l].returnToPool();delete this.animationTimelines[t]}for(var t in this.boneCachedFrameIndices)delete this.boneCachedFrameIndices[t];for(var t in this.slotCachedFrameIndices)delete this.slotCachedFrameIndices[t];null!==this.actionTimeline&&this.actionTimeline.returnToPool(),null!==this.zOrderTimeline&&this.zOrderTimeline.returnToPool(),this.frameIntOffset=0,this.frameFloatOffset=0,this.frameOffset=0,this.frameCount=0,this.playTimes=0,this.duration=0,this.scale=1,this.fadeInTime=0,this.cacheFrameRate=0,this.name="",this.cachedFrames.length=0,this.actionTimeline=null,this.zOrderTimeline=null,this.parent=null},e.prototype.cacheFrames=function(t){if(!(this.cacheFrameRate>0)){this.cacheFrameRate=Math.max(Math.ceil(t*this.scale),1);var e=Math.ceil(this.cacheFrameRate*this.duration)+1;this.cachedFrames.length=e;for(var i=0,n=this.cacheFrames.length;i<n;++i)this.cachedFrames[i]=!1;for(var s=0,r=this.parent.sortedBones;s<r.length;s++){var o=r[s];for(i=0,n=(l=new Array(e)).length;i<n;++i)l[i]=-1;this.boneCachedFrameIndices[o.name]=l}for(var a=0,c=this.parent.sortedSlots;a<c.length;a++){var l,h=c[a];for(i=0,n=(l=new Array(e)).length;i<n;++i)l[i]=-1;this.slotCachedFrameIndices[h.name]=l}}},e.prototype.addBoneTimeline=function(t,e){var i=t.name in this.boneTimelines?this.boneTimelines[t.name]:this.boneTimelines[t.name]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.addSurfaceTimeline=function(t,e){var i=t.name in this.surfaceTimelines?this.surfaceTimelines[t.name]:this.surfaceTimelines[t.name]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.addSlotTimeline=function(t,e){var i=t.name in this.slotTimelines?this.slotTimelines[t.name]:this.slotTimelines[t.name]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.addConstraintTimeline=function(t,e){var i=t.name in this.constraintTimelines?this.constraintTimelines[t.name]:this.constraintTimelines[t.name]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.addAnimationTimeline=function(t,e){var i=t in this.animationTimelines?this.animationTimelines[t]:this.animationTimelines[t]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.getBoneTimelines=function(t){return t in this.boneTimelines?this.boneTimelines[t]:null},e.prototype.getSurfaceTimelines=function(t){return t in this.surfaceTimelines?this.surfaceTimelines[t]:null},e.prototype.getSlotTimelines=function(t){return t in this.slotTimelines?this.slotTimelines[t]:null},e.prototype.getConstraintTimelines=function(t){return t in this.constraintTimelines?this.constraintTimelines[t]:null},e.prototype.getAnimationTimelines=function(t){return t in this.animationTimelines?this.animationTimelines[t]:null},e.prototype.getBoneCachedFrameIndices=function(t){return t in this.boneCachedFrameIndices?this.boneCachedFrameIndices[t]:null},e.prototype.getSlotCachedFrameIndices=function(t){return t in this.slotCachedFrameIndices?this.slotCachedFrameIndices[t]:null},e}(t.BaseObject);t.AnimationData=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.toString=function(){return"[class dragonBones.TimelineData]"},e.prototype._onClear=function(){this.type=10,this.offset=0,this.frameIndicesOffset=-1},e}(t.BaseObject);t.TimelineData=i}(R$||(R$={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.boneMask=[],e}return I$(e,t),e.toString=function(){return"[class dragonBones.AnimationConfig]"},e.prototype._onClear=function(){this.pauseFadeOut=!0,this.fadeOutMode=4,this.fadeOutTweenType=1,this.fadeOutTime=-1,this.actionEnabled=!0,this.additiveBlending=!1,this.displayControl=!0,this.pauseFadeIn=!0,this.resetToPose=!0,this.fadeInTweenType=1,this.playTimes=-1,this.layer=0,this.position=0,this.duration=-1,this.timeScale=-100,this.weight=1,this.fadeInTime=-1,this.autoFadeOutTime=-1,this.name="",this.animation="",this.group="",this.boneMask.length=0},e.prototype.clear=function(){this._onClear()},e.prototype.copyFrom=function(t){this.pauseFadeOut=t.pauseFadeOut,this.fadeOutMode=t.fadeOutMode,this.autoFadeOutTime=t.autoFadeOutTime,this.fadeOutTweenType=t.fadeOutTweenType,this.actionEnabled=t.actionEnabled,this.additiveBlending=t.additiveBlending,this.displayControl=t.displayControl,this.pauseFadeIn=t.pauseFadeIn,this.resetToPose=t.resetToPose,this.playTimes=t.playTimes,this.layer=t.layer,this.position=t.position,this.duration=t.duration,this.timeScale=t.timeScale,this.fadeInTime=t.fadeInTime,this.fadeOutTime=t.fadeOutTime,this.fadeInTweenType=t.fadeInTweenType,this.weight=t.weight,this.name=t.name,this.animation=t.animation,this.group=t.group,this.boneMask.length=t.boneMask.length;for(var e=0,i=this.boneMask.length;e<i;++e)this.boneMask[e]=t.boneMask[e]},e.prototype.containsBoneMask=function(t){return 0===this.boneMask.length||this.boneMask.indexOf(t)>=0},e.prototype.addBoneMask=function(t,e,i){void 0===i&&(i=!0);var n=t.getBone(e);if(null!==n&&(this.boneMask.indexOf(e)<0&&this.boneMask.push(e),i))for(var s=0,r=t.getBones();s<r.length;s++){var o=r[s];this.boneMask.indexOf(o.name)<0&&n.contains(o)&&this.boneMask.push(o.name)}},e.prototype.removeBoneMask=function(t,e,i){void 0===i&&(i=!0);var n=this.boneMask.indexOf(e);if(n>=0&&this.boneMask.splice(n,1),i){var s=t.getBone(e);if(null!==s)if(this.boneMask.length>0)for(var r=0,o=t.getBones();r<o.length;r++){var a=o[r],c=this.boneMask.indexOf(a.name);c>=0&&s.contains(a)&&this.boneMask.splice(c,1)}else for(var l=0,h=t.getBones();l<h.length;l++)(a=h[l])!==s&&(s.contains(a)||this.boneMask.push(a.name))}},e}(t.BaseObject);t.AnimationConfig=e}(R$||(R$={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.textures={},e}return I$(e,t),e.prototype._onClear=function(){for(var t in this.textures)this.textures[t].returnToPool(),delete this.textures[t];this.autoSearch=!1,this.width=0,this.height=0,this.scale=1,this.name="",this.imagePath=""},e.prototype.copyFrom=function(t){for(var e in this.autoSearch=t.autoSearch,this.scale=t.scale,this.width=t.width,this.height=t.height,this.name=t.name,this.imagePath=t.imagePath,this.textures)this.textures[e].returnToPool(),delete this.textures[e];for(var e in t.textures){var i=this.createTexture();i.copyFrom(t.textures[e]),this.textures[e]=i}},e.prototype.addTexture=function(t){t.name in this.textures?console.warn("Same texture: "+t.name):(t.parent=this,this.textures[t.name]=t)},e.prototype.getTexture=function(t){return t in this.textures?this.textures[t]:null},e}(t.BaseObject);t.TextureAtlasData=e;var i=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.region=new t.Rectangle,i.frame=null,i}return I$(i,e),i.createRectangle=function(){return new t.Rectangle},i.prototype._onClear=function(){this.rotated=!1,this.name="",this.region.clear(),this.parent=null,this.frame=null},i.prototype.copyFrom=function(t){this.rotated=t.rotated,this.name=t.name,this.region.copyFrom(t.region),this.parent=t.parent,null===this.frame&&null!==t.frame?this.frame=i.createRectangle():null!==this.frame&&null===t.frame&&(this.frame=null),null!==this.frame&&null!==t.frame&&this.frame.copyFrom(t.frame)},i}(t.BaseObject);t.TextureData=i}(R$||(R$={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.vertices=[],e.bones=[],e}return I$(e,t),e.toString=function(){return"[class dragonBones.DeformVertices]"},e.prototype._onClear=function(){this.verticesDirty=!1,this.vertices.length=0,this.bones.length=0,this.verticesData=null},e.prototype.init=function(t,e){if(this.verticesData=t,null!==this.verticesData){var i;i=null!==this.verticesData.weight?2*this.verticesData.weight.count:2*this.verticesData.data.intArray[this.verticesData.offset+0],this.verticesDirty=!0,this.vertices.length=i,this.bones.length=0;for(var n=0,s=this.vertices.length;n<s;++n)this.vertices[n]=0;if(null!==this.verticesData.weight)for(n=0,s=this.verticesData.weight.bones.length;n<s;++n){var r=e.getBone(this.verticesData.weight.bones[n].name);this.bones.push(r)}}else this.verticesDirty=!1,this.vertices.length=0,this.bones.length=0,this.verticesData=null},e.prototype.isBonesUpdate=function(){for(var t=0,e=this.bones;t<e.length;t++){var i=e[t];if(null!==i&&i._childrenTransformDirty)return!0}return!1},e}(t.BaseObject);t.DeformVertices=e}(R$||(R$={})),function(t){var e=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t._bones=[],t._slots=[],t._constraints=[],t._actions=[],t._animation=null,t._proxy=null,t._replaceTextureAtlasData=null,t._clock=null,t}return I$(i,e),i.toString=function(){return"[class dragonBones.Armature]"},i._onSortSlots=function(t,e){return t._zOrder>e._zOrder?1:-1},i.prototype._onClear=function(){null!==this._clock&&this._clock.remove(this);for(var t=0,e=this._bones;t<e.length;t++)e[t].returnToPool();for(var i=0,n=this._slots;i<n.length;i++)n[i].returnToPool();for(var s=0,r=this._constraints;s<r.length;s++)r[s].returnToPool();for(var o=0,a=this._actions;o<a.length;o++)a[o].returnToPool();null!==this._animation&&this._animation.returnToPool(),null!==this._proxy&&this._proxy.dbClear(),null!==this._replaceTextureAtlasData&&this._replaceTextureAtlasData.returnToPool(),this.inheritAnimation=!0,this.userData=null,this._lockUpdate=!1,this._slotsDirty=!0,this._zOrderDirty=!1,this._flipX=!1,this._flipY=!1,this._cacheFrameIndex=-1,this._bones.length=0,this._slots.length=0,this._constraints.length=0,this._actions.length=0,this._armatureData=null,this._animation=null,this._proxy=null,this._display=null,this._replaceTextureAtlasData=null,this._replacedTexture=null,this._dragonBones=null,this._clock=null,this._parent=null},i.prototype._sortZOrder=function(t,e){var i=this._armatureData.sortedSlots,n=null===t;if(this._zOrderDirty||!n){for(var s=0,r=i.length;s<r;++s){var o=n?s:t[e+s];if(!(o<0||o>=r)){var a=i[o],c=this.getSlot(a.name);null!==c&&c._setZorder(s)}}this._slotsDirty=!0,this._zOrderDirty=!n}},i.prototype._addBone=function(t){this._bones.indexOf(t)<0&&this._bones.push(t)},i.prototype._addSlot=function(t){this._slots.indexOf(t)<0&&this._slots.push(t)},i.prototype._addConstraint=function(t){this._constraints.indexOf(t)<0&&this._constraints.push(t)},i.prototype._bufferAction=function(t,e){this._actions.indexOf(t)<0&&(e?this._actions.push(t):this._actions.unshift(t))},i.prototype.dispose=function(){null!==this._armatureData&&(this._lockUpdate=!0,this._dragonBones.bufferObject(this))},i.prototype.init=function(e,i,n,s){null===this._armatureData&&(this._armatureData=e,this._animation=t.BaseObject.borrowObject(t.Animation),this._proxy=i,this._display=n,this._dragonBones=s,this._proxy.dbInit(this),this._animation.init(this),this._animation.animations=this._armatureData.animations)},i.prototype.advanceTime=function(t){if(!this._lockUpdate)if(null!==this._armatureData)if(null!==this._armatureData.parent){var e=this._cacheFrameIndex;if(this._animation.advanceTime(t),this._slotsDirty&&(this._slotsDirty=!1,this._slots.sort(i._onSortSlots)),this._cacheFrameIndex<0||this._cacheFrameIndex!==e){var n=0,s=0;for(n=0,s=this._bones.length;n<s;++n)this._bones[n].update(this._cacheFrameIndex);for(n=0,s=this._slots.length;n<s;++n)this._slots[n].update(this._cacheFrameIndex)}if(this._actions.length>0){this._lockUpdate=!0;for(var r=0,o=this._actions;r<o.length;r++){var a=o[r],c=a.actionData;if(null!==c&&0===c.type)if(null!==a.slot)null!==(_=a.slot.childArmature)&&_.animation.fadeIn(c.name);else if(null!==a.bone)for(var l=0,h=this.getSlots();l<h.length;l++){var _,u=h[l];u.parent===a.bone&&null!==(_=u.childArmature)&&_.animation.fadeIn(c.name)}else this._animation.fadeIn(c.name);a.returnToPool()}this._actions.length=0,this._lockUpdate=!1}this._proxy.dbUpdate()}else console.warn("The armature data has been disposed.\nPlease make sure dispose armature before call factory.clear().");else console.warn("The armature has been disposed.")},i.prototype.invalidUpdate=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=!1),null!==t&&t.length>0){if(null!==(o=this.getBone(t))&&(o.invalidUpdate(),e))for(var i=0,n=this._slots;i<n.length;i++)(l=n[i]).parent===o&&l.invalidUpdate()}else{for(var s=0,r=this._bones;s<r.length;s++){var o;(o=r[s]).invalidUpdate()}if(e)for(var a=0,c=this._slots;a<c.length;a++){var l;(l=c[a]).invalidUpdate()}}},i.prototype.containsPoint=function(t,e){for(var i=0,n=this._slots;i<n.length;i++){var s=n[i];if(s.containsPoint(t,e))return s}return null},i.prototype.intersectsSegment=function(t,e,i,n,s,r,o){void 0===s&&(s=null),void 0===r&&(r=null),void 0===o&&(o=null);for(var a=t===i,c=0,l=0,h=0,_=0,u=0,d=0,m=0,p=0,f=null,g=null,v=0,y=this._slots;v<y.length;v++){var x=y[v];if(x.intersectsSegment(t,e,i,n,s,r,o)>0){if(null===s&&null===r){f=x;break}var S;null!==s&&((S=a?s.y-e:s.x-t)<0&&(S=-S),(null===f||S<c)&&(c=S,h=s.x,_=s.y,f=x,o&&(m=o.x))),null!==r&&((S=r.x-t)<0&&(S=-S),(null===g||S>l)&&(l=S,u=r.x,d=r.y,g=x,null!==o&&(p=o.y)))}}return null!==f&&null!==s&&(s.x=h,s.y=_,null!==o&&(o.x=m)),null!==g&&null!==r&&(r.x=u,r.y=d,null!==o&&(o.y=p)),f},i.prototype.getBone=function(t){for(var e=0,i=this._bones;e<i.length;e++){var n=i[e];if(n.name===t)return n}return null},i.prototype.getBoneByDisplay=function(t){var e=this.getSlotByDisplay(t);return null!==e?e.parent:null},i.prototype.getSlot=function(t){for(var e=0,i=this._slots;e<i.length;e++){var n=i[e];if(n.name===t)return n}return null},i.prototype.getSlotByDisplay=function(t){if(null!==t)for(var e=0,i=this._slots;e<i.length;e++){var n=i[e];if(n.display===t)return n}return null},i.prototype.getBones=function(){return this._bones},i.prototype.getSlots=function(){return this._slots},Object.defineProperty(i.prototype,"flipX",{get:function(){return this._flipX},set:function(t){this._flipX!==t&&(this._flipX=t,this.invalidUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"flipY",{get:function(){return this._flipY},set:function(t){this._flipY!==t&&(this._flipY=t,this.invalidUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"cacheFrameRate",{get:function(){return this._armatureData.cacheFrameRate},set:function(t){if(this._armatureData.cacheFrameRate!==t){this._armatureData.cacheFrames(t);for(var e=0,i=this._slots;e<i.length;e++){var n=i[e].childArmature;null!==n&&(n.cacheFrameRate=t)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return this._armatureData.name},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"armatureData",{get:function(){return this._armatureData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animation",{get:function(){return this._animation},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"proxy",{get:function(){return this._proxy},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"eventDispatcher",{get:function(){return this._proxy},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"display",{get:function(){return this._display},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"replacedTexture",{get:function(){return this._replacedTexture},set:function(t){if(this._replacedTexture!==t){null!==this._replaceTextureAtlasData&&(this._replaceTextureAtlasData.returnToPool(),this._replaceTextureAtlasData=null),this._replacedTexture=t;for(var e=0,i=this._slots;e<i.length;e++){var n=i[e];n.invalidUpdate(),n.update(-1)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"clock",{get:function(){return this._clock},set:function(t){if(this._clock!==t){null!==this._clock&&this._clock.remove(this),this._clock=t,this._clock&&this._clock.add(this);for(var e=0,i=this._slots;e<i.length;e++){var n=i[e].childArmature;null!==n&&(n.clock=this._clock)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),i.prototype.replaceTexture=function(t){this.replacedTexture=t},i.prototype.hasEventListener=function(t){return this._proxy.hasDBEventListener(t)},i.prototype.addEventListener=function(t,e,i){this._proxy.addDBEventListener(t,e,i)},i.prototype.removeEventListener=function(t,e,i){this._proxy.removeDBEventListener(t,e,i)},i.prototype.enableAnimationCache=function(t){console.warn("Deprecated."),this.cacheFrameRate=t},i.prototype.getDisplay=function(){return this._display},i}(t.BaseObject);t.Armature=e}(R$||(R$={})),function(t){var e=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.globalTransformMatrix=new t.Matrix,i.global=new t.Transform,i.offset=new t.Transform,i}return I$(i,e),i.prototype._onClear=function(){this.globalTransformMatrix.identity(),this.global.identity(),this.offset.identity(),this.origin=null,this.userData=null,this._globalDirty=!1,this._armature=null},i.prototype.updateGlobalTransform=function(){this._globalDirty&&(this._globalDirty=!1,this.global.fromMatrix(this.globalTransformMatrix))},Object.defineProperty(i.prototype,"armature",{get:function(){return this._armature},enumerable:!0,configurable:!0}),i._helpMatrix=new t.Matrix,i._helpTransform=new t.Transform,i._helpPoint=new t.Point,i}(t.BaseObject);t.TransformObject=e}(R$||(R$={})),function(t){var e=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.animationPose=new t.Transform,i._blendState=new t.BlendState,i}return I$(i,e),i.toString=function(){return"[class dragonBones.Bone]"},i.prototype._onClear=function(){e.prototype._onClear.call(this),this.offsetMode=1,this.animationPose.identity(),this._transformDirty=!1,this._childrenTransformDirty=!1,this._localDirty=!0,this._hasConstraint=!1,this._visible=!0,this._cachedFrameIndex=-1,this._blendState.clear(),this._boneData=null,this._parent=null,this._cachedFrameIndices=null},i.prototype._updateGlobalTransformMatrix=function(e){var i=this._boneData,n=this.global,s=this.globalTransformMatrix,r=this.origin,o=this.offset,a=this.animationPose,c=this._parent,l=this._armature.flipX,h=this._armature.flipY===t.DragonBones.yDown,_=null!==c,u=0;if(1===this.offsetMode?null!==r?(n.x=r.x+o.x+a.x,n.scaleX=r.scaleX*o.scaleX*a.scaleX,n.scaleY=r.scaleY*o.scaleY*a.scaleY,t.DragonBones.yDown?(n.y=r.y+o.y+a.y,n.skew=r.skew+o.skew+a.skew,n.rotation=r.rotation+o.rotation+a.rotation):(n.y=r.y-o.y+a.y,n.skew=r.skew-o.skew+a.skew,n.rotation=r.rotation-o.rotation+a.rotation)):(n.copyFrom(o),t.DragonBones.yDown||(n.y=-n.y,n.skew=-n.skew,n.rotation=-n.rotation),n.add(a)):0===this.offsetMode?null!==r?n.copyFrom(r).add(a):n.copyFrom(a):(_=!1,n.copyFrom(o),t.DragonBones.yDown||(n.y=-n.y,n.skew=-n.skew,n.rotation=-n.rotation)),_){var d=0===c._boneData.type?c.globalTransformMatrix:c._getGlobalTransformMatrix(n.x,n.y);if(i.inheritScale)i.inheritRotation||(c.updateGlobalTransform(),u=l&&h?n.rotation-(c.global.rotation+Math.PI):l?n.rotation+c.global.rotation+Math.PI:h?n.rotation+c.global.rotation:n.rotation-c.global.rotation,n.rotation=u),n.toMatrix(s),s.concat(d),i.inheritTranslation?(n.x=s.tx,n.y=s.ty):(s.tx=n.x,s.ty=n.y),e?n.fromMatrix(s):this._globalDirty=!0;else{if(i.inheritTranslation){var m=n.x,p=n.y;n.x=d.a*m+d.c*p+d.tx,n.y=d.b*m+d.d*p+d.ty}else l&&(n.x=-n.x),h&&(n.y=-n.y);i.inheritRotation?(c.updateGlobalTransform(),u=c.global.scaleX<0?n.rotation+c.global.rotation+Math.PI:n.rotation+c.global.rotation,d.a*d.d-d.b*d.c<0&&(u-=2*n.rotation,(l!==h||i.inheritReflection)&&(n.skew+=Math.PI),t.DragonBones.yDown||(n.skew=-n.skew)),n.rotation=u):(l||h)&&(l&&h?u=n.rotation+Math.PI:(u=l?Math.PI-n.rotation:-n.rotation,n.skew+=Math.PI),n.rotation=u),n.toMatrix(s)}}else(l||h)&&(l&&(n.x=-n.x),h&&(n.y=-n.y),l&&h?u=n.rotation+Math.PI:(u=l?Math.PI-n.rotation:-n.rotation,n.skew+=Math.PI),n.rotation=u),n.toMatrix(s)},i.prototype.init=function(t,e){null===this._boneData&&(this._boneData=t,this._armature=e,null!==this._boneData.parent&&(this._parent=this._armature.getBone(this._boneData.parent.name)),this._armature._addBone(this),this.origin=this._boneData.transform)},i.prototype.update=function(t){if(this._blendState.dirty=!1,t>=0&&null!==this._cachedFrameIndices){var e=this._cachedFrameIndices[t];if(e>=0&&this._cachedFrameIndex===e)this._transformDirty=!1;else if(e>=0)this._transformDirty=!0,this._cachedFrameIndex=e;else{if(this._hasConstraint)for(var i=0,n=this._armature._constraints;i<n.length;i++)(o=n[i])._root===this&&o.update();this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}}else{if(this._hasConstraint)for(var s=0,r=this._armature._constraints;s<r.length;s++){var o;(o=r[s])._root===this&&o.update()}(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1)}if(this._transformDirty)if(this._transformDirty=!1,this._childrenTransformDirty=!0,this._cachedFrameIndex<0){var a=t>=0;this._localDirty&&this._updateGlobalTransformMatrix(a),a&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);else this._childrenTransformDirty&&(this._childrenTransformDirty=!1);this._localDirty=!0},i.prototype.updateByConstraint=function(){this._localDirty&&(this._localDirty=!1,(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&this._updateGlobalTransformMatrix(!0),this._transformDirty=!0)},i.prototype.invalidUpdate=function(){this._transformDirty=!0},i.prototype.contains=function(t){if(t===this)return!1;for(var e=t;e!==this&&null!==e;)e=e.parent;return e===this},Object.defineProperty(i.prototype,"boneData",{get:function(){return this._boneData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"visible",{get:function(){return this._visible},set:function(t){if(this._visible!==t){this._visible=t;for(var e=0,i=this._armature.getSlots();e<i.length;e++){var n=i[e];n.parent===this&&n._updateVisible()}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return this._boneData.name},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),i.prototype.getBones=function(){console.warn("Deprecated.");for(var t=new Array,e=0,i=this._armature.getBones();e<i.length;e++){var n=i[e];n.parent===this&&t.push(n)}return t},i.prototype.getSlots=function(){console.warn("Deprecated.");for(var t=new Array,e=0,i=this._armature.getSlots();e<i.length;e++){var n=i[e];n.parent===this&&t.push(n)}return t},Object.defineProperty(i.prototype,"slot",{get:function(){console.warn("Deprecated.");for(var t=0,e=this._armature.getSlots();t<e.length;t++){var i=e[t];if(i.parent===this)return i}return null},enumerable:!0,configurable:!0}),i}(t.TransformObject);t.Bone=e}(R$||(R$={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._vertices=[],e._deformVertices=[],e._hullCache=[],e._matrixCahce=[],e}return I$(e,t),e.toString=function(){return"[class dragonBones.Surface]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._dX=0,this._dY=0,this._k=0,this._kX=0,this._kY=0,this._vertices.length=0,this._deformVertices.length=0,this._matrixCahce.length=0,this._hullCache.length=0},e.prototype._getAffineTransform=function(t,e,i,n,s,r,o,a,c,l,h,_,u){var d=o-s,m=a-r,p=c-s,f=l-r;h.rotation=Math.atan2(m,d),h.skew=Math.atan2(f,p)-.5*Math.PI-h.rotation,u&&(h.rotation+=Math.PI),h.scaleX=Math.sqrt(d*d+m*m)/i,h.scaleY=Math.sqrt(p*p+f*f)/n,h.toMatrix(_),h.x=_.tx=s-(_.a*t+_.c*e),h.y=_.ty=r-(_.b*t+_.d*e)},e.prototype._updateVertices=function(){var t=this._boneData.vertices,e=this._vertices,i=this._deformVertices;if(null!==this._parent)if(1===this._parent._boneData.type)for(var n=0,s=t.length;n<s;n+=2){var r=t[n]+i[n],o=t[n+1]+i[n],a=this._parent._getGlobalTransformMatrix(r,o);e[n]=a.a*r+a.c*o+a.tx,e[n+1]=a.b*r+a.d*o+a.ty}else{var c=this._parent.globalTransformMatrix;for(n=0,s=t.length;n<s;n+=2)r=t[n]+i[n],o=t[n+1]+i[n+1],e[n]=c.a*r+c.c*o+c.tx,e[n+1]=c.b*r+c.d*o+c.ty}else for(n=0,s=t.length;n<s;n+=2)e[n]=t[n]+i[n],e[n+1]=t[n+1]+i[n+1]},e.prototype._updateGlobalTransformMatrix=function(){var t=2*this._boneData.segmentX,e=this._vertices.length-2,i=this._vertices[0],n=this._vertices[1],s=this._vertices[t],r=this._vertices[t+1],o=this._vertices[e],a=this._vertices[e+1],c=this._vertices[e-t],l=this._vertices[e-t+1],h=i+.5*(o-i),_=n+.5*(a-n),u=h+.5*(s+.5*(c-s)-h),d=_+.5*(r+.5*(l-r)-_),m=s+.5*(o-s),p=r+.5*(a-r),f=c+.5*(o-c),g=l+.5*(a-l);this._globalDirty=!1,this._getAffineTransform(0,0,200,200,u,d,m,p,f,g,this.global,this.globalTransformMatrix,!1)},e.prototype._getGlobalTransformMatrix=function(t,i){var n=1e3;if(t<-n||n<t||i<-n||n<i)return this.globalTransformMatrix;var s=!1,r=200,o=this._boneData,a=o.segmentX,c=o.segmentY,l=2*o.segmentX,h=this._dX,_=this._dY,u=Math.floor((t+r)/h),d=Math.floor((i+r)/_),m=0,p=u*h-r,f=d*_-r,g=this._matrixCahce,v=e._helpMatrix;if(t<-r){if(i<-r||i>=r)return this.globalTransformMatrix;if(m=7*(2*(a*(c+1)+2*a+c+d)+((s=i>this._kX*(t+r)+f)?1:0)),this._matrixCahce[m]>0)v.copyFromArray(g,m+1);else{var y=d*(l+2),x=this._hullCache[4],S=this._hullCache[5],C=this._hullCache[2]-(c-d)*x,A=this._hullCache[3]-(c-d)*S,b=this._vertices;s?this._getAffineTransform(-r,f+_,800,_,b[y+l+2],b[y+l+3],C+x,A+S,b[y],b[y+1],e._helpTransform,v,!0):this._getAffineTransform(-n,f,800,_,C,A,b[y],b[y+1],C+x,A+S,e._helpTransform,v,!1),g[m]=1,g[m+1]=v.a,g[m+2]=v.b,g[m+3]=v.c,g[m+4]=v.d,g[m+5]=v.tx,g[m+6]=v.ty}}else if(t>=r){if(i<-r||i>=r)return this.globalTransformMatrix;m=7*(2*(a*(c+1)+a+d)+((s=i>this._kX*(t-n)+f)?1:0)),this._matrixCahce[m]>0?v.copyFromArray(g,m+1):(y=(d+1)*(l+2)-2,x=this._hullCache[4],S=this._hullCache[5],C=this._hullCache[0]+d*x,A=this._hullCache[1]+d*S,b=this._vertices,s?this._getAffineTransform(n,f+_,800,_,C+x,A+S,b[y+l+2],b[y+l+3],C,A,e._helpTransform,v,!0):this._getAffineTransform(r,f,800,_,b[y],b[y+1],C,A,b[y+l+2],b[y+l+3],e._helpTransform,v,!1),g[m]=1,g[m+1]=v.a,g[m+2]=v.b,g[m+3]=v.c,g[m+4]=v.d,g[m+5]=v.tx,g[m+6]=v.ty)}else if(i<-r){if(t<-r||t>=r)return this.globalTransformMatrix;m=7*(a*(c+1)+2*u+((s=i>this._kY*(t-p-h)-n)?1:0)),this._matrixCahce[m]>0?v.copyFromArray(g,m+1):(y=2*u,x=this._hullCache[10],S=this._hullCache[11],C=this._hullCache[8]+u*x,A=this._hullCache[9]+u*S,b=this._vertices,s?this._getAffineTransform(p+h,-r,h,800,b[y+2],b[y+3],b[y],b[y+1],C+x,A+S,e._helpTransform,v,!0):this._getAffineTransform(p,-n,h,800,C,A,C+x,A+S,b[y],b[y+1],e._helpTransform,v,!1),g[m]=1,g[m+1]=v.a,g[m+2]=v.b,g[m+3]=v.c,g[m+4]=v.d,g[m+5]=v.tx,g[m+6]=v.ty)}else if(i>=r){if(t<-r||t>=r)return this.globalTransformMatrix;m=7*(2*(a*(c+1)+a+c+d)+((s=i>this._kY*(t-p-h)+r)?1:0)),this._matrixCahce[m]>0?v.copyFromArray(g,m+1):(y=c*(l+2)+2*u,x=this._hullCache[10],S=this._hullCache[11],C=this._hullCache[6]-(a-u)*x,A=this._hullCache[7]-(a-u)*S,b=this._vertices,s?this._getAffineTransform(p+h,n,h,800,C+x,A+S,C,A,b[y+2],b[y+3],e._helpTransform,v,!0):this._getAffineTransform(p,r,h,800,b[y],b[y+1],b[y+2],b[y+3],C,A,e._helpTransform,v,!1),g[m]=1,g[m+1]=v.a,g[m+2]=v.b,g[m+3]=v.c,g[m+4]=v.d,g[m+5]=v.tx,g[m+6]=v.ty)}else m=7*(2*(a*d+u)+((s=i>this._k*(t-p-h)+f)?1:0)),this._matrixCahce[m]>0?v.copyFromArray(g,m+1):(y=2*u+d*(l+2),b=this._vertices,s?this._getAffineTransform(p+h,f+_,h,_,b[y+l+4],b[y+l+5],b[y+l+2],b[y+l+3],b[y+2],b[y+3],e._helpTransform,v,!0):this._getAffineTransform(p,f,h,_,b[y],b[y+1],b[y+2],b[y+3],b[y+l+2],b[y+l+3],e._helpTransform,v,!1),g[m]=1,g[m+1]=v.a,g[m+2]=v.b,g[m+3]=v.c,g[m+4]=v.d,g[m+5]=v.tx,g[m+6]=v.ty);return v},e.prototype.init=function(e,i){if(null===this._boneData){t.prototype.init.call(this,e,i);var n=e.segmentX,s=e.segmentY,r=e.vertices.length;this._dX=400/n,this._dY=400/s,this._k=-this._dY/this._dX,this._kX=-this._dY/800,this._kY=-800/this._dX,this._vertices.length=r,this._deformVertices.length=r,this._matrixCahce.length=14*(n*s+2*n+2*s),this._hullCache.length=10;for(var o=0;o<r;++o)this._deformVertices[o]=0}},e.prototype.update=function(t){if(this._blendState.dirty=!1,t>=0&&null!==this._cachedFrameIndices){var i=this._cachedFrameIndices[t];if(i>=0&&this._cachedFrameIndex===i)this._transformDirty=!1;else if(i>=0)this._transformDirty=!0,this._cachedFrameIndex=i;else{if(this._hasConstraint)for(var n=0,s=this._armature._constraints;n<s.length;n++)(a=s[n])._root===this&&a.update();this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}}else{if(this._hasConstraint)for(var r=0,o=this._armature._constraints;r<o.length;r++){var a;(a=o[r])._root===this&&a.update()}(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1)}if(this._transformDirty){this._transformDirty=!1,this._childrenTransformDirty=!0;for(var c=0,l=this._matrixCahce.length;c<l;c+=7)this._matrixCahce[c]=-1;if(this._updateVertices(),this._cachedFrameIndex<0){var h=t>=0;this._localDirty&&this._updateGlobalTransformMatrix(h),h&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);var _=2*this.global.x,u=2*this.global.y,d=e._helpPoint;this.globalTransformMatrix.transformPoint(1e3,-200,d),this._hullCache[0]=d.x,this._hullCache[1]=d.y,this._hullCache[2]=_-d.x,this._hullCache[3]=u-d.y,this.globalTransformMatrix.transformPoint(0,this._dY,d,!0),this._hullCache[4]=d.x,this._hullCache[5]=d.y,this.globalTransformMatrix.transformPoint(200,1e3,d),this._hullCache[6]=d.x,this._hullCache[7]=d.y,this._hullCache[8]=_-d.x,this._hullCache[9]=u-d.y,this.globalTransformMatrix.transformPoint(this._dX,0,d,!0),this._hullCache[10]=d.x,this._hullCache[11]=d.y}else this._childrenTransformDirty&&(this._childrenTransformDirty=!1);this._localDirty=!0},e}(t.Bone);t.Surface=e}(R$||(R$={})),function(t){var e=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i._localMatrix=new t.Matrix,i._colorTransform=new t.ColorTransform,i._displayDatas=[],i._displayList=[],i._deformVertices=null,i._rawDisplay=null,i._meshDisplay=null,i}return I$(i,e),i.prototype._onClear=function(){e.prototype._onClear.call(this);for(var i=[],n=0,s=this._displayList;n<s.length;n++)null!==(a=s[n])&&a!==this._rawDisplay&&a!==this._meshDisplay&&i.indexOf(a)<0&&i.push(a);for(var r=0,o=i;r<o.length;r++){var a;(a=o[r])instanceof t.Armature?a.dispose():this._disposeDisplay(a,!0)}null!==this._deformVertices&&this._deformVertices.returnToPool(),null!==this._meshDisplay&&this._meshDisplay!==this._rawDisplay&&this._disposeDisplay(this._meshDisplay,!1),null!==this._rawDisplay&&this._disposeDisplay(this._rawDisplay,!1),this.displayController=null,this._displayDirty=!1,this._zOrderDirty=!1,this._blendModeDirty=!1,this._colorDirty=!1,this._transformDirty=!1,this._visible=!0,this._blendMode=0,this._displayIndex=-1,this._animationDisplayIndex=-1,this._zOrder=0,this._cachedFrameIndex=-1,this._pivotX=0,this._pivotY=0,this._localMatrix.identity(),this._colorTransform.identity(),this._displayList.length=0,this._displayDatas.length=0,this._slotData=null,this._rawDisplayDatas=null,this._displayData=null,this._boundingBoxData=null,this._textureData=null,this._deformVertices=null,this._rawDisplay=null,this._meshDisplay=null,this._display=null,this._childArmature=null,this._parent=null,this._cachedFrameIndices=null},i.prototype._getDefaultRawDisplayData=function(t){var e=this._armature._armatureData.defaultSkin;if(null!==e){var i=e.getDisplays(this._slotData.name);if(null!==i)return t<i.length?i[t]:null}return null},i.prototype._updateDisplayData=function(){var e=this._displayData,n=null!==this._deformVertices?this._deformVertices.verticesData:null,s=this._textureData,r=null,o=null;if(this._displayData=null,this._boundingBoxData=null,this._textureData=null,this._displayIndex>=0&&(null!==this._rawDisplayDatas&&(r=this._displayIndex<this._rawDisplayDatas.length?this._rawDisplayDatas[this._displayIndex]:null),null===r&&(r=this._getDefaultRawDisplayData(this._displayIndex)),this._displayIndex<this._displayDatas.length&&(this._displayData=this._displayDatas[this._displayIndex])),null!==this._displayData&&(2===this._displayData.type||4===this._displayData.type?o=this._displayData.vertices:null!==r&&(2===r.type||4===r.type)&&(o=r.vertices),3===this._displayData.type?this._boundingBoxData=this._displayData.boundingBox:null!==r&&3===r.type&&(this._boundingBoxData=r.boundingBox),(0===this._displayData.type||2===this._displayData.type)&&(this._textureData=this._displayData.texture)),this._displayData!==e||o!==n||this._textureData!==s){if(null===o&&null!==this._textureData){var a=this._displayData,c=this._textureData.parent.scale*this._armature._armatureData.scale,l=this._textureData.frame;this._pivotX=a.pivot.x,this._pivotY=a.pivot.y;var h=null!==l?l:this._textureData.region,_=h.width,u=h.height;this._textureData.rotated&&null===l&&(_=h.height,u=h.width),this._pivotX*=_*c,this._pivotY*=u*c,null!==l&&(this._pivotX+=l.x*c,this._pivotY+=l.y*c),null!==this._displayData&&null!==r&&this._displayData!==r&&(r.transform.toMatrix(i._helpMatrix),i._helpMatrix.invert(),i._helpMatrix.transformPoint(0,0,i._helpPoint),this._pivotX-=i._helpPoint.x,this._pivotY-=i._helpPoint.y,this._displayData.transform.toMatrix(i._helpMatrix),i._helpMatrix.invert(),i._helpMatrix.transformPoint(0,0,i._helpPoint),this._pivotX+=i._helpPoint.x,this._pivotY+=i._helpPoint.y),t.DragonBones.yDown||(this._pivotY=(this._textureData.rotated?this._textureData.region.width:this._textureData.region.height)*c-this._pivotY)}else this._pivotX=0,this._pivotY=0;null!==r?this.origin=r.transform:null!==this._displayData?this.origin=this._displayData.transform:this.origin=null,o!==n?(null===this._deformVertices&&(this._deformVertices=t.BaseObject.borrowObject(t.DeformVertices)),this._deformVertices.init(o,this._armature)):null!==this._deformVertices&&this._textureData!==s&&(this._deformVertices.verticesDirty=!0),this._displayDirty=!0,this._transformDirty=!0}},i.prototype._updateDisplay=function(){var e=null!==this._display?this._display:this._rawDisplay,i=this._childArmature;this._displayIndex>=0&&this._displayIndex<this._displayList.length?(this._display=this._displayList[this._displayIndex],null!==this._display&&this._display instanceof t.Armature?(this._childArmature=this._display,this._display=this._childArmature.display):this._childArmature=null):(this._display=null,this._childArmature=null);var n=null!==this._display?this._display:this._rawDisplay;if(n!==e&&(this._onUpdateDisplay(),this._replaceDisplay(e),this._transformDirty=!0,this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0),n!==this._rawDisplay&&n!==this._meshDisplay||this._updateFrame(),this._childArmature!==i&&(null!==i&&(i._parent=null,i.clock=null,i.inheritAnimation&&i.animation.reset()),null!==this._childArmature&&(this._childArmature._parent=this,this._childArmature.clock=this._armature.clock,this._childArmature.inheritAnimation))){if(0===this._childArmature.cacheFrameRate){var s=this._armature.cacheFrameRate;0!==s&&(this._childArmature.cacheFrameRate=s)}var r=null;if(null!==this._displayData&&1===this._displayData.type)r=this._displayData.actions;else if(this._displayIndex>=0&&null!==this._rawDisplayDatas){var o=this._displayIndex<this._rawDisplayDatas.length?this._rawDisplayDatas[this._displayIndex]:null;null===o&&(o=this._getDefaultRawDisplayData(this._displayIndex)),null!==o&&1===o.type&&(r=o.actions)}if(null!==r&&r.length>0)for(var a=0,c=r;a<c.length;a++){var l=c[a],h=t.BaseObject.borrowObject(t.EventObject);t.EventObject.actionDataToInstance(l,h,this._armature),h.slot=this,this._armature._bufferAction(h,!1)}else this._childArmature.animation.play()}},i.prototype._updateGlobalTransformMatrix=function(t){var e=0===this._parent._boneData.type?this._parent.globalTransformMatrix:this._parent._getGlobalTransformMatrix(this.global.x,this.global.y);this.globalTransformMatrix.copyFrom(this._localMatrix),this.globalTransformMatrix.concat(e),t?this.global.fromMatrix(this.globalTransformMatrix):this._globalDirty=!0},i.prototype._setDisplayIndex=function(t,e){if(void 0===e&&(e=!1),e){if(this._animationDisplayIndex===t)return!1;this._animationDisplayIndex=t}return this._displayIndex!==t&&(this._displayIndex=t,this._displayDirty=!0,this._updateDisplayData(),this._displayDirty)},i.prototype._setZorder=function(t){return this._zOrder,this._zOrder=t,this._zOrderDirty=!0,this._zOrderDirty},i.prototype._setColor=function(t){return this._colorTransform.copyFrom(t),this._colorDirty=!0,this._colorDirty},i.prototype._setDisplayList=function(e){if(null!==e&&e.length>0){this._displayList.length!==e.length&&(this._displayList.length=e.length);for(var i=0,n=e.length;i<n;++i){var s=e[i];null!==s&&s!==this._rawDisplay&&s!==this._meshDisplay&&!(s instanceof t.Armature)&&this._displayList.indexOf(s)<0&&this._initDisplay(s,!0),this._displayList[i]=s}}else this._displayList.length>0&&(this._displayList.length=0);return this._displayIndex>=0&&this._displayIndex<this._displayList.length?this._displayDirty=this._display!==this._displayList[this._displayIndex]:this._displayDirty=null!==this._display,this._updateDisplayData(),this._displayDirty},i.prototype.init=function(t,e,i,n){if(null===this._slotData){this._slotData=t,this._isFromCache=!1,this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0,this._blendMode=this._slotData.blendMode,this._zOrder=this._slotData.zOrder,this._colorTransform.copyFrom(this._slotData.color),this._rawDisplay=i,this._meshDisplay=n,this._armature=e;var s=this._armature.getBone(this._slotData.parent.name);null!==s&&(this._parent=s),this._armature._addSlot(this),this._initDisplay(this._rawDisplay,!1),this._rawDisplay!==this._meshDisplay&&this._initDisplay(this._meshDisplay,!1),this._onUpdateDisplay(),this._addDisplay()}},i.prototype.update=function(t){if(this._isFromCache=!1,this._displayDirty&&(this._displayDirty=!1,this._updateDisplay(),this._transformDirty&&(null!==this.origin?this.global.copyFrom(this.origin).add(this.offset).toMatrix(this._localMatrix):this.global.copyFrom(this.offset).toMatrix(this._localMatrix))),this._zOrderDirty&&(this._zOrderDirty=!1,this._updateZOrder()),t>=0&&null!==this._cachedFrameIndices){var e=this._cachedFrameIndices[t];e>=0&&this._cachedFrameIndex===e?this._transformDirty=!1:e>=0?(this._transformDirty=!0,this._cachedFrameIndex=e):this._transformDirty||this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}else(this._transformDirty||this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1);if(null!==this._display){if(this._visibleDirty&&(this._visibleDirty=!1,this._updateVisible()),this._blendModeDirty&&(this._blendModeDirty=!1,this._updateBlendMode()),this._colorDirty&&(this._colorDirty=!1,this._updateColor()),null!==this._deformVertices&&null!==this._deformVertices.verticesData&&this._display===this._meshDisplay){var i=null!==this._deformVertices.verticesData.weight,n=0!==this._parent._boneData.type;if((this._deformVertices.verticesDirty||i&&this._deformVertices.isBonesUpdate()||n&&this._parent._childrenTransformDirty)&&(this._deformVertices.verticesDirty=!1,this._updateMesh()),i||n)return}if(this._transformDirty){if(this._transformDirty=!1,this._cachedFrameIndex<0){var s=t>=0;this._updateGlobalTransformMatrix(s),s&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._isFromCache=!0,this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);this._updateTransform()}}},i.prototype.updateTransformAndMatrix=function(){this._transformDirty&&(this._transformDirty=!1,this._updateGlobalTransformMatrix(!1))},i.prototype.replaceDisplayData=function(t,e){if(void 0===e&&(e=-1),e<0&&(e=this._displayIndex<0?0:this._displayIndex),this._displayDatas.length<=e){this._displayDatas.length=e+1;for(var i=0,n=this._displayDatas.length;i<n;++i)this._displayDatas[i]||(this._displayDatas[i]=null)}this._displayDatas[e]=t},i.prototype.containsPoint=function(t,e){return null!==this._boundingBoxData&&(this.updateTransformAndMatrix(),i._helpMatrix.copyFrom(this.globalTransformMatrix),i._helpMatrix.invert(),i._helpMatrix.transformPoint(t,e,i._helpPoint),this._boundingBoxData.containsPoint(i._helpPoint.x,i._helpPoint.y))},i.prototype.intersectsSegment=function(t,e,n,s,r,o,a){if(void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null),null===this._boundingBoxData)return 0;this.updateTransformAndMatrix(),i._helpMatrix.copyFrom(this.globalTransformMatrix),i._helpMatrix.invert(),i._helpMatrix.transformPoint(t,e,i._helpPoint),t=i._helpPoint.x,e=i._helpPoint.y,i._helpMatrix.transformPoint(n,s,i._helpPoint),n=i._helpPoint.x,s=i._helpPoint.y;var c=this._boundingBoxData.intersectsSegment(t,e,n,s,r,o,a);return c>0&&(1===c||2===c?null!==r?(this.globalTransformMatrix.transformPoint(r.x,r.y,r),null!==o&&(o.x=r.x,o.y=r.y)):null!==o&&this.globalTransformMatrix.transformPoint(o.x,o.y,o):(null!==r&&this.globalTransformMatrix.transformPoint(r.x,r.y,r),null!==o&&this.globalTransformMatrix.transformPoint(o.x,o.y,o)),null!==a&&(this.globalTransformMatrix.transformPoint(Math.cos(a.x),Math.sin(a.x),i._helpPoint,!0),a.x=Math.atan2(i._helpPoint.y,i._helpPoint.x),this.globalTransformMatrix.transformPoint(Math.cos(a.y),Math.sin(a.y),i._helpPoint,!0),a.y=Math.atan2(i._helpPoint.y,i._helpPoint.x))),c},i.prototype.invalidUpdate=function(){this._displayDirty=!0,this._transformDirty=!0},Object.defineProperty(i.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible!==t&&(this._visible=t,this._updateVisible())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"displayIndex",{get:function(){return this._displayIndex},set:function(t){this._setDisplayIndex(t)&&this.update(-1)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return this._slotData.name},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"displayList",{get:function(){return this._displayList.concat()},set:function(e){var i=this._displayList.concat(),n=new Array;this._setDisplayList(e)&&this.update(-1);for(var s=0,r=i;s<r.length;s++)null!==(c=r[s])&&c!==this._rawDisplay&&c!==this._meshDisplay&&this._displayList.indexOf(c)<0&&n.indexOf(c)<0&&n.push(c);for(var o=0,a=n;o<a.length;o++){var c;(c=a[o])instanceof t.Armature||this._disposeDisplay(c,!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"slotData",{get:function(){return this._slotData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rawDisplayDatas",{get:function(){return this._rawDisplayDatas},set:function(t){if(this._rawDisplayDatas!==t)if(this._displayDirty=!0,this._rawDisplayDatas=t,null!==this._rawDisplayDatas){this._displayDatas.length=this._rawDisplayDatas.length;for(var e=0,i=this._displayDatas.length;e<i;++e){var n=this._rawDisplayDatas[e];null===n&&(n=this._getDefaultRawDisplayData(e)),this._displayDatas[e]=n}}else this._displayDatas.length=0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"displayData",{get:function(){return this._displayData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"boundingBoxData",{get:function(){return this._boundingBoxData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rawDisplay",{get:function(){return this._rawDisplay},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"meshDisplay",{get:function(){return this._meshDisplay},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"display",{get:function(){return this._display},set:function(t){if(this._display!==t){var e=this._displayList.length;if(this._displayIndex<0&&0===e&&(this._displayIndex=0),!(this._displayIndex<0)){var i=this.displayList;e<=this._displayIndex&&(i.length=this._displayIndex+1),i[this._displayIndex]=t,this.displayList=i}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"childArmature",{get:function(){return this._childArmature},set:function(t){this._childArmature!==t&&(this.display=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),i.prototype.getDisplay=function(){return this._display},i.prototype.setDisplay=function(t){this.display=t},i}(t.TransformObject);t.Slot=e}(R$||(R$={})),function(t){var e=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return I$(i,e),i.prototype._onClear=function(){this._armature=null,this._target=null,this._root=null,this._bone=null},Object.defineProperty(i.prototype,"name",{get:function(){return this._constraintData.name},enumerable:!0,configurable:!0}),i._helpMatrix=new t.Matrix,i._helpTransform=new t.Transform,i._helpPoint=new t.Point,i}(t.BaseObject);t.Constraint=e;var i=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return I$(i,e),i.toString=function(){return"[class dragonBones.IKConstraint]"},i.prototype._onClear=function(){e.prototype._onClear.call(this),this._scaleEnabled=!1,this._bendPositive=!1,this._weight=1,this._constraintData=null},i.prototype._computeA=function(){var e=this._target.global,i=this._root.global,n=this._root.globalTransformMatrix,s=Math.atan2(e.y-i.y,e.x-i.x);i.scaleX<0&&(s+=Math.PI),i.rotation+=t.Transform.normalizeRadian(s-i.rotation)*this._weight,i.toMatrix(n)},i.prototype._computeB=function(){var e=this._bone._boneData.length,i=this._root,n=this._target.global,s=i.global,r=this._bone.global,o=this._bone.globalTransformMatrix,a=o.a*e,c=o.b*e,l=a*a+c*c,h=Math.sqrt(l),_=r.x-s.x,u=r.y-s.y,d=_*_+u*u,m=Math.sqrt(d),p=r.rotation,f=s.rotation,g=Math.atan2(u,_),v=(_=n.x-s.x)*_+(u=n.y-s.y)*u,y=Math.sqrt(v),x=0;if(h+m<=y||y+h<=m||y+m<=h)x=Math.atan2(n.y-s.y,n.x-s.x),h+m<=y||m<h&&(x+=Math.PI);else{var S=(d-l+v)/(2*v),C=Math.sqrt(d-S*S*v)/y,A=s.x+_*S,b=s.y+u*S,T=-u*C,E=_*C,P=!1,w=i.parent;if(null!==w){var I=w.globalTransformMatrix;P=I.a*I.d-I.b*I.c<0}P!==this._bendPositive?(r.x=A-T,r.y=b-E):(r.x=A+T,r.y=b+E),x=Math.atan2(r.y-s.y,r.x-s.x)}var R=t.Transform.normalizeRadian(x-g);s.rotation=f+R*this._weight,s.toMatrix(i.globalTransformMatrix);var D=g+R*this._weight;r.x=s.x+Math.cos(D)*m,r.y=s.y+Math.sin(D)*m;var M=Math.atan2(n.y-r.y,n.x-r.x);r.scaleX<0&&(M+=Math.PI),r.rotation=s.rotation+p-f+t.Transform.normalizeRadian(M-R-p)*this._weight,r.toMatrix(o)},i.prototype.init=function(t,e){if(null===this._constraintData){this._constraintData=t,this._armature=e,this._target=this._armature.getBone(this._constraintData.target.name),this._root=this._armature.getBone(this._constraintData.root.name),this._bone=null!==this._constraintData.bone?this._armature.getBone(this._constraintData.bone.name):null;var i=this._constraintData;this._scaleEnabled=i.scaleEnabled,this._bendPositive=i.bendPositive,this._weight=i.weight,this._root._hasConstraint=!0}},i.prototype.update=function(){this._root.updateByConstraint(),null!==this._bone?(this._bone.updateByConstraint(),this._computeB()):this._computeA()},i.prototype.invalidUpdate=function(){this._root.invalidUpdate(),null!==this._bone&&this._bone.invalidUpdate()},i}(e);t.IKConstraint=i;var n=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t._bones=[],t._spaces=[],t._positions=[],t._curves=[],t._boneLengths=[],t._pathGlobalVertices=[],t._segments=[10],t}return I$(i,e),i.toString=function(){return"[class dragonBones.PathConstraint]"},i.prototype._onClear=function(){e.prototype._onClear.call(this),this.dirty=!1,this.pathOffset=0,this.position=0,this.spacing=0,this.rotateOffset=0,this.rotateMix=1,this.translateMix=1,this._pathSlot=null,this._bones.length=0,this._spaces.length=0,this._positions.length=0,this._curves.length=0,this._boneLengths.length=0,this._pathGlobalVertices.length=0},i.prototype._updatePathVertices=function(t){var e=this._armature,i=e.armatureData.parent,n=e.armatureData.scale,s=i.intArray,r=i.floatArray,o=t.offset,a=s[o+0],c=s[o+2];this._pathGlobalVertices.length=2*a;var l=t.weight;if(null!==l)for(var h=this._pathSlot._deformVertices.bones,_=l.bones.length,u=l.offset,d=s[u+1],m=u+2+_,p=(b=0,0);b<a;b++){for(var f=0,g=0,v=0,y=s[m++];v<y;v++){var x=h[s[m++]];if(null!==x){x.updateByConstraint(),A=x.globalTransformMatrix;var S=r[d++];E=r[d++]*n,P=r[d++]*n,f+=(A.a*E+A.c*P+A.tx)*S,g+=(A.b*E+A.d*P+A.ty)*S}}this._pathGlobalVertices[p++]=f,this._pathGlobalVertices[p++]=g}else{var C=this._pathSlot.parent;C.updateByConstraint();for(var A=C.globalTransformMatrix,b=0,T=c;b<a;b+=2){var E=r[T++]*n,P=r[T++]*n,w=A.a*E+A.c*P+A.tx,I=A.b*E+A.d*P+A.ty;this._pathGlobalVertices[b]=w,this._pathGlobalVertices[b+1]=I}}},i.prototype._computeVertices=function(t,e,i,n){for(var s=i,r=t;s<e;s+=2)n[s]=this._pathGlobalVertices[r++],n[s+1]=this._pathGlobalVertices[r++]},i.prototype._computeBezierCurve=function(t,e,i,n,s){var r=this._armature.armatureData.parent.intArray[t.vertices.offset+0],o=this._positions,a=this._spaces,c=t.closed,l=Array(),h=2*r,_=h/6,u=-1,d=this.position;o.length=3*e+2;var m=0;if(t.constantSpeed){c?(h+=2,l.length=r,this._computeVertices(2,h-4,0,l),this._computeVertices(0,2,h-4,l),l[h-2]=l[0],l[h-1]=l[1]):(_--,h-=4,l.length=h,this._computeVertices(2,h,0,l));var p=new Array(_);m=0;for(var f,g,v,y,x,S,C,A,b=l[0],T=l[1],E=0,P=0,w=0,I=0,R=0,D=0,M=(k=0,2);k<_;k++,M+=6)E=l[M],P=l[M+1],w=l[M+2],I=l[M+3],x=2*(f=.1875*(b-2*E+w))+(v=.09375*(3*(E-w)-b+(R=l[M+4]))),S=2*(g=.1875*(T-2*P+I))+(y=.09375*(3*(P-I)-T+(D=l[M+5]))),C=.75*(E-b)+f+.16666667*v,A=.75*(P-T)+g+.16666667*y,m+=Math.sqrt(C*C+A*A),C+=x,A+=S,x+=v,S+=y,m+=Math.sqrt(C*C+A*A),C+=x,A+=S,m+=Math.sqrt(C*C+A*A),C+=x+v,A+=S+y,m+=Math.sqrt(C*C+A*A),p[k]=m,b=R,T=D;if(n&&(d*=m),s)for(k=0;k<e;k++)a[k]*=m;for(var O=this._segments,B=0,N=(k=0,H=0,j=0,0);k<e;k++,H+=3){var L=d+=a[k];if(c)(L%=m)<0&&(L+=m),j=0;else{if(L<0)continue;if(L>m)continue}for(;;j++){var F=p[j];if(!(L>F)){0===j?L/=F:L=(L-(G=p[j-1]))/(F-G);break}}if(j!==u){u=j;var z=6*j;for(b=l[z],T=l[z+1],E=l[z+2],P=l[z+3],w=l[z+4],I=l[z+5],x=2*(f=.03*(b-2*E+w))+(v=.006*(3*(E-w)-b+(R=l[z+6]))),S=2*(g=.03*(T-2*P+I))+(y=.006*(3*(P-I)-T+(D=l[z+7]))),C=.3*(E-b)+f+.16666667*v,A=.3*(P-T)+g+.16666667*y,B=Math.sqrt(C*C+A*A),O[0]=B,z=1;z<8;z++)C+=x,A+=S,x+=v,S+=y,B+=Math.sqrt(C*C+A*A),O[z]=B;C+=x,A+=S,B+=Math.sqrt(C*C+A*A),O[8]=B,C+=x+v,A+=S+y,B+=Math.sqrt(C*C+A*A),O[9]=B,N=0}for(L*=B;;N++){var V=O[N];if(!(L>V)){var G;0===N?L/=V:L=N+(L-(G=O[N-1]))/(V-G);break}}this.addCurvePosition(.1*L,b,T,E,P,w,I,R,D,o,H,i)}}else{var U=t.curveLengths;if(m=U[_-=c?1:2],n&&(d*=m),s)for(var k=0;k<e;k++)a[k]*=m;l.length=8;k=0;for(var H=0,j=0;k<e;k++,H+=3){if(d+=a[k],c)(d%=m)<0&&(d+=m),j=0;else{if(d<0)continue;if(d>m)continue}for(var W=0;;j++){var q=U[j];if(!(d>q)){if(0===j)W=d/q;else{var X=U[j-1];W=(d-X)/(q-X)}break}}j!==u&&(u=j,c&&j===_?(this._computeVertices(h-4,4,0,l),this._computeVertices(0,4,4,l)):this._computeVertices(6*j+2,8,0,l)),this.addCurvePosition(W,l[0],l[1],l[2],l[3],l[4],l[5],l[6],l[7],o,H,i)}}},i.prototype.addCurvePosition=function(t,e,i,n,s,r,o,a,c,l,h,_){if(0===t)return l[h]=e,l[h+1]=i,void(l[h+2]=0);if(1===t)return l[h]=a,l[h+1]=c,void(l[h+2]=0);var u=1-t,d=u*u,m=t*t,p=d*u,f=d*t*3,g=u*m*3,v=t*m,y=p*e+f*n+g*r+v*a,x=p*i+f*s+g*o+v*c;l[h]=y,l[h+1]=x,l[h+2]=_?Math.atan2(x-(p*i+f*s+g*o),y-(p*e+f*n+g*r)):0},i.prototype.init=function(t,e){this._constraintData=t,this._armature=e;var i=t;this.pathOffset=i.pathDisplayData.vertices.offset,this.position=i.position,this.spacing=i.spacing,this.rotateOffset=i.rotateOffset,this.rotateMix=i.rotateMix,this.translateMix=i.translateMix,this._root=this._armature.getBone(i.root.name),this._target=this._armature.getBone(i.target.name),this._pathSlot=this._armature.getSlot(i.pathSlot.name);for(var n=0,s=i.bones.length;n<s;n++){var r=this._armature.getBone(i.bones[n].name);null!==r&&this._bones.push(r)}2===i.rotateMode&&(this._boneLengths.length=this._bones.length),this._root._hasConstraint=!0},i.prototype.update=function(){var e=this._pathSlot;if(null!==e._deformVertices&&null!==e._deformVertices.verticesData&&e._deformVertices.verticesData.offset===this.pathOffset){var i=this._constraintData,n=e._displayData,s=!1,r=e._deformVertices;if(this._root._childrenTransformDirty?(this._updatePathVertices(n.vertices),s=!0):null!==r&&(r.verticesDirty||r.isBonesUpdate())&&(this._updatePathVertices(n.vertices),r.verticesDirty=!1,s=!0),s||this.dirty){var o=i.positionMode,a=i.spacingMode,c=i.rotateMode,l=this._bones,h=0===a,_=2===c,u=0===c,d=l.length,m=u?d:d+1,p=this.spacing,f=this._spaces;if(f.length=m,_||h){f[0]=0;for(var g=0,v=m-1;g<v;g++){(D=l[g]).updateByConstraint();var y=D._boneData.length,x=y*(M=D.globalTransformMatrix).a,S=y*M.b,C=Math.sqrt(x*x+S*S);_&&(this._boneLengths[g]=C),f[g+1]=(y+p)*C/y}}else for(g=0;g<m;g++)f[g]=p;this._computeBezierCurve(n,m,u,1===o,2===a);var A,b=this._positions,T=this.rotateOffset,E=b[0],P=b[1];0===T?A=1===c:(A=!1,null!==(D=e.parent)&&(T*=(M=D.globalTransformMatrix).a*M.d-M.b*M.c>0?t.Transform.DEG_RAD:-t.Transform.DEG_RAD));for(var w=this.rotateMix,I=this.translateMix,R=(g=0,3);g<d;g++,R+=3){var D,M;(D=l[g]).updateByConstraint(),(M=D.globalTransformMatrix).tx+=(E-M.tx)*I,M.ty+=(P-M.ty)*I;var O=(x=b[R])-E,B=(S=b[R+1])-P;if(_){var N=this._boneLengths[g],L=(Math.sqrt(O*O+B*B)/N-1)*w+1;M.a*=L,M.b*=L}if(E=x,P=S,w>0){var F=M.a,z=M.b,V=M.c,G=M.d,U=void 0,k=void 0,H=void 0;if(U=u?b[R-1]:Math.atan2(B,O),U-=Math.atan2(z,F),A){k=Math.cos(U),H=Math.sin(U);var j=D._boneData.length;E+=(j*(k*F-H*z)-O)*w,P+=(j*(H*F+k*z)-B)*w}else U+=T;U>t.Transform.PI?U-=t.Transform.PI_D:U<-t.Transform.PI&&(U+=t.Transform.PI_D),U*=w,k=Math.cos(U),H=Math.sin(U),M.a=k*F-H*z,M.b=H*F+k*z,M.c=k*V-H*G,M.d=H*V+k*G}D.global.fromMatrix(M)}this.dirty=!1}}},i.prototype.invalidUpdate=function(){},i}(e);t.PathConstraint=n}(R$||(R$={})),function(t){var e=function(){function t(t){void 0===t&&(t=0),this.time=0,this.timeScale=1,this._systemTime=0,this._animatebles=[],this._clock=null,this.time=t,this._systemTime=.001*(new Date).getTime()}return t.prototype.advanceTime=function(t){t!=t&&(t=0);var e=.001*Date.now();if(t<0&&(t=e-this._systemTime),this._systemTime=e,1!==this.timeScale&&(t*=this.timeScale),0!==t){t<0?this.time-=t:this.time+=t;for(var i=0,n=0,s=this._animatebles.length;i<s;++i){var r=this._animatebles[i];null!==r?(n>0&&(this._animatebles[i-n]=r,this._animatebles[i]=null),r.advanceTime(t)):n++}if(n>0){for(s=this._animatebles.length;i<s;++i){var o=this._animatebles[i];null!==o?this._animatebles[i-n]=o:n++}this._animatebles.length-=n}}},t.prototype.contains=function(t){if(t===this)return!1;for(var e=t;e!==this&&null!==e;)e=e.clock;return e===this},t.prototype.add=function(t){this._animatebles.indexOf(t)<0&&(this._animatebles.push(t),t.clock=this)},t.prototype.remove=function(t){var e=this._animatebles.indexOf(t);e>=0&&(this._animatebles[e]=null,t.clock=null)},t.prototype.clear=function(){for(var t=0,e=this._animatebles;t<e.length;t++){var i=e[t];null!==i&&(i.clock=null)}},Object.defineProperty(t.prototype,"clock",{get:function(){return this._clock},set:function(t){this._clock!==t&&(null!==this._clock&&this._clock.remove(this),this._clock=t,null!==this._clock&&this._clock.add(this))},enumerable:!0,configurable:!0}),t.clock=new t,t}();t.WorldClock=e}(R$||(R$={})),function(t){var e=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t._animationNames=[],t._animationStates=[],t._animations={},t._animationConfig=null,t}return I$(i,e),i.toString=function(){return"[class dragonBones.Animation]"},i.prototype._onClear=function(){for(var t=0,e=this._animationStates;t<e.length;t++)e[t].returnToPool();for(var i in this._animations)delete this._animations[i];null!==this._animationConfig&&this._animationConfig.returnToPool(),this.timeScale=1,this._lockUpdate=!1,this._animationDirty=!1,this._inheritTimeScale=1,this._animationNames.length=0,this._animationStates.length=0,this._armature=null,this._animationConfig=null,this._lastAnimationState=null},i.prototype._fadeOut=function(t){switch(t.fadeOutMode){case 1:for(var e=0,i=this._animationStates;e<i.length;e++)null===(l=i[e])._parent&&l.layer===t.layer&&l.fadeOut(t.fadeOutTime,t.pauseFadeOut);break;case 2:for(var n=0,s=this._animationStates;n<s.length;n++)null===(l=s[n])._parent&&l.group===t.group&&l.fadeOut(t.fadeOutTime,t.pauseFadeOut);break;case 3:for(var r=0,o=this._animationStates;r<o.length;r++)null===(l=o[r])._parent&&l.layer===t.layer&&l.group===t.group&&l.fadeOut(t.fadeOutTime,t.pauseFadeOut);break;case 4:for(var a=0,c=this._animationStates;a<c.length;a++){var l;null===(l=c[a])._parent&&l.fadeOut(t.fadeOutTime,t.pauseFadeOut)}}},i.prototype.init=function(e){null===this._armature&&(this._armature=e,this._animationConfig=t.BaseObject.borrowObject(t.AnimationConfig))},i.prototype.advanceTime=function(t){t<0&&(t=-t),this._armature.inheritAnimation&&null!==this._armature._parent?this._inheritTimeScale=this._armature._parent._armature.animation._inheritTimeScale*this.timeScale:this._inheritTimeScale=this.timeScale,1!==this._inheritTimeScale&&(t*=this._inheritTimeScale);var e=this._animationStates.length;if(1===e)if((m=this._animationStates[0])._fadeState>0&&m._subFadeState>0)this._armature._dragonBones.bufferObject(m),this._animationStates.length=0,this._lastAnimationState=null;else{var i=m._animationData,n=i.cacheFrameRate;if(this._animationDirty&&n>0){this._animationDirty=!1;for(var s=0,r=this._armature.getBones();s<r.length;s++){var o=r[s];o._cachedFrameIndices=i.getBoneCachedFrameIndices(o.name)}for(var a=0,c=this._armature.getSlots();a<c.length;a++){var l=c[a],h=l.rawDisplayDatas;if(null!==h&&h.length>0){var _=h[0];if(null!==_&&_.parent===this._armature.armatureData.defaultSkin){l._cachedFrameIndices=i.getSlotCachedFrameIndices(l.name);continue}}l._cachedFrameIndices=null}}m.advanceTime(t,n)}else if(e>1){for(var u=0,d=0;u<e;++u){var m;(m=this._animationStates[u])._fadeState>0&&m._subFadeState>0?(d++,this._armature._dragonBones.bufferObject(m),this._animationDirty=!0,this._lastAnimationState===m&&(this._lastAnimationState=null)):(d>0&&(this._animationStates[u-d]=m),m.advanceTime(t,0)),u===e-1&&d>0&&(this._animationStates.length-=d,null===this._lastAnimationState&&this._animationStates.length>0&&(this._lastAnimationState=this._animationStates[this._animationStates.length-1]))}this._armature._cacheFrameIndex=-1}else this._armature._cacheFrameIndex=-1},i.prototype.reset=function(){for(var t=0,e=this._animationStates;t<e.length;t++)e[t].returnToPool();this._animationDirty=!1,this._animationConfig.clear(),this._animationStates.length=0,this._lastAnimationState=null},i.prototype.stop=function(t){if(void 0===t&&(t=null),null!==t)null!==(n=this.getState(t))&&n.stop();else for(var e=0,i=this._animationStates;e<i.length;e++){var n;(n=i[e]).stop()}},i.prototype.playConfig=function(e){var i=e.animation;if(!(i in this._animations))return console.warn("Non-existent animation.\n","DragonBones name: "+this._armature.armatureData.parent.name,"Armature name: "+this._armature.name,"Animation name: "+i),null;var n=this._animations[i];if(5===e.fadeOutMode)for(var s=0,r=this._animationStates;s<r.length;s++){var o=r[s];if(o._animationData===n)return o}0===this._animationStates.length?e.fadeInTime=0:e.fadeInTime<0&&(e.fadeInTime=n.fadeInTime),e.fadeOutTime<0&&(e.fadeOutTime=e.fadeInTime),e.timeScale<=-100&&(e.timeScale=1/n.scale),n.frameCount>1?(e.position<0?(e.position%=n.duration,e.position=n.duration-e.position):e.position===n.duration?e.position-=1e-6:e.position>n.duration&&(e.position%=n.duration),e.duration>0&&e.position+e.duration>n.duration&&(e.duration=n.duration-e.position),e.playTimes<0&&(e.playTimes=n.playTimes)):(e.playTimes=1,e.position=0,e.duration>0&&(e.duration=0)),0===e.duration&&(e.duration=-1),this._fadeOut(e);var a=t.BaseObject.borrowObject(t.AnimationState);if(a.init(this._armature,n,e),this._animationDirty=!0,this._armature._cacheFrameIndex=-1,this._animationStates.length>0){for(var c=!1,l=0,h=this._animationStates.length;l<h;++l){if(a.layer>this._animationStates[l].layer){c=!0,this._animationStates.splice(l,0,a);break}if(l!==h-1&&a.layer>this._animationStates[l+1].layer){c=!0,this._animationStates.splice(l+1,0,a);break}}c||this._animationStates.push(a)}else this._animationStates.push(a);for(var _=0,u=this._armature.getSlots();_<u.length;_++){var d=u[_].childArmature;null!==d&&d.inheritAnimation&&d.animation.hasAnimation(i)&&null===d.animation.getState(i)&&d.animation.fadeIn(i)}var m=!1;for(var p in n.animationTimelines){this._lockUpdate||(m=!0,this._lockUpdate=!0);var f=this.fadeIn(p,e.fadeInTime,1,a.layer,null,0);null!==f&&(f.resetToPose=!1,f._parent=a,f.stop())}return m&&(this._lockUpdate=!1),this._lockUpdate||(e.fadeInTime<=0&&this._armature.advanceTime(0),this._lastAnimationState=a),a},i.prototype.play=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=e,this._animationConfig.fadeInTime=0,this._animationConfig.animation=null!==t?t:"",null!==t&&t.length>0)this.playConfig(this._animationConfig);else if(null===this._lastAnimationState){var i=this._armature.armatureData.defaultAnimation;null!==i&&(this._animationConfig.animation=i.name,this.playConfig(this._animationConfig))}else this._lastAnimationState.isPlaying||this._lastAnimationState.isCompleted?(this._animationConfig.animation=this._lastAnimationState.name,this.playConfig(this._animationConfig)):this._lastAnimationState.play();return this._lastAnimationState},i.prototype.fadeIn=function(t,e,i,n,s,r){return void 0===e&&(e=-1),void 0===i&&(i=-1),void 0===n&&(n=0),void 0===s&&(s=null),void 0===r&&(r=3),this._animationConfig.clear(),this._animationConfig.fadeOutMode=r,this._animationConfig.playTimes=i,this._animationConfig.layer=n,this._animationConfig.fadeInTime=e,this._animationConfig.animation=t,this._animationConfig.group=null!==s?s:"",this.playConfig(this._animationConfig)},i.prototype.gotoAndPlayByTime=function(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=i,this._animationConfig.position=e,this._animationConfig.fadeInTime=0,this._animationConfig.animation=t,this.playConfig(this._animationConfig)},i.prototype.gotoAndPlayByFrame=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=i,this._animationConfig.fadeInTime=0,this._animationConfig.animation=t;var n=t in this._animations?this._animations[t]:null;return null!==n&&(this._animationConfig.position=n.duration*e/n.frameCount),this.playConfig(this._animationConfig)},i.prototype.gotoAndPlayByProgress=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=i,this._animationConfig.fadeInTime=0,this._animationConfig.animation=t;var n=t in this._animations?this._animations[t]:null;return null!==n&&(this._animationConfig.position=n.duration*(e>0?e:0)),this.playConfig(this._animationConfig)},i.prototype.gotoAndStopByTime=function(t,e){void 0===e&&(e=0);var i=this.gotoAndPlayByTime(t,e,1);return null!==i&&i.stop(),i},i.prototype.gotoAndStopByFrame=function(t,e){void 0===e&&(e=0);var i=this.gotoAndPlayByFrame(t,e,1);return null!==i&&i.stop(),i},i.prototype.gotoAndStopByProgress=function(t,e){void 0===e&&(e=0);var i=this.gotoAndPlayByProgress(t,e,1);return null!==i&&i.stop(),i},i.prototype.getState=function(t){for(var e=this._animationStates.length;e--;){var i=this._animationStates[e];if(i.name===t)return i}return null},i.prototype.hasAnimation=function(t){return t in this._animations},i.prototype.getStates=function(){return this._animationStates},Object.defineProperty(i.prototype,"isPlaying",{get:function(){for(var t=0,e=this._animationStates;t<e.length;t++)if(e[t].isPlaying)return!0;return!1},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isCompleted",{get:function(){for(var t=0,e=this._animationStates;t<e.length;t++)if(!e[t].isCompleted)return!1;return this._animationStates.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lastAnimationName",{get:function(){return null!==this._lastAnimationState?this._lastAnimationState.name:""},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animationNames",{get:function(){return this._animationNames},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animations",{get:function(){return this._animations},set:function(t){if(this._animations!==t){for(var e in this._animationNames.length=0,this._animations)delete this._animations[e];for(var e in t)this._animationNames.push(e),this._animations[e]=t[e]}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animationConfig",{get:function(){return this._animationConfig.clear(),this._animationConfig},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lastAnimationState",{get:function(){return this._lastAnimationState},enumerable:!0,configurable:!0}),i.prototype.gotoAndPlay=function(t,e,i,n,s,r,o){void 0===e&&(e=-1),void 0===i&&(i=-1),void 0===n&&(n=-1),void 0===s&&(s=0),void 0===r&&(r=null),void 0===o&&(o=3),console.warn("Deprecated."),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.fadeOutMode=o,this._animationConfig.playTimes=n,this._animationConfig.layer=s,this._animationConfig.fadeInTime=e,this._animationConfig.animation=t,this._animationConfig.group=null!==r?r:"";var a=this._animations[t];return a&&i>0&&(this._animationConfig.timeScale=a.duration/i),this.playConfig(this._animationConfig)},i.prototype.gotoAndStop=function(t,e){return void 0===e&&(e=0),console.warn("Deprecated."),this.gotoAndStopByTime(t,e)},Object.defineProperty(i.prototype,"animationList",{get:function(){return console.warn("Deprecated."),this._animationNames},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animationDataList",{get:function(){console.warn("Deprecated.");for(var t=[],e=0,i=this._animationNames.length;e<i;++e)t.push(this._animations[this._animationNames[e]]);return t},enumerable:!0,configurable:!0}),i}(t.BaseObject);t.Animation=e}(R$||(R$={})),function(t){var e=function(e){function s(){var t=null!==e&&e.apply(this,arguments)||this;return t._blendState=new n,t._boneMask=[],t._boneTimelines=[],t._surfaceTimelines=[],t._slotTimelines=[],t._constraintTimelines=[],t._animationTimelines=[],t._poseTimelines=[],t._bonePoses={},t._actionTimeline=null,t._zOrderTimeline=null,t._parent=null,t}return I$(s,e),s.toString=function(){return"[class dragonBones.AnimationState]"},s.prototype._onClear=function(){for(var t=0,e=this._boneTimelines;t<e.length;t++)e[t].returnToPool();for(var i=0,n=this._surfaceTimelines;i<n.length;i++)n[i].returnToPool();for(var s=0,r=this._slotTimelines;s<r.length;s++)r[s].returnToPool();for(var o=0,a=this._constraintTimelines;o<a.length;o++)a[o].returnToPool();for(var c=0,l=this._animationTimelines;c<l.length;c++)l[c].returnToPool();for(var h in this._bonePoses)this._bonePoses[h].returnToPool(),delete this._bonePoses[h];null!==this._actionTimeline&&this._actionTimeline.returnToPool(),null!==this._zOrderTimeline&&this._zOrderTimeline.returnToPool(),this.actionEnabled=!1,this.additiveBlending=!1,this.displayControl=!1,this.resetToPose=!1,this.playTimes=1,this.layer=0,this.timeScale=1,this.weight=1,this.autoFadeOutTime=0,this.fadeTotalTime=0,this.name="",this.group="",this._timelineDirty=2,this._playheadState=0,this._fadeState=-1,this._subFadeState=-1,this._position=0,this._duration=0,this._fadeTime=0,this._time=0,this._fadeProgress=0,this._weightResult=0,this._blendState.clear(),this._boneMask.length=0,this._boneTimelines.length=0,this._surfaceTimelines.length=0,this._slotTimelines.length=0,this._constraintTimelines.length=0,this._animationTimelines.length=0,this._poseTimelines.length=0,this._animationData=null,this._armature=null,this._actionTimeline=null,this._zOrderTimeline=null,this._parent=null},s.prototype._updateTimelines=function(){for(var e=0,i=this._armature._constraints;e<i.length;e++){var n=i[e];if(null!==(c=this._animationData.getConstraintTimelines(n.name)))for(var s=0,r=c;s<r.length;s++)switch((u=r[s]).type){case 30:(d=t.BaseObject.borrowObject(t.IKConstraintTimelineState)).constraint=n,d.init(this._armature,this,u),this._constraintTimelines.push(d)}else this.resetToPose&&((d=t.BaseObject.borrowObject(t.IKConstraintTimelineState)).constraint=n,d.init(this._armature,this,null),this._constraintTimelines.push(d),this._poseTimelines.push(d))}for(var o=0,a=this._armature.animation.getStates();o<a.length;o++){var c,l=a[o];if(l._parent===this&&null!==(c=this._animationData.getAnimationTimelines(l.name)))for(var h=0,_=c;h<_.length;h++){var u;switch((u=_[h]).type){case 40:var d;(d=t.BaseObject.borrowObject(t.AnimationTimelineState)).animationState=l,d.init(this._armature,this,u),this._animationTimelines.push(d)}}}},s.prototype._updateBoneAndSlotTimelines=function(){for(var e={},n=0,s=this._boneTimelines;n<s.length;n++)(c=(v=s[n]).bone.name)in e||(e[c]=[]),e[c].push(v);for(var r=0,o=this._armature.getBones();r<o.length;r++){var a=o[r],c=a.name;if(this.containsBoneMask(c))if(c in e)delete e[c];else if(0===a._boneData.type){var l=this._animationData.getBoneTimelines(c),h=c in this._bonePoses?this._bonePoses[c]:this._bonePoses[c]=t.BaseObject.borrowObject(i);if(null!==l)for(var _=0,u=l;_<u.length;_++)switch((D=u[_]).type){case 10:(v=t.BaseObject.borrowObject(t.BoneAllTimelineState)).bone=a,v.bonePose=h,v.init(this._armature,this,D),this._boneTimelines.push(v);break;case 11:(v=t.BaseObject.borrowObject(t.BoneTranslateTimelineState)).bone=a,v.bonePose=h,v.init(this._armature,this,D),this._boneTimelines.push(v);break;case 12:(v=t.BaseObject.borrowObject(t.BoneRotateTimelineState)).bone=a,v.bonePose=h,v.init(this._armature,this,D),this._boneTimelines.push(v);break;case 13:(v=t.BaseObject.borrowObject(t.BoneScaleTimelineState)).bone=a,v.bonePose=h,v.init(this._armature,this,D),this._boneTimelines.push(v)}else this.resetToPose&&((v=t.BaseObject.borrowObject(t.BoneAllTimelineState)).bone=a,v.bonePose=h,v.init(this._armature,this,null),this._boneTimelines.push(v),this._poseTimelines.push(v))}else if(1===a._boneData.type)if(null!==(l=this._animationData.getSurfaceTimelines(c)))for(var d=0,m=l;d<m.length;d++)switch((D=m[d]).type){case 50:(v=t.BaseObject.borrowObject(t.SurfaceTimelineState)).surface=a,v.init(this._armature,this,D),this._surfaceTimelines.push(v)}else this.resetToPose&&((v=t.BaseObject.borrowObject(t.SurfaceTimelineState)).surface=a,v.init(this._armature,this,null),this._surfaceTimelines.push(v),this._poseTimelines.push(v))}for(var p in e)for(var f=0,g=e[p];f<g.length;f++){var v=g[f];this._boneTimelines.splice(this._boneTimelines.indexOf(v),1),v.returnToPool()}for(var y={},x=[],S=0,C=this._slotTimelines;S<C.length;S++)(c=(v=C[S]).slot.name)in y||(y[c]=[]),y[c].push(v);for(var A=0,b=this._armature.getSlots();A<b.length;A++){var T=b[A],E=T.parent.name;if(this.containsBoneMask(E))if(c=T.name,l=this._animationData.getSlotTimelines(c),c in y)delete y[c];else{var P=!1,w=!1;if(x.length=0,null!==l)for(var I=0,R=l;I<R.length;I++){var D;switch((D=R[I]).type){case 20:(v=t.BaseObject.borrowObject(t.SlotDislayTimelineState)).slot=T,v.init(this._armature,this,D),this._slotTimelines.push(v),P=!0;break;case 21:(v=t.BaseObject.borrowObject(t.SlotColorTimelineState)).slot=T,v.init(this._armature,this,D),this._slotTimelines.push(v),w=!0;break;case 22:(v=t.BaseObject.borrowObject(t.DeformTimelineState)).slot=T,v.init(this._armature,this,D),this._slotTimelines.push(v),x.push(v.vertexOffset)}}if(this.resetToPose&&(P||((v=t.BaseObject.borrowObject(t.SlotDislayTimelineState)).slot=T,v.init(this._armature,this,null),this._slotTimelines.push(v),this._poseTimelines.push(v)),w||((v=t.BaseObject.borrowObject(t.SlotColorTimelineState)).slot=T,v.init(this._armature,this,null),this._slotTimelines.push(v),this._poseTimelines.push(v)),null!==T.rawDisplayDatas))for(var M=0,O=T.rawDisplayDatas;M<O.length;M++){var B=O[M];if(null!==B&&2===B.type){var N=B.vertices.offset;x.indexOf(N)<0&&((v=t.BaseObject.borrowObject(t.DeformTimelineState)).vertexOffset=N,v.slot=T,v.init(this._armature,this,null),this._slotTimelines.push(v),this._poseTimelines.push(v))}}}}for(var p in y)for(var L=0,F=y[p];L<F.length;L++)v=F[L],this._slotTimelines.splice(this._slotTimelines.indexOf(v),1),v.returnToPool()},s.prototype._advanceFadeTime=function(e){var i,n=this._fadeState>0;if(this._subFadeState<0){this._subFadeState=0;var s=n?t.EventObject.FADE_OUT:t.EventObject.FADE_IN;this._armature.eventDispatcher.hasDBEventListener(s)&&((i=t.BaseObject.borrowObject(t.EventObject)).type=s,i.armature=this._armature,i.animationState=this,this._armature._dragonBones.bufferEvent(i))}(e<0&&(e=-e),this._fadeTime+=e,this._fadeTime>=this.fadeTotalTime?(this._subFadeState=1,this._fadeProgress=n?0:1):this._fadeTime>0?this._fadeProgress=n?1-this._fadeTime/this.fadeTotalTime:this._fadeTime/this.fadeTotalTime:this._fadeProgress=n?1:0,this._subFadeState>0)&&(n||(this._playheadState|=1,this._fadeState=0),s=n?t.EventObject.FADE_OUT_COMPLETE:t.EventObject.FADE_IN_COMPLETE,this._armature.eventDispatcher.hasDBEventListener(s)&&((i=t.BaseObject.borrowObject(t.EventObject)).type=s,i.armature=this._armature,i.animationState=this,this._armature._dragonBones.bufferEvent(i)))},s.prototype.init=function(e,i,n){if(null===this._armature){if(this._armature=e,this._animationData=i,this.resetToPose=n.resetToPose,this.additiveBlending=n.additiveBlending,this.displayControl=n.displayControl,this.actionEnabled=n.actionEnabled,this.layer=n.layer,this.playTimes=n.playTimes,this.timeScale=n.timeScale,this.fadeTotalTime=n.fadeInTime,this.autoFadeOutTime=n.autoFadeOutTime,this.weight=n.weight,this.name=n.name.length>0?n.name:n.animation,this.group=n.group,n.pauseFadeIn?this._playheadState=2:this._playheadState=3,n.duration<0?(this._position=0,this._duration=this._animationData.duration,0!==n.position?this.timeScale>=0?this._time=n.position:this._time=n.position-this._duration:this._time=0):(this._position=n.position,this._duration=n.duration,this._time=0),this.timeScale<0&&0===this._time&&(this._time=-1e-6),this.fadeTotalTime<=0&&(this._fadeProgress=.999999),n.boneMask.length>0){this._boneMask.length=n.boneMask.length;for(var s=0,r=this._boneMask.length;s<r;++s)this._boneMask[s]=n.boneMask[s]}this._actionTimeline=t.BaseObject.borrowObject(t.ActionTimelineState),this._actionTimeline.init(this._armature,this,this._animationData.actionTimeline),this._actionTimeline.currentTime=this._time,this._actionTimeline.currentTime<0&&(this._actionTimeline.currentTime=this._duration-this._actionTimeline.currentTime),null!==this._animationData.zOrderTimeline&&(this._zOrderTimeline=t.BaseObject.borrowObject(t.ZOrderTimelineState),this._zOrderTimeline.init(this._armature,this,this._animationData.zOrderTimeline))}},s.prototype.advanceTime=function(e,i){if(this._blendState.dirty=!1,0===this._fadeState&&0===this._subFadeState||this._advanceFadeTime(e),3===this._playheadState&&(1!==this.timeScale&&(e*=this.timeScale),this._time+=e),0!==this._timelineDirty&&(2===this._timelineDirty&&this._updateTimelines(),this._timelineDirty=0,this._updateBoneAndSlotTimelines()),0!==this.weight){var n=0===this._fadeState&&i>0,s=!0,r=!0,o=this._time;if(this._weightResult=this.weight*this._fadeProgress,null!==this._parent&&(this._weightResult*=this._parent._weightResult/this._parent._fadeProgress),this._actionTimeline.playState<=0&&this._actionTimeline.update(o),n){var a=2*i;this._actionTimeline.currentTime=Math.floor(this._actionTimeline.currentTime*a)/a}if(null!==this._zOrderTimeline&&this._zOrderTimeline.playState<=0&&this._zOrderTimeline.update(o),n){var c=Math.floor(this._actionTimeline.currentTime*i);this._armature._cacheFrameIndex===c?(s=!1,r=!1):(this._armature._cacheFrameIndex=c,this._animationData.cachedFrames[c]?r=!1:this._animationData.cachedFrames[c]=!0)}if(s){if(r)for(var l=0,h=this._boneTimelines.length;l<h;++l)(p=this._boneTimelines[l]).playState<=0&&p.update(o),(l===h-1||p.bone!==this._boneTimelines[l+1].bone)&&0!==(_=p.bone._blendState.update(this._weightResult,this.layer))&&p.blend(_);for(l=0,h=this._surfaceTimelines.length;l<h;++l){var _=(p=this._surfaceTimelines[l]).surface._blendState.update(this._weightResult,this.layer);p.playState<=0&&p.update(o),0!==_&&p.blend(_)}if(this.displayControl)for(l=0,h=this._slotTimelines.length;l<h;++l){var u=(p=this._slotTimelines[l]).slot.displayController;null!==u&&u!==this.name&&u!==this.group||p.playState<=0&&p.update(o)}for(l=0,h=this._constraintTimelines.length;l<h;++l)(p=this._constraintTimelines[l]).playState<=0&&p.update(o);for(l=0,h=this._animationTimelines.length;l<h;++l)_=(p=this._animationTimelines[l]).animationState._blendState.update(this._weightResult,this.layer),p.playState<=0&&p.update(o),0!==_&&p.blend(_)}if(0===this._fadeState){if(this._subFadeState>0&&(this._subFadeState=0,this._poseTimelines.length>0)){for(var d=0,m=this._poseTimelines;d<m.length;d++){var p;(p=m[d])instanceof t.BoneTimelineState?this._boneTimelines.splice(this._boneTimelines.indexOf(p),1):p instanceof t.SurfaceTimelineState?this._surfaceTimelines.splice(this._surfaceTimelines.indexOf(p),1):p instanceof t.SlotTimelineState?this._slotTimelines.splice(this._slotTimelines.indexOf(p),1):p instanceof t.ConstraintTimelineState&&this._constraintTimelines.splice(this._constraintTimelines.indexOf(p),1),p.returnToPool()}this._poseTimelines.length=0}this._actionTimeline.playState>0&&this.autoFadeOutTime>=0&&this.fadeOut(this.autoFadeOutTime)}}},s.prototype.play=function(){this._playheadState=3},s.prototype.stop=function(){this._playheadState&=1},s.prototype.fadeOut=function(t,e){if(void 0===e&&(e=!0),t<0&&(t=0),e&&(this._playheadState&=2),this._fadeState>0){if(t>this.fadeTotalTime-this._fadeTime)return}else{this._fadeState=1,this._subFadeState=-1,(t<=0||this._fadeProgress<=0)&&(this._fadeProgress=1e-6);for(var i=0,n=this._boneTimelines;i<n.length;i++)(u=n[i]).fadeOut();for(var s=0,r=this._surfaceTimelines;s<r.length;s++)(u=r[s]).fadeOut();for(var o=0,a=this._slotTimelines;o<a.length;o++)(u=a[o]).fadeOut();for(var c=0,l=this._constraintTimelines;c<l.length;c++)(u=l[c]).fadeOut();for(var h=0,_=this._animationTimelines;h<_.length;h++){var u;(u=_[h]).animationState.fadeOut(t,e),u.fadeOut()}}this.displayControl=!1,this.fadeTotalTime=this._fadeProgress>1e-6?t/this._fadeProgress:0,this._fadeTime=this.fadeTotalTime*(1-this._fadeProgress)},s.prototype.containsBoneMask=function(t){return 0===this._boneMask.length||this._boneMask.indexOf(t)>=0},s.prototype.addBoneMask=function(t,e){void 0===e&&(e=!0);var i=this._armature.getBone(t);if(null!==i){if(this._boneMask.indexOf(t)<0&&this._boneMask.push(t),e)for(var n=0,s=this._armature.getBones();n<s.length;n++){var r=s[n];this._boneMask.indexOf(r.name)<0&&i.contains(r)&&this._boneMask.push(r.name)}this._timelineDirty=1}},s.prototype.removeBoneMask=function(t,e){void 0===e&&(e=!0);var i=this._boneMask.indexOf(t);if(i>=0&&this._boneMask.splice(i,1),e){var n=this._armature.getBone(t);if(null!==n){var s=this._armature.getBones();if(this._boneMask.length>0)for(var r=0,o=s;r<o.length;r++){var a=o[r],c=this._boneMask.indexOf(a.name);c>=0&&n.contains(a)&&this._boneMask.splice(c,1)}else for(var l=0,h=s;l<h.length;l++)(a=h[l])!==n&&(n.contains(a)||this._boneMask.push(a.name))}}this._timelineDirty=1},s.prototype.removeAllBoneMask=function(){this._boneMask.length=0,this._timelineDirty=1},Object.defineProperty(s.prototype,"isFadeIn",{get:function(){return this._fadeState<0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isFadeOut",{get:function(){return this._fadeState>0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isFadeComplete",{get:function(){return 0===this._fadeState},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isPlaying",{get:function(){return 0!=(2&this._playheadState)&&this._actionTimeline.playState<=0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isCompleted",{get:function(){return this._actionTimeline.playState>0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"currentPlayTimes",{get:function(){return this._actionTimeline.currentPlayTimes},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"totalTime",{get:function(){return this._duration},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"currentTime",{get:function(){return this._actionTimeline.currentTime},set:function(t){var e=this._actionTimeline.currentPlayTimes-(this._actionTimeline.playState>0?1:0);if((t<0||this._duration<t)&&(t=t%this._duration+e*this._duration)<0&&(t+=this._duration),this.playTimes>0&&e===this.playTimes-1&&t===this._duration&&(t=this._duration-1e-6),this._time!==t){this._time=t,this._actionTimeline.setCurrentTime(this._time),null!==this._zOrderTimeline&&(this._zOrderTimeline.playState=-1);for(var i=0,n=this._boneTimelines;i<n.length;i++)n[i].playState=-1;for(var s=0,r=this._slotTimelines;s<r.length;s++)r[s].playState=-1}},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"animationData",{get:function(){return this._animationData},enumerable:!0,configurable:!0}),s}(t.BaseObject);t.AnimationState=e;var i=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.current=new t.Transform,i.delta=new t.Transform,i.result=new t.Transform,i}return I$(i,e),i.toString=function(){return"[class dragonBones.BonePose]"},i.prototype._onClear=function(){this.current.identity(),this.delta.identity(),this.result.identity()},i}(t.BaseObject);t.BonePose=i;var n=function(){function t(){}return t.prototype.update=function(t,e){if(this.dirty){if(!(this.leftWeight>0))return 0;if(this.layer!==e){if(this.layerWeight>=this.leftWeight)return this.leftWeight=0,0;this.layer=e,this.leftWeight-=this.layerWeight,this.layerWeight=0}return t*=this.leftWeight,this.layerWeight+=t,this.blendWeight=t,2}return this.dirty=!0,this.layer=e,this.layerWeight=t,this.leftWeight=1,this.blendWeight=t,1},t.prototype.clear=function(){this.dirty=!1,this.layer=0,this.leftWeight=0,this.layerWeight=0,this.blendWeight=0},t}();t.BlendState=n}(R$||(R$={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.prototype._onClear=function(){this.playState=-1,this.currentPlayTimes=-1,this.currentTime=-1,this._tweenState=0,this._frameRate=0,this._frameValueOffset=0,this._frameCount=0,this._frameOffset=0,this._frameIndex=-1,this._frameRateR=0,this._position=0,this._duration=0,this._timeScale=1,this._timeOffset=0,this._dragonBonesData=null,this._animationData=null,this._timelineData=null,this._armature=null,this._animationState=null,this._actionTimeline=null,this._frameArray=null,this._frameIntArray=null,this._frameFloatArray=null,this._timelineArray=null,this._frameIndices=null},e.prototype._setCurrentTime=function(t){var e=this.playState,i=this.currentPlayTimes,n=this.currentTime;if(null!==this._actionTimeline&&this._frameCount<=1)this.playState=this._actionTimeline.playState>=0?1:-1,this.currentPlayTimes=1,this.currentTime=this._actionTimeline.currentTime;else if(null===this._actionTimeline||1!==this._timeScale||0!==this._timeOffset){var s=this._animationState.playTimes,r=s*this._duration;t*=this._timeScale,0!==this._timeOffset&&(t+=this._timeOffset*this._animationData.duration),s>0&&(t>=r||t<=-r)?(this.playState<=0&&3===this._animationState._playheadState&&(this.playState=1),this.currentPlayTimes=s,this.currentTime=t<0?0:this._duration+1e-6):(0!==this.playState&&3===this._animationState._playheadState&&(this.playState=0),t<0?(t=-t,this.currentPlayTimes=Math.floor(t/this._duration),this.currentTime=this._duration-t%this._duration):(this.currentPlayTimes=Math.floor(t/this._duration),this.currentTime=t%this._duration)),this.currentTime+=this._position}else this.playState=this._actionTimeline.playState,this.currentPlayTimes=this._actionTimeline.currentPlayTimes,this.currentTime=this._actionTimeline.currentTime;return(this.currentPlayTimes!==i||this.currentTime!==n)&&((e<0&&this.playState!==e||this.playState<=0&&this.currentPlayTimes!==i)&&(this._frameIndex=-1),!0)},e.prototype.init=function(t,e,i){this._armature=t,this._animationState=e,this._timelineData=i,this._actionTimeline=this._animationState._actionTimeline,this===this._actionTimeline&&(this._actionTimeline=null),this._animationData=this._animationState._animationData,this._frameRate=this._animationData.parent.frameRate,this._frameRateR=1/this._frameRate,this._position=this._animationState._position,this._duration=this._animationState._duration,this._dragonBonesData=this._animationData.parent.parent,null!==this._timelineData&&(this._frameIntArray=this._dragonBonesData.frameIntArray,this._frameFloatArray=this._dragonBonesData.frameFloatArray,this._frameArray=this._dragonBonesData.frameArray,this._timelineArray=this._dragonBonesData.timelineArray,this._frameIndices=this._dragonBonesData.frameIndices,this._frameCount=this._timelineArray[this._timelineData.offset+2],this._frameValueOffset=this._timelineArray[this._timelineData.offset+4],this._timeScale=100/this._timelineArray[this._timelineData.offset+0],this._timeOffset=.01*this._timelineArray[this._timelineData.offset+1])},e.prototype.fadeOut=function(){},e.prototype.update=function(t){if(this._setCurrentTime(t)){if(this._frameCount>1){var e=Math.floor(this.currentTime*this._frameRate),i=this._frameIndices[this._timelineData.frameIndicesOffset+e];this._frameIndex!==i&&(this._frameIndex=i,this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+this._frameIndex],this._onArriveAtFrame())}else this._frameIndex<0&&(this._frameIndex=0,null!==this._timelineData&&(this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5]),this._onArriveAtFrame());0!==this._tweenState&&this._onUpdateFrame()}},e}(t.BaseObject);t.TimelineState=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e._getEasingValue=function(t,e,i){var n=e;switch(t){case 3:n=Math.pow(e,2);break;case 4:n=1-Math.pow(1-e,2);break;case 5:n=.5*(1-Math.cos(e*Math.PI))}return(n-e)*i+e},e._getEasingCurveValue=function(t,e,i,n){if(t<=0)return 0;if(t>=1)return 1;var s=i+1,r=Math.floor(t*s),o=0===r?0:e[n+r-1];return 1e-4*(o+((r===s-1?1e4:e[n+r])-o)*(t*s-r))},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._tweenType=0,this._curveCount=0,this._framePosition=0,this._frameDurationR=0,this._tweenProgress=0,this._tweenEasing=0},e.prototype._onArriveAtFrame=function(){if(this._frameCount>1&&(this._frameIndex!==this._frameCount-1||0===this._animationState.playTimes||this._animationState.currentPlayTimes<this._animationState.playTimes-1))if(this._tweenType=this._frameArray[this._frameOffset+1],this._tweenState=0===this._tweenType?1:2,2===this._tweenType?this._curveCount=this._frameArray[this._frameOffset+2]:0!==this._tweenType&&1!==this._tweenType&&(this._tweenEasing=.01*this._frameArray[this._frameOffset+2]),this._framePosition=this._frameArray[this._frameOffset]*this._frameRateR,this._frameIndex===this._frameCount-1)this._frameDurationR=1/(this._animationData.duration-this._framePosition);else{var t=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+this._frameIndex+1],e=this._frameArray[t]*this._frameRateR-this._framePosition;this._frameDurationR=e>0?1/e:0}else this._tweenState=1},e.prototype._onUpdateFrame=function(){2===this._tweenState?(this._tweenProgress=(this.currentTime-this._framePosition)*this._frameDurationR,2===this._tweenType?this._tweenProgress=e._getEasingCurveValue(this._tweenProgress,this._frameArray,this._curveCount,this._frameOffset+3):1!==this._tweenType&&(this._tweenProgress=e._getEasingValue(this._tweenType,this._tweenProgress,this._tweenEasing))):this._tweenProgress=0},e}(e);t.TweenTimelineState=i;var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.prototype._onClear=function(){t.prototype._onClear.call(this),this.bone=null,this.bonePose=null},e.prototype.blend=function(t){var e=this.bone._blendState.blendWeight,i=this.bone.animationPose,n=this.bonePose.result;2===t?(i.x+=n.x*e,i.y+=n.y*e,i.rotation+=n.rotation*e,i.skew+=n.skew*e,i.scaleX+=(n.scaleX-1)*e,i.scaleY+=(n.scaleY-1)*e):1!==e?(i.x=n.x*e,i.y=n.y*e,i.rotation=n.rotation*e,i.skew=n.skew*e,i.scaleX=(n.scaleX-1)*e+1,i.scaleY=(n.scaleY-1)*e+1):(i.x=n.x,i.y=n.y,i.rotation=n.rotation,i.skew=n.skew,i.scaleX=n.scaleX,i.scaleY=n.scaleY),0===this._animationState._fadeState&&0===this._animationState._subFadeState||(this.bone._transformDirty=!0)},e}(i);t.BoneTimelineState=n;var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.prototype._onClear=function(){t.prototype._onClear.call(this),this.slot=null},e}(i);t.SlotTimelineState=s;var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.prototype._onClear=function(){t.prototype._onClear.call(this),this.constraint=null},e}(i);t.ConstraintTimelineState=r}(R$||(R$={})),function(t){var e=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return I$(i,e),i.toString=function(){return"[class dragonBones.ActionTimelineState]"},i.prototype._onCrossFrame=function(e){var i=this._armature.eventDispatcher;if(this._animationState.actionEnabled)for(var n=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+e],s=this._frameArray[n+1],r=this._animationData.parent.actions,o=0;o<s;++o){var a=r[this._frameArray[n+2+o]];if(0===a.type)(c=t.BaseObject.borrowObject(t.EventObject)).time=this._frameArray[n]/this._frameRate,c.animationState=this._animationState,t.EventObject.actionDataToInstance(a,c,this._armature),this._armature._bufferAction(c,!0);else{var c,l=10===a.type?t.EventObject.FRAME_EVENT:t.EventObject.SOUND_EVENT;(11===a.type||i.hasDBEventListener(l))&&((c=t.BaseObject.borrowObject(t.EventObject)).time=this._frameArray[n]/this._frameRate,c.animationState=this._animationState,t.EventObject.actionDataToInstance(a,c,this._armature),this._armature._dragonBones.bufferEvent(c))}}},i.prototype._onArriveAtFrame=function(){},i.prototype._onUpdateFrame=function(){},i.prototype.update=function(e){var i=this.playState,n=this.currentPlayTimes,s=this.currentTime;if(this._setCurrentTime(e)){var r=this._armature.eventDispatcher;if(i<0){if(this.playState===i)return;if(this._animationState.displayControl&&this._animationState.resetToPose&&this._armature._sortZOrder(null,0),n=this.currentPlayTimes,r.hasDBEventListener(t.EventObject.START)){var o=t.BaseObject.borrowObject(t.EventObject);o.type=t.EventObject.START,o.armature=this._armature,o.animationState=this._animationState,this._armature._dragonBones.bufferEvent(o)}}var a=this._animationState.timeScale<0,c=null,l=null;if(this.currentPlayTimes!==n&&(r.hasDBEventListener(t.EventObject.LOOP_COMPLETE)&&((c=t.BaseObject.borrowObject(t.EventObject)).type=t.EventObject.LOOP_COMPLETE,c.armature=this._armature,c.animationState=this._animationState),this.playState>0&&r.hasDBEventListener(t.EventObject.COMPLETE)&&((l=t.BaseObject.borrowObject(t.EventObject)).type=t.EventObject.COMPLETE,l.armature=this._armature,l.animationState=this._animationState)),this._frameCount>1){var h=this._timelineData,_=Math.floor(this.currentTime*this._frameRate),u=this._frameIndices[h.frameIndicesOffset+_];if(this._frameIndex!==u){var d=this._frameIndex;if(this._frameIndex=u,null!==this._timelineArray)if(this._frameOffset=this._animationData.frameOffset+this._timelineArray[h.offset+5+this._frameIndex],a){if(d<0){var m=Math.floor(s*this._frameRate);d=this._frameIndices[h.frameIndicesOffset+m],this.currentPlayTimes===n&&d===u&&(d=-1)}for(;d>=0;){var p=this._animationData.frameOffset+this._timelineArray[h.offset+5+d],f=this._frameArray[p]/this._frameRate;if(this._position<=f&&f<=this._position+this._duration&&this._onCrossFrame(d),null!==c&&0===d&&(this._armature._dragonBones.bufferEvent(c),c=null),d>0?d--:d=this._frameCount-1,d===u)break}}else for(d<0&&(m=Math.floor(s*this._frameRate),d=this._frameIndices[h.frameIndicesOffset+m],p=this._animationData.frameOffset+this._timelineArray[h.offset+5+d],f=this._frameArray[p]/this._frameRate,this.currentPlayTimes===n&&(s<=f?d>0?d--:d=this._frameCount-1:d===u&&(d=-1)));d>=0&&(d<this._frameCount-1?d++:d=0,p=this._animationData.frameOffset+this._timelineArray[h.offset+5+d],f=this._frameArray[p]/this._frameRate,this._position<=f&&f<=this._position+this._duration&&this._onCrossFrame(d),null!==c&&0===d&&(this._armature._dragonBones.bufferEvent(c),c=null),d!==u););}}else this._frameIndex<0&&(this._frameIndex=0,null!==this._timelineData)&&(this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5],f=this._frameArray[this._frameOffset]/this._frameRate,this.currentPlayTimes===n?s<=f&&this._onCrossFrame(this._frameIndex):this._position<=f&&(a||null===c||(this._armature._dragonBones.bufferEvent(c),c=null),this._onCrossFrame(this._frameIndex)));null!==c&&this._armature._dragonBones.bufferEvent(c),null!==l&&this._armature._dragonBones.bufferEvent(l)}},i.prototype.setCurrentTime=function(t){this._setCurrentTime(t),this._frameIndex=-1},i}(t.TimelineState);t.ActionTimelineState=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.toString=function(){return"[class dragonBones.ZOrderTimelineState]"},e.prototype._onArriveAtFrame=function(){this.playState>=0&&(this._frameArray[this._frameOffset+1]>0?this._armature._sortZOrder(this._frameArray,this._frameOffset+2):this._armature._sortZOrder(null,0))},e.prototype._onUpdateFrame=function(){},e}(t.TimelineState);t.ZOrderTimelineState=i;var n=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return I$(i,e),i.toString=function(){return"[class dragonBones.BoneAllTimelineState]"},i.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var t=this._animationData.frameFloatOffset+this._frameValueOffset+6*this._frameIndex,i=this._armature._armatureData.scale,n=this._frameFloatArray,s=this.bonePose.current,r=this.bonePose.delta;s.x=n[t++]*i,s.y=n[t++]*i,s.rotation=n[t++],s.skew=n[t++],s.scaleX=n[t++],s.scaleY=n[t++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(t=this._animationData.frameFloatOffset+this._frameValueOffset),r.x=n[t++]*i-s.x,r.y=n[t++]*i-s.y,r.rotation=n[t++]-s.rotation,r.skew=n[t++]-s.skew,r.scaleX=n[t++]-s.scaleX,r.scaleY=n[t++]-s.scaleY):(r.x=0,r.y=0,r.rotation=0,r.skew=0,r.scaleX=0,r.scaleY=0)}else s=this.bonePose.current,r=this.bonePose.delta,s.x=0,s.y=0,s.rotation=0,s.skew=0,s.scaleX=1,s.scaleY=1,r.x=0,r.y=0,r.rotation=0,r.skew=0,r.scaleX=0,r.scaleY=0},i.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this);var t=this.bonePose.current,i=this.bonePose.delta,n=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),n.x=t.x+i.x*this._tweenProgress,n.y=t.y+i.y*this._tweenProgress,n.rotation=t.rotation+i.rotation*this._tweenProgress,n.skew=t.skew+i.skew*this._tweenProgress,n.scaleX=t.scaleX+i.scaleX*this._tweenProgress,n.scaleY=t.scaleY+i.scaleY*this._tweenProgress},i.prototype.fadeOut=function(){var e=this.bonePose.result;e.rotation=t.Transform.normalizeRadian(e.rotation),e.skew=t.Transform.normalizeRadian(e.skew)},i}(t.BoneTimelineState);t.BoneAllTimelineState=n;var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.toString=function(){return"[class dragonBones.BoneTranslateTimelineState]"},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,i=this._armature._armatureData.scale,n=this._frameFloatArray,s=this.bonePose.current,r=this.bonePose.delta;s.x=n[e++]*i,s.y=n[e++]*i,2===this._tweenState?(this._frameIndex===this._frameCount-1&&(e=this._animationData.frameFloatOffset+this._frameValueOffset),r.x=n[e++]*i-s.x,r.y=n[e++]*i-s.y):(r.x=0,r.y=0)}else s=this.bonePose.current,r=this.bonePose.delta,s.x=0,s.y=0,r.x=0,r.y=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this);var e=this.bonePose.current,i=this.bonePose.delta,n=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),n.x=e.x+i.x*this._tweenProgress,n.y=e.y+i.y*this._tweenProgress},e}(t.BoneTimelineState);t.BoneTranslateTimelineState=s;var r=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return I$(i,e),i.toString=function(){return"[class dragonBones.BoneRotateTimelineState]"},i.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var i=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,n=this._frameFloatArray,s=this.bonePose.current,r=this.bonePose.delta;s.rotation=n[i++],s.skew=n[i++],2===this._tweenState?(this._frameIndex===this._frameCount-1?(i=this._animationData.frameFloatOffset+this._frameValueOffset,r.rotation=t.Transform.normalizeRadian(n[i++]-s.rotation)):r.rotation=n[i++]-s.rotation,r.skew=n[i++]-s.skew):(r.rotation=0,r.skew=0)}else s=this.bonePose.current,r=this.bonePose.delta,s.rotation=0,s.skew=0,r.rotation=0,r.skew=0},i.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this);var t=this.bonePose.current,i=this.bonePose.delta,n=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),n.rotation=t.rotation+i.rotation*this._tweenProgress,n.skew=t.skew+i.skew*this._tweenProgress},i.prototype.fadeOut=function(){var e=this.bonePose.result;e.rotation=t.Transform.normalizeRadian(e.rotation),e.skew=t.Transform.normalizeRadian(e.skew)},i}(t.BoneTimelineState);t.BoneRotateTimelineState=r;var o=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.toString=function(){return"[class dragonBones.BoneScaleTimelineState]"},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,i=this._frameFloatArray,n=this.bonePose.current,s=this.bonePose.delta;n.scaleX=i[e++],n.scaleY=i[e++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(e=this._animationData.frameFloatOffset+this._frameValueOffset),s.scaleX=i[e++]-n.scaleX,s.scaleY=i[e++]-n.scaleY):(s.scaleX=0,s.scaleY=0)}else n=this.bonePose.current,s=this.bonePose.delta,n.scaleX=1,n.scaleY=1,s.scaleX=0,s.scaleY=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this);var e=this.bonePose.current,i=this.bonePose.delta,n=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),n.scaleX=e.scaleX+i.scaleX*this._tweenProgress,n.scaleY=e.scaleY+i.scaleY*this._tweenProgress},e}(t.BoneTimelineState);t.BoneScaleTimelineState=o;var a=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._current=[],e._delta=[],e._result=[],e}return I$(e,t),e.toString=function(){return"[class dragonBones.SurfaceTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.surface=null,this._frameFloatOffset=0,this._valueCount=0,this._deformCount=0,this._valueOffset=0,this._current.length=0,this._delta.length=0,this._result.length=0},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+this._frameIndex*this._valueCount,i=this._armature._armatureData.scale,n=this._frameFloatArray;if(2===this._tweenState){var s=e+this._valueCount;this._frameIndex===this._frameCount-1&&(s=this._animationData.frameFloatOffset+this._frameValueOffset);for(var r=0;r<this._valueCount;++r)this._delta[r]=n[s+r]*i-(this._current[r]=n[e+r]*i)}else for(r=0;r<this._valueCount;++r)this._current[r]=n[e+r]*i}else for(r=0;r<this._valueCount;++r)this._current[r]=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),this.surface._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0);for(var e=0;e<this._valueCount;++e)this._result[e]=this._current[e]+this._delta[e]*this._tweenProgress},e.prototype.init=function(e,i,n){if(t.prototype.init.call(this,e,i,n),null!==this._timelineData){var s=this._animationData.frameIntOffset+this._timelineArray[this._timelineData.offset+3];this._deformCount=this._frameIntArray[s+1],this._valueCount=this._frameIntArray[s+2],this._valueOffset=this._frameIntArray[s+3],this._frameFloatOffset=this._frameIntArray[s+4]+this._animationData.frameFloatOffset}else this._deformCount=this.surface._deformVertices.length,this._valueCount=this._deformCount,this._valueOffset=0,this._frameFloatOffset=0;this._current.length=this._valueCount,this._delta.length=this._valueCount,this._result.length=this._valueCount;for(var r=0;r<this._valueCount;++r)this._delta[r]=0},e.prototype.blend=function(t){for(var e=this.surface._blendState.blendWeight,i=this.surface._deformVertices,n=0;n<this._deformCount;++n){var s;s=n<this._valueOffset?this._frameFloatArray[this._frameFloatOffset+n]:n<this._valueOffset+this._valueCount?this._result[n-this._valueOffset]:this._frameFloatArray[this._frameFloatOffset+n-this._valueCount],2===t?i[n]+=s*e:i[n]=1!==e?s*e:s}0===this._animationState._fadeState&&0===this._animationState._subFadeState||(this.surface._transformDirty=!0)},e}(t.TweenTimelineState);t.SurfaceTimelineState=a;var c=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.toString=function(){return"[class dragonBones.SlotDislayTimelineState]"},e.prototype._onArriveAtFrame=function(){if(this.playState>=0){var t=null!==this._timelineData?this._frameArray[this._frameOffset+1]:this.slot._slotData.displayIndex;this.slot.displayIndex!==t&&this.slot._setDisplayIndex(t,!0)}},e}(t.SlotTimelineState);t.SlotDislayTimelineState=c;var l=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._current=[0,0,0,0,0,0,0,0],e._delta=[0,0,0,0,0,0,0,0],e._result=[0,0,0,0,0,0,0,0],e}return I$(e,t),e.toString=function(){return"[class dragonBones.SlotColorTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._dirty=!1},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._dragonBonesData.intArray,i=this._frameIntArray,n=this._animationData.frameIntOffset+this._frameValueOffset+1*this._frameIndex,s=i[n];s<0&&(s+=65536),this._current[0]=e[s++],this._current[1]=e[s++],this._current[2]=e[s++],this._current[3]=e[s++],this._current[4]=e[s++],this._current[5]=e[s++],this._current[6]=e[s++],this._current[7]=e[s++],2===this._tweenState&&((s=this._frameIndex===this._frameCount-1?i[this._animationData.frameIntOffset+this._frameValueOffset]:i[n+1])<0&&(s+=65536),this._delta[0]=e[s++]-this._current[0],this._delta[1]=e[s++]-this._current[1],this._delta[2]=e[s++]-this._current[2],this._delta[3]=e[s++]-this._current[3],this._delta[4]=e[s++]-this._current[4],this._delta[5]=e[s++]-this._current[5],this._delta[6]=e[s++]-this._current[6],this._delta[7]=e[s++]-this._current[7])}else{var r=this.slot._slotData.color;this._current[0]=100*r.alphaMultiplier,this._current[1]=100*r.redMultiplier,this._current[2]=100*r.greenMultiplier,this._current[3]=100*r.blueMultiplier,this._current[4]=r.alphaOffset,this._current[5]=r.redOffset,this._current[6]=r.greenOffset,this._current[7]=r.blueOffset}},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),this._dirty=!0,2!==this._tweenState&&(this._tweenState=0),this._result[0]=.01*(this._current[0]+this._delta[0]*this._tweenProgress),this._result[1]=.01*(this._current[1]+this._delta[1]*this._tweenProgress),this._result[2]=.01*(this._current[2]+this._delta[2]*this._tweenProgress),this._result[3]=.01*(this._current[3]+this._delta[3]*this._tweenProgress),this._result[4]=this._current[4]+this._delta[4]*this._tweenProgress,this._result[5]=this._current[5]+this._delta[5]*this._tweenProgress,this._result[6]=this._current[6]+this._delta[6]*this._tweenProgress,this._result[7]=this._current[7]+this._delta[7]*this._tweenProgress},e.prototype.fadeOut=function(){this._tweenState=0,this._dirty=!1},e.prototype.update=function(e){if(t.prototype.update.call(this,e),0!==this._tweenState||this._dirty){var i=this.slot._colorTransform;if(0!==this._animationState._fadeState||0!==this._animationState._subFadeState){if(i.alphaMultiplier!==this._result[0]||i.redMultiplier!==this._result[1]||i.greenMultiplier!==this._result[2]||i.blueMultiplier!==this._result[3]||i.alphaOffset!==this._result[4]||i.redOffset!==this._result[5]||i.greenOffset!==this._result[6]||i.blueOffset!==this._result[7]){var n=Math.pow(this._animationState._fadeProgress,4);i.alphaMultiplier+=(this._result[0]-i.alphaMultiplier)*n,i.redMultiplier+=(this._result[1]-i.redMultiplier)*n,i.greenMultiplier+=(this._result[2]-i.greenMultiplier)*n,i.blueMultiplier+=(this._result[3]-i.blueMultiplier)*n,i.alphaOffset+=(this._result[4]-i.alphaOffset)*n,i.redOffset+=(this._result[5]-i.redOffset)*n,i.greenOffset+=(this._result[6]-i.greenOffset)*n,i.blueOffset+=(this._result[7]-i.blueOffset)*n,this.slot._colorDirty=!0}}else this._dirty&&(this._dirty=!1,i.alphaMultiplier===this._result[0]&&i.redMultiplier===this._result[1]&&i.greenMultiplier===this._result[2]&&i.blueMultiplier===this._result[3]&&i.alphaOffset===this._result[4]&&i.redOffset===this._result[5]&&i.greenOffset===this._result[6]&&i.blueOffset===this._result[7]||(i.alphaMultiplier=this._result[0],i.redMultiplier=this._result[1],i.greenMultiplier=this._result[2],i.blueMultiplier=this._result[3],i.alphaOffset=this._result[4],i.redOffset=this._result[5],i.greenOffset=this._result[6],i.blueOffset=this._result[7],this.slot._colorDirty=!0))}},e}(t.SlotTimelineState);t.SlotColorTimelineState=l;var h=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._current=[],e._delta=[],e._result=[],e}return I$(e,t),e.toString=function(){return"[class dragonBones.DeformTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.vertexOffset=0,this._dirty=!1,this._frameFloatOffset=0,this._valueCount=0,this._deformCount=0,this._valueOffset=0,this._current.length=0,this._delta.length=0,this._result.length=0},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+this._frameIndex*this._valueCount,i=this._armature._armatureData.scale,n=this._frameFloatArray;if(2===this._tweenState){var s=e+this._valueCount;this._frameIndex===this._frameCount-1&&(s=this._animationData.frameFloatOffset+this._frameValueOffset);for(var r=0;r<this._valueCount;++r)this._delta[r]=n[s+r]*i-(this._current[r]=n[e+r]*i)}else for(r=0;r<this._valueCount;++r)this._current[r]=n[e+r]*i}else for(r=0;r<this._valueCount;++r)this._current[r]=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),this._dirty=!0,2!==this._tweenState&&(this._tweenState=0);for(var e=0;e<this._valueCount;++e)this._result[e]=this._current[e]+this._delta[e]*this._tweenProgress},e.prototype.init=function(e,i,n){if(t.prototype.init.call(this,e,i,n),null!==this._timelineData){var s=this._animationData.frameIntOffset+this._timelineArray[this._timelineData.offset+3];this.vertexOffset=this._frameIntArray[s+0],this.vertexOffset<0&&(this.vertexOffset+=65536),this._deformCount=this._frameIntArray[s+1],this._valueCount=this._frameIntArray[s+2],this._valueOffset=this._frameIntArray[s+3],this._frameFloatOffset=this._frameIntArray[s+4]+this._animationData.frameFloatOffset}else{var r=this.slot._deformVertices;this._deformCount=null!==r?r.vertices.length:0,this._valueCount=this._deformCount,this._valueOffset=0,this._frameFloatOffset=0}this._current.length=this._valueCount,this._delta.length=this._valueCount,this._result.length=this._valueCount;for(var o=0;o<this._valueCount;++o)this._delta[o]=0},e.prototype.fadeOut=function(){this._tweenState=0,this._dirty=!1},e.prototype.update=function(e){var i=this.slot._deformVertices;if(null!==i&&null!==i.verticesData&&i.verticesData.offset===this.vertexOffset&&(t.prototype.update.call(this,e),0!==this._tweenState||this._dirty)){var n=i.vertices;if(0!==this._animationState._fadeState||0!==this._animationState._subFadeState){for(var s=Math.pow(this._animationState._fadeProgress,2),r=0;r<this._deformCount;++r)r<this._valueOffset?n[r]+=(this._frameFloatArray[this._frameFloatOffset+r]-n[r])*s:r<this._valueOffset+this._valueCount?n[r]+=(this._result[r-this._valueOffset]-n[r])*s:n[r]+=(this._frameFloatArray[this._frameFloatOffset+r-this._valueCount]-n[r])*s;i.verticesDirty=!0}else if(this._dirty){for(this._dirty=!1,r=0;r<this._deformCount;++r)r<this._valueOffset?n[r]=this._frameFloatArray[this._frameFloatOffset+r]:r<this._valueOffset+this._valueCount?n[r]=this._result[r-this._valueOffset]:n[r]=this._frameFloatArray[this._frameFloatOffset+r-this._valueCount];i.verticesDirty=!0}}},e}(t.SlotTimelineState);t.DeformTimelineState=h;var _=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.toString=function(){return"[class dragonBones.IKConstraintTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._current=0,this._delta=0},e.prototype._onArriveAtFrame=function(){t.prototype._onArriveAtFrame.call(this);var e=this.constraint;if(null!==this._timelineData){var i=this._animationData.frameIntOffset+this._frameValueOffset+2*this._frameIndex,n=this._frameIntArray,s=0!==n[i++];this._current=.01*n[i++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(i=this._animationData.frameIntOffset+this._frameValueOffset),this._delta=.01*n[i+1]-this._current):this._delta=0,e._bendPositive=s}else{var r=e._constraintData;this._current=r.weight,this._delta=0,e._bendPositive=r.bendPositive}e.invalidUpdate()},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),2!==this._tweenState&&(this._tweenState=0);var e=this.constraint;e._weight=this._current+this._delta*this._tweenProgress,e.invalidUpdate()},e}(t.ConstraintTimelineState);t.IKConstraintTimelineState=_;var u=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._floats=[0,0,0,0,0,0],e}return I$(e,t),e.toString=function(){return"[class dragonBones.AnimationTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.animationState=null},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameIntOffset+this._frameValueOffset+2*this._frameIndex,i=1/this.animationState._animationData.parent.frameRate,n=this._frameIntArray;this._floats[0]=n[e++]*i,this._floats[3]=.01*n[e++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(e=this._animationData.frameIntOffset+this._frameValueOffset),this._floats[1]=n[e++]*i-this._floats[0],this._floats[4]=.01*n[e++]-this._floats[3]):(this._floats[1]=0,this._floats[4]=0)}},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),2!==this._tweenState&&(this._tweenState=0),this._floats[0]>=0&&(this._floats[2]=this._floats[0]+this._floats[1]*this._tweenProgress),this._floats[5]=this._floats[3]+this._floats[4]*this._tweenProgress},e.prototype.blend=function(t){var e=this.animationState,i=e._blendState.blendWeight;2===t?(e.weight+=this._floats[5]*i,e.currentTime+=this._floats[2]*i):(e.weight=this._floats[5]*i,e.currentTime=this._floats[2]*i)},e}(t.TweenTimelineState);t.AnimationTimelineState=u}(R$||(R$={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return I$(e,t),e.actionDataToInstance=function(t,i,n){0===t.type?i.type=e.FRAME_EVENT:i.type=10===t.type?e.FRAME_EVENT:e.SOUND_EVENT,i.name=t.name,i.armature=n,i.actionData=t,i.data=t.data,null!==t.bone&&(i.bone=n.getBone(t.bone.name)),null!==t.slot&&(i.slot=n.getSlot(t.slot.name))},e.toString=function(){return"[class dragonBones.EventObject]"},e.prototype._onClear=function(){this.time=0,this.type="",this.name="",this.armature=null,this.bone=null,this.slot=null,this.animationState=null,this.actionData=null,this.data=null},e.START="start",e.LOOP_COMPLETE="loopComplete",e.COMPLETE="complete",e.FADE_IN="fadeIn",e.FADE_IN_COMPLETE="fadeInComplete",e.FADE_OUT="fadeOut",e.FADE_OUT_COMPLETE="fadeOutComplete",e.FRAME_EVENT="frameEvent",e.SOUND_EVENT="soundEvent",e}(t.BaseObject);t.EventObject=e}(R$||(R$={})),function(t){var e=function(){function e(){}return e._getArmatureType=function(t){switch(t.toLowerCase()){case"stage":return 2;case"armature":return 0;case"movieclip":return 1;default:return 0}},e._getBoneType=function(t){switch(t.toLowerCase()){case"bone":return 0;case"surface":return 1;default:return 0}},e._getDisplayType=function(t){switch(t.toLowerCase()){case"image":return 0;case"mesh":return 2;case"armature":return 1;case"boundingbox":return 3;case"path":return 4;default:return 0}},e._getBoundingBoxType=function(t){switch(t.toLowerCase()){case"rectangle":return 0;case"ellipse":return 1;case"polygon":return 2;default:return 0}},e._getActionType=function(t){switch(t.toLowerCase()){case"play":return 0;case"frame":return 10;case"sound":return 11;default:return 0}},e._getBlendMode=function(t){switch(t.toLowerCase()){case"normal":return 0;case"add":return 1;case"alpha":return 2;case"darken":return 3;case"difference":return 4;case"erase":return 5;case"hardlight":return 6;case"invert":return 7;case"layer":return 8;case"lighten":return 9;case"multiply":return 10;case"overlay":return 11;case"screen":return 12;case"subtract":return 13;default:return 0}},e._getPositionMode=function(t){switch(t.toLocaleLowerCase()){case"percent":return 1;case"fixed":return 0;default:return 1}},e._getSpacingMode=function(t){switch(t.toLocaleLowerCase()){case"length":return 0;case"percent":return 2;case"fixed":return 1;default:return 0}},e._getRotateMode=function(t){switch(t.toLocaleLowerCase()){case"tangent":return 0;case"chain":return 1;case"chainscale":return 2;default:return 0}},e.parseDragonBonesData=function(e){return console.warn("Deprecated."),e instanceof ArrayBuffer?t.BinaryDataParser.getInstance().parseDragonBonesData(e):t.ObjectDataParser.getInstance().parseDragonBonesData(e)},e.parseTextureAtlasData=function(i,n){void 0===n&&(n=1),console.warn("已废弃");for(var s={},r=i[e.SUB_TEXTURE],o=0,a=r.length;o<a;o++){var c=r[o],l=c[e.NAME],h=new t.Rectangle,_=null;h.x=c[e.X]/n,h.y=c[e.Y]/n,h.width=c[e.WIDTH]/n,h.height=c[e.HEIGHT]/n,e.FRAME_WIDTH in c&&((_=new t.Rectangle).x=c[e.FRAME_X]/n,_.y=c[e.FRAME_Y]/n,_.width=c[e.FRAME_WIDTH]/n,_.height=c[e.FRAME_HEIGHT]/n),s[l]={region:h,frame:_,rotated:!1}}return s},e.DATA_VERSION_2_3="2.3",e.DATA_VERSION_3_0="3.0",e.DATA_VERSION_4_0="4.0",e.DATA_VERSION_4_5="4.5",e.DATA_VERSION_5_0="5.0",e.DATA_VERSION_5_5="5.5",e.DATA_VERSION=e.DATA_VERSION_5_5,e.DATA_VERSIONS=[e.DATA_VERSION_4_0,e.DATA_VERSION_4_5,e.DATA_VERSION_5_0,e.DATA_VERSION_5_5],e.TEXTURE_ATLAS="textureAtlas",e.SUB_TEXTURE="SubTexture",e.FORMAT="format",e.IMAGE_PATH="imagePath",e.WIDTH="width",e.HEIGHT="height",e.ROTATED="rotated",e.FRAME_X="frameX",e.FRAME_Y="frameY",e.FRAME_WIDTH="frameWidth",e.FRAME_HEIGHT="frameHeight",e.DRADON_BONES="dragonBones",e.USER_DATA="userData",e.ARMATURE="armature",e.BONE="bone",e.SURFACE="surface",e.SLOT="slot",e.CONSTRAINT="constraint",e.IK="ik",e.PATH_CONSTRAINT="path",e.SKIN="skin",e.DISPLAY="display",e.ANIMATION="animation",e.Z_ORDER="zOrder",e.FFD="ffd",e.FRAME="frame",e.TRANSLATE_FRAME="translateFrame",e.ROTATE_FRAME="rotateFrame",e.SCALE_FRAME="scaleFrame",e.DISPLAY_FRAME="displayFrame",e.COLOR_FRAME="colorFrame",e.DEFAULT_ACTIONS="defaultActions",e.ACTIONS="actions",e.EVENTS="events",e.INTS="ints",e.FLOATS="floats",e.STRINGS="strings",e.CANVAS="canvas",e.TRANSFORM="transform",e.PIVOT="pivot",e.AABB="aabb",e.COLOR="color",e.VERSION="version",e.COMPATIBLE_VERSION="compatibleVersion",e.FRAME_RATE="frameRate",e.TYPE="type",e.SUB_TYPE="subType",e.NAME="name",e.PARENT="parent",e.TARGET="target",e.STAGE="stage",e.SHARE="share",e.PATH="path",e.LENGTH="length",e.DISPLAY_INDEX="displayIndex",e.BLEND_MODE="blendMode",e.INHERIT_TRANSLATION="inheritTranslation",e.INHERIT_ROTATION="inheritRotation",e.INHERIT_SCALE="inheritScale",e.INHERIT_REFLECTION="inheritReflection",e.INHERIT_ANIMATION="inheritAnimation",e.INHERIT_DEFORM="inheritDeform",e.SEGMENT_X="segmentX",e.SEGMENT_Y="segmentY",e.BEND_POSITIVE="bendPositive",e.CHAIN="chain",e.WEIGHT="weight",e.FADE_IN_TIME="fadeInTime",e.PLAY_TIMES="playTimes",e.SCALE="scale",e.OFFSET="offset",e.POSITION="position",e.DURATION="duration",e.TWEEN_EASING="tweenEasing",e.TWEEN_ROTATE="tweenRotate",e.TWEEN_SCALE="tweenScale",e.CLOCK_WISE="clockwise",e.CURVE="curve",e.SOUND="sound",e.EVENT="event",e.ACTION="action",e.X="x",e.Y="y",e.SKEW_X="skX",e.SKEW_Y="skY",e.SCALE_X="scX",e.SCALE_Y="scY",e.VALUE="value",e.ROTATE="rotate",e.SKEW="skew",e.ALPHA_OFFSET="aO",e.RED_OFFSET="rO",e.GREEN_OFFSET="gO",e.BLUE_OFFSET="bO",e.ALPHA_MULTIPLIER="aM",e.RED_MULTIPLIER="rM",e.GREEN_MULTIPLIER="gM",e.BLUE_MULTIPLIER="bM",e.UVS="uvs",e.VERTICES="vertices",e.TRIANGLES="triangles",e.WEIGHTS="weights",e.SLOT_POSE="slotPose",e.BONE_POSE="bonePose",e.GLUE_WEIGHTS="glueWeights",e.GLUE_MESHES="glueMeshes",e.BONES="bones",e.POSITION_MODE="positionMode",e.SPACING_MODE="spacingMode",e.ROTATE_MODE="rotateMode",e.SPACING="spacing",e.ROTATE_OFFSET="rotateOffset",e.ROTATE_MIX="rotateMix",e.TRANSLATE_MIX="translateMix",e.TARGET_DISPLAY="targetDisplay",e.CLOSED="closed",e.CONSTANT_SPEED="constantSpeed",e.VERTEX_COUNT="vertexCount",e.LENGTHS="lengths",e.GOTO_AND_PLAY="gotoAndPlay",e.DEFAULT_NAME="default",e}();t.DataParser=e}(R$||(R$={})),function(t){var e=function(e){function n(){var i=null!==e&&e.apply(this,arguments)||this;return i._rawTextureAtlasIndex=0,i._rawBones=[],i._data=null,i._armature=null,i._bone=null,i._surface=null,i._slot=null,i._skin=null,i._mesh=null,i._animation=null,i._timeline=null,i._rawTextureAtlases=null,i._defaultColorOffset=-1,i._prevClockwise=0,i._prevRotation=0,i._helpMatrixA=new t.Matrix,i._helpMatrixB=new t.Matrix,i._helpTransform=new t.Transform,i._helpColorTransform=new t.ColorTransform,i._helpPoint=new t.Point,i._helpArray=[],i._intArray=[],i._floatArray=[],i._frameIntArray=[],i._frameFloatArray=[],i._frameArray=[],i._timelineArray=[],i._cacheRawMeshes=[],i._cacheMeshes=[],i._actionFrames=[],i._weightSlotPose={},i._weightBonePoses={},i._cacheBones={},i._slotChildActions={},i}return I$(n,e),n._getBoolean=function(t,e,i){if(e in t){var n=t[e],s=typeof n;if("boolean"===s)return n;if("string"!==s)return!!n;switch(n){case"0":case"NaN":case"":case"false":case"null":case"undefined":return!1;default:return!0}}return i},n._getNumber=function(t,e,i){if(e in t){var n=t[e];return null===n||"NaN"===n?i:+n||0}return i},n._getString=function(e,i,n){if(i in e){var s=e[i];if("string"==typeof s){if(t.DragonBones.webAssembly)for(var r=0,o=s.length;r<o;++r)if(s.charCodeAt(r)>255)return encodeURI(s);return s}return String(s)}return n},n.prototype._getCurvePoint=function(t,e,i,n,s,r,o,a,c,l){var h=1-c,_=h*h,u=c*c,d=h*_,m=3*c*_,p=3*h*u,f=c*u;l.x=d*t+m*i+p*s+f*o,l.y=d*e+m*n+p*r+f*a},n.prototype._samplingEasingCurve=function(t,e){for(var i=t.length,n=-2,s=0,r=e.length;s<r;++s){for(var o=(s+1)/(r+1);(n+6<i?t[n+6]:1)<o;)n+=6;for(var a=n>=0&&n+6<i,c=a?t[n]:0,l=a?t[n+1]:0,h=t[n+2],_=t[n+3],u=t[n+4],d=t[n+5],m=a?t[n+6]:1,p=a?t[n+7]:1,f=0,g=1;g-f>1e-4;){var v=.5*(g+f);this._getCurvePoint(c,l,h,_,u,d,m,p,v,this._helpPoint),o-this._helpPoint.x>0?f=v:g=v}e[s]=this._helpPoint.y}},n.prototype._parseActionDataInFrame=function(e,i,n,s){t.DataParser.EVENT in e&&this._mergeActionFrame(e[t.DataParser.EVENT],i,10,n,s),t.DataParser.SOUND in e&&this._mergeActionFrame(e[t.DataParser.SOUND],i,11,n,s),t.DataParser.ACTION in e&&this._mergeActionFrame(e[t.DataParser.ACTION],i,0,n,s),t.DataParser.EVENTS in e&&this._mergeActionFrame(e[t.DataParser.EVENTS],i,10,n,s),t.DataParser.ACTIONS in e&&this._mergeActionFrame(e[t.DataParser.ACTIONS],i,0,n,s)},n.prototype._mergeActionFrame=function(e,n,s,r,o){for(var a=t.DragonBones.webAssembly?this._armature.actions.size():this._armature.actions.length,c=this._parseActionData(e,s,r,o),l=0,h=null,_=0,u=c;_<u.length;_++){var d=u[_];this._armature.addAction(d,!1)}0===this._actionFrames.length&&((h=new i).frameStart=0,this._actionFrames.push(h),h=null);for(var m=0,p=this._actionFrames;m<p.length;m++){var f=p[m];if(f.frameStart===n){h=f;break}if(f.frameStart>n)break;l++}null===h&&((h=new i).frameStart=n,this._actionFrames.splice(l+1,0,h));for(var g=0;g<c.length;++g)h.actions.push(a+g)},n.prototype._parseArmature=function(e,i){var s=t.BaseObject.borrowObject(t.ArmatureData);if(s.name=n._getString(e,t.DataParser.NAME,""),s.frameRate=n._getNumber(e,t.DataParser.FRAME_RATE,this._data.frameRate),s.scale=i,t.DataParser.TYPE in e&&"string"==typeof e[t.DataParser.TYPE]?s.type=t.DataParser._getArmatureType(e[t.DataParser.TYPE]):s.type=n._getNumber(e,t.DataParser.TYPE,0),0===s.frameRate&&(s.frameRate=24),this._armature=s,t.DataParser.CANVAS in e){var r=e[t.DataParser.CANVAS],o=t.BaseObject.borrowObject(t.CanvasData);t.DataParser.COLOR in r?o.hasBackground=!0:o.hasBackground=!1,o.color=n._getNumber(r,t.DataParser.COLOR,0),o.x=n._getNumber(r,t.DataParser.X,0)*s.scale,o.y=n._getNumber(r,t.DataParser.Y,0)*s.scale,o.width=n._getNumber(r,t.DataParser.WIDTH,0)*s.scale,o.height=n._getNumber(r,t.DataParser.HEIGHT,0)*s.scale,s.canvas=o}if(t.DataParser.AABB in e){var a=e[t.DataParser.AABB];s.aabb.x=n._getNumber(a,t.DataParser.X,0)*s.scale,s.aabb.y=n._getNumber(a,t.DataParser.Y,0)*s.scale,s.aabb.width=n._getNumber(a,t.DataParser.WIDTH,0)*s.scale,s.aabb.height=n._getNumber(a,t.DataParser.HEIGHT,0)*s.scale}if(t.DataParser.BONE in e)for(var c=0,l=e[t.DataParser.BONE];c<l.length;c++){var h=l[c],_=n._getString(h,t.DataParser.PARENT,""),u=this._parseBone(h);if(_.length>0){var d=s.getBone(_);null!==d?u.parent=d:(_ in this._cacheBones||(this._cacheBones[_]=[]),this._cacheBones[_].push(u))}if(u.name in this._cacheBones){for(var m=0,p=this._cacheBones[u.name];m<p.length;m++)p[m].parent=u;delete this._cacheBones[u.name]}s.addBone(u),this._rawBones.push(u)}if(t.DataParser.IK in e)for(var f=0,g=e[t.DataParser.IK];f<g.length;f++){var v=g[f];(w=this._parseIKConstraint(v))&&s.addConstraint(w)}if(s.sortBones(),t.DataParser.SLOT in e)for(var y=0,x=0,S=e[t.DataParser.SLOT];x<S.length;x++){var C=S[x];s.addSlot(this._parseSlot(C,y++))}if(t.DataParser.SKIN in e)for(var A=0,b=e[t.DataParser.SKIN];A<b.length;A++){var T=b[A];s.addSkin(this._parseSkin(T))}if(t.DataParser.PATH_CONSTRAINT in e)for(var E=0,P=e[t.DataParser.PATH_CONSTRAINT];E<P.length;E++){var w,I=P[E];(w=this._parsePathConstraint(I))&&s.addConstraint(w)}for(var R=0,D=this._cacheRawMeshes.length;R<D;++R){var M=this._cacheRawMeshes[R];t.DataParser.GLUE_WEIGHTS in M&&t.DataParser.GLUE_MESHES in M&&this._parseMeshGlue(M,this._cacheMeshes[R])}for(R=0,D=this._cacheRawMeshes.length;R<D;++R){var O=this._cacheRawMeshes[R],B=n._getString(O,t.DataParser.SHARE,"");if(0!==B.length){var N=n._getString(O,t.DataParser.SKIN,t.DataParser.DEFAULT_NAME);0===N.length&&(N=t.DataParser.DEFAULT_NAME);var L=s.getMesh(N,"",B);null!==L&&this._cacheMeshes[R].vertices.shareFrom(L.vertices)}}if(t.DataParser.ANIMATION in e)for(var F=0,z=e[t.DataParser.ANIMATION];F<z.length;F++){var V=z[F],G=this._parseAnimation(V);s.addAnimation(G)}if(t.DataParser.DEFAULT_ACTIONS in e)for(var U=0,k=this._parseActionData(e[t.DataParser.DEFAULT_ACTIONS],0,null,null);U<k.length;U++){var H=k[U];s.addAction(H,!0),0===H.type&&null!==(G=s.getAnimation(H.name))&&(s.defaultAnimation=G)}if(t.DataParser.ACTIONS in e)for(var j=0,W=this._parseActionData(e[t.DataParser.ACTIONS],0,null,null);j<W.length;j++)H=W[j],s.addAction(H,!1);for(var q in this._rawBones.length=0,this._cacheRawMeshes.length=0,this._cacheMeshes.length=0,this._armature=null,this._weightSlotPose)delete this._weightSlotPose[q];for(var q in this._weightBonePoses)delete this._weightBonePoses[q];for(var q in this._cacheBones)delete this._cacheBones[q];for(var q in this._slotChildActions)delete this._slotChildActions[q];return s},n.prototype._parseBone=function(e){var i=this._armature.scale;if(0===(t.DataParser.TYPE in e&&"string"==typeof e[t.DataParser.TYPE]?t.DataParser._getBoneType(e[t.DataParser.TYPE]):n._getNumber(e,t.DataParser.TYPE,0))){var s=t.BaseObject.borrowObject(t.BoneData);return s.inheritTranslation=n._getBoolean(e,t.DataParser.INHERIT_TRANSLATION,!0),s.inheritRotation=n._getBoolean(e,t.DataParser.INHERIT_ROTATION,!0),s.inheritScale=n._getBoolean(e,t.DataParser.INHERIT_SCALE,!0),s.inheritReflection=n._getBoolean(e,t.DataParser.INHERIT_REFLECTION,!0),s.length=n._getNumber(e,t.DataParser.LENGTH,0)*i,s.name=n._getString(e,t.DataParser.NAME,""),t.DataParser.TRANSFORM in e&&this._parseTransform(e[t.DataParser.TRANSFORM],s.transform,i),s}var r=t.BaseObject.borrowObject(t.SurfaceData);if(r.name=n._getString(e,t.DataParser.NAME,""),r.segmentX=n._getNumber(e,t.DataParser.SEGMENT_X,0),r.segmentY=n._getNumber(e,t.DataParser.SEGMENT_Y,0),r.vertices.length=(r.segmentX+1)*(r.segmentY+1)*2,t.DataParser.VERTICES in e)for(var o=e[t.DataParser.VERTICES],a=0,c=r.vertices.length;a<c;++a)a<o.length?r.vertices[a]=o[a]*i:r.vertices[a]=0;return r},n.prototype._parseIKConstraint=function(e){var i=this._armature.getBone(n._getString(e,t.DataParser.BONE,""));if(null===i)return null;var s=this._armature.getBone(n._getString(e,t.DataParser.TARGET,""));if(null===s)return null;var r=t.BaseObject.borrowObject(t.IKConstraintData);return r.scaleEnabled=n._getBoolean(e,t.DataParser.SCALE,!1),r.bendPositive=n._getBoolean(e,t.DataParser.BEND_POSITIVE,!0),r.weight=n._getNumber(e,t.DataParser.WEIGHT,1),r.name=n._getString(e,t.DataParser.NAME,""),r.type=0,r.target=s,n._getNumber(e,t.DataParser.CHAIN,0)>0&&null!==i.parent?(r.root=i.parent,r.bone=i):(r.root=i,r.bone=null),r},n.prototype._parsePathConstraint=function(e){var i=this._armature.getSlot(n._getString(e,t.DataParser.TARGET,""));if(null===i)return null;var s=this._armature.defaultSkin;if(null===s)return null;var r=s.getDisplay(i.name,n._getString(e,t.DataParser.TARGET_DISPLAY,i.name));if(null===r||!(r instanceof t.PathDisplayData))return null;var o=e[t.DataParser.BONES];if(null===o||0===o.length)return null;var a=t.BaseObject.borrowObject(t.PathConstraintData);a.name=n._getString(e,t.DataParser.NAME,""),a.type=1,a.pathSlot=i,a.pathDisplayData=r,a.target=i.parent,a.positionMode=t.DataParser._getPositionMode(n._getString(e,t.DataParser.POSITION_MODE,"")),a.spacingMode=t.DataParser._getSpacingMode(n._getString(e,t.DataParser.SPACING_MODE,"")),a.rotateMode=t.DataParser._getRotateMode(n._getString(e,t.DataParser.ROTATE_MODE,"")),a.position=n._getNumber(e,t.DataParser.POSITION,0),a.spacing=n._getNumber(e,t.DataParser.SPACING,0),a.rotateOffset=n._getNumber(e,t.DataParser.ROTATE_OFFSET,0),a.rotateMix=n._getNumber(e,t.DataParser.ROTATE_MIX,1),a.translateMix=n._getNumber(e,t.DataParser.TRANSLATE_MIX,1);for(var c=0,l=o;c<l.length;c++){var h=l[c],_=this._armature.getBone(h);null!==_&&(a.AddBone(_),null===a.root&&(a.root=_))}return a},n.prototype._parseSlot=function(e,i){var s=t.BaseObject.borrowObject(t.SlotData);return s.displayIndex=n._getNumber(e,t.DataParser.DISPLAY_INDEX,0),s.zOrder=i,s.name=n._getString(e,t.DataParser.NAME,""),s.parent=this._armature.getBone(n._getString(e,t.DataParser.PARENT,"")),t.DataParser.BLEND_MODE in e&&"string"==typeof e[t.DataParser.BLEND_MODE]?s.blendMode=t.DataParser._getBlendMode(e[t.DataParser.BLEND_MODE]):s.blendMode=n._getNumber(e,t.DataParser.BLEND_MODE,0),t.DataParser.COLOR in e?(s.color=t.SlotData.createColor(),this._parseColorTransform(e[t.DataParser.COLOR],s.color)):s.color=t.SlotData.DEFAULT_COLOR,t.DataParser.ACTIONS in e&&(this._slotChildActions[s.name]=this._parseActionData(e[t.DataParser.ACTIONS],0,null,null)),s},n.prototype._parseSkin=function(e){var i=t.BaseObject.borrowObject(t.SkinData);if(i.name=n._getString(e,t.DataParser.NAME,t.DataParser.DEFAULT_NAME),0===i.name.length&&(i.name=t.DataParser.DEFAULT_NAME),t.DataParser.SLOT in e){var s=e[t.DataParser.SLOT];this._skin=i;for(var r=0,o=s;r<o.length;r++){var a=o[r],c=n._getString(a,t.DataParser.NAME,""),l=this._armature.getSlot(c);if(null!==l){if(this._slot=l,t.DataParser.DISPLAY in a)for(var h=0,_=a[t.DataParser.DISPLAY];h<_.length;h++){var u=_[h];u?i.addDisplay(c,this._parseDisplay(u)):i.addDisplay(c,null)}this._slot=null}}this._skin=null}return i},n.prototype._parseDisplay=function(e){var i=n._getString(e,t.DataParser.NAME,""),s=n._getString(e,t.DataParser.PATH,""),r=0,o=null;switch(r=t.DataParser.TYPE in e&&"string"==typeof e[t.DataParser.TYPE]?t.DataParser._getDisplayType(e[t.DataParser.TYPE]):n._getNumber(e,t.DataParser.TYPE,r)){case 0:var a=o=t.BaseObject.borrowObject(t.ImageDisplayData);a.name=i,a.path=s.length>0?s:i,this._parsePivot(e,a);break;case 1:var c=o=t.BaseObject.borrowObject(t.ArmatureDisplayData);if(c.name=i,c.path=s.length>0?s:i,c.inheritAnimation=!0,t.DataParser.ACTIONS in e)for(var l=0,h=this._parseActionData(e[t.DataParser.ACTIONS],0,null,null);l<h.length;l++){var _=h[l];c.addAction(_)}else if(this._slot.name in this._slotChildActions){var u=this._skin.getDisplays(this._slot.name);if(null===u?0===this._slot.displayIndex:this._slot.displayIndex===u.length){for(var d=0,m=this._slotChildActions[this._slot.name];d<m.length;d++)_=m[d],c.addAction(_);delete this._slotChildActions[this._slot.name]}}break;case 2:var p=o=t.BaseObject.borrowObject(t.MeshDisplayData);p.vertices.inheritDeform=n._getBoolean(e,t.DataParser.INHERIT_DEFORM,!0),p.name=i,p.path=s.length>0?s:i,p.vertices.data=this._data,t.DataParser.SHARE in e?(this._cacheRawMeshes.push(e),this._cacheMeshes.push(p)):this._parseMesh(e,p),t.DataParser.GLUE_WEIGHTS in e&&t.DataParser.GLUE_MESHES in e&&(this._cacheRawMeshes.push(e),this._cacheMeshes.push(p));break;case 3:var f=this._parseBoundingBox(e);if(null!==f){var g=o=t.BaseObject.borrowObject(t.BoundingBoxDisplayData);g.name=i,g.path=s.length>0?s:i,g.boundingBox=f}break;case 4:var v=e[t.DataParser.LENGTHS],y=o=t.BaseObject.borrowObject(t.PathDisplayData);y.closed=n._getBoolean(e,t.DataParser.CLOSED,!1),y.constantSpeed=n._getBoolean(e,t.DataParser.CONSTANT_SPEED,!1),y.name=i,y.path=s.length>0?s:i,y.vertices.data=this._data,y.curveLengths.length=v.length;for(var x=0,S=v.length;x<S;++x)y.curveLengths[x]=v[x];this._parsePath(e,y)}return null!==o&&t.DataParser.TRANSFORM in e&&this._parseTransform(e[t.DataParser.TRANSFORM],o.transform,this._armature.scale),o},n.prototype._parsePath=function(e,i){var s=e[t.DataParser.VERTICES],r=n._getNumber(e,t.DataParser.VERTEX_COUNT,0),o=this._floatArray.length,a=this._intArray.length;if(i.vertices.offset=a,this._intArray.length+=2,this._intArray[a+0]=r,this._intArray[a+2]=o,t.DataParser.WEIGHTS in e){var c=e[t.DataParser.WEIGHTS],l=e[t.DataParser.BONES],h=l.length,_=Math.floor(c.length-r)/2,u=this._intArray.length,d=this._floatArray.length,m=this._armature.sortedBones,p=t.BaseObject.borrowObject(t.WeightData);for(p.count=_,p.offset=u,this._intArray.length+=2+h+r+_,this._intArray[u+0]=h,this._intArray[u+1]=d,w=0;w<h;w++){var f=l[w],g=this._rawBones[f];p.addBone(g),this._intArray[u+2+w]=m.indexOf(g)}this._floatArray.length+=3*_,w=0;for(var v=0,y=0,x=u+2+h,S=d;w<_;w++){var C=c[v++];this._intArray[x++]=C;for(var A=0;A<C;A++){var b=c[v++],T=c[v++],E=s[y++],P=s[y++];this._intArray[x++]=l.indexOf(b),this._floatArray[S++]=T,this._floatArray[S++]=E,this._floatArray[S++]=P}}i.vertices.weight=p}else{this._floatArray.length+=s.length;for(var w=0,I=s.length;w<I;++w)this._floatArray[o+w]=s[w]}},n.prototype._parsePivot=function(e,i){if(t.DataParser.PIVOT in e){var s=e[t.DataParser.PIVOT];i.pivot.x=n._getNumber(s,t.DataParser.X,0),i.pivot.y=n._getNumber(s,t.DataParser.Y,0)}else i.pivot.x=.5,i.pivot.y=.5},n.prototype._parseMesh=function(e,i){var n=e[t.DataParser.VERTICES],s=e[t.DataParser.UVS],r=e[t.DataParser.TRIANGLES],o=Math.floor(n.length/2),a=Math.floor(r.length/3),c=this._floatArray.length,l=c+2*o,h=this._intArray.length,_=this._skin.name+"_"+this._slot.name+"_"+i.name;i.vertices.offset=h,this._intArray.length+=4+3*a,this._intArray[h+0]=o,this._intArray[h+1]=a,this._intArray[h+2]=c;for(var u=0,d=3*a;u<d;++u)this._intArray[h+4+u]=r[u];for(this._floatArray.length+=2*o+2*o,u=0,d=2*o;u<d;++u)this._floatArray[c+u]=n[u],this._floatArray[l+u]=s[u];if(t.DataParser.WEIGHTS in e){var m=e[t.DataParser.WEIGHTS],p=e[t.DataParser.SLOT_POSE],f=e[t.DataParser.BONE_POSE],g=this._armature.sortedBones,v=new Array,y=Math.floor(f.length/7),x=this._floatArray.length,S=Math.floor(m.length-o)/2,C=this._intArray.length,A=t.BaseObject.borrowObject(t.WeightData);for(A.count=S,A.offset=C,v.length=y,this._intArray.length+=2+y+o+S,this._intArray[C+1]=x,u=0;u<y;++u){var b=f[7*u],T=this._rawBones[b];A.addBone(T),v[u]=b,this._intArray[C+2+u]=g.indexOf(T)}this._floatArray.length+=3*S,this._helpMatrixA.copyFromArray(p,0),u=0;for(var E=0,P=C+2+y,w=x;u<o;++u){var I=2*u,R=this._intArray[P++]=m[E++],D=this._floatArray[c+I],M=this._floatArray[c+I+1];this._helpMatrixA.transformPoint(D,M,this._helpPoint),D=this._helpPoint.x,M=this._helpPoint.y;for(var O=0;O<R;++O){b=m[E++];var B=v.indexOf(b);this._helpMatrixB.copyFromArray(f,7*B+1),this._helpMatrixB.invert(),this._helpMatrixB.transformPoint(D,M,this._helpPoint),this._intArray[P++]=B,this._floatArray[w++]=m[E++],this._floatArray[w++]=this._helpPoint.x,this._floatArray[w++]=this._helpPoint.y}}i.vertices.weight=A,this._weightSlotPose[_]=p,this._weightBonePoses[_]=f}},n.prototype._parseMeshGlue=function(){},n.prototype._parseBoundingBox=function(e){var i=null,s=0;switch(s=t.DataParser.SUB_TYPE in e&&"string"==typeof e[t.DataParser.SUB_TYPE]?t.DataParser._getBoundingBoxType(e[t.DataParser.SUB_TYPE]):n._getNumber(e,t.DataParser.SUB_TYPE,s)){case 0:i=t.BaseObject.borrowObject(t.RectangleBoundingBoxData);break;case 1:i=t.BaseObject.borrowObject(t.EllipseBoundingBoxData);break;case 2:i=this._parsePolygonBoundingBox(e)}return null!==i&&(i.color=n._getNumber(e,t.DataParser.COLOR,0),0!==i.type&&1!==i.type||(i.width=n._getNumber(e,t.DataParser.WIDTH,0),i.height=n._getNumber(e,t.DataParser.HEIGHT,0))),i},n.prototype._parsePolygonBoundingBox=function(e){var i=t.BaseObject.borrowObject(t.PolygonBoundingBoxData);if(t.DataParser.VERTICES in e){var n=this._armature.scale,s=e[t.DataParser.VERTICES],r=i.vertices;t.DragonBones.webAssembly?r.resize(s.length,0):r.length=s.length;for(var o=0,a=s.length;o<a;o+=2){var c=s[o]*n,l=s[o+1]*n;t.DragonBones.webAssembly?(r.set(o,c),r.set(o+1,l)):(r[o]=c,r[o+1]=l),0===o?(i.x=c,i.y=l,i.width=c,i.height=l):(c<i.x?i.x=c:c>i.width&&(i.width=c),l<i.y?i.y=l:l>i.height&&(i.height=l))}i.width-=i.x,i.height-=i.y}else console.warn("Data error.\n Please reexport DragonBones Data to fixed the bug.");return i},n.prototype._parseAnimation=function(e){var i=t.BaseObject.borrowObject(t.AnimationData);if(i.frameCount=Math.max(n._getNumber(e,t.DataParser.DURATION,1),1),i.playTimes=n._getNumber(e,t.DataParser.PLAY_TIMES,1),i.duration=i.frameCount/this._armature.frameRate,i.fadeInTime=n._getNumber(e,t.DataParser.FADE_IN_TIME,0),i.scale=n._getNumber(e,t.DataParser.SCALE,1),i.name=n._getString(e,t.DataParser.NAME,t.DataParser.DEFAULT_NAME),0===i.name.length&&(i.name=t.DataParser.DEFAULT_NAME),i.frameIntOffset=this._frameIntArray.length,i.frameFloatOffset=this._frameFloatArray.length,i.frameOffset=this._frameArray.length,this._animation=i,t.DataParser.FRAME in e){var s=e[t.DataParser.FRAME],r=s.length;if(r>0)for(var o=0,a=0;o<r;++o){var c=s[o];this._parseActionDataInFrame(c,a,null,null),a+=n._getNumber(c,t.DataParser.DURATION,1)}}if(t.DataParser.Z_ORDER in e&&(this._animation.zOrderTimeline=this._parseTimeline(e[t.DataParser.Z_ORDER],null,t.DataParser.FRAME,1,!1,!1,0,this._parseZOrderFrame)),t.DataParser.BONE in e)for(var l=0,h=e[t.DataParser.BONE];l<h.length;l++){var _=h[l];this._parseBoneTimeline(_)}if(t.DataParser.SURFACE in e)for(var u=0,d=e[t.DataParser.SURFACE];u<d.length;u++){_=d[u];var m=n._getString(_,t.DataParser.NAME,"");this._surface=this._armature.getBone(m),null!==this._surface&&(null!==(w=this._parseTimeline(_,null,t.DataParser.FRAME,50,!1,!0,0,this._parseSurfaceFrame))&&this._animation.addSurfaceTimeline(this._surface,w),this._surface=null)}if(t.DataParser.SLOT in e)for(var p=0,f=e[t.DataParser.SLOT];p<f.length;p++)_=f[p],this._parseSlotTimeline(_);if(t.DataParser.FFD in e)for(var g=0,v=e[t.DataParser.FFD];g<v.length;g++){_=v[g];var y=n._getString(_,t.DataParser.SKIN,t.DataParser.DEFAULT_NAME),x=n._getString(_,t.DataParser.SLOT,""),S=n._getString(_,t.DataParser.NAME,"");0===y.length&&(y=t.DataParser.DEFAULT_NAME),this._slot=this._armature.getSlot(x),this._mesh=this._armature.getMesh(y,x,S),null!==this._slot&&null!==this._mesh&&(null!==(w=this._parseTimeline(_,null,t.DataParser.FRAME,22,!1,!0,0,this._parseSlotFFDFrame))&&this._animation.addSlotTimeline(this._slot,w),this._slot=null,this._mesh=null)}if(t.DataParser.IK in e)for(var C=0,A=e[t.DataParser.IK];C<A.length;C++){_=A[C];var b=n._getString(_,t.DataParser.NAME,""),T=this._armature.getConstraint(b);null!==T&&null!==(w=this._parseTimeline(_,null,t.DataParser.FRAME,30,!0,!1,2,this._parseIKConstraintFrame))&&this._animation.addConstraintTimeline(T,w)}if(t.DataParser.ANIMATION in e)for(var E=0,P=e[t.DataParser.ANIMATION];E<P.length;E++){_=P[E];var w,I=n._getString(_,t.DataParser.NAME,"");null!==(w=this._parseTimeline(_,null,t.DataParser.FRAME,40,!0,!1,2,this._parseAnimationFrame))&&this._animation.addAnimationTimeline(I,w)}return this._actionFrames.length>0&&(this._animation.actionTimeline=this._parseTimeline(null,this._actionFrames,"",0,!1,!1,0,this._parseActionFrame),this._actionFrames.length=0),this._animation=null,i},n.prototype._parseTimeline=function(e,s,r,o,a,c,l,h){if(null!==e&&r.length>0&&r in e&&(s=e[r]),null===s)return null;var _=s.length;if(0===_)return null;var u=this._frameIntArray.length,d=this._frameFloatArray.length,m=t.BaseObject.borrowObject(t.TimelineData),p=this._timelineArray.length;if(this._timelineArray.length+=5+_,null!==e?(this._timelineArray[p+0]=Math.round(100*n._getNumber(e,t.DataParser.SCALE,1)),this._timelineArray[p+1]=Math.round(100*n._getNumber(e,t.DataParser.OFFSET,0))):(this._timelineArray[p+0]=100,this._timelineArray[p+1]=0),this._timelineArray[p+2]=_,this._timelineArray[p+3]=l,this._timelineArray[p+4]=a?u-this._animation.frameIntOffset:c?d-this._animation.frameFloatOffset:0,this._timeline=m,m.type=o,m.offset=p,1===_)m.frameIndicesOffset=-1,this._timelineArray[p+5+0]=h.call(this,s[0],0,0)-this._animation.frameOffset;else{var f=this._animation.frameCount+1,g=this._data.frameIndices,v=0;t.DragonBones.webAssembly?(v=g.size(),g.resize(v+f,0)):(v=g.length,g.length+=f),m.frameIndicesOffset=v;for(var y=0,x=0,S=0,C=0;y<f;++y){if(S+C<=y&&x<_){var A=s[x];S=y,C=x===_-1?this._animation.frameCount-S:A instanceof i?this._actionFrames[x+1].frameStart-S:n._getNumber(A,t.DataParser.DURATION,1),this._timelineArray[p+5+x]=h.call(this,A,S,C)-this._animation.frameOffset,x++}t.DragonBones.webAssembly?g.set(v+y,x-1):g[v+y]=x-1}}return this._timeline=null,m},n.prototype._parseBoneTimeline=function(e){var i,s=this._armature.getBone(n._getString(e,t.DataParser.NAME,""));null!==s&&(this._bone=s,this._slot=this._armature.getSlot(this._bone.name),t.DataParser.TRANSLATE_FRAME in e&&null!==(i=this._parseTimeline(e,null,t.DataParser.TRANSLATE_FRAME,11,!1,!0,2,this._parseBoneTranslateFrame))&&this._animation.addBoneTimeline(s,i),t.DataParser.ROTATE_FRAME in e&&null!==(i=this._parseTimeline(e,null,t.DataParser.ROTATE_FRAME,12,!1,!0,2,this._parseBoneRotateFrame))&&this._animation.addBoneTimeline(s,i),t.DataParser.SCALE_FRAME in e&&null!==(i=this._parseTimeline(e,null,t.DataParser.SCALE_FRAME,13,!1,!0,2,this._parseBoneScaleFrame))&&this._animation.addBoneTimeline(s,i),t.DataParser.FRAME in e&&null!==(i=this._parseTimeline(e,null,t.DataParser.FRAME,10,!1,!0,6,this._parseBoneAllFrame))&&this._animation.addBoneTimeline(s,i),this._bone=null,this._slot=null)},n.prototype._parseSlotTimeline=function(e){var i=this._armature.getSlot(n._getString(e,t.DataParser.NAME,""));if(null!==i){this._slot=i;var s;null!==(s=t.DataParser.DISPLAY_FRAME in e?this._parseTimeline(e,null,t.DataParser.DISPLAY_FRAME,20,!1,!1,0,this._parseSlotDisplayFrame):this._parseTimeline(e,null,t.DataParser.FRAME,20,!1,!1,0,this._parseSlotDisplayFrame))&&this._animation.addSlotTimeline(i,s);var r;null!==(r=t.DataParser.COLOR_FRAME in e?this._parseTimeline(e,null,t.DataParser.COLOR_FRAME,21,!0,!1,1,this._parseSlotColorFrame):this._parseTimeline(e,null,t.DataParser.FRAME,21,!0,!1,1,this._parseSlotColorFrame))&&this._animation.addSlotTimeline(i,r),this._slot=null}},n.prototype._parseFrame=function(t,e){var i=this._frameArray.length;return this._frameArray.length+=1,this._frameArray[i+0]=e,i},n.prototype._parseTweenFrame=function(e,i,s){var r=this._parseFrame(e,i,s);if(s>0)if(t.DataParser.CURVE in e){var o=s+1;this._helpArray.length=o,this._samplingEasingCurve(e[t.DataParser.CURVE],this._helpArray),this._frameArray.length+=2+this._helpArray.length,this._frameArray[r+1]=2,this._frameArray[r+2]=o;for(var a=0;a<o;++a)this._frameArray[r+3+a]=Math.round(1e4*this._helpArray[a])}else{var c=-2;t.DataParser.TWEEN_EASING in e&&(c=n._getNumber(e,t.DataParser.TWEEN_EASING,-2)),-2===c?(this._frameArray.length+=1,this._frameArray[r+1]=0):0===c?(this._frameArray.length+=1,this._frameArray[r+1]=1):c<0?(this._frameArray.length+=2,this._frameArray[r+1]=3,this._frameArray[r+2]=Math.round(100*-c)):c<=1?(this._frameArray.length+=2,this._frameArray[r+1]=4,this._frameArray[r+2]=Math.round(100*c)):(this._frameArray.length+=2,this._frameArray[r+1]=5,this._frameArray[r+2]=Math.round(100*c-100))}else this._frameArray.length+=1,this._frameArray[r+1]=0;return r},n.prototype._parseActionFrame=function(t,e){var i=this._frameArray.length,n=t.actions.length;this._frameArray.length+=2+n,this._frameArray[i+0]=e,this._frameArray[i+0+1]=n;for(var s=0;s<n;++s)this._frameArray[i+0+2+s]=t.actions[s];return i},n.prototype._parseZOrderFrame=function(e,i,n){var s=this._parseFrame(e,i,n);if(t.DataParser.Z_ORDER in e){var r=e[t.DataParser.Z_ORDER];if(r.length>0){for(var o=this._armature.sortedSlots.length,a=new Array(o-r.length/2),c=new Array(o),l=0;l<a.length;++l)a[l]=0;for(var h=0;h<o;++h)c[h]=-1;for(var _=0,u=0,d=0,m=r.length;d<m;d+=2){for(var p=r[d],f=r[d+1];_!==p;)a[u++]=_++;c[_+f]=_++}for(;_<o;)a[u++]=_++;this._frameArray.length+=1+o,this._frameArray[s+1]=o;for(var g=o;g--;)-1===c[g]?this._frameArray[s+2+g]=a[--u]||0:this._frameArray[s+2+g]=c[g]||0;return s}}return this._frameArray.length+=1,this._frameArray[s+1]=0,s},n.prototype._parseBoneAllFrame=function(e,i,s){this._helpTransform.identity(),t.DataParser.TRANSFORM in e&&this._parseTransform(e[t.DataParser.TRANSFORM],this._helpTransform,1);var r=this._helpTransform.rotation;0!==i&&(0===this._prevClockwise?r=this._prevRotation+t.Transform.normalizeRadian(r-this._prevRotation):((this._prevClockwise>0?r>=this._prevRotation:r<=this._prevRotation)&&(this._prevClockwise=this._prevClockwise>0?this._prevClockwise-1:this._prevClockwise+1),r=this._prevRotation+r-this._prevRotation+t.Transform.PI_D*this._prevClockwise)),this._prevClockwise=n._getNumber(e,t.DataParser.TWEEN_ROTATE,0),this._prevRotation=r;var o=this._parseTweenFrame(e,i,s),a=this._frameFloatArray.length;return this._frameFloatArray.length+=6,this._frameFloatArray[a++]=this._helpTransform.x,this._frameFloatArray[a++]=this._helpTransform.y,this._frameFloatArray[a++]=r,this._frameFloatArray[a++]=this._helpTransform.skew,this._frameFloatArray[a++]=this._helpTransform.scaleX,this._frameFloatArray[a++]=this._helpTransform.scaleY,this._parseActionDataInFrame(e,i,this._bone,this._slot),o},n.prototype._parseBoneTranslateFrame=function(e,i,s){var r=this._parseTweenFrame(e,i,s),o=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[o++]=n._getNumber(e,t.DataParser.X,0),this._frameFloatArray[o++]=n._getNumber(e,t.DataParser.Y,0),r},n.prototype._parseBoneRotateFrame=function(e,i,s){var r=n._getNumber(e,t.DataParser.ROTATE,0)*t.Transform.DEG_RAD;0!==i&&(0===this._prevClockwise?r=this._prevRotation+t.Transform.normalizeRadian(r-this._prevRotation):((this._prevClockwise>0?r>=this._prevRotation:r<=this._prevRotation)&&(this._prevClockwise=this._prevClockwise>0?this._prevClockwise-1:this._prevClockwise+1),r=this._prevRotation+r-this._prevRotation+t.Transform.PI_D*this._prevClockwise)),this._prevClockwise=n._getNumber(e,t.DataParser.CLOCK_WISE,0),this._prevRotation=r;var o=this._parseTweenFrame(e,i,s),a=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[a++]=r,this._frameFloatArray[a++]=n._getNumber(e,t.DataParser.SKEW,0)*t.Transform.DEG_RAD,o},n.prototype._parseBoneScaleFrame=function(e,i,s){var r=this._parseTweenFrame(e,i,s),o=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[o++]=n._getNumber(e,t.DataParser.X,1),this._frameFloatArray[o++]=n._getNumber(e,t.DataParser.Y,1),r},n.prototype._parseSurfaceFrame=function(e,i,s){var r=this._frameFloatArray.length,o=this._parseTweenFrame(e,i,s),a=e[t.DataParser.VERTICES],c=n._getNumber(e,t.DataParser.OFFSET,0),l=this._surface.vertices.length/2,h=0,_=0;this._frameFloatArray.length+=2*l;for(var u=0;u<2*l;u+=2)h=u<c||u-c>=a.length?0:a[u-c],_=u+1<c||u+1-c>=a.length?0:a[u+1-c],this._frameFloatArray[r+u]=h,this._frameFloatArray[r+u+1]=_;if(0===i){var d=this._frameIntArray.length;this._frameIntArray.length+=5,this._frameIntArray[d+0]=0,this._frameIntArray[d+1]=this._frameFloatArray.length-r,this._frameIntArray[d+2]=this._frameFloatArray.length-r,this._frameIntArray[d+3]=0,this._frameIntArray[d+4]=r-this._animation.frameFloatOffset,this._timelineArray[this._timeline.offset+3]=d-this._animation.frameIntOffset}return o},n.prototype._parseSlotDisplayFrame=function(e,i,s){var r=this._parseFrame(e,i,s);return this._frameArray.length+=1,t.DataParser.VALUE in e?this._frameArray[r+1]=n._getNumber(e,t.DataParser.VALUE,0):this._frameArray[r+1]=n._getNumber(e,t.DataParser.DISPLAY_INDEX,0),this._parseActionDataInFrame(e,i,this._slot.parent,this._slot),r},n.prototype._parseSlotColorFrame=function(e,i,n){var s=this._parseTweenFrame(e,i,n),r=-1;if(t.DataParser.VALUE in e||t.DataParser.COLOR in e){var o=t.DataParser.VALUE in e?e[t.DataParser.VALUE]:e[t.DataParser.COLOR];for(var a in o){this._parseColorTransform(o,this._helpColorTransform),r=this._intArray.length,this._intArray.length+=8,this._intArray[r++]=Math.round(100*this._helpColorTransform.alphaMultiplier),this._intArray[r++]=Math.round(100*this._helpColorTransform.redMultiplier),this._intArray[r++]=Math.round(100*this._helpColorTransform.greenMultiplier),this._intArray[r++]=Math.round(100*this._helpColorTransform.blueMultiplier),this._intArray[r++]=Math.round(this._helpColorTransform.alphaOffset),this._intArray[r++]=Math.round(this._helpColorTransform.redOffset),this._intArray[r++]=Math.round(this._helpColorTransform.greenOffset),this._intArray[r++]=Math.round(this._helpColorTransform.blueOffset),r-=8;break}}r<0&&(this._defaultColorOffset<0&&(this._defaultColorOffset=r=this._intArray.length,this._intArray.length+=8,this._intArray[r++]=100,this._intArray[r++]=100,this._intArray[r++]=100,this._intArray[r++]=100,this._intArray[r++]=0,this._intArray[r++]=0,this._intArray[r++]=0,this._intArray[r++]=0),r=this._defaultColorOffset);var c=this._frameIntArray.length;return this._frameIntArray.length+=1,this._frameIntArray[c]=r,s},n.prototype._parseSlotFFDFrame=function(e,i,s){var r=this._frameFloatArray.length,o=this._parseTweenFrame(e,i,s),a=t.DataParser.VERTICES in e?e[t.DataParser.VERTICES]:null,c=n._getNumber(e,t.DataParser.OFFSET,0),l=this._intArray[this._mesh.vertices.offset+0],h=this._mesh.parent.name+"_"+this._slot.name+"_"+this._mesh.name,_=this._mesh.vertices.weight,u=0,d=0,m=0,p=0;if(null!==_){var f=this._weightSlotPose[h];this._helpMatrixA.copyFromArray(f,0),this._frameFloatArray.length+=2*_.count,m=_.offset+2+_.bones.length}else this._frameFloatArray.length+=2*l;for(var g=0;g<2*l;g+=2)if(null===a?(u=0,d=0):(u=g<c||g-c>=a.length?0:a[g-c],d=g+1<c||g+1-c>=a.length?0:a[g+1-c]),null!==_){var v=this._weightBonePoses[h],y=this._intArray[m++];this._helpMatrixA.transformPoint(u,d,this._helpPoint,!0),u=this._helpPoint.x,d=this._helpPoint.y;for(var x=0;x<y;++x){var S=this._intArray[m++];this._helpMatrixB.copyFromArray(v,7*S+1),this._helpMatrixB.invert(),this._helpMatrixB.transformPoint(u,d,this._helpPoint,!0),this._frameFloatArray[r+p++]=this._helpPoint.x,this._frameFloatArray[r+p++]=this._helpPoint.y}}else this._frameFloatArray[r+g]=u,this._frameFloatArray[r+g+1]=d;if(0===i){var C=this._frameIntArray.length;this._frameIntArray.length+=5,this._frameIntArray[C+0]=this._mesh.vertices.offset,this._frameIntArray[C+1]=this._frameFloatArray.length-r,this._frameIntArray[C+2]=this._frameFloatArray.length-r,this._frameIntArray[C+3]=0,this._frameIntArray[C+4]=r-this._animation.frameFloatOffset,this._timelineArray[this._timeline.offset+3]=C-this._animation.frameIntOffset}return o},n.prototype._parseIKConstraintFrame=function(e,i,s){var r=this._parseTweenFrame(e,i,s),o=this._frameIntArray.length;return this._frameIntArray.length+=2,this._frameIntArray[o++]=n._getBoolean(e,t.DataParser.BEND_POSITIVE,!0)?1:0,this._frameIntArray[o++]=Math.round(100*n._getNumber(e,t.DataParser.WEIGHT,1)),r},n.prototype._parseAnimationFrame=function(e,i,s){var r=this._parseTweenFrame(e,i,s),o=this._frameIntArray.length;return this._frameIntArray.length+=2,this._frameIntArray[o++]=n._getNumber(e,t.DataParser.VALUE,0),this._frameIntArray[o++]=Math.round(100*n._getNumber(e,t.DataParser.WEIGHT,1)),r},n.prototype._parseActionData=function(e,i,s,r){var o=new Array;if("string"==typeof e)(h=t.BaseObject.borrowObject(t.ActionData)).type=i,h.name=e,h.bone=s,h.slot=r,o.push(h);else if(e instanceof Array)for(var a=0,c=e;a<c.length;a++){var l=c[a],h=t.BaseObject.borrowObject(t.ActionData);if(t.DataParser.GOTO_AND_PLAY in l?(h.type=0,h.name=n._getString(l,t.DataParser.GOTO_AND_PLAY,"")):(t.DataParser.TYPE in l&&"string"==typeof l[t.DataParser.TYPE]?h.type=t.DataParser._getActionType(l[t.DataParser.TYPE]):h.type=n._getNumber(l,t.DataParser.TYPE,i),h.name=n._getString(l,t.DataParser.NAME,"")),t.DataParser.BONE in l){var _=n._getString(l,t.DataParser.BONE,"");h.bone=this._armature.getBone(_)}else h.bone=s;if(t.DataParser.SLOT in l){var u=n._getString(l,t.DataParser.SLOT,"");h.slot=this._armature.getSlot(u)}else h.slot=r;var d=null;if(t.DataParser.INTS in l){null===d&&(d=t.BaseObject.borrowObject(t.UserData));for(var m=0,p=l[t.DataParser.INTS];m<p.length;m++){var f=p[m];d.addInt(f)}}if(t.DataParser.FLOATS in l){null===d&&(d=t.BaseObject.borrowObject(t.UserData));for(var g=0,v=l[t.DataParser.FLOATS];g<v.length;g++)f=v[g],d.addFloat(f)}if(t.DataParser.STRINGS in l){null===d&&(d=t.BaseObject.borrowObject(t.UserData));for(var y=0,x=l[t.DataParser.STRINGS];y<x.length;y++)f=x[y],d.addString(f)}h.data=d,o.push(h)}return o},n.prototype._parseTransform=function(e,i,s){i.x=n._getNumber(e,t.DataParser.X,0)*s,i.y=n._getNumber(e,t.DataParser.Y,0)*s,t.DataParser.ROTATE in e||t.DataParser.SKEW in e?(i.rotation=t.Transform.normalizeRadian(n._getNumber(e,t.DataParser.ROTATE,0)*t.Transform.DEG_RAD),i.skew=t.Transform.normalizeRadian(n._getNumber(e,t.DataParser.SKEW,0)*t.Transform.DEG_RAD)):(t.DataParser.SKEW_X in e||t.DataParser.SKEW_Y in e)&&(i.rotation=t.Transform.normalizeRadian(n._getNumber(e,t.DataParser.SKEW_Y,0)*t.Transform.DEG_RAD),i.skew=t.Transform.normalizeRadian(n._getNumber(e,t.DataParser.SKEW_X,0)*t.Transform.DEG_RAD)-i.rotation),i.scaleX=n._getNumber(e,t.DataParser.SCALE_X,1),i.scaleY=n._getNumber(e,t.DataParser.SCALE_Y,1)},n.prototype._parseColorTransform=function(e,i){i.alphaMultiplier=.01*n._getNumber(e,t.DataParser.ALPHA_MULTIPLIER,100),i.redMultiplier=.01*n._getNumber(e,t.DataParser.RED_MULTIPLIER,100),i.greenMultiplier=.01*n._getNumber(e,t.DataParser.GREEN_MULTIPLIER,100),i.blueMultiplier=.01*n._getNumber(e,t.DataParser.BLUE_MULTIPLIER,100),i.alphaOffset=n._getNumber(e,t.DataParser.ALPHA_OFFSET,0),i.redOffset=n._getNumber(e,t.DataParser.RED_OFFSET,0),i.greenOffset=n._getNumber(e,t.DataParser.GREEN_OFFSET,0),i.blueOffset=n._getNumber(e,t.DataParser.BLUE_OFFSET,0)},n.prototype._parseArray=function(){this._intArray.length=0,this._floatArray.length=0,this._frameIntArray.length=0,this._frameFloatArray.length=0,this._frameArray.length=0,this._timelineArray.length=0},n.prototype._modifyArray=function(){this._intArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._intArray.push(0),this._frameIntArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._frameIntArray.push(0),this._frameArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._frameArray.push(0),this._timelineArray.length%Uint16Array.BYTES_PER_ELEMENT!=0&&this._timelineArray.push(0);var e=this._intArray.length*Int16Array.BYTES_PER_ELEMENT,i=this._floatArray.length*Float32Array.BYTES_PER_ELEMENT,n=this._frameIntArray.length*Int16Array.BYTES_PER_ELEMENT,s=this._frameFloatArray.length*Float32Array.BYTES_PER_ELEMENT,r=this._frameArray.length*Int16Array.BYTES_PER_ELEMENT,o=this._timelineArray.length*Uint16Array.BYTES_PER_ELEMENT,a=e+i+n+s+r+o;if(t.DragonBones.webAssembly){for(var c=t.webAssemblyModule.HEAP16.buffer,l=t.webAssemblyModule._malloc(a),h=new Int16Array(c,l,this._intArray.length),_=new Float32Array(c,l+e,this._floatArray.length),u=new Int16Array(c,l+e+i,this._frameIntArray.length),d=new Float32Array(c,l+e+i+n,this._frameFloatArray.length),m=new Int16Array(c,l+e+i+n+s,this._frameArray.length),p=new Uint16Array(c,l+e+i+n+s+r,this._timelineArray.length),f=0,g=this._intArray.length;f<g;++f)h[f]=this._intArray[f];for(f=0,g=this._floatArray.length;f<g;++f)_[f]=this._floatArray[f];for(f=0,g=this._frameIntArray.length;f<g;++f)u[f]=this._frameIntArray[f];for(f=0,g=this._frameFloatArray.length;f<g;++f)d[f]=this._frameFloatArray[f];for(f=0,g=this._frameArray.length;f<g;++f)m[f]=this._frameArray[f];for(f=0,g=this._timelineArray.length;f<g;++f)p[f]=this._timelineArray[f];t.webAssemblyModule.setDataBinary(this._data,l,e,i,n,s,r,o)}else{var v=new ArrayBuffer(a);for(h=new Int16Array(v,0,this._intArray.length),_=new Float32Array(v,e,this._floatArray.length),u=new Int16Array(v,e+i,this._frameIntArray.length),d=new Float32Array(v,e+i+n,this._frameFloatArray.length),m=new Int16Array(v,e+i+n+s,this._frameArray.length),p=new Uint16Array(v,e+i+n+s+r,this._timelineArray.length),f=0,g=this._intArray.length;f<g;++f)h[f]=this._intArray[f];for(f=0,g=this._floatArray.length;f<g;++f)_[f]=this._floatArray[f];for(f=0,g=this._frameIntArray.length;f<g;++f)u[f]=this._frameIntArray[f];for(f=0,g=this._frameFloatArray.length;f<g;++f)d[f]=this._frameFloatArray[f];for(f=0,g=this._frameArray.length;f<g;++f)m[f]=this._frameArray[f];for(f=0,g=this._timelineArray.length;f<g;++f)p[f]=this._timelineArray[f];this._data.binary=v,this._data.intArray=h,this._data.floatArray=_,this._data.frameIntArray=u,this._data.frameFloatArray=d,this._data.frameArray=m,this._data.timelineArray=p}this._defaultColorOffset=-1},n.prototype.parseDragonBonesData=function(e,i){void 0===i&&(i=1),console.assert(null!=e,"Data error.");var s=n._getString(e,t.DataParser.VERSION,""),r=n._getString(e,t.DataParser.COMPATIBLE_VERSION,"");if(t.DataParser.DATA_VERSIONS.indexOf(s)>=0||t.DataParser.DATA_VERSIONS.indexOf(r)>=0){var o=t.BaseObject.borrowObject(t.DragonBonesData);if(o.version=s,o.name=n._getString(e,t.DataParser.NAME,""),o.frameRate=n._getNumber(e,t.DataParser.FRAME_RATE,24),0===o.frameRate&&(o.frameRate=24),t.DataParser.ARMATURE in e){this._data=o,this._parseArray(e);for(var a=0,c=e[t.DataParser.ARMATURE];a<c.length;a++){var l=c[a];o.addArmature(this._parseArmature(l,i))}this._data.binary||this._modifyArray(),t.DataParser.STAGE in e?o.stage=o.getArmature(n._getString(e,t.DataParser.STAGE,"")):o.armatureNames.length>0&&(o.stage=o.getArmature(o.armatureNames[0])),this._data=null}return t.DataParser.TEXTURE_ATLAS in e&&(this._rawTextureAtlases=e[t.DataParser.TEXTURE_ATLAS]),o}return console.assert(!1,"Nonsupport data version: "+s+"\nPlease convert DragonBones data to support version.\nRead more: https://github.com/DragonBones/Tools/"),null},n.prototype.parseTextureAtlasData=function(e,i,s){if(void 0===s&&(s=1),console.assert(void 0!==e),null===e){if(null===this._rawTextureAtlases||0===this._rawTextureAtlases.length)return!1;var r=this._rawTextureAtlases[this._rawTextureAtlasIndex++];return this.parseTextureAtlasData(r,i,s),this._rawTextureAtlasIndex>=this._rawTextureAtlases.length&&(this._rawTextureAtlasIndex=0,this._rawTextureAtlases=null),!0}if(i.width=n._getNumber(e,t.DataParser.WIDTH,0),i.height=n._getNumber(e,t.DataParser.HEIGHT,0),i.scale=1===s?1/n._getNumber(e,t.DataParser.SCALE,1):s,i.name=n._getString(e,t.DataParser.NAME,""),i.imagePath=n._getString(e,t.DataParser.IMAGE_PATH,""),t.DataParser.SUB_TEXTURE in e)for(var o=e[t.DataParser.SUB_TEXTURE],a=0,c=o.length;a<c;++a){var l=o[a],h=i.createTexture();h.rotated=n._getBoolean(l,t.DataParser.ROTATED,!1),h.name=n._getString(l,t.DataParser.NAME,""),h.region.x=n._getNumber(l,t.DataParser.X,0),h.region.y=n._getNumber(l,t.DataParser.Y,0),h.region.width=n._getNumber(l,t.DataParser.WIDTH,0),h.region.height=n._getNumber(l,t.DataParser.HEIGHT,0);var _=n._getNumber(l,t.DataParser.FRAME_WIDTH,-1),u=n._getNumber(l,t.DataParser.FRAME_HEIGHT,-1);_>0&&u>0&&(h.frame=t.TextureData.createRectangle(),h.frame.x=n._getNumber(l,t.DataParser.FRAME_X,0),h.frame.y=n._getNumber(l,t.DataParser.FRAME_Y,0),h.frame.width=_,h.frame.height=u),i.addTexture(h)}return!0},n.getInstance=function(){return null===n._objectDataParserInstance&&(n._objectDataParserInstance=new n),n._objectDataParserInstance},n._objectDataParserInstance=null,n}(t.DataParser);t.ObjectDataParser=e;var i=function(){this.frameStart=0,this.actions=[]};t.ActionFrame=i}(R$||(R$={})),function(t){var e=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return I$(i,e),i.prototype._inRange=function(t,e,i){return e<=t&&t<=i},i.prototype._decodeUTF8=function(t){for(var e,i=0,n="",s=0,r=0,o=0,a=0;t.length>i;){var c=t[i++];if(-1===c)e=0!==r?65533:-1;else if(0===r)this._inRange(c,0,127)?e=c:(this._inRange(c,194,223)?(r=1,a=128,s=c-192):this._inRange(c,224,239)?(r=2,a=2048,s=c-224):this._inRange(c,240,244)&&(r=3,a=65536,s=c-240),s*=Math.pow(64,r),e=null);else if(this._inRange(c,128,191))if(o+=1,s+=(c-128)*Math.pow(64,r-o),o!==r)e=null;else{var l=s,h=a;s=0,r=0,o=0,a=0,e=this._inRange(l,h,1114111)&&!this._inRange(l,55296,57343)?l:c}else s=0,r=0,o=0,a=0,i--,e=c;null!==e&&-1!==e&&(e<=65535?e>0&&(n+=String.fromCharCode(e)):(e-=65536,n+=String.fromCharCode(55296+(e>>10&1023)),n+=String.fromCharCode(56320+(1023&e))))}return n},i.prototype._getUTF16Key=function(t){for(var e=0,i=t.length;e<i;++e)if(t.charCodeAt(e)>255)return encodeURI(t);return t},i.prototype._parseBinaryTimeline=function(e,i,n){void 0===n&&(n=null);var s=null!==n?n:t.BaseObject.borrowObject(t.TimelineData);s.type=e,s.offset=i,this._timeline=s;var r=this._timelineArrayBuffer[s.offset+2];if(1===r)s.frameIndicesOffset=-1;else{var o=0,a=this._animation.frameCount+1,c=this._data.frameIndices;t.DragonBones.webAssembly?(o=c.size(),c.resize(o+a,0)):(o=c.length,c.length+=a),s.frameIndicesOffset=o;for(var l=0,h=0,_=0,u=0;l<a;++l)_+u<=l&&h<r&&(_=this._frameArrayBuffer[this._animation.frameOffset+this._timelineArrayBuffer[s.offset+5+h]],u=h===r-1?this._animation.frameCount-_:this._frameArrayBuffer[this._animation.frameOffset+this._timelineArrayBuffer[s.offset+5+h+1]]-_,h++),t.DragonBones.webAssembly?c.set(o+l,h-1):c[o+l]=h-1}return this._timeline=null,s},i.prototype._parseVertices=function(e,i){i.offset=e[t.DataParser.OFFSET];var n=this._intArrayBuffer[i.offset+3];if(n>=0){var s=t.BaseObject.borrowObject(t.WeightData),r=this._intArrayBuffer[i.offset+0],o=this._intArrayBuffer[n+0];s.offset=n;for(var a=0;a<o;++a){var c=this._intArrayBuffer[n+2+a];s.addBone(this._rawBones[c])}for(var l=n+2+o,h=0,_=(a=0,r);a<_;++a){var u=this._intArrayBuffer[l++];h+=u,l+=u}s.count=h,i.weight=s}},i.prototype._parseMesh=function(t,e){this._parseVertices(t,e.vertices)},i.prototype._parsePath=function(t,e){this._parseVertices(t,e.vertices)},i.prototype._parseAnimation=function(e){var i=t.BaseObject.borrowObject(t.AnimationData);i.frameCount=Math.max(t.ObjectDataParser._getNumber(e,t.DataParser.DURATION,1),1),i.playTimes=t.ObjectDataParser._getNumber(e,t.DataParser.PLAY_TIMES,1),i.duration=i.frameCount/this._armature.frameRate,i.fadeInTime=t.ObjectDataParser._getNumber(e,t.DataParser.FADE_IN_TIME,0),i.scale=t.ObjectDataParser._getNumber(e,t.DataParser.SCALE,1),i.name=t.ObjectDataParser._getString(e,t.DataParser.NAME,t.DataParser.DEFAULT_NAME),0===i.name.length&&(i.name=t.DataParser.DEFAULT_NAME);var n=e[t.DataParser.OFFSET];if(i.frameIntOffset=n[0],i.frameFloatOffset=n[1],i.frameOffset=n[2],this._animation=i,t.DataParser.ACTION in e&&(i.actionTimeline=this._parseBinaryTimeline(0,e[t.DataParser.ACTION])),t.DataParser.Z_ORDER in e&&(i.zOrderTimeline=this._parseBinaryTimeline(1,e[t.DataParser.Z_ORDER])),t.DataParser.BONE in e){var s=e[t.DataParser.BONE];for(var r in s){var o=s[r];t.DragonBones.webAssembly&&(r=this._getUTF16Key(r));var a=this._armature.getBone(r);if(null!==a)for(var c=0,l=o.length;c<l;c+=2){var h=o[c],_=o[c+1],u=this._parseBinaryTimeline(h,_);this._animation.addBoneTimeline(a,u)}}}if(t.DataParser.SURFACE in e)for(var r in s=e[t.DataParser.SURFACE]){o=s[r],t.DragonBones.webAssembly&&(r=this._getUTF16Key(r));var d=this._armature.getBone(r);if(null!==d)for(c=0,l=o.length;c<l;c+=2)h=o[c],_=o[c+1],u=this._parseBinaryTimeline(h,_),this._animation.addSurfaceTimeline(d,u)}if(t.DataParser.SLOT in e)for(var r in s=e[t.DataParser.SLOT]){o=s[r],t.DragonBones.webAssembly&&(r=this._getUTF16Key(r));var m=this._armature.getSlot(r);if(null!==m)for(c=0,l=o.length;c<l;c+=2)h=o[c],_=o[c+1],u=this._parseBinaryTimeline(h,_),this._animation.addSlotTimeline(m,u)}if(t.DataParser.CONSTRAINT in e)for(var r in s=e[t.DataParser.CONSTRAINT]){o=s[r],t.DragonBones.webAssembly&&(r=this._getUTF16Key(r));var p=this._armature.getConstraint(r);if(null!==p)for(c=0,l=o.length;c<l;c+=2)h=o[c],_=o[c+1],u=this._parseBinaryTimeline(h,_),this._animation.addConstraintTimeline(p,u)}if(t.DataParser.ANIMATION in e)for(var r in s=e[t.DataParser.ANIMATION])for(o=s[r],t.DragonBones.webAssembly&&(r=this._getUTF16Key(r)),c=0,l=o.length;c<l;c+=2)h=o[c],_=o[c+1],u=this._parseBinaryTimeline(h,_),this._animation.addAnimationTimeline(r,u);return this._animation=null,i},i.prototype._parseArray=function(e){var i=e[t.DataParser.OFFSET],n=i[1],s=i[3],r=i[5],o=i[7],a=i[9],c=i[11],l=new Int16Array(this._binary,this._binaryOffset+i[0],n/Int16Array.BYTES_PER_ELEMENT),h=new Float32Array(this._binary,this._binaryOffset+i[2],s/Float32Array.BYTES_PER_ELEMENT),_=new Int16Array(this._binary,this._binaryOffset+i[4],r/Int16Array.BYTES_PER_ELEMENT),u=new Float32Array(this._binary,this._binaryOffset+i[6],o/Float32Array.BYTES_PER_ELEMENT),d=new Int16Array(this._binary,this._binaryOffset+i[8],a/Int16Array.BYTES_PER_ELEMENT),m=new Uint16Array(this._binary,this._binaryOffset+i[10],c/Uint16Array.BYTES_PER_ELEMENT);if(t.DragonBones.webAssembly){for(var p=n+s+r+o+a+c,f=t.webAssemblyModule._malloc(p),g=new Uint8Array(this._binary,this._binaryOffset,p/Uint8Array.BYTES_PER_ELEMENT),v=new Uint8Array(t.webAssemblyModule.HEAP16.buffer,f,g.length),y=0,x=g.length;y<x;++y)v[y]=g[y];t.webAssemblyModule.setDataBinary(this._data,f,n,s,r,o,a,c),this._intArrayBuffer=l,this._floatArrayBuffer=h,this._frameIntArrayBuffer=_,this._frameFloatArrayBuffer=u,this._frameArrayBuffer=d,this._timelineArrayBuffer=m}else this._data.binary=this._binary,this._data.intArray=this._intArrayBuffer=l,this._data.floatArray=this._floatArrayBuffer=h,this._data.frameIntArray=this._frameIntArrayBuffer=_,this._data.frameFloatArray=this._frameFloatArrayBuffer=u,this._data.frameArray=this._frameArrayBuffer=d,this._data.timelineArray=this._timelineArrayBuffer=m},i.prototype.parseDragonBonesData=function(t,i){void 0===i&&(i=1),console.assert(null!=t&&t instanceof ArrayBuffer,"Data error.");var n=new Uint8Array(t,0,8);if(n[0]!=="D".charCodeAt(0)||n[1]!=="B".charCodeAt(0)||n[2]!=="D".charCodeAt(0)||n[3]!=="T".charCodeAt(0))return console.assert(!1,"Nonsupport data."),null;var s=new Uint32Array(t,8,1)[0],r=new Uint8Array(t,12,s),o=this._decodeUTF8(r),a=JSON.parse(o);return this._binaryOffset=12+s,this._binary=t,e.prototype.parseDragonBonesData.call(this,a,i)},i.getInstance=function(){return null===i._binaryDataParserInstance&&(i._binaryDataParserInstance=new i),i._binaryDataParserInstance},i._binaryDataParserInstance=null,i}(t.ObjectDataParser);t.BinaryDataParser=e}(R$||(R$={})),function(t){var e=function(){function e(i){void 0===i&&(i=null),this.autoSearch=!1,this._dragonBonesDataMap={},this._textureAtlasDataMap={},this._dragonBones=null,this._dataParser=null,null===e._objectParser&&(e._objectParser=new t.ObjectDataParser),null===e._binaryParser&&(e._binaryParser=new t.BinaryDataParser),this._dataParser=null!==i?i:e._objectParser}return e.prototype._isSupportMesh=function(){return!0},e.prototype._getTextureData=function(t,e){if(t in this._textureAtlasDataMap)for(var i=0,n=this._textureAtlasDataMap[t];i<n.length;i++)if(null!==(c=(a=n[i]).getTexture(e)))return c;if(this.autoSearch)for(var s in this._textureAtlasDataMap)for(var r=0,o=this._textureAtlasDataMap[s];r<o.length;r++){var a,c;if((a=o[r]).autoSearch&&null!==(c=a.getTexture(e)))return c}return null},e.prototype._fillBuildArmaturePackage=function(t,e,i,n,s){var r=null,o=null;if(e.length>0&&e in this._dragonBonesDataMap&&(o=(r=this._dragonBonesDataMap[e]).getArmature(i)),null===o&&(0===e.length||this.autoSearch))for(var a in this._dragonBonesDataMap)if(r=this._dragonBonesDataMap[a],(0===e.length||r.autoSearch)&&null!==(o=r.getArmature(i))){e=a;break}if(null!==o){if(t.dataName=e,t.textureAtlasName=s,t.data=r,t.armature=o,t.skin=null,n.length>0&&(t.skin=o.getSkin(n),null===t.skin&&this.autoSearch))for(var a in this._dragonBonesDataMap){var c=this._dragonBonesDataMap[a].getArmature(n);if(null!==c){t.skin=c.defaultSkin;break}}return null===t.skin&&(t.skin=o.defaultSkin),!0}return!1},e.prototype._buildBones=function(e,i){for(var n=0,s=e.armature.sortedBones;n<s.length;n++){var r=s[n];t.BaseObject.borrowObject(0===r.type?t.Bone:t.Surface).init(r,i)}},e.prototype._buildSlots=function(e,i){var n=e.skin,s=e.armature.defaultSkin;if(null!==n&&null!==s){var r={};for(var o in s.displays){var a=s.getDisplays(o);r[o]=a}if(n!==s)for(var o in n.displays)a=n.getDisplays(o),r[o]=a;for(var c=0,l=e.armature.sortedSlots;c<l.length;c++){var h=l[c],_=h.name in r?r[h.name]:null,u=this._buildSlot(e,h,i);if(u.rawDisplayDatas=_,null!==_){for(var d=new Array,m=0,p=t.DragonBones.webAssembly?_.size():_.length;m<p;++m){var f=t.DragonBones.webAssembly?_.get(m):_[m];null!==f?d.push(this._getSlotDisplay(e,f,null,u)):d.push(null)}u._setDisplayList(d)}u._setDisplayIndex(h.displayIndex,!0)}}},e.prototype._buildConstraints=function(e,i){var n=e.armature.constraints;for(var s in n){var r=n[s];switch(r.type){case 0:var o=t.BaseObject.borrowObject(t.IKConstraint);o.init(r,i),i._addConstraint(o);break;case 1:var a=t.BaseObject.borrowObject(t.PathConstraint);a.init(r,i),i._addConstraint(a);break;default:var c=t.BaseObject.borrowObject(t.IKConstraint);c.init(r,i),i._addConstraint(c)}}},e.prototype._buildChildArmature=function(t,e,i){return this.buildArmature(i.path,null!==t?t.dataName:"","",null!==t?t.textureAtlasName:"")},e.prototype._getSlotDisplay=function(e,i,n,s){var r=null!==e?e.dataName:i.parent.parent.parent.name,o=null;switch(i.type){case 0:var a=i;null!==e&&e.textureAtlasName.length>0&&(a.texture=this._getTextureData(e.textureAtlasName,i.path)),null===a.texture&&(a.texture=this._getTextureData(r,i.path)),o=null!==n&&2===n.type&&this._isSupportMesh()?s.meshDisplay:s.rawDisplay;break;case 2:var c=i;null!==e&&e.textureAtlasName.length>0&&(c.texture=this._getTextureData(e.textureAtlasName,c.path)),null===c.texture&&(c.texture=this._getTextureData(r,c.path)),o=this._isSupportMesh()?s.meshDisplay:s.rawDisplay;break;case 1:var l=i,h=this._buildChildArmature(e,s,i);if(null!==h){if(h.inheritAnimation=l.inheritAnimation,!h.inheritAnimation){var _=l.actions.length>0?l.actions:h.armatureData.defaultActions;if(_.length>0)for(var u=0,d=_;u<d.length;u++){var m=d[u],p=t.BaseObject.borrowObject(t.EventObject);t.EventObject.actionDataToInstance(m,p,s.armature),p.slot=s,s.armature._bufferAction(p,!1)}else h.animation.play()}l.armature=h.armatureData}o=h}return o},e.prototype.parseDragonBonesData=function(t,i,n){void 0===i&&(i=null),void 0===n&&(n=1);for(var s=t instanceof ArrayBuffer?e._binaryParser:this._dataParser,r=s.parseDragonBonesData(t,n);;){var o=this._buildTextureAtlasData(null,null);if(!s.parseTextureAtlasData(null,o,n)){o.returnToPool();break}this.addTextureAtlasData(o,i)}return null!==r&&this.addDragonBonesData(r,i),r},e.prototype.parseTextureAtlasData=function(t,e,i,n){void 0===i&&(i=null),void 0===n&&(n=1);var s=this._buildTextureAtlasData(null,null);return this._dataParser.parseTextureAtlasData(t,s,n),this._buildTextureAtlasData(s,e||null),this.addTextureAtlasData(s,i),s},e.prototype.updateTextureAtlasData=function(t,e){var i=this.getTextureAtlasData(t);if(null!==i)for(var n=0,s=i.length;n<s;++n)n<e.length&&this._buildTextureAtlasData(i[n],e[n])},e.prototype.getDragonBonesData=function(t){return t in this._dragonBonesDataMap?this._dragonBonesDataMap[t]:null},e.prototype.addDragonBonesData=function(t,e){if(void 0===e&&(e=null),(e=null!==e?e:t.name)in this._dragonBonesDataMap){if(this._dragonBonesDataMap[e]===t)return;console.warn("Can not add same name data: "+e)}else this._dragonBonesDataMap[e]=t},e.prototype.removeDragonBonesData=function(t,e){void 0===e&&(e=!0),t in this._dragonBonesDataMap&&(e&&this._dragonBones.bufferObject(this._dragonBonesDataMap[t]),delete this._dragonBonesDataMap[t])},e.prototype.getTextureAtlasData=function(t){return t in this._textureAtlasDataMap?this._textureAtlasDataMap[t]:null},e.prototype.addTextureAtlasData=function(t,e){void 0===e&&(e=null);var i=(e=null!==e?e:t.name)in this._textureAtlasDataMap?this._textureAtlasDataMap[e]:this._textureAtlasDataMap[e]=[];i.indexOf(t)<0&&i.push(t)},e.prototype.removeTextureAtlasData=function(t,e){if(void 0===e&&(e=!0),t in this._textureAtlasDataMap){var i=this._textureAtlasDataMap[t];if(e)for(var n=0,s=i;n<s.length;n++){var r=s[n];this._dragonBones.bufferObject(r)}delete this._textureAtlasDataMap[t]}},e.prototype.getArmatureData=function(t,e){void 0===e&&(e="");var n=new i;return this._fillBuildArmaturePackage(n,e,t,"","")?n.armature:null},e.prototype.clear=function(t){for(var e in void 0===t&&(t=!0),this._dragonBonesDataMap)t&&this._dragonBones.bufferObject(this._dragonBonesDataMap[e]),delete this._dragonBonesDataMap[e];for(var e in this._textureAtlasDataMap){if(t)for(var i=0,n=this._textureAtlasDataMap[e];i<n.length;i++){var s=n[i];this._dragonBones.bufferObject(s)}delete this._textureAtlasDataMap[e]}},e.prototype.buildArmature=function(t,e,n,s){void 0===e&&(e=""),void 0===n&&(n=""),void 0===s&&(s="");var r=new i;if(!this._fillBuildArmaturePackage(r,e||"",t,n||"",s||""))return console.warn("No armature data: "+t+", "+(null!==e?e:"")),null;var o=this._buildArmature(r);return this._buildBones(r,o),this._buildSlots(r,o),this._buildConstraints(r,o),o.invalidUpdate(null,!0),o.advanceTime(0),o},e.prototype.replaceDisplay=function(e,i,n){void 0===n&&(n=-1),n<0&&(n=e.displayIndex),n<0&&(n=0),e.replaceDisplayData(i,n);var s=e.displayList;if(s.length<=n){s.length=n+1;for(var r=0,o=s.length;r<o;++r)s[r]||(s[r]=null)}if(null!==i){var a=e.rawDisplayDatas,c=null;a&&(t.DragonBones.webAssembly?n<a.size()&&(c=a.get(n)):n<a.length&&(c=a[n])),s[n]=this._getSlotDisplay(null,i,c,e)}else s[n]=null;e.displayList=s},e.prototype.replaceSlotDisplay=function(t,e,i,n,s,r){void 0===r&&(r=-1);var o=this.getArmatureData(e,t||"");if(!o||!o.defaultSkin)return!1;var a=o.defaultSkin.getDisplay(i,n);return!!a&&(this.replaceDisplay(s,a,r),!0)},e.prototype.replaceSlotDisplayList=function(e,i,n,s){var r=this.getArmatureData(i,e||"");if(!r||!r.defaultSkin)return!1;var o=r.defaultSkin.getDisplays(n);if(!o)return!1;for(var a=0,c=0,l=t.DragonBones.webAssembly?o.size():o.length;c<l;++c){var h=t.DragonBones.webAssembly?o.get(c):o[c];this.replaceDisplay(s,h,a++)}return!0},e.prototype.replaceSkin=function(e,i,n,s){void 0===n&&(n=!1),void 0===s&&(s=null);for(var r=!1,o=i.parent.defaultSkin,a=0,c=e.getSlots();a<c.length;a++){var l=c[a];if(!(null!==s&&s.indexOf(l.name)>=0)){var h=i.getDisplays(l.name);if(h||(null!==o&&i!==o&&(h=o.getDisplays(l.name)),h)){var _=t.DragonBones.webAssembly?h.size():h.length,u=l.displayList;u.length=_;for(var d=0,m=_;d<m;++d){var p=t.DragonBones.webAssembly?h.get(d):h[d];u[d]=null!==p?this._getSlotDisplay(null,p,null,l):null}r=!0,l.rawDisplayDatas=h,l.displayList=u}else n&&(l.rawDisplayDatas=null,l.displayList=[])}}return r},e.prototype.replaceAnimation=function(e,i,n){void 0===n&&(n=!0);var s=i.defaultSkin;if(null===s)return!1;if(n)e.animation.animations=i.animations;else{var r=e.animation.animations,o={};for(var a in r)o[a]=r[a];for(var a in i.animations)o[a]=i.animations[a];e.animation.animations=o}for(var c=0,l=e.getSlots();c<l.length;c++)for(var h=l[c],_=0,u=0,d=h.displayList;u<d.length;u++){var m=d[u];if(m instanceof t.Armature){var p=s.getDisplays(h.name);if(null!==p&&_<(t.DragonBones.webAssembly?p.size():p.length)){var f=t.DragonBones.webAssembly?p.get(_):p[_];if(null!==f&&1===f.type){var g=this.getArmatureData(f.path,f.parent.parent.parent.name);g&&this.replaceAnimation(m,g,n)}}}_++}return!0},e.prototype.getAllDragonBonesData=function(){return this._dragonBonesDataMap},e.prototype.getAllTextureAtlasData=function(){return this._textureAtlasDataMap},Object.defineProperty(e.prototype,"clock",{get:function(){return this._dragonBones.clock},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dragonBones",{get:function(){return this._dragonBones},enumerable:!0,configurable:!0}),e.prototype.changeSkin=function(t,e,i){return void 0===i&&(i=null),this.replaceSkin(t,e,!1,i)},e.prototype.copyAnimationsToArmature=function(t,e,i,n,s){void 0===n&&(n=""),void 0===s&&(s=!0);var r=this.getArmatureData(e,n);return!!r&&this.replaceAnimation(t,r,s)},e._objectParser=null,e._binaryParser=null,e}();t.BaseFactory=e;var i=function(){this.dataName="",this.textureAtlasName="",this.skin=null};t.BuildArmaturePackage=i}(R$||(R$={})),function(t){t.BinaryOffset={WeigthBoneCount:0,WeigthFloatOffset:1,WeigthBoneIndices:2,MeshVertexCount:0,MeshTriangleCount:1,MeshFloatOffset:2,MeshWeightOffset:3,MeshVertexIndices:4,TimelineScale:0,TimelineOffset:1,TimelineKeyFrameCount:2,TimelineFrameValueCount:3,TimelineFrameValueOffset:4,TimelineFrameOffset:5,FramePosition:0,FrameTweenType:1,FrameTweenEasingOrCurveSampleCount:2,FrameCurveSamples:3,DeformMeshOffset:0,DeformCount:1,DeformValueCount:2,DeformValueOffset:3,DeformFloatOffset:4},t.ArmatureType={Armature:0,MovieClip:1,Stage:2},t.BoneType={Bone:0,Surface:1},t.DisplayType={Image:0,Armature:1,Mesh:2,BoundingBox:3},t.BoundingBoxType={Rectangle:0,Ellipse:1,Polygon:2},t.ActionType={Play:0,Stop:1,GotoAndPlay:2,GotoAndStop:3,FadeIn:4,FadeOut:5,Frame:10,Sound:11},t.BlendMode={Normal:0,Add:1,Alpha:2,Darken:3,Difference:4,Erase:5,HardLight:6,Invert:7,Layer:8,Lighten:9,Multiply:10,Overlay:11,Screen:12,Subtract:13},t.TweenType={None:0,Line:1,Curve:2,QuadIn:3,QuadOut:4,QuadInOut:5},t.TimelineType={Action:0,ZOrder:1,BoneAll:10,BoneTranslate:11,BoneRotate:12,BoneScale:13,Surface:50,SlotDisplay:20,SlotColor:21,SlotFFD:22,IKConstraint:30,AnimationTime:40,AnimationWeight:41}}(R$||(R$={}));const D$=R$.DragonBones,M$=R$.BaseObject,O$=R$.Matrix,B$=(R$.Transform,R$.ColorTransform,R$.Point,R$.Rectangle,R$.UserData,R$.ActionData,R$.DragonBonesData,R$.ArmatureData,R$.BoneData,R$.SurfaceData,R$.SlotData,R$.ConstraintData,R$.IKConstraintData,R$.PathConstraintData,R$.CanvasData,R$.SkinData,R$.VerticesData,R$.DisplayData),N$=(R$.ImageDisplayData,R$.ArmatureDisplayData,R$.MeshDisplayData,R$.BoundingBoxDisplayData,R$.PathDisplayData,R$.WeightData,R$.BoundingBoxData,R$.RectangleBoundingBoxData,R$.EllipseBoundingBoxData,R$.PolygonBoundingBoxData,R$.AnimationData,R$.TimelineData,R$.AnimationConfig,R$.TextureAtlasData),L$=R$.TextureData,F$=(R$.DeformVertices,R$.Armature),z$=(R$.TransformObject,R$.Bone,R$.Surface,R$.Slot),V$=(R$.Constraint,R$.IKConstraint,R$.PathConstraint,R$.WorldClock,R$.Animation),G$=(R$.AnimationState,R$.BonePose,R$.BlendState,R$.TimelineState,R$.TweenTimelineState,R$.BoneTimelineState,R$.SlotTimelineState,R$.ConstraintTimelineState,R$.ActionTimelineState,R$.ZOrderTimelineState,R$.BoneAllTimelineState,R$.BoneTranslateTimelineState,R$.BoneRotateTimelineState,R$.BoneScaleTimelineState,R$.SurfaceTimelineState,R$.SlotDislayTimelineState,R$.SlotColorTimelineState,R$.DeformTimelineState,R$.IKConstraintTimelineState,R$.AnimationTimelineState,R$.EventObject),U$=(R$.DataParser,R$.ObjectDataParser,R$.ActionFrame,R$.BinaryDataParser,R$.BaseFactory),k$=(R$.BuildArmaturePackage,R$.BinaryOffset),H$=(R$.ArmatureType,R$.BoneType);var j$,W$;R$.DisplayType,R$.BoundingBoxType,R$.ActionType,R$.BlendMode,R$.TweenType,R$.TimelineType;let q$=dc("dragonBones.CCTextureAtlasData")(j$=class extends N${constructor(...t){super(...t),this._renderTexture=null}get renderTexture(){return this._renderTexture}set renderTexture(t){if(this._renderTexture=t,t)for(const e in this.textures){const i=this.textures[e];if(!i.spriteFrame){let e=null;i.rotated?e=new ki(i.region.x,i.region.y,i.region.height,i.region.width):(e=new ki(i.region.x,i.region.y,i.region.width,i.region.height),i.spriteFrame=new jD,i.spriteFrame.texture=t,i.spriteFrame.rect=e)}}else for(const t in this.textures)this.textures[t].spriteFrame=null}static toString(){return"[class dragonBones.CCTextureAtlasData]"}createTexture(){return M$.borrowObject(X$)}_onClear(){super._onClear(),this.renderTexture=null}})||j$,X$=dc("dragonBones.CCTextureData")(W$=class extends L${constructor(...t){super(...t),this.spriteFrame=null}static toString(){return"[class dragonBones.CCTextureData]"}_onClear(){super._onClear(),this.spriteFrame=null}})||W$;var Y$;let K$=dc("dragonBones.CCSlot")(Y$=class extends z${static toString(){return"[class dragonBones.CCSlot]"}constructor(){super(),this._localVertices=void 0,this._indices=void 0,this._matrix=void 0,this._worldMatrix=void 0,this._worldMatrixDirty=void 0,this._color=void 0,this._localVertices=[],this._indices=[],this._matrix=new Ii,this._worldMatrix=new Ii,this._worldMatrixDirty=!0,this._visible=!1,this._color=new hi}getTexture(){return this._textureData?this._textureData.spriteFrame.texture:null}calculWorldMatrix(){const t=this._armature._parent;t?this._mulMat(this._worldMatrix,t._worldMatrix,this._matrix):Ii.copy(this._worldMatrix,this._matrix),this._worldMatrixDirty=!1}_onClear(){super._onClear(),this._localVertices.length=0,this._indices.length=0,Ii.identity(this._matrix),Ii.identity(this._worldMatrix),this._worldMatrixDirty=!0,this._color=new hi,this._visible=!1}_onUpdateDisplay(){}_initDisplay(t){}_addDisplay(){this._visible=!0}_replaceDisplay(t){}_removeDisplay(){this._visible=!1}_disposeDisplay(t){}_updateVisible(){this._visible=this.parent.visible}_updateGlueMesh(){}_updateZOrder(){}_updateBlendMode(){if(this._childArmature){const t=this._childArmature.getSlots();for(let e=0,i=t.length;e<i;e++){const i=t[e];i._blendMode=this._blendMode,i._updateBlendMode()}}}_updateColor(){const t=this._color;t.r=255*this._colorTransform.redMultiplier,t.g=255*this._colorTransform.greenMultiplier,t.b=255*this._colorTransform.blueMultiplier,t.a=255*this._colorTransform.alphaMultiplier}_updateFrame(){this._indices.length=0;const t=this._indices,e=this._localVertices;let i=0,n=0;const s=this._textureData;if(!this._display||this._displayIndex<0||!s||!s.spriteFrame)return;const r=s.spriteFrame.texture,o=r.width,a=r.height,c=s.region;if(0===o||0===a)return void console.error(`SpriteFrame ${s.spriteFrame.name} incorrect size ${o} x ${a}`);const l=null!==this._deformVertices&&this._display===this._meshDisplay?this._deformVertices.verticesData:null;if(l){const s=l.data,r=s.intArray,h=s.floatArray,_=r[l.offset+k$.MeshVertexCount],u=r[l.offset+k$.MeshTriangleCount];let d=r[l.offset+k$.MeshFloatOffset];d<0&&(d+=65536);const m=d+2*_,p=this._armature._armatureData.scale;for(let t=0,i=2*_;t<i;t+=2)e[n++]=h[d+t]*p,e[n++]=-h[d+t+1]*p,l.rotated?(e[n++]=(c.x+(1-h[m+t])*c.width)/o,e[n++]=(c.y+h[m+t+1]*c.height)/a):(e[n++]=(c.x+h[m+t]*c.width)/o,e[n++]=(c.y+h[m+t+1]*c.height)/a);for(let e=0;e<3*u;++e)t[i++]=r[l.offset+k$.MeshVertexIndices+e];e.length=n,t.length=i,l.weight&&this._identityTransform()}else{const i=c.x/o,s=(c.y+c.height)/a,r=(c.x+c.width)/o,l=c.y/a;e[n++]=0,e[n++]=0,e[n++]=i,e[n++]=s,e[n++]=c.width,e[n++]=0,e[n++]=r,e[n++]=s,e[n++]=0,e[n++]=c.height,e[n++]=i,e[n++]=l,e[n++]=c.width,e[n++]=c.height,e[n++]=r,e[n++]=l,t[0]=0,t[1]=1,t[2]=2,t[3]=1,t[4]=3,t[5]=2,e.length=n,t.length=6}this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0}_updateMesh(){const t=this._armature._armatureData.scale,e=this._deformVertices.vertices,i=this._deformVertices.bones,n=this._deformVertices.verticesData,s=n.weight,r=e.length>0&&n.inheritDeform,o=this._localVertices;if(s){const a=n.data,c=a.intArray,l=a.floatArray,h=c[n.offset+k$.MeshVertexCount];let _=c[s.offset+k$.WeigthFloatOffset];_<0&&(_+=65536);for(let n=0,a=s.offset+k$.WeigthBoneIndices+i.length,u=_,d=0,m=0;n<h;n++,m+=4){const n=c[a++];let s=0,h=0;for(let o=0;o<n;++o){const n=i[c[a++]];if(null!==n){const i=n.globalTransformMatrix,o=l[u++];let a=l[u++]*t,c=l[u++]*t;r&&(a+=e[d++],c+=e[d++]),s+=(i.a*a+i.c*c+i.tx)*o,h+=(i.b*a+i.d*c+i.ty)*o}}o[m]=s,o[m+1]=-h}}else if(r){const i=this._parent._boneData.type!==H$.Bone,s=n.data,r=s.intArray,a=s.floatArray,c=r[n.offset+k$.MeshVertexCount];let l=r[n.offset+k$.MeshFloatOffset];l<0&&(l+=65536);for(let n=0,s=c,r=0;n<s;n++,r+=4){const s=a[l+2*n]*t+e[2*n],c=a[l+2*n+1]*t+e[2*n+1];if(i){const t=this._parent._getGlobalTransformMatrix(s,c);o[r]=t.a*s+t.c*c+t.tx,o[r+1]=-t.b*s+t.d*c+t.ty}else o[r]=s,o[r+1]=-c}}s&&this._identityTransform()}_identityTransform(){const t=this._matrix;t.m00=1,t.m01=0,t.m04=-0,t.m05=-1,t.m12=0,t.m13=0,this._worldMatrixDirty=!0}_updateTransform(){const t=this._matrix;t.m00=this.globalTransformMatrix.a,t.m01=this.globalTransformMatrix.b,t.m04=-this.globalTransformMatrix.c,t.m05=-this.globalTransformMatrix.d,this._childArmature?(t.m12=this.globalTransformMatrix.tx,t.m13=this.globalTransformMatrix.ty):(t.m12=this.globalTransformMatrix.tx-(this.globalTransformMatrix.a*this._pivotX-this.globalTransformMatrix.c*this._pivotY),t.m13=this.globalTransformMatrix.ty-(this.globalTransformMatrix.b*this._pivotX-this.globalTransformMatrix.d*this._pivotY)),this._worldMatrixDirty=!0}updateWorldMatrix(){if(!this._armature)return;const t=this._armature._parent;if(t&&t.updateWorldMatrix(),this._worldMatrixDirty){this.calculWorldMatrix();const t=this.childArmature;if(!t)return;const e=t.getSlots();for(let t=0,i=e.length;t<i;t++){const i=e[t];i&&(i._worldMatrixDirty=!0)}}}_mulMat(t,e,i){const n=e.m00,s=e.m01,r=e.m04,o=e.m05,a=e.m12,c=e.m13,l=i.m00,h=i.m01,_=i.m04,u=i.m05,d=i.m12,m=i.m13;0!==s||0!==r?(t.m00=l*n+h*r,t.m01=l*s+h*o,t.m04=_*n+u*r,t.m05=_*s+u*o,t.m12=n*d+r*m+a,t.m13=s*d+o*m+c):(t.m00=l*n,t.m01=h*o,t.m04=_*n,t.m05=u*o,t.m12=n*d+a,t.m13=o*m+c)}})||Y$;var J$;let $$=dc("dragonBones.CCArmatureDisplay")(J$=class extends B${get node(){return this}constructor(){super(),this.shouldAdvanced=!1,this._ccNode=null,this._ccComponent=null,this._eventTarget=void 0,this._armature=null,this._eventTarget=new Hl}hasEvent(t){return console.warn("Method not implemented."),!1}addEvent(t,e,i){console.warn("Method not implemented.")}removeEvent(t,e,i){console.warn("Method not implemented.")}setEventTarget(t){this._eventTarget=t}getRootDisplay(){let t,e=this._armature._parent;if(!e)return this;for(;e;)t=e,e=e._armature._parent;return t._armature.display}convertToRootSpace(t){const e=this._armature._parent;if(!e)return t;e.updateWorldMatrix();const i=e._worldMatrix,n=new mi(0,0);return n.x=t.x*i.m00+t.y*i.m04+i.m12,n.y=t.x*i.m01+t.y*i.m05+i.m13,n}convertToWorldSpace(t){var e;const i=this.convertToRootSpace(t),n=this.getRootNode();return null==n||null===(e=n._uiProps.uiTransformComp)||void 0===e?void 0:e.convertToWorldSpaceAR(i)}getRootNode(){const t=this.getRootDisplay();return t&&t._ccNode}dbInit(t){this._armature=t}dbClear(){this._armature=null}dbUpdate(){this._ccComponent&&this._ccComponent.markForUpdateRenderData()}advanceTimeBySelf(t){this.shouldAdvanced=!!t}hasDBEventListener(t){return this._eventTarget.hasEventListener(t)}addDBEventListener(t,e,i){this._eventTarget.on(t,e,i)}removeDBEventListener(t,e,i){this._eventTarget.off(t,e,i)}dispatchDBEvent(t,e){this._eventTarget.emit(t,e)}})||J$;var Z$,Q$,tZ;let eZ=dc("CCFactory")((tZ=Q$=class t extends U${static getInstance(){return t._factory||(t._factory=new t),t._factory}constructor(){super(),this.id=void 0,this.uuid=void 0,this._slots=void 0;const t=new $$;this._dragonBones=new D$(t),mw.getScheduler()&&(uw.on(_w.EVENT_RESTART,this.onRestart,this),this.initUpdate()),this.id=this.uuid="CCFactory"}onRestart(){t._factory=null}initUpdate(t){aw.enableForTarget(this),mw.getScheduler().scheduleUpdate(this,ew.Priority.HIGH,!1)}update(t){this._dragonBones.advanceTime(t)}getDragonBonesDataByRawData(t){return(t instanceof ArrayBuffer?U$._binaryParser:this._dataParser).parseDragonBonesData(t,1)}buildArmatureDisplay(t,e,i,n){const s=this.buildArmature(t,e,i,n);return s?s._display:null}createArmatureNode(t,e,i){let n=(i=i||new iS).getComponent("dragonBones.ArmatureDisplay");return n||(n=i.addComponent("dragonBones.ArmatureDisplay")),i.name=e,n._armatureName=e,n._dragonAsset=t.dragonAsset,n._dragonAtlasAsset=t.dragonAtlasAsset,n._init(),n}_buildTextureAtlasData(t,e){return t?t.renderTexture=e:t=M$.borrowObject(q$),t}_sortSlots(){const t=this._slots,e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i],s=n._zOrder;let r=!1;for(let t=e.length-1;t>=0;t--)if(s>=e[t]._zOrder){e.splice(t+1,0,n),r=!0;break}r||e.unshift(n)}this._slots=e}_buildArmature(t){const e=M$.borrowObject(F$);e._skinData=t.skin,e._animation=M$.borrowObject(V$),e._animation._armature=e,e._animation.animations=t.armature.animations,e._isChildArmature=!1;const i=new $$;return e.init(t.armature,i,i,this._dragonBones),e}_buildSlot(t,e,i){const n=M$.borrowObject(K$),s=n;return n.init(e,i,s,s),n}getDragonBonesDataByUUID(t){for(const e in this._dragonBonesDataMap)if(-1!==e.indexOf(t))return this._dragonBonesDataMap[e];return null}removeDragonBonesDataByUUID(t,e){void 0===e&&(e=!0);for(const i in this._dragonBonesDataMap)-1!==i.indexOf(t)&&(e&&this._dragonBones.bufferObject(this._dragonBonesDataMap[i]),delete this._dragonBonesDataMap[i])}},Q$._factory=null,Z$=tZ))||Z$;const iZ=1/60,nZ=[],sZ=[];let rZ,oZ,aZ=0,cZ=0,lZ=0,hZ=null,_Z=null,uZ=0,dZ=0,mZ=0,pZ=0,fZ=0;class gZ{constructor(){this.maxVertexCount=0,this.maxIndexCount=0,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this.frames=[],this.totalTime=0,this.isCompleted=!1,this._frameIdx=-1,this._armatureInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null}init(t,e){this._inited=!0,this._armatureInfo=t,this._animationName=e}clear(){this._inited=!1;for(let t=0,e=this.frames.length;t<e;t++)this.frames[t].segments.length=0;this.invalidAllFrame()}begin(){if(!this._invalid)return;const t=this._armatureInfo,e=t.curAnimationCache;e&&e!==this&&(this._privateMode?e.invalidAllFrame():e.updateToFrame()),t.armature.animation.play(this._animationName,1),t.curAnimationCache=this,this._invalid=!1,this._frameIdx=-1,this.totalTime=0,this.isCompleted=!1}end(){this._needToUpdate()||(this._armatureInfo.curAnimationCache=null,this.frames.length=this._frameIdx+1,this.isCompleted=!0)}_needToUpdate(t){return!this._armatureInfo.armature.animation.isCompleted&&this.totalTime<30&&(void 0===t||this._frameIdx<t)}updateToFrame(t){if(!this._inited)return;if(this.begin(),!this._needToUpdate(t))return;const e=this._armatureInfo.armature;do{e.advanceTime(iZ),this._frameIdx++,this.updateFrame(e,this._frameIdx),this.totalTime+=iZ}while(this._needToUpdate(t));this.end()}isInited(){return this._inited}isInvalid(){return this._invalid}invalidAllFrame(){this.isCompleted=!1,this._invalid=!0}updateAllFrame(){this.invalidAllFrame(),this.updateToFrame()}enableCacheAttachedInfo(){this._enableCacheAttachedInfo||(this._enableCacheAttachedInfo=!0,this.invalidAllFrame())}updateFrame(t,e){lZ=0,aZ=0,cZ=0,hZ=null,_Z=null,uZ=0,dZ=0,mZ=0,pZ=0,fZ=0,this.frames[e]=this.frames[e]||{segments:[],colors:[],boneInfos:[],vertices:null,uintVert:null,indices:null};const i=this.frames[e],n=this._tempSegments=i.segments,s=this._tempColors=i.colors,r=this._tempBoneInfos=i.boneInfos;this._traverseArmature(t,1),pZ>0&&(s[pZ-1].vfOffset=lZ),s.length=pZ,r.length=aZ;const o=mZ-1;if(o>=0)if(dZ>0){const t=n[o];t.indexCount=dZ,t.vfCount=9*uZ,t.vertexCount=uZ,n.length=mZ}else n.length=mZ-1;if(0===n.length)return;let a=i.vertices;const c=lZ/5,l=9*c;let h;(!a||a.length<lZ)&&(a=i.vertices=new Float32Array(l));for(let t=0,e=0;t<l;)a[t]=nZ[e++],a[t+1]=nZ[e++],a[t+3]=nZ[e++],a[t+4]=nZ[e++],h=nZ[e++],a[t+5]=(255&h)/255,a[t+6]=(h>>8&255)/255,a[t+7]=(h>>16&255)/255,a[t+8]=(h>>24&255)/255,t+=9;let _=i.indices;(!_||_.length<cZ)&&(_=i.indices=new Uint16Array(cZ));for(let t=0;t<cZ;t++)_[t]=sZ[t];i.vertices=a,i.indices=_,this.maxVertexCount=c>this.maxVertexCount?c:this.maxVertexCount,this.maxIndexCount=_.length>this.maxIndexCount?_.length:this.maxIndexCount}_traverseArmature(t,e){const i=this._tempColors,n=this._tempSegments,s=this._tempBoneInfos,r=t._slots;let o,a,c,l,h,_,u,d,m;const p=t._bones;if(this._enableCacheAttachedInfo)for(let t=0,e=p.length;t<e;t++,aZ++){const e=p[t];let i=s[aZ];i||(i=s[aZ]={globalTransformMatrix:new O$});const n=e.globalTransformMatrix;i.globalTransformMatrix.copyFrom(n)}for(let t=0,s=r.length;t<s;t++)if(c=r[t],c._visible&&c._displayData)if(c.updateWorldMatrix(),h=c._color,c.childArmature)this._traverseArmature(c.childArmature,e*h.a/255);else if(u=c.getTexture(),u){hZ===u.nativeUrl&&_Z===c._blendMode||(hZ=u.nativeUrl,_Z=c._blendMode,d=mZ-1,d>=0&&(dZ>0?(m=n[d],m.indexCount=dZ,m.vertexCount=uZ,m.vfCount=9*uZ):mZ--),n[mZ]={tex:u,blendMode:c._blendMode,indexCount:0,vertexCount:0,vfCount:0},mZ++,dZ=0,uZ=0),_=(h.a*e<<24>>>0)+(h.b<<16)+(h.g<<8)+h.r,fZ!==_&&(fZ=_,pZ>0&&(i[pZ-1].vfOffset=lZ),i[pZ++]={r:h.r,g:h.g,b:h.b,a:h.a*e,vfOffset:0}),o=c._localVertices,a=c._indices,l=c._worldMatrix;for(let t=0,e=o.length;t<e;)rZ=o[t++],oZ=o[t++],nZ[lZ++]=rZ*l.m00+oZ*l.m04+l.m12,nZ[lZ++]=rZ*l.m01+oZ*l.m05+l.m13,nZ[lZ++]=o[t++],nZ[lZ++]=o[t++],nZ[lZ++]=_;for(let t=0,e=a.length;t<e;t++)sZ[cZ++]=uZ+a[t];dZ+=a.length,uZ+=o.length/4}}}class vZ{constructor(){this._privateMode=!1,this._animationPool={},this._armatureCache={}}enablePrivateMode(){this._privateMode=!0}dispose(){for(const t in this._armatureCache){const e=this._armatureCache[t];if(e){const t=e.armature;t&&t.dispose()}}this._armatureCache={},this._animationPool={}}_removeArmature(t){const e=this._armatureCache[t],i=e.animationsCache;for(const e in i){const n=i[e];n&&(this._animationPool[`${t}#${e}`]=n,n.clear())}const n=e.armature;n&&n.dispose(),delete this._armatureCache[t]}resetArmature(t){for(const e in this._armatureCache)-1!==e.indexOf(t)&&this._removeArmature(e)}getArmatureCache(t,e,i){const n=this._armatureCache[e];let s;if(n)s=n.armature;else{const n=eZ.getInstance().buildArmatureDisplay(t,e,"",i);if(!n||!n._armature)return null;if(s=n._armature,!vZ.canCache(s))return s.dispose(),null;this._armatureCache[e]={armature:s,animationsCache:{},curAnimationCache:null}}return s}getAnimationCache(t,e){const i=this._armatureCache[t];return i?i.animationsCache[e]:null}initAnimationCache(t,e){if(!e)return null;const i=this._armatureCache[t],n=i&&i.armature;if(!n)return null;if(!n.animation.hasAnimation(e))return null;const s=i.animationsCache;let r=s[e];if(!r){const n=`${t}#${e}`;r=this._animationPool[n],r?delete this._animationPool[n]:(r=new gZ,r._privateMode=this._privateMode),r.init(i,e),s[e]=r}return r}invalidAnimationCache(t){const e=this._armatureCache[t];if(!e||!e.armature)return;const i=e.animationsCache;for(const t in i)i[t].invalidAllFrame()}updateAnimationCache(t,e){if(e){const i=this.initAnimationCache(t,e);if(!i)return;i.updateAllFrame()}else{const e=this._armatureCache[t];if(!e||!e.armature)return;const i=e.animationsCache;for(const t in i)i[t].updateAllFrame()}}static canCache(t){const e=t._slots;for(let t=0,i=e.length;t<i;t++)if(e[t].childArmature)return!1;return!0}}var yZ,xZ,SZ;vZ.FrameTime=iZ,vZ.sharedCache=new vZ;let CZ=dc("dragonBones.DragonBonesAsset")((SZ=sc((xZ=class extends fh{constructor(...t){super(...t),nc(this,"_dragonBonesJson",SZ,this),this._factory=null,this._dragonBonesJsonData=void 0,this._armaturesEnum=null}get dragonBonesJson(){return this._dragonBonesJson}set dragonBonesJson(t){this._dragonBonesJson=t,this._dragonBonesJsonData=JSON.parse(t),this.reset()}constructctor(){this.reset()}createNode(t){const e=new iS(this.name);return e.addComponent("dragonBones.ArmatureDisplay").dragonAsset=this,t(null,e)}reset(){this._clear()}init(t,e){this._factory=t,!this._dragonBonesJsonData&&this.dragonBonesJson&&(this._dragonBonesJsonData=JSON.parse(this.dragonBonesJson));let i=null;if(i=this._dragonBonesJsonData?this._dragonBonesJsonData:this._nativeAsset,!this._uuid){const t=this._factory.getDragonBonesDataByRawData(i);t?this._uuid=t.name:console.warn("dragonbones name is empty")}const n=`${this._uuid}#${e}`;return this._factory.getDragonBonesData(n)||this._factory.parseDragonBonesData(i instanceof ArrayBuffer?i:i.buffer instanceof ArrayBuffer?i.buffer:i,n),n}getArmatureEnum(){if(this._armaturesEnum)return this._armaturesEnum;this.init();const t=this._factory.getDragonBonesDataByUUID(this._uuid);if(t){const e=t.armatureNames,i={};for(let t=0;t<e.length;t++)i[e[t]]=t;return this._armaturesEnum=jt(i)}return null}getAnimsEnum(t){this.init();const e=this._factory.getDragonBonesDataByUUID(this._uuid);if(e){const i=e.getArmature(t);if(!i)return null;const n={"<None>":0},s=i.animations;let r=0;for(const t in s)s.hasOwnProperty(t)&&(n[t]=r+1,r++);return jt(n)}return null}destroy(){return this._clear(),super.destroy()}_clear(){this._factory&&(vZ.sharedCache.resetArmature(this._uuid),this._factory.removeDragonBonesDataByUUID(this._uuid,!0))}}).prototype,"_dragonBonesJson",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yZ=xZ))||yZ;var AZ,bZ,TZ,EZ,PZ,wZ,IZ,RZ;l.internal.DragonBonesAsset=CZ;let DZ=(AZ=dc("dragonBones.DragonBonesAtlasAsset"),bZ=Kc(xf),AZ((PZ=sc((EZ=class extends fh{constructor(){super(),nc(this,"_atlasJson",PZ,this),nc(this,"_texture",wZ,this),nc(this,"_atlasJsonData",IZ,this),this._factory=null,nc(this,"_textureAtlasData",RZ,this),this._clear()}get atlasJson(){return this._atlasJson}set atlasJson(t){this._atlasJson=t,this._atlasJsonData=JSON.parse(this.atlasJson),this._clear()}get texture(){return this._texture}set texture(t){this._texture=t,this._clear()}createNode(t){const e=new iS(this.name);return e.addComponent("dragonBones.ArmatureDisplay").dragonAtlasAsset=this,t(null,e)}init(t){this._factory=t,this._atlasJsonData||(this._atlasJsonData=JSON.parse(this.atlasJson));const e=this._atlasJsonData;this._uuid=this._uuid||e.name,this._textureAtlasData?t.addTextureAtlasData(this._textureAtlasData,this._uuid):this._textureAtlasData=t.parseTextureAtlasData(e,this.texture,this._uuid)}destroy(){return this._clear(),super.destroy()}_clear(){}}).prototype,"_atlasJson",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wZ=sc(EZ.prototype,"_texture",[Sc,bZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IZ=sc(EZ.prototype,"_atlasJsonData",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),RZ=sc(EZ.prototype,"_textureAtlasData",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TZ=EZ))||TZ);var MZ;l.internal.DragonBonesAtlasAsset=DZ;const OZ=new Ii;let BZ=dc("dragonBones.AttachUtil")(MZ=class{constructor(){this._inited=!1,this._armature=null,this._armatureNode=null,this._armatureDisplay=null}init(t){this._inited=!0,this._armature=t._armature,this._armatureNode=t.node,this._armatureDisplay=t}reset(){this._inited=!1,this._armature=null,this._armatureNode=null,this._armatureDisplay=null}_syncAttachedNode(){if(!this._inited)return;this._armatureNode.worldMatrix;let t=null;const e=this._armatureDisplay.isAnimationCached();if(e&&this._armatureDisplay&&(t=this._armatureDisplay._curFrame&&this._armatureDisplay._curFrame.boneInfos,!t))return;const i=this._armatureDisplay.sockets,n=this._armatureDisplay.socketNodes,s=(t,e)=>{const i=OZ;i.m00=e.a,i.m01=e.b,i.m04=-e.c,i.m05=-e.d,i.m12=e.tx,i.m13=e.ty,t.matrix=OZ},r=this._armature.getBones();for(let o=i.length-1;o>=0;o--){const a=i[o],c=a.target;if(!c)continue;if(!c.isValid){n.delete(a.path),i.splice(o,1);continue}const l=e?t[a.boneIndex]:r[a.boneIndex];l&&s(c,l.globalTransformMatrix)}}})||MZ;class NZ extends ew{constructor(){super(),this._armatures=new Set}static getInstance(){return NZ._instance||(NZ._instance=new NZ,mw.registerSystem(NZ.ID,NZ._instance,ew.Priority.HIGH)),NZ._instance}add(t){t&&(this._armatures.has(t)||this._armatures.add(t))}remove(t){t&&this._armatures.has(t)&&this._armatures.delete(t)}postUpdate(t){this._armatures&&this._armatures.forEach((e=>{e.updateAnimation(t)}))}}var LZ,FZ,zZ,VZ,GZ,UZ,kZ,HZ,jZ,WZ,qZ,XZ,YZ,KZ,JZ,$Z,ZZ,QZ,tQ,eQ,iQ,nQ,sQ,rQ,oQ,aQ,cQ,lQ,hQ,_Q,uQ,dQ,mQ,pQ,fQ,gQ,vQ,yQ,xQ,SQ,CQ,AQ,bQ,TQ,EQ,PQ,wQ,IQ,RQ;let DQ;function MQ(t,e,i){Le.Attr.setClassAttr(t,e,"type","Enum"),Le.Attr.setClassAttr(t,e,"enumList",jt.getList(i))}NZ.ID="ARMATURE",NZ._instance=void 0,l.internal.ArmatureSystem=NZ,function(t){t[t.default=-1]="default"}(wQ||(wQ={})),Xt(wQ),function(t){t[t["<None>"]=0]="<None>"}(IQ||(IQ={})),Xt(IQ),function(t){t[t.REALTIME=0]="REALTIME"}(RQ||(RQ={})),Xt(IQ),function(t){t[t.REALTIME=0]="REALTIME",t[t.SHARED_CACHE=1]="SHARED_CACHE",t[t.PRIVATE_CACHE=2]="PRIVATE_CACHE"}(DQ||(DQ={})),Xt(DQ);let OQ=(LZ=dc("dragonBones.ArmatureDisplay.DragonBoneSocket"),FZ=Kc(iS),LZ((GZ=sc((VZ=class{constructor(t="",e=null){nc(this,"path",GZ,this),nc(this,"target",UZ,this),this.boneIndex=null,this.path=t,this.target=e}}).prototype,"path",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),UZ=sc(VZ.prototype,"target",[FZ,Mc,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zZ=VZ))||zZ);Bt(OQ,"dragonBones.ArmatureDisplay.DragonBoneSocket");let BQ=(kZ=dc("dragonBones.ArmatureDisplay"),HZ=Dc(),jZ=Pc(),WZ=Kc(CZ),qZ=Lc(),XZ=Kc(DZ),YZ=Lc(),KZ=Oc(),JZ=Oc(),$Z=Nc(),ZZ=Kc(wQ),QZ=Lc(),tQ=Kc(IQ),eQ=Nc(),iQ=Lc(),nQ=Nc(),sQ=Lc(),rQ=Lc(),oQ=Lc(),aQ=Lc(),cQ=Lc(),lQ=Kc([OQ]),hQ=Lc(),kZ(_Q=HZ(_Q=jZ(_Q=Ec((PQ=EQ=class t extends HO{get dragonAsset(){return this._dragonAsset}set dragonAsset(t){this._dragonAsset=t,this.destroyRenderData(),this._refresh()}get dragonAtlasAsset(){return this._dragonAtlasAsset}set dragonAtlasAsset(t){this._dragonAtlasAsset=t,this._parseDragonAtlasAsset(),this._refresh()}get armatureName(){return this._armatureName}set armatureName(t){this._armatureName=t;const e=this.getAnimationNames(this._armatureName);(!this.animationName||e.indexOf(this.animationName)<0)&&(this.animationName=""),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.remove(this._armature),this._refresh(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature)}get animationName(){return this._animationName}set animationName(t){this._animationName=t}get _defaultArmatureIndex(){return this._defaultArmatureIndexValue}set _defaultArmatureIndex(t){this._defaultArmatureIndexValue=t;let e="";if(this.dragonAsset){let t;if(this.dragonAsset&&(t=this.dragonAsset.getArmatureEnum()),!t)return void D(7400,this.name);e=t[this._defaultArmatureIndex]}void 0!==e?this.armatureName=e:D(7401,this.name),this.markForUpdateRenderData()}get _animationIndex(){return this._animationIndexValue}set _animationIndex(t){if(this._animationIndexValue=t,0===this._animationIndex)return void(this.animationName="");let e;if(this.dragonAsset&&(e=this.dragonAsset.getAnimsEnum(this.armatureName)),!e)return;const i=e[this._animationIndex];void 0!==i?this.playAnimation(i,this.playTimes):D(7402,this.name)}get _defaultCacheMode(){return this._defaultCacheModeValue}set _defaultCacheMode(t){if(this._defaultCacheModeValue=t,this._defaultCacheMode!==DQ.REALTIME&&this._armature&&!vZ.canCache(this._armature))return this._defaultCacheMode=DQ.REALTIME,void console.warn("Animation cache mode doesn't support skeletal nesting");this.setAnimationCacheMode(this._defaultCacheMode)}get timeScale(){return this._timeScale}set timeScale(t){this._timeScale=t,this._armature&&!this.isAnimationCached()&&(this._armature.animation.timeScale=this.timeScale)}get debugBones(){return this._debugBones}set debugBones(t){this._debugBones=t,this._updateDebugDraw()}get sockets(){return this._sockets}set sockets(t){this._verifySockets(t),this._sockets=t,this._updateSocketBindings(),t.length>0&&this._frameCache&&this._frameCache.enableCacheAttachedInfo()}get socketNodes(){return this._socketNodes}get drawList(){return this._drawList}constructor(){super(),nc(this,"playTimes",dQ,this),nc(this,"premultipliedAlpha",mQ,this),this._armature=null,this.attachUtil=void 0,nc(this,"_defaultArmatureIndexValue",pQ,this),nc(this,"_dragonAsset",fQ,this),nc(this,"_dragonAtlasAsset",gQ,this),nc(this,"_armatureName",vQ,this),nc(this,"_animationName",yQ,this),nc(this,"_animationIndexValue",xQ,this),this._preCacheMode=-1,this._cacheMode=DQ.REALTIME,nc(this,"_defaultCacheModeValue",SQ,this),nc(this,"_timeScale",CQ,this),nc(this,"_playTimes",AQ,this),nc(this,"_debugBones",bQ,this),this._debugDraw=null,this._armatureKey="",this._accTime=0,this._playCount=0,this._frameCache=null,this._curFrame=null,this._playing=!1,this._armatureCache=null,this._eventTarget=void 0,this._factory=null,this._displayProxy=null,this._drawIdx=0,this._drawList=new Ol((()=>({material:null,texture:null,indexOffset:0,indexCount:0})),1),this.maxVertexCount=0,this.maxIndexCount=0,this._materialCache={},this._enumArmatures=jt({}),this._enumAnimations=jt({}),this._socketNodes=new Map,this._cachedSockets=new Map,nc(this,"_sockets",TQ,this),this._inited=void 0,this._cacheModeEnum=void 0,this._eventTarget=new Hl,this._inited=!1,this.attachUtil=new BZ,this.initFactory(),MQ(this,"_animationIndex",this._enumAnimations),MQ(this,"_defaultArmatureIndex",this._enumArmatures),this._useVertexOpacity=!0}initFactory(){this._factory=eZ.getInstance()}onLoad(){const t=this.node.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];0===(i.name&&i.name.search("CHILD_ARMATURE-"))&&i.destroy()}}_requestDrawData(t,e,i,n){const s=this._drawList.add();return s.material=t,s.texture=e,s.indexOffset=i,s.indexCount=n,s}destroyRenderData(){this._drawList.reset(),super.destroyRenderData()}getMaterialForBlend(t,e){const i=`${t}/${e}`;let n=this._materialCache[i];if(n)return n;const s=this.getMaterial(0);return n=new dv({parent:s,subModelIdx:0,owner:this}),n.recompileShaders({USE_LOCAL:!0},0),this._materialCache[i]=n,n.overridePipelineStates({blendState:{targets:[{blendSrc:t,blendDst:e}]}}),n}_render(t){if(this._renderData&&this._drawList){const e=this._renderData,i=e.chunk,n=i.vertexAccessor,s=e.getMeshBuffer(),r=s.indexOffset;n.appendIndices(i.bufferId,e.indices);for(let e=0;e<this._drawList.length;e++){this._drawIdx=e;const i=this._drawList.data[e];if(i.texture){const e=s.requireFreeIA(t.device);e.firstIndex=r+i.indexOffset,e.indexCount=i.indexCount,t.commitIA(this,e,i.texture,i.material,this.node)}}}}__preload(){super.__preload(),this._init()}_init(){if(this._cacheMode=this._defaultCacheMode,this._inited)return;this._inited=!0,this._parseDragonAtlasAsset(),this._refresh();const t=this.node.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];i&&"DEBUG_DRAW_NODE"===i.name&&i.destroy()}this._updateDebugDraw(),this._indexBoneSockets(),this._updateSocketBindings()}getArmatureKey(){return this._armatureKey}setAnimationCacheMode(t){this._preCacheMode!==t&&(this._cacheMode=t,this._buildArmature(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature),this._updateSocketBindings(),this.markForUpdateRenderData())}isAnimationCached(){return this._cacheMode!==DQ.REALTIME}onEnable(){super.onEnable(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature),this._flushAssembler(),NZ.getInstance().add(this)}onDisable(){super.onDisable(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.remove(this._armature),NZ.getInstance().remove(this)}_emitCacheCompleteEvent(){this._eventTarget.emit(G$.LOOP_COMPLETE),this._eventTarget.emit(G$.COMPLETE)}updateAnimation(t){if(!this.isAnimationCached())return;if(!this._frameCache)return;this.markForUpdateRenderData();const e=this._frameCache;if(!e.isInited())return;const i=e.frames;if(!this._playing)return void(e.isInvalid()&&(e.updateToFrame(),this._curFrame=i[i.length-1],this._renderData&&(this._renderData.vertexCount<e.maxVertexCount||this._renderData.indexCount<e.maxIndexCount)&&(this.maxVertexCount=e.maxVertexCount>this.maxVertexCount?e.maxVertexCount:this.maxVertexCount,this.maxIndexCount=e.maxIndexCount>this.maxIndexCount?e.maxIndexCount:this.maxIndexCount,this._renderData.resize(this.maxVertexCount,this.maxIndexCount),(!this._renderData.indices||this.maxIndexCount>this._renderData.indices.length)&&(this._renderData.indices=new Uint16Array(this.maxIndexCount)))));const n=vZ.FrameTime;0===this._accTime&&0===this._playCount&&this._eventTarget.emit(G$.START),this._accTime+=t*this.timeScale*1;let s=Math.floor(this._accTime/n);if(e.isCompleted||(e.updateToFrame(s),this._renderData&&(this._renderData.vertexCount<e.maxVertexCount||this._renderData.indexCount<e.maxIndexCount)&&(this.maxVertexCount=e.maxVertexCount>this.maxVertexCount?e.maxVertexCount:this.maxVertexCount,this.maxIndexCount=e.maxIndexCount>this.maxIndexCount?e.maxIndexCount:this.maxIndexCount,this._renderData.resize(this.maxVertexCount,this.maxIndexCount),(!this._renderData.indices||this.maxIndexCount>this._renderData.indices.length)&&(this._renderData.indices=new Uint16Array(this.maxIndexCount)))),e.isCompleted&&s>=i.length){if(this._playCount++,this.playTimes>0&&this._playCount>=this.playTimes)return this._curFrame=i[i.length-1],this._accTime=0,this._playing=!1,this._playCount=0,this._emitCacheCompleteEvent(),void this.attachUtil._syncAttachedNode();this._accTime=0,s=0,this._emitCacheCompleteEvent()}this._curFrame=i[s],this.attachUtil._syncAttachedNode()}onDestroy(){this._materialInstances=this._materialInstances.filter((t=>!!t)),this._inited=!1,this._cacheMode===DQ.PRIVATE_CACHE?(this._armatureCache.dispose(),this._armatureCache=null,this._armature=null):this._cacheMode===DQ.SHARED_CACHE?(this._armatureCache=null,this._armature=null):this._armature&&(this._armature.dispose(),this._armature=null),this._drawList.destroy(),super.onDestroy()}_updateDebugDraw(){if(this.debugBones){if(!this._debugDraw){const t=new iS("DEBUG_DRAW_NODE");t.hideFlags|=il.Flags.DontSave|il.Flags.HideInHierarchy;const e=t.addComponent(KN);e.lineWidth=1,e.strokeColor=new hi(255,0,0,255),this._debugDraw=e}this._debugDraw.node.parent=this.node}else this._debugDraw&&(this._debugDraw.node.parent=null);this.markForUpdateRenderData()}_buildArmature(){if(!this.dragonAsset||!this.dragonAtlasAsset||!this.armatureName)return;this._armature&&(this._preCacheMode===DQ.PRIVATE_CACHE?this._armatureCache.dispose():this._preCacheMode===DQ.REALTIME&&this._armature.dispose(),this._armatureCache=null,this._armature=null,this._displayProxy=null,this._frameCache=null,this._curFrame=null,this._playing=!1,this._preCacheMode=-1),this._cacheMode===DQ.SHARED_CACHE?this._armatureCache=vZ.sharedCache:this._cacheMode===DQ.PRIVATE_CACHE&&(this._armatureCache=new vZ,this._armatureCache.enablePrivateMode());const t=this.dragonAtlasAsset._uuid;if(this._armatureKey=this.dragonAsset.init(this._factory,t),this.isAnimationCached()&&(this._armature=this._armatureCache.getArmatureCache(this.armatureName,this._armatureKey,t),this._armature||(this._cacheMode=DQ.REALTIME)),this._preCacheMode=this._cacheMode,this._cacheMode===DQ.REALTIME){if(this._displayProxy=this._factory.buildArmatureDisplay(this.armatureName,this._armatureKey,"",t),!this._displayProxy)return;this._displayProxy._ccNode=this.node,this._displayProxy._ccComponent=this,this._displayProxy.setEventTarget(this._eventTarget),this._armature=this._displayProxy._armature,this._armature.animation.timeScale=this.timeScale}if(this._cacheMode!==DQ.REALTIME&&this.debugBones&&console.warn("Debug bones is invalid in cached mode"),this._armature){const t=this._armature.armatureData.aabb;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this.attachUtil.init(this),this.animationName&&this.playAnimation(this.animationName,this.playTimes),this._flushAssembler()}querySockets(){return this._armature?(0===this._cachedSockets.size&&this._indexBoneSockets(),Array.from(this._cachedSockets.keys()).sort()):[]}setBlendHash(){-1!==this._blendHash&&(this._blendHash=-1)}querySocketPathByName(t){const e=[];for(const i of this._cachedSockets.keys())i.endsWith(t)&&e.push(i);return e}_parseDragonAtlasAsset(){this.dragonAtlasAsset&&this.dragonAtlasAsset.init(this._factory)}_refresh(){this._buildArmature(),this._indexBoneSockets(),this.markForUpdateRenderData()}_updateCacheModeEnum(){this._cacheModeEnum=jt({}),this._armature?Object.assign(this._cacheModeEnum,DQ):Object.assign(this._cacheModeEnum,RQ),MQ(this,"_defaultCacheMode",this._cacheModeEnum)}_updateAnimEnum(){let t;t=this.dragonAsset?this.dragonAsset.getAnimsEnum(this.armatureName):IQ,this._enumAnimations=jt({}),Object.assign(this._enumAnimations,t||IQ),jt.update(this._enumAnimations),MQ(this,"_animationIndex",this._enumAnimations)}_updateArmatureEnum(){let t;t=this.dragonAsset?this.dragonAsset.getArmatureEnum():wQ,this._enumArmatures=jt({}),Object.assign(this._enumArmatures,t||wQ),jt.update(this._enumArmatures),MQ(this,"_defaultArmatureIndex",this._enumArmatures)}_indexBoneSockets(){if(!this._armature)return;this._cachedSockets.clear();const t=this._cachedSockets,e=(t,i,n)=>{if(n.has(t))return n.get(t);const s=i[t];if(!s.parent)return n.set(t,s.name),s.path=s.name,s.name;const r=`${e(s.parent._boneIndex,i,n)}/${s.name}`;return n.set(t,r),s.path=r,r},i=(n,s)=>{const r=s.getBones(),o=new Map;for(let t=0;t<r.length;t++)r[t]._boneIndex=t;for(let t=0;t<r.length;t++)e(t,r,o);for(const e of o.keys())t.set(`${n}${o.get(e)}`,e);const a=s.getSlots();for(let t=0;t<a.length;t++)a[t].childArmature&&i(a[t].name,a[t].childArmature)};i("",this._armature)}playAnimation(t,e){if(this.playTimes=void 0===e?-1:e,this.animationName=t,this.isAnimationCached()){let e=this._armatureCache.getAnimationCache(this._armatureKey,t);e||(e=this._armatureCache.initAnimationCache(this._armatureKey,t)),e&&(this._accTime=0,this._playCount=0,this._frameCache=e,this._sockets.length>0&&this._frameCache.enableCacheAttachedInfo(),this._frameCache.updateToFrame(0),this._playing=!0,this._curFrame=this._frameCache.frames[0])}else if(this._armature)return this._armature.animation.play(t,this.playTimes);return this.markForUpdateRenderData(),null}updateAnimationCache(t){this.isAnimationCached()&&this._armatureCache.updateAnimationCache(this._armatureKey,t)}invalidAnimationCache(){this.isAnimationCached()&&this._armatureCache.invalidAnimationCache(this._armatureKey)}getArmatureNames(){const t=this._factory.getDragonBonesData(this._armatureKey);return t&&t.armatureNames||[]}getAnimationNames(t){const e=[],i=this._factory.getDragonBonesData(this._armatureKey);if(i){const n=i.getArmature(t);if(n)for(const t in n.animations)n.animations.hasOwnProperty(t)&&e.push(t)}return e}on(t,e,i){this.addEventListener(t,e,i)}off(t,e,i){this.removeEventListener(t,e,i)}once(t,e,i){this._eventTarget.once(t,e,i)}addEventListener(t,e,i){this._eventTarget.on(t,e,i)}removeEventListener(t,e,i){this._eventTarget.off(t,e,i)}buildArmature(t,e){return this._factory.createArmatureNode(this,t,e)}armature(){return this._armature}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._armature&&this._assembler&&(this._renderData=this._assembler.createData(this),this._renderData&&(this.maxVertexCount=this._renderData.vertexCount,this.maxIndexCount=this._renderData.indexCount),this.markForUpdateRenderData(),this._updateColor())}_updateSocketBindings(){if(this._armature){this._socketNodes.clear();for(let t=0,e=this._sockets.length;t<e;t++){const e=this._sockets[t];if(e.path&&e.target){const t=this._cachedSockets.get(e.path);if(!t){console.error(`Skeleton data does not contain path ${e.path}`);continue}e.boneIndex=t,this._socketNodes.set(e.path,e.target)}}}}_verifySockets(t){for(let e=0,i=t.length;e<i;e++){const i=t[e].target;!i||i.parent&&i.parent===this.node||console.error(`Target node ${i.name} is expected to be a direct child of ${this.node.name}`)}}},EQ.AnimationCacheMode=DQ,sc((uQ=PQ).prototype,"dragonAsset",[Mc,WZ,qZ],Object.getOwnPropertyDescriptor(uQ.prototype,"dragonAsset"),uQ.prototype),sc(uQ.prototype,"dragonAtlasAsset",[Mc,XZ,YZ],Object.getOwnPropertyDescriptor(uQ.prototype,"dragonAtlasAsset"),uQ.prototype),sc(uQ.prototype,"armatureName",[KZ],Object.getOwnPropertyDescriptor(uQ.prototype,"armatureName"),uQ.prototype),sc(uQ.prototype,"animationName",[JZ],Object.getOwnPropertyDescriptor(uQ.prototype,"animationName"),uQ.prototype),sc(uQ.prototype,"_defaultArmatureIndex",[$Z,Mc,ZZ,QZ],Object.getOwnPropertyDescriptor(uQ.prototype,"_defaultArmatureIndex"),uQ.prototype),sc(uQ.prototype,"_animationIndex",[Mc,tQ,eQ,iQ],Object.getOwnPropertyDescriptor(uQ.prototype,"_animationIndex"),uQ.prototype),sc(uQ.prototype,"_defaultCacheMode",[Mc,nQ,sQ],Object.getOwnPropertyDescriptor(uQ.prototype,"_defaultCacheMode"),uQ.prototype),sc(uQ.prototype,"timeScale",[Mc,rQ,Sc],Object.getOwnPropertyDescriptor(uQ.prototype,"timeScale"),uQ.prototype),dQ=sc(uQ.prototype,"playTimes",[oQ,Mc,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),mQ=sc(uQ.prototype,"premultipliedAlpha",[Sc,Mc,aQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sc(uQ.prototype,"debugBones",[cQ,Mc],Object.getOwnPropertyDescriptor(uQ.prototype,"debugBones"),uQ.prototype),sc(uQ.prototype,"sockets",[lQ,hQ],Object.getOwnPropertyDescriptor(uQ.prototype,"sockets"),uQ.prototype),pQ=sc(uQ.prototype,"_defaultArmatureIndexValue",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wQ.default}}),fQ=sc(uQ.prototype,"_dragonAsset",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gQ=sc(uQ.prototype,"_dragonAtlasAsset",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vQ=sc(uQ.prototype,"_armatureName",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yQ=sc(uQ.prototype,"_animationName",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xQ=sc(uQ.prototype,"_animationIndexValue",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SQ=sc(uQ.prototype,"_defaultCacheModeValue",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DQ.REALTIME}}),CQ=sc(uQ.prototype,"_timeScale",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),AQ=sc(uQ.prototype,"_playTimes",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),bQ=sc(uQ.prototype,"_debugBones",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TQ=sc(uQ.prototype,"_sockets",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_Q=uQ))||_Q)||_Q)||_Q)||_Q);l.internal.ArmatureDisplay=BQ;const NQ=new hi(255,0,0,255),LQ=new hi(0,0,255,255),FQ=new hi(0,255,0,255);let zQ,VQ,GQ,UQ,kQ,HQ,jQ,WQ,qQ,XQ,YQ,KQ,JQ,$Q=0,ZQ=0,QQ=0,t0=0,e0=0,i0=0,n0=0,s0=0,r0=0;const o0=new Float32Array(4);let a0,c0,l0,h0,_0,u0,d0;const m0=new Ii;let p0=null,f0=null;function g0(t,e){if(!t)return null;let i,n;switch(e){case 1:i=kQ?fn.ONE:fn.SRC_ALPHA,n=fn.ONE;break;case 10:i=fn.DST_COLOR,n=fn.ONE_MINUS_SRC_ALPHA;break;case 12:i=fn.ONE,n=fn.ONE_MINUS_SRC_COLOR;break;case 0:default:i=kQ?fn.ONE:fn.SRC_ALPHA,n=fn.ONE_MINUS_SRC_ALPHA}return YQ.setBlendHash(),YQ.getMaterialForBlend(i,n)}function v0(t,e){const i=t.a*e*UQ,n=kQ?i/255:1,s=t.r*zQ*n/255,r=t.g*VQ*n/255,o=t.b*GQ*n/255;o0[0]=s,o0[1]=r,o0[2]=o,o0[3]=kQ?1:i/255}let y0=null;const x0={accessor:y0,vCount:32767,ensureAccessor(){if(!y0){const t=mw.root.device,e=mw.root.batcher2D,i=UM;this.accessor=y0=new Ck(t,i,this.vCount),e.registerBufferAccessor(Number.parseInt("DRAGONBONES",36),y0)}return this.accessor},createData(t){let e=t.renderData;if(!e){this.ensureAccessor();const i=t._armature._slots;let n=0,s=0;for(let t=0;t<i.length;++t){const e=i[t];n+=e._localVertices.length/4,s+=e._indices.length}e=KM.add(UM,this.accessor),e.resize(n,s),e.indices&&s===e.indices.length||(e.indices=new Uint16Array(s))}return e},updateRenderData(t,e){YQ=t,t._armature&&function(t){const e=t._armature;if(!e)return;HQ=!0,kQ=t.premultipliedAlpha,t.drawList.reset(),YQ=t,XQ=t.node,jQ=t.renderData,YQ=t,a0=0,p0=null;const i=t.color;let n;if(zQ=i.r/255,VQ=i.g/255,GQ=i.b/255,UQ=t.node._uiProps.opacity,4294967295!==i._val&&(a0|=1),$Q=0,QQ=0,t0=0,e0=0,i0=0,r0=0,n0=YQ.maxVertexCount,s0=YQ.maxIndexCount,t.isAnimationCached())!function(t){if(!t)return;const e=t.segments;if(0===e.length)return;let i=null;const n=t.vertices,s=t.indices;let r=0,o=0,a=0,c=0,l=0;const h=t.colors;let _=h[l++],u=_.vfOffset;v0(_,1);const d=jQ,m=d.chunk.vb,p=d.indices;for(let t=0,f=e.length;t<f;t++){const f=e[t];if(i=g0(f.tex,f.blendMode),!i)continue;if(p0||(p0=i),HQ||i.hash!==p0.hash||f.tex&&f.tex!==f0){HQ=!1;const t=i0-r0;t>0&&(YQ._requestDrawData(p0,f0,r0,t),r0=i0),p0=i,f0=f.tex}ZQ=f.vertexCount,e0=f.indexCount,r=d.chunk.vertexOffset;for(let t=i0,e=i0+e0;t<e;t++)p[t]=r+QQ+s[a++];c=f.vfCount;const g=n.subarray(o,c);m.set(g,o);if(1&a0){let t=o/9*5;for(let e=o,i=o+c;e<i;e+=9,t+=5)t>=u&&(_=h[l++],v0(_,1),u=_.vfOffset),m.set(o0,e+5)}o+=c,QQ+=ZQ,i0+=e0,ZQ=0,e0=0}const f=i0-r0;f0&&f>0&&YQ._requestDrawData(p0,f0,r0,f)}(t._curFrame);else{S0(e,1,n);const i=t._debugDraw;if(t.debugBones&&i){i.clear(),i.lineWidth=5,i.strokeColor=NQ,i.fillColor=LQ;const t=e.getBones();for(let e=0,n=t.length;e<n;e++){const n=t[e],s=Math.max(n.boneData.length,5),r=n.globalTransformMatrix.tx,o=n.globalTransformMatrix.ty,a=r+n.globalTransformMatrix.a*s,c=o+n.globalTransformMatrix.b*s;i.moveTo(r,o),i.lineTo(a,c),i.stroke(),i.circle(r,o,2*Math.PI),i.fill(),0===e&&(i.fillColor=FQ)}}}y0.getMeshBuffer(jQ.chunk.bufferId).setDirty(),t.attachUtil._syncAttachedNode(),XQ=void 0,YQ=void 0}(t)},updateColor(t){t&&(YQ=t,YQ.markForUpdateRenderData())}};function S0(t,e,i){const n=jQ;qQ=n.chunk.vb,WQ=n.indices;const s=t._slots;let r,o,a,c,l,h=0;for(let t=0,h=s.length;t<h;t++){if(l=s[t],c=l._color,!l._visible||!l._displayData)continue;if(i?l._mulMat(l._worldMatrix,i,l._matrix):Ii.copy(l._worldMatrix,l._matrix),l.childArmature){S0(l.childArmature,c.a/255,l._worldMatrix);continue}if(r=g0(l.getTexture(),l._blendMode),!r)continue;p0||(p0=r);const h=l.getTexture();if(HQ||r.hash!==p0.hash||h&&f0!==h){HQ=!1;const t=i0-r0;t>0&&(YQ._requestDrawData(p0,f0,r0,t),r0=i0),f0=h,p0=r}v0(c,e),m0.set(l._worldMatrix),o=l._localVertices,ZQ=o.length/4,$Q=9*ZQ,a=l._indices,e0=a.length;let _=!1;if(QQ+ZQ>n0&&(n0=QQ+ZQ,_=!0),i0+e0>s0&&(s0=i0+e0,_=!0),_){const t=WQ,e=n.chunk.vertexOffset;n.resizeAndCopy(n0,s0>n.indexCount?s0:n.indexCount),qQ=n.chunk.vb,s0>WQ.length&&(WQ=n.indices=new Uint16Array(s0));const i=n.chunk.vertexOffset-e;for(let e=0;e<i0;++e)WQ[e]=t[e]+i}c0=m0.m00,l0=m0.m04,h0=m0.m12,_0=m0.m01,u0=m0.m05,d0=m0.m13;for(let t=0,e=o.length,i=t0;t<e;i+=9)KQ=o[t++],JQ=o[t++],qQ[i]=KQ*c0+JQ*l0+h0,qQ[i+1]=KQ*_0+JQ*u0+d0,qQ[i+3]=o[t++],qQ[i+4]=o[t++],qQ.set(o0,i+5);const u=n.chunk.vertexOffset;for(let t=0,e=a.length,i=i0;t<e;t++,i++)WQ[i]=QQ+a[t]+u;t0+=$Q,QQ+=ZQ,i0+=e0,ZQ=0,e0=0}h=i0-r0,f0&&h>0&&(YQ._requestDrawData(p0,f0,r0,h),r0=i0),YQ.maxIndexCount<s0&&(YQ.maxIndexCount=s0),YQ.maxVertexCount<n0&&(YQ.maxVertexCount=n0)}l.internal.DragonBonesAssembler=x0;const C0={getAssembler:()=>x0};let A0,b0,T0;BQ.Assembler=C0,function(t){t[t.FFD=0]="FFD",t[t.AdjustColor=10]="AdjustColor",t[t.BevelFilter=11]="BevelFilter",t[t.BlurFilter=12]="BlurFilter",t[t.DropShadowFilter=13]="DropShadowFilter",t[t.GlowFilter=14]="GlowFilter",t[t.GradientBevelFilter=15]="GradientBevelFilter",t[t.GradientGlowFilter=16]="GradientGlowFilter"}(A0||(A0={})),function(t){t[t.Frame=0]="Frame",t[t.Sound=1]="Sound"}(b0||(b0={})),function(t){t[t.None=0]="None",t[t.SameLayer=1]="SameLayer",t[t.SameGroup=2]="SameGroup",t[t.SameLayerAndGroup=3]="SameLayerAndGroup",t[t.All=4]="All"}(T0||(T0={}));const E0=window.dragonBones,P0=E0.Slot,w0=E0.Matrix,I0=E0.BaseObject,R0=E0.BoundingBoxData,D0=E0.PolygonBoundingBoxData,M0=E0.Transform,O0=E0.Animation,B0=E0.TextureData,N0=E0.CCTextureData,L0=E0.BaseFactory,F0=E0.CCFactory,z0=E0.WorldClock,V0=E0.TextureAtlasData,G0=E0.CCArmatureDisplay,U0=E0.AnimationState,k0=E0.BoneData,H0=E0.EllipseBoundingBoxData,j0=E0.ArmatureData,W0=E0.CCTextureAtlasData,q0=E0.TransformObject,X0=E0.CCSlot,Y0=E0.Armature,K0=E0.Bone,J0=E0.RectangleBoundingBoxData,$0=E0.ArmatureCacheMgr,Z0=E0.SkinData,Q0=E0.EventObject,t1=E0.SlotData,e1=E0.DragonBonesData,i1=E0.AnimationData,n1=E0.CCArmatureCacheDisplay;t("dragonBones",Object.freeze({__proto__:null,DragonBonesAsset:CZ,DragonBonesAtlasAsset:DZ,timeScale:1,get AnimationCacheMode(){return DQ},DragonBoneSocket:OQ,ArmatureDisplay:BQ,AttachUtil:BZ,simpleDragonBoneAssembler:C0,get ExtensionType(){return A0},get EventType(){return b0},get AnimationFadeOutMode(){return T0},Slot:P0,Matrix:w0,BaseObject:I0,BoundingBoxData:R0,PolygonBoundingBoxData:D0,Transform:M0,Animation:O0,TextureData:B0,CCTextureData:N0,BaseFactory:L0,CCFactory:F0,WorldClock:z0,TextureAtlasData:V0,CCArmatureDisplay:G0,AnimationState:U0,BoneData:k0,EllipseBoundingBoxData:H0,ArmatureData:j0,CCTextureAtlasData:W0,TransformObject:q0,CCSlot:X0,Armature:Y0,Bone:K0,RectangleBoundingBoxData:J0,ArmatureCacheMgr:$0,SkinData:Z0,EventObject:Q0,SlotData:t1,DragonBonesData:e1,AnimationData:i1,CCArmatureCacheDisplay:n1}));class s1 extends sr{constructor(...t){super(...t),this._gpuDescriptorSet=null}get gpuDescriptorSet(){return this._gpuDescriptorSet}initialize(t){this._layout=t.layout;const{bindings:e,descriptorIndices:i,descriptorCount:n}=t.layout.gpuDescriptorSetLayout;this._buffers=Array(n).fill(null),this._textures=Array(n).fill(null),this._samplers=Array(n).fill(null);const s=[];this._gpuDescriptorSet={gpuDescriptors:s,descriptorIndices:i};for(let t=0;t<e.length;++t){const i=e[t];for(let t=0;t<i.count;t++)s.push({type:i.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})}}destroy(){this._layout=null,this._gpuDescriptorSet=null}update(){if(this._isDirty&&this._gpuDescriptorSet){const t=this._gpuDescriptorSet.gpuDescriptors;for(let e=0;e<t.length;++e)if(t[e].type&Us){const i=this._buffers[e];i&&(t[e].gpuBuffer=i.gpuBuffer||i.gpuBufferView)}else t[e].type&ks&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}}}let r1;!function(t){t[t.RGBA16F_EXT=34842]="RGBA16F_EXT",t[t.RGB16F_EXT=34843]="RGB16F_EXT",t[t.RGBA32F_EXT=34836]="RGBA32F_EXT",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",t[t.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",t[t.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",t[t.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",t[t.SRGB_EXT=35904]="SRGB_EXT",t[t.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",t[t.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(r1||(r1={}));class o1{static get instance(){return o1._instance}static setInstance(t){o1._instance=t}}function a1(t,e){switch(t){case Zi.R8:return e.UNSIGNED_BYTE;case Zi.R8SN:return e.BYTE;case Zi.R8UI:return e.UNSIGNED_BYTE;case Zi.R8I:return e.BYTE;case Zi.R16F:return r1.HALF_FLOAT_OES;case Zi.R16UI:return e.UNSIGNED_SHORT;case Zi.R16I:return e.SHORT;case Zi.R32F:return e.FLOAT;case Zi.R32UI:return e.UNSIGNED_INT;case Zi.R32I:return e.INT;case Zi.RG8:return e.UNSIGNED_BYTE;case Zi.RG8SN:return e.BYTE;case Zi.RG8UI:return e.UNSIGNED_BYTE;case Zi.RG8I:return e.BYTE;case Zi.RG16F:return r1.HALF_FLOAT_OES;case Zi.RG16UI:return e.UNSIGNED_SHORT;case Zi.RG16I:return e.SHORT;case Zi.RG32F:return e.FLOAT;case Zi.RG32UI:return e.UNSIGNED_INT;case Zi.RG32I:return e.INT;case Zi.RGB8:case Zi.SRGB8:return e.UNSIGNED_BYTE;case Zi.RGB8SN:return e.BYTE;case Zi.RGB8UI:return e.UNSIGNED_BYTE;case Zi.RGB8I:return e.BYTE;case Zi.RGB16F:return r1.HALF_FLOAT_OES;case Zi.RGB16UI:return e.UNSIGNED_SHORT;case Zi.RGB16I:return e.SHORT;case Zi.RGB32F:return e.FLOAT;case Zi.RGB32UI:return e.UNSIGNED_INT;case Zi.RGB32I:return e.INT;case Zi.BGRA8:case Zi.RGBA8:case Zi.SRGB8_A8:return e.UNSIGNED_BYTE;case Zi.RGBA8SN:return e.BYTE;case Zi.RGBA8UI:return e.UNSIGNED_BYTE;case Zi.RGBA8I:return e.BYTE;case Zi.RGBA16F:return r1.HALF_FLOAT_OES;case Zi.RGBA16UI:return e.UNSIGNED_SHORT;case Zi.RGBA16I:return e.SHORT;case Zi.RGBA32F:return e.FLOAT;case Zi.RGBA32UI:return e.UNSIGNED_INT;case Zi.RGBA32I:return e.INT;case Zi.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case Zi.R11G11B10F:return e.FLOAT;case Zi.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case Zi.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case Zi.RGB10A2:return e.UNSIGNED_BYTE;case Zi.RGB10A2UI:return e.UNSIGNED_INT;case Zi.RGB9E5:return e.UNSIGNED_BYTE;case Zi.DEPTH:return e.UNSIGNED_INT;case Zi.DEPTH_STENCIL:return r1.UNSIGNED_INT_24_8_WEBGL;case Zi.BC1:case Zi.BC1_SRGB:case Zi.BC2:case Zi.BC2_SRGB:case Zi.BC3:case Zi.BC3_SRGB:case Zi.BC4:return e.UNSIGNED_BYTE;case Zi.BC4_SNORM:return e.BYTE;case Zi.BC5:return e.UNSIGNED_BYTE;case Zi.BC5_SNORM:return e.BYTE;case Zi.BC6H_SF16:case Zi.BC6H_UF16:return e.FLOAT;case Zi.BC7:case Zi.BC7_SRGB:case Zi.ETC_RGB8:case Zi.ETC2_RGB8:case Zi.ETC2_SRGB8:case Zi.ETC2_RGB8_A1:case Zi.ETC2_SRGB8_A1:case Zi.EAC_R11:return e.UNSIGNED_BYTE;case Zi.EAC_R11SN:return e.BYTE;case Zi.EAC_RG11:return e.UNSIGNED_BYTE;case Zi.EAC_RG11SN:return e.BYTE;case Zi.PVRTC_RGB2:case Zi.PVRTC_RGBA2:case Zi.PVRTC_RGB4:case Zi.PVRTC_RGBA4:case Zi.PVRTC2_2BPP:case Zi.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case Zi.ASTC_RGBA_4X4:case Zi.ASTC_RGBA_5X4:case Zi.ASTC_RGBA_5X5:case Zi.ASTC_RGBA_6X5:case Zi.ASTC_RGBA_6X6:case Zi.ASTC_RGBA_8X5:case Zi.ASTC_RGBA_8X6:case Zi.ASTC_RGBA_8X8:case Zi.ASTC_RGBA_10X5:case Zi.ASTC_RGBA_10X6:case Zi.ASTC_RGBA_10X8:case Zi.ASTC_RGBA_10X10:case Zi.ASTC_RGBA_12X10:case Zi.ASTC_RGBA_12X12:case Zi.ASTC_SRGBA_4X4:case Zi.ASTC_SRGBA_5X4:case Zi.ASTC_SRGBA_5X5:case Zi.ASTC_SRGBA_6X5:case Zi.ASTC_SRGBA_6X6:case Zi.ASTC_SRGBA_8X5:case Zi.ASTC_SRGBA_8X6:case Zi.ASTC_SRGBA_8X8:case Zi.ASTC_SRGBA_10X5:case Zi.ASTC_SRGBA_10X6:case Zi.ASTC_SRGBA_10X8:case Zi.ASTC_SRGBA_10X10:case Zi.ASTC_SRGBA_12X10:case Zi.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function c1(t,e){switch(t){case tn.BOOL:return e.BOOL;case tn.BOOL2:return e.BOOL_VEC2;case tn.BOOL3:return e.BOOL_VEC3;case tn.BOOL4:return e.BOOL_VEC4;case tn.INT:return e.INT;case tn.INT2:return e.INT_VEC2;case tn.INT3:return e.INT_VEC3;case tn.INT4:return e.INT_VEC4;case tn.UINT:return e.UNSIGNED_INT;case tn.FLOAT:return e.FLOAT;case tn.FLOAT2:return e.FLOAT_VEC2;case tn.FLOAT3:return e.FLOAT_VEC3;case tn.FLOAT4:return e.FLOAT_VEC4;case tn.MAT2:return e.FLOAT_MAT2;case tn.MAT3:return e.FLOAT_MAT3;case tn.MAT4:return e.FLOAT_MAT4;case tn.SAMPLER2D:return e.SAMPLER_2D;case tn.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),tn.UNKNOWN}}function l1(t){switch(t){case tn.BOOL:case tn.BOOL2:case tn.BOOL3:case tn.BOOL4:case tn.INT:case tn.INT2:case tn.INT3:case tn.INT4:case tn.UINT:return Int32Array;case tn.FLOAT:case tn.FLOAT2:case tn.FLOAT3:case tn.FLOAT4:case tn.MAT2:case tn.MAT3:case tn.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function h1(t,e){switch(t){case e.BOOL:return tn.BOOL;case e.BOOL_VEC2:return tn.BOOL2;case e.BOOL_VEC3:return tn.BOOL3;case e.BOOL_VEC4:return tn.BOOL4;case e.INT:return tn.INT;case e.INT_VEC2:return tn.INT2;case e.INT_VEC3:return tn.INT3;case e.INT_VEC4:return tn.INT4;case e.UNSIGNED_INT:return tn.UINT;case e.FLOAT:return tn.FLOAT;case e.FLOAT_VEC2:return tn.FLOAT2;case e.FLOAT_VEC3:return tn.FLOAT3;case e.FLOAT_VEC4:return tn.FLOAT4;case e.FLOAT_MAT2:return tn.MAT2;case e.FLOAT_MAT3:return tn.MAT3;case e.FLOAT_MAT4:return tn.MAT4;case e.SAMPLER_2D:return tn.SAMPLER2D;case e.SAMPLER_CUBE:return tn.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),tn.UNKNOWN}}function _1(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function u1(t,e){switch(t){case e.FLOAT_MAT2:return 2;case e.FLOAT_MAT3:return 3;case e.FLOAT_MAT4:return 4;default:return 1}}o1._instance=null;const d1=[512,513,514,515,516,517,518,519],m1=[0,7680,7681,7682,7683,5386,34055,34056],p1=[32774,32778,32779,32775,32776],f1=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];let g1;!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(g1||(g1={}));class v1{constructor(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t}}class y1 extends v1{constructor(){super(g1.BEGIN_RENDER_PASS),this.gpuRenderPass=null,this.gpuFramebuffer=null,this.renderArea=new Gn,this.clearFlag=Nn.NONE,this.clearColors=[],this.clearDepth=1,this.clearStencil=0}clear(){this.gpuFramebuffer=null,this.clearColors.length=0}}class x1 extends v1{constructor(){super(g1.BIND_STATES),this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets=[],this.dynamicOffsets=[],this.dynamicStates=new zs}clear(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0}}class S1 extends v1{constructor(){super(g1.DRAW),this.drawInfo=new ts}clear(){}}class C1 extends v1{constructor(){super(g1.UPDATE_BUFFER),this.gpuBuffer=null,this.buffer=null,this.offset=0,this.size=0}clear(){this.gpuBuffer=null,this.buffer=null}}class A1 extends v1{constructor(){super(g1.COPY_BUFFER_TO_TEXTURE),this.gpuTexture=null,this.buffers=[],this.regions=[]}clear(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}class b1{constructor(){this.cmds=new Bl(1),this.beginRenderPassCmds=new Bl(1),this.bindStatesCmds=new Bl(1),this.drawCmds=new Bl(1),this.updateBufferCmds=new Bl(1),this.copyBufferToTextureCmds=new Bl(1)}clearCmds(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}function T1(t,e,i,n,s){if(e.usage&en.UNIFORM)ArrayBuffer.isView(i)?e.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):e.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(e.usage&en.INDIRECT){e.indirects.clearDraws();const t=i.drawInfos;for(let i=0;i<t.length;++i)e.indirects.setDrawInfo(n+i,t[i])}else{const r=i,{gl:o}=t,a=t.stateCache;switch(e.glTarget){case o.ARRAY_BUFFER:t.extensions.useVAO&&a.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=null),E1.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer);break;case o.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&a.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=null),E1.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}s===r.byteLength?o.bufferSubData(e.glTarget,n,r):o.bufferSubData(e.glTarget,n,r.slice(0,s))}}const E1={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0},P1=new Gn;function w1(t,e,i,n,s,r,o){const{gl:a}=t,c=t.stateCache;let l=0;if(i&&(P1.x=n.x<<i.lodLevel,P1.y=n.y<<i.lodLevel,P1.width=n.width<<i.lodLevel,P1.height=n.height<<i.lodLevel),i&&e){c.glFramebuffer!==i.glFramebuffer&&(a.bindFramebuffer(a.FRAMEBUFFER,i.glFramebuffer),c.glFramebuffer=i.glFramebuffer),c.viewport.left===P1.x&&c.viewport.top===P1.y&&c.viewport.width===P1.width&&c.viewport.height===P1.height||(a.viewport(P1.x,P1.y,P1.width,P1.height),c.viewport.left=P1.x,c.viewport.top=P1.y,c.viewport.width=P1.width,c.viewport.height=P1.height),c.scissorRect.x===P1.x&&c.scissorRect.y===P1.y&&c.scissorRect.width===P1.width&&c.scissorRect.height===P1.height||(a.scissor(P1.x,P1.y,P1.width,P1.height),c.scissorRect.x=P1.x,c.scissorRect.y=P1.y,c.scissorRect.width=P1.width,c.scissorRect.height=P1.height);let n=s.length;t.extensions.WEBGL_draw_buffers||(n=1);for(let t=0;t<n;++t){const i=e.colorAttachments[t];if(i.format!==Zi.UNKNOWN)switch(i.loadOp){case xn.LOAD:break;case xn.CLEAR:{c.bs.targets[0].blendColorMask!==vn.ALL&&a.colorMask(!0,!0,!0,!0);const t=s[0];a.clearColor(t.x,t.y,t.z,t.w),l|=a.COLOR_BUFFER_BIT;break}case xn.DISCARD:}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==Zi.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case xn.LOAD:break;case xn.CLEAR:c.dss.depthWrite||a.depthMask(!0),a.clearDepth(r),l|=a.DEPTH_BUFFER_BIT;break;case xn.DISCARD:}if(Gs[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case xn.LOAD:break;case xn.CLEAR:c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,65535),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,65535),a.clearStencil(o),l|=a.STENCIL_BUFFER_BIT;break;case xn.DISCARD:}}if(l&&a.clear(l),l&a.COLOR_BUFFER_BIT){const t=c.bs.targets[0].blendColorMask;if(t!==vn.ALL){const e=(t&vn.R)!==vn.NONE,i=(t&vn.G)!==vn.NONE,n=(t&vn.B)!==vn.NONE,s=(t&vn.A)!==vn.NONE;a.colorMask(e,i,n,s)}}l&a.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&a.depthMask(!1),l&a.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,0),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,0))}}function I1(t,e,i,n,s,r){const{gl:o}=t,a=t.stateCache,c=e&&e.gpuShader;let l,h,_,u=!1;if(e&&E1.gpuPipelineState!==e){if(E1.gpuPipelineState=e,E1.glPrimitive=e.glPrimitive,e.gpuShader){const{glProgram:t}=e.gpuShader;a.glProgram!==t&&(o.useProgram(t),a.glProgram=t,u=!0)}const{rs:t}=e;if(t){if(a.rs.cullMode!==t.cullMode){switch(t.cullMode){case wn.NONE:o.disable(o.CULL_FACE);break;case wn.FRONT:o.enable(o.CULL_FACE),o.cullFace(o.FRONT);break;case wn.BACK:o.enable(o.CULL_FACE),o.cullFace(o.BACK)}a.rs.cullMode=t.cullMode}const e=t.isFrontFaceCCW;a.rs.isFrontFaceCCW!==e&&(o.frontFace(e?o.CCW:o.CW),a.rs.isFrontFaceCCW=e),a.rs.depthBias===t.depthBias&&a.rs.depthBiasSlop===t.depthBiasSlop||(o.polygonOffset(t.depthBias,t.depthBiasSlop),a.rs.depthBias=t.depthBias,a.rs.depthBiasSlop=t.depthBiasSlop),a.rs.lineWidth!==t.lineWidth&&(o.lineWidth(t.lineWidth),a.rs.lineWidth=t.lineWidth)}const{dss:i}=e;i&&(a.dss.depthTest!==i.depthTest&&(i.depthTest?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),a.dss.depthTest=i.depthTest),a.dss.depthWrite!==i.depthWrite&&(o.depthMask(i.depthWrite),a.dss.depthWrite=i.depthWrite),a.dss.depthFunc!==i.depthFunc&&(o.depthFunc(d1[i.depthFunc]),a.dss.depthFunc=i.depthFunc),a.dss.stencilTestFront===i.stencilTestFront&&a.dss.stencilTestBack===i.stencilTestBack||(i.stencilTestFront||i.stencilTestBack?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),a.dss.stencilTestFront=i.stencilTestFront,a.dss.stencilTestBack=i.stencilTestBack),a.dss.stencilFuncFront===i.stencilFuncFront&&a.dss.stencilRefFront===i.stencilRefFront&&a.dss.stencilReadMaskFront===i.stencilReadMaskFront||(o.stencilFuncSeparate(o.FRONT,d1[i.stencilFuncFront],i.stencilRefFront,i.stencilReadMaskFront),a.dss.stencilFuncFront=i.stencilFuncFront,a.dss.stencilRefFront=i.stencilRefFront,a.dss.stencilReadMaskFront=i.stencilReadMaskFront),a.dss.stencilFailOpFront===i.stencilFailOpFront&&a.dss.stencilZFailOpFront===i.stencilZFailOpFront&&a.dss.stencilPassOpFront===i.stencilPassOpFront||(o.stencilOpSeparate(o.FRONT,m1[i.stencilFailOpFront],m1[i.stencilZFailOpFront],m1[i.stencilPassOpFront]),a.dss.stencilFailOpFront=i.stencilFailOpFront,a.dss.stencilZFailOpFront=i.stencilZFailOpFront,a.dss.stencilPassOpFront=i.stencilPassOpFront),a.dss.stencilWriteMaskFront!==i.stencilWriteMaskFront&&(o.stencilMaskSeparate(o.FRONT,i.stencilWriteMaskFront),a.dss.stencilWriteMaskFront=i.stencilWriteMaskFront),a.dss.stencilFuncBack===i.stencilFuncBack&&a.dss.stencilRefBack===i.stencilRefBack&&a.dss.stencilReadMaskBack===i.stencilReadMaskBack||(o.stencilFuncSeparate(o.BACK,d1[i.stencilFuncBack],i.stencilRefBack,i.stencilReadMaskBack),a.dss.stencilFuncBack=i.stencilFuncBack,a.dss.stencilRefBack=i.stencilRefBack,a.dss.stencilReadMaskBack=i.stencilReadMaskBack),a.dss.stencilFailOpBack===i.stencilFailOpBack&&a.dss.stencilZFailOpBack===i.stencilZFailOpBack&&a.dss.stencilPassOpBack===i.stencilPassOpBack||(o.stencilOpSeparate(o.BACK,m1[i.stencilFailOpBack],m1[i.stencilZFailOpBack],m1[i.stencilPassOpBack]),a.dss.stencilFailOpBack=i.stencilFailOpBack,a.dss.stencilZFailOpBack=i.stencilZFailOpBack,a.dss.stencilPassOpBack=i.stencilPassOpBack),a.dss.stencilWriteMaskBack!==i.stencilWriteMaskBack&&(o.stencilMaskSeparate(o.BACK,i.stencilWriteMaskBack),a.dss.stencilWriteMaskBack=i.stencilWriteMaskBack));const{bs:n}=e;if(n){a.bs.isA2C!==n.isA2C&&(n.isA2C?o.enable(o.SAMPLE_ALPHA_TO_COVERAGE):o.disable(o.SAMPLE_ALPHA_TO_COVERAGE),a.bs.isA2C=n.isA2C),a.bs.blendColor.x===n.blendColor.x&&a.bs.blendColor.y===n.blendColor.y&&a.bs.blendColor.z===n.blendColor.z&&a.bs.blendColor.w===n.blendColor.w||(o.blendColor(n.blendColor.x,n.blendColor.y,n.blendColor.z,n.blendColor.w),a.bs.blendColor.x=n.blendColor.x,a.bs.blendColor.y=n.blendColor.y,a.bs.blendColor.z=n.blendColor.z,a.bs.blendColor.w=n.blendColor.w);const t=n.targets[0],e=a.bs.targets[0];e.blend!==t.blend&&(t.blend?o.enable(o.BLEND):o.disable(o.BLEND),e.blend=t.blend),e.blendEq===t.blendEq&&e.blendAlphaEq===t.blendAlphaEq||(o.blendEquationSeparate(p1[t.blendEq],p1[t.blendAlphaEq]),e.blendEq=t.blendEq,e.blendAlphaEq=t.blendAlphaEq),e.blendSrc===t.blendSrc&&e.blendDst===t.blendDst&&e.blendSrcAlpha===t.blendSrcAlpha&&e.blendDstAlpha===t.blendDstAlpha||(o.blendFuncSeparate(f1[t.blendSrc],f1[t.blendDst],f1[t.blendSrcAlpha],f1[t.blendDstAlpha]),e.blendSrc=t.blendSrc,e.blendDst=t.blendDst,e.blendSrcAlpha=t.blendSrcAlpha,e.blendDstAlpha=t.blendDstAlpha),e.blendColorMask!==t.blendColorMask&&(o.colorMask((t.blendColorMask&vn.R)!==vn.NONE,(t.blendColorMask&vn.G)!==vn.NONE,(t.blendColorMask&vn.B)!==vn.NONE,(t.blendColorMask&vn.A)!==vn.NONE),e.blendColorMask=t.blendColorMask)}}if(e&&e.gpuPipelineLayout&&c){const i=c.glBlocks.length,{dynamicOffsetIndices:r}=e.gpuPipelineLayout;for(let t=0;t<i;t++){const e=c.glBlocks[t],i=n[e.set],a=i&&i.descriptorIndices[e.binding],l=a>=0&&i.gpuDescriptors[a];let h=null,_=0;if(l&&l.gpuBuffer){const{gpuBuffer:t}=l,i=r[e.set],n=i&&i[e.binding];n>=0&&(_=s[n]),"vf32"in t?h=t.vf32:(_+=t.offset,h=t.gpuBuffer.vf32),_>>=2}if(!h){x(`Buffer binding '${e.name}' at set ${e.set} binding ${e.binding} is not bounded`);continue}const u=e.glActiveUniforms.length;for(let t=0;t<u;t++){const i=e.glActiveUniforms[t];switch(i.glType){case o.BOOL:case o.INT:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform1iv(i.glLoc,i.array);break}}break;case o.BOOL_VEC2:case o.INT_VEC2:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform2iv(i.glLoc,i.array);break}}break;case o.BOOL_VEC3:case o.INT_VEC3:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform3iv(i.glLoc,i.array);break}}break;case o.BOOL_VEC4:case o.INT_VEC4:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform4iv(i.glLoc,i.array);break}}break;case o.FLOAT:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform1fv(i.glLoc,i.array);break}}break;case o.FLOAT_VEC2:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform2fv(i.glLoc,i.array);break}}break;case o.FLOAT_VEC3:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform3fv(i.glLoc,i.array);break}}break;case o.FLOAT_VEC4:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform4fv(i.glLoc,i.array);break}}break;case o.FLOAT_MAT2:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniformMatrix2fv(i.glLoc,!1,i.array);break}}break;case o.FLOAT_MAT3:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniformMatrix3fv(i.glLoc,!1,i.array);break}}break;case o.FLOAT_MAT4:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniformMatrix4fv(i.glLoc,!1,i.array);break}}}}}const u=c.glSamplerTextures.length;for(let e=0;e<u;e++){const i=c.glSamplerTextures[e],s=n[i.set];let r=s&&s.descriptorIndices[i.binding],u=r>=0&&s.gpuDescriptors[r];const d=i.units.length;for(let e=0;e<d;e++){const n=i.units[e];if(u&&u.gpuSampler){if(u.gpuTexture&&u.gpuTexture.size>0){const{gpuTexture:e}=u,i=a.glTexUnits[n];i.glTexture!==e.glTexture&&(a.texUnit!==n&&(o.activeTexture(o.TEXTURE0+n),a.texUnit=n),e.glTexture?o.bindTexture(e.glTarget,e.glTexture):o.bindTexture(e.glTarget,t.nullTex2D.gpuTexture.glTexture),i.glTexture=e.glTexture);const{gpuSampler:s}=u;e.isPowerOf2?(l=s.glWrapS,h=s.glWrapT):(l=o.CLAMP_TO_EDGE,h=o.CLAMP_TO_EDGE),_=e.isPowerOf2?e.mipLevel<=1&&(s.glMinFilter===o.LINEAR_MIPMAP_NEAREST||s.glMinFilter===o.LINEAR_MIPMAP_LINEAR)?o.LINEAR:s.glMinFilter:s.glMinFilter===o.LINEAR||s.glMinFilter===o.LINEAR_MIPMAP_NEAREST||s.glMinFilter===o.LINEAR_MIPMAP_LINEAR?o.LINEAR:o.NEAREST,e.glWrapS!==l&&(a.texUnit!==n&&(o.activeTexture(o.TEXTURE0+n),a.texUnit=n),o.texParameteri(e.glTarget,o.TEXTURE_WRAP_S,l),e.glWrapS=l),e.glWrapT!==h&&(a.texUnit!==n&&(o.activeTexture(o.TEXTURE0+n),a.texUnit=n),o.texParameteri(e.glTarget,o.TEXTURE_WRAP_T,h),e.glWrapT=h),e.glMinFilter!==_&&(a.texUnit!==n&&(o.activeTexture(o.TEXTURE0+n),a.texUnit=n),o.texParameteri(e.glTarget,o.TEXTURE_MIN_FILTER,_),e.glMinFilter=_),e.glMagFilter!==s.glMagFilter&&(a.texUnit!==n&&(o.activeTexture(o.TEXTURE0+n),a.texUnit=n),o.texParameteri(e.glTarget,o.TEXTURE_MAG_FILTER,s.glMagFilter),e.glMagFilter=s.glMagFilter)}u=s.gpuDescriptors[++r]}else x(`Sampler binding '${i.name}' at set ${i.set} binding ${i.binding} index ${e} is not bounded`)}}}if(i&&c&&(u||E1.gpuInputAssembler!==i)){E1.gpuInputAssembler=i;const e=t.extensions.ANGLE_instanced_arrays;if(t.extensions.useVAO){const n=t.extensions.OES_vertex_array_object;let s=i.glVAOs.get(c.glProgram);if(!s){let t;s=n.createVertexArrayOES(),i.glVAOs.set(c.glProgram,s),n.bindVertexArrayOES(s),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null;const r=c.glInputs.length;for(let n=0;n<r;n++){const s=c.glInputs[n];t=null;const r=i.glAttribs.length;for(let e=0;e<r;e++){const n=i.glAttribs[e];if(n.name===s.name){t=n;break}}if(t){a.glArrayBuffer!==t.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,t.glBuffer),a.glArrayBuffer=t.glBuffer);for(let i=0;i<t.componentCount;++i){const n=s.glLoc+i,r=t.offset+t.size*i;o.enableVertexAttribArray(n),a.glCurrentAttribLocs[n]=!0,o.vertexAttribPointer(n,t.count,t.glType,t.isNormalized,t.stride,r),e&&e.vertexAttribDivisorANGLE(n,t.isInstanced?1:0)}}}const l=i.gpuIndexBuffer;l&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,l.glBuffer),n.bindVertexArrayOES(null),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null}a.glVAO!==s&&(n.bindVertexArrayOES(s),a.glVAO=s)}else{for(let e=0;e<t.capabilities.maxVertexAttributes;++e)a.glCurrentAttribLocs[e]=!1;const n=c.glInputs.length;for(let t=0;t<n;t++){const n=c.glInputs[t];let s=null;const r=i.glAttribs.length;for(let t=0;t<r;t++){const e=i.glAttribs[t];if(e.name===n.name){s=e;break}}if(s){a.glArrayBuffer!==s.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,s.glBuffer),a.glArrayBuffer=s.glBuffer);for(let t=0;t<s.componentCount;++t){const i=n.glLoc+t,r=s.offset+s.size*t;!a.glEnabledAttribLocs[i]&&i>=0&&(o.enableVertexAttribArray(i),a.glEnabledAttribLocs[i]=!0),a.glCurrentAttribLocs[i]=!0,o.vertexAttribPointer(i,s.count,s.glType,s.isNormalized,s.stride,r),e&&e.vertexAttribDivisorANGLE(i,s.isInstanced?1:0)}}}const s=i.gpuIndexBuffer;s&&a.glElementArrayBuffer!==s.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,s.glBuffer),a.glElementArrayBuffer=s.glBuffer);for(let e=0;e<t.capabilities.maxVertexAttributes;++e)a.glEnabledAttribLocs[e]!==a.glCurrentAttribLocs[e]&&(o.disableVertexAttribArray(e),a.glEnabledAttribLocs[e]=!1)}}if(e&&e.dynamicStates.length){const t=e.dynamicStates.length;for(let i=0;i<t;i++)switch(e.dynamicStates[i]){case In.LINE_WIDTH:a.rs.lineWidth!==r.lineWidth&&(o.lineWidth(r.lineWidth),a.rs.lineWidth=r.lineWidth);break;case In.DEPTH_BIAS:a.rs.depthBias===r.depthBiasConstant&&a.rs.depthBiasSlop===r.depthBiasSlope||(o.polygonOffset(r.depthBiasConstant,r.depthBiasSlope),a.rs.depthBias=r.depthBiasConstant,a.rs.depthBiasSlop=r.depthBiasSlope);break;case In.BLEND_CONSTANTS:{const t=r.blendConstant;a.bs.blendColor.x===t.x&&a.bs.blendColor.y===t.y&&a.bs.blendColor.z===t.z&&a.bs.blendColor.w===t.w||(o.blendColor(t.x,t.y,t.z,t.w),a.bs.blendColor.copy(t));break}case In.STENCIL_WRITE_MASK:{const t=r.stencilStatesFront,e=r.stencilStatesBack;a.dss.stencilWriteMaskFront!==t.writeMask&&(o.stencilMaskSeparate(o.FRONT,t.writeMask),a.dss.stencilWriteMaskFront=t.writeMask),a.dss.stencilWriteMaskBack!==e.writeMask&&(o.stencilMaskSeparate(o.BACK,e.writeMask),a.dss.stencilWriteMaskBack=e.writeMask);break}case In.STENCIL_COMPARE_MASK:{const t=r.stencilStatesFront,e=r.stencilStatesBack;a.dss.stencilRefFront===t.reference&&a.dss.stencilReadMaskFront===t.compareMask||(o.stencilFuncSeparate(o.FRONT,d1[a.dss.stencilFuncFront],t.reference,t.compareMask),a.dss.stencilRefFront=t.reference,a.dss.stencilReadMaskFront=t.compareMask),a.dss.stencilRefBack===e.reference&&a.dss.stencilReadMaskBack===e.compareMask||(o.stencilFuncSeparate(o.BACK,d1[a.dss.stencilFuncBack],e.reference,e.compareMask),a.dss.stencilRefBack=e.reference,a.dss.stencilReadMaskBack=e.compareMask);break}}}}function R1(t,e){const{gl:i}=t,{ANGLE_instanced_arrays:n,WEBGL_multi_draw:s}=t.extensions,{gpuInputAssembler:r,glPrimitive:o}=E1;if(r){const t=r.gpuIndexBuffer;if(r.gpuIndirectBuffer){const e=r.gpuIndirectBuffer.indirects;if(e.drawByIndex){for(let i=0;i<e.drawCount;i++)e.byteOffsets[i]=e.offsets[i]*t.stride;if(s)e.instancedDraw?s.multiDrawElementsInstancedWEBGL(o,e.counts,0,r.glIndexType,e.byteOffsets,0,e.instances,0,e.drawCount):s.multiDrawElementsWEBGL(o,e.counts,0,r.glIndexType,e.byteOffsets,0,e.drawCount);else for(let t=0;t<e.drawCount;t++)e.instances[t]&&n?n.drawElementsInstancedANGLE(o,e.counts[t],r.glIndexType,e.byteOffsets[t],e.instances[t]):i.drawElements(o,e.counts[t],r.glIndexType,e.byteOffsets[t])}else if(s)e.instancedDraw?s.multiDrawArraysInstancedWEBGL(o,e.offsets,0,e.counts,0,e.instances,0,e.drawCount):s.multiDrawArraysWEBGL(o,e.offsets,0,e.counts,0,e.drawCount);else for(let t=0;t<e.drawCount;t++)e.instances[t]&&n?n.drawArraysInstancedANGLE(o,e.offsets[t],e.counts[t],e.instances[t]):i.drawArrays(o,e.offsets[t],e.counts[t])}else if(e.instanceCount&&n)if(t){if(e.indexCount>0){const i=e.firstIndex*t.stride;n.drawElementsInstancedANGLE(o,e.indexCount,r.glIndexType,i,e.instanceCount)}}else e.vertexCount>0&&n.drawArraysInstancedANGLE(o,e.firstVertex,e.vertexCount,e.instanceCount);else if(t){if(e.indexCount>0){const n=e.firstIndex*t.stride;i.drawElements(o,e.indexCount,r.glIndexType,n)}}else e.vertexCount>0&&i.drawArrays(o,e.firstVertex,e.vertexCount)}}const D1=new Array(g1.COUNT);function M1(t,e){D1.fill(0);for(let i=0;i<e.cmds.length;++i){const n=e.cmds.array[i],s=D1[n]++;switch(n){case g1.BEGIN_RENDER_PASS:{const i=e.beginRenderPassCmds.array[s];w1(t,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break}case g1.BIND_STATES:{const i=e.bindStatesCmds.array[s];I1(t,i.gpuPipelineState,i.gpuInputAssembler,i.gpuDescriptorSets,i.dynamicOffsets,i.dynamicStates);break}case g1.DRAW:R1(t,e.drawCmds.array[s].drawInfo);break;case g1.UPDATE_BUFFER:{const i=e.updateBufferCmds.array[s];T1(t,i.gpuBuffer,i.buffer,i.offset,i.size);break}case g1.COPY_BUFFER_TO_TEXTURE:{const i=e.copyBufferToTextureCmds.array[s];O1(t,i.buffers,i.gpuTexture,i.regions);break}}}}function O1(t,e,i,n){const{gl:s}=t,r=t.stateCache.glTexUnits[t.stateCache.texUnit];r.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),r.glTexture=i.glTexture);let o=0,a=1,c=1,l=0;const h=Gs[i.format],{isCompressed:_}=h;switch(i.glTarget){case s.TEXTURE_2D:for(let r=0;r<n.length;r++){const l=n[r];a=l.texExtent.width,c=l.texExtent.height;const h=e[o++];_?i.glInternalFmt===r1.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,i.glInternalFmt,a,c,0,h):s.compressedTexSubImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,a,c,i.glFormat,h):s.texSubImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,a,c,i.glFormat,i.glType,h)}break;case s.TEXTURE_CUBE_MAP:for(let r=0;r<n.length;r++){const h=n[r],u=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(l=h.texSubres.baseArrayLayer;l<u;++l){a=h.texExtent.width,c=h.texExtent.height;const n=e[o++];_?i.glInternalFmt===r1.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,h.texSubres.mipLevel,i.glInternalFmt,a,c,0,n):s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,a,c,i.glFormat,n):s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,a,c,i.glFormat,i.glType,n)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&cn.GEN_MIPMAP&&s.generateMipmap(i.glTarget)}class B1{constructor(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}clearDraws(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1}setDrawInfo(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)}_ensureCapacity(t){if(this._capacity>t)return;this._capacity=r(t);const e=new Int32Array(this._capacity),i=new Int32Array(this._capacity),n=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),i.set(this.offsets),n.set(this.instances),this.counts=e,this.offsets=i,this.instances=n}}class N1 extends rr{constructor(...t){super(...t),this._gpuBuffer=null,this._gpuBufferView=null,this._uniformBuffer=null}get gpuBuffer(){return this._gpuBuffer}get gpuBufferView(){return this._gpuBufferView}initialize(t){if("buffer"in t){this._isBufferView=!0;const e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBufferView={gpuBuffer:e.gpuBuffer,offset:t.offset,range:t.range}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._usage&en.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new B1,glTarget:0,glBuffer:null},this._usage&en.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(t,e){const{gl:i}=t,n=t.stateCache,s=e.memUsage&rn.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(e.usage&en.VERTEX){e.glTarget=i.ARRAY_BUFFER;const r=i.createBuffer();r&&(e.glBuffer=r,e.size>0&&(t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),E1.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),i.bufferData(i.ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&en.INDEX){e.glTarget=i.ELEMENT_ARRAY_BUFFER;const r=i.createBuffer();r&&(e.glBuffer=r,e.size>0&&(t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),E1.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else e.usage&en.UNIFORM?(e.glTarget=i.NONE,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(e.usage&en.INDIRECT||e.usage&en.TRANSFER_DST||e.usage&en.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=i.NONE)}(o1.instance,this._gpuBuffer),o1.instance.memoryStatus.bufferSize+=this._size}destroy(){this._gpuBuffer&&(function(t,e){const{gl:i}=t,n=t.stateCache;if(e.glBuffer){switch(e.glTarget){case i.ARRAY_BUFFER:t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),E1.gpuInputAssembler=null,i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null;break;case i.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),E1.gpuInputAssembler=null,i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null}i.deleteBuffer(e.glBuffer),e.glBuffer=null}}(o1.instance,this._gpuBuffer),o1.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)}resize(t){if(this._isBufferView)return void console.warn("cannot resize buffer views!");const e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(t)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=t,t>0&&(function(t,e){const{gl:i}=t,n=t.stateCache,s=e.memUsage&rn.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;e.usage&en.VERTEX?(t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),E1.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,e.glBuffer),e.buffer?i.bufferData(i.ARRAY_BUFFER,e.buffer,s):i.bufferData(i.ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):e.usage&en.INDEX?(t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),E1.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.buffer,s):i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&en.UNIFORM?e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer)):(e.usage&en.INDIRECT||e.usage&en.TRANSFER_DST||e.usage&en.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=i.NONE)}(o1.instance,this._gpuBuffer),o1.instance.memoryStatus.bufferSize-=e,o1.instance.memoryStatus.bufferSize+=t)))}update(t,e){if(this._isBufferView)return void console.warn("cannot update through buffer views!");let i;i=void 0!==e?e:this._usage&en.INDIRECT?0:t.byteLength,T1(o1.instance,this._gpuBuffer,t,0,i)}}class L1{constructor(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new Bl(e);for(let i=0;i<e;++i)this._frees[i]=new t;this._freeIdx=e-1}alloc(t){if(this._freeIdx<0){const e=2*this._frees.length,i=this._frees;this._frees=new Array(e);const n=e-i.length;for(let e=0;e<n;++e)this._frees[e]=new t;for(let t=n,s=0;t<e;++t,++s)this._frees[t]=i[s];this._freeIdx+=n}const e=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++e.refCount,e}free(t){0==--t.refCount&&this._freeCmds.push(t)}freeCmds(t){for(let e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])}release(){for(let t=0;t<this._freeCmds.length;++t){const e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()}}class F1{constructor(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new L1(y1,1),this.bindStatesCmdPool=new L1(x1,1),this.drawCmdPool=new L1(S1,1),this.updateBufferCmdPool=new L1(C1,1),this.copyBufferToTextureCmdPool=new L1(A1,1)}clearCmds(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()}releaseCmds(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}class z1 extends or{constructor(...t){super(...t),this.cmdPackage=new b1,this._cmdAllocator=new F1,this._isInRenderPass=!1,this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets=[],this._curDynamicOffsets=Array(8).fill(0),this._curDynamicStates=new zs,this._isStateInvalied=!1}initialize(t){this._type=t.type,this._queue=t.queue;const e=o1.instance.bindingMappings.blockOffsets.length;for(let t=0;t<e;t++)this._curGPUDescriptorSets.push(null)}destroy(){this._cmdAllocator.clearCmds(this.cmdPackage)}begin(t,e=0,i){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}end(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}beginRenderPass(t,e,i,n,s,r){const o=this._cmdAllocator.beginRenderPassCmdPool.alloc(y1);o.gpuRenderPass=t.gpuRenderPass,o.gpuFramebuffer=e.gpuFramebuffer,o.renderArea.copy(i),o.clearColors.length=n.length;for(let t=0;t<n.length;++t)o.clearColors[t]=n[t];o.clearDepth=s,o.clearStencil=r,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(g1.BEGIN_RENDER_PASS),this._isInRenderPass=!0}endRenderPass(){this._isInRenderPass=!1}bindPipelineState(t){const e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)}bindDescriptorSet(t,e,i){const n=e.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=n,this._isStateInvalied=!0),i){var s;const e=null===(s=this._curGPUPipelineState)||void 0===s?void 0:s.gpuPipelineLayout;if(e){const n=this._curDynamicOffsets,s=e.dynamicOffsetOffsets[t];for(let t=0;t<i.length;t++)n[s+t]=i[t];this._isStateInvalied=!0}}}bindInputAssembler(t){const e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0}setViewport(t){const e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)}setScissor(t){const e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)}setLineWidth(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)}setDepthBias(t,e,i){const n=this._curDynamicStates;n.depthBiasConstant===t&&n.depthBiasClamp===e&&n.depthBiasSlope===i||(n.depthBiasConstant=t,n.depthBiasClamp=e,n.depthBiasSlope=i,this._isStateInvalied=!0)}setBlendConstants(t){const e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)}setDepthBound(t,e){const i=this._curDynamicStates;i.depthMinBounds===t&&i.depthMaxBounds===e||(i.depthMinBounds=t,i.depthMaxBounds=e,this._isStateInvalied=!0)}setStencilWriteMask(t,e){const i=this._curDynamicStates.stencilStatesFront,n=this._curDynamicStates.stencilStatesBack;t&Rn.FRONT&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0),t&Rn.BACK&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0)}setStencilCompareMask(t,e,i){const n=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;t&Rn.FRONT&&(n.compareMask===i&&n.reference===e||(n.reference=e,n.compareMask=i,this._isStateInvalied=!0)),t&Rn.BACK&&(s.compareMask===i&&s.reference===e||(s.reference=e,s.compareMask=i,this._isStateInvalied=!0))}draw(t){if(this._type===Bn.PRIMARY&&this._isInRenderPass||this._type===Bn.SECONDARY){this._isStateInvalied&&this.bindStates();const e="drawInfo"in t?t.drawInfo:t,i=this._cmdAllocator.drawCmdPool.alloc(S1);i.drawInfo.copy(e),this.cmdPackage.drawCmds.push(i),this.cmdPackage.cmds.push(g1.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;const n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(t,e,i){if(this._type===Bn.PRIMARY&&!this._isInRenderPass||this._type===Bn.SECONDARY){const n=t.gpuBuffer;if(n){const s=this._cmdAllocator.updateBufferCmdPool.alloc(C1);let r=0,o=null;t.usage&en.INDIRECT||(r=void 0!==i?i:e.byteLength),o=e,s.gpuBuffer=n,s.buffer=o,s.offset=0,s.size=r,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(g1.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}copyBuffersToTexture(t,e,i){if(this._type===Bn.PRIMARY&&!this._isInRenderPass||this._type===Bn.SECONDARY){const n=e.gpuTexture;if(n){const e=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(A1);e&&(e.gpuTexture=n,e.regions=i,e.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(e),this.cmdPackage.cmds.push(g1.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}execute(t,e){for(let i=0;i<e;++i){const e=t[i];for(let t=0;t<e.cmdPackage.beginRenderPassCmds.length;++t){const i=e.cmdPackage.beginRenderPassCmds.array[t];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(let t=0;t<e.cmdPackage.bindStatesCmds.length;++t){const i=e.cmdPackage.bindStatesCmds.array[t];++i.refCount,this.cmdPackage.bindStatesCmds.push(i)}for(let t=0;t<e.cmdPackage.drawCmds.length;++t){const i=e.cmdPackage.drawCmds.array[t];++i.refCount,this.cmdPackage.drawCmds.push(i)}for(let t=0;t<e.cmdPackage.updateBufferCmds.length;++t){const i=e.cmdPackage.updateBufferCmds.array[t];++i.refCount,this.cmdPackage.updateBufferCmds.push(i)}for(let t=0;t<e.cmdPackage.copyBufferToTextureCmds.length;++t){const i=e.cmdPackage.copyBufferToTextureCmds.array[t];++i.refCount,this.cmdPackage.copyBufferToTextureCmds.push(i)}this.cmdPackage.cmds.concat(e.cmdPackage.cmds.array),this._numDrawCalls+=e._numDrawCalls,this._numInstances+=e._numInstances,this._numTris+=e._numTris}}pipelineBarrier(t,e,i){}bindStates(){const t=this._cmdAllocator.bindStatesCmdPool.alloc(x1);t&&(t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(g1.BIND_STATES),this._isStateInvalied=!1)}}class V1 extends lr{constructor(...t){super(...t),this._gpuFramebuffer=null}get gpuFramebuffer(){return this._gpuFramebuffer}initialize(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;let e=0;const i=[];for(let n=0;n<t.colorTextures.length;++n){const s=t.colorTextures[n];s&&(i.push(s.gpuTexture),e=s.lodLevel)}let n=null;t.depthStencilTexture&&(n=t.depthStencilTexture.gpuTexture,e=t.depthStencilTexture.lodLevel);let s=Number.MAX_SAFE_INTEGER,r=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:i,gpuDepthStencilTexture:n,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?s:this.gpuColorTextures[0].width},set width(t){s=t},get height(){return this.isOffscreen?r:this.gpuColorTextures[0].height},set height(t){r=t},lodLevel:e},function(t,e){for(let t=0;t<e.gpuColorTextures.length;++t)if(e.gpuColorTextures[t].isSwapchainTexture)return void(e.isOffscreen=!1);const{gl:i}=t,n=[],s=i.createFramebuffer();if(s){e.glFramebuffer=s,t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.glFramebuffer);for(let t=0;t<e.gpuColorTextures.length;++t){const s=e.gpuColorTextures[t];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+t,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+t,i.RENDERBUFFER,s.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+t),e.width=Math.min(e.width,s.width),e.height=Math.min(e.height,s.height))}const r=e.gpuDepthStencilTexture;if(r){const t=Gs[r.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;r.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,t,r.glTarget,r.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,t,i.RENDERBUFFER,r.glRenderbuffer),e.width=Math.min(e.width,r.width),e.height=Math.min(e.height,r.height)}t.extensions.WEBGL_draw_buffers&&t.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(n);const o=i.checkFramebufferStatus(i.FRAMEBUFFER);if(o!==i.FRAMEBUFFER_COMPLETE)switch(o){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(o1.instance,this._gpuFramebuffer)}destroy(){var t,e;this._gpuFramebuffer&&(t=o1.instance,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),t.stateCache.glFramebuffer===e.glFramebuffer&&(t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),t.stateCache.glFramebuffer=null),e.glFramebuffer=null),this._gpuFramebuffer=null)}}class G1 extends dr{constructor(...t){super(...t),this._gpuInputAssembler=null}get gpuInputAssembler(){return this._gpuInputAssembler}initialize(t){if(0===t.vertexBuffers.length)return void console.error("InputAssemblerInfo.vertexBuffers is null.");if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{const t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;const e=new Array(t.vertexBuffers.length);for(let i=0;i<t.vertexBuffers.length;++i){const n=t.vertexBuffers[i];n.gpuBuffer&&(e[i]=n.gpuBuffer)}let i=null,n=0;if(t.indexBuffer&&(i=t.indexBuffer.gpuBuffer,i))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Error index buffer stride.")}let s=null;t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:e,gpuIndexBuffer:i,gpuIndirectBuffer:s,glAttribs:[],glIndexType:n,glVAOs:new Map},function(t,e){const{gl:i}=t;e.glAttribs=new Array(e.attributes.length);const n=[0,0,0,0,0,0,0,0];for(let t=0;t<e.attributes.length;++t){const s=e.attributes[t],r=void 0!==s.stream?s.stream:0,o=e.gpuVertexBuffers[r],a=a1(s.format,i),{size:c}=Gs[s.format];e.glAttribs[t]={name:s.name,glBuffer:o.glBuffer,glType:a,size:c,count:Gs[s.format].count,stride:o.stride,componentCount:u1(a,i),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:n[r]},n[r]+=c}}(o1.instance,this._gpuInputAssembler)}destroy(){const t=o1.instance;this._gpuInputAssembler&&t.extensions.useVAO&&function(t,e){const i=e.glVAOs.values();let n=i.next();const s=t.extensions.OES_vertex_array_object;let r=t.stateCache.glVAO;for(;!n.done;)s.deleteVertexArrayOES(n.value),r===n.value&&(s.bindVertexArrayOES(null),r=null),n=i.next();t.stateCache.glVAO=r,e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null}}class U1 extends mr{constructor(...t){super(...t),this._gpuDescriptorSetLayout=null}get gpuDescriptorSetLayout(){return this._gpuDescriptorSetLayout}initialize(t){Array.prototype.push.apply(this._bindings,t.bindings);let e=0,i=-1;const n=[];for(let t=0;t<this._bindings.length;t++){const s=this._bindings[t];n.push(e),e+=s.count,s.binding>i&&(i=s.binding)}this._bindingIndices=Array(i+1).fill(-1);const s=this._descriptorIndices=Array(i+1).fill(-1);for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];this._bindingIndices[e.binding]=t,s[e.binding]=n[t]}const r=[];for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];if(e.descriptorType&Hs)for(let t=0;t<e.count;t++)r.push(e.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:r,descriptorIndices:s,descriptorCount:e}}destroy(){this._bindings.length=0}}class k1 extends pr{constructor(...t){super(...t),this._gpuPipelineLayout=null}get gpuPipelineLayout(){return this._gpuPipelineLayout}initialize(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);const e=[],i=[];let n=0;const s=[];for(let t=0;t<this._setLayouts.length;t++){const r=this._setLayouts[t],o=r.gpuDescriptorSetLayout.dynamicBindings,a=Array(r.bindingIndices.length).fill(-1);for(let t=0;t<o.length;t++){const e=o[t];a[e]<0&&(a[e]=n+t)}i.push(r.gpuDescriptorSetLayout),e.push(a),s.push(n),n+=o.length}this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetIndices:e,dynamicOffsetCount:n,dynamicOffsetOffsets:s}}destroy(){this._setLayouts.length=0}}class H1{get native(){return this}constructor(t=!1,e=En.FILL,i=Pn.GOURAND,n=wn.BACK,s=!0,r=!1,o=0,a=0,c=0,l=!0,h=!1,_=1){this.isDiscard=t,this.polygonMode=e,this.shadeModel=i,this.cullMode=n,this.isFrontFaceCCW=s,this.depthBiasEnabled=r,this.depthBias=o,this.depthBiasClamp=a,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=h,this.lineWidth=_}reset(){this.isDiscard=!1,this.polygonMode=En.FILL,this.shadeModel=Pn.GOURAND,this.cullMode=wn.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}assign(t){Object.assign(this,t)}destroy(){}}class j1{get native(){return this}constructor(t=!0,e=!0,i=mn.LESS,n=!1,s=mn.ALWAYS,r=65535,o=65535,a=pn.KEEP,c=pn.KEEP,l=pn.KEEP,h=1,_=!1,u=mn.ALWAYS,d=65535,m=65535,p=pn.KEEP,f=pn.KEEP,g=pn.KEEP,v=1){this.depthTest=t,this.depthWrite=e,this.depthFunc=i,this.stencilTestFront=n,this.stencilFuncFront=s,this.stencilReadMaskFront=r,this.stencilWriteMaskFront=o,this.stencilFailOpFront=a,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=h,this.stencilTestBack=_,this.stencilFuncBack=u,this.stencilReadMaskBack=d,this.stencilWriteMaskBack=m,this.stencilFailOpBack=p,this.stencilZFailOpBack=f,this.stencilPassOpBack=g,this.stencilRefBack=v}reset(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=mn.LESS,this.stencilTestFront=!1,this.stencilFuncFront=mn.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=pn.KEEP,this.stencilZFailOpFront=pn.KEEP,this.stencilPassOpFront=pn.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=mn.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=pn.KEEP,this.stencilZFailOpBack=pn.KEEP,this.stencilPassOpBack=pn.KEEP,this.stencilRefBack=1}assign(t){Object.assign(this,t)}destroy(){}}class W1{constructor(t=!1,e=fn.ONE,i=fn.ZERO,n=gn.ADD,s=fn.ONE,r=fn.ZERO,o=gn.ADD,a=vn.ALL){this.blend=t,this.blendSrc=e,this.blendDst=i,this.blendEq=n,this.blendSrcAlpha=s,this.blendDstAlpha=r,this.blendAlphaEq=o,this.blendColorMask=a}reset(){this.blend=!1,this.blendSrc=fn.ONE,this.blendDst=fn.ZERO,this.blendEq=gn.ADD,this.blendSrcAlpha=fn.ONE,this.blendDstAlpha=fn.ZERO,this.blendAlphaEq=gn.ADD,this.blendColorMask=vn.ALL}assign(t){Object.assign(this,t)}destroy(){}}class q1{get native(){return this}constructor(t=!1,e=!1,i=new Yn,n=[new W1]){this.isA2C=t,this.isIndepend=e,this.blendColor=i,this.targets=n}setTarget(t,e){let i=this.targets[t];i||(i=this.targets[t]=new W1),Object.assign(i,e)}reset(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()}destroy(){}}class X1 extends Vs{get shader(){return this._shader}get pipelineLayout(){return this._pipelineLayout}get primitive(){return this._primitive}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get inputState(){return this._is}get dynamicStates(){return this._dynamicStates}get renderPass(){return this._renderPass}constructor(){super(Xi.PIPELINE_STATE),this._shader=null,this._pipelineLayout=null,this._primitive=Tn.TRIANGLE_LIST,this._is=null,this._rs=new H1,this._dss=new j1,this._bs=new q1,this._dynamicStates=In.NONE,this._renderPass=null}}const Y1=[0,1,3,2,0,0,0,4,5,6,0,0,0,0];class K1 extends X1{constructor(...t){super(...t),this._gpuPipelineState=null}get gpuPipelineState(){return this._gpuPipelineState}initialize(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;const e=this._bs;if(t.blendState){const i=t.blendState,{targets:n}=i;n&&n.forEach(((t,i)=>{e.setTarget(i,t)})),void 0!==i.isA2C&&(e.isA2C=i.isA2C),void 0!==i.isIndepend&&(e.isIndepend=i.isIndepend),void 0!==i.blendColor&&(e.blendColor=i.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;const i=[];for(let t=0;t<31;t++)this._dynamicStates&1<<t&&i.push(1<<t);this._gpuPipelineState={glPrimitive:Y1[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:i}}destroy(){this._gpuPipelineState=null}}class J1 extends z1{beginRenderPass(t,e,i,n,s,r){w1(o1.instance,t.gpuRenderPass,e.gpuFramebuffer,i,n,s,r),this._isInRenderPass=!0}draw(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();const e="drawInfo"in t?t.drawInfo:t;R1(o1.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;const i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}setViewport(t){const{stateCache:e,gl:i}=o1.instance;e.viewport.left===t.left&&e.viewport.top===t.top&&e.viewport.width===t.width&&e.viewport.height===t.height||(i.viewport(t.left,t.top,t.width,t.height),e.viewport.left=t.left,e.viewport.top=t.top,e.viewport.width=t.width,e.viewport.height=t.height)}setScissor(t){const{stateCache:e,gl:i}=o1.instance;e.scissorRect.x===t.x&&e.scissorRect.y===t.y&&e.scissorRect.width===t.width&&e.scissorRect.height===t.height||(i.scissor(t.x,t.y,t.width,t.height),e.scissorRect.x=t.x,e.scissorRect.y=t.y,e.scissorRect.width=t.width,e.scissorRect.height=t.height)}updateBuffer(t,e,i){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{const n=t.gpuBuffer;if(n){let s;s=void 0!==i?i:t.usage&en.INDIRECT?0:e.byteLength,T1(o1.instance,n,e,0,s)}}}copyBuffersToTexture(t,e,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{const n=e.gpuTexture;n&&O1(o1.instance,t,n,i)}}execute(t,e){for(let i=0;i<e;++i){const e=t[i];M1(o1.instance,e.cmdPackage),this._numDrawCalls+=e._numDrawCalls,this._numInstances+=e._numInstances,this._numTris+=e._numTris}}bindStates(){I1(o1.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1}}class $1 extends fr{constructor(...t){super(...t),this.numDrawCalls=0,this.numInstances=0,this.numTris=0}initialize(t){this._type=t.type}destroy(){}submit(t){const e=t.length;for(let i=0;i<e;i++){const e=t[i];this.numDrawCalls+=e.numDrawCalls,this.numInstances+=e.numInstances,this.numTris+=e.numTris}}clear(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}class Z1 extends gr{constructor(...t){super(...t),this._gpuRenderPass=null}get gpuRenderPass(){return this._gpuRenderPass}initialize(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()}destroy(){this._gpuRenderPass=null}}const Q1=[10497,33648,33071,33071];class t2 extends xr{get gpuSampler(){return this._gpuSampler}constructor(t,e){super(t,e),this._gpuSampler=null;let i=0,n=0;const s=this._info.minFilter,r=this._info.magFilter,o=this._info.mipFilter;i=s===un.LINEAR||s===un.ANISOTROPIC?o===un.LINEAR||o===un.ANISOTROPIC?9987:o===un.POINT?9985:9729:o===un.LINEAR||o===un.ANISOTROPIC?9986:o===un.POINT?9984:9728,n=r===un.LINEAR||r===un.ANISOTROPIC?9729:9728;const a=Q1[this._info.addressU],c=Q1[this._info.addressV],l=Q1[this._info.addressW];this._gpuSampler={glMinFilter:i,glMagFilter:n,glWrapS:a,glWrapT:c,glWrapR:l}}}class e2 extends vr{constructor(...t){super(...t),this._gpuShader=null}get gpuShader(){return this._gpuShader}initialize(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(let e=0;e<t.stages.length;++e){const i=t.stages[e];this._gpuShader.gpuStages[e]={type:i.stage,source:i.source,glShader:null}}!function(t,e){const{gl:i}=t;for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];let s=0,r="",o=1;switch(n.type){case yn.VERTEX:r="VertexShader",s=i.VERTEX_SHADER;break;case yn.FRAGMENT:r="FragmentShader",s=i.FRAGMENT_SHADER;break;default:return void console.error("Unsupported ShaderType.")}const a=i.createShader(s);if(a&&(n.glShader=a,i.shaderSource(n.glShader,n.source),i.compileShader(n.glShader),!i.getShaderParameter(n.glShader,i.COMPILE_STATUS))){console.error(`${r} in '${e.name}' compilation failed.`),console.error("Shader source dump:",n.source.replace(/^|\n/g,(()=>`\n${o++} `))),console.error(i.getShaderInfoLog(n.glShader));for(let n=0;n<e.gpuStages.length;n++){const n=e.gpuStages[t];n.glShader&&(i.deleteShader(n.glShader),n.glShader=null)}return}}const n=i.createProgram();if(!n)return;e.glProgram=n;for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];i.attachShader(e.glProgram,n.glShader)}if(i.linkProgram(e.glProgram),t.extensions.destroyShadersImmediately)for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];n.glShader&&(i.detachShader(e.glProgram,n.glShader),i.deleteShader(n.glShader),n.glShader=null)}if(!i.getProgramParameter(e.glProgram,i.LINK_STATUS))return console.error(`Failed to link shader '${e.name}'.`),void console.error(i.getProgramInfoLog(e.glProgram));C(`Shader '${e.name}' compilation succeeded.`);const s=i.getProgramParameter(e.glProgram,i.ACTIVE_ATTRIBUTES);e.glInputs=new Array(s);for(let t=0;t<s;++t){const n=i.getActiveAttrib(e.glProgram,t);if(n){let s;const r=n.name.indexOf("[");s=-1!==r?n.name.substr(0,r):n.name;const o=i.getAttribLocation(e.glProgram,s),a=h1(n.type,i),c=_1(n.type,i);e.glInputs[t]={binding:o,name:s,type:a,stride:c,count:n.size,size:c*n.size,glType:n.type,glLoc:o}}}if(e.blocks.length>0){e.glBlocks=new Array(e.blocks.length);for(let t=0;t<e.blocks.length;++t){const n=e.blocks[t],s={set:n.set,binding:n.binding,name:n.name,size:0,glUniforms:new Array(n.members.length),glActiveUniforms:[]};e.glBlocks[t]=s;for(let t=0;t<n.members.length;++t){const e=n.members[t],r=c1(e.type,i),o=_1(r,i),a=o*e.count;s.glUniforms[t]={binding:-1,name:e.name,type:e.type,stride:o,count:e.count,size:a,offset:0,glType:r,glLoc:null,array:null}}}}for(let t=0;t<e.subpassInputs.length;++t){const i=e.subpassInputs[t];e.samplerTextures.push(new ls(i.set,i.binding,i.name,tn.SAMPLER2D,i.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(let t=0;t<e.samplerTextures.length;++t){const n=e.samplerTextures[t];e.glSamplerTextures[t]={set:n.set,binding:n.binding,name:n.name,type:n.type,count:n.count,units:[],glUnits:null,glType:c1(n.type,i),glLoc:null}}}const r=i.getProgramParameter(e.glProgram,i.ACTIVE_UNIFORMS);for(let n=0;n<r;++n){const s=i.getActiveUniform(e.glProgram,n);if(s&&s.type!==i.SAMPLER_2D&&s.type!==i.SAMPLER_CUBE){const n=i.getUniformLocation(e.glProgram,s.name);if(t.extensions.isLocationActive(n)){let t;const i=s.name.indexOf("[");t=-1!==i?s.name.substr(0,i):s.name;for(let i=0;i<e.glBlocks.length;i++){const r=e.glBlocks[i];for(let e=0;e<r.glUniforms.length;e++){const i=r.glUniforms[e];if(i.name===t){i.glLoc=n,i.count=s.size,i.size=i.stride*i.count,i.array=new(l1(i.type))(i.size/4),r.glActiveUniforms.push(i);break}}}}}}for(let t=0;t<e.glBlocks.length;t++){const i=e.glBlocks[t];for(let t=0;t<i.glUniforms.length;t++){const e=i.glUniforms[t];e.offset=i.size/4,i.size+=e.size}}const o=[],a=[],{bindingMappings:c}=t,{texUnitCacheMap:l}=t.stateCache;let h=0;for(let t=0;t<e.blocks.length;++t)e.blocks[t].set===c.flexibleSet&&h++;let _=0;for(let n=0;n<e.samplerTextures.length;++n){const s=e.samplerTextures[n],r=i.getUniformLocation(e.glProgram,s.name);if(t.extensions.isLocationActive(r)&&(o.push(e.glSamplerTextures[n]),a.push(r)),void 0===l[s.name]){let e=s.binding+c.samplerTextureOffsets[s.set]+_;s.set===c.flexibleSet&&(e-=h),l[s.name]=e%t.capabilities.maxTextureUnits,_+=s.count-1}}if(o.length){const n=[];for(let e=0;e<o.length;++e){const i=o[e];let s=l[i.name];if(void 0!==s){i.glLoc=a[e];for(let e=0;e<i.count;++e){for(;n[s];)s=(s+1)%t.capabilities.maxTextureUnits;i.units.push(s),n[s]=!0}}}let s=0;for(let e=0;e<o.length;++e){const i=o[e];if(!t.extensions.isLocationActive(i.glLoc)){i.glLoc=a[e];for(let e=0;e<i.count;++e){for(;n[s];)s=(s+1)%t.capabilities.maxTextureUnits;void 0===l[i.name]&&(l[i.name]=s),i.units.push(s),n[s]=!0}}}t.stateCache.glProgram!==e.glProgram&&i.useProgram(e.glProgram);for(let t=0;t<o.length;t++){const e=o[t];e.glUnits=new Int32Array(e.units),i.uniform1iv(e.glLoc,e.glUnits)}t.stateCache.glProgram!==e.glProgram&&i.useProgram(t.stateCache.glProgram)}for(let t=0;t<e.glBlocks.length;)e.glBlocks[t].glActiveUniforms.length?t++:(e.glBlocks[t]=e.glBlocks[e.glBlocks.length-1],e.glBlocks.length--);e.glSamplerTextures=o}(o1.instance,this._gpuShader)}destroy(){this._gpuShader&&(function(t,e){if(e.glProgram){const{gl:i}=t;if(!t.extensions.destroyShadersImmediately)for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];n.glShader&&(i.detachShader(e.glProgram,n.glShader),i.deleteShader(n.glShader),n.glShader=null)}i.deleteProgram(e.glProgram),t.stateCache.glProgram===e.glProgram&&(t.gl.useProgram(null),t.stateCache.glProgram=null),e.glProgram=null}}(o1.instance,this._gpuShader),this._gpuShader=null)}}class i2{constructor(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new Xn,this.scissorRect=new Gn(0,0,0,0),this.rs=new H1,this.dss=new j1,this.bs=new q1,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}initialize(t,e){for(let e=0;e<t;++e)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=e,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=e,this.glCurrentAttribLocs.fill(!1)}}class n2 extends yr{constructor(...t){super(...t),this._gpuTexture=null,this._lodLevel=0}get gpuTexture(){return this._gpuTexture}get lodLevel(){return this._lodLevel}initialize(t,e){let i=t;const n=t;"texture"in t&&(i=n.texture.info,this._isTextureView=!0),this._info.copy(i),this._isPowerOf2=js(this._info.width)&&js(this._info.height),this._size=qs(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView?(this._viewInfo.copy(n),this._lodLevel=n.baseLevel,this._gpuTexture=n.texture._gpuTexture):(this._gpuTexture={type:i.type,format:i.format,usage:i.usage,width:i.width,height:i.height,depth:i.depth,size:this._size,arrayLayer:i.layerCount,mipLevel:i.levelCount,samples:i.samples,flags:i.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},function(t,e){const{gl:i}=t;e.glFormat=e.glInternalFmt=function(t,e){switch(t){case Zi.A8:return e.ALPHA;case Zi.L8:return e.LUMINANCE;case Zi.LA8:return e.LUMINANCE_ALPHA;case Zi.RGB8:case Zi.RGB16F:case Zi.RGB32F:return e.RGB;case Zi.BGRA8:case Zi.RGBA8:case Zi.SRGB8_A8:case Zi.RGBA16F:case Zi.RGBA32F:return e.RGBA;case Zi.R5G6B5:return e.RGB;case Zi.RGB5A1:case Zi.RGBA4:return e.RGBA;case Zi.DEPTH:return e.DEPTH_COMPONENT;case Zi.DEPTH_STENCIL:return e.DEPTH_STENCIL;case Zi.BC1:return r1.COMPRESSED_RGB_S3TC_DXT1_EXT;case Zi.BC1_ALPHA:return r1.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Zi.BC1_SRGB:return r1.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Zi.BC1_SRGB_ALPHA:return r1.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Zi.BC2:return r1.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Zi.BC2_SRGB:return r1.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Zi.BC3:return r1.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Zi.BC3_SRGB:return r1.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Zi.ETC_RGB8:return r1.COMPRESSED_RGB_ETC1_WEBGL;case Zi.ETC2_RGB8:return r1.COMPRESSED_RGB8_ETC2;case Zi.ETC2_SRGB8:return r1.COMPRESSED_SRGB8_ETC2;case Zi.ETC2_RGB8_A1:return r1.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Zi.ETC2_SRGB8_A1:return r1.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Zi.ETC2_RGBA8:return r1.COMPRESSED_RGBA8_ETC2_EAC;case Zi.ETC2_SRGB8_A8:return r1.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Zi.EAC_R11:return r1.COMPRESSED_R11_EAC;case Zi.EAC_R11SN:return r1.COMPRESSED_SIGNED_R11_EAC;case Zi.EAC_RG11:return r1.COMPRESSED_RG11_EAC;case Zi.EAC_RG11SN:return r1.COMPRESSED_SIGNED_RG11_EAC;case Zi.PVRTC_RGB2:return r1.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Zi.PVRTC_RGBA2:return r1.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Zi.PVRTC_RGB4:return r1.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Zi.PVRTC_RGBA4:return r1.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Zi.ASTC_RGBA_4X4:return r1.COMPRESSED_RGBA_ASTC_4x4_KHR;case Zi.ASTC_RGBA_5X4:return r1.COMPRESSED_RGBA_ASTC_5x4_KHR;case Zi.ASTC_RGBA_5X5:return r1.COMPRESSED_RGBA_ASTC_5x5_KHR;case Zi.ASTC_RGBA_6X5:return r1.COMPRESSED_RGBA_ASTC_6x5_KHR;case Zi.ASTC_RGBA_6X6:return r1.COMPRESSED_RGBA_ASTC_6x6_KHR;case Zi.ASTC_RGBA_8X5:return r1.COMPRESSED_RGBA_ASTC_8x5_KHR;case Zi.ASTC_RGBA_8X6:return r1.COMPRESSED_RGBA_ASTC_8x6_KHR;case Zi.ASTC_RGBA_8X8:return r1.COMPRESSED_RGBA_ASTC_8x8_KHR;case Zi.ASTC_RGBA_10X5:return r1.COMPRESSED_RGBA_ASTC_10x5_KHR;case Zi.ASTC_RGBA_10X6:return r1.COMPRESSED_RGBA_ASTC_10x6_KHR;case Zi.ASTC_RGBA_10X8:return r1.COMPRESSED_RGBA_ASTC_10x8_KHR;case Zi.ASTC_RGBA_10X10:return r1.COMPRESSED_RGBA_ASTC_10x10_KHR;case Zi.ASTC_RGBA_12X10:return r1.COMPRESSED_RGBA_ASTC_12x10_KHR;case Zi.ASTC_RGBA_12X12:return r1.COMPRESSED_RGBA_ASTC_12x12_KHR;case Zi.ASTC_SRGBA_4X4:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Zi.ASTC_SRGBA_5X4:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Zi.ASTC_SRGBA_5X5:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Zi.ASTC_SRGBA_6X5:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Zi.ASTC_SRGBA_6X6:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Zi.ASTC_SRGBA_8X5:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Zi.ASTC_SRGBA_8X6:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Zi.ASTC_SRGBA_8X8:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Zi.ASTC_SRGBA_10X5:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Zi.ASTC_SRGBA_10X6:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Zi.ASTC_SRGBA_10X8:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Zi.ASTC_SRGBA_10X10:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Zi.ASTC_SRGBA_12X10:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Zi.ASTC_SRGBA_12X12:return r1.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}(e.format,i),e.glType=a1(e.format,i);let n=e.width,s=e.height;switch(e.type){case on.TEX2D:{if(e.glTarget=i.TEXTURE_2D,e.isSwapchainTexture)break;const r=Math.max(n,s);if(r>t.capabilities.maxTextureSize&&D(9100,r,t.capabilities.maxTextureSize),t.textureExclusive[e.format]||t.extensions.WEBGL_depth_texture||!Gs[e.format].hasDepth){if(e.glTexture=i.createTexture(),e.size>0){const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_2D,e.glTexture),r.glTexture=e.glTexture),Gs[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const r=Ws(e.format,n,s,1),o=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,o),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else for(let t=0;t<e.mipLevel;++t)i.texImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1);e.isPowerOf2?(e.glWrapS=i.REPEAT,e.glWrapT=i.REPEAT):(e.glWrapS=i.CLAMP_TO_EDGE,e.glWrapT=i.CLAMP_TO_EDGE),e.glMinFilter=i.LINEAR,e.glMagFilter=i.LINEAR,i.texParameteri(e.glTarget,i.TEXTURE_WRAP_S,e.glWrapS),i.texParameteri(e.glTarget,i.TEXTURE_WRAP_T,e.glWrapT),i.texParameteri(e.glTarget,i.TEXTURE_MIN_FILTER,e.glMinFilter),i.texParameteri(e.glTarget,i.TEXTURE_MAG_FILTER,e.glMagFilter)}}else e.glInternalFmt=function(t,e){switch(t){case Zi.R5G6B5:return e.RGB565;case Zi.RGB5A1:return e.RGB5_A1;case Zi.RGBA4:return e.RGBA4;case Zi.RGBA16F:return r1.RGBA16F_EXT;case Zi.RGBA32F:return r1.RGBA32F_EXT;case Zi.SRGB8_A8:return r1.SRGB8_ALPHA8_EXT;case Zi.DEPTH:return e.DEPTH_COMPONENT16;case Zi.DEPTH_STENCIL:return e.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,i),e.glRenderbuffer=i.createRenderbuffer(),e.size>0&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,e.glInternalFmt,n,s));break}case on.CUBE:{e.glTarget=i.TEXTURE_CUBE_MAP;const r=Math.max(n,s);if(r>t.capabilities.maxCubeMapTextureSize&&D(9100,r,t.capabilities.maxTextureSize),e.glTexture=i.createTexture(),e.size>0){const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,e.glTexture),r.glTexture=e.glTexture),Gs[e.format].isCompressed)for(let t=0;t<6;++t){n=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r){const o=Ws(e.format,n,s,1),a=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else for(let t=0;t<6;++t){n=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,n,s,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}e.isPowerOf2?(e.glWrapS=i.REPEAT,e.glWrapT=i.REPEAT):(e.glWrapS=i.CLAMP_TO_EDGE,e.glWrapT=i.CLAMP_TO_EDGE),e.glMinFilter=i.LINEAR,e.glMagFilter=i.LINEAR,i.texParameteri(e.glTarget,i.TEXTURE_WRAP_S,e.glWrapS),i.texParameteri(e.glTarget,i.TEXTURE_WRAP_T,e.glWrapT),i.texParameteri(e.glTarget,i.TEXTURE_MIN_FILTER,e.glMinFilter),i.texParameteri(e.glTarget,i.TEXTURE_MAG_FILTER,e.glMagFilter)}break}default:console.error("Unsupported TextureType, create texture failed."),e.type=on.TEX2D,e.glTarget=i.TEXTURE_2D}}(o1.instance,this._gpuTexture),o1.instance.memoryStatus.textureSize+=this._size,this._viewInfo.texture=this,this._viewInfo.type=t.type,this._viewInfo.format=t.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=t.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=t.layerCount)}destroy(){!this._isTextureView&&this._gpuTexture&&(function(t,e){const{gl:i}=t;if(e.glTexture){const n=t.stateCache.glTexUnits;let s=t.stateCache.texUnit;i.deleteTexture(e.glTexture);for(let t=0;t<n.length;t++)n[t].glTexture===e.glTexture&&(i.activeTexture(i.TEXTURE0+t),s=t,i.bindTexture(e.glTarget,null),n[t].glTexture=null);t.stateCache.texUnit=s,e.glTexture=null}if(e.glRenderbuffer){let n=t.stateCache.glRenderbuffer;i.deleteRenderbuffer(e.glRenderbuffer),n===e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,null),n=null),e.glRenderbuffer=null}}(o1.instance,this._gpuTexture),o1.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)}resize(t,e){if(this._info.width===t&&this._info.height===e)return;this._info.levelCount===n2.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=n2.getLevelCount(t,e):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,n2.getLevelCount(t,e)));const i=this._size;this._info.width=t,this._info.height=e,this._size=qs(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){if(!e.size)return;const{gl:i}=t;let n=e.width,s=e.height;switch(e.type){case on.TEX2D:{e.glTarget=i.TEXTURE_2D;const r=Math.max(n,s);if(r>t.capabilities.maxTextureSize&&D(9100,r,t.capabilities.maxTextureSize),e.glRenderbuffer)t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,e.glInternalFmt,n,s);else if(e.glTexture){const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_2D,e.glTexture),r.glTexture=e.glTexture),Gs[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const r=Ws(e.format,n,s,1),o=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,o),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else for(let t=0;t<e.mipLevel;++t)i.texImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}break}case on.CUBE:{e.glTarget=i.TEXTURE_CUBE_MAP;const r=Math.max(n,s);r>t.capabilities.maxCubeMapTextureSize&&D(9100,r,t.capabilities.maxTextureSize);const o=t.stateCache.glTexUnits[t.stateCache.texUnit];if(o.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,e.glTexture),o.glTexture=e.glTexture),Gs[e.format].isCompressed)for(let t=0;t<6;++t){n=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r){const o=Ws(e.format,n,s,1),a=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else for(let t=0;t<6;++t){n=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,n,s,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}break}default:console.error("Unsupported TextureType, create texture failed."),e.type=on.TEX2D,e.glTarget=i.TEXTURE_2D}}(o1.instance,this._gpuTexture),o1.instance.memoryStatus.textureSize-=i,o1.instance.memoryStatus.textureSize+=this._size)}initAsSwapchainTexture(t){const e=new ss;e.format=t.format,e.usage=Gs[t.format].hasDepth?an.DEPTH_STENCIL_ATTACHMENT:an.COLOR_ATTACHMENT,e.width=t.width,e.height=t.height,this.initialize(e,!0)}}const s2="webglcontextlost";function r2(t,e){const i=["","WEBKIT_","MOZ_"];for(let n=0;n<i.length;++n){const s=t.getExtension(i[n]+e);if(s)return s}return null}function o2(t){const e={EXT_texture_filter_anisotropic:r2(t,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:r2(t,"EXT_blend_minmax"),EXT_frag_depth:r2(t,"EXT_frag_depth"),EXT_shader_texture_lod:r2(t,"EXT_shader_texture_lod"),EXT_sRGB:r2(t,"EXT_sRGB"),OES_vertex_array_object:r2(t,"OES_vertex_array_object"),EXT_color_buffer_half_float:r2(t,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:r2(t,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:r2(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:r2(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:r2(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:r2(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:r2(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:r2(t,"WEBGL_debug_shaders"),WEBGL_draw_buffers:r2(t,"WEBGL_draw_buffers"),WEBGL_lose_context:r2(t,"WEBGL_lose_context"),WEBGL_depth_texture:r2(t,"WEBGL_depth_texture"),OES_texture_half_float:r2(t,"OES_texture_half_float"),OES_texture_half_float_linear:r2(t,"OES_texture_half_float_linear"),OES_texture_float:r2(t,"OES_texture_float"),OES_texture_float_linear:r2(t,"OES_texture_float_linear"),OES_standard_derivatives:r2(t,"OES_standard_derivatives"),OES_element_index_uint:r2(t,"OES_element_index_uint"),ANGLE_instanced_arrays:r2(t,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:r2(t,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:t=>!!t,useVAO:!1};return Zl.os===Xl.IOS&&14===Zl.osMainVersion&&Zl.isBrowser||(e.WEBGL_compressed_texture_astc=r2(t,"WEBGL_compressed_texture_astc")),Zl.os!==Xl.ANDROID&&Zl.os!==Xl.IOS&&(e.WEBGL_multi_draw=r2(t,"WEBGL_multi_draw")),Zl.browserType===jl.UC&&(e.ANGLE_instanced_arrays=null),Zl.os===Xl.IOS&&Zl.osMainVersion<=10&&(e.destroyShadersImmediately=!1),e.OES_vertex_array_object&&(e.useVAO=!0),e}class a2 extends cr{constructor(...t){super(...t),this.stateCache=new i2,this.cmdAllocator=new F1,this.nullTex2D=null,this.nullTexCube=null,this._canvas=null,this._webGLContextLostHandler=null,this._extensions=null}get extensions(){return this._extensions}initialize(t){this._canvas=t.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(s2,this._onWebGLContextLost);const e=o1.instance.gl;this.stateCache.initialize(o1.instance.capabilities.maxTextureUnits,o1.instance.capabilities.maxVertexAttributes),this._extensions=o2(e),function(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.depthRange(0,1),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}(e);const i=Zi.RGBA8;let n=Zi.DEPTH_STENCIL,s=e.getParameter(e.DEPTH_BITS);const r=e.getParameter(e.STENCIL_BITS);s&&r?n=Zi.DEPTH_STENCIL:s&&(n=Zi.DEPTH),this._colorTexture=new n2,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this._depthStencilTexture=new n2,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:n,width:t.width,height:t.height}),this.nullTex2D=o1.instance.createTexture(new ss(on.TEX2D,an.SAMPLED,Zi.RGBA8,2,2,cn.GEN_MIPMAP)),this.nullTexCube=o1.instance.createTexture(new ss(on.CUBE,an.SAMPLED,Zi.RGBA8,2,2,cn.GEN_MIPMAP,6));const o=new qn;o.texExtent.width=2,o.texExtent.height=2;const a=new Uint8Array(this.nullTex2D.size);a.fill(0),o1.instance.copyBuffersToTexture([a],this.nullTex2D,[o]),o.texSubres.layerCount=6,o1.instance.copyBuffersToTexture([a,a,a,a,a,a],this.nullTexCube,[o])}destroy(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(s2,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null}resize(t,e,i){this._colorTexture.width===t&&this._colorTexture.height===e||(C(`Resizing swapchain: ${t}x${e}`),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))}_onWebGLContextLost(t){I(11e3),y(t)}}class c2 extends ar{constructor(...t){super(...t),this._swapchain=null,this._context=null,this._bindingMappings=null,this._textureExclusive=new Array(Zi.COUNT)}get gl(){return this._context}get extensions(){return this._swapchain.extensions}get stateCache(){return this._swapchain.stateCache}get nullTex2D(){return this._swapchain.nullTex2D}get nullTexCube(){return this._swapchain.nullTexCube}get textureExclusive(){return this._textureExclusive}get bindingMappings(){return this._bindingMappings}initialize(t){o1.setInstance(this),this._gfxAPI=Ki.WEBGL;const e=this._bindingMappingInfo=t.bindingMappingInfo,i=[],n=[],s=e.setIndices[0];i[s]=0,n[s]=0;for(let t=1;t<e.setIndices.length;++t){const s=e.setIndices[t],r=e.setIndices[t-1];i[s]=e.maxBlockCounts[r]+i[r],n[s]=e.maxSamplerTextureCounts[r]+n[r]}for(let t=0;t<e.setIndices.length;++t){const i=e.setIndices[t];n[i]-=e.maxBlockCounts[i]}this._bindingMappings={blockOffsets:i,samplerTextureOffsets:n,flexibleSet:e.setIndices[e.setIndices.length-1]};const r=this._context=function(t){let e=null;try{const i={alpha:Kt.ENABLE_TRANSPARENT_CANVAS,antialias:Kt.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl",i)}catch(t){return null}return e}(ar.canvas);if(!r)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Os(Mn.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Ms(this._queue)),this._caps.maxVertexAttributes=r.getParameter(r.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=r.getParameter(r.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=r.getParameter(r.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=r.getParameter(r.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;const o=r.getSupportedExtensions();let a="";if(o)for(const t of o)a+=`${t} `;const c=o2(r);c.WEBGL_debug_renderer_info?(this._renderer=r.getParameter(c.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=r.getParameter(c.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=r.getParameter(r.RENDERER),this._vendor=r.getParameter(r.VENDOR));const l=r.getParameter(r.VERSION);this._features.fill(!1),this.initFormatFeatures(c),c.EXT_blend_minmax&&(this._features[$i.BLEND_MINMAX]=!0),c.OES_element_index_uint&&(this._features[$i.ELEMENT_INDEX_UINT]=!0),c.ANGLE_instanced_arrays&&(this._features[$i.INSTANCED_ARRAYS]=!0),c.WEBGL_draw_buffers&&(this._features[$i.MULTIPLE_RENDER_TARGETS]=!0);let h="";return this.getFormatFeatures(Zi.ETC_RGB8)&&(h+="etc1 "),this.getFormatFeatures(Zi.ETC2_RGB8)&&(h+="etc2 "),this.getFormatFeatures(Zi.BC1)&&(h+="dxt "),this.getFormatFeatures(Zi.PVRTC_RGB2)&&(h+="pvrtc "),this.getFormatFeatures(Zi.ASTC_RGBA_4X4)&&(h+="astc "),C("WebGL device initialized."),C(`RENDERER: ${this._renderer}`),C(`VENDOR: ${this._vendor}`),C(`VERSION: ${l}`),C(`COMPRESSED_FORMAT: ${h}`),C(`EXTENSIONS: ${a}`),!0}destroy(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}flushCommands(t){}acquire(t){}present(){const t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()}initFormatFeatures(t){this._formatFeatures.fill(ln.NONE),this._textureExclusive.fill(!0);const e=ln.RENDER_TARGET|ln.SAMPLED_TEXTURE|ln.LINEAR_FILTER;this._formatFeatures[Zi.RGB8]=e,this._formatFeatures[Zi.R5G6B5]=e,this._textureExclusive[Zi.R5G6B5]=!1,this._formatFeatures[Zi.RGBA8]=e,this._formatFeatures[Zi.RGBA4]=e,this._textureExclusive[Zi.RGBA4]=!1,this._formatFeatures[Zi.RGB5A1]=e,this._textureExclusive[Zi.RGB5A1]=!1,this._formatFeatures[Zi.DEPTH]=ln.RENDER_TARGET,this._textureExclusive[Zi.DEPTH]=!1,this._formatFeatures[Zi.DEPTH_STENCIL]=ln.RENDER_TARGET,this._textureExclusive[Zi.DEPTH_STENCIL]=!1,this._formatFeatures[Zi.R8I]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RG8I]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RGB8I]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RGBA8I]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.R8UI]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RG8UI]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RGB8UI]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RGBA8UI]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.R8I]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RG8I]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RGB8I]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RGBA8I]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.R8UI]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RG8UI]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RGB8UI]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RGBA8UI]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.R32F]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RG32F]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RGB32F]|=ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.RGBA32F]|=ln.VERTEX_ATTRIBUTE,t.EXT_sRGB&&(this._formatFeatures[Zi.SRGB8]=e,this._formatFeatures[Zi.SRGB8_A8]=e,this._textureExclusive[Zi.SRGB8_A8]=!1),t.WEBGL_depth_texture&&(this._formatFeatures[Zi.DEPTH]|=e,this._formatFeatures[Zi.DEPTH_STENCIL]|=e),t.WEBGL_color_buffer_float&&(this._formatFeatures[Zi.RGB32F]|=ln.RENDER_TARGET,this._formatFeatures[Zi.RGBA32F]|=ln.RENDER_TARGET,this._textureExclusive[Zi.RGB32F]=!1,this._textureExclusive[Zi.RGBA32F]=!1),t.EXT_color_buffer_half_float&&(this._formatFeatures[Zi.RGB16F]|=ln.RENDER_TARGET,this._formatFeatures[Zi.RGBA16F]|=ln.RENDER_TARGET,this._textureExclusive[Zi.RGB16F]=!1,this._textureExclusive[Zi.RGBA16F]=!1),t.OES_texture_float&&(this._formatFeatures[Zi.RGB32F]|=ln.RENDER_TARGET|ln.SAMPLED_TEXTURE,this._formatFeatures[Zi.RGBA32F]|=ln.RENDER_TARGET|ln.SAMPLED_TEXTURE),t.OES_texture_half_float&&(this._formatFeatures[Zi.RGB16F]|=ln.RENDER_TARGET|ln.SAMPLED_TEXTURE,this._formatFeatures[Zi.RGBA16F]|=ln.RENDER_TARGET|ln.SAMPLED_TEXTURE),t.OES_texture_float_linear&&(this._formatFeatures[Zi.RGB32F]|=ln.LINEAR_FILTER,this._formatFeatures[Zi.RGBA32F]|=ln.LINEAR_FILTER),t.OES_texture_half_float_linear&&(this._formatFeatures[Zi.RGB16F]|=ln.LINEAR_FILTER,this._formatFeatures[Zi.RGBA16F]|=ln.LINEAR_FILTER);const i=ln.SAMPLED_TEXTURE|ln.LINEAR_FILTER;t.WEBGL_compressed_texture_etc1&&(this._formatFeatures[Zi.ETC_RGB8]=i),t.WEBGL_compressed_texture_etc&&(this._formatFeatures[Zi.ETC2_RGB8]=i,this._formatFeatures[Zi.ETC2_RGBA8]=i,this._formatFeatures[Zi.ETC2_SRGB8]=i,this._formatFeatures[Zi.ETC2_SRGB8_A8]=i,this._formatFeatures[Zi.ETC2_RGB8_A1]=i,this._formatFeatures[Zi.ETC2_SRGB8_A1]=i),t.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[Zi.BC1]=i,this._formatFeatures[Zi.BC1_ALPHA]=i,this._formatFeatures[Zi.BC1_SRGB]=i,this._formatFeatures[Zi.BC1_SRGB_ALPHA]=i,this._formatFeatures[Zi.BC2]=i,this._formatFeatures[Zi.BC2_SRGB]=i,this._formatFeatures[Zi.BC3]=i,this._formatFeatures[Zi.BC3_SRGB]=i),t.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[Zi.PVRTC_RGB2]|=i,this._formatFeatures[Zi.PVRTC_RGBA2]|=i,this._formatFeatures[Zi.PVRTC_RGB4]|=i,this._formatFeatures[Zi.PVRTC_RGBA4]|=i),t.WEBGL_compressed_texture_astc&&(this._formatFeatures[Zi.ASTC_RGBA_4X4]|=i,this._formatFeatures[Zi.ASTC_RGBA_5X4]|=i,this._formatFeatures[Zi.ASTC_RGBA_5X5]|=i,this._formatFeatures[Zi.ASTC_RGBA_6X5]|=i,this._formatFeatures[Zi.ASTC_RGBA_6X6]|=i,this._formatFeatures[Zi.ASTC_RGBA_8X5]|=i,this._formatFeatures[Zi.ASTC_RGBA_8X6]|=i,this._formatFeatures[Zi.ASTC_RGBA_8X8]|=i,this._formatFeatures[Zi.ASTC_RGBA_10X5]|=i,this._formatFeatures[Zi.ASTC_RGBA_10X6]|=i,this._formatFeatures[Zi.ASTC_RGBA_10X8]|=i,this._formatFeatures[Zi.ASTC_RGBA_10X10]|=i,this._formatFeatures[Zi.ASTC_RGBA_12X10]|=i,this._formatFeatures[Zi.ASTC_RGBA_12X12]|=i,this._formatFeatures[Zi.ASTC_SRGBA_4X4]|=i,this._formatFeatures[Zi.ASTC_SRGBA_5X4]|=i,this._formatFeatures[Zi.ASTC_SRGBA_5X5]|=i,this._formatFeatures[Zi.ASTC_SRGBA_6X5]|=i,this._formatFeatures[Zi.ASTC_SRGBA_6X6]|=i,this._formatFeatures[Zi.ASTC_SRGBA_8X5]|=i,this._formatFeatures[Zi.ASTC_SRGBA_8X6]|=i,this._formatFeatures[Zi.ASTC_SRGBA_8X8]|=i,this._formatFeatures[Zi.ASTC_SRGBA_10X5]|=i,this._formatFeatures[Zi.ASTC_SRGBA_10X6]|=i,this._formatFeatures[Zi.ASTC_SRGBA_10X8]|=i,this._formatFeatures[Zi.ASTC_SRGBA_10X10]|=i,this._formatFeatures[Zi.ASTC_SRGBA_12X10]|=i,this._formatFeatures[Zi.ASTC_SRGBA_12X12]|=i)}createCommandBuffer(t){const e=new(t.type===Bn.PRIMARY?J1:z1);return e.initialize(t),e}createSwapchain(t){const e=new a2;return this._swapchain=e,e.initialize(t),e}createBuffer(t){const e=new N1;return e.initialize(t),e}createTexture(t){const e=new n2;return e.initialize(t),e}createDescriptorSet(t){const e=new s1;return e.initialize(t),e}createShader(t){const e=new e2;return e.initialize(t),e}createInputAssembler(t){const e=new G1;return e.initialize(t),e}createRenderPass(t){const e=new Z1;return e.initialize(t),e}createFramebuffer(t){const e=new V1;return e.initialize(t),e}createDescriptorSetLayout(t){const e=new U1;return e.initialize(t),e}createPipelineLayout(t){const e=new k1;return e.initialize(t),e}createPipelineState(t){const e=new K1;return e.initialize(t),e}createQueue(t){const e=new $1;return e.initialize(t),e}getSampler(t){const e=xr.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new t2(t,e)),this._samplers.get(e)}getGeneralBarrier(t){const e=Sr.computeHash(t);return this._generalBarrierss.has(e)||this._generalBarrierss.set(e,new Sr(t,e)),this._generalBarrierss.get(e)}getTextureBarrier(t){const e=Cr.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new Cr(t,e)),this._textureBarriers.get(e)}copyBuffersToTexture(t,e,i){O1(this,t,e.gpuTexture,i)}copyTextureToBuffers(t,e,i){!function(t,e,i,n){const{gl:s}=t,r=t.stateCache,o=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,o);let a=0,c=0,l=1,h=1;switch(e.glTarget){case s.TEXTURE_2D:for(let t=0;t<n.length;t++){const r=n[t];s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,r.texSubres.mipLevel),a=r.texOffset.x,c=r.texOffset.y,l=r.texExtent.width,h=r.texExtent.height,s.readPixels(a,c,l,h,e.glFormat,e.glType,i[t])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}s.bindFramebuffer(s.FRAMEBUFFER,null),r.glFramebuffer=null,s.deleteFramebuffer(o)}(this,t.gpuTexture,e,i)}copyTexImagesToTexture(t,e,i){!function(t,e,i,n){const{gl:s}=t,r=t.stateCache.glTexUnits[t.stateCache.texUnit];r.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),r.glTexture=i.glTexture);let o=0,a=0;switch(i.glTarget){case s.TEXTURE_2D:for(let t=0;t<n.length;t++){const r=n[t];s.texSubImage2D(s.TEXTURE_2D,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,i.glFormat,i.glType,e[o++])}break;case s.TEXTURE_CUBE_MAP:for(let t=0;t<n.length;t++){const r=n[t],c=r.texSubres.baseArrayLayer+r.texSubres.layerCount;for(a=r.texSubres.baseArrayLayer;a<c;++a)s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,i.glFormat,i.glType,e[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&cn.GEN_MIPMAP&&i.isPowerOf2&&s.generateMipmap(i.glTarget)}(this,t,e.gpuTexture,i)}}t("WebGLDevice",c2),l.WebGLDevice=c2;class l2 extends sr{constructor(...t){super(...t),this._gpuDescriptorSet=null}get gpuDescriptorSet(){return this._gpuDescriptorSet}initialize(t){this._layout=t.layout;const{bindings:e,descriptorIndices:i,descriptorCount:n}=t.layout.gpuDescriptorSetLayout;this._buffers=Array(n).fill(null),this._textures=Array(n).fill(null),this._samplers=Array(n).fill(null);const s=[];this._gpuDescriptorSet={gpuDescriptors:s,descriptorIndices:i};for(let t=0;t<e.length;++t){const i=e[t];for(let t=0;t<i.count;t++)s.push({type:i.descriptorType,gpuBuffer:null,gpuTextureView:null,gpuSampler:null})}}destroy(){this._layout=null,this._gpuDescriptorSet=null}update(){if(this._isDirty&&this._gpuDescriptorSet){const t=this._gpuDescriptorSet.gpuDescriptors;for(let e=0;e<t.length;++e)t[e].type&Us?this._buffers[e]&&(t[e].gpuBuffer=this._buffers[e].gpuBuffer):t[e].type&ks&&(this._textures[e]&&(t[e].gpuTextureView=this._textures[e].gpuTextureView),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}}}let h2;!function(t){t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(h2||(h2={}));class _2{static get instance(){return _2._instance}static setInstance(t){_2._instance=t}}_2._instance=null;const u2=[10497,33648,33071,33071],d2=new Float32Array(4);function m2(t,e){switch(t){case Zi.R8:return e.UNSIGNED_BYTE;case Zi.R8SN:return e.BYTE;case Zi.R8UI:return e.UNSIGNED_BYTE;case Zi.R8I:return e.BYTE;case Zi.R16F:return e.HALF_FLOAT;case Zi.R16UI:return e.UNSIGNED_SHORT;case Zi.R16I:return e.SHORT;case Zi.R32F:return e.FLOAT;case Zi.R32UI:return e.UNSIGNED_INT;case Zi.R32I:return e.INT;case Zi.RG8:return e.UNSIGNED_BYTE;case Zi.RG8SN:return e.BYTE;case Zi.RG8UI:return e.UNSIGNED_BYTE;case Zi.RG8I:return e.BYTE;case Zi.RG16F:return e.HALF_FLOAT;case Zi.RG16UI:return e.UNSIGNED_SHORT;case Zi.RG16I:return e.SHORT;case Zi.RG32F:return e.FLOAT;case Zi.RG32UI:return e.UNSIGNED_INT;case Zi.RG32I:return e.INT;case Zi.RGB8:case Zi.SRGB8:return e.UNSIGNED_BYTE;case Zi.RGB8SN:return e.BYTE;case Zi.RGB8UI:return e.UNSIGNED_BYTE;case Zi.RGB8I:return e.BYTE;case Zi.RGB16F:return e.HALF_FLOAT;case Zi.RGB16UI:return e.UNSIGNED_SHORT;case Zi.RGB16I:return e.SHORT;case Zi.RGB32F:return e.FLOAT;case Zi.RGB32UI:return e.UNSIGNED_INT;case Zi.RGB32I:return e.INT;case Zi.BGRA8:case Zi.RGBA8:case Zi.SRGB8_A8:return e.UNSIGNED_BYTE;case Zi.RGBA8SN:return e.BYTE;case Zi.RGBA8UI:return e.UNSIGNED_BYTE;case Zi.RGBA8I:return e.BYTE;case Zi.RGBA16F:return e.HALF_FLOAT;case Zi.RGBA16UI:return e.UNSIGNED_SHORT;case Zi.RGBA16I:return e.SHORT;case Zi.RGBA32F:return e.FLOAT;case Zi.RGBA32UI:return e.UNSIGNED_INT;case Zi.RGBA32I:return e.INT;case Zi.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case Zi.R11G11B10F:return e.UNSIGNED_INT_10F_11F_11F_REV;case Zi.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case Zi.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case Zi.RGB10A2:case Zi.RGB10A2UI:return e.UNSIGNED_INT_2_10_10_10_REV;case Zi.RGB9E5:case Zi.DEPTH:return e.FLOAT;case Zi.DEPTH_STENCIL:return e.UNSIGNED_INT_24_8;case Zi.BC1:case Zi.BC1_SRGB:case Zi.BC2:case Zi.BC2_SRGB:case Zi.BC3:case Zi.BC3_SRGB:case Zi.BC4:return e.UNSIGNED_BYTE;case Zi.BC4_SNORM:return e.BYTE;case Zi.BC5:return e.UNSIGNED_BYTE;case Zi.BC5_SNORM:return e.BYTE;case Zi.BC6H_SF16:case Zi.BC6H_UF16:return e.FLOAT;case Zi.BC7:case Zi.BC7_SRGB:case Zi.ETC_RGB8:case Zi.ETC2_RGB8:case Zi.ETC2_SRGB8:case Zi.ETC2_RGB8_A1:case Zi.ETC2_SRGB8_A1:case Zi.EAC_R11:return e.UNSIGNED_BYTE;case Zi.EAC_R11SN:return e.BYTE;case Zi.EAC_RG11:return e.UNSIGNED_BYTE;case Zi.EAC_RG11SN:return e.BYTE;case Zi.PVRTC_RGB2:case Zi.PVRTC_RGBA2:case Zi.PVRTC_RGB4:case Zi.PVRTC_RGBA4:case Zi.PVRTC2_2BPP:case Zi.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case Zi.ASTC_RGBA_4X4:case Zi.ASTC_RGBA_5X4:case Zi.ASTC_RGBA_5X5:case Zi.ASTC_RGBA_6X5:case Zi.ASTC_RGBA_6X6:case Zi.ASTC_RGBA_8X5:case Zi.ASTC_RGBA_8X6:case Zi.ASTC_RGBA_8X8:case Zi.ASTC_RGBA_10X5:case Zi.ASTC_RGBA_10X6:case Zi.ASTC_RGBA_10X8:case Zi.ASTC_RGBA_10X10:case Zi.ASTC_RGBA_12X10:case Zi.ASTC_RGBA_12X12:case Zi.ASTC_SRGBA_4X4:case Zi.ASTC_SRGBA_5X4:case Zi.ASTC_SRGBA_5X5:case Zi.ASTC_SRGBA_6X5:case Zi.ASTC_SRGBA_6X6:case Zi.ASTC_SRGBA_8X5:case Zi.ASTC_SRGBA_8X6:case Zi.ASTC_SRGBA_8X8:case Zi.ASTC_SRGBA_10X5:case Zi.ASTC_SRGBA_10X6:case Zi.ASTC_SRGBA_10X8:case Zi.ASTC_SRGBA_10X10:case Zi.ASTC_SRGBA_12X10:case Zi.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function p2(t,e){switch(t){case tn.BOOL:return e.BOOL;case tn.BOOL2:return e.BOOL_VEC2;case tn.BOOL3:return e.BOOL_VEC3;case tn.BOOL4:return e.BOOL_VEC4;case tn.INT:return e.INT;case tn.INT2:return e.INT_VEC2;case tn.INT3:return e.INT_VEC3;case tn.INT4:return e.INT_VEC4;case tn.UINT:return e.UNSIGNED_INT;case tn.FLOAT:return e.FLOAT;case tn.FLOAT2:return e.FLOAT_VEC2;case tn.FLOAT3:return e.FLOAT_VEC3;case tn.FLOAT4:return e.FLOAT_VEC4;case tn.MAT2:return e.FLOAT_MAT2;case tn.MAT2X3:return e.FLOAT_MAT2x3;case tn.MAT2X4:return e.FLOAT_MAT2x4;case tn.MAT3X2:return e.FLOAT_MAT3x2;case tn.MAT3:return e.FLOAT_MAT3;case tn.MAT3X4:return e.FLOAT_MAT3x4;case tn.MAT4X2:return e.FLOAT_MAT4x2;case tn.MAT4X3:return e.FLOAT_MAT4x3;case tn.MAT4:return e.FLOAT_MAT4;case tn.SAMPLER2D:return e.SAMPLER_2D;case tn.SAMPLER2D_ARRAY:return e.SAMPLER_2D_ARRAY;case tn.SAMPLER3D:return e.SAMPLER_3D;case tn.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),tn.UNKNOWN}}function f2(t,e){switch(t){case e.BOOL:return tn.BOOL;case e.BOOL_VEC2:return tn.BOOL2;case e.BOOL_VEC3:return tn.BOOL3;case e.BOOL_VEC4:return tn.BOOL4;case e.INT:return tn.INT;case e.INT_VEC2:return tn.INT2;case e.INT_VEC3:return tn.INT3;case e.INT_VEC4:return tn.INT4;case e.UNSIGNED_INT:return tn.UINT;case e.UNSIGNED_INT_VEC2:return tn.UINT2;case e.UNSIGNED_INT_VEC3:return tn.UINT3;case e.UNSIGNED_INT_VEC4:return tn.UINT4;case e.FLOAT:return tn.FLOAT;case e.FLOAT_VEC2:return tn.FLOAT2;case e.FLOAT_VEC3:return tn.FLOAT3;case e.FLOAT_VEC4:return tn.FLOAT4;case e.FLOAT_MAT2:return tn.MAT2;case e.FLOAT_MAT2x3:return tn.MAT2X3;case e.FLOAT_MAT2x4:return tn.MAT2X4;case e.FLOAT_MAT3x2:return tn.MAT3X2;case e.FLOAT_MAT3:return tn.MAT3;case e.FLOAT_MAT3x4:return tn.MAT3X4;case e.FLOAT_MAT4x2:return tn.MAT4X2;case e.FLOAT_MAT4x3:return tn.MAT4X3;case e.FLOAT_MAT4:return tn.MAT4;case e.SAMPLER_2D:return tn.SAMPLER2D;case e.SAMPLER_2D_ARRAY:return tn.SAMPLER2D_ARRAY;case e.SAMPLER_3D:return tn.SAMPLER3D;case e.SAMPLER_CUBE:return tn.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),tn.UNKNOWN}}function g2(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:return 4;case e.UNSIGNED_INT_VEC2:return 8;case e.UNSIGNED_INT_VEC3:return 12;case e.UNSIGNED_INT_VEC4:return 16;case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT2x3:return 24;case e.FLOAT_MAT2x4:return 32;case e.FLOAT_MAT3x2:return 24;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT3x4:return 48;case e.FLOAT_MAT4x2:return 32;case e.FLOAT_MAT4x3:return 48;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_2D_ARRAY:case e.SAMPLER_2D_ARRAY_SHADOW:case e.SAMPLER_3D:case e.SAMPLER_CUBE:case e.INT_SAMPLER_2D:case e.INT_SAMPLER_2D_ARRAY:case e.INT_SAMPLER_3D:case e.INT_SAMPLER_CUBE:case e.UNSIGNED_INT_SAMPLER_2D:case e.UNSIGNED_INT_SAMPLER_2D_ARRAY:case e.UNSIGNED_INT_SAMPLER_3D:case e.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function v2(t,e){switch(t){case e.FLOAT_MAT2:case e.FLOAT_MAT2x3:case e.FLOAT_MAT2x4:return 2;case e.FLOAT_MAT3x2:case e.FLOAT_MAT3:case e.FLOAT_MAT3x4:return 3;case e.FLOAT_MAT4x2:case e.FLOAT_MAT4x3:case e.FLOAT_MAT4:return 4;default:return 1}}const y2=[512,513,514,515,516,517,518,519],x2=[0,7680,7681,7682,7683,5386,34055,34056],S2=[32774,32778,32779,32775,32776],C2=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];let A2;!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(A2||(A2={}));class b2{constructor(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t}}class T2 extends b2{constructor(){super(A2.BEGIN_RENDER_PASS),this.gpuRenderPass=null,this.gpuFramebuffer=null,this.renderArea=new Gn,this.clearColors=[],this.clearDepth=1,this.clearStencil=0}clear(){this.gpuFramebuffer=null,this.clearColors.length=0}}class E2 extends b2{constructor(){super(A2.BIND_STATES),this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets=[],this.dynamicOffsets=[],this.dynamicStates=new zs}clear(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0}}class P2 extends b2{constructor(){super(A2.DRAW),this.drawInfo=new ts}clear(){}}class w2 extends b2{constructor(){super(A2.UPDATE_BUFFER),this.gpuBuffer=null,this.buffer=null,this.offset=0,this.size=0}clear(){this.gpuBuffer=null,this.buffer=null}}class I2 extends b2{constructor(){super(A2.COPY_BUFFER_TO_TEXTURE),this.gpuTexture=null,this.buffers=[],this.regions=[]}clear(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}class R2{constructor(){this.cmds=new Bl(1),this.beginRenderPassCmds=new Bl(1),this.bindStatesCmds=new Bl(1),this.drawCmds=new Bl(1),this.updateBufferCmds=new Bl(1),this.copyBufferToTextureCmds=new Bl(1)}clearCmds(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}function D2(t,e,i,n,s){if(e.usage&en.INDIRECT){e.indirects.clearDraws();const t=i.drawInfos;for(let i=0;i<t.length;++i)e.indirects.setDrawInfo(n+i,t[i])}else{const r=i,{gl:o}=t,a=t.stateCache;switch(e.glTarget){case o.ARRAY_BUFFER:t.extensions.useVAO&&a.glVAO&&(o.bindVertexArray(null),a.glVAO=null),B2.gpuInputAssembler=null,a.glArrayBuffer!==e.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,e.glBuffer),a.glArrayBuffer=e.glBuffer),s===r.byteLength?o.bufferSubData(e.glTarget,n,r):o.bufferSubData(e.glTarget,n,r.slice(0,s));break;case o.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&a.glVAO&&(o.bindVertexArray(null),a.glVAO=null),B2.gpuInputAssembler=null,a.glElementArrayBuffer!==e.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,e.glBuffer),a.glElementArrayBuffer=e.glBuffer),s===r.byteLength?o.bufferSubData(e.glTarget,n,r):o.bufferSubData(e.glTarget,n,r.slice(0,s));break;case o.UNIFORM_BUFFER:a.glUniformBuffer!==e.glBuffer&&(o.bindBuffer(o.UNIFORM_BUFFER,e.glBuffer),a.glUniformBuffer=e.glBuffer),s===r.byteLength?o.bufferSubData(e.glTarget,n,r):o.bufferSubData(e.glTarget,n,new Float32Array(r,0,s/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function M2(t,e){const{gl:i}=t;e.glInternalFmt=function(t,e){switch(t){case Zi.A8:return e.ALPHA;case Zi.L8:return e.LUMINANCE;case Zi.LA8:return e.LUMINANCE_ALPHA;case Zi.R8:return e.R8;case Zi.R8SN:return e.R8_SNORM;case Zi.R8UI:return e.R8UI;case Zi.R8I:return e.R8I;case Zi.RG8:return e.RG8;case Zi.RG8SN:return e.RG8_SNORM;case Zi.RG8UI:return e.RG8UI;case Zi.RG8I:return e.RG8I;case Zi.RGB8:return e.RGB8;case Zi.RGB8SN:return e.RGB8_SNORM;case Zi.RGB8UI:return e.RGB8UI;case Zi.RGB8I:return e.RGB8I;case Zi.BGRA8:case Zi.RGBA8:return e.RGBA8;case Zi.RGBA8SN:return e.RGBA8_SNORM;case Zi.RGBA8UI:return e.RGBA8UI;case Zi.RGBA8I:return e.RGBA8I;case Zi.R16I:return e.R16I;case Zi.R16UI:return e.R16UI;case Zi.R16F:return e.R16F;case Zi.RG16I:return e.RG16I;case Zi.RG16UI:return e.RG16UI;case Zi.RG16F:return e.RG16F;case Zi.RGB16I:return e.RGB16I;case Zi.RGB16UI:return e.RGB16UI;case Zi.RGB16F:return e.RGB16F;case Zi.RGBA16I:return e.RGBA16I;case Zi.RGBA16UI:return e.RGBA16UI;case Zi.RGBA16F:return e.RGBA16F;case Zi.R32I:return e.R32I;case Zi.R32UI:return e.R32UI;case Zi.R32F:return e.R32F;case Zi.RG32I:return e.RG32I;case Zi.RG32UI:return e.RG32UI;case Zi.RG32F:return e.RG32F;case Zi.RGB32I:return e.RGB32I;case Zi.RGB32UI:return e.RGB32UI;case Zi.RGB32F:return e.RGB32F;case Zi.RGBA32I:return e.RGBA32I;case Zi.RGBA32UI:return e.RGBA32UI;case Zi.RGBA32F:return e.RGBA32F;case Zi.R5G6B5:return e.RGB565;case Zi.RGB5A1:return e.RGB5_A1;case Zi.RGBA4:return e.RGBA4;case Zi.SRGB8:return e.SRGB8;case Zi.SRGB8_A8:return e.SRGB8_ALPHA8;case Zi.RGB10A2:return e.RGB10_A2;case Zi.RGB10A2UI:return e.RGB10_A2UI;case Zi.R11G11B10F:return e.R11F_G11F_B10F;case Zi.DEPTH:return e.DEPTH_COMPONENT32F;case Zi.DEPTH_STENCIL:return e.DEPTH24_STENCIL8;case Zi.BC1:return h2.COMPRESSED_RGB_S3TC_DXT1_EXT;case Zi.BC1_ALPHA:return h2.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Zi.BC1_SRGB:return h2.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Zi.BC1_SRGB_ALPHA:return h2.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Zi.BC2:return h2.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Zi.BC2_SRGB:return h2.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Zi.BC3:return h2.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Zi.BC3_SRGB:return h2.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Zi.ETC_RGB8:return h2.COMPRESSED_RGB_ETC1_WEBGL;case Zi.ETC2_RGB8:return h2.COMPRESSED_RGB8_ETC2;case Zi.ETC2_SRGB8:return h2.COMPRESSED_SRGB8_ETC2;case Zi.ETC2_RGB8_A1:return h2.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Zi.ETC2_SRGB8_A1:return h2.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Zi.ETC2_RGBA8:return h2.COMPRESSED_RGBA8_ETC2_EAC;case Zi.ETC2_SRGB8_A8:return h2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Zi.EAC_R11:return h2.COMPRESSED_R11_EAC;case Zi.EAC_R11SN:return h2.COMPRESSED_SIGNED_R11_EAC;case Zi.EAC_RG11:return h2.COMPRESSED_RG11_EAC;case Zi.EAC_RG11SN:return h2.COMPRESSED_SIGNED_RG11_EAC;case Zi.PVRTC_RGB2:return h2.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Zi.PVRTC_RGBA2:return h2.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Zi.PVRTC_RGB4:return h2.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Zi.PVRTC_RGBA4:return h2.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Zi.ASTC_RGBA_4X4:return h2.COMPRESSED_RGBA_ASTC_4x4_KHR;case Zi.ASTC_RGBA_5X4:return h2.COMPRESSED_RGBA_ASTC_5x4_KHR;case Zi.ASTC_RGBA_5X5:return h2.COMPRESSED_RGBA_ASTC_5x5_KHR;case Zi.ASTC_RGBA_6X5:return h2.COMPRESSED_RGBA_ASTC_6x5_KHR;case Zi.ASTC_RGBA_6X6:return h2.COMPRESSED_RGBA_ASTC_6x6_KHR;case Zi.ASTC_RGBA_8X5:return h2.COMPRESSED_RGBA_ASTC_8x5_KHR;case Zi.ASTC_RGBA_8X6:return h2.COMPRESSED_RGBA_ASTC_8x6_KHR;case Zi.ASTC_RGBA_8X8:return h2.COMPRESSED_RGBA_ASTC_8x8_KHR;case Zi.ASTC_RGBA_10X5:return h2.COMPRESSED_RGBA_ASTC_10x5_KHR;case Zi.ASTC_RGBA_10X6:return h2.COMPRESSED_RGBA_ASTC_10x6_KHR;case Zi.ASTC_RGBA_10X8:return h2.COMPRESSED_RGBA_ASTC_10x8_KHR;case Zi.ASTC_RGBA_10X10:return h2.COMPRESSED_RGBA_ASTC_10x10_KHR;case Zi.ASTC_RGBA_12X10:return h2.COMPRESSED_RGBA_ASTC_12x10_KHR;case Zi.ASTC_RGBA_12X12:return h2.COMPRESSED_RGBA_ASTC_12x12_KHR;case Zi.ASTC_SRGBA_4X4:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Zi.ASTC_SRGBA_5X4:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Zi.ASTC_SRGBA_5X5:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Zi.ASTC_SRGBA_6X5:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Zi.ASTC_SRGBA_6X6:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Zi.ASTC_SRGBA_8X5:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Zi.ASTC_SRGBA_8X6:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Zi.ASTC_SRGBA_8X8:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Zi.ASTC_SRGBA_10X5:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Zi.ASTC_SRGBA_10X6:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Zi.ASTC_SRGBA_10X8:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Zi.ASTC_SRGBA_10X10:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Zi.ASTC_SRGBA_12X10:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Zi.ASTC_SRGBA_12X12:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,i),e.glFormat=function(t,e){switch(t){case Zi.A8:return e.ALPHA;case Zi.L8:return e.LUMINANCE;case Zi.LA8:return e.LUMINANCE_ALPHA;case Zi.R8:case Zi.R8SN:return e.RED;case Zi.R8UI:case Zi.R8I:return e.RED;case Zi.RG8:case Zi.RG8SN:case Zi.RG8UI:case Zi.RG8I:return e.RG;case Zi.RGB8:case Zi.RGB8SN:case Zi.RGB8UI:case Zi.RGB8I:return e.RGB;case Zi.BGRA8:case Zi.RGBA8:case Zi.RGBA8SN:case Zi.RGBA8UI:case Zi.RGBA8I:return e.RGBA;case Zi.R16UI:case Zi.R16I:case Zi.R16F:return e.RED;case Zi.RG16UI:case Zi.RG16I:case Zi.RG16F:return e.RG;case Zi.RGB16UI:case Zi.RGB16I:case Zi.RGB16F:return e.RGB;case Zi.RGBA16UI:case Zi.RGBA16I:case Zi.RGBA16F:return e.RGBA;case Zi.R32UI:case Zi.R32I:case Zi.R32F:return e.RED;case Zi.RG32UI:case Zi.RG32I:case Zi.RG32F:return e.RG;case Zi.RGB32UI:case Zi.RGB32I:case Zi.RGB32F:return e.RGB;case Zi.RGBA32UI:case Zi.RGBA32I:case Zi.RGBA32F:case Zi.RGB10A2:return e.RGBA;case Zi.R11G11B10F:case Zi.R5G6B5:return e.RGB;case Zi.RGB5A1:case Zi.RGBA4:return e.RGBA;case Zi.SRGB8:return e.RGB;case Zi.SRGB8_A8:return e.RGBA;case Zi.DEPTH:return e.DEPTH_COMPONENT;case Zi.DEPTH_STENCIL:return e.DEPTH_STENCIL;case Zi.BC1:return h2.COMPRESSED_RGB_S3TC_DXT1_EXT;case Zi.BC1_ALPHA:return h2.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Zi.BC1_SRGB:return h2.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Zi.BC1_SRGB_ALPHA:return h2.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Zi.BC2:return h2.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Zi.BC2_SRGB:return h2.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Zi.BC3:return h2.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Zi.BC3_SRGB:return h2.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Zi.ETC_RGB8:return h2.COMPRESSED_RGB_ETC1_WEBGL;case Zi.ETC2_RGB8:return h2.COMPRESSED_RGB8_ETC2;case Zi.ETC2_SRGB8:return h2.COMPRESSED_SRGB8_ETC2;case Zi.ETC2_RGB8_A1:return h2.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Zi.ETC2_SRGB8_A1:return h2.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Zi.ETC2_RGBA8:return h2.COMPRESSED_RGBA8_ETC2_EAC;case Zi.ETC2_SRGB8_A8:return h2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Zi.EAC_R11:return h2.COMPRESSED_R11_EAC;case Zi.EAC_R11SN:return h2.COMPRESSED_SIGNED_R11_EAC;case Zi.EAC_RG11:return h2.COMPRESSED_RG11_EAC;case Zi.EAC_RG11SN:return h2.COMPRESSED_SIGNED_RG11_EAC;case Zi.PVRTC_RGB2:return h2.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Zi.PVRTC_RGBA2:return h2.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Zi.PVRTC_RGB4:return h2.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Zi.PVRTC_RGBA4:return h2.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Zi.ASTC_RGBA_4X4:return h2.COMPRESSED_RGBA_ASTC_4x4_KHR;case Zi.ASTC_RGBA_5X4:return h2.COMPRESSED_RGBA_ASTC_5x4_KHR;case Zi.ASTC_RGBA_5X5:return h2.COMPRESSED_RGBA_ASTC_5x5_KHR;case Zi.ASTC_RGBA_6X5:return h2.COMPRESSED_RGBA_ASTC_6x5_KHR;case Zi.ASTC_RGBA_6X6:return h2.COMPRESSED_RGBA_ASTC_6x6_KHR;case Zi.ASTC_RGBA_8X5:return h2.COMPRESSED_RGBA_ASTC_8x5_KHR;case Zi.ASTC_RGBA_8X6:return h2.COMPRESSED_RGBA_ASTC_8x6_KHR;case Zi.ASTC_RGBA_8X8:return h2.COMPRESSED_RGBA_ASTC_8x8_KHR;case Zi.ASTC_RGBA_10X5:return h2.COMPRESSED_RGBA_ASTC_10x5_KHR;case Zi.ASTC_RGBA_10X6:return h2.COMPRESSED_RGBA_ASTC_10x6_KHR;case Zi.ASTC_RGBA_10X8:return h2.COMPRESSED_RGBA_ASTC_10x8_KHR;case Zi.ASTC_RGBA_10X10:return h2.COMPRESSED_RGBA_ASTC_10x10_KHR;case Zi.ASTC_RGBA_12X10:return h2.COMPRESSED_RGBA_ASTC_12x10_KHR;case Zi.ASTC_RGBA_12X12:return h2.COMPRESSED_RGBA_ASTC_12x12_KHR;case Zi.ASTC_SRGBA_4X4:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Zi.ASTC_SRGBA_5X4:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Zi.ASTC_SRGBA_5X5:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Zi.ASTC_SRGBA_6X5:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Zi.ASTC_SRGBA_6X6:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Zi.ASTC_SRGBA_8X5:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Zi.ASTC_SRGBA_8X6:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Zi.ASTC_SRGBA_8X8:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Zi.ASTC_SRGBA_10X5:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Zi.ASTC_SRGBA_10X6:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Zi.ASTC_SRGBA_10X8:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Zi.ASTC_SRGBA_10X10:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Zi.ASTC_SRGBA_12X10:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Zi.ASTC_SRGBA_12X12:return h2.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}(e.format,i),e.glType=m2(e.format,i);let n=e.width,s=e.height;switch(e.type){case on.TEX2D:{if(e.glTarget=i.TEXTURE_2D,e.isSwapchainTexture)break;const r=Math.max(n,s);if(r>t.capabilities.maxTextureSize&&D(9100,r,t.capabilities.maxTextureSize),e.samples===hn.ONE){if(e.glTexture=i.createTexture(),e.size>0){const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_2D,e.glTexture),r.glTexture=e.glTexture),Gs[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const r=Ws(e.format,n,s,1),o=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,o),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else i.texStorage2D(i.TEXTURE_2D,e.mipLevel,e.glInternalFmt,n,s)}}else e.glRenderbuffer=i.createRenderbuffer(),e.size>0&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,e.samples,e.glInternalFmt,e.width,e.height));break}case on.CUBE:{e.glTarget=i.TEXTURE_CUBE_MAP;const r=Math.max(n,s);if(r>t.capabilities.maxCubeMapTextureSize&&D(9100,r,t.capabilities.maxTextureSize),e.glTexture=i.createTexture(),e.size>0){const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,e.glTexture),r.glTexture=e.glTexture),Gs[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const r=Ws(e.format,n,s,1),o=new Uint8Array(r);for(let r=0;r<6;++r)i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+r,t,e.glInternalFmt,n,s,0,o);n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else i.texStorage2D(i.TEXTURE_CUBE_MAP,e.mipLevel,e.glInternalFmt,n,s)}break}default:console.error("Unsupported TextureType, create texture failed."),e.type=on.TEX2D,e.glTarget=i.TEXTURE_2D}}function O2(t,e){const{gl:i}=t;if(e.glTexture){const n=t.stateCache.glTexUnits;let s=t.stateCache.texUnit;i.deleteTexture(e.glTexture);for(let t=0;t<n.length;++t)n[t].glTexture===e.glTexture&&(i.activeTexture(i.TEXTURE0+t),s=t,i.bindTexture(e.glTarget,null),n[t].glTexture=null);t.stateCache.texUnit=s,e.glTexture=null}if(e.glRenderbuffer){let n=t.stateCache.glRenderbuffer;i.deleteRenderbuffer(e.glRenderbuffer),n===e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,null),n=null),e.glRenderbuffer=null}}const B2={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function N2(t,e,i,n,s,r,o){const{gl:a}=t,c=t.stateCache;let l=0;if(i&&e){c.glFramebuffer!==i.glFramebuffer&&(a.bindFramebuffer(a.FRAMEBUFFER,i.glFramebuffer),c.glFramebuffer=i.glFramebuffer),c.viewport.left===n.x&&c.viewport.top===n.y&&c.viewport.width===n.width&&c.viewport.height===n.height||(a.viewport(n.x,n.y,n.width,n.height),c.viewport.left=n.x,c.viewport.top=n.y,c.viewport.width=n.width,c.viewport.height=n.height),c.scissorRect.x===n.x&&c.scissorRect.y===n.y&&c.scissorRect.width===n.width&&c.scissorRect.height===n.height||(a.scissor(n.x,n.y,n.width,n.height),c.scissorRect.x=n.x,c.scissorRect.y=n.y,c.scissorRect.width=n.width,c.scissorRect.height=n.height),B2.invalidateAttachments.length=0;for(let t=0;t<s.length;++t){const n=e.colorAttachments[t];if(n.format!==Zi.UNKNOWN)switch(n.loadOp){case xn.LOAD:break;case xn.CLEAR:if(c.bs.targets[0].blendColorMask!==vn.ALL&&a.colorMask(!0,!0,!0,!0),i.isOffscreen)d2[0]=s[t].x,d2[1]=s[t].y,d2[2]=s[t].z,d2[3]=s[t].w,a.clearBufferfv(a.COLOR,t,d2);else{const t=s[0];a.clearColor(t.x,t.y,t.z,t.w),l|=a.COLOR_BUFFER_BIT}break;case xn.DISCARD:B2.invalidateAttachments.push(a.COLOR_ATTACHMENT0+t)}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==Zi.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case xn.LOAD:break;case xn.CLEAR:c.dss.depthWrite||a.depthMask(!0),a.clearDepth(r),l|=a.DEPTH_BUFFER_BIT;break;case xn.DISCARD:B2.invalidateAttachments.push(a.DEPTH_ATTACHMENT)}if(Gs[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case xn.LOAD:break;case xn.CLEAR:c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,65535),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,65535),a.clearStencil(o),l|=a.STENCIL_BUFFER_BIT;break;case xn.DISCARD:B2.invalidateAttachments.push(a.STENCIL_ATTACHMENT)}}if(i.glFramebuffer&&B2.invalidateAttachments.length&&a.invalidateFramebuffer(a.FRAMEBUFFER,B2.invalidateAttachments),l&&a.clear(l),l&a.COLOR_BUFFER_BIT){const t=c.bs.targets[0].blendColorMask;if(t!==vn.ALL){const e=(t&vn.R)!==vn.NONE,i=(t&vn.G)!==vn.NONE,n=(t&vn.B)!==vn.NONE,s=(t&vn.A)!==vn.NONE;a.colorMask(e,i,n,s)}}l&a.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&a.depthMask(!1),l&a.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,0),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,0))}}function L2(t,e,i,n,s,r){const{gl:o}=t,a=t.stateCache,c=e&&e.gpuShader;let l=!1;if(e&&B2.gpuPipelineState!==e){if(B2.gpuPipelineState=e,B2.glPrimitive=e.glPrimitive,c){const{glProgram:t}=c;a.glProgram!==t&&(o.useProgram(t),a.glProgram=t,l=!0)}const{rs:i}=e;if(i){if(a.rs.cullMode!==i.cullMode){switch(i.cullMode){case wn.NONE:o.disable(o.CULL_FACE);break;case wn.FRONT:o.enable(o.CULL_FACE),o.cullFace(o.FRONT);break;case wn.BACK:o.enable(o.CULL_FACE),o.cullFace(o.BACK)}t.stateCache.rs.cullMode=i.cullMode}const e=i.isFrontFaceCCW;t.stateCache.rs.isFrontFaceCCW!==e&&(o.frontFace(e?o.CCW:o.CW),t.stateCache.rs.isFrontFaceCCW=e),t.stateCache.rs.depthBias===i.depthBias&&t.stateCache.rs.depthBiasSlop===i.depthBiasSlop||(o.polygonOffset(i.depthBias,i.depthBiasSlop),t.stateCache.rs.depthBias=i.depthBias,t.stateCache.rs.depthBiasSlop=i.depthBiasSlop),t.stateCache.rs.lineWidth!==i.lineWidth&&(o.lineWidth(i.lineWidth),t.stateCache.rs.lineWidth=i.lineWidth)}const{dss:n}=e;n&&(a.dss.depthTest!==n.depthTest&&(n.depthTest?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),a.dss.depthTest=n.depthTest),a.dss.depthWrite!==n.depthWrite&&(o.depthMask(n.depthWrite),a.dss.depthWrite=n.depthWrite),a.dss.depthFunc!==n.depthFunc&&(o.depthFunc(y2[n.depthFunc]),a.dss.depthFunc=n.depthFunc),a.dss.stencilTestFront===n.stencilTestFront&&a.dss.stencilTestBack===n.stencilTestBack||(n.stencilTestFront||n.stencilTestBack?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),a.dss.stencilTestFront=n.stencilTestFront,a.dss.stencilTestBack=n.stencilTestBack),a.dss.stencilFuncFront===n.stencilFuncFront&&a.dss.stencilRefFront===n.stencilRefFront&&a.dss.stencilReadMaskFront===n.stencilReadMaskFront||(o.stencilFuncSeparate(o.FRONT,y2[n.stencilFuncFront],n.stencilRefFront,n.stencilReadMaskFront),a.dss.stencilFuncFront=n.stencilFuncFront,a.dss.stencilRefFront=n.stencilRefFront,a.dss.stencilReadMaskFront=n.stencilReadMaskFront),a.dss.stencilFailOpFront===n.stencilFailOpFront&&a.dss.stencilZFailOpFront===n.stencilZFailOpFront&&a.dss.stencilPassOpFront===n.stencilPassOpFront||(o.stencilOpSeparate(o.FRONT,x2[n.stencilFailOpFront],x2[n.stencilZFailOpFront],x2[n.stencilPassOpFront]),a.dss.stencilFailOpFront=n.stencilFailOpFront,a.dss.stencilZFailOpFront=n.stencilZFailOpFront,a.dss.stencilPassOpFront=n.stencilPassOpFront),a.dss.stencilWriteMaskFront!==n.stencilWriteMaskFront&&(o.stencilMaskSeparate(o.FRONT,n.stencilWriteMaskFront),a.dss.stencilWriteMaskFront=n.stencilWriteMaskFront),a.dss.stencilFuncBack===n.stencilFuncBack&&a.dss.stencilRefBack===n.stencilRefBack&&a.dss.stencilReadMaskBack===n.stencilReadMaskBack||(o.stencilFuncSeparate(o.BACK,y2[n.stencilFuncBack],n.stencilRefBack,n.stencilReadMaskBack),a.dss.stencilFuncBack=n.stencilFuncBack,a.dss.stencilRefBack=n.stencilRefBack,a.dss.stencilReadMaskBack=n.stencilReadMaskBack),a.dss.stencilFailOpBack===n.stencilFailOpBack&&a.dss.stencilZFailOpBack===n.stencilZFailOpBack&&a.dss.stencilPassOpBack===n.stencilPassOpBack||(o.stencilOpSeparate(o.BACK,x2[n.stencilFailOpBack],x2[n.stencilZFailOpBack],x2[n.stencilPassOpBack]),a.dss.stencilFailOpBack=n.stencilFailOpBack,a.dss.stencilZFailOpBack=n.stencilZFailOpBack,a.dss.stencilPassOpBack=n.stencilPassOpBack),a.dss.stencilWriteMaskBack!==n.stencilWriteMaskBack&&(o.stencilMaskSeparate(o.BACK,n.stencilWriteMaskBack),a.dss.stencilWriteMaskBack=n.stencilWriteMaskBack));const{bs:s}=e;if(s){a.bs.isA2C!==s.isA2C&&(s.isA2C?o.enable(o.SAMPLE_ALPHA_TO_COVERAGE):o.disable(o.SAMPLE_ALPHA_TO_COVERAGE),a.bs.isA2C=s.isA2C),a.bs.blendColor.x===s.blendColor.x&&a.bs.blendColor.y===s.blendColor.y&&a.bs.blendColor.z===s.blendColor.z&&a.bs.blendColor.w===s.blendColor.w||(o.blendColor(s.blendColor.x,s.blendColor.y,s.blendColor.z,s.blendColor.w),a.bs.blendColor.x=s.blendColor.x,a.bs.blendColor.y=s.blendColor.y,a.bs.blendColor.z=s.blendColor.z,a.bs.blendColor.w=s.blendColor.w);const t=s.targets[0],e=a.bs.targets[0];e.blend!==t.blend&&(t.blend?o.enable(o.BLEND):o.disable(o.BLEND),e.blend=t.blend),e.blendEq===t.blendEq&&e.blendAlphaEq===t.blendAlphaEq||(o.blendEquationSeparate(S2[t.blendEq],S2[t.blendAlphaEq]),e.blendEq=t.blendEq,e.blendAlphaEq=t.blendAlphaEq),e.blendSrc===t.blendSrc&&e.blendDst===t.blendDst&&e.blendSrcAlpha===t.blendSrcAlpha&&e.blendDstAlpha===t.blendDstAlpha||(o.blendFuncSeparate(C2[t.blendSrc],C2[t.blendDst],C2[t.blendSrcAlpha],C2[t.blendDstAlpha]),e.blendSrc=t.blendSrc,e.blendDst=t.blendDst,e.blendSrcAlpha=t.blendSrcAlpha,e.blendDstAlpha=t.blendDstAlpha),e.blendColorMask!==t.blendColorMask&&(o.colorMask((t.blendColorMask&vn.R)!==vn.NONE,(t.blendColorMask&vn.G)!==vn.NONE,(t.blendColorMask&vn.B)!==vn.NONE,(t.blendColorMask&vn.A)!==vn.NONE),e.blendColorMask=t.blendColorMask)}}if(e&&e.gpuPipelineLayout&&c){const i=c.glBlocks.length,{dynamicOffsetIndices:r}=e.gpuPipelineLayout;for(let t=0;t<i;t++){const e=c.glBlocks[t],i=n[e.set],l=i&&i.descriptorIndices[e.binding],h=l>=0&&i.gpuDescriptors[l];if(!h||!h.gpuBuffer){x(`Buffer binding '${e.name}' at set ${e.set} binding ${e.binding} is not bounded`);continue}const _=r[e.set],u=_&&_[e.binding];let d=h.gpuBuffer.glOffset;u>=0&&(d+=s[u]),a.glBindUBOs[e.glBinding]===h.gpuBuffer.glBuffer&&a.glBindUBOOffsets[e.glBinding]===d||(d?o.bindBufferRange(o.UNIFORM_BUFFER,e.glBinding,h.gpuBuffer.glBuffer,d,h.gpuBuffer.size):o.bindBufferBase(o.UNIFORM_BUFFER,e.glBinding,h.gpuBuffer.glBuffer),a.glUniformBuffer=a.glBindUBOs[e.glBinding]=h.gpuBuffer.glBuffer,a.glBindUBOOffsets[e.glBinding]=d)}const l=c.glSamplerTextures.length;for(let e=0;e<l;e++){const i=c.glSamplerTextures[e],s=n[i.set];let r=s&&s.descriptorIndices[i.binding],l=r>=0&&s.gpuDescriptors[r];for(let e=0;e<i.units.length;e++){const n=i.units[e],c=a.glTexUnits[n];if(!(l&&l.gpuTextureView&&l.gpuTextureView.gpuTexture&&l.gpuSampler)){x(`Sampler binding '${i.name}' at set ${i.set} binding ${i.binding} index ${e} is not bounded`);continue}const h=l.gpuTextureView,_=h.gpuTexture,u=h.baseLevel,d=u+h.levelCount;if(_.size>0){c.glTexture!==_.glTexture&&(a.texUnit!==n&&(o.activeTexture(o.TEXTURE0+n),a.texUnit=n),_.glTexture?o.bindTexture(_.glTarget,_.glTexture):o.bindTexture(_.glTarget,t.nullTex2D.gpuTexture.glTexture),c.glTexture=_.glTexture);const{gpuSampler:e}=l,i=e.getGLSampler(t,u,d);a.glSamplerUnits[n]!==i&&(o.bindSampler(n,i),a.glSamplerUnits[n]=i)}l=s.gpuDescriptors[++r]}}}if(i&&c&&(l||B2.gpuInputAssembler!==i))if(B2.gpuInputAssembler=i,t.extensions.useVAO){let t=i.glVAOs.get(c.glProgram);if(!t){let e;t=o.createVertexArray(),i.glVAOs.set(c.glProgram,t),o.bindVertexArray(t),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null;for(let t=0;t<c.glInputs.length;t++){const n=c.glInputs[t];e=null;for(let t=0;t<i.glAttribs.length;t++){const s=i.glAttribs[t];if(s.name===n.name){e=s;break}}if(e){a.glArrayBuffer!==e.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,e.glBuffer),a.glArrayBuffer=e.glBuffer);for(let t=0;t<e.componentCount;++t){const i=n.glLoc+t,s=e.offset+e.size*t;o.enableVertexAttribArray(i),a.glCurrentAttribLocs[i]=!0,o.vertexAttribPointer(i,e.count,e.glType,e.isNormalized,e.stride,s),o.vertexAttribDivisor(i,e.isInstanced?1:0)}}}const n=i.gpuIndexBuffer;n&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,n.glBuffer),o.bindVertexArray(null),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null}a.glVAO!==t&&(o.bindVertexArray(t),a.glVAO=t)}else{for(let e=0;e<t.capabilities.maxVertexAttributes;++e)a.glCurrentAttribLocs[e]=!1;for(let t=0;t<c.glInputs.length;t++){const e=c.glInputs[t];let n=null;for(let t=0;t<i.glAttribs.length;t++){const s=i.glAttribs[t];if(s.name===e.name){n=s;break}}if(n){a.glArrayBuffer!==n.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,n.glBuffer),a.glArrayBuffer=n.glBuffer);for(let t=0;t<n.componentCount;++t){const i=e.glLoc+t,s=n.offset+n.size*t;!a.glEnabledAttribLocs[i]&&i>=0&&(o.enableVertexAttribArray(i),a.glEnabledAttribLocs[i]=!0),a.glCurrentAttribLocs[i]=!0,o.vertexAttribPointer(i,n.count,n.glType,n.isNormalized,n.stride,s),o.vertexAttribDivisor(i,n.isInstanced?1:0)}}}const e=i.gpuIndexBuffer;e&&a.glElementArrayBuffer!==e.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,e.glBuffer),a.glElementArrayBuffer=e.glBuffer);for(let e=0;e<t.capabilities.maxVertexAttributes;++e)a.glEnabledAttribLocs[e]!==a.glCurrentAttribLocs[e]&&(o.disableVertexAttribArray(e),a.glEnabledAttribLocs[e]=!1)}if(e&&e.dynamicStates.length){const t=e.dynamicStates.length;for(let i=0;i<t;i++)switch(e.dynamicStates[i]){case In.LINE_WIDTH:a.rs.lineWidth!==r.lineWidth&&(o.lineWidth(r.lineWidth),a.rs.lineWidth=r.lineWidth);break;case In.DEPTH_BIAS:a.rs.depthBias===r.depthBiasConstant&&a.rs.depthBiasSlop===r.depthBiasSlope||(o.polygonOffset(r.depthBiasConstant,r.depthBiasSlope),a.rs.depthBias=r.depthBiasConstant,a.rs.depthBiasSlop=r.depthBiasSlope);break;case In.BLEND_CONSTANTS:{const t=r.blendConstant;a.bs.blendColor.x===t.x&&a.bs.blendColor.y===t.y&&a.bs.blendColor.z===t.z&&a.bs.blendColor.w===t.w||(o.blendColor(t.x,t.y,t.z,t.w),a.bs.blendColor.copy(t));break}case In.STENCIL_WRITE_MASK:{const t=r.stencilStatesFront,e=r.stencilStatesBack;a.dss.stencilWriteMaskFront!==t.writeMask&&(o.stencilMaskSeparate(o.FRONT,t.writeMask),a.dss.stencilWriteMaskFront=t.writeMask),a.dss.stencilWriteMaskBack!==e.writeMask&&(o.stencilMaskSeparate(o.BACK,e.writeMask),a.dss.stencilWriteMaskBack=e.writeMask);break}case In.STENCIL_COMPARE_MASK:{const t=r.stencilStatesFront,e=r.stencilStatesBack;a.dss.stencilRefFront===t.reference&&a.dss.stencilReadMaskFront===t.compareMask||(o.stencilFuncSeparate(o.FRONT,y2[a.dss.stencilFuncFront],t.reference,t.compareMask),a.dss.stencilRefFront=t.reference,a.dss.stencilReadMaskFront=t.compareMask),a.dss.stencilRefBack===e.reference&&a.dss.stencilReadMaskBack===e.compareMask||(o.stencilFuncSeparate(o.BACK,y2[a.dss.stencilFuncBack],e.reference,e.compareMask),a.dss.stencilRefBack=e.reference,a.dss.stencilReadMaskBack=e.compareMask);break}}}}function F2(t,e){const{gl:i}=t,{gpuInputAssembler:n,glPrimitive:s}=B2,r=t.extensions.WEBGL_multi_draw;if(n){const t=n.gpuIndexBuffer;if(n.gpuIndirectBuffer){const{indirects:e}=n.gpuIndirectBuffer;if(e.drawByIndex){for(let i=0;i<e.drawCount;i++)e.byteOffsets[i]=e.offsets[i]*t.stride;if(r)e.instancedDraw?r.multiDrawElementsInstancedWEBGL(s,e.counts,0,n.glIndexType,e.byteOffsets,0,e.instances,0,e.drawCount):r.multiDrawElementsWEBGL(s,e.counts,0,n.glIndexType,e.byteOffsets,0,e.drawCount);else for(let t=0;t<e.drawCount;t++)e.instances[t]?i.drawElementsInstanced(s,e.counts[t],n.glIndexType,e.byteOffsets[t],e.instances[t]):i.drawElements(s,e.counts[t],n.glIndexType,e.byteOffsets[t])}else if(r)e.instancedDraw?r.multiDrawArraysInstancedWEBGL(s,e.offsets,0,e.counts,0,e.instances,0,e.drawCount):r.multiDrawArraysWEBGL(s,e.offsets,0,e.counts,0,e.drawCount);else for(let t=0;t<e.drawCount;t++)e.instances[t]?i.drawArraysInstanced(s,e.offsets[t],e.counts[t],e.instances[t]):i.drawArrays(s,e.offsets[t],e.counts[t])}else if(e.instanceCount)if(t){if(e.indexCount>0){const r=e.firstIndex*t.stride;i.drawElementsInstanced(s,e.indexCount,n.glIndexType,r,e.instanceCount)}}else e.vertexCount>0&&i.drawArraysInstanced(s,e.firstVertex,e.vertexCount,e.instanceCount);else if(t){if(e.indexCount>0){const r=e.firstIndex*t.stride;i.drawElements(s,e.indexCount,n.glIndexType,r)}}else e.vertexCount>0&&i.drawArrays(s,e.firstVertex,e.vertexCount)}}const z2=new Array(A2.COUNT);function V2(t,e){z2.fill(0);for(let i=0;i<e.cmds.length;++i){const n=e.cmds.array[i],s=z2[n]++;switch(n){case A2.BEGIN_RENDER_PASS:{const i=e.beginRenderPassCmds.array[s];N2(t,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break}case A2.BIND_STATES:{const i=e.bindStatesCmds.array[s];L2(t,i.gpuPipelineState,i.gpuInputAssembler,i.gpuDescriptorSets,i.dynamicOffsets,i.dynamicStates);break}case A2.DRAW:F2(t,e.drawCmds.array[s].drawInfo);break;case A2.UPDATE_BUFFER:{const i=e.updateBufferCmds.array[s];D2(t,i.gpuBuffer,i.buffer,i.offset,i.size);break}case A2.COPY_BUFFER_TO_TEXTURE:{const i=e.copyBufferToTextureCmds.array[s];G2(t,i.buffers,i.gpuTexture,i.regions);break}}}}function G2(t,e,i,n){const{gl:s}=t,r=t.stateCache.glTexUnits[t.stateCache.texUnit];r.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),r.glTexture=i.glTexture);let o=0,a=1,c=1,l=0;const h=Gs[i.format],{isCompressed:_}=h;switch(i.glTarget){case s.TEXTURE_2D:for(let t=0;t<n.length;t++){const r=n[t];a=r.texExtent.width,c=r.texExtent.height;const l=e[o++];_?i.glInternalFmt!==h2.COMPRESSED_RGB_ETC1_WEBGL?s.compressedTexSubImage2D(s.TEXTURE_2D,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,a,c,i.glFormat,l):s.compressedTexImage2D(s.TEXTURE_2D,r.texSubres.mipLevel,i.glInternalFmt,a,c,0,l):s.texSubImage2D(s.TEXTURE_2D,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,a,c,i.glFormat,i.glType,l)}break;case s.TEXTURE_CUBE_MAP:for(let t=0;t<n.length;t++){const r=n[t],h=r.texSubres.baseArrayLayer+r.texSubres.layerCount;for(l=r.texSubres.baseArrayLayer;l<h;++l){a=r.texExtent.width,c=r.texExtent.height;const t=e[o++];_?i.glInternalFmt!==h2.COMPRESSED_RGB_ETC1_WEBGL?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,a,c,i.glFormat,t):s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,r.texSubres.mipLevel,i.glInternalFmt,a,c,0,t):s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,a,c,i.glFormat,i.glType,t)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&cn.GEN_MIPMAP&&s.generateMipmap(i.glTarget)}class U2{constructor(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}clearDraws(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1}setDrawInfo(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)}_ensureCapacity(t){if(this._capacity>t)return;this._capacity=r(t);const e=new Int32Array(this._capacity),i=new Int32Array(this._capacity),n=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),i.set(this.offsets),n.set(this.instances),this.counts=e,this.offsets=i,this.instances=n}}class k2 extends rr{constructor(...t){super(...t),this._gpuBuffer=null}get gpuBuffer(){return this._gpuBuffer}initialize(t){if("buffer"in t){this._isBufferView=!0;const e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:e.gpuBuffer.indirects,glTarget:e.gpuBuffer.glTarget,glBuffer:e.gpuBuffer.glBuffer,glOffset:t.offset}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new U2,glTarget:0,glBuffer:null,glOffset:0},function(t,e){const{gl:i}=t,n=t.stateCache,s=e.memUsage&rn.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(e.usage&en.VERTEX){e.glTarget=i.ARRAY_BUFFER;const r=i.createBuffer();r&&(e.glBuffer=r,e.size>0&&(t.extensions.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),B2.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),i.bufferData(i.ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&en.INDEX){e.glTarget=i.ELEMENT_ARRAY_BUFFER;const r=i.createBuffer();r&&(e.glBuffer=r,e.size>0&&(t.extensions.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),B2.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else if(e.usage&en.UNIFORM){e.glTarget=i.UNIFORM_BUFFER;const n=i.createBuffer();n&&e.size>0&&(e.glBuffer=n,t.stateCache.glUniformBuffer!==e.glBuffer&&(i.bindBuffer(i.UNIFORM_BUFFER,e.glBuffer),t.stateCache.glUniformBuffer=e.glBuffer),i.bufferData(i.UNIFORM_BUFFER,e.size,s),i.bindBuffer(i.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null)}else e.usage&en.INDIRECT||e.usage&en.TRANSFER_DST||e.usage&en.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=i.NONE}(_2.instance,this._gpuBuffer),_2.instance.memoryStatus.bufferSize+=this._size}destroy(){this._gpuBuffer&&(this._isBufferView||(function(t,e){const{gl:i}=t,n=t.stateCache;if(e.glBuffer){switch(e.glTarget){case i.ARRAY_BUFFER:t.extensions.useVAO&&n.glVAO&&(i.bindVertexArray(null),t.stateCache.glVAO=null),B2.gpuInputAssembler=null,i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null;break;case i.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&n.glVAO&&(i.bindVertexArray(null),t.stateCache.glVAO=null),B2.gpuInputAssembler=null,i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null;break;case i.UNIFORM_BUFFER:i.bindBuffer(i.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null}i.deleteBuffer(e.glBuffer),e.glBuffer=null}}(_2.instance,this._gpuBuffer),_2.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)}resize(t){if(this._isBufferView)return void console.warn("cannot resize buffer views!");const e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=t,t>0&&(function(t,e){const{gl:i}=t,n=t.stateCache,s=e.memUsage&rn.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;e.usage&en.VERTEX?(t.extensions.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),B2.gpuInputAssembler=null,n.glArrayBuffer!==e.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,e.glBuffer),e.buffer?i.bufferData(i.ARRAY_BUFFER,e.buffer,s):i.bufferData(i.ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),n.glArrayBuffer=null):e.usage&en.INDEX?(t.extensions.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),B2.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.buffer,s):i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&en.UNIFORM?(t.stateCache.glUniformBuffer!==e.glBuffer&&i.bindBuffer(i.UNIFORM_BUFFER,e.glBuffer),i.bufferData(i.UNIFORM_BUFFER,e.size,s),i.bindBuffer(i.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null):(e.usage&en.INDIRECT||e.usage&en.TRANSFER_DST||e.usage&en.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=i.NONE)}(_2.instance,this._gpuBuffer),_2.instance.memoryStatus.bufferSize-=e,_2.instance.memoryStatus.bufferSize+=t)))}update(t,e){if(this._isBufferView)return void console.warn("cannot update through buffer views!");let i;i=void 0!==e?e:this._usage&en.INDIRECT?0:t.byteLength,D2(_2.instance,this._gpuBuffer,t,0,i)}}class H2{constructor(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new Bl(e);for(let i=0;i<e;++i)this._frees[i]=new t;this._freeIdx=e-1}alloc(t){if(this._freeIdx<0){const e=2*this._frees.length,i=this._frees;this._frees=new Array(e);const n=e-i.length;for(let e=0;e<n;++e)this._frees[e]=new t;for(let t=n,s=0;t<e;++t,++s)this._frees[t]=i[s];this._freeIdx+=n}const e=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++e.refCount,e}free(t){0==--t.refCount&&this._freeCmds.push(t)}freeCmds(t){for(let e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])}release(){for(let t=0;t<this._freeCmds.length;++t){const e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()}}class j2{constructor(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new H2(T2,1),this.bindStatesCmdPool=new H2(E2,1),this.drawCmdPool=new H2(P2,1),this.updateBufferCmdPool=new H2(w2,1),this.copyBufferToTextureCmdPool=new H2(I2,1)}clearCmds(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()}releaseCmds(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}class W2 extends or{constructor(...t){super(...t),this.cmdPackage=new R2,this._cmdAllocator=new j2,this._isInRenderPass=!1,this._curGPUPipelineState=null,this._curGPUDescriptorSets=[],this._curGPUInputAssembler=null,this._curDynamicOffsets=Array(8).fill(0),this._curDynamicStates=new zs,this._isStateInvalied=!1}initialize(t){this._type=t.type,this._queue=t.queue;const e=_2.instance.bindingMappings.blockOffsets.length;for(let t=0;t<e;t++)this._curGPUDescriptorSets.push(null)}destroy(){this._cmdAllocator.clearCmds(this.cmdPackage)}begin(t,e=0,i){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}end(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}beginRenderPass(t,e,i,n,s,r){const o=this._cmdAllocator.beginRenderPassCmdPool.alloc(T2);o.gpuRenderPass=t.gpuRenderPass,o.gpuFramebuffer=e.gpuFramebuffer,o.renderArea.copy(i);for(let t=0;t<n.length;++t)o.clearColors[t]=n[t];o.clearDepth=s,o.clearStencil=r,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(A2.BEGIN_RENDER_PASS),this._isInRenderPass=!0}endRenderPass(){this._isInRenderPass=!1}bindPipelineState(t){const e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)}bindDescriptorSet(t,e,i){const n=e.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=n,this._isStateInvalied=!0),i){var s;const e=null===(s=this._curGPUPipelineState)||void 0===s?void 0:s.gpuPipelineLayout;if(e){const n=this._curDynamicOffsets,s=e.dynamicOffsetOffsets[t];for(let t=0;t<i.length;t++)n[s+t]=i[t];this._isStateInvalied=!0}}}bindInputAssembler(t){const e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0}setViewport(t){const e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)}setScissor(t){const e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)}setLineWidth(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)}setDepthBias(t,e,i){const n=this._curDynamicStates;n.depthBiasConstant===t&&n.depthBiasClamp===e&&n.depthBiasSlope===i||(n.depthBiasConstant=t,n.depthBiasClamp=e,n.depthBiasSlope=i,this._isStateInvalied=!0)}setBlendConstants(t){const e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)}setDepthBound(t,e){const i=this._curDynamicStates;i.depthMinBounds===t&&i.depthMaxBounds===e||(i.depthMinBounds=t,i.depthMaxBounds=e,this._isStateInvalied=!0)}setStencilWriteMask(t,e){const i=this._curDynamicStates.stencilStatesFront,n=this._curDynamicStates.stencilStatesBack;t&Rn.FRONT&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0),t&Rn.BACK&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0)}setStencilCompareMask(t,e,i){const n=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;t&Rn.FRONT&&(n.compareMask===i&&n.reference===e||(n.reference=e,n.compareMask=i,this._isStateInvalied=!0)),t&Rn.BACK&&(s.compareMask===i&&s.reference===e||(s.reference=e,s.compareMask=i,this._isStateInvalied=!0))}draw(t){if(this._type===Bn.PRIMARY&&this._isInRenderPass||this._type===Bn.SECONDARY){this._isStateInvalied&&this.bindStates();const e="drawInfo"in t?t.drawInfo:t,i=this._cmdAllocator.drawCmdPool.alloc(P2);i.drawInfo.copy(e),this.cmdPackage.drawCmds.push(i),this.cmdPackage.cmds.push(A2.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;const n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(t,e,i){if(this._type===Bn.PRIMARY&&!this._isInRenderPass||this._type===Bn.SECONDARY){const n=t.gpuBuffer;if(n){const s=this._cmdAllocator.updateBufferCmdPool.alloc(w2);let r=0,o=null;t.usage&en.INDIRECT||(r=void 0!==i?i:e.byteLength),o=e,s.gpuBuffer=n,s.buffer=o,s.offset=0,s.size=r,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(A2.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}copyBuffersToTexture(t,e,i){if(this._type===Bn.PRIMARY&&!this._isInRenderPass||this._type===Bn.SECONDARY){const n=e.gpuTexture;if(n){const e=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(I2);e.gpuTexture=n,e.regions=i,e.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(e),this.cmdPackage.cmds.push(A2.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}execute(t,e){for(let i=0;i<e;++i){const e=t[i];for(let t=0;t<e.cmdPackage.beginRenderPassCmds.length;++t){const i=e.cmdPackage.beginRenderPassCmds.array[t];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(let t=0;t<e.cmdPackage.bindStatesCmds.length;++t){const i=e.cmdPackage.bindStatesCmds.array[t];++i.refCount,this.cmdPackage.bindStatesCmds.push(i)}for(let t=0;t<e.cmdPackage.drawCmds.length;++t){const i=e.cmdPackage.drawCmds.array[t];++i.refCount,this.cmdPackage.drawCmds.push(i)}for(let t=0;t<e.cmdPackage.updateBufferCmds.length;++t){const i=e.cmdPackage.updateBufferCmds.array[t];++i.refCount,this.cmdPackage.updateBufferCmds.push(i)}for(let t=0;t<e.cmdPackage.copyBufferToTextureCmds.length;++t){const i=e.cmdPackage.copyBufferToTextureCmds.array[t];++i.refCount,this.cmdPackage.copyBufferToTextureCmds.push(i)}this.cmdPackage.cmds.concat(e.cmdPackage.cmds.array),this._numDrawCalls+=e._numDrawCalls,this._numInstances+=e._numInstances,this._numTris+=e._numTris}}pipelineBarrier(t,e,i){}bindStates(){const t=this._cmdAllocator.bindStatesCmdPool.alloc(E2);t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(A2.BIND_STATES),this._isStateInvalied=!1}}class q2 extends lr{constructor(...t){super(...t),this._gpuFramebuffer=null}get gpuFramebuffer(){return this._gpuFramebuffer}initialize(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;const e=[];for(let i=0;i<t.colorTextures.length;i++){const n=t.colorTextures[i];n&&e.push(n.gpuTextureView)}let i=null;t.depthStencilTexture&&(i=t.depthStencilTexture.gpuTextureView);let n=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorViews:e,gpuDepthStencilView:i,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?n:this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.width:this.gpuDepthStencilView.gpuTexture.width},set width(t){n=t},get height(){return this.isOffscreen?n:this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.height:this.gpuDepthStencilView.gpuTexture.height},set height(t){}},function(t,e){for(let t=0;t<e.gpuColorViews.length;++t)if(e.gpuColorViews[t].gpuTexture.isSwapchainTexture)return void(e.isOffscreen=!1);const{gl:i}=t,n=[],s=i.createFramebuffer();if(s){e.glFramebuffer=s,t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.glFramebuffer);for(let t=0;t<e.gpuColorViews.length;++t){const s=e.gpuColorViews[t],r=s.gpuTexture;r&&(r.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+t,r.glTarget,r.glTexture,s.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+t,i.RENDERBUFFER,r.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+t),e.width=Math.min(e.width,r.width>>s.baseLevel),e.height=Math.min(e.height,r.height>>s.baseLevel))}const r=e.gpuDepthStencilView;if(r){const t=r.gpuTexture,n=Gs[t.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;t.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,n,t.glTarget,t.glTexture,e.gpuDepthStencilView.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,n,i.RENDERBUFFER,t.glRenderbuffer),e.width=Math.min(e.width,t.width>>r.baseLevel),e.height=Math.min(e.height,t.height>>r.baseLevel)}i.drawBuffers(n);const o=i.checkFramebufferStatus(i.FRAMEBUFFER);if(o!==i.FRAMEBUFFER_COMPLETE)switch(o){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(_2.instance,this._gpuFramebuffer)}destroy(){var t,e;this._gpuFramebuffer&&(t=_2.instance,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),t.stateCache.glFramebuffer===e.glFramebuffer&&(t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),t.stateCache.glFramebuffer=null),e.glFramebuffer=null),this._gpuFramebuffer=null)}}class X2 extends dr{constructor(...t){super(...t),this._gpuInputAssembler=null}get gpuInputAssembler(){return this._gpuInputAssembler}initialize(t){if(0===t.vertexBuffers.length)return void console.error("InputAssemblerInfo.vertexBuffers is null.");if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{const t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;const e=new Array(t.vertexBuffers.length);for(let i=0;i<t.vertexBuffers.length;++i){const n=t.vertexBuffers[i];n.gpuBuffer&&(e[i]=n.gpuBuffer)}let i=null,n=0;if(t.indexBuffer&&(i=t.indexBuffer.gpuBuffer,i))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Illegal index buffer stride.")}let s=null;t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:e,gpuIndexBuffer:i,gpuIndirectBuffer:s,glAttribs:[],glIndexType:n,glVAOs:new Map},function(t,e){const{gl:i}=t;e.glAttribs=new Array(e.attributes.length);const n=[0,0,0,0,0,0,0,0];for(let t=0;t<e.attributes.length;++t){const s=e.attributes[t],r=void 0!==s.stream?s.stream:0,o=e.gpuVertexBuffers[r],a=m2(s.format,i),{size:c}=Gs[s.format];e.glAttribs[t]={name:s.name,glBuffer:o.glBuffer,glType:a,size:c,count:Gs[s.format].count,stride:o.stride,componentCount:v2(a,i),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:n[r]},n[r]+=c}}(_2.instance,this._gpuInputAssembler)}destroy(){const t=_2.instance;this._gpuInputAssembler&&t.extensions.useVAO&&function(t,e){const i=e.glVAOs.values();let n=i.next();const{gl:s}=t;let r=t.stateCache.glVAO;for(;!n.done;)s.deleteVertexArray(n.value),r===n.value&&(s.bindVertexArray(null),r=null),n=i.next();t.stateCache.glVAO=r,e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null}}class Y2 extends mr{constructor(...t){super(...t),this._gpuDescriptorSetLayout=null}get gpuDescriptorSetLayout(){return this._gpuDescriptorSetLayout}initialize(t){Array.prototype.push.apply(this._bindings,t.bindings);let e=0,i=-1;const n=[];for(let t=0;t<this._bindings.length;t++){const s=this._bindings[t];n.push(e),e+=s.count,s.binding>i&&(i=s.binding)}this._bindingIndices=Array(i+1).fill(-1);const s=this._descriptorIndices=Array(i+1).fill(-1);for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];this._bindingIndices[e.binding]=t,s[e.binding]=n[t]}const r=[];for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];if(e.descriptorType&Hs)for(let t=0;t<e.count;t++)r.push(e.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:r,descriptorIndices:s,descriptorCount:e}}destroy(){this._bindings.length=0}}class K2 extends pr{constructor(...t){super(...t),this._gpuPipelineLayout=null}get gpuPipelineLayout(){return this._gpuPipelineLayout}initialize(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);const e=[],i=[];let n=0;const s=[];for(let t=0;t<this._setLayouts.length;t++){const r=this._setLayouts[t],o=r.gpuDescriptorSetLayout.dynamicBindings,a=Array(r.bindingIndices.length).fill(-1);for(let t=0;t<o.length;t++){const e=o[t];a[e]<0&&(a[e]=n+t)}i.push(r.gpuDescriptorSetLayout),e.push(a),s.push(n),n+=o.length}this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetIndices:e,dynamicOffsetCount:n,dynamicOffsetOffsets:s}}destroy(){this._setLayouts.length=0}}const J2=[0,1,3,2,0,0,0,4,5,6,0,0,0,0];class $2 extends X1{constructor(...t){super(...t),this._gpuPipelineState=null}get gpuPipelineState(){return this._gpuPipelineState}initialize(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;const e=this._bs;if(t.blendState){const i=t.blendState,{targets:n}=i;n&&n.forEach(((t,i)=>{e.setTarget(i,t)})),void 0!==i.isA2C&&(e.isA2C=i.isA2C),void 0!==i.isIndepend&&(e.isIndepend=i.isIndepend),void 0!==i.blendColor&&(e.blendColor=i.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;const i=[];for(let t=0;t<31;t++)this._dynamicStates&1<<t&&i.push(1<<t);this._gpuPipelineState={glPrimitive:J2[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:i}}destroy(){this._gpuPipelineState=null}}class Z2 extends W2{beginRenderPass(t,e,i,n,s,r){N2(_2.instance,t.gpuRenderPass,e.gpuFramebuffer,i,n,s,r),this._isInRenderPass=!0}draw(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();const e="drawInfo"in t?t.drawInfo:t;F2(_2.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;const i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}setViewport(t){const{stateCache:e,gl:i}=_2.instance;e.viewport.left===t.left&&e.viewport.top===t.top&&e.viewport.width===t.width&&e.viewport.height===t.height||(i.viewport(t.left,t.top,t.width,t.height),e.viewport.left=t.left,e.viewport.top=t.top,e.viewport.width=t.width,e.viewport.height=t.height)}setScissor(t){const{stateCache:e,gl:i}=_2.instance;e.scissorRect.x===t.x&&e.scissorRect.y===t.y&&e.scissorRect.width===t.width&&e.scissorRect.height===t.height||(i.scissor(t.x,t.y,t.width,t.height),e.scissorRect.x=t.x,e.scissorRect.y=t.y,e.scissorRect.width=t.width,e.scissorRect.height=t.height)}updateBuffer(t,e,i){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{const n=t.gpuBuffer;if(n){let s;s=void 0!==i?i:t.usage&en.INDIRECT?0:e.byteLength,D2(_2.instance,n,e,0,s)}}}copyBuffersToTexture(t,e,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{const n=e.gpuTexture;n&&G2(_2.instance,t,n,i)}}execute(t,e){for(let i=0;i<e;++i){const e=t[i];V2(_2.instance,e.cmdPackage),this._numDrawCalls+=e._numDrawCalls,this._numInstances+=e._numInstances,this._numTris+=e._numTris}}bindStates(){L2(_2.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1}}class Q2 extends fr{constructor(...t){super(...t),this.numDrawCalls=0,this.numInstances=0,this.numTris=0}initialize(t){this._type=t.type}destroy(){}submit(t){for(let e=0;e<t.length;e++){const i=t[e];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}}clear(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}class t4 extends gr{constructor(...t){super(...t),this._gpuRenderPass=null}get gpuRenderPass(){return this._gpuRenderPass}initialize(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()}destroy(){this._gpuRenderPass=null}}class e4 extends xr{get gpuSampler(){return this._gpuSampler}constructor(t,e){super(t,e),this._gpuSampler=null,this._gpuSampler={glSamplers:new Map,minFilter:this._info.minFilter,magFilter:this._info.magFilter,mipFilter:this._info.mipFilter,addressU:this._info.addressU,addressV:this._info.addressV,addressW:this._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0,getGLSampler(t,e,i){const{gl:n}=t,s=e<<16|i;if(!this.glSamplers.has(s)){const t=n.createSampler();t&&(this.glSamplers.set(s,t),n.samplerParameteri(t,n.TEXTURE_MIN_FILTER,this.glMinFilter),n.samplerParameteri(t,n.TEXTURE_MAG_FILTER,this.glMagFilter),n.samplerParameteri(t,n.TEXTURE_WRAP_S,this.glWrapS),n.samplerParameteri(t,n.TEXTURE_WRAP_T,this.glWrapT),n.samplerParameteri(t,n.TEXTURE_WRAP_R,this.glWrapR),n.samplerParameterf(t,n.TEXTURE_MIN_LOD,e),n.samplerParameterf(t,n.TEXTURE_MAX_LOD,i))}return this.glSamplers.get(s)}},function(t,e){const{gl:i}=t;e.minFilter===un.LINEAR||e.minFilter===un.ANISOTROPIC?e.mipFilter===un.LINEAR||e.mipFilter===un.ANISOTROPIC?e.glMinFilter=i.LINEAR_MIPMAP_LINEAR:e.mipFilter===un.POINT?e.glMinFilter=i.LINEAR_MIPMAP_NEAREST:e.glMinFilter=i.LINEAR:e.mipFilter===un.LINEAR||e.mipFilter===un.ANISOTROPIC?e.glMinFilter=i.NEAREST_MIPMAP_LINEAR:e.mipFilter===un.POINT?e.glMinFilter=i.NEAREST_MIPMAP_NEAREST:e.glMinFilter=i.NEAREST,e.magFilter===un.LINEAR||e.magFilter===un.ANISOTROPIC?e.glMagFilter=i.LINEAR:e.glMagFilter=i.NEAREST,e.glWrapS=u2[e.addressU],e.glWrapT=u2[e.addressV],e.glWrapR=u2[e.addressW]}(_2.instance,this._gpuSampler)}destroy(){this._gpuSampler&&(function(t,e){const{gl:i}=t,n=e.glSamplers.values().next();for(;!n.done;){i.deleteSampler(n.value);const e=t.stateCache.glSamplerUnits;for(let t=0;t<e.length;++t)e[t]===n.value&&(i.bindSampler(t,null),e[t]=null)}e.glSamplers.clear()}(_2.instance,this._gpuSampler),this._gpuSampler=null)}}class i4 extends vr{constructor(...t){super(...t),this._gpuShader=null}get gpuShader(){return this._gpuShader}initialize(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(let e=0;e<t.stages.length;++e){const i=t.stages[e];this._gpuShader.gpuStages[e]={type:i.stage,source:i.source,glShader:null}}!function(t,e){const{gl:i}=t;for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];let s=0,r="",o=1;switch(n.type){case yn.VERTEX:r="VertexShader",s=i.VERTEX_SHADER;break;case yn.FRAGMENT:r="FragmentShader",s=i.FRAGMENT_SHADER;break;default:return void console.error("Unsupported ShaderType.")}const a=i.createShader(s);if(a&&(n.glShader=a,i.shaderSource(n.glShader,`#version 300 es\n${n.source}`),i.compileShader(n.glShader),!i.getShaderParameter(n.glShader,i.COMPILE_STATUS))){console.error(`${r} in '${e.name}' compilation failed.`),console.error("Shader source dump:",n.source.replace(/^|\n/g,(()=>`\n${o++} `))),console.error(i.getShaderInfoLog(n.glShader));for(let n=0;n<e.gpuStages.length;n++){const n=e.gpuStages[t];n.glShader&&(i.deleteShader(n.glShader),n.glShader=null)}return}}const n=i.createProgram();if(!n)return;e.glProgram=n;for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];i.attachShader(e.glProgram,n.glShader)}i.linkProgram(e.glProgram);for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];n.glShader&&(i.detachShader(e.glProgram,n.glShader),i.deleteShader(n.glShader),n.glShader=null)}if(!i.getProgramParameter(e.glProgram,i.LINK_STATUS))return console.error(`Failed to link shader '${e.name}'.`),void console.error(i.getProgramInfoLog(e.glProgram));C(`Shader '${e.name}' compilation succeeded.`);const s=i.getProgramParameter(e.glProgram,i.ACTIVE_ATTRIBUTES);e.glInputs=new Array(s);for(let t=0;t<s;++t){const n=i.getActiveAttrib(e.glProgram,t);if(n){let s;const r=n.name.indexOf("[");s=-1!==r?n.name.substr(0,r):n.name;const o=i.getAttribLocation(e.glProgram,s),a=f2(n.type,i),c=g2(n.type,i);e.glInputs[t]={name:s,type:a,stride:c,count:n.size,size:c*n.size,glType:n.type,glLoc:o}}}const r=i.getProgramParameter(e.glProgram,i.ACTIVE_UNIFORM_BLOCKS);let o,a,c,l;if(r){e.glBlocks=new Array(r);for(let n=0;n<r;++n){o=i.getActiveUniformBlockName(e.glProgram,n);const s=o.indexOf("[");-1!==s&&(o=o.substr(0,s)),l=null;for(let t=0;t<e.blocks.length;t++)if(e.blocks[t].name===o){l=e.blocks[t];break}if(l){a=n,c=i.getActiveUniformBlockParameter(e.glProgram,a,i.UNIFORM_BLOCK_DATA_SIZE);const s=l.binding+(t.bindingMappings.blockOffsets[l.set]||0);i.uniformBlockBinding(e.glProgram,a,s),e.glBlocks[n]={set:l.set,binding:l.binding,idx:a,name:o,size:c,glBinding:s}}else x(`Block '${o}' does not bound`)}}for(let t=0;t<e.subpassInputs.length;++t){const i=e.subpassInputs[t];e.samplerTextures.push(new ls(i.set,i.binding,i.name,tn.SAMPLER2D,i.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(let t=0;t<e.samplerTextures.length;++t){const n=e.samplerTextures[t];e.glSamplerTextures[t]={set:n.set,binding:n.binding,name:n.name,type:n.type,count:n.count,units:[],glUnits:null,glType:p2(n.type,i),glLoc:null}}}const h=[],_=[],u=t.stateCache.texUnitCacheMap;let d=0;for(let i=0;i<e.blocks.length;++i)e.blocks[i].set===t.bindingMappings.flexibleSet&&d++;let m=0;for(let n=0;n<e.samplerTextures.length;++n){const s=e.samplerTextures[n],r=i.getUniformLocation(e.glProgram,s.name);if(r&&-1!==r.id&&(h.push(e.glSamplerTextures[n]),_.push(r)),void 0===u[s.name]){let e=s.binding+t.bindingMappings.samplerTextureOffsets[s.set]+m;s.set===t.bindingMappings.flexibleSet&&(e-=d),u[s.name]=e%t.capabilities.maxTextureUnits,m+=s.count-1}}if(h.length){const n=[];for(let e=0;e<h.length;++e){const i=h[e];let s=u[i.name];if(void 0!==s){i.glLoc=_[e];for(let e=0;e<i.count;++e){for(;n[s];)s=(s+1)%t.capabilities.maxTextureUnits;i.units.push(s),n[s]=!0}}}let s=0;for(let e=0;e<h.length;++e){const i=h[e];if(!i.glLoc){for(i.glLoc=_[e];n[s];)s++;for(let e=0;e<i.count;++e){for(;n[s];)s=(s+1)%t.capabilities.maxTextureUnits;void 0===u[i.name]&&(u[i.name]=s),i.units.push(s),n[s]=!0}}}t.stateCache.glProgram!==e.glProgram&&i.useProgram(e.glProgram);for(let t=0;t<h.length;t++){const e=h[t];e.glUnits=new Int32Array(e.units),i.uniform1iv(e.glLoc,e.glUnits)}t.stateCache.glProgram!==e.glProgram&&i.useProgram(t.stateCache.glProgram)}e.glSamplerTextures=h}(_2.instance,this._gpuShader)}destroy(){var t,e;this._gpuShader&&(t=_2.instance,(e=this._gpuShader).glProgram&&(t.gl.deleteProgram(e.glProgram),t.stateCache.glProgram===e.glProgram&&(t.gl.useProgram(null),t.stateCache.glProgram=null),e.glProgram=null),this._gpuShader=null)}}class n4{constructor(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new Xn,this.scissorRect=new Gn(0,0,0,0),this.rs=new H1,this.dss=new j1,this.bs=new q1,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}initialize(t,e,i){for(let e=0;e<t;++e)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=t,this.glSamplerUnits.fill(null),this.glBindUBOs.length=e,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=e,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=i,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=i,this.glCurrentAttribLocs.fill(!1)}}class s4 extends yr{constructor(...t){super(...t),this._gpuTexture=null,this._gpuTextureView=null}get gpuTexture(){return this._gpuTexture}get gpuTextureView(){return this._gpuTextureView}initialize(t,e){let i=t;const n=t;if("texture"in t&&(i=n.texture.info,this._isTextureView=!0),this._info.copy(i),this._isPowerOf2=js(this._info.width)&&js(this._info.height),this._size=qs(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView){var s;if(this._viewInfo.copy(n),this._gpuTexture=n.texture._gpuTexture,(null===(s=this._gpuTexture)||void 0===s?void 0:s.format)!==i.format)return void console.log("GPU memory alias is not supported");this._gpuTextureView={gpuTexture:this._gpuTexture,type:n.type,format:n.format,baseLevel:n.baseLevel,levelCount:n.levelCount}}else this._gpuTexture={type:i.type,format:i.format,usage:i.usage,width:i.width,height:i.height,depth:i.depth,size:this._size,arrayLayer:i.layerCount,mipLevel:i.levelCount,samples:i.samples,flags:i.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},M2(_2.instance,this._gpuTexture),_2.instance.memoryStatus.textureSize+=this._size,this._viewInfo.texture=this,this._viewInfo.type=t.type,this._viewInfo.format=t.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=t.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=t.layerCount,this._gpuTextureView={gpuTexture:this._gpuTexture,type:this._viewInfo.type,format:this._viewInfo.format,baseLevel:this._viewInfo.baseLevel,levelCount:this._viewInfo.levelCount}}destroy(){!this._isTextureView&&this._gpuTexture&&(O2(_2.instance,this._gpuTexture),_2.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)}resize(t,e){if(this._info.width===t&&this._info.height===e)return;this._info.levelCount===s4.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=s4.getLevelCount(t,e):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,s4.getLevelCount(t,e)));const i=this._size;this._info.width=t,this._info.height=e,this._size=qs(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){if(!e.size)return;const{gl:i}=t;let n=e.width,s=e.height;switch(e.type){case on.TEX2D:{e.glTarget=i.TEXTURE_2D;const r=Math.max(n,s);if(r>t.capabilities.maxTextureSize&&D(9100,r,t.capabilities.maxTextureSize),e.samples===hn.ONE){const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_2D,e.glTexture),r.glTexture=e.glTexture),Gs[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const r=Ws(e.format,n,s,1),o=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,o),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else O2(t,e),M2(t,e)}else e.glRenderbuffer&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,e.samples,e.glInternalFmt,e.width,e.height));break}case on.CUBE:{e.type=on.CUBE,e.glTarget=i.TEXTURE_CUBE_MAP;const r=Math.max(n,s);r>t.capabilities.maxCubeMapTextureSize&&D(9100,r,t.capabilities.maxTextureSize);const o=t.stateCache.glTexUnits[t.stateCache.texUnit];if(o.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,e.glTexture),o.glTexture=e.glTexture),Gs[e.format].isCompressed)for(let t=0;t<6;++t){n=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r){const o=Ws(e.format,n,s,1),a=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else O2(t,e),M2(t,e);break}default:console.error("Unsupported TextureType, create texture failed."),e.type=on.TEX2D,e.glTarget=i.TEXTURE_2D}}(_2.instance,this._gpuTexture),_2.instance.memoryStatus.textureSize-=i,_2.instance.memoryStatus.textureSize+=this._size)}initAsSwapchainTexture(t){const e=new ss;e.format=t.format,e.usage=Gs[t.format].hasDepth?an.DEPTH_STENCIL_ATTACHMENT:an.COLOR_ATTACHMENT,e.width=t.width,e.height=t.height,this.initialize(e,!0)}}const r4="webglcontextlost";function o4(t,e){const i=["","WEBKIT_","MOZ_"];for(let n=0;n<i.length;++n){const s=t.getExtension(i[n]+e);if(s)return s}return null}function a4(t){const e={EXT_texture_filter_anisotropic:o4(t,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:o4(t,"EXT_color_buffer_half_float"),EXT_color_buffer_float:o4(t,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:o4(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:o4(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:o4(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:o4(t,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:o4(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:o4(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:o4(t,"WEBGL_debug_shaders"),WEBGL_lose_context:o4(t,"WEBGL_lose_context"),WEBGL_debug_renderer_info:o4(t,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:o4(t,"OES_texture_half_float_linear"),OES_texture_float_linear:o4(t,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return Zl.os!==Xl.ANDROID&&Zl.os!==Xl.IOS&&(e.WEBGL_multi_draw=o4(t,"WEBGL_multi_draw")),e}class c4 extends cr{constructor(...t){super(...t),this.stateCache=new n4,this.nullTex2D=null,this.nullTexCube=null,this._canvas=null,this._webGL2ContextLostHandler=null,this._extensions=null}get extensions(){return this._extensions}initialize(t){this._canvas=t.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(r4,this._onWebGLContextLost);const e=_2.instance.gl;this.stateCache.initialize(_2.instance.capabilities.maxTextureUnits,_2.instance.capabilities.maxUniformBufferBindings,_2.instance.capabilities.maxVertexAttributes),this._extensions=a4(e),function(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}(e);const i=Zi.RGBA8;let n=Zi.DEPTH_STENCIL;const s=e.getParameter(e.DEPTH_BITS),r=e.getParameter(e.STENCIL_BITS);s&&r?n=Zi.DEPTH_STENCIL:s&&(n=Zi.DEPTH),this._colorTexture=new s4,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this._depthStencilTexture=new s4,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:n,width:t.width,height:t.height}),this.nullTex2D=_2.instance.createTexture(new ss(on.TEX2D,an.SAMPLED,Zi.RGBA8,2,2,cn.NONE)),this.nullTexCube=_2.instance.createTexture(new ss(on.CUBE,an.SAMPLED,Zi.RGBA8,2,2,cn.NONE,6));const o=new qn;o.texExtent.width=2,o.texExtent.height=2;const a=new Uint8Array(this.nullTex2D.size);a.fill(0),_2.instance.copyBuffersToTexture([a],this.nullTex2D,[o]),o.texSubres.layerCount=6,_2.instance.copyBuffersToTexture([a,a,a,a,a,a],this.nullTexCube,[o])}destroy(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(r4,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null}resize(t,e,i){this._colorTexture.width===t&&this._colorTexture.height===e||(C(`Resizing swapchain: ${t}x${e}`),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))}_onWebGLContextLost(t){I(11e3),y(t)}}class l4 extends ar{constructor(...t){super(...t),this._swapchain=null,this._context=null,this._bindingMappings=null,this._textureExclusive=new Array(Zi.COUNT)}get gl(){return this._context}get extensions(){return this._swapchain.extensions}get stateCache(){return this._swapchain.stateCache}get nullTex2D(){return this._swapchain.nullTex2D}get nullTexCube(){return this._swapchain.nullTexCube}get textureExclusive(){return this._textureExclusive}get bindingMappings(){return this._bindingMappings}initialize(t){_2.setInstance(this),this._gfxAPI=Ki.WEBGL2;const e=this._bindingMappingInfo=t.bindingMappingInfo,i=[],n=[],s=e.setIndices[0];i[s]=0,n[s]=0;for(let t=1;t<e.setIndices.length;++t){const s=e.setIndices[t],r=e.setIndices[t-1];i[s]=e.maxBlockCounts[r]+i[r],n[s]=e.maxSamplerTextureCounts[r]+n[r]}for(let t=0;t<e.setIndices.length;++t){const i=e.setIndices[t];n[i]-=e.maxBlockCounts[i]}this._bindingMappings={blockOffsets:i,samplerTextureOffsets:n,flexibleSet:e.setIndices[e.setIndices.length-1]};const r=this._context=function(t){let e=null;try{const i={alpha:Kt.ENABLE_TRANSPARENT_CANVAS,antialias:Kt.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl2",i)}catch(t){return null}return e}(ar.canvas);if(!r)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Os(Mn.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Ms(this._queue)),this._caps.maxVertexAttributes=r.getParameter(r.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=r.getParameter(r.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=r.getParameter(r.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=r.getParameter(r.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=r.getParameter(r.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=r.getParameter(r.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=r.getParameter(r.UNIFORM_BUFFER_OFFSET_ALIGNMENT);const o=r.getSupportedExtensions();let a="";if(o)for(const t of o)a+=`${t} `;const c=a4(r);c.WEBGL_debug_renderer_info?(this._renderer=r.getParameter(c.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=r.getParameter(c.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=r.getParameter(r.RENDERER),this._vendor=r.getParameter(r.VENDOR));const l=r.getParameter(r.VERSION);this._features.fill(!1),this.initFormatFeatures(c),this._features[$i.ELEMENT_INDEX_UINT]=!0,this._features[$i.INSTANCED_ARRAYS]=!0,this._features[$i.MULTIPLE_RENDER_TARGETS]=!0,this._features[$i.BLEND_MINMAX]=!0;let h="";return this.getFormatFeatures(Zi.ETC_RGB8)&&(h+="etc1 "),this.getFormatFeatures(Zi.ETC2_RGB8)&&(h+="etc2 "),this.getFormatFeatures(Zi.BC1)&&(h+="dxt "),this.getFormatFeatures(Zi.PVRTC_RGB2)&&(h+="pvrtc "),this.getFormatFeatures(Zi.ASTC_RGBA_4X4)&&(h+="astc "),C("WebGL2 device initialized."),C(`RENDERER: ${this._renderer}`),C(`VENDOR: ${this._vendor}`),C(`VERSION: ${l}`),C(`COMPRESSED_FORMAT: ${h}`),C(`EXTENSIONS: ${a}`),!0}destroy(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);const t=this._samplers.values();let e=t.next();for(;!e.done;)e.value.destroy(),e=t.next();this._swapchain=null}flushCommands(t){}acquire(t){}present(){const t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()}initFormatFeatures(t){this._formatFeatures.fill(ln.NONE),this._textureExclusive.fill(!0);let e=ln.RENDER_TARGET|ln.SAMPLED_TEXTURE|ln.STORAGE_TEXTURE|ln.LINEAR_FILTER|ln.VERTEX_ATTRIBUTE;this._formatFeatures[Zi.R8]=e,this._formatFeatures[Zi.RG8]=e,this._formatFeatures[Zi.RGB8]=e,this._formatFeatures[Zi.RGBA8]=e,e=ln.RENDER_TARGET|ln.SAMPLED_TEXTURE|ln.STORAGE_TEXTURE|ln.LINEAR_FILTER,this._formatFeatures[Zi.R8SN]=e,this._formatFeatures[Zi.RG8SN]=e,this._formatFeatures[Zi.RGB8SN]=e,this._formatFeatures[Zi.RGBA8SN]=e,this._formatFeatures[Zi.R5G6B5]=e,this._formatFeatures[Zi.RGBA4]=e,this._formatFeatures[Zi.RGB5A1]=e,this._formatFeatures[Zi.RGB10A2]=e,this._formatFeatures[Zi.SRGB8]=e,this._formatFeatures[Zi.SRGB8_A8]=e,this._formatFeatures[Zi.R11G11B10F]=e,this._formatFeatures[Zi.RGB9E5]=e,this._formatFeatures[Zi.DEPTH]=e,this._formatFeatures[Zi.DEPTH_STENCIL]=e,this._formatFeatures[Zi.RGB10A2UI]=ln.RENDER_TARGET|ln.STORAGE_TEXTURE|ln.SAMPLED_TEXTURE|ln.LINEAR_FILTER,e=ln.RENDER_TARGET|ln.SAMPLED_TEXTURE|ln.STORAGE_TEXTURE|ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.R16F]=e,this._formatFeatures[Zi.RG16F]=e,this._formatFeatures[Zi.RGB16F]=e,this._formatFeatures[Zi.RGBA16F]=e,e=ln.STORAGE_TEXTURE|ln.SAMPLED_TEXTURE|ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.R32F]=e,this._formatFeatures[Zi.RG32F]=e,this._formatFeatures[Zi.RGB32F]=e,this._formatFeatures[Zi.RGBA32F]=e,this._formatFeatures[Zi.RGB10A2UI]=ln.RENDER_TARGET|ln.STORAGE_TEXTURE|ln.SAMPLED_TEXTURE|ln.LINEAR_FILTER,e=ln.RENDER_TARGET|ln.STORAGE_TEXTURE|ln.SAMPLED_TEXTURE|ln.LINEAR_FILTER|ln.VERTEX_ATTRIBUTE,this._formatFeatures[Zi.R8I]=e,this._formatFeatures[Zi.R8UI]=e,this._formatFeatures[Zi.R16I]=e,this._formatFeatures[Zi.R16UI]=e,this._formatFeatures[Zi.R32I]=e,this._formatFeatures[Zi.R32UI]=e,this._formatFeatures[Zi.RG8I]=e,this._formatFeatures[Zi.RG8UI]=e,this._formatFeatures[Zi.RG16I]=e,this._formatFeatures[Zi.RG16UI]=e,this._formatFeatures[Zi.RG32I]=e,this._formatFeatures[Zi.RG32UI]=e,this._formatFeatures[Zi.RGB8I]=e,this._formatFeatures[Zi.RGB8UI]=e,this._formatFeatures[Zi.RGB16I]=e,this._formatFeatures[Zi.RGB16UI]=e,this._formatFeatures[Zi.RGB32I]=e,this._formatFeatures[Zi.RGB32UI]=e,this._formatFeatures[Zi.RGBA8I]=e,this._formatFeatures[Zi.RGBA8UI]=e,this._formatFeatures[Zi.RGBA16I]=e,this._formatFeatures[Zi.RGBA16UI]=e,this._formatFeatures[Zi.RGBA32I]=e,this._formatFeatures[Zi.RGBA32UI]=e,this._textureExclusive[Zi.R8]=!1,this._textureExclusive[Zi.RG8]=!1,this._textureExclusive[Zi.RGB8]=!1,this._textureExclusive[Zi.R5G6B5]=!1,this._textureExclusive[Zi.RGBA4]=!1,this._textureExclusive[Zi.RGB5A1]=!1,this._textureExclusive[Zi.RGBA8]=!1,this._textureExclusive[Zi.RGB10A2]=!1,this._textureExclusive[Zi.RGB10A2UI]=!1,this._textureExclusive[Zi.SRGB8_A8]=!1,this._textureExclusive[Zi.R8I]=!1,this._textureExclusive[Zi.R8UI]=!1,this._textureExclusive[Zi.R16I]=!1,this._textureExclusive[Zi.R16UI]=!1,this._textureExclusive[Zi.R32I]=!1,this._textureExclusive[Zi.R32UI]=!1,this._textureExclusive[Zi.RG8I]=!1,this._textureExclusive[Zi.RG8UI]=!1,this._textureExclusive[Zi.RG16I]=!1,this._textureExclusive[Zi.RG16UI]=!1,this._textureExclusive[Zi.RG32I]=!1,this._textureExclusive[Zi.RG32UI]=!1,this._textureExclusive[Zi.RGBA8I]=!1,this._textureExclusive[Zi.RGBA8UI]=!1,this._textureExclusive[Zi.RGBA16I]=!1,this._textureExclusive[Zi.RGBA16UI]=!1,this._textureExclusive[Zi.RGBA32I]=!1,this._textureExclusive[Zi.RGBA32UI]=!1,this._textureExclusive[Zi.DEPTH]=!1,this._textureExclusive[Zi.DEPTH_STENCIL]=!1,t.EXT_color_buffer_float&&(this._formatFeatures[Zi.R32F]|=ln.RENDER_TARGET,this._formatFeatures[Zi.RG32F]|=ln.RENDER_TARGET,this._formatFeatures[Zi.RGBA32F]|=ln.RENDER_TARGET,this._textureExclusive[Zi.R32F]=!1,this._textureExclusive[Zi.RG32F]=!1,this._textureExclusive[Zi.RGBA32F]=!1),t.EXT_color_buffer_half_float&&(this._textureExclusive[Zi.R16F]=!1,this._textureExclusive[Zi.RG16F]=!1,this._textureExclusive[Zi.RGBA16F]=!1),t.OES_texture_float_linear&&(this._formatFeatures[Zi.RGB32F]|=ln.LINEAR_FILTER,this._formatFeatures[Zi.RGBA32F]|=ln.LINEAR_FILTER,this._formatFeatures[Zi.R32F]|=ln.LINEAR_FILTER,this._formatFeatures[Zi.RG32F]|=ln.LINEAR_FILTER),t.OES_texture_half_float_linear&&(this._formatFeatures[Zi.RGB16F]|=ln.LINEAR_FILTER,this._formatFeatures[Zi.RGBA16F]|=ln.LINEAR_FILTER,this._formatFeatures[Zi.R16F]|=ln.LINEAR_FILTER,this._formatFeatures[Zi.RG16F]|=ln.LINEAR_FILTER);const i=ln.SAMPLED_TEXTURE|ln.LINEAR_FILTER;t.WEBGL_compressed_texture_etc1&&(this._formatFeatures[Zi.ETC_RGB8]=i),t.WEBGL_compressed_texture_etc&&(this._formatFeatures[Zi.ETC2_RGB8]=i,this._formatFeatures[Zi.ETC2_RGBA8]=i,this._formatFeatures[Zi.ETC2_SRGB8]=i,this._formatFeatures[Zi.ETC2_SRGB8_A8]=i,this._formatFeatures[Zi.ETC2_RGB8_A1]=i,this._formatFeatures[Zi.ETC2_SRGB8_A1]=i),t.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[Zi.BC1]=i,this._formatFeatures[Zi.BC1_ALPHA]=i,this._formatFeatures[Zi.BC1_SRGB]=i,this._formatFeatures[Zi.BC1_SRGB_ALPHA]=i,this._formatFeatures[Zi.BC2]=i,this._formatFeatures[Zi.BC2_SRGB]=i,this._formatFeatures[Zi.BC3]=i,this._formatFeatures[Zi.BC3_SRGB]=i),t.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[Zi.PVRTC_RGB2]=i,this._formatFeatures[Zi.PVRTC_RGBA2]=i,this._formatFeatures[Zi.PVRTC_RGB4]=i,this._formatFeatures[Zi.PVRTC_RGBA4]=i),t.WEBGL_compressed_texture_astc&&(this._formatFeatures[Zi.ASTC_RGBA_4X4]=i,this._formatFeatures[Zi.ASTC_RGBA_5X4]=i,this._formatFeatures[Zi.ASTC_RGBA_5X5]=i,this._formatFeatures[Zi.ASTC_RGBA_6X5]=i,this._formatFeatures[Zi.ASTC_RGBA_6X6]=i,this._formatFeatures[Zi.ASTC_RGBA_8X5]=i,this._formatFeatures[Zi.ASTC_RGBA_8X6]=i,this._formatFeatures[Zi.ASTC_RGBA_8X8]=i,this._formatFeatures[Zi.ASTC_RGBA_10X5]=i,this._formatFeatures[Zi.ASTC_RGBA_10X6]=i,this._formatFeatures[Zi.ASTC_RGBA_10X8]=i,this._formatFeatures[Zi.ASTC_RGBA_10X10]=i,this._formatFeatures[Zi.ASTC_RGBA_12X10]=i,this._formatFeatures[Zi.ASTC_RGBA_12X12]=i,this._formatFeatures[Zi.ASTC_SRGBA_4X4]=i,this._formatFeatures[Zi.ASTC_SRGBA_5X4]=i,this._formatFeatures[Zi.ASTC_SRGBA_5X5]=i,this._formatFeatures[Zi.ASTC_SRGBA_6X5]=i,this._formatFeatures[Zi.ASTC_SRGBA_6X6]=i,this._formatFeatures[Zi.ASTC_SRGBA_8X5]=i,this._formatFeatures[Zi.ASTC_SRGBA_8X6]=i,this._formatFeatures[Zi.ASTC_SRGBA_8X8]=i,this._formatFeatures[Zi.ASTC_SRGBA_10X5]=i,this._formatFeatures[Zi.ASTC_SRGBA_10X6]=i,this._formatFeatures[Zi.ASTC_SRGBA_10X8]=i,this._formatFeatures[Zi.ASTC_SRGBA_10X10]=i,this._formatFeatures[Zi.ASTC_SRGBA_12X10]=i,this._formatFeatures[Zi.ASTC_SRGBA_12X12]=i)}createCommandBuffer(t){const e=new(t.type===Bn.PRIMARY?Z2:W2);return e.initialize(t),e}createSwapchain(t){const e=new c4;return this._swapchain=e,e.initialize(t),e}createBuffer(t){const e=new k2;return e.initialize(t),e}createTexture(t){const e=new s4;return e.initialize(t),e}createDescriptorSet(t){const e=new l2;return e.initialize(t),e}createShader(t){const e=new i4;return e.initialize(t),e}createInputAssembler(t){const e=new X2;return e.initialize(t),e}createRenderPass(t){const e=new t4;return e.initialize(t),e}createFramebuffer(t){const e=new q2;return e.initialize(t),e}createDescriptorSetLayout(t){const e=new Y2;return e.initialize(t),e}createPipelineLayout(t){const e=new K2;return e.initialize(t),e}createPipelineState(t){const e=new $2;return e.initialize(t),e}createQueue(t){const e=new Q2;return e.initialize(t),e}getSampler(t){const e=xr.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new e4(t,e)),this._samplers.get(e)}getGeneralBarrier(t){const e=Sr.computeHash(t);return this._generalBarrierss.has(e)||this._generalBarrierss.set(e,new Sr(t,e)),this._generalBarrierss.get(e)}getTextureBarrier(t){const e=Cr.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new Cr(t,e)),this._textureBarriers.get(e)}copyBuffersToTexture(t,e,i){G2(this,t,e.gpuTexture,i)}copyTextureToBuffers(t,e,i){!function(t,e,i,n){const{gl:s}=t,r=t.stateCache,o=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,o);let a=0,c=0,l=1,h=1;switch(e.glTarget){case s.TEXTURE_2D:for(let t=0;t<n.length;t++){const r=n[t];s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,r.texSubres.mipLevel),a=r.texOffset.x,c=r.texOffset.y,l=r.texExtent.width,h=r.texExtent.height,s.readPixels(a,c,l,h,e.glFormat,e.glType,i[t])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}s.bindFramebuffer(s.FRAMEBUFFER,null),r.glFramebuffer=null,s.deleteFramebuffer(o)}(this,t.gpuTexture,e,i)}copyTexImagesToTexture(t,e,i){!function(t,e,i,n){const{gl:s}=t,r=t.stateCache.glTexUnits[t.stateCache.texUnit];r.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),r.glTexture=i.glTexture);let o=0,a=0;switch(i.glTarget){case s.TEXTURE_2D:for(let t=0;t<n.length;t++){const r=n[t];s.texSubImage2D(s.TEXTURE_2D,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,i.glFormat,i.glType,e[o++])}break;case s.TEXTURE_CUBE_MAP:for(let t=0;t<n.length;t++){const r=n[t],c=r.texSubres.baseArrayLayer+r.texSubres.layerCount;for(a=r.texSubres.baseArrayLayer;a<c;++a)s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,i.glFormat,i.glType,e[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&cn.GEN_MIPMAP&&s.generateMipmap(i.glTarget)}(this,t,e.gpuTexture,i)}}function h4(t,e,i,n){const s=(n.x-i.x)*(t.y-i.y)-(n.y-i.y)*(t.x-i.x),r=(e.x-t.x)*(t.y-i.y)-(e.y-t.y)*(t.x-i.x),o=(n.y-i.y)*(e.x-t.x)-(n.x-i.x)*(e.y-t.y);if(0!==o){const t=s/o,e=r/o;if(t>=0&&t<=1&&e>=0&&e<=1)return!0}return!1}t("WebGL2Device",l4),l.WebGL2Device=l4;const _4=new Oi,u4=new Oi,d4=new Oi,m4=new Oi;function p4(t,e,i){const n=i.length;for(let s=0;s<n;++s)if(h4(t,e,i[s],i[(s+1)%n]))return!0;return!1}function f4(t,e){let i=!1;const n=t.x,s=t.y,r=e.length;for(let t=0,o=r-1;t<r;o=t++){const r=e[t].x,a=e[t].y,c=e[o].x,l=e[o].y;a>s!=l>s&&n<(c-r)*(s-a)/(l-a)+r&&(i=!i)}return i}function g4(t,e,i,n){let s=i.x-e.x,r=i.y-e.y;const o=s*s+r*r,a=((t.x-e.x)*s+(t.y-e.y)*r)/o;let c;return c=n?o?a<0?e:a>1?i:_4.set(e.x+a*s,e.y+a*r):e:_4.set(e.x+a*s,e.y+a*r),s=t.x-c.x,r=t.y-c.y,Math.sqrt(s*s+r*r)}class v4{}t("Intersection2D",v4),v4.lineLine=h4,v4.lineRect=function(t,e,i){const n=_4.set(i.x,i.y),s=u4.set(i.x,i.yMax),r=d4.set(i.xMax,i.yMax),o=m4.set(i.xMax,i.y);return!!(h4(t,e,n,s)||h4(t,e,s,r)||h4(t,e,r,o)||h4(t,e,o,n))},v4.linePolygon=p4,v4.rectRect=function(t,e){const i=t.x,n=t.y,s=t.x+t.width,r=t.y+t.height,o=e.x,a=e.y,c=e.x+e.width,l=e.y+e.height;return i<=c&&s>=o&&n<=l&&r>=a},v4.rectPolygon=function(t,e){const i=_4.set(t.x,t.y),n=u4.set(t.x,t.yMax),s=d4.set(t.xMax,t.yMax),r=m4.set(t.xMax,t.y);if(p4(i,n,e))return!0;if(p4(n,s,e))return!0;if(p4(s,r,e))return!0;if(p4(r,i,e))return!0;for(let i=0,n=e.length;i<n;++i)if(t.contains(e[i]))return!0;return!!(f4(i,e)||f4(n,e)||f4(s,e)||f4(r,e))},v4.rectCircle=function(t,e,i){const n=e.x,s=e.y,r=t.x,o=t.y,a=t.width,c=t.height;let l=n,h=s;n<r?l=r:n>r+a&&(l=r+a),s<o?h=o:s>o+c&&(h=o+c);const _=n-l,u=s-h;return Math.sqrt(_*_+u*u)<=i},v4.polygonPolygon=function(t,e){let i,n;for(i=0,n=t.length;i<n;++i)if(p4(t[i],t[(i+1)%n],e))return!0;for(i=0,n=e.length;i<n;++i)if(f4(e[i],t))return!0;for(i=0,n=t.length;i<n;++i)if(f4(t[i],e))return!0;return!1},v4.circleCircle=function(t,e,i,n){return Oi.distance(t,i)<e+n},v4.polygonCircle=function(t,e,i){const n=e;if(f4(n,t))return!0;for(let e=0,s=t.length;e<s;e++)if(g4(n,0===e?t[t.length-1]:t[e-1],t[e],!0)<i)return!0;return!1},v4.pointInPolygon=f4,v4.pointLineDistance=g4;const y4=jt({GRAVITY:0,RADIUS:1}),x4=jt({FREE:0,RELATIVE:1,GROUPED:2}),S4=new Oi(0,0),C4=new Oi,A4=new Oi,b4=new Oi,T4=new Oi,E4=HM(UM);class P4{constructor(){this.pos=new Oi(0,0),this.startPos=new Oi(0,0),this.color=new hi(0,0,0,255),this.deltaColor={r:0,g:0,b:0,a:255},this.size=0,this.deltaSize=0,this.rotation=0,this.deltaRotation=0,this.timeToLive=0,this.drawPos=new Oi(0,0),this.aspectRatio=1,this.dir=new Oi(0,0),this.radialAccel=0,this.tangentialAccel=0,this.angle=0,this.degreesPerSecond=0,this.radius=0,this.deltaRadius=0}}const w4=new class extends Vt{get(){return this._get()||new P4}}((t=>{t.pos.set(S4),t.startPos.set(S4),t.color._val=4278190080,t.deltaColor.r=t.deltaColor.g=t.deltaColor.b=0,t.deltaColor.a=255,t.size=0,t.deltaSize=0,t.rotation=0,t.deltaRotation=0,t.timeToLive=0,t.drawPos.set(S4),t.aspectRatio=1,t.dir.set(S4),t.radialAccel=0,t.tangentialAccel=0,t.angle=0,t.degreesPerSecond=0,t.radius=0,t.deltaRadius=0}),1024);class I4{constructor(t){this.particles=[],this.active=!1,this.uvFilled=0,this.finished=!1,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this._worldRotation=0,this.sys=t,this.particles=[],this.active=!1,this.readyToPlay=!0,this.finished=!1,this.elapsed=0,this.emitCounter=0,this.uvFilled=0,this._worldRotation=0}stop(){this.active=!1,this.readyToPlay=!1,this.elapsed=this.sys.duration,this.emitCounter=0}reset(){this.active=!0,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this.finished=!1;const t=this.particles;for(let e=0;e<t.length;++e)w4.put(t[e]);t.length=0}emitParticle(t){const e=this.sys,i=w4.get();this.particles.push(i),i.timeToLive=e.life+e.lifeVar*(Math.random()-.5)*2;const n=i.timeToLive=Math.max(0,i.timeToLive);i.pos.x=e.sourcePos.x+e.posVar.x*(Math.random()-.5)*2,i.pos.y=e.sourcePos.y+e.posVar.y*(Math.random()-.5)*2;let s=0,r=0,o=0,a=0;const c=e.startColor,l=e.startColorVar,h=e.endColor,_=e.endColorVar;i.color.r=s=re(c.r+l.r*(Math.random()-.5)*2,0,255),i.color.g=r=re(c.g+l.g*(Math.random()-.5)*2,0,255),i.color.b=o=re(c.b+l.b*(Math.random()-.5)*2,0,255),i.color.a=a=re(c.a+l.a*(Math.random()-.5)*2,0,255),i.deltaColor.r=(re(h.r+_.r*(Math.random()-.5)*2,0,255)-s)/n,i.deltaColor.g=(re(h.g+_.g*(Math.random()-.5)*2,0,255)-r)/n,i.deltaColor.b=(re(h.b+_.b*(Math.random()-.5)*2,0,255)-o)/n,i.deltaColor.a=(re(h.a+_.a*(Math.random()-.5)*2,0,255)-a)/n;let u=e.startSize+e.startSizeVar*(Math.random()-.5)*2;if(u=Math.max(0,u),i.size=u,-1===e.endSize)i.deltaSize=0;else{let t=e.endSize+e.endSizeVar*(Math.random()-.5)*2;t=Math.max(0,t),i.deltaSize=(t-u)/n}const d=e.startSpin+e.startSpinVar*(Math.random()-.5)*2,m=e.endSpin+e.endSpinVar*(Math.random()-.5)*2;i.rotation=d,i.deltaRotation=(m-d)/n,i.startPos.x=t.x,i.startPos.y=t.y,i.aspectRatio=e.aspectRatio||1;const p=oe(e.angle+this._worldRotation+e.angleVar*(Math.random()-.5)*2);if(e.emitterMode===y4.GRAVITY){const t=e.speed+e.speedVar*(Math.random()-.5)*2;i.dir.x=Math.cos(p),i.dir.y=Math.sin(p),i.dir.multiplyScalar(t),i.radialAccel=e.radialAccel+e.radialAccelVar*(Math.random()-.5)*2,i.tangentialAccel=e.tangentialAccel+e.tangentialAccelVar*(Math.random()-.5)*2,e.rotationIsDir&&(i.rotation=-ae(Math.atan2(i.dir.y,i.dir.x)))}else{const t=e.startRadius+e.startRadiusVar*(Math.random()-.5)*2,s=e.endRadius+e.endRadiusVar*(Math.random()-.5)*2;i.radius=t,i.deltaRadius=-1===e.endRadius?0:(s-t)/n,i.angle=p,i.degreesPerSecond=oe(e.rotatePerS+e.rotatePerSVar*(Math.random()-.5)*2)}}updateUVs(t){const e=this.renderData;if(e&&this.sys._renderSpriteFrame){const i=e.vData,n=this.sys._renderSpriteFrame.uv,s=t?0:this.uvFilled,r=this.particles.length;for(let t=s;t<r;t++){const e=t*E4*4;i[e+3]=n[0],i[e+4]=n[1],i[e+12]=n[2],i[e+13]=n[3],i[e+21]=n[4],i[e+22]=n[5],i[e+30]=n[6],i[e+31]=n[7]}this.uvFilled=r}}updateParticleBuffer(t,e,i,n){const s=i.vData,r=e.x,o=e.y;let a=t.size,c=a;const l=t.aspectRatio;l>1?c=a/l:a=c*l;const h=a/2,_=c/2;if(t.rotation){const e=-h,i=-_,a=h,c=_,l=-oe(t.rotation),u=Math.cos(l),d=Math.sin(l);s[n]=e*u-i*d+r,s[n+1]=e*d+i*u+o,s[n+2]=0,s[n+9]=a*u-i*d+r,s[n+10]=a*d+i*u+o,s[n+11]=0,s[n+18]=e*u-c*d+r,s[n+19]=e*d+c*u+o,s[n+20]=0,s[n+27]=a*u-c*d+r,s[n+28]=a*d+c*u+o,s[n+29]=0}else s[n]=r-h,s[n+1]=o-_,s[n+2]=0,s[n+9]=r+h,s[n+10]=o-_,s[n+11]=0,s[n+18]=r-h,s[n+19]=o+_,s[n+20]=0,s[n+27]=r+h,s[n+28]=o+_,s[n+29]=0;hi.toArray(s,t.color,n+5),hi.toArray(s,t.color,n+14),hi.toArray(s,t.color,n+23),hi.toArray(s,t.color,n+32)}step(t){const e=this.sys.assembler,i=this.sys,n=i.node,s=this.particles;if(t=t>e.maxParticleDeltaTime?e.maxParticleDeltaTime:t,n.updateWorldTransform(),i.positionType===x4.FREE){this._worldRotation=function(t){let e=0,i=t;for(;i;)e+=i.eulerAngles.z,i=i.parent;return e}(n);const t=n.worldMatrix;C4.x=t.m12,C4.y=t.m13}else i.positionType===x4.RELATIVE?(this._worldRotation=n.eulerAngles.z,C4.x=n.position.x,C4.y=n.position.y):this._worldRotation=0;if(this.active&&i.emissionRate){const e=1/i.emissionRate;for(s.length<i.totalParticles&&(this.emitCounter+=t);s.length<i.totalParticles&&this.emitCounter>e;)this.emitParticle(C4),this.emitCounter-=e;this.elapsed+=t,-1!==i.duration&&i.duration<this.elapsed&&i.stopSystem()}const r=this.renderData,o=s.length;r.reset(),this.requestData(4*o,6*o),o>this.uvFilled&&this.updateUVs();let a=0;for(;a<s.length;){A4.x=A4.y=b4.x=b4.y=T4.x=T4.y=0;const e=s[a];if(e.timeToLive-=t,e.timeToLive>0){if(i.emitterMode===y4.GRAVITY){const n=T4,s=A4,r=b4;(e.pos.x||e.pos.y)&&(s.set(e.pos),s.normalize()),r.set(s),s.multiplyScalar(e.radialAccel);const o=r.x;r.x=-r.y,r.y=o,r.multiplyScalar(e.tangentialAccel),n.set(s),n.add(r),n.add(i.gravity),n.multiplyScalar(t),e.dir.add(n),n.set(e.dir),n.multiplyScalar(t),e.pos.add(n)}else e.angle+=e.degreesPerSecond*t,e.radius+=e.deltaRadius*t,e.pos.x=-Math.cos(e.angle)*e.radius,e.pos.y=-Math.sin(e.angle)*e.radius;e.color.r+=e.deltaColor.r*t,e.color.g+=e.deltaColor.g*t,e.color.b+=e.deltaColor.b*t,e.color.a+=e.deltaColor.a*t,e.size+=e.deltaSize*t,e.size<0&&(e.size=0),e.rotation+=e.deltaRotation*t;const n=A4;n.set(e.pos),i.positionType!==x4.GROUPED&&n.add(e.startPos);const s=E4*a*4;this.updateParticleBuffer(e,n,r,s),++a}else{const t=s[a];a!==s.length-1&&(s[a]=s[s.length-1]),w4.put(t),s.length--,r.resize(r.vertexCount-4,r.indexCount-6)}}0!==s.length||this.active||this.readyToPlay||(this.finished=!0,i._finishedSimulation())}requestData(t,e){let i=this.renderData.indexCount;this.renderData.request(t,e);const n=this.renderData.indexCount/6,s=this.renderData.iData;for(let t=i;t<n;t++){const e=4*t;s[i++]=e,s[i++]=e+1,s[i++]=e+2,s[i++]=e+1,s[i++]=e+3,s[i++]=e+2}}}var R4,D4,M4;let O4=t("ParticleAsset",dc("cc.ParticleAsset")((M4=sc((D4=class extends fh{constructor(...t){super(...t),nc(this,"spriteFrame",M4,this)}}).prototype,"spriteFrame",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),R4=D4))||R4);l.ParticleAsset=O4;
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
var B4={};(function(){function t(t){throw t}var e=void 0,i=!0,n=this;function s(t,i){var s,r=t.split("."),o=n;!(r[0]in o)&&o.execScript&&o.execScript("var "+r[0]);for(;r.length&&(s=r.shift());)r.length||i===e?o=o[s]?o[s]:o[s]={}:o[s]=i}var r="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array;function o(t){if("string"==typeof t){var e,i,n=t.split("");for(e=0,i=n.length;e<i;e++)n[e]=(255&n[e].charCodeAt(0))>>>0;t=n}for(var s,r=1,o=0,a=t.length,c=0;0<a;){a-=s=1024<a?1024:a;do{o+=r+=t[c++]}while(--s);r%=65521,o%=65521}return(o<<16|r)>>>0}function a(e,i){this.index="number"==typeof i?i:0,this.i=0,this.buffer=e instanceof(r?Uint8Array:Array)?e:new(r?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&t(Error("invalid index")),this.buffer.length<=this.index&&this.f()}a.prototype.f=function(){var t,e=this.buffer,i=e.length,n=new(r?Uint8Array:Array)(i<<1);if(r)n.set(e);else for(t=0;t<i;++t)n[t]=e[t];return this.buffer=n},a.prototype.d=function(t,e,i){var n,s=this.buffer,r=this.index,o=this.i,a=s[r];if(i&&1<e&&(t=8<e?(d[255&t]<<24|d[t>>>8&255]<<16|d[t>>>16&255]<<8|d[t>>>24&255])>>32-e:d[t]>>8-e),8>e+o)a=a<<e|t,o+=e;else for(n=0;n<e;++n)a=a<<1|t>>e-n-1&1,8==++o&&(o=0,s[r++]=d[a],a=0,r===s.length&&(s=this.f()));s[r]=a,this.buffer=s,this.i=o,this.index=r},a.prototype.finish=function(){var t,e=this.buffer,i=this.index;return 0<this.i&&(e[i]<<=8-this.i,e[i]=d[e[i]],i++),r?t=e.subarray(0,i):(e.length=i,t=e),t};var c,l=new(r?Uint8Array:Array)(256);for(c=0;256>c;++c){for(var h=u=c,_=7,u=u>>>1;u;u>>>=1)h<<=1,h|=1&u,--_;l[c]=(h<<_&255)>>>0}var d=l;function m(t){this.buffer=new(r?Uint16Array:Array)(2*t),this.length=0}function p(t){var e,i,n,s,o,a,c,l,h,_=t.length,u=0,d=Number.POSITIVE_INFINITY;for(l=0;l<_;++l)t[l]>u&&(u=t[l]),t[l]<d&&(d=t[l]);for(e=1<<u,i=new(r?Uint32Array:Array)(e),n=1,s=0,o=2;n<=u;){for(l=0;l<_;++l)if(t[l]===n){for(a=0,c=s,h=0;h<n;++h)a=a<<1|1&c,c>>=1;for(h=a;h<e;h+=o)i[h]=n<<16|l;++s}++n,s<<=1,o<<=1}return[i,u,d]}function f(t,e){this.h=v,this.w=0,this.input=t,this.b=0,e&&(e.lazy&&(this.w=e.lazy),"number"==typeof e.compressionType&&(this.h=e.compressionType),e.outputBuffer&&(this.a=r&&e.outputBuffer instanceof Array?new Uint8Array(e.outputBuffer):e.outputBuffer),"number"==typeof e.outputIndex&&(this.b=e.outputIndex)),this.a||(this.a=new(r?Uint8Array:Array)(32768))}m.prototype.getParent=function(t){return 2*((t-2)/4|0)},m.prototype.push=function(t,e){var i,n,s,r=this.buffer;for(i=this.length,r[this.length++]=e,r[this.length++]=t;0<i&&(n=this.getParent(i),r[i]>r[n]);)s=r[i],r[i]=r[n],r[n]=s,s=r[i+1],r[i+1]=r[n+1],r[n+1]=s,i=n;return this.length},m.prototype.pop=function(){var t,e,i,n,s,r=this.buffer;for(e=r[0],t=r[1],this.length-=2,r[0]=r[this.length],r[1]=r[this.length+1],s=0;!((n=2*s+2)>=this.length)&&(n+2<this.length&&r[n+2]>r[n]&&(n+=2),r[n]>r[s]);)i=r[s],r[s]=r[n],r[n]=i,i=r[s+1],r[s+1]=r[n+1],r[n+1]=i,s=n;return{index:t,value:e,length:this.length}};var g,v=2,y={NONE:0,r:1,j:v,N:3},x=[];for(g=0;288>g;g++)switch(i){case 143>=g:x.push([g+48,8]);break;case 255>=g:x.push([g-144+400,9]);break;case 279>=g:x.push([g-256+0,7]);break;case 287>=g:x.push([g-280+192,8]);break;default:t("invalid literal: "+g)}function S(t,e){this.length=t,this.G=e}function C(){var e=A;switch(i){case 3===e:return[257,e-3,0];case 4===e:return[258,e-4,0];case 5===e:return[259,e-5,0];case 6===e:return[260,e-6,0];case 7===e:return[261,e-7,0];case 8===e:return[262,e-8,0];case 9===e:return[263,e-9,0];case 10===e:return[264,e-10,0];case 12>=e:return[265,e-11,1];case 14>=e:return[266,e-13,1];case 16>=e:return[267,e-15,1];case 18>=e:return[268,e-17,1];case 22>=e:return[269,e-19,2];case 26>=e:return[270,e-23,2];case 30>=e:return[271,e-27,2];case 34>=e:return[272,e-31,2];case 42>=e:return[273,e-35,3];case 50>=e:return[274,e-43,3];case 58>=e:return[275,e-51,3];case 66>=e:return[276,e-59,3];case 82>=e:return[277,e-67,4];case 98>=e:return[278,e-83,4];case 114>=e:return[279,e-99,4];case 130>=e:return[280,e-115,4];case 162>=e:return[281,e-131,5];case 194>=e:return[282,e-163,5];case 226>=e:return[283,e-195,5];case 257>=e:return[284,e-227,5];case 258===e:return[285,e-258,0];default:t("invalid length: "+e)}}f.prototype.n=function(){var n,s,o,c,l=this.input;switch(this.h){case 0:for(o=0,c=l.length;o<c;){var h,_,u,d=s=r?l.subarray(o,o+65535):l.slice(o,o+65535),m=(o+=s.length)===c,p=e,f=e,g=this.a,y=this.b;if(r){for(g=new Uint8Array(this.a.buffer);g.length<=y+d.length+5;)g=new Uint8Array(g.length<<1);g.set(this.a)}if(h=m?1:0,g[y++]=0|h,u=65536+~(_=d.length)&65535,g[y++]=255&_,g[y++]=_>>>8&255,g[y++]=255&u,g[y++]=u>>>8&255,r)g.set(d,y),y+=d.length,g=g.subarray(0,y);else{for(p=0,f=d.length;p<f;++p)g[y++]=d[p];g.length=y}this.b=y,this.a=g}break;case 1:var S=new a(new Uint8Array(this.a.buffer),this.b);S.d(1,1,i),S.d(1,2,i);var C,A,b,T=P(this,l);for(C=0,A=T.length;C<A;C++)if(b=T[C],a.prototype.d.apply(S,x[b]),256<b)S.d(T[++C],T[++C],i),S.d(T[++C],5),S.d(T[++C],T[++C],i);else if(256===b)break;this.a=S.finish(),this.b=this.a.length;break;case v:var E,R,D,M,O,B,N,L,F,z,V,G,U,k,H,j=new a(new Uint8Array(this.a),this.b),W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],q=Array(19);for(E=v,j.d(1,1,i),j.d(E,2,i),R=P(this,l),N=I(B=w(this.L,15)),F=I(L=w(this.K,7)),D=286;257<D&&0===B[D-1];D--);for(M=30;1<M&&0===L[M-1];M--);var X,Y,K,J,$,Z,Q=D,tt=M,et=new(r?Uint32Array:Array)(Q+tt),it=new(r?Uint32Array:Array)(316),nt=new(r?Uint8Array:Array)(19);for(X=Y=0;X<Q;X++)et[Y++]=B[X];for(X=0;X<tt;X++)et[Y++]=L[X];if(!r)for(X=0,J=nt.length;X<J;++X)nt[X]=0;for(X=$=0,J=et.length;X<J;X+=Y){for(Y=1;X+Y<J&&et[X+Y]===et[X];++Y);if(K=Y,0===et[X])if(3>K)for(;0<K--;)it[$++]=0,nt[0]++;else for(;0<K;)(Z=138>K?K:138)>K-3&&Z<K&&(Z=K-3),10>=Z?(it[$++]=17,it[$++]=Z-3,nt[17]++):(it[$++]=18,it[$++]=Z-11,nt[18]++),K-=Z;else if(it[$++]=et[X],nt[et[X]]++,3>--K)for(;0<K--;)it[$++]=et[X],nt[et[X]]++;else for(;0<K;)(Z=6>K?K:6)>K-3&&Z<K&&(Z=K-3),it[$++]=16,it[$++]=Z-3,nt[16]++,K-=Z}for(n=r?it.subarray(0,$):it.slice(0,$),z=w(nt,7),k=0;19>k;k++)q[k]=z[W[k]];for(O=19;4<O&&0===q[O-1];O--);for(V=I(z),j.d(D-257,5,i),j.d(M-1,5,i),j.d(O-4,4,i),k=0;k<O;k++)j.d(q[k],3,i);for(k=0,H=n.length;k<H;k++)if(G=n[k],j.d(V[G],z[G],i),16<=G){switch(k++,G){case 16:U=2;break;case 17:U=3;break;case 18:U=7;break;default:t("invalid code: "+G)}j.d(n[k],U,i)}var st,rt,ot,at,ct,lt,ht,_t,ut=[N,B],dt=[F,L];for(ct=ut[0],lt=ut[1],ht=dt[0],_t=dt[1],st=0,rt=R.length;st<rt;++st)if(ot=R[st],j.d(ct[ot],lt[ot],i),256<ot)j.d(R[++st],R[++st],i),at=R[++st],j.d(ht[at],_t[at],i),j.d(R[++st],R[++st],i);else if(256===ot)break;this.a=j.finish(),this.b=this.a.length;break;default:t("invalid compression type")}return this.a};var A,b,T=[];for(A=3;258>=A;A++)b=C(),T[A]=b[2]<<24|b[1]<<16|b[0];var E=r?new Uint32Array(T):T;function P(n,s){function o(e,n){var s,r,o,a,c=e.G,l=[],h=0;switch(s=E[e.length],l[h++]=65535&s,l[h++]=s>>16&255,l[h++]=s>>24,i){case 1===c:r=[0,c-1,0];break;case 2===c:r=[1,c-2,0];break;case 3===c:r=[2,c-3,0];break;case 4===c:r=[3,c-4,0];break;case 6>=c:r=[4,c-5,1];break;case 8>=c:r=[5,c-7,1];break;case 12>=c:r=[6,c-9,2];break;case 16>=c:r=[7,c-13,2];break;case 24>=c:r=[8,c-17,3];break;case 32>=c:r=[9,c-25,3];break;case 48>=c:r=[10,c-33,4];break;case 64>=c:r=[11,c-49,4];break;case 96>=c:r=[12,c-65,5];break;case 128>=c:r=[13,c-97,5];break;case 192>=c:r=[14,c-129,6];break;case 256>=c:r=[15,c-193,6];break;case 384>=c:r=[16,c-257,7];break;case 512>=c:r=[17,c-385,7];break;case 768>=c:r=[18,c-513,8];break;case 1024>=c:r=[19,c-769,8];break;case 1536>=c:r=[20,c-1025,9];break;case 2048>=c:r=[21,c-1537,9];break;case 3072>=c:r=[22,c-2049,10];break;case 4096>=c:r=[23,c-3073,10];break;case 6144>=c:r=[24,c-4097,11];break;case 8192>=c:r=[25,c-6145,11];break;case 12288>=c:r=[26,c-8193,12];break;case 16384>=c:r=[27,c-12289,12];break;case 24576>=c:r=[28,c-16385,13];break;case 32768>=c:r=[29,c-24577,13];break;default:t("invalid distance")}for(s=r,l[h++]=s[0],l[h++]=s[1],l[h++]=s[2],o=0,a=l.length;o<a;++o)g[v++]=l[o];x[l[0]]++,C[l[3]]++,y=e.length+n-1,m=null}var a,c,l,h,_,u,d,m,p,f={},g=r?new Uint16Array(2*s.length):[],v=0,y=0,x=new(r?Uint32Array:Array)(286),C=new(r?Uint32Array:Array)(30),A=n.w;if(!r){for(l=0;285>=l;)x[l++]=0;for(l=0;29>=l;)C[l++]=0}for(x[256]=1,a=0,c=s.length;a<c;++a){for(l=_=0,h=3;l<h&&a+l!==c;++l)_=_<<8|s[a+l];if(f[_]===e&&(f[_]=[]),u=f[_],!(0<y--)){for(;0<u.length&&32768<a-u[0];)u.shift();if(a+3>=c){for(m&&o(m,-1),l=0,h=c-a;l<h;++l)p=s[a+l],g[v++]=p,++x[p];break}if(0<u.length){var b=e,T=e,P=0,w=e,I=e,R=e,D=s.length,M=(I=0,u.length);t:for(;I<M;I++){if(b=u[M-I-1],w=3,3<P){for(R=P;3<R;R--)if(s[b+R-1]!==s[a+R-1])continue t;w=P}for(;258>w&&a+w<D&&s[b+w]===s[a+w];)++w;if(w>P&&(T=b,P=w),258===w)break}d=new S(P,a-T),m?m.length<d.length?(p=s[a-1],g[v++]=p,++x[p],o(d,0)):o(m,-1):d.length<A?m=d:o(d,0)}else m?o(m,-1):(p=s[a],g[v++]=p,++x[p])}u.push(a)}return g[v++]=256,x[256]++,n.L=x,n.K=C,r?g.subarray(0,v):g}function w(t,e){function i(t){var e=A[t][b[t]];e===v?(i(t+1),i(t+1)):--S[e],++b[t]}var n,s,o,a,c,l=t.length,h=new m(572),_=new(r?Uint8Array:Array)(l);if(!r)for(a=0;a<l;a++)_[a]=0;for(a=0;a<l;++a)0<t[a]&&h.push(a,t[a]);if(n=Array(h.length/2),s=new(r?Uint32Array:Array)(h.length/2),1===n.length)return _[h.pop().index]=1,_;for(a=0,c=h.length/2;a<c;++a)n[a]=h.pop(),s[a]=n[a].value;var u,d,p,f,g,v=s.length,y=new(r?Uint16Array:Array)(e),x=new(r?Uint8Array:Array)(e),S=new(r?Uint8Array:Array)(v),C=Array(e),A=Array(e),b=Array(e),T=(1<<e)-v,E=1<<e-1;for(y[e-1]=v,d=0;d<e;++d)T<E?x[d]=0:(x[d]=1,T-=E),T<<=1,y[e-2-d]=(y[e-1-d]/2|0)+v;for(y[0]=x[0],C[0]=Array(y[0]),A[0]=Array(y[0]),d=1;d<e;++d)y[d]>2*y[d-1]+x[d]&&(y[d]=2*y[d-1]+x[d]),C[d]=Array(y[d]),A[d]=Array(y[d]);for(u=0;u<v;++u)S[u]=e;for(p=0;p<y[e-1];++p)C[e-1][p]=s[p],A[e-1][p]=p;for(u=0;u<e;++u)b[u]=0;for(1===x[e-1]&&(--S[0],++b[e-1]),d=e-2;0<=d;--d){for(f=u=0,g=b[d+1],p=0;p<y[d];p++)(f=C[d+1][g]+C[d+1][g+1])>s[u]?(C[d][p]=f,A[d][p]=v,g+=2):(C[d][p]=s[u],A[d][p]=u,++u);b[d]=0,1===x[d]&&i(d)}for(o=S,a=0,c=n.length;a<c;++a)_[n[a].index]=o[a];return _}function I(e){var i,n,s,o,a=new(r?Uint16Array:Array)(e.length),c=[],l=[],h=0;for(i=0,n=e.length;i<n;i++)c[e[i]]=1+(0|c[e[i]]);for(i=1,n=16;i<=n;i++)l[i]=h,(h+=0|c[i])>1<<i&&t("overcommitted"),h<<=1;for(65536>h&&t("undercommitted"),i=0,n=e.length;i<n;i++)for(h=l[e[i]],l[e[i]]+=1,s=a[i]=0,o=e[i];s<o;s++)a[i]=a[i]<<1|1&h,h>>>=1;return a}function R(t,e){this.input=t,this.a=new(r?Uint8Array:Array)(32768),this.h=D.j;var i,n={};for(i in!e&&(e={})||"number"!=typeof e.compressionType||(this.h=e.compressionType),e)n[i]=e[i];n.outputBuffer=this.a,this.z=new f(this.input,n)}var D=y;function M(e,i){switch(this.k=[],this.l=32768,this.e=this.g=this.c=this.q=0,this.input=r?new Uint8Array(e):e,this.s=!1,this.m=B,this.B=!1,!i&&(i={})||(i.index&&(this.c=i.index),i.bufferSize&&(this.l=i.bufferSize),i.bufferType&&(this.m=i.bufferType),i.resize&&(this.B=i.resize)),this.m){case O:this.b=32768,this.a=new(r?Uint8Array:Array)(32768+this.l+258);break;case B:this.b=0,this.a=new(r?Uint8Array:Array)(this.l),this.f=this.J,this.t=this.H,this.o=this.I;break;default:t(Error("invalid inflate mode"))}}R.prototype.n=function(){var e,i,n,s,a,c,l,h=0;switch(l=this.a,e=ht){case ht:i=Math.LOG2E*Math.log(32768)-8;break;default:t(Error("invalid compression method"))}switch(n=i<<4|e,l[h++]=n,e){case ht:switch(this.h){case D.NONE:a=0;break;case D.r:a=1;break;case D.j:a=2;break;default:t(Error("unsupported compression type"))}break;default:t(Error("invalid compression method"))}return s=a<<6|0,l[h++]=s|31-(256*n+s)%31,c=o(this.input),this.z.b=h,h=(l=this.z.n()).length,r&&((l=new Uint8Array(l.buffer)).length<=h+4&&(this.a=new Uint8Array(l.length+4),this.a.set(l),l=this.a),l=l.subarray(0,h+4)),l[h++]=c>>24&255,l[h++]=c>>16&255,l[h++]=c>>8&255,l[h++]=255&c,l},s("Zlib.Deflate",R),s("Zlib.Deflate.compress",(function(t,e){return new R(t,e).n()})),s("Zlib.Deflate.CompressionType",D),s("Zlib.Deflate.CompressionType.NONE",D.NONE),s("Zlib.Deflate.CompressionType.FIXED",D.r),s("Zlib.Deflate.CompressionType.DYNAMIC",D.j);var O=0,B=1,N={D:O,C:B};M.prototype.p=function(){for(;!this.s;){var n=tt(this,3);switch(1&n&&(this.s=i),n>>>=1){case 0:var s=this.input,o=this.c,a=this.a,c=this.b,l=e,h=e,_=e,u=a.length,d=e;switch(this.e=this.g=0,(l=s[o++])===e&&t(Error("invalid uncompressed block header: LEN (first byte)")),h=l,(l=s[o++])===e&&t(Error("invalid uncompressed block header: LEN (second byte)")),h|=l<<8,(l=s[o++])===e&&t(Error("invalid uncompressed block header: NLEN (first byte)")),_=l,(l=s[o++])===e&&t(Error("invalid uncompressed block header: NLEN (second byte)")),h===~(_|=l<<8)&&t(Error("invalid uncompressed block header: length verify")),o+h>s.length&&t(Error("input buffer is broken")),this.m){case O:for(;c+h>a.length;){if(h-=d=u-c,r)a.set(s.subarray(o,o+d),c),c+=d,o+=d;else for(;d--;)a[c++]=s[o++];this.b=c,a=this.f(),c=this.b}break;case B:for(;c+h>a.length;)a=this.f({v:2});break;default:t(Error("invalid inflate mode"))}if(r)a.set(s.subarray(o,o+h),c),c+=h,o+=h;else for(;h--;)a[c++]=s[o++];this.c=o,this.b=c,this.a=a;break;case 1:this.o($,Q);break;case 2:it(this);break;default:t(Error("unknown BTYPE: "+n))}}return this.t()};var L,F,z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],V=r?new Uint16Array(z):z,G=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],U=r?new Uint16Array(G):G,k=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],H=r?new Uint8Array(k):k,j=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],W=r?new Uint16Array(j):j,q=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],X=r?new Uint8Array(q):q,Y=new(r?Uint8Array:Array)(288);for(L=0,F=Y.length;L<F;++L)Y[L]=143>=L?8:255>=L?9:279>=L?7:8;var K,J,$=p(Y),Z=new(r?Uint8Array:Array)(30);for(K=0,J=Z.length;K<J;++K)Z[K]=5;var Q=p(Z);function tt(i,n){for(var s,r=i.g,o=i.e,a=i.input,c=i.c;o<n;)(s=a[c++])===e&&t(Error("input buffer is broken")),r|=s<<o,o+=8;return s=r&(1<<n)-1,i.g=r>>>n,i.e=o-n,i.c=c,s}function et(i,n){for(var s,r,o,a=i.g,c=i.e,l=i.input,h=i.c,_=n[0],u=n[1];c<u;)(s=l[h++])===e&&t(Error("input buffer is broken")),a|=s<<c,c+=8;return o=(r=_[a&(1<<u)-1])>>>16,i.g=a>>o,i.e=c-o,i.c=h,65535&r}function it(t){function e(t,e,i){var n,s,r,o;for(o=0;o<t;)switch(n=et(this,e),n){case 16:for(r=3+tt(this,2);r--;)i[o++]=s;break;case 17:for(r=3+tt(this,3);r--;)i[o++]=0;s=0;break;case 18:for(r=11+tt(this,7);r--;)i[o++]=0;s=0;break;default:s=i[o++]=n}return i}var i,n,s,o,a=tt(t,5)+257,c=tt(t,5)+1,l=tt(t,4)+4,h=new(r?Uint8Array:Array)(V.length);for(o=0;o<l;++o)h[V[o]]=tt(t,3);i=p(h),n=new(r?Uint8Array:Array)(a),s=new(r?Uint8Array:Array)(c),t.o(p(e.call(t,a,i,n)),p(e.call(t,c,i,s)))}function nt(e,i){var n,s;switch(this.input=e,this.c=0,!i&&(i={})||(i.index&&(this.c=i.index),i.verify&&(this.M=i.verify)),n=e[this.c++],s=e[this.c++],15&n){case ht:this.method=ht;break;default:t(Error("unsupported compression method"))}0!=((n<<8)+s)%31&&t(Error("invalid fcheck flag:"+((n<<8)+s)%31)),32&s&&t(Error("fdict flag is not supported")),this.A=new M(e,{index:this.c,bufferSize:i.bufferSize,bufferType:i.bufferType,resize:i.resize})}M.prototype.o=function(t,e){var i=this.a,n=this.b;this.u=t;for(var s,r,o,a,c=i.length-258;256!==(s=et(this,t));)if(256>s)n>=c&&(this.b=n,i=this.f(),n=this.b),i[n++]=s;else for(a=U[r=s-257],0<H[r]&&(a+=tt(this,H[r])),s=et(this,e),o=W[s],0<X[s]&&(o+=tt(this,X[s])),n>=c&&(this.b=n,i=this.f(),n=this.b);a--;)i[n]=i[n++-o];for(;8<=this.e;)this.e-=8,this.c--;this.b=n},M.prototype.I=function(t,e){var i=this.a,n=this.b;this.u=t;for(var s,r,o,a,c=i.length;256!==(s=et(this,t));)if(256>s)n>=c&&(c=(i=this.f()).length),i[n++]=s;else for(a=U[r=s-257],0<H[r]&&(a+=tt(this,H[r])),s=et(this,e),o=W[s],0<X[s]&&(o+=tt(this,X[s])),n+a>c&&(c=(i=this.f()).length);a--;)i[n]=i[n++-o];for(;8<=this.e;)this.e-=8,this.c--;this.b=n},M.prototype.f=function(){var t,e,i=new(r?Uint8Array:Array)(this.b-32768),n=this.b-32768,s=this.a;if(r)i.set(s.subarray(32768,i.length));else for(t=0,e=i.length;t<e;++t)i[t]=s[t+32768];if(this.k.push(i),this.q+=i.length,r)s.set(s.subarray(n,n+32768));else for(t=0;32768>t;++t)s[t]=s[n+t];return this.b=32768,s},M.prototype.J=function(t){var e,i,n,s=this.input.length/this.c+1|0,o=this.input,a=this.a;return t&&("number"==typeof t.v&&(s=t.v),"number"==typeof t.F&&(s+=t.F)),i=2>s?(n=(o.length-this.c)/this.u[2]/2*258|0)<a.length?a.length+n:a.length<<1:a.length*s,r?(e=new Uint8Array(i)).set(a):e=a,this.a=e},M.prototype.t=function(){var t,e,i,n,s,o=0,a=this.a,c=this.k,l=new(r?Uint8Array:Array)(this.q+(this.b-32768));if(0===c.length)return r?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(e=0,i=c.length;e<i;++e)for(n=0,s=(t=c[e]).length;n<s;++n)l[o++]=t[n];for(e=32768,i=this.b;e<i;++e)l[o++]=a[e];return this.k=[],this.buffer=l},M.prototype.H=function(){var t,e=this.b;return r?this.B?(t=new Uint8Array(e)).set(this.a.subarray(0,e)):t=this.a.subarray(0,e):(this.a.length>e&&(this.a.length=e),t=this.a),this.buffer=t},nt.prototype.p=function(){var e,i=this.input;return e=this.A.p(),this.c=this.A.c,this.M&&(i[this.c++]<<24|i[this.c++]<<16|i[this.c++]<<8|i[this.c++])>>>0!==o(e)&&t(Error("invalid adler-32 checksum")),e},s("Zlib.Inflate",nt),s("Zlib.Inflate.BufferType",N),N.ADAPTIVE=N.C,N.BLOCK=N.D,s("Zlib.Inflate.prototype.decompress",nt.prototype.p);var st,rt,ot=new(r?Uint8Array:Array)(288);for(st=0,rt=ot.length;st<rt;++st)ot[st]=143>=st?8:255>=st?9:279>=st?7:8;p(ot);var at,ct,lt=new(r?Uint8Array:Array)(30);for(at=0,ct=lt.length;at<ct;++at)lt[at]=5;p(lt);var ht=8}).call(B4);var N4=B4.Zlib;N4.Deflate=N4.Deflate,N4.Deflate.compress=N4.Deflate.compress,N4.Inflate=N4.Inflate,N4.Inflate.BufferType=N4.Inflate.BufferType,N4.Inflate.prototype.decompress=N4.Inflate.prototype.decompress;class L4{constructor(t){let e;this.pos=8,this.palette=[],this.imgData=[],this.text={},this.width=0,this.height=0,this.bits=0,this.colorType=0,this.compressionMethod=0,this.filterMethod=0,this.interlaceMethod=0,this.colors=0,this.hasAlphaChannel=!1,this.pixelBitlength=0,this.data=t,this.transparency={indexed:[],rgb:0,grayscale:0};let i=0,n=0,s=0,r=0;for(;;){r=this.readUInt32();const o=(()=>{const t=[];for(i=n=0;n<4;i=++n)t.push(String.fromCharCode(this.data[this.pos++]));return t}).call(this).join("");switch(o){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(r);break;case"fcTL":e&&this.animation.frames.push(e),this.pos+=4,e={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()};const a=this.readUInt16(),c=this.readUInt16()||100;e.delay=1e3*a/c,e.disposeOp=this.data[this.pos++],e.blendOp=this.data[this.pos++],e.data=[];break;case"IDAT":case"fdAT":for("fdAT"===o&&(this.pos+=4,r-=4),t=(null!=e?e.data:void 0)||this.imgData,i=n=0;r>=0?n<r:n>r;i=r>=0?++n:--n)t.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:this.transparency.indexed=this.read(r);const t=255-this.transparency.indexed.length;if(t>0)for(i=s=0;t>=0?s<t:s>t;i=t>=0?++s:--s)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(r)[0];break;case 2:this.transparency.rgb=this.read(r)}break;case"tEXt":const l=this.read(r),h=l.indexOf(0),_=String.fromCharCode.apply(String,l.slice(0,h));this.text[_]=String.fromCharCode.apply(String,l.slice(h+1));break;case"IEND":e&&this.animation.frames.push(e),this.colors=(()=>{switch(this.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}).call(this);const u=this.colorType;this.hasAlphaChannel=4===u||6===u;const d=this.colors+(this.hasAlphaChannel?1:0);return this.pixelBitlength=this.bits*d,this.colorSpace=(()=>{switch(this.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}).call(this),void(this.imgData instanceof Uint8Array||(this.imgData=new Uint8Array(this.imgData)));default:this.pos+=r}if(this.pos+=4,this.pos>this.data.length)throw new Error(N(6017))}}read(t){let e=0,i=0;const n=[];for(e=i=0;t>=0?i<t:i>t;e=t>=0?++i:--i)n.push(this.data[this.pos++]);return n}readUInt32(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]}readUInt16(){return this.data[this.pos++]<<8|this.data[this.pos++]}decodePixels(t){if(null==t&&(t=this.imgData),0===t.length)return new Uint8Array(0);t=new N4.Inflate(t,{index:0,verify:!1}).decompress();const e=this.pixelBitlength/8,i=e*this.width,n=new Uint8Array(i*this.height),s=t.length;let r=0,o=0,a=0,c=0,l=0,h=0,_=0,u=0,d=0,m=0,p=0,f=0,g=0,v=0,y=0,x=0,S=0,C=0,A=0;for(;o<s;){switch(t[o++]){case 0:for(h=_=0;_<i;h=_+=1)n[a++]=t[o++];break;case 1:for(h=u=0;u<i;h=u+=1)c=t[o++],f=h<e?0:n[a-e],n[a++]=(c+f)%256;break;case 2:for(h=d=0;d<i;h=d+=1)c=t[o++],l=(h-h%e)/e,C=r&&n[(r-1)*i+l*e+h%e],n[a++]=(C+c)%256;break;case 3:for(h=m=0;m<i;h=m+=1)c=t[o++],l=(h-h%e)/e,f=h<e?0:n[a-e],C=r&&n[(r-1)*i+l*e+h%e],n[a++]=(c+Math.floor((f+C)/2))%256;break;case 4:for(h=p=0;p<i;h=p+=1)c=t[o++],l=(h-h%e)/e,f=h<e?0:n[a-e],0===r?C=A=0:(C=n[(r-1)*i+l*e+h%e],A=l&&n[(r-1)*i+(l-1)*e+h%e]),g=f+C-A,v=Math.abs(g-f),x=Math.abs(g-C),S=Math.abs(g-A),y=v<=x&&v<=S?f:x<=S?C:A,n[a++]=(c+y)%256;break;default:throw new Error(N(6018,t[o-1]))}r++}return n}copyToImageData(t,e){let i,n=this.hasAlphaChannel,s=this.colors;this.palette.length&&(i=null!=this._decodedPalette?this._decodedPalette:this._decodedPalette=this.decodePalette(),s=4,n=!0);const r=t.data||t,o=r.length,a=i||e;let c=0,l=0,h=0,_=0;if(1===s)for(;c<o;)h=i?4*e[c/4]:l,_=a[h++],r[c++]=_,r[c++]=_,r[c++]=_,r[c++]=n?a[h++]:255,l=h;else for(;c<o;)h=i?4*e[c/4]:l,r[c++]=a[h++],r[c++]=a[h++],r[c++]=a[h++],r[c++]=n?a[h++]:255,l=h}decodePalette(){const t=this.palette,e=this.transparency.indexed||[],i=new Uint8Array((e.length||0)+t.length);let n=0,s=0,r=0;for(let o=0,a=0,c=t.length;a<c;o=a+=3)i[n++]=t[o],i[n++]=t[o+1],i[n++]=t[o+2],r=e[s++],i[n++]=null!=r?r:255;return i}render(t){t.width=this.width,t.height=this.height;const e=t.getContext("2d"),i=e.createImageData(this.width,this.height);return this.copyToImageData(i,this.decodePixels(null)),e.putImageData(i,0,0)}}class F4{constructor(){this._littleEndian=!1,this._tiffData=[],this._fileDirectories=[]}getUint8(t){return this._tiffData[t]}getUint16(t){return this._littleEndian?this._tiffData[t+1]<<8|this._tiffData[t]:this._tiffData[t]<<8|this._tiffData[t+1]}getUint32(t){const e=this._tiffData;return this._littleEndian?e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]:e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}checkLittleEndian(){const t=this.getUint16(0);if(18761===t)this._littleEndian=!0;else{if(19789!==t)throw console.log(t),TypeError(N(6019));this._littleEndian=!1}return this._littleEndian}hasTowel(){if(42!==this.getUint16(2))throw RangeError(N(6020));return!0}getFieldTypeName(t){return t in V4?V4[t]:null}getFieldTagName(t){return t in z4?z4[t]:(P(6021,t),`Tag${t}`)}getFieldTypeLength(t){return-1!==["BYTE","ASCII","SBYTE","UNDEFINED"].indexOf(t)?1:-1!==["SHORT","SSHORT"].indexOf(t)?2:-1!==["LONG","SLONG","FLOAT"].indexOf(t)?4:-1!==["RATIONAL","SRATIONAL","DOUBLE"].indexOf(t)?8:0}getFieldValues(t,e,i,n){const s=[],r=this.getFieldTypeLength(e);if(r*i<=4)!1===this._littleEndian?s.push(n>>>8*(4-r)):s.push(n);else for(let t=0;t<i;t++){const i=r*t;r>=8?-1!==["RATIONAL","SRATIONAL"].indexOf(e)?(s.push(this.getUint32(n+i)),s.push(this.getUint32(n+i+4))):P(8e3):s.push(this.getBytes(r,n+i))}return"ASCII"===e&&s.forEach(((t,e,i)=>{i[e]=String.fromCharCode(t)})),s}getBytes(t,e){if(t<=0)P(8001);else{if(t<=1)return this.getUint8(e);if(t<=2)return this.getUint16(e);if(t<=3)return this.getUint32(e)>>>8;if(t<=4)return this.getUint32(e);P(8002)}return 0}getBits(t,e,i){i=i||0;const n=e+Math.floor(i/8),s=i+t,r=32-t;let o=0,a=0;return s<=0?P(6023):s<=8?(o=24+i,a=this.getUint8(n)):s<=16?(o=16+i,a=this.getUint16(n)):s<=32?(o=i,a=this.getUint32(n)):P(6022),{bits:a<<o>>>r,byteOffset:n+Math.floor(s/8),bitOffset:s%8}}parseFileDirectory(t){const e=this.getUint16(t),i=[];let n=0,s=0;for(n=t+2,s=0;s<e;n+=12,s++){const t=this.getUint16(n),e=this.getUint16(n+2),s=this.getUint32(n+4),r=this.getUint32(n+8),o=this.getFieldTagName(t),a=this.getFieldTypeName(e),c=this.getFieldValues(o,a,s,r);i[o]={type:a,values:c}}this._fileDirectories.push(i);const r=this.getUint32(n);0!==r&&this.parseFileDirectory(r)}clampColorSample(t,e){const i=Math.pow(2,8-e);return Math.floor(t*i+(i-1))}parseTIFF(t,e){if(e=e||document.createElement("canvas"),this._tiffData=t,this._canvas=e,this.checkLittleEndian(),!this.hasTowel())return;const i=this.getUint32(4);this._fileDirectories.length=0,this.parseFileDirectory(i);const n=this._fileDirectories[0],s=n.ImageWidth.values[0],r=n.ImageLength.values[0];this._canvas.width=s,this._canvas.height=r;const o=[],a=n.Compression?n.Compression.values[0]:1,c=n.SamplesPerPixel.values[0],l=[];let h=0,_=!1;n.BitsPerSample.values.forEach(((t,e)=>{l[e]={bitsPerSample:t,hasBytesPerSample:!1,bytesPerSample:void 0},t%8==0&&(l[e].hasBytesPerSample=!0,l[e].bytesPerSample=t/8),h+=t}),this);let u=0;h%8==0&&(_=!0,u=h/8);const d=n.StripOffsets.values,m=d.length;let p;if(n.StripByteCounts)p=n.StripByteCounts.values;else{if(P(8003),1!==m)throw Error(N(6024));p=[Math.ceil(s*r*h/8)]}let f=1,g=1;for(let t=0;t<m;t++){const e=d[t];o[t]=[];const i=p[t];for(let n=0,s=0,r=1,h=!0,d=[],m=0,p=0,v=0;n<i;n+=r)switch(a){case 1:d=[];for(let t=0;t<c;t++){const i=l[t];if(!i.hasBytesPerSample){const t=this.getBits(i.bitsPerSample,e+n,s);throw d.push(t.bits),n=t.byteOffset-e,s=t.bitOffset,RangeError(N(6025))}{const s=i.bytesPerSample*t;d.push(this.getBytes(i.bytesPerSample,e+n+s))}}if(o[t].push(d),!_)throw r=0,RangeError(N(6026));r=u;break;case 2:case 3:case 4:case 5:case 6:case 7:break;case 32773:if(h){h=!1;const t=this.getUint8(e+n);t>=0&&t<=127?f=t+1:t>=-127&&t<=-1?g=1-t:h=!0}else{const i=this.getUint8(e+n);for(let e=0;e<g;e++){const e=l[p];if(!e.hasBytesPerSample)throw RangeError(N(6025));v=v<<8*m|i,m++,m===e.bytesPerSample&&(d.push(v),v=m=0,p++),p===c&&(o[t].push(d),d=[],p=0)}f--,0===f&&(h=!0)}r=1}}if(e.getContext){const t=this._canvas.getContext("2d");t.fillStyle="rgba(255, 255, 255, 0)";const e=n.RowsPerStrip?n.RowsPerStrip.values[0]:r,i=o.length,a=r%e,c=0===a?e:a;let h=e,_=0;const u=n.PhotometricInterpretation.values[0];let d=[],m=0;n.ExtraSamples&&(d=n.ExtraSamples.values,m=d.length);let p=[],f=0;n.ColorMap&&(p=n.ColorMap.values,f=Math.pow(2,l[0].bitsPerSample));for(let e=0;e<i;e++){e+1===i&&(h=c);const n=o[e].length,r=_*e;for(let i=0,a=0;i<h&&a<n;i++)for(let n=0;n<s;n++,a++){const s=o[e][a];let c=0,h=0,_=0,g=1;if(m>0)for(let t=0;t<m;t++)if(1===d[t]||2===d[t]){g=s[3+t]/256;break}switch(u){case 0:let t=0;l[0].hasBytesPerSample&&(t=Math.pow(16,2*l[0].bytesPerSample)),s.forEach(((e,i,n)=>{n[i]=t-e}));case 1:c=h=_=this.clampColorSample(s[0],l[0].bitsPerSample);break;case 2:c=this.clampColorSample(s[0],l[0].bitsPerSample),h=this.clampColorSample(s[1],l[1].bitsPerSample),_=this.clampColorSample(s[2],l[2].bitsPerSample);break;case 3:if(void 0===p)throw Error(N(6027));const e=s[0];c=this.clampColorSample(p[e],16),h=this.clampColorSample(p[f+e],16),_=this.clampColorSample(p[2*f+e],16);break;default:throw RangeError(N(6028,u))}t.fillStyle=`rgba(${c}, ${h}, ${_}, ${g})`,t.fillRect(n,r+i,1,1)}_=h}}return this._canvas}}const z4={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop"},V4={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE"},G4=new Array(123);for(let t=0;t<123;++t)G4[t]=64;for(let t=0;t<64;++t)G4["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(t)]=t;var U4={name:"Jacob__Codec__Base64",decode:function(t){var e,i,n,s,r,o,a=[],c=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<t.length;)e=G4[t.charCodeAt(c++)]<<2|(s=G4[t.charCodeAt(c++)])>>4,i=(15&s)<<4|(r=G4[t.charCodeAt(c++)])>>2,n=(3&r)<<6|(o=G4[t.charCodeAt(c++)]),a.push(String.fromCharCode(e)),64!==r&&a.push(String.fromCharCode(i)),64!==o&&a.push(String.fromCharCode(n));return a.join("")},decodeAsArray:function(t,e){var i,n,s,r=this.decode(t),o=[];for(i=0,s=r.length/e;i<s;i++)for(o[i]=0,n=e-1;n>=0;--n)o[i]+=r.charCodeAt(i*e+n)<<8*n;return o}},k4=function(t){this.data=t,this.debug=!1,this.gpflags=void 0,this.files=0,this.unzipped=[],this.buf32k=new Array(32768),this.bIdx=0,this.modeZIP=!1,this.bytepos=0,this.bb=1,this.bits=0,this.nameBuf=[],this.fileout=void 0,this.literalTree=new Array(k4.LITERALS),this.distanceTree=new Array(32),this.treepos=0,this.Places=null,this.len=0,this.fpos=new Array(17),this.fpos[0]=0,this.flens=void 0,this.fmax=void 0};k4.gunzip=function(t){return t.constructor===Array||t.constructor,new k4(t).gunzip()[0][0]},k4.HufNode=function(){this.b0=0,this.b1=0,this.jump=null,this.jumppos=-1},k4.LITERALS=288,k4.NAMEMAX=256,k4.bitReverse=[0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,3,131,67,195,35,163,99,227,19,147,83,211,51,179,115,243,11,139,75,203,43,171,107,235,27,155,91,219,59,187,123,251,7,135,71,199,39,167,103,231,23,151,87,215,55,183,119,247,15,143,79,207,47,175,111,239,31,159,95,223,63,191,127,255],k4.cplens=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],k4.cplext=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],k4.cpdist=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],k4.cpdext=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],k4.border=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],k4.prototype.gunzip=function(){return this.outputArr=[],this.nextFile(),this.unzipped},k4.prototype.readByte=function(){return this.bits+=8,this.bytepos<this.data.length?this.data.charCodeAt(this.bytepos++):-1},k4.prototype.byteAlign=function(){this.bb=1},k4.prototype.readBit=function(){var t;return this.bits++,t=1&this.bb,this.bb>>=1,0===this.bb&&(this.bb=this.readByte(),t=1&this.bb,this.bb=this.bb>>1|128),t},k4.prototype.readBits=function(t){for(var e=0,i=t;i--;)e=e<<1|this.readBit();return t&&(e=k4.bitReverse[e]>>8-t),e},k4.prototype.flushBuffer=function(){this.bIdx=0},k4.prototype.addBuffer=function(t){this.buf32k[this.bIdx++]=t,this.outputArr.push(String.fromCharCode(t)),32768===this.bIdx&&(this.bIdx=0)},k4.prototype.IsPat=function(){for(;;){if(this.fpos[this.len]>=this.fmax)return-1;if(this.flens[this.fpos[this.len]]===this.len)return this.fpos[this.len]++;this.fpos[this.len]++}},k4.prototype.Rec=function(){var t,e=this.Places[this.treepos];if(17===this.len)return-1;if(this.treepos++,this.len++,(t=this.IsPat())>=0)e.b0=t;else if(e.b0=32768,this.Rec())return-1;if((t=this.IsPat())>=0)e.b1=t,e.jump=null;else if(e.b1=32768,e.jump=this.Places[this.treepos],e.jumppos=this.treepos,this.Rec())return-1;return this.len--,0},k4.prototype.CreateTree=function(t,e,i){var n;for(this.Places=t,this.treepos=0,this.flens=i,this.fmax=e,n=0;n<17;n++)this.fpos[n]=0;return this.len=0,this.Rec()?-1:0},k4.prototype.DecodeValue=function(t){for(var e,i,n=0,s=t[n];;)if(this.readBit()){if(!(32768&s.b1))return s.b1;for(s=s.jump,e=t.length,i=0;i<e;i++)if(t[i]===s){n=i;break}}else{if(!(32768&s.b0))return s.b0;s=t[++n]}return-1},k4.prototype.DeflateLoop=function(){var t,e,i;do{var n,s;if(t=this.readBit(),0===(e=this.readBits(2)))for(this.byteAlign(),n=this.readByte(),n|=this.readByte()<<8,s=this.readByte(),65535&(n^~(s|=this.readByte()<<8))&&document.write("BlockLen checksum mismatch\n");n--;)r=this.readByte(),this.addBuffer(r);else if(1===e)for(;;)if((o=k4.bitReverse[this.readBits(7)]>>1)>23?(o=o<<1|this.readBit())>199?o=(o-=128)<<1|this.readBit():(o-=48)>143&&(o+=136):o+=256,o<256)this.addBuffer(o);else{if(256===o)break;for(o-=257,m=this.readBits(k4.cplext[o])+k4.cplens[o],o=k4.bitReverse[this.readBits(5)]>>3,k4.cpdext[o]>8?(p=this.readBits(8),p|=this.readBits(k4.cpdext[o]-8)<<8):p=this.readBits(k4.cpdext[o]),p+=k4.cpdist[o],o=0;o<m;o++){var r=this.buf32k[this.bIdx-p&32767];this.addBuffer(r)}}else if(2===e){var o,a,c,l,h,_=new Array(320);for(c=257+this.readBits(5),l=1+this.readBits(5),h=4+this.readBits(4),o=0;o<19;o++)_[o]=0;for(o=0;o<h;o++)_[k4.border[o]]=this.readBits(3);for(m=this.distanceTree.length,i=0;i<m;i++)this.distanceTree[i]=new k4.HufNode;if(this.CreateTree(this.distanceTree,19,_,0))return this.flushBuffer(),1;for(a=c+l,i=0;i<a;)if((o=this.DecodeValue(this.distanceTree))<16)_[i++]=o;else if(16===o){var u;if(i+(o=3+this.readBits(2))>a)return this.flushBuffer(),1;for(u=i?_[i-1]:0;o--;)_[i++]=u}else{if(i+(o=17===o?3+this.readBits(3):11+this.readBits(7))>a)return this.flushBuffer(),1;for(;o--;)_[i++]=0}for(m=this.literalTree.length,i=0;i<m;i++)this.literalTree[i]=new k4.HufNode;if(this.CreateTree(this.literalTree,c,_,0))return this.flushBuffer(),1;for(m=this.literalTree.length,i=0;i<m;i++)this.distanceTree[i]=new k4.HufNode;var d=new Array;for(i=c;i<_.length;i++)d[i-c]=_[i];if(this.CreateTree(this.distanceTree,l,d,0))return this.flushBuffer(),1;for(;;)if((o=this.DecodeValue(this.literalTree))>=256){var m,p;if(0==(o-=256))break;for(o--,m=this.readBits(k4.cplext[o])+k4.cplens[o],o=this.DecodeValue(this.distanceTree),k4.cpdext[o]>8?(p=this.readBits(8),p|=this.readBits(k4.cpdext[o]-8)<<8):p=this.readBits(k4.cpdext[o]),p+=k4.cpdist[o];m--;)r=this.buf32k[this.bIdx-p&32767],this.addBuffer(r)}else this.addBuffer(o)}}while(!t);return this.flushBuffer(),this.byteAlign(),0},k4.prototype.unzipFile=function(t){var e;for(this.gunzip(),e=0;e<this.unzipped.length;e++)if(this.unzipped[e][1]===t)return this.unzipped[e][0]},k4.prototype.nextFile=function(){this.outputArr=[],this.modeZIP=!1;var t=[];if(t[0]=this.readByte(),t[1]=this.readByte(),120===t[0]&&218===t[1]&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),"geonext.gxt"],this.files++),31===t[0]&&139===t[1]&&(this.skipdir(),this.unzipped[this.files]=[this.outputArr.join(""),"file"],this.files++),80===t[0]&&75===t[1]&&(this.modeZIP=!0,t[2]=this.readByte(),t[3]=this.readByte(),3===t[2]&&4===t[3])){t[0]=this.readByte(),t[1]=this.readByte(),this.gpflags=this.readByte(),this.gpflags|=this.readByte()<<8;var e=this.readByte();e|=this.readByte()<<8,this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte();var i=this.readByte();i|=this.readByte()<<8;var n=this.readByte();for(n|=this.readByte()<<8,r=0,this.nameBuf=[];i--;){var s=this.readByte();"/"===s|":"===s?r=0:r<k4.NAMEMAX-1&&(this.nameBuf[r++]=String.fromCharCode(s))}this.fileout||(this.fileout=this.nameBuf);for(var r=0;r<n;)s=this.readByte(),r++;8===e&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),this.nameBuf.join("")],this.files++),this.skipdir()}},k4.prototype.skipdir=function(){var t,e,i=[];if(8&this.gpflags&&(i[0]=this.readByte(),i[1]=this.readByte(),i[2]=this.readByte(),i[3]=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte()),this.modeZIP&&this.nextFile(),i[0]=this.readByte(),8!==i[0])return 0;if(this.gpflags=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),4&this.gpflags)for(i[0]=this.readByte(),i[2]=this.readByte(),this.len=i[0]+256*i[1],t=0;t<this.len;t++)this.readByte();if(8&this.gpflags)for(t=0,this.nameBuf=[];e=this.readByte();)"7"!==e&&":"!==e||(t=0),t<k4.NAMEMAX-1&&(this.nameBuf[t++]=e);if(16&this.gpflags)for(;e=this.readByte(););2&this.gpflags&&(this.readByte(),this.readByte()),this.DeflateLoop(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.modeZIP&&this.nextFile()};var H4,j4,W4,q4,X4,Y4,K4,J4,$4,Z4,Q4,t3,e3,i3,n3,s3,r3,o3,a3,c3,l3,h3,_3,u3,d3,m3,p3,f3,g3,v3,y3,x3,S3,C3,A3,b3,T3,E3,P3,w3,I3,R3,D3,M3,O3,B3,N3,L3,F3,z3,V3,G3,U3,k3,H3,j3,W3,q3,X3,Y3,K3,J3,$3,Z3,Q3,t5,e5,i5,n5,s5,r5,o5,a5,c5,l5,h5,_5,u5,d5,m5,p5,f5,g5,v5,y5,x5,S5,C5,A5,b5,T5,E5,P5,w5,I5,R5,D5,M5,O5,B5,N5,L5,F5={name:"Jacob__Codec"};let z5;function V5(t){const e=t.parent,i=t.getComponent(G5);return e&&i?V5(e):t.getComponentsInChildren(G5)}F5.Base64=U4,F5.GZip=k4,F5.unzip=function(){return F5.GZip.gunzip.apply(F5.GZip,arguments)},F5.unzipBase64=function(){var t=F5.Base64.decode.apply(F5.Base64,arguments);try{return F5.GZip.gunzip.call(F5.GZip,t)}catch(e){return t.slice(7)}},F5.unzipBase64AsArray=function(t,e){e=e||1;var i,n,s,r=this.unzipBase64(t),o=[];for(i=0,s=r.length/e;i<s;i++)for(o[i]=0,n=e-1;n>=0;--n)o[i]+=r.charCodeAt(i*e+n)<<8*n;return o},F5.unzipAsArray=function(t,e){e=e||1;var i,n,s,r=this.unzip(t),o=[];for(i=0,s=r.length/e;i<s;i++)for(o[i]=0,n=e-1;n>=0;--n)o[i]+=r.charCodeAt(i*e+n)<<8*n;return o},function(t){t[t.JPG=0]="JPG",t[t.PNG=1]="PNG",t[t.TIFF=2]="TIFF",t[t.WEBP=3]="WEBP",t[t.PVR=4]="PVR",t[t.ETC=5]="ETC",t[t.S3TC=6]="S3TC",t[t.ATITC=7]="ATITC",t[t.TGA=8]="TGA",t[t.RAWDATA=9]="RAWDATA",t[t.UNKNOWN=10]="UNKNOWN"}(z5||(z5={}));let G5=t("ParticleSystem2D",(H4=dc("cc.ParticleSystem2D"),j4=Pc(),W4=kc(),q4=Lc(),X4=Kc(O4),Y4=kc(),K4=Lc(),J4=Kc(jD),$4=Lc(),Z4=Lc(),Q4=Lc(),t3=Lc(),e3=Lc(),i3=Lc(),n3=Lc(),s3=Lc(),r3=Oc(),o3=Lc(),a3=Lc(),c3=Lc(),l3=Lc(),h3=Lc(),_3=Lc(),u3=Lc(),d3=Lc(),m3=Lc(),p3=Lc(),f3=Lc(),g3=Lc(),v3=Lc(),y3=Kc(x4),x3=Lc(),S3=kc(),C3=Lc(),A3=Kc(y4),b3=Lc(),T3=Lc(),E3=Lc(),P3=Lc(),w3=Lc(),I3=Lc(),R3=Lc(),D3=Lc(),M3=Lc(),O3=Lc(),B3=Lc(),N3=Lc(),L3=Lc(),F3=Lc(),z3=Lc(),V3=kc(),G3=Lc(),U3=kc(),k3=Lc(),H3=Cc("preview"),H4(j3=j4(j3=wc(j3=Ec((L5=N5=class t extends HO{get custom(){return this._custom}set custom(t){this._custom!==t&&(this._custom=t,this._applyFile())}get file(){return this._file}set file(t){this._file!==t&&(this._file=t,t?this._applyFile():this.custom=!0)}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){this._renderSpriteFrame!==t&&(this._renderSpriteFrame=t,t&&!t._uuid||(this._spriteFrame=t),this._applySpriteFrame())}get particleCount(){return this._simulator.particles.length}get totalParticles(){return this._totalParticles}set totalParticles(t){this._totalParticles!==t&&(this._totalParticles=t)}get startColor(){return this._startColor}set startColor(t){this._startColor.r=t.r,this._startColor.g=t.g,this._startColor.b=t.b,this._startColor.a=t.a}get startColorVar(){return this._startColorVar}set startColorVar(t){this._startColorVar.r=t.r,this._startColorVar.g=t.g,this._startColorVar.b=t.b,this._startColorVar.a=t.a}set color(t){}get color(){return this._color}get endColor(){return this._endColor}set endColor(t){this._endColor.r=t.r,this._endColor.g=t.g,this._endColor.b=t.b,this._endColor.a=t.a}get endColorVar(){return this._endColorVar}set endColorVar(t){this._endColorVar.r=t.r,this._endColorVar.g=t.g,this._endColorVar.b=t.b,this._endColorVar.a=t.a}get positionType(){return this._positionType}set positionType(t){this._positionType=t,this._updateMaterial()}get preview(){return this._preview}set preview(t){t?this._startPreview():this._stopPreview(),this._preview=t}get stopped(){return this._stopped}get active(){return this._simulator.active}get assembler(){return this._assembler}constructor(){super(),nc(this,"duration",q3,this),nc(this,"emissionRate",X3,this),nc(this,"life",Y3,this),nc(this,"lifeVar",K3,this),nc(this,"angle",J3,this),nc(this,"angleVar",$3,this),nc(this,"startSize",Z3,this),nc(this,"startSizeVar",Q3,this),nc(this,"endSize",t5,this),nc(this,"endSizeVar",e5,this),nc(this,"startSpin",i5,this),nc(this,"startSpinVar",n5,this),nc(this,"endSpin",s5,this),nc(this,"endSpinVar",r5,this),nc(this,"sourcePos",o5,this),nc(this,"posVar",a5,this),nc(this,"emitterMode",c5,this),nc(this,"gravity",l5,this),nc(this,"speed",h5,this),nc(this,"speedVar",_5,this),nc(this,"tangentialAccel",u5,this),nc(this,"tangentialAccelVar",d5,this),nc(this,"radialAccel",m5,this),nc(this,"radialAccelVar",p5,this),nc(this,"rotationIsDir",f5,this),nc(this,"startRadius",g5,this),nc(this,"startRadiusVar",v5,this),nc(this,"endRadius",y5,this),nc(this,"endRadiusVar",x5,this),nc(this,"rotatePerS",S5,this),nc(this,"rotatePerSVar",C5,this),this.aspectRatio=1,nc(this,"playOnLoad",A5,this),nc(this,"autoRemoveOnFinish",b5,this),nc(this,"_preview",T5,this),nc(this,"_custom",E5,this),nc(this,"_file",P5,this),nc(this,"_spriteFrame",w5,this),nc(this,"_totalParticles",I5,this),nc(this,"_startColor",R5,this),nc(this,"_startColorVar",D5,this),nc(this,"_endColor",M5,this),nc(this,"_endColorVar",O5,this),nc(this,"_positionType",B5,this),this._stopped=!0,this.initProperties()}onEnable(){super.onEnable(),this._updateMaterial()}onDestroy(){super.onDestroy(),this.autoRemoveOnFinish&&(this.autoRemoveOnFinish=!1),this._simulator.uvFilled=0,this._simulator.renderData&&this._assembler&&this._assembler.removeData(this._simulator.renderData)}initProperties(){this._previewTimer=null,this._focused=!1,this.aspectRatio=1,this._simulator=new I4(this)}onFocusInEditor(){this._focused=!0;const t=V5(this.node);for(let e=0;e<t.length;++e)t[e]._startPreview()}onLostFocusInEditor(){this._focused=!1;const t=V5(this.node);for(let e=0;e<t.length;++e)t[e]._stopPreview()}_startPreview(){this._preview&&this.resetSystem()}_stopPreview(){this._preview&&(this.resetSystem(),this.stopSystem()),this._previewTimer&&clearInterval(this._previewTimer)}__preload(){super.__preload(),this._custom&&this.spriteFrame&&!this._renderSpriteFrame?this._applySpriteFrame():this._file&&(this._custom?!this._getTexture()&&this._applyFile():this._applyFile()),this.playOnLoad&&this.resetSystem()}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._assembler&&this._assembler.createData&&(this._simulator.renderData=this._assembler.createData(this))}lateUpdate(t){this._simulator.finished||this._simulator.step(t)}addParticle(){}stopSystem(){this._stopped=!0,this._simulator.stop()}resetSystem(){this._stopped=!1,this._simulator.reset(),this._renderFlag=this._canRender()}isFull(){return this.particleCount>=this.totalParticles}_applyFile(){const t=this._file;if(t){if(!t)return void D(6029);if(!this.isValid)return;this._plistFile=t.nativeUrl,this._custom||(this._spriteFrame!==t.spriteFrame&&(this.spriteFrame=t.spriteFrame),this._initWithDictionary(t._nativeAsset)),this._spriteFrame?!this._renderSpriteFrame&&this._spriteFrame&&this._applySpriteFrame():t.spriteFrame?this.spriteFrame=t.spriteFrame:this._custom&&this._initTextureWithDictionary(t._nativeAsset)}}_initTextureWithDictionary(t){if(t.spriteFrameUuid){const e=t.spriteFrameUuid;EI.loadAny(e,((e,i)=>{e?(t.spriteFrameUuid=void 0,this._initTextureWithDictionary(t),x(e)):this.spriteFrame=i}))}else{const i=ch(this._plistFile,t.textureFileName||"");if(t.textureFileName)EI.loadRemote(i,((e,i)=>{e?(t.textureFileName=void 0,this._initTextureWithDictionary(t),x(e)):this.spriteFrame=i?jD.createWithImage(i):jD.createWithImage(Mf.get("white-texture"))}));else if(t.textureImageData){const n=t.textureImageData;if(!(n&&n.length>0))return!1;{let t=EI.assets.get(i);if(!t){const s=F5.unzipBase64AsArray(n,1);if(!s)return I(6030,this._file.name),!1;const r=(e=s).length>8&&137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]&&13===e[4]&&10===e[5]&&26===e[6]&&10===e[7]?z5.PNG:e.length>2&&(73===e[0]&&73===e[1]||77===e[0]&&77===e[1]||255===e[0]&&216===e[1])?z5.TIFF:z5.UNKNOWN;if(r!==z5.TIFF&&r!==z5.PNG)return I(6031,this._file.name),!1;const o=document.createElement("canvas");r===z5.PNG?new L4(s).render(o):(this._tiffReader||(this._tiffReader=new F4),this._tiffReader.parseTIFF(s,o)),t=new rf(o),EI.assets.add(i,t)}t||I(6032,this._file.name),this.spriteFrame=t?jD.createWithImage(t):jD.createWithImage(Mf.get("white-texture"))}}}var e;return!0}_initWithDictionary(t){this.totalParticles=parseInt(t.maxParticles||0),this.life=parseFloat(t.particleLifespan||0),this.lifeVar=parseFloat(t.particleLifespanVariance||0);const e=t.emissionRate;this.emissionRate=e||Math.min(this.totalParticles/this.life,Number.MAX_VALUE),this.duration=parseFloat(t.duration||0),this._srcBlendFactor=parseInt(t.blendFuncSource||fn.SRC_ALPHA),this._dstBlendFactor=parseInt(t.blendFuncDestination||fn.ONE_MINUS_SRC_ALPHA);const i=this._startColor;i.r=255*parseFloat(t.startColorRed||0),i.g=255*parseFloat(t.startColorGreen||0),i.b=255*parseFloat(t.startColorBlue||0),i.a=255*parseFloat(t.startColorAlpha||0);const n=this._startColorVar;n.r=255*parseFloat(t.startColorVarianceRed||0),n.g=255*parseFloat(t.startColorVarianceGreen||0),n.b=255*parseFloat(t.startColorVarianceBlue||0),n.a=255*parseFloat(t.startColorVarianceAlpha||0);const s=this._endColor;s.r=255*parseFloat(t.finishColorRed||0),s.g=255*parseFloat(t.finishColorGreen||0),s.b=255*parseFloat(t.finishColorBlue||0),s.a=255*parseFloat(t.finishColorAlpha||0);const r=this._endColorVar;if(r.r=255*parseFloat(t.finishColorVarianceRed||0),r.g=255*parseFloat(t.finishColorVarianceGreen||0),r.b=255*parseFloat(t.finishColorVarianceBlue||0),r.a=255*parseFloat(t.finishColorVarianceAlpha||0),this.startSize=parseFloat(t.startParticleSize||0),this.startSizeVar=parseFloat(t.startParticleSizeVariance||0),this.endSize=parseFloat(t.finishParticleSize||0),this.endSizeVar=parseFloat(t.finishParticleSizeVariance||0),this.positionType=parseFloat(void 0!==t.positionType?t.positionType:x4.FREE),this.sourcePos.set(0,0),this.posVar.set(parseFloat(t.sourcePositionVariancex||0),parseFloat(t.sourcePositionVariancey||0)),this.angle=parseFloat(t.angle||0),this.angleVar=parseFloat(t.angleVariance||0),this.startSpin=parseFloat(t.rotationStart||0),this.startSpinVar=parseFloat(t.rotationStartVariance||0),this.endSpin=parseFloat(t.rotationEnd||0),this.endSpinVar=parseFloat(t.rotationEndVariance||0),this.emitterMode=parseInt(t.emitterType||y4.GRAVITY),this.emitterMode===y4.GRAVITY){this.gravity.set(parseFloat(t.gravityx||0),parseFloat(t.gravityy||0)),this.speed=parseFloat(t.speed||0),this.speedVar=parseFloat(t.speedVariance||0),this.radialAccel=parseFloat(t.radialAcceleration||0),this.radialAccelVar=parseFloat(t.radialAccelVariance||0),this.tangentialAccel=parseFloat(t.tangentialAcceleration||0),this.tangentialAccelVar=parseFloat(t.tangentialAccelVariance||0);let e=t.rotationIsDir||"";null!==e?(e=e.toString().toLowerCase(),this.rotationIsDir="true"===e||"1"===e):this.rotationIsDir=!1}else{if(this.emitterMode!==y4.RADIUS)return I(6009),!1;this.startRadius=parseFloat(t.maxRadius||0),this.startRadiusVar=parseFloat(t.maxRadiusVariance||0),this.endRadius=parseFloat(t.minRadius||0),this.endRadiusVar=parseFloat(t.minRadiusVariance||0),this.rotatePerS=parseFloat(t.rotatePerSecond||0),this.rotatePerSVar=parseFloat(t.rotatePerSecondVariance||0)}return this._initTextureWithDictionary(t),!0}_syncAspect(){if(this._renderSpriteFrame){const t=this._renderSpriteFrame.rect;this.aspectRatio=t.width/t.height}}_applySpriteFrame(){this._renderSpriteFrame=this._renderSpriteFrame||this._spriteFrame,this._renderSpriteFrame?this._renderSpriteFrame.texture&&(this._simulator.updateUVs(!0),this._syncAspect(),this._updateMaterial(),this._stopped=!1,this._renderFlag=this._canRender()):this.resetSystem()}_getTexture(){return this._renderSpriteFrame&&this._renderSpriteFrame.texture}_updateMaterial(){const t=this.getMaterialInstance(0);t&&t.recompileShaders({USE_LOCAL:this._positionType!==x4.FREE})}_finishedSimulation(){this.resetSystem(),this.stopSystem(),this._renderFlag=this._canRender(),this.autoRemoveOnFinish&&this._stopped&&this.node.destroy()}_canRender(){return super._canRender()&&!this._stopped&&null!==this._renderSpriteFrame}_render(t){this._positionType===x4.RELATIVE?t.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node.parent):this.positionType===x4.GROUPED?t.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node):t.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,null)}},N5.EmitterMode=y4,N5.PositionType=x4,N5.DURATION_INFINITY=-1,N5.START_SIZE_EQUAL_TO_END_SIZE=-1,N5.START_RADIUS_EQUAL_TO_END_RADIUS=-1,sc((W3=L5).prototype,"custom",[Mc,W4,q4],Object.getOwnPropertyDescriptor(W3.prototype,"custom"),W3.prototype),sc(W3.prototype,"file",[X4,Y4,K4],Object.getOwnPropertyDescriptor(W3.prototype,"file"),W3.prototype),sc(W3.prototype,"spriteFrame",[J4,$4],Object.getOwnPropertyDescriptor(W3.prototype,"spriteFrame"),W3.prototype),sc(W3.prototype,"totalParticles",[Mc,Z4],Object.getOwnPropertyDescriptor(W3.prototype,"totalParticles"),W3.prototype),q3=sc(W3.prototype,"duration",[Sc,Mc,Q4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),X3=sc(W3.prototype,"emissionRate",[Sc,Mc,t3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),Y3=sc(W3.prototype,"life",[Sc,Mc,e3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),K3=sc(W3.prototype,"lifeVar",[Sc,Mc,i3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sc(W3.prototype,"startColor",[Mc,n3],Object.getOwnPropertyDescriptor(W3.prototype,"startColor"),W3.prototype),sc(W3.prototype,"startColorVar",[Mc,s3],Object.getOwnPropertyDescriptor(W3.prototype,"startColorVar"),W3.prototype),sc(W3.prototype,"color",[r3],Object.getOwnPropertyDescriptor(W3.prototype,"color"),W3.prototype),sc(W3.prototype,"endColor",[Mc,o3],Object.getOwnPropertyDescriptor(W3.prototype,"endColor"),W3.prototype),sc(W3.prototype,"endColorVar",[Mc,a3],Object.getOwnPropertyDescriptor(W3.prototype,"endColorVar"),W3.prototype),J3=sc(W3.prototype,"angle",[Sc,Mc,c3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),$3=sc(W3.prototype,"angleVar",[Sc,Mc,l3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),Z3=sc(W3.prototype,"startSize",[Sc,Mc,h3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),Q3=sc(W3.prototype,"startSizeVar",[Sc,Mc,_3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),t5=sc(W3.prototype,"endSize",[Sc,Mc,u3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),e5=sc(W3.prototype,"endSizeVar",[Sc,Mc,d3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i5=sc(W3.prototype,"startSpin",[Sc,Mc,m3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n5=sc(W3.prototype,"startSpinVar",[Sc,Mc,p3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),s5=sc(W3.prototype,"endSpin",[Sc,Mc,f3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),r5=sc(W3.prototype,"endSpinVar",[Sc,Mc,g3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),o5=sc(W3.prototype,"sourcePos",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oi.ZERO.clone()}}),a5=sc(W3.prototype,"posVar",[Sc,Mc,v3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oi.ZERO.clone()}}),sc(W3.prototype,"positionType",[y3,x3],Object.getOwnPropertyDescriptor(W3.prototype,"positionType"),W3.prototype),sc(W3.prototype,"preview",[Mc,S3,C3],Object.getOwnPropertyDescriptor(W3.prototype,"preview"),W3.prototype),c5=sc(W3.prototype,"emitterMode",[Sc,Mc,A3,b3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return y4.GRAVITY}}),l5=sc(W3.prototype,"gravity",[Sc,Mc,T3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oi.ZERO.clone()}}),h5=sc(W3.prototype,"speed",[Sc,Mc,E3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 180}}),_5=sc(W3.prototype,"speedVar",[Sc,Mc,P3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),u5=sc(W3.prototype,"tangentialAccel",[Sc,Mc,w3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 80}}),d5=sc(W3.prototype,"tangentialAccelVar",[Sc,Mc,I3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m5=sc(W3.prototype,"radialAccel",[Sc,Mc,R3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),p5=sc(W3.prototype,"radialAccelVar",[Sc,Mc,D3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),f5=sc(W3.prototype,"rotationIsDir",[Sc,Mc,M3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),g5=sc(W3.prototype,"startRadius",[Sc,Mc,O3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v5=sc(W3.prototype,"startRadiusVar",[Sc,Mc,B3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),y5=sc(W3.prototype,"endRadius",[Sc,Mc,N3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),x5=sc(W3.prototype,"endRadiusVar",[Sc,Mc,L3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S5=sc(W3.prototype,"rotatePerS",[Sc,Mc,F3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C5=sc(W3.prototype,"rotatePerSVar",[Sc,Mc,z3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),A5=sc(W3.prototype,"playOnLoad",[Sc,Mc,V3,G3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),b5=sc(W3.prototype,"autoRemoveOnFinish",[Sc,Mc,U3,k3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T5=sc(W3.prototype,"_preview",[H3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),E5=sc(W3.prototype,"_custom",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),P5=sc(W3.prototype,"_file",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),w5=sc(W3.prototype,"_spriteFrame",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),I5=sc(W3.prototype,"_totalParticles",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 150}}),R5=sc(W3.prototype,"_startColor",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(255,255,255,255)}}),D5=sc(W3.prototype,"_startColorVar",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(0,0,0,0)}}),M5=sc(W3.prototype,"_endColor",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(255,255,255,0)}}),O5=sc(W3.prototype,"_endColorVar",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(0,0,0,0)}}),B5=sc(W3.prototype,"_positionType",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return x4.FREE}}),j3=W3))||j3)||j3)||j3)||j3));var U5,k5,H5,j5,W5,q5,X5,Y5,K5,J5,$5,Z5,Q5,t6;let e6=t("MotionStreak",(U5=dc("cc.MotionStreak"),k5=Pc(),H5=Dc(),j5=Kc(xf),U5(W5=Ec(W5=wc(W5=k5(W5=H5((t6=Q5=class t extends HO{constructor(...t){super(...t),nc(this,"_preview",X5,this),nc(this,"_fadeTime",Y5,this),nc(this,"_minSeg",K5,this),nc(this,"_stroke",J5,this),nc(this,"_texture",$5,this),nc(this,"_fastMode",Z5,this),this._points=[]}get preview(){return this._preview}set preview(t){this._preview=t,this.reset()}get fadeTime(){return this._fadeTime}set fadeTime(t){this._fadeTime=t,this.reset()}get minSeg(){return this._minSeg}set minSeg(t){this._minSeg=t}get stroke(){return this._stroke}set stroke(t){this._stroke=t}get texture(){return this._texture}set texture(t){this._texture!==t&&(this._texture=t)}get fastMode(){return this._fastMode}set fastMode(t){this._fastMode=t}get points(){return this._points}onEnable(){super.onEnable(),this.reset()}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)}onFocusInEditor(){this._preview&&this.reset()}onLostFocusInEditor(){this._preview&&this.reset()}reset(){this._points.length=0,this._renderData&&this._renderData.clear()}lateUpdate(t){this._assembler&&this._assembler.update(this,t)}_render(t){t.commitComp(this,this.renderData,this._texture,this._assembler,null)}},Q5.Point=class{constructor(t,e){this.point=new Oi,this.dir=new Oi,this.distance=0,this.time=0,t&&this.point.set(t),e&&this.dir.set(e)}setPoint(t,e){this.point.x=t,this.point.y=e}setDir(t,e){this.dir.x=t,this.dir.y=e}},sc((q5=t6).prototype,"preview",[Mc],Object.getOwnPropertyDescriptor(q5.prototype,"preview"),q5.prototype),sc(q5.prototype,"fadeTime",[Mc],Object.getOwnPropertyDescriptor(q5.prototype,"fadeTime"),q5.prototype),sc(q5.prototype,"minSeg",[Mc],Object.getOwnPropertyDescriptor(q5.prototype,"minSeg"),q5.prototype),sc(q5.prototype,"stroke",[Mc],Object.getOwnPropertyDescriptor(q5.prototype,"stroke"),q5.prototype),sc(q5.prototype,"texture",[j5],Object.getOwnPropertyDescriptor(q5.prototype,"texture"),q5.prototype),sc(q5.prototype,"fastMode",[Mc],Object.getOwnPropertyDescriptor(q5.prototype,"fastMode"),q5.prototype),X5=sc(q5.prototype,"_preview",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y5=sc(q5.prototype,"_fadeTime",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),K5=sc(q5.prototype,"_minSeg",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),J5=sc(q5.prototype,"_stroke",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),$5=sc(q5.prototype,"_texture",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Z5=sc(q5.prototype,"_fastMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),W5=q5))||W5)||W5)||W5)||W5)||W5));new Oi;const i6=new Oi,n6=new Oi;function s6(t,e){return t.x=-e.y,t.y=e.x,t}const r6={createData(t){const e=t.requestRenderData();return e.dataLength=4,e.resize(16,42),e},update(t,e){const i=t.stroke/2,n=t.node.worldMatrix,s=n.m12,r=n.m13,o=t.points;let a;if(o.length>1){const e=o[0],i=e.point.x-s,n=e.point.y-r;i*i+n*n<t.minSeg&&(a=e)}a||(a=new e6.Point,o.unshift(a)),a.setPoint(s,r),a.time=t.fadeTime+e;let c=0,l=0;if(o.length<2)return;const h=t.renderData;this.updateRenderDataCache(t,h);const _=t.color,u=_.r,d=_.g,m=_.b,p=_.a,f=o[1];f.distance=Oi.subtract(n6,a.point,f.point).length(),n6.normalize(),f.setDir(n6.x,n6.y),a.setDir(n6.x,n6.y),h.dataLength=2*o.length;const g=h.data,v=t.fadeTime;let y=!1;for(let t=o.length-1;t>=0;t--){const n=o[t],s=n.point,r=n.dir;if(n.time-=e,n.time<0){o.splice(t,1);continue}const a=n.time/v,l=o[t-1];if(!y){if(!l){o.splice(t,1);continue}s.x=l.point.x-r.x*a,s.y=l.point.y-r.y*a}y=!0,s6(i6,r);const h=(a*p<<24>>>0)+(m<<16)+(d<<8)+u;let _=c;g[_].x=s.x+i6.x*i,g[_].y=s.y+i6.y*i,g[_].u=1,g[_].v=a,g[_].color._val=h,_+=1,g[_].x=s.x-i6.x*i,g[_].y=s.y-i6.y*i,g[_].u=0,g[_].v=a,g[_].color._val=h,c+=2}l=c<=2?0:3*(c-2),h.resize(c,l)},updateRenderDataCache(t,e){e.passDirty&&e.updatePass(t),e.nodeDirty&&e.updateNode(t),e.textureDirty&&t.texture&&(e.updateTexture(t.texture),e.material=t.getRenderMaterial(0)),e.hashDirty&&e.updateHash()},updateRenderData(t){},updateColor(t){},fillBuffers(t,e){const i=t.renderData,n=i.chunk,s=i.data,r=i.vertexCount,o=i.indexCount,a=n.vb;let c=0;for(let t=0;t<r;t++){const e=s[t];a[c++]=e.x,a[c++]=e.y,a[c++]=e.z,a[c++]=e.u,a[c++]=e.v,hi.toArray(a,e.color,c),c+=4}const l=n.bufferId,h=n.vertexOffset,_=n.vertexAccessor.getMeshBuffer(n.bufferId),u=n.vertexAccessor.getIndexBuffer(l);let d=_.indexOffset;for(let t=0,e=o;t<e;t+=2){const e=h+t;u[d++]=e,u[d++]=e+2,u[d++]=e+1,u[d++]=e+1,u[d++]=e+2,u[d++]=e+3}_.indexOffset+=i.indexCount,_.setDirty()}},o6=t("MotionStreakAssemblerManager",{getAssembler:()=>r6});e6.Assembler=o6;const a6={maxParticleDeltaTime:0,createData:()=>JM.add(),removeData(t){JM.remove(t)},updateRenderData(){},fillBuffers(t,e){}},c6=t("ParticleSystem2DAssembler",{getAssembler:()=>(a6.maxParticleDeltaTime||(a6.maxParticleDeltaTime=l.game.frameTime/1e3*2),a6)});let l6,h6;G5.Assembler=c6,"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var _6,u6=function(t,e){return function(t,e){!function(t){function e(t,...e){if(!t)throw new Error(...e)}function i(t,e){return void 0!==t?t:e}const n=1e37,s=1e-5,r=s*s,o=3.14159265359,a=2,c=8,l=.1,h=2,_=.008,u=2/180*o,d=2*_,m=8,p=32,f=1,g=.2,v=8/180*o,y=2,x=y*y,S=.5*o,C=S*S,A=.2,b=.75,T=-1,E=2147483647,P=.75,w=1,I=.25,R=.5,D=2,M=D*D,O=256,B=2.5,N=.5,L=.01,F=2/180*o;function z(){return null}function V(){}function G(){}class U{constructor(t=0,e=0,i=0){this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}toString(){return this.major+"."+this.minor+"."+this.revision}}const k=new U(2,3,2),H="master",j="fbf51801d80fc389d43dc46524520e89043b6faf";function W(t){return parseInt(t,10)}function q(t){return Math.abs(parseInt(t,10))}function X(t,e){const i=new Array(t);for(let n=0;n<t;++n)i[n]=e(n);return i}function Y(t){const e=new Array(t);for(let i=0;i<t;++i)e[i]=null;return e}function K(t,e=0){const i=new Array(t);for(let n=0;n<t;++n)i[n]=e;return i}const J=o/180,$=180/o,Z=2*o,Q=Math.abs;function tt(t,e){return t<e?t:e}function et(t,e){return t>e?t:e}function it(t,e,i){return t<e?e:t>i?i:t}function nt(t,e){const i=t[0];t[0]=e[0],e[0]=i}const st=isFinite;function rt(t){return t*t}function ot(t){return 1/Math.sqrt(t)}const at=Math.sqrt,ct=Math.pow;function lt(t){return t*J}function ht(t){return t*$}const _t=Math.cos,ut=Math.sin,dt=Math.acos,mt=Math.asin,pt=Math.atan2;function ft(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,1+((t|=t>>8&16777215)|t>>16&65535)}function gt(t){return t>0&&0==(t&t-1)}function vt(){return 2*Math.random()-1}function yt(t,e){return(e-t)*Math.random()+t}class xt{constructor(...t){if(t[0]instanceof Float32Array){if(2!==t[0].length)throw new Error;this.data=t[0]}else{const e="number"==typeof t[0]?t[0]:0,i="number"==typeof t[1]?t[1]:0;this.data=new Float32Array([e,i])}}get x(){return this.data[0]}set x(t){this.data[0]=t}get y(){return this.data[1]}set y(t){this.data[1]=t}Clone(){return new xt(this.x,this.y)}SetZero(){return this.x=0,this.y=0,this}Set(t,e){return this.x=t,this.y=e,this}Copy(t){return this.x=t.x,this.y=t.y,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this}SelfAddXY(t,e){return this.x+=t,this.y+=e,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this}SelfSubXY(t,e){return this.x-=t,this.y-=e,this}SelfMul(t){return this.x*=t,this.y*=t,this}SelfMulAdd(t,e){return this.x+=t*e.x,this.y+=t*e.y,this}SelfMulSub(t,e){return this.x-=t*e.x,this.y-=t*e.y,this}Dot(t){return this.x*t.x+this.y*t.y}Cross(t){return this.x*t.y-this.y*t.x}Length(){const t=this.x,e=this.y;return Math.sqrt(t*t+e*e)}LengthSquared(){const t=this.x,e=this.y;return t*t+e*e}Normalize(){const t=this.Length();if(t>=s){const e=1/t;this.x*=e,this.y*=e}return t}SelfNormalize(){const t=this.Length();if(t>=s){const e=1/t;this.x*=e,this.y*=e}return this}SelfRotate(t){const e=Math.cos(t),i=Math.sin(t),n=this.x;return this.x=e*n-i*this.y,this.y=i*n+e*this.y,this}SelfRotateCosSin(t,e){const i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this}IsValid(){return isFinite(this.x)&&isFinite(this.y)}SelfCrossVS(t){const e=this.x;return this.x=t*this.y,this.y=-t*e,this}SelfCrossSV(t){const e=this.x;return this.x=-t*this.y,this.y=t*e,this}SelfMinV(t){return this.x=tt(this.x,t.x),this.y=tt(this.y,t.y),this}SelfMaxV(t){return this.x=et(this.x,t.x),this.y=et(this.y,t.y),this}SelfAbs(){return this.x=Q(this.x),this.y=Q(this.y),this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this}SelfSkew(){const t=this.x;return this.x=-this.y,this.y=t,this}static MakeArray(t){return X(t,(()=>new xt))}static AbsV(t,e){return e.x=Q(t.x),e.y=Q(t.y),e}static MinV(t,e,i){return i.x=tt(t.x,e.x),i.y=tt(t.y,e.y),i}static MaxV(t,e,i){return i.x=et(t.x,e.x),i.y=et(t.y,e.y),i}static ClampV(t,e,i,n){return n.x=it(t.x,e.x,i.x),n.y=it(t.y,e.y,i.y),n}static RotateV(t,e,i){const n=t.x,s=t.y,r=Math.cos(e),o=Math.sin(e);return i.x=r*n-o*s,i.y=o*n+r*s,i}static DotVV(t,e){return t.x*e.x+t.y*e.y}static CrossVV(t,e){return t.x*e.y-t.y*e.x}static CrossVS(t,e,i){const n=t.x;return i.x=e*t.y,i.y=-e*n,i}static CrossVOne(t,e){const i=t.x;return e.x=t.y,e.y=-i,e}static CrossSV(t,e,i){const n=e.x;return i.x=-t*e.y,i.y=t*n,i}static CrossOneV(t,e){const i=t.x;return e.x=-t.y,e.y=i,e}static AddVV(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i}static SubVV(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i}static MulSV(t,e,i){return i.x=e.x*t,i.y=e.y*t,i}static MulVS(t,e,i){return i.x=t.x*e,i.y=t.y*e,i}static AddVMulSV(t,e,i,n){return n.x=t.x+e*i.x,n.y=t.y+e*i.y,n}static SubVMulSV(t,e,i,n){return n.x=t.x-e*i.x,n.y=t.y-e*i.y,n}static AddVCrossSV(t,e,i,n){const s=i.x;return n.x=t.x-e*i.y,n.y=t.y+e*s,n}static MidVV(t,e,i){return i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i}static ExtVV(t,e,i){return i.x=.5*(e.x-t.x),i.y=.5*(e.y-t.y),i}static IsEqualToV(t,e){return t.x===e.x&&t.y===e.y}static DistanceVV(t,e){const i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)}static DistanceSquaredVV(t,e){const i=t.x-e.x,n=t.y-e.y;return i*i+n*n}static NegV(t,e){return e.x=-t.x,e.y=-t.y,e}}xt.ZERO=new xt(0,0),xt.UNITX=new xt(1,0),xt.UNITY=new xt(0,1),xt.s_t0=new xt,xt.s_t1=new xt,xt.s_t2=new xt,xt.s_t3=new xt;const St=new xt(0,0);class Ct{constructor(...t){if(t[0]instanceof Float32Array){if(3!==t[0].length)throw new Error;this.data=t[0]}else{const e="number"==typeof t[0]?t[0]:0,i="number"==typeof t[1]?t[1]:0,n="number"==typeof t[2]?t[2]:0;this.data=new Float32Array([e,i,n])}}get x(){return this.data[0]}set x(t){this.data[0]=t}get y(){return this.data[1]}set y(t){this.data[1]=t}get z(){return this.data[2]}set z(t){this.data[2]=t}Clone(){return new Ct(this.x,this.y,this.z)}SetZero(){return this.x=0,this.y=0,this.z=0,this}SetXYZ(t,e,i){return this.x=t,this.y=e,this.z=i,this}Copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}SelfAddXYZ(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}SelfSubXYZ(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this}SelfMul(t){return this.x*=t,this.y*=t,this.z*=t,this}static DotV3V3(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static CrossV3V3(t,e,i){const n=t.x,s=t.y,r=t.z,o=e.x,a=e.y,c=e.z;return i.x=s*c-r*a,i.y=r*o-n*c,i.z=n*a-s*o,i}}Ct.ZERO=new Ct(0,0,0),Ct.s_t0=new Ct;class At{constructor(){this.data=new Float32Array([1,0,0,1]),this.ex=new xt(this.data.subarray(0,2)),this.ey=new xt(this.data.subarray(2,4))}Clone(){return(new At).Copy(this)}static FromVV(t,e){return(new At).SetVV(t,e)}static FromSSSS(t,e,i,n){return(new At).SetSSSS(t,e,i,n)}static FromAngle(t){return(new At).SetAngle(t)}SetSSSS(t,e,i,n){return this.ex.Set(t,i),this.ey.Set(e,n),this}SetVV(t,e){return this.ex.Copy(t),this.ey.Copy(e),this}SetAngle(t){const e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this}SetIdentity(){return this.ex.Set(1,0),this.ey.Set(0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this}GetAngle(){return Math.atan2(this.ex.y,this.ex.x)}GetInverse(t){const e=this.ex.x,i=this.ey.x,n=this.ex.y,s=this.ey.y;let r=e*s-i*n;return 0!==r&&(r=1/r),t.ex.x=r*s,t.ey.x=-r*i,t.ex.y=-r*n,t.ey.y=r*e,t}Solve(t,e,i){const n=this.ex.x,s=this.ey.x,r=this.ex.y,o=this.ey.y;let a=n*o-s*r;return 0!==a&&(a=1/a),i.x=a*(o*t-s*e),i.y=a*(n*e-r*t),i}SelfAbs(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this}SelfInv(){return this.GetInverse(this),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this}SelfSubM(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this}static AbsM(t,e){const i=t.ex,n=t.ey;return e.ex.x=Q(i.x),e.ex.y=Q(i.y),e.ey.x=Q(n.x),e.ey.y=Q(n.y),e}static MulMV(t,e,i){const n=t.ex,s=t.ey,r=e.x,o=e.y;return i.x=n.x*r+s.x*o,i.y=n.y*r+s.y*o,i}static MulTMV(t,e,i){const n=t.ex,s=t.ey,r=e.x,o=e.y;return i.x=n.x*r+n.y*o,i.y=s.x*r+s.y*o,i}static AddMM(t,e,i){const n=t.ex,s=t.ey,r=e.ex,o=e.ey;return i.ex.x=n.x+r.x,i.ex.y=n.y+r.y,i.ey.x=s.x+o.x,i.ey.y=s.y+o.y,i}static MulMM(t,e,i){const n=t.ex.x,s=t.ex.y,r=t.ey.x,o=t.ey.y,a=e.ex.x,c=e.ex.y,l=e.ey.x,h=e.ey.y;return i.ex.x=n*a+r*c,i.ex.y=s*a+o*c,i.ey.x=n*l+r*h,i.ey.y=s*l+o*h,i}static MulTMM(t,e,i){const n=t.ex.x,s=t.ex.y,r=t.ey.x,o=t.ey.y,a=e.ex.x,c=e.ex.y,l=e.ey.x,h=e.ey.y;return i.ex.x=n*a+s*c,i.ex.y=r*a+o*c,i.ey.x=n*l+s*h,i.ey.y=r*l+o*h,i}}At.IDENTITY=new At;class bt{constructor(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new Ct(this.data.subarray(0,3)),this.ey=new Ct(this.data.subarray(3,6)),this.ez=new Ct(this.data.subarray(6,9))}Clone(){return(new bt).Copy(this)}SetVVV(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this}SetIdentity(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this}Solve33(t,e,i,n){const s=this.ex.x,r=this.ex.y,o=this.ex.z,a=this.ey.x,c=this.ey.y,l=this.ey.z,h=this.ez.x,_=this.ez.y,u=this.ez.z;let d=s*(c*u-l*_)+r*(l*h-a*u)+o*(a*_-c*h);return 0!==d&&(d=1/d),n.x=d*(t*(c*u-l*_)+e*(l*h-a*u)+i*(a*_-c*h)),n.y=d*(s*(e*u-i*_)+r*(i*h-t*u)+o*(t*_-e*h)),n.z=d*(s*(c*i-l*e)+r*(l*t-a*i)+o*(a*e-c*t)),n}Solve22(t,e,i){const n=this.ex.x,s=this.ey.x,r=this.ex.y,o=this.ey.y;let a=n*o-s*r;return 0!==a&&(a=1/a),i.x=a*(o*t-s*e),i.y=a*(n*e-r*t),i}GetInverse22(t){const e=this.ex.x,i=this.ey.x,n=this.ex.y,s=this.ey.y;let r=e*s-i*n;0!==r&&(r=1/r),t.ex.x=r*s,t.ey.x=-r*i,t.ex.z=0,t.ex.y=-r*n,t.ey.y=r*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0}GetSymInverse33(t){let e=Ct.DotV3V3(this.ex,Ct.CrossV3V3(this.ey,this.ez,Ct.s_t0));0!==e&&(e=1/e);const i=this.ex.x,n=this.ey.x,s=this.ez.x,r=this.ey.y,o=this.ez.y,a=this.ez.z;t.ex.x=e*(r*a-o*o),t.ex.y=e*(s*o-n*a),t.ex.z=e*(n*o-s*r),t.ey.x=t.ex.y,t.ey.y=e*(i*a-s*s),t.ey.z=e*(s*n-i*o),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*r-n*n)}static MulM33V3(t,e,i){const n=e.x,s=e.y,r=e.z;return i.x=t.ex.x*n+t.ey.x*s+t.ez.x*r,i.y=t.ex.y*n+t.ey.y*s+t.ez.y*r,i.z=t.ex.z*n+t.ey.z*s+t.ez.z*r,i}static MulM33XYZ(t,e,i,n,s){return s.x=t.ex.x*e+t.ey.x*i+t.ez.x*n,s.y=t.ex.y*e+t.ey.y*i+t.ez.y*n,s.z=t.ex.z*e+t.ey.z*i+t.ez.z*n,s}static MulM33V2(t,e,i){const n=e.x,s=e.y;return i.x=t.ex.x*n+t.ey.x*s,i.y=t.ex.y*n+t.ey.y*s,i}static MulM33XY(t,e,i,n){return n.x=t.ex.x*e+t.ey.x*i,n.y=t.ex.y*e+t.ey.y*i,n}}bt.IDENTITY=new bt;class Tt{constructor(t=0){this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}Clone(){return(new Tt).Copy(this)}Copy(t){return this.s=t.s,this.c=t.c,this}SetAngle(t){return this.s=Math.sin(t),this.c=Math.cos(t),this}SetIdentity(){return this.s=0,this.c=1,this}GetAngle(){return Math.atan2(this.s,this.c)}GetXAxis(t){return t.x=this.c,t.y=this.s,t}GetYAxis(t){return t.x=-this.s,t.y=this.c,t}static MulRR(t,e,i){const n=t.c,s=t.s,r=e.c,o=e.s;return i.s=s*r+n*o,i.c=n*r-s*o,i}static MulTRR(t,e,i){const n=t.c,s=t.s,r=e.c,o=e.s;return i.s=n*o-s*r,i.c=n*r+s*o,i}static MulRV(t,e,i){const n=t.c,s=t.s,r=e.x,o=e.y;return i.x=n*r-s*o,i.y=s*r+n*o,i}static MulTRV(t,e,i){const n=t.c,s=t.s,r=e.x,o=e.y;return i.x=n*r+s*o,i.y=-s*r+n*o,i}}Tt.IDENTITY=new Tt;class Et{constructor(){this.p=new xt,this.q=new Tt}Clone(){return(new Et).Copy(this)}Copy(t){return this.p.Copy(t.p),this.q.Copy(t.q),this}SetIdentity(){return this.p.SetZero(),this.q.SetIdentity(),this}SetPositionRotation(t,e){return this.p.Copy(t),this.q.Copy(e),this}SetPositionAngle(t,e){return this.p.Copy(t),this.q.SetAngle(e),this}SetPosition(t){return this.p.Copy(t),this}SetPositionXY(t,e){return this.p.Set(t,e),this}SetRotation(t){return this.q.Copy(t),this}SetRotationAngle(t){return this.q.SetAngle(t),this}GetPosition(){return this.p}GetRotation(){return this.q}GetRotationAngle(){return this.q.GetAngle()}GetAngle(){return this.q.GetAngle()}static MulXV(t,e,i){const n=t.q.c,s=t.q.s,r=e.x,o=e.y;return i.x=n*r-s*o+t.p.x,i.y=s*r+n*o+t.p.y,i}static MulTXV(t,e,i){const n=t.q.c,s=t.q.s,r=e.x-t.p.x,o=e.y-t.p.y;return i.x=n*r+s*o,i.y=-s*r+n*o,i}static MulXX(t,e,i){return Tt.MulRR(t.q,e.q,i.q),xt.AddVV(Tt.MulRV(t.q,e.p,i.p),t.p,i.p),i}static MulTXX(t,e,i){return Tt.MulTRR(t.q,e.q,i.q),Tt.MulTRV(t.q,xt.SubVV(e.p,t.p,i.p),i.p),i}}Et.IDENTITY=new Et;class Pt{constructor(){this.localCenter=new xt,this.c0=new xt,this.c=new xt,this.a0=0,this.a=0,this.alpha0=0}Clone(){return(new Pt).Copy(this)}Copy(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this}GetTransform(t,e){const i=1-e;t.p.x=i*this.c0.x+e*this.c.x,t.p.y=i*this.c0.y+e*this.c.y;const n=i*this.a0+e*this.a;return t.q.SetAngle(n),t.p.SelfSub(Tt.MulRV(t.q,this.localCenter,xt.s_t0)),t}Advance(t){const e=(t-this.alpha0)/(1-this.alpha0),i=1-e;this.c0.x=i*this.c0.x+e*this.c.x,this.c0.y=i*this.c0.y+e*this.c.y,this.a0=i*this.a0+e*this.a,this.alpha0=t}Normalize(){const t=Z*Math.floor(this.a0/Z);this.a0-=t,this.a-=t}}class wt{constructor(...t){if(t[0]instanceof Float32Array){if(4!==t[0].length)throw new Error;this.data=t[0]}else{const e="number"==typeof t[0]?t[0]:.5,i="number"==typeof t[1]?t[1]:.5,n="number"==typeof t[2]?t[2]:.5,s="number"==typeof t[3]?t[3]:1;this.data=new Float32Array([e,i,n,s])}}get r(){return this.data[0]}set r(t){this.data[0]=t}get g(){return this.data[1]}set g(t){this.data[1]=t}get b(){return this.data[2]}set b(t){this.data[2]=t}get a(){return this.data[3]}set a(t){this.data[3]=t}Clone(){return(new wt).Copy(this)}Copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}IsEqual(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}IsZero(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a}Set(t,e,i,n=this.a){this.SetRGBA(t,e,i,n)}SetByteRGB(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this}SetByteRGBA(t,e,i,n){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=n/255,this}SetRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}SetRGBA(t,e,i,n){return this.r=t,this.g=e,this.b=i,this.a=n,this}SelfAdd(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this}Add(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e}SelfSub(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this}Sub(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e}SelfMul(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this}Mul(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e}Mix(t,e){wt.MixColors(this,t,e)}static MixColors(t,e,i){const n=i*(e.r-t.r),s=i*(e.g-t.g),r=i*(e.b-t.b),o=i*(e.a-t.a);t.r+=n,t.g+=s,t.b+=r,t.a+=o,e.r-=n,e.g-=s,e.b-=r,e.a-=o}MakeStyleString(t=this.a){return wt.MakeStyleString(this.r,this.g,this.b,t)}static MakeStyleString(t,e,i,n=1){return t*=255,e*=255,i*=255,n<1?`rgba(${t},${e},${i},${n})`:`rgb(${t},${e},${i})`}}var It;wt.ZERO=new wt(0,0,0,0),wt.RED=new wt(1,0,0),wt.GREEN=new wt(0,1,0),wt.BLUE=new wt(0,0,1),(It=t.b2DrawFlags||(t.b2DrawFlags={}))[It.e_none=0]="e_none",It[It.e_shapeBit=1]="e_shapeBit",It[It.e_jointBit=2]="e_jointBit",It[It.e_aabbBit=4]="e_aabbBit",It[It.e_pairBit=8]="e_pairBit",It[It.e_centerOfMassBit=16]="e_centerOfMassBit",It[It.e_particleBit=32]="e_particleBit",It[It.e_controllerBit=64]="e_controllerBit",It[It.e_all=63]="e_all";class Rt{constructor(){this.m_drawFlags=0}SetFlags(t){this.m_drawFlags=t}GetFlags(){return this.m_drawFlags}AppendFlags(t){this.m_drawFlags|=t}ClearFlags(t){this.m_drawFlags&=~t}}class Dt{constructor(){this.m_start=Date.now()}Reset(){return this.m_start=Date.now(),this}GetMilliseconds(){return Date.now()-this.m_start}}class Mt{constructor(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}GetCount(){return this.m_count}GetMinCount(){return this.m_min_count}GetMaxCount(){return this.m_max_count}ResetCount(){const t=this.m_count;return this.m_count=0,t}ResetMinCount(){this.m_min_count=0}ResetMaxCount(){this.m_max_count=0}Increment(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)}Decrement(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)}}class Ot{constructor(t){this.m_stack=[],this.m_count=0,this.m_stack=X(t,(()=>null)),this.m_count=0}Reset(){return this.m_count=0,this}Push(t){this.m_stack[this.m_count]=t,this.m_count++}Pop(){this.m_count--;const t=this.m_stack[this.m_count];if(this.m_stack[this.m_count]=null,null===t)throw new Error;return t}GetCount(){return this.m_count}}class Bt{}class Nt{}class Lt{constructor(){this.m_buffer=xt.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}Copy(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this}Reset(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this}SetShape(t,e){t.SetupDistanceProxy(this,e)}SetVerticesRadius(t,e,i){this.m_vertices=t,this.m_count=e,this.m_radius=i}GetSupport(t){let e=0,i=xt.DotVV(this.m_vertices[0],t);for(let n=1;n<this.m_count;++n){const s=xt.DotVV(this.m_vertices[n],t);s>i&&(e=n,i=s)}return e}GetSupportVertex(t){let e=0,i=xt.DotVV(this.m_vertices[0],t);for(let n=1;n<this.m_count;++n){const s=xt.DotVV(this.m_vertices[n],t);s>i&&(e=n,i=s)}return this.m_vertices[e]}GetVertexCount(){return this.m_count}GetVertex(t){return this.m_vertices[t]}}class Ft{constructor(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}Reset(){return this.metric=0,this.count=0,this}}class zt{constructor(){this.proxyA=new Lt,this.proxyB=new Lt,this.transformA=new Et,this.transformB=new Et,this.useRadii=!1}Reset(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this}}class Vt{constructor(){this.pointA=new xt,this.pointB=new xt,this.distance=0,this.iterations=0}Reset(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this}}class Gt{constructor(){this.proxyA=new Lt,this.proxyB=new Lt,this.transformA=new Et,this.transformB=new Et,this.translationB=new xt}}class Ut{constructor(){this.point=new xt,this.normal=new xt,this.lambda=0,this.iterations=0}}function kt(){t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0}t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0;class Ht{constructor(){this.wA=new xt,this.wB=new xt,this.w=new xt,this.a=0,this.indexA=0,this.indexB=0}Copy(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this}}class jt{constructor(){this.m_v1=new Ht,this.m_v2=new Ht,this.m_v3=new Ht,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}ReadCache(t,e,i,n,r){this.m_count=t.count;const o=this.m_vertices;for(let s=0;s<this.m_count;++s){const a=o[s];a.indexA=t.indexA[s],a.indexB=t.indexB[s];const c=e.GetVertex(a.indexA),l=n.GetVertex(a.indexB);Et.MulXV(i,c,a.wA),Et.MulXV(r,l,a.wB),xt.SubVV(a.wB,a.wA,a.w),a.a=0}if(this.m_count>1){const e=t.metric,i=this.GetMetric();(i<.5*e||2*e<i||i<s)&&(this.m_count=0)}if(0===this.m_count){const t=o[0];t.indexA=0,t.indexB=0;const s=e.GetVertex(0),a=n.GetVertex(0);Et.MulXV(i,s,t.wA),Et.MulXV(r,a,t.wB),xt.SubVV(t.wB,t.wA,t.w),t.a=1,this.m_count=1}}WriteCache(t){t.metric=this.GetMetric(),t.count=this.m_count;const e=this.m_vertices;for(let i=0;i<this.m_count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB}GetSearchDirection(t){switch(this.m_count){case 1:return xt.NegV(this.m_v1.w,t);case 2:{const e=xt.SubVV(this.m_v2.w,this.m_v1.w,t);return xt.CrossVV(e,xt.NegV(this.m_v1.w,xt.s_t0))>0?xt.CrossOneV(e,t):xt.CrossVOne(e,t)}default:return t.SetZero()}}GetClosestPoint(t){switch(this.m_count){case 0:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:default:return t.SetZero()}}GetWitnessPoints(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}}GetMetric(){switch(this.m_count){case 0:case 1:return 0;case 2:return xt.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return xt.CrossVV(xt.SubVV(this.m_v2.w,this.m_v1.w,xt.s_t0),xt.SubVV(this.m_v3.w,this.m_v1.w,xt.s_t1));default:return 0}}Solve2(){const t=this.m_v1.w,e=this.m_v2.w,i=xt.SubVV(e,t,jt.s_e12),n=-xt.DotVV(t,i);if(n<=0)return this.m_v1.a=1,void(this.m_count=1);const s=xt.DotVV(e,i);if(s<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);const r=1/(s+n);this.m_v1.a=s*r,this.m_v2.a=n*r,this.m_count=2}Solve3(){const t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,n=xt.SubVV(e,t,jt.s_e12),s=xt.DotVV(t,n),r=xt.DotVV(e,n),o=-s,a=xt.SubVV(i,t,jt.s_e13),c=xt.DotVV(t,a),l=xt.DotVV(i,a),h=-c,_=xt.SubVV(i,e,jt.s_e23),u=xt.DotVV(e,_),d=xt.DotVV(i,_),m=-u,p=xt.CrossVV(n,a),f=p*xt.CrossVV(e,i),g=p*xt.CrossVV(i,t),v=p*xt.CrossVV(t,e);if(o<=0&&h<=0)return this.m_v1.a=1,void(this.m_count=1);if(r>0&&o>0&&v<=0){const t=1/(r+o);return this.m_v1.a=r*t,this.m_v2.a=o*t,void(this.m_count=2)}if(l>0&&h>0&&g<=0){const t=1/(l+h);return this.m_v1.a=l*t,this.m_v3.a=h*t,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(r<=0&&m<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(l<=0&&d<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(d>0&&m>0&&f<=0){const t=1/(d+m);return this.m_v2.a=d*t,this.m_v3.a=m*t,this.m_count=2,void this.m_v1.Copy(this.m_v3)}const y=1/(f+g+v);this.m_v1.a=f*y,this.m_v2.a=g*y,this.m_v3.a=v*y,this.m_count=3}}jt.s_e12=new xt,jt.s_e13=new xt,jt.s_e23=new xt;const Wt=new jt,qt=[0,0,0],Xt=[0,0,0],Yt=new xt,Kt=new xt,Jt=new xt,$t=new xt,Zt=new xt;function Qt(e,i,n){++t.b2_gjkCalls;const o=n.proxyA,a=n.proxyB,c=n.transformA,l=n.transformB,h=Wt;h.ReadCache(i,o,c,a,l);const _=h.m_vertices,u=20,d=qt,m=Xt;let p=0,f=0;for(;f<u;){p=h.m_count;for(let t=0;t<p;++t)d[t]=_[t].indexA,m[t]=_[t].indexB;switch(h.m_count){case 1:break;case 2:h.Solve2();break;case 3:h.Solve3()}if(3===h.m_count)break;const e=h.GetSearchDirection(Kt);if(e.LengthSquared()<r)break;const i=_[h.m_count];i.indexA=o.GetSupport(Tt.MulTRV(c.q,xt.NegV(e,xt.s_t0),$t)),Et.MulXV(c,o.GetVertex(i.indexA),i.wA),i.indexB=a.GetSupport(Tt.MulTRV(l.q,e,Zt)),Et.MulXV(l,a.GetVertex(i.indexB),i.wB),xt.SubVV(i.wB,i.wA,i.w),++f,++t.b2_gjkIters;let n=!1;for(let t=0;t<p;++t)if(i.indexA===d[t]&&i.indexB===m[t]){n=!0;break}if(n)break;++h.m_count}if(t.b2_gjkMaxIters=et(t.b2_gjkMaxIters,f),h.GetWitnessPoints(e.pointA,e.pointB),e.distance=xt.DistanceVV(e.pointA,e.pointB),e.iterations=f,h.WriteCache(i),n.useRadii){const t=o.m_radius,i=a.m_radius;if(e.distance>t+i&&e.distance>s){e.distance-=t+i;const n=xt.SubVV(e.pointB,e.pointA,Jt);n.Normalize(),e.pointA.SelfMulAdd(t,n),e.pointB.SelfMulSub(i,n)}else{const t=xt.MidVV(e.pointA,e.pointB,Yt);e.pointA.Copy(t),e.pointB.Copy(t),e.distance=0}}}const te=new xt,ee=new jt,ie=new xt,ne=new xt,se=new xt,re=new xt,oe=new xt,ae=new xt;function ce(t,e){t.iterations=0,t.lambda=1,t.normal.SetZero(),t.point.SetZero();const i=e.proxyA,n=e.proxyB,s=et(i.m_radius,d)+et(n.m_radius,d),r=e.transformA,o=e.transformB,a=e.translationB,c=te.Set(0,0);let l=0;const h=ee;h.m_count=0;const u=h.m_vertices;let m=i.GetSupport(Tt.MulTRV(r.q,xt.NegV(a,xt.s_t1),xt.s_t0)),p=Et.MulXV(r,i.GetVertex(m),ie),f=n.GetSupport(Tt.MulTRV(o.q,a,xt.s_t0)),g=Et.MulXV(o,n.GetVertex(f),ne);const v=xt.SubVV(p,g,se),y=et(d,s-d),x=.5*_,S=20;let C=0;for(;C<S&&Q(v.Length()-y)>x;){t.iterations+=1,m=i.GetSupport(Tt.MulTRV(r.q,xt.NegV(v,xt.s_t1),xt.s_t0)),p=Et.MulXV(r,i.GetVertex(m),ie),f=n.GetSupport(Tt.MulTRV(o.q,v,xt.s_t0)),g=Et.MulXV(o,n.GetVertex(f),ne);const e=xt.SubVV(p,g,re);v.Normalize();const s=xt.DotVV(v,e),_=xt.DotVV(v,a);if(s-y>l*_){if(_<=0)return!1;if(l=(s-y)/_,l>1)return!1;c.Copy(v).SelfNeg(),h.m_count=0}const d=u[h.m_count];switch(d.indexA=f,d.wA.Copy(g).SelfMulAdd(l,a),d.indexB=m,d.wB.Copy(p),d.w.Copy(d.wB).SelfSub(d.wA),d.a=1,h.m_count+=1,h.m_count){case 1:break;case 2:h.Solve2();break;case 3:h.Solve3()}if(3===h.m_count)return!1;h.GetClosestPoint(v),++C}const A=oe,b=ae;return h.GetWitnessPoints(A,b),v.LengthSquared()>0&&(c.Copy(v).SelfNeg(),c.Normalize()),t.normal.Copy(c),t.lambda=l,t.iterations=C,!0}var le,he,_e;(le=t.b2ContactFeatureType||(t.b2ContactFeatureType={}))[le.e_vertex=0]="e_vertex",le[le.e_face=1]="e_face";class ue{constructor(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}get key(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key}set key(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}get indexA(){return this._indexA}set indexA(t){this._indexA=t,this._key_invalid=!0}get indexB(){return this._indexB}set indexB(t){this._indexB=t,this._key_invalid=!0}get typeA(){return this._typeA}set typeA(t){this._typeA=t,this._key_invalid=!0}get typeB(){return this._typeB}set typeB(t){this._typeB=t,this._key_invalid=!0}}class de{constructor(){this.cf=new ue}Copy(t){return this.key=t.key,this}Clone(){return(new de).Copy(this)}get key(){return this.cf.key}set key(t){this.cf.key=t}}class me{constructor(){this.localPoint=new xt,this.normalImpulse=0,this.tangentImpulse=0,this.id=new de}static MakeArray(t){return X(t,(()=>new me))}Reset(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0}Copy(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this}}(he=t.b2ManifoldType||(t.b2ManifoldType={}))[he.e_unknown=-1]="e_unknown",he[he.e_circles=0]="e_circles",he[he.e_faceA=1]="e_faceA",he[he.e_faceB=2]="e_faceB";class pe{constructor(){this.points=me.MakeArray(a),this.localNormal=new xt,this.localPoint=new xt,this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}Reset(){for(let t=0;t<a;++t)this.points[t].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}Copy(t){this.pointCount=t.pointCount;for(let e=0;e<a;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this}Clone(){return(new pe).Copy(this)}}class fe{constructor(){this.normal=new xt,this.points=xt.MakeArray(a),this.separations=K(a)}Initialize(e,i,n,s,o){if(0!==e.pointCount)switch(e.type){case t.b2ManifoldType.e_circles:{this.normal.Set(1,0);const t=Et.MulXV(i,e.localPoint,fe.Initialize_s_pointA),a=Et.MulXV(s,e.points[0].localPoint,fe.Initialize_s_pointB);xt.DistanceSquaredVV(t,a)>r&&xt.SubVV(a,t,this.normal).SelfNormalize();const c=xt.AddVMulSV(t,n,this.normal,fe.Initialize_s_cA),l=xt.SubVMulSV(a,o,this.normal,fe.Initialize_s_cB);xt.MidVV(c,l,this.points[0]),this.separations[0]=xt.DotVV(xt.SubVV(l,c,xt.s_t0),this.normal);break}case t.b2ManifoldType.e_faceA:{Tt.MulRV(i.q,e.localNormal,this.normal);const t=Et.MulXV(i,e.localPoint,fe.Initialize_s_planePoint);for(let i=0;i<e.pointCount;++i){const r=Et.MulXV(s,e.points[i].localPoint,fe.Initialize_s_clipPoint),a=n-xt.DotVV(xt.SubVV(r,t,xt.s_t0),this.normal),c=xt.AddVMulSV(r,a,this.normal,fe.Initialize_s_cA),l=xt.SubVMulSV(r,o,this.normal,fe.Initialize_s_cB);xt.MidVV(c,l,this.points[i]),this.separations[i]=xt.DotVV(xt.SubVV(l,c,xt.s_t0),this.normal)}break}case t.b2ManifoldType.e_faceB:{Tt.MulRV(s.q,e.localNormal,this.normal);const t=Et.MulXV(s,e.localPoint,fe.Initialize_s_planePoint);for(let s=0;s<e.pointCount;++s){const r=Et.MulXV(i,e.points[s].localPoint,fe.Initialize_s_clipPoint),a=o-xt.DotVV(xt.SubVV(r,t,xt.s_t0),this.normal),c=xt.AddVMulSV(r,a,this.normal,fe.Initialize_s_cB),l=xt.SubVMulSV(r,n,this.normal,fe.Initialize_s_cA);xt.MidVV(l,c,this.points[s]),this.separations[s]=xt.DotVV(xt.SubVV(l,c,xt.s_t0),this.normal)}this.normal.SelfNeg();break}}}}function ge(e,i,n,s){let r;for(r=0;r<n.pointCount;++r){const i=n.points[r].id.key;e[r]=t.b2PointState.b2_removeState;for(let n=0,o=s.pointCount;n<o;++n)if(s.points[n].id.key===i){e[r]=t.b2PointState.b2_persistState;break}}for(;r<a;++r)e[r]=t.b2PointState.b2_nullState;for(r=0;r<s.pointCount;++r){const e=s.points[r].id.key;i[r]=t.b2PointState.b2_addState;for(let s=0,o=n.pointCount;s<o;++s)if(n.points[s].id.key===e){i[r]=t.b2PointState.b2_persistState;break}}for(;r<a;++r)i[r]=t.b2PointState.b2_nullState}fe.Initialize_s_pointA=new xt,fe.Initialize_s_pointB=new xt,fe.Initialize_s_cA=new xt,fe.Initialize_s_cB=new xt,fe.Initialize_s_planePoint=new xt,fe.Initialize_s_clipPoint=new xt,(_e=t.b2PointState||(t.b2PointState={}))[_e.b2_nullState=0]="b2_nullState",_e[_e.b2_addState=1]="b2_addState",_e[_e.b2_persistState=2]="b2_persistState",_e[_e.b2_removeState=3]="b2_removeState";class ve{constructor(){this.v=new xt,this.id=new de}static MakeArray(t){return X(t,(()=>new ve))}Copy(t){return this.v.Copy(t.v),this.id.Copy(t.id),this}}class ye{constructor(){this.p1=new xt,this.p2=new xt,this.maxFraction=1}Copy(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this}}class xe{constructor(){this.normal=new xt,this.fraction=0}Copy(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this}}class Se{constructor(){this.lowerBound=new xt,this.upperBound=new xt,this.m_cache_center=new xt,this.m_cache_extent=new xt}Copy(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this}IsValid(){return!(!this.lowerBound.IsValid()||!this.upperBound.IsValid()||this.upperBound.x<this.lowerBound.x||this.upperBound.y<this.lowerBound.y)}GetCenter(){return xt.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)}GetExtents(){return xt.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)}GetPerimeter(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))}Combine1(t){return this.lowerBound.x=tt(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=tt(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=et(this.upperBound.x,t.upperBound.x),this.upperBound.y=et(this.upperBound.y,t.upperBound.y),this}Combine2(t,e){return this.lowerBound.x=tt(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=tt(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=et(t.upperBound.x,e.upperBound.x),this.upperBound.y=et(t.upperBound.y,e.upperBound.y),this}static Combine(t,e,i){return i.Combine2(t,e),i}Contains(t){return!(this.lowerBound.x<=t.lowerBound.x||this.lowerBound.y<=t.lowerBound.y||t.upperBound.x<=this.upperBound.x||t.upperBound.y<=this.upperBound.y)}RayCast(t,e){let i=-n,r=n;const o=e.p1.x,a=e.p1.y,c=e.p2.x-e.p1.x,l=e.p2.y-e.p1.y,h=Q(c),_=Q(l),u=t.normal;if(h<s){if(o<this.lowerBound.x||this.upperBound.x<o)return!1}else{const t=1/c;let e=(this.lowerBound.x-o)*t,n=(this.upperBound.x-o)*t,s=-1;if(e>n){const t=e;e=n,n=t,s=1}if(e>i&&(u.x=s,u.y=0,i=e),r=tt(r,n),i>r)return!1}if(_<s){if(a<this.lowerBound.y||this.upperBound.y<a)return!1}else{const t=1/l;let e=(this.lowerBound.y-a)*t,n=(this.upperBound.y-a)*t,s=-1;if(e>n){const t=e;e=n,n=t,s=1}if(e>i&&(u.x=0,u.y=s,i=e),r=tt(r,n),i>r)return!1}return!(i<0||e.maxFraction<i||(t.fraction=i,0))}TestContain(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x||t.y<this.lowerBound.y||this.upperBound.y<t.y)}TestOverlap(t){return!(this.upperBound.x<t.lowerBound.x||this.upperBound.y<t.lowerBound.y||t.upperBound.x<this.lowerBound.x||t.upperBound.y<this.lowerBound.y)}}function Ce(t,e){return!(t.upperBound.x<e.lowerBound.x||t.upperBound.y<e.lowerBound.y||e.upperBound.x<t.lowerBound.x||e.upperBound.y<t.lowerBound.y)}function Ae(e,i,n,s,r){let o=0;const a=i[0],c=i[1],l=xt.DotVV(n,a.v)-s,h=xt.DotVV(n,c.v)-s;if(l<=0&&e[o++].Copy(a),h<=0&&e[o++].Copy(c),l*h<0){const i=l/(l-h),n=e[o].v;n.x=a.v.x+i*(c.v.x-a.v.x),n.y=a.v.y+i*(c.v.y-a.v.y);const s=e[o].id;s.cf.indexA=r,s.cf.indexB=a.id.cf.indexB,s.cf.typeA=t.b2ContactFeatureType.e_vertex,s.cf.typeB=t.b2ContactFeatureType.e_face,++o}return o}const be=new zt,Te=new Ft,Ee=new Vt;function Pe(t,e,i,n,r,o){const a=be.Reset();a.proxyA.SetShape(t,e),a.proxyB.SetShape(i,n),a.transformA.Copy(r),a.transformB.Copy(o),a.useRadii=!0;const c=Te.Reset();c.count=0;const l=Ee.Reset();return Qt(l,c,a),l.distance<10*s}function we(t){if(null===t)throw new Error;return t}class Ie{constructor(t=0){this.m_id=0,this.aabb=new Se,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}get userData(){if(null===this._userData)throw new Error;return this._userData}set userData(t){if(null!==this._userData)throw new Error;this._userData=t}Reset(){this._userData=null}IsLeaf(){return null===this.child1}}class Re{constructor(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0,this.m_stack=new Ot(256)}Query(t,e){const i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const n=i.Pop();if(null!==n&&n.aabb.TestOverlap(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}}QueryPoint(t,e){const i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const n=i.Pop();if(null!==n&&n.aabb.TestContain(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}}RayCast(t,e){const i=t.p1,n=t.p2,s=xt.SubVV(n,i,Re.s_r);s.Normalize();const r=xt.CrossOneV(s,Re.s_v),o=xt.AbsV(r,Re.s_abs_v);let a=t.maxFraction;const c=Re.s_segmentAABB;let l=i.x+a*(n.x-i.x),h=i.y+a*(n.y-i.y);c.lowerBound.x=tt(i.x,l),c.lowerBound.y=tt(i.y,h),c.upperBound.x=et(i.x,l),c.upperBound.y=et(i.y,h);const _=this.m_stack.Reset();for(_.Push(this.m_root);_.GetCount()>0;){const s=_.Pop();if(null===s)continue;if(!Ce(s.aabb,c))continue;const u=s.aabb.GetCenter(),d=s.aabb.GetExtents();if(!(Q(xt.DotVV(r,xt.SubVV(i,u,xt.s_t0)))-xt.DotVV(o,d)>0))if(s.IsLeaf()){const r=Re.s_subInput;r.p1.Copy(t.p1),r.p2.Copy(t.p2),r.maxFraction=a;const o=e(r,s);if(0===o)return;o>0&&(a=o,l=i.x+a*(n.x-i.x),h=i.y+a*(n.y-i.y),c.lowerBound.x=tt(i.x,l),c.lowerBound.y=tt(i.y,h),c.upperBound.x=et(i.x,l),c.upperBound.y=et(i.y,h))}else _.Push(s.child1),_.Push(s.child2)}}AllocateNode(){if(null!==this.m_freeList){const t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t}return new Ie(Re.s_node_id++)}FreeNode(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,t.Reset(),this.m_freeList=t}CreateProxy(t,e){const i=this.AllocateNode(),n=l,s=l;return i.aabb.lowerBound.x=t.lowerBound.x-n,i.aabb.lowerBound.y=t.lowerBound.y-s,i.aabb.upperBound.x=t.upperBound.x+n,i.aabb.upperBound.y=t.upperBound.y+s,i.userData=e,i.height=0,this.InsertLeaf(i),i}DestroyProxy(t){this.RemoveLeaf(t),this.FreeNode(t)}MoveProxy(t,e,i){if(t.aabb.Contains(e))return!1;this.RemoveLeaf(t);const n=l,s=l;t.aabb.lowerBound.x=e.lowerBound.x-n,t.aabb.lowerBound.y=e.lowerBound.y-s,t.aabb.upperBound.x=e.upperBound.x+n,t.aabb.upperBound.y=e.upperBound.y+s;const r=h*i.x,o=h*i.y;return r<0?t.aabb.lowerBound.x+=r:t.aabb.upperBound.x+=r,o<0?t.aabb.lowerBound.y+=o:t.aabb.upperBound.y+=o,this.InsertLeaf(t),!0}InsertLeaf(t){if(++this.m_insertionCount,null===this.m_root)return this.m_root=t,void(this.m_root.parent=null);const e=t.aabb;let i=this.m_root;for(;!i.IsLeaf();){const t=we(i.child1),n=we(i.child2),s=i.aabb.GetPerimeter(),r=Re.s_combinedAABB;r.Combine2(i.aabb,e);const o=r.GetPerimeter(),a=2*o,c=2*(o-s);let l;const h=Re.s_aabb;let _,u,d;if(t.IsLeaf()?(h.Combine2(e,t.aabb),l=h.GetPerimeter()+c):(h.Combine2(e,t.aabb),_=t.aabb.GetPerimeter(),u=h.GetPerimeter(),l=u-_+c),n.IsLeaf()?(h.Combine2(e,n.aabb),d=h.GetPerimeter()+c):(h.Combine2(e,n.aabb),_=n.aabb.GetPerimeter(),u=h.GetPerimeter(),d=u-_+c),a<l&&a<d)break;i=l<d?t:n}const n=i.parent,s=this.AllocateNode();s.parent=n,s.aabb.Combine2(e,i.aabb),s.height=i.height+1,null!==n?(n.child1===i?n.child1=s:n.child2=s,s.child1=i,s.child2=t,i.parent=s,t.parent=s):(s.child1=i,s.child2=t,i.parent=s,t.parent=s,this.m_root=s);let r=t.parent;for(;null!==r;){r=this.Balance(r);const t=we(r.child1),e=we(r.child2);r.height=1+et(t.height,e.height),r.aabb.Combine2(t.aabb,e.aabb),r=r.parent}}RemoveLeaf(t){if(t===this.m_root)return void(this.m_root=null);const e=we(t.parent),i=e&&e.parent,n=we(e.child1===t?e.child2:e.child1);if(null!==i){i.child1===e?i.child1=n:i.child2=n,n.parent=i,this.FreeNode(e);let t=i;for(;null!==t;){t=this.Balance(t);const e=we(t.child1),i=we(t.child2);t.aabb.Combine2(e.aabb,i.aabb),t.height=1+et(e.height,i.height),t=t.parent}}else this.m_root=n,n.parent=null,this.FreeNode(e)}Balance(t){if(t.IsLeaf()||t.height<2)return t;const e=we(t.child1),i=we(t.child2),n=i.height-e.height;if(n>1){const n=we(i.child1),s=we(i.child2);return i.child1=t,i.parent=t.parent,t.parent=i,null!==i.parent?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.m_root=i,n.height>s.height?(i.child2=n,t.child2=s,s.parent=t,t.aabb.Combine2(e.aabb,s.aabb),i.aabb.Combine2(t.aabb,n.aabb),t.height=1+et(e.height,s.height),i.height=1+et(t.height,n.height)):(i.child2=s,t.child2=n,n.parent=t,t.aabb.Combine2(e.aabb,n.aabb),i.aabb.Combine2(t.aabb,s.aabb),t.height=1+et(e.height,n.height),i.height=1+et(t.height,s.height)),i}if(n<-1){const n=we(e.child1),s=we(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,null!==e.parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,n.height>s.height?(e.child2=n,t.child1=s,s.parent=t,t.aabb.Combine2(i.aabb,s.aabb),e.aabb.Combine2(t.aabb,n.aabb),t.height=1+et(i.height,s.height),e.height=1+et(t.height,n.height)):(e.child2=s,t.child1=n,n.parent=t,t.aabb.Combine2(i.aabb,n.aabb),e.aabb.Combine2(t.aabb,s.aabb),t.height=1+et(i.height,n.height),e.height=1+et(t.height,s.height)),e}return t}GetHeight(){return null===this.m_root?0:this.m_root.height}static GetAreaNode(t){if(null===t)return 0;if(t.IsLeaf())return 0;let e=t.aabb.GetPerimeter();return e+=Re.GetAreaNode(t.child1),e+=Re.GetAreaNode(t.child2),e}GetAreaRatio(){if(null===this.m_root)return 0;const t=this.m_root.aabb.GetPerimeter();return Re.GetAreaNode(this.m_root)/t}static ComputeHeightNode(t){return null===t||t.IsLeaf()?0:1+et(Re.ComputeHeightNode(t.child1),Re.ComputeHeightNode(t.child2))}ComputeHeight(){return Re.ComputeHeightNode(this.m_root)}ValidateStructure(t){if(null===t)return;if(this.m_root,t.IsLeaf())return;const e=we(t.child1),i=we(t.child2);this.ValidateStructure(e),this.ValidateStructure(i)}ValidateMetrics(t){if(null===t)return;if(t.IsLeaf())return;const e=we(t.child1),i=we(t.child2);Re.s_aabb.Combine2(e.aabb,i.aabb),this.ValidateMetrics(e),this.ValidateMetrics(i)}Validate(){}static GetMaxBalanceNode(t,e){if(null===t)return e;if(t.height<=1)return e;const i=we(t.child1),n=we(t.child2);return et(e,Q(n.height-i.height))}GetMaxBalance(){return Re.GetMaxBalanceNode(this.m_root,0)}RebuildBottomUp(){this.Validate()}static ShiftOriginNode(t,e){if(null===t)return;if(t.height<=1)return;const i=t.child1,n=t.child2;Re.ShiftOriginNode(i,e),Re.ShiftOriginNode(n,e),t.aabb.lowerBound.SelfSub(e),t.aabb.upperBound.SelfSub(e)}ShiftOrigin(t){Re.ShiftOriginNode(this.m_root,t)}}function De(t,e,i){const n=t[e];t[e]=t[i],t[i]=n}function Me(t,e){return t<e}function Oe(t,e=0,i=t.length-e,n=Me){let s=e;const r=[];let o=0;for(;;){for(;s+1<i;i++){const e=t[s+Math.floor(Math.random()*(i-s))];r[o++]=i;for(let r=s-1;;){for(;n(t[++r],e););for(;n(e,t[--i]););if(r>=i)break;De(t,r,i)}}if(0===o)break;s=i,i=r[--o]}return t}Re.s_r=new xt,Re.s_v=new xt,Re.s_abs_v=new xt,Re.s_segmentAABB=new Se,Re.s_subInput=new ye,Re.s_combinedAABB=new Se,Re.s_aabb=new Se,Re.s_node_id=0;class Be{constructor(t,e){this.proxyA=t,this.proxyB=e}}class Ne{constructor(){this.m_tree=new Re,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}CreateProxy(t,e){const i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i}DestroyProxy(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)}MoveProxy(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)}TouchProxy(t){this.BufferMove(t)}GetProxyCount(){return this.m_proxyCount}UpdatePairs(t){this.m_pairCount=0;for(let t=0;t<this.m_moveCount;++t){const e=this.m_moveBuffer[t];if(null===e)continue;const i=e.aabb;this.m_tree.Query(i,(t=>{if(t.m_id===e.m_id)return!0;let i,n;if(t.m_id<e.m_id?(i=t,n=e):(i=e,n=t),this.m_pairCount===this.m_pairBuffer.length)this.m_pairBuffer[this.m_pairCount]=new Be(i,n);else{const t=this.m_pairBuffer[this.m_pairCount];t.proxyA=i,t.proxyB=n}return++this.m_pairCount,!0}))}this.m_moveCount=0,Oe(this.m_pairBuffer,0,this.m_pairCount,Le);let e=0;for(;e<this.m_pairCount;){const i=this.m_pairBuffer[e];for(t(i.proxyA.userData,i.proxyB.userData),++e;e<this.m_pairCount;){const t=this.m_pairBuffer[e];if(t.proxyA.m_id!==i.proxyA.m_id||t.proxyB.m_id!==i.proxyB.m_id)break;++e}}}Query(t,e){this.m_tree.Query(t,e)}QueryPoint(t,e){this.m_tree.QueryPoint(t,e)}RayCast(t,e){this.m_tree.RayCast(t,e)}GetTreeHeight(){return this.m_tree.GetHeight()}GetTreeBalance(){return this.m_tree.GetMaxBalance()}GetTreeQuality(){return this.m_tree.GetAreaRatio()}ShiftOrigin(t){this.m_tree.ShiftOrigin(t)}BufferMove(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount}UnBufferMove(t){const e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null}}function Le(t,e){return t.proxyA.m_id<e.proxyA.m_id||t.proxyA.m_id===e.proxyA.m_id&&t.proxyB.m_id<e.proxyB.m_id}function Fe(){t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0}t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0;const ze=new Et,Ve=new Et,Ge=new xt,Ue=new xt,ke=new xt,He=new xt,je=new xt;class We{constructor(){this.proxyA=new Lt,this.proxyB=new Lt,this.sweepA=new Pt,this.sweepB=new Pt,this.tMax=0}}var qe,Xe;(qe=t.b2TOIOutputState||(t.b2TOIOutputState={}))[qe.e_unknown=0]="e_unknown",qe[qe.e_failed=1]="e_failed",qe[qe.e_overlapped=2]="e_overlapped",qe[qe.e_touching=3]="e_touching",qe[qe.e_separated=4]="e_separated";class Ye{constructor(){this.state=t.b2TOIOutputState.e_unknown,this.t=0}}(Xe=t.b2SeparationFunctionType||(t.b2SeparationFunctionType={}))[Xe.e_unknown=-1]="e_unknown",Xe[Xe.e_points=0]="e_points",Xe[Xe.e_faceA=1]="e_faceA",Xe[Xe.e_faceB=2]="e_faceB";class Ke{constructor(){this.m_sweepA=new Pt,this.m_sweepB=new Pt,this.m_type=t.b2SeparationFunctionType.e_unknown,this.m_localPoint=new xt,this.m_axis=new xt}Initialize(e,i,n,s,r,o){this.m_proxyA=i,this.m_proxyB=s;const a=e.count;this.m_sweepA.Copy(n),this.m_sweepB.Copy(r);const c=ze,l=Ve;if(this.m_sweepA.GetTransform(c,o),this.m_sweepB.GetTransform(l,o),1===a){this.m_type=t.b2SeparationFunctionType.e_points;const i=this.m_proxyA.GetVertex(e.indexA[0]),n=this.m_proxyB.GetVertex(e.indexB[0]),s=Et.MulXV(c,i,Ge),r=Et.MulXV(l,n,Ue);xt.SubVV(r,s,this.m_axis);const o=this.m_axis.Normalize();return this.m_localPoint.SetZero(),o}if(e.indexA[0]===e.indexA[1]){this.m_type=t.b2SeparationFunctionType.e_faceB;const i=this.m_proxyB.GetVertex(e.indexB[0]),n=this.m_proxyB.GetVertex(e.indexB[1]);xt.CrossVOne(xt.SubVV(n,i,xt.s_t0),this.m_axis).SelfNormalize();const s=Tt.MulRV(l.q,this.m_axis,ke);xt.MidVV(i,n,this.m_localPoint);const r=Et.MulXV(l,this.m_localPoint,Ue),o=this.m_proxyA.GetVertex(e.indexA[0]),a=Et.MulXV(c,o,Ge);let h=xt.DotVV(xt.SubVV(a,r,xt.s_t0),s);return h<0&&(this.m_axis.SelfNeg(),h=-h),h}{this.m_type=t.b2SeparationFunctionType.e_faceA;const i=this.m_proxyA.GetVertex(e.indexA[0]),n=this.m_proxyA.GetVertex(e.indexA[1]);xt.CrossVOne(xt.SubVV(n,i,xt.s_t0),this.m_axis).SelfNormalize();const s=Tt.MulRV(c.q,this.m_axis,ke);xt.MidVV(i,n,this.m_localPoint);const r=Et.MulXV(c,this.m_localPoint,Ge),o=this.m_proxyB.GetVertex(e.indexB[0]),a=Et.MulXV(l,o,Ue);let h=xt.DotVV(xt.SubVV(a,r,xt.s_t0),s);return h<0&&(this.m_axis.SelfNeg(),h=-h),h}}FindMinSeparation(e,i,n){const s=ze,r=Ve;switch(this.m_sweepA.GetTransform(s,n),this.m_sweepB.GetTransform(r,n),this.m_type){case t.b2SeparationFunctionType.e_points:{const t=Tt.MulTRV(s.q,this.m_axis,He),n=Tt.MulTRV(r.q,xt.NegV(this.m_axis,xt.s_t0),je);e[0]=this.m_proxyA.GetSupport(t),i[0]=this.m_proxyB.GetSupport(n);const o=this.m_proxyA.GetVertex(e[0]),a=this.m_proxyB.GetVertex(i[0]),c=Et.MulXV(s,o,Ge),l=Et.MulXV(r,a,Ue);return xt.DotVV(xt.SubVV(l,c,xt.s_t0),this.m_axis)}case t.b2SeparationFunctionType.e_faceA:{const t=Tt.MulRV(s.q,this.m_axis,ke),n=Et.MulXV(s,this.m_localPoint,Ge),o=Tt.MulTRV(r.q,xt.NegV(t,xt.s_t0),je);e[0]=-1,i[0]=this.m_proxyB.GetSupport(o);const a=this.m_proxyB.GetVertex(i[0]),c=Et.MulXV(r,a,Ue);return xt.DotVV(xt.SubVV(c,n,xt.s_t0),t)}case t.b2SeparationFunctionType.e_faceB:{const t=Tt.MulRV(r.q,this.m_axis,ke),n=Et.MulXV(r,this.m_localPoint,Ue),o=Tt.MulTRV(s.q,xt.NegV(t,xt.s_t0),He);i[0]=-1,e[0]=this.m_proxyA.GetSupport(o);const a=this.m_proxyA.GetVertex(e[0]),c=Et.MulXV(s,a,Ge);return xt.DotVV(xt.SubVV(c,n,xt.s_t0),t)}default:return e[0]=-1,i[0]=-1,0}}Evaluate(e,i,n){const s=ze,r=Ve;switch(this.m_sweepA.GetTransform(s,n),this.m_sweepB.GetTransform(r,n),this.m_type){case t.b2SeparationFunctionType.e_points:{const t=this.m_proxyA.GetVertex(e),n=this.m_proxyB.GetVertex(i),o=Et.MulXV(s,t,Ge),a=Et.MulXV(r,n,Ue);return xt.DotVV(xt.SubVV(a,o,xt.s_t0),this.m_axis)}case t.b2SeparationFunctionType.e_faceA:{const t=Tt.MulRV(s.q,this.m_axis,ke),e=Et.MulXV(s,this.m_localPoint,Ge),n=this.m_proxyB.GetVertex(i),o=Et.MulXV(r,n,Ue);return xt.DotVV(xt.SubVV(o,e,xt.s_t0),t)}case t.b2SeparationFunctionType.e_faceB:{const t=Tt.MulRV(r.q,this.m_axis,ke),i=Et.MulXV(r,this.m_localPoint,Ue),n=this.m_proxyA.GetVertex(e),o=Et.MulXV(s,n,Ge);return xt.DotVV(xt.SubVV(o,i,xt.s_t0),t)}default:return 0}}}const Je=new Dt,$e=new Ft,Ze=new zt,Qe=new Vt,ti=new Ke,ei=[0],ii=[0],ni=new Pt,si=new Pt;function ri(e,i){const n=Je.Reset();++t.b2_toiCalls,e.state=t.b2TOIOutputState.e_unknown,e.t=i.tMax;const s=i.proxyA,r=i.proxyB,o=et(c,et(s.m_count,r.m_count)),a=ni.Copy(i.sweepA),l=si.Copy(i.sweepB);a.Normalize(),l.Normalize();const h=i.tMax,u=s.m_radius+r.m_radius,d=et(_,u-3*_),m=.25*_;let p=0;const f=20;let g=0;const v=$e;v.count=0;const y=Ze;for(y.proxyA.Copy(i.proxyA),y.proxyB.Copy(i.proxyB),y.useRadii=!1;;){const i=ze,n=Ve;a.GetTransform(i,p),l.GetTransform(n,p),y.transformA.Copy(i),y.transformB.Copy(n);const c=Qe;if(Qt(c,v,y),c.distance<=0){e.state=t.b2TOIOutputState.e_overlapped,e.t=0;break}if(c.distance<d+m){e.state=t.b2TOIOutputState.e_touching,e.t=p;break}const _=ti;_.Initialize(v,s,a,r,l,p);let u=!1,x=h,S=0;for(;;){const i=ei,n=ii;let s=_.FindMinSeparation(i,n,x);if(s>d+m){e.state=t.b2TOIOutputState.e_separated,e.t=h,u=!0;break}if(s>d-m){p=x;break}let r=_.Evaluate(i[0],n[0],p);if(r<d-m){e.state=t.b2TOIOutputState.e_failed,e.t=p,u=!0;break}if(r<=d+m){e.state=t.b2TOIOutputState.e_touching,e.t=p,u=!0;break}let a=0,c=p,l=x;for(;;){let e=0;e=1&a?c+(d-r)*(l-c)/(s-r):.5*(c+l),++a,++t.b2_toiRootIters;const o=_.Evaluate(i[0],n[0],e);if(Q(o-d)<m){x=e;break}if(o>d?(c=e,r=o):(l=e,s=o),50===a)break}if(t.b2_toiMaxRootIters=et(t.b2_toiMaxRootIters,a),++S,S===o)break}if(++g,++t.b2_toiIters,u)break;if(g===f){e.state=t.b2TOIOutputState.e_failed,e.t=p;break}}t.b2_toiMaxIters=et(t.b2_toiMaxIters,g);const x=n.GetMilliseconds();t.b2_toiMaxTime=et(t.b2_toiMaxTime,x),t.b2_toiTime+=x}const oi=new xt,ai=new xt;function ci(e,i,n,s,r){e.pointCount=0;const o=Et.MulXV(n,i.m_p,oi),a=Et.MulXV(r,s.m_p,ai),c=xt.DistanceSquaredVV(o,a),l=i.m_radius+s.m_radius;c>l*l||(e.type=t.b2ManifoldType.e_circles,e.localPoint.Copy(i.m_p),e.localNormal.SetZero(),e.pointCount=1,e.points[0].localPoint.Copy(s.m_p),e.points[0].id.key=0)}const li=new xt,hi=new xt,_i=new xt;function ui(e,i,r,o,a){e.pointCount=0;const c=Et.MulXV(a,o.m_p,li),l=Et.MulTXV(r,c,hi);let h=0,_=-n;const u=i.m_radius+o.m_radius,d=i.m_count,m=i.m_vertices,p=i.m_normals;for(let t=0;t<d;++t){const e=xt.DotVV(p[t],xt.SubVV(l,m[t],xt.s_t0));if(e>u)return;e>_&&(_=e,h=t)}const f=h,g=(f+1)%d,v=m[f],y=m[g];if(_<s)return e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(p[h]),xt.MidVV(v,y,e.localPoint),e.points[0].localPoint.Copy(o.m_p),void(e.points[0].id.key=0);const x=xt.DotVV(xt.SubVV(l,v,xt.s_t0),xt.SubVV(y,v,xt.s_t1)),S=xt.DotVV(xt.SubVV(l,y,xt.s_t0),xt.SubVV(v,y,xt.s_t1));if(x<=0){if(xt.DistanceSquaredVV(l,v)>u*u)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,xt.SubVV(l,v,e.localNormal).SelfNormalize(),e.localPoint.Copy(v),e.points[0].localPoint.Copy(o.m_p),e.points[0].id.key=0}else if(S<=0){if(xt.DistanceSquaredVV(l,y)>u*u)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,xt.SubVV(l,y,e.localNormal).SelfNormalize(),e.localPoint.Copy(y),e.points[0].localPoint.Copy(o.m_p),e.points[0].id.key=0}else{const i=xt.MidVV(v,y,_i);if(xt.DotVV(xt.SubVV(l,i,xt.s_t1),p[f])>u)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(p[f]).SelfNormalize(),e.localPoint.Copy(i),e.points[0].localPoint.Copy(o.m_p),e.points[0].id.key=0}}const di=new xt,mi=new xt,pi=new xt,fi=new xt;function gi(t,e,i,s,r){const o=t.m_vertices,a=t.m_normals,c=s.m_count,l=s.m_vertices,h=Tt.MulRV(e.q,a[i],di),_=Tt.MulTRV(r.q,h,mi);let u=0,d=n;for(let t=0;t<c;++t){const e=xt.DotVV(l[t],_);e<d&&(d=e,u=t)}const m=Et.MulXV(e,o[i],pi),p=Et.MulXV(r,l[u],fi);return xt.DotVV(xt.SubVV(p,m,xt.s_t0),h)}const vi=new xt,yi=new xt;function xi(t,e,i,s,r){const o=e.m_count,a=e.m_normals,c=xt.SubVV(Et.MulXV(r,s.m_centroid,xt.s_t0),Et.MulXV(i,e.m_centroid,xt.s_t1),vi),l=Tt.MulTRV(i.q,c,yi);let h=0,_=-n;for(let t=0;t<o;++t){const e=xt.DotVV(a[t],l);e>_&&(_=e,h=t)}let u=gi(e,i,h,s,r);const d=(h+o-1)%o,m=gi(e,i,d,s,r),p=(h+1)%o,f=gi(e,i,p,s,r);let g=0,v=0,y=0;if(m>u&&m>f)y=-1,g=d,v=m;else{if(!(f>u))return t[0]=h,u;y=1,g=p,v=f}for(;h=-1===y?(g+o-1)%o:(g+1)%o,u=gi(e,i,h,s,r),u>v;)g=h,v=u;return t[0]=g,v}const Si=new xt;function Ci(e,i,s,r,o,a){const c=i.m_normals,l=o.m_count,h=o.m_vertices,_=o.m_normals,u=Tt.MulTRV(a.q,Tt.MulRV(s.q,c[r],xt.s_t0),Si);let d=0,m=n;for(let t=0;t<l;++t){const e=xt.DotVV(u,_[t]);e<m&&(m=e,d=t)}const p=d,f=(p+1)%l,g=e[0];Et.MulXV(a,h[p],g.v);const v=g.id.cf;v.indexA=r,v.indexB=p,v.typeA=t.b2ContactFeatureType.e_face,v.typeB=t.b2ContactFeatureType.e_vertex;const y=e[1];Et.MulXV(a,h[f],y.v);const x=y.id.cf;x.indexA=r,x.indexB=f,x.typeA=t.b2ContactFeatureType.e_face,x.typeB=t.b2ContactFeatureType.e_vertex}const Ai=ve.MakeArray(2),bi=ve.MakeArray(2),Ti=ve.MakeArray(2),Ei=[0],Pi=[0],wi=new xt,Ii=new xt,Ri=new xt,Di=new xt,Mi=new xt,Oi=new xt,Bi=new xt,Ni=new xt;function Li(e,i,n,s,r){e.pointCount=0;const o=i.m_radius+s.m_radius,c=Ei;c[0]=0;const l=xi(c,i,n,s,r);if(l>o)return;const h=Pi;h[0]=0;const _=xi(h,s,r,i,n);if(_>o)return;let u,d,m,p,f=0,g=0;_>.98*l+.001?(u=s,d=i,m=r,p=n,f=h[0],e.type=t.b2ManifoldType.e_faceB,g=1):(u=i,d=s,m=n,p=r,f=c[0],e.type=t.b2ManifoldType.e_faceA,g=0);const v=Ai;Ci(v,u,m,f,d,p);const y=u.m_count,x=u.m_vertices,S=f,C=(f+1)%y,A=x[S],b=x[C],T=xt.SubVV(b,A,wi);T.Normalize();const E=xt.CrossVOne(T,Ii),P=xt.MidVV(A,b,Ri),w=Tt.MulRV(m.q,T,Mi),I=xt.CrossVOne(w,Di),R=Et.MulXV(m,A,Bi),D=Et.MulXV(m,b,Ni),M=xt.DotVV(I,R),O=-xt.DotVV(w,R)+o,B=xt.DotVV(w,D)+o,N=bi,L=Ti;let F;if(F=Ae(N,v,xt.NegV(w,Oi),O,S),F<2)return;if(F=Ae(L,N,w,B,C),F<2)return;e.localNormal.Copy(E),e.localPoint.Copy(P);let z=0;for(let t=0;t<a;++t){const i=L[t];if(xt.DotVV(I,i.v)-M<=o){const t=e.points[z];if(Et.MulTXV(p,i.v,t.localPoint),t.id.Copy(i.id),g){const e=t.id.cf;t.id.cf.indexA=e.indexB,t.id.cf.indexB=e.indexA,t.id.cf.typeA=e.typeB,t.id.cf.typeB=e.typeA}++z}}e.pointCount=z}const Fi=new xt,zi=new xt,Vi=new xt,Gi=new xt,Ui=new xt,ki=new xt,Hi=new xt,ji=new de;function Wi(e,i,n,s,r){e.pointCount=0;const o=Et.MulTXV(n,Et.MulXV(r,s.m_p,xt.s_t0),Fi),a=i.m_vertex1,c=i.m_vertex2,l=xt.SubVV(c,a,zi),h=xt.DotVV(l,xt.SubVV(c,o,xt.s_t0)),_=xt.DotVV(l,xt.SubVV(o,a,xt.s_t0)),u=i.m_radius+s.m_radius,d=ji;if(d.cf.indexB=0,d.cf.typeB=t.b2ContactFeatureType.e_vertex,_<=0){const n=a,r=xt.SubVV(o,n,Vi);if(xt.DotVV(r,r)>u*u)return;if(i.m_hasVertex0){const t=i.m_vertex0,e=a,n=xt.SubVV(e,t,Gi);if(xt.DotVV(n,xt.SubVV(e,o,xt.s_t0))>0)return}return d.cf.indexA=0,d.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(n),e.points[0].id.Copy(d),void e.points[0].localPoint.Copy(s.m_p)}if(h<=0){const n=c,r=xt.SubVV(o,n,Vi);if(xt.DotVV(r,r)>u*u)return;if(i.m_hasVertex3){const t=i.m_vertex3,e=c,n=xt.SubVV(t,e,Ui);if(xt.DotVV(n,xt.SubVV(o,e,xt.s_t0))>0)return}return d.cf.indexA=1,d.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(n),e.points[0].id.Copy(d),void e.points[0].localPoint.Copy(s.m_p)}const m=xt.DotVV(l,l),p=ki;p.x=1/m*(h*a.x+_*c.x),p.y=1/m*(h*a.y+_*c.y);const f=xt.SubVV(o,p,Vi);if(xt.DotVV(f,f)>u*u)return;const g=Hi.Set(-l.y,l.x);xt.DotVV(g,xt.SubVV(o,a,xt.s_t0))<0&&g.Set(-g.x,-g.y),g.Normalize(),d.cf.indexA=0,d.cf.typeA=t.b2ContactFeatureType.e_face,e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(g),e.localPoint.Copy(a),e.points[0].id.Copy(d),e.points[0].localPoint.Copy(s.m_p)}var qi,Xi;!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB"}(qi||(qi={}));class Yi{constructor(){this.type=qi.e_unknown,this.index=0,this.separation=0}}class Ki{constructor(){this.vertices=[],this.normals=[],this.count=0}}class Ji{constructor(){this.i1=0,this.i2=0,this.v1=new xt,this.v2=new xt,this.normal=new xt,this.sideNormal1=new xt,this.sideOffset1=0,this.sideNormal2=new xt,this.sideOffset2=0}}!function(t){t[t.e_isolated=0]="e_isolated",t[t.e_concave=1]="e_concave",t[t.e_convex=2]="e_convex"}(Xi||(Xi={}));class $i{constructor(){this.m_polygonB=new Ki,this.m_xf=new Et,this.m_centroidB=new xt,this.m_v0=new xt,this.m_v1=new xt,this.m_v2=new xt,this.m_v3=new xt,this.m_normal0=new xt,this.m_normal1=new xt,this.m_normal2=new xt,this.m_normal=new xt,this.m_type1=Xi.e_isolated,this.m_type2=Xi.e_isolated,this.m_lowerLimit=new xt,this.m_upperLimit=new xt,this.m_radius=0,this.m_front=!1}Collide(e,i,n,s,r){Et.MulTXX(n,r,this.m_xf),Et.MulXV(this.m_xf,s.m_centroid,this.m_centroidB),this.m_v0.Copy(i.m_vertex0),this.m_v1.Copy(i.m_vertex1),this.m_v2.Copy(i.m_vertex2),this.m_v3.Copy(i.m_vertex3);const o=i.m_hasVertex0,c=i.m_hasVertex3,l=xt.SubVV(this.m_v2,this.m_v1,$i.s_edge1);l.Normalize(),this.m_normal1.Set(l.y,-l.x);const h=xt.DotVV(this.m_normal1,xt.SubVV(this.m_centroidB,this.m_v1,xt.s_t0));let _=0,u=0,d=!1,m=!1;if(o){const t=xt.SubVV(this.m_v1,this.m_v0,$i.s_edge0);t.Normalize(),this.m_normal0.Set(t.y,-t.x),d=xt.CrossVV(t,l)>=0,_=xt.DotVV(this.m_normal0,xt.SubVV(this.m_centroidB,this.m_v0,xt.s_t0))}if(c){const t=xt.SubVV(this.m_v3,this.m_v2,$i.s_edge2);t.Normalize(),this.m_normal2.Set(t.y,-t.x),m=xt.CrossVV(l,t)>0,u=xt.DotVV(this.m_normal2,xt.SubVV(this.m_centroidB,this.m_v2,xt.s_t0))}o&&c?d&&m?(this.m_front=_>=0||h>=0||u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):d?(this.m_front=_>=0||h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):m?(this.m_front=u>=0||_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=_>=0&&h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):o?d?(this.m_front=_>=0||h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):c?m?(this.m_front=h>=0||u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=s.m_count;for(let t=0;t<s.m_count;++t)this.m_polygonB.vertices.length<=t&&this.m_polygonB.vertices.push(new xt),this.m_polygonB.normals.length<=t&&this.m_polygonB.normals.push(new xt),Et.MulXV(this.m_xf,s.m_vertices[t],this.m_polygonB.vertices[t]),Tt.MulRV(this.m_xf.q,s.m_normals[t],this.m_polygonB.normals[t]);this.m_radius=s.m_radius+i.m_radius,e.pointCount=0;const p=this.ComputeEdgeSeparation($i.s_edgeAxis);if(p.type===qi.e_unknown)return;if(p.separation>this.m_radius)return;const f=this.ComputePolygonSeparation($i.s_polygonAxis);if(f.type!==qi.e_unknown&&f.separation>this.m_radius)return;const g=.98,v=.001;let y;y=f.type===qi.e_unknown?p:f.separation>g*p.separation+v?f:p;const x=$i.s_ie,S=$i.s_rf;if(y.type===qi.e_edgeA){e.type=t.b2ManifoldType.e_faceA;let i=0,n=xt.DotVV(this.m_normal,this.m_polygonB.normals[0]);for(let t=1;t<this.m_polygonB.count;++t){const e=xt.DotVV(this.m_normal,this.m_polygonB.normals[t]);e<n&&(n=e,i=t)}const s=i,r=(s+1)%this.m_polygonB.count,o=x[0];o.v.Copy(this.m_polygonB.vertices[s]),o.id.cf.indexA=0,o.id.cf.indexB=s,o.id.cf.typeA=t.b2ContactFeatureType.e_face,o.id.cf.typeB=t.b2ContactFeatureType.e_vertex;const a=x[1];a.v.Copy(this.m_polygonB.vertices[r]),a.id.cf.indexA=0,a.id.cf.indexB=r,a.id.cf.typeA=t.b2ContactFeatureType.e_face,a.id.cf.typeB=t.b2ContactFeatureType.e_vertex,this.m_front?(S.i1=0,S.i2=1,S.v1.Copy(this.m_v1),S.v2.Copy(this.m_v2),S.normal.Copy(this.m_normal1)):(S.i1=1,S.i2=0,S.v1.Copy(this.m_v2),S.v2.Copy(this.m_v1),S.normal.Copy(this.m_normal1).SelfNeg())}else{e.type=t.b2ManifoldType.e_faceB;const i=x[0];i.v.Copy(this.m_v1),i.id.cf.indexA=0,i.id.cf.indexB=y.index,i.id.cf.typeA=t.b2ContactFeatureType.e_vertex,i.id.cf.typeB=t.b2ContactFeatureType.e_face;const n=x[1];n.v.Copy(this.m_v2),n.id.cf.indexA=0,n.id.cf.indexB=y.index,n.id.cf.typeA=t.b2ContactFeatureType.e_vertex,n.id.cf.typeB=t.b2ContactFeatureType.e_face,S.i1=y.index,S.i2=(S.i1+1)%this.m_polygonB.count,S.v1.Copy(this.m_polygonB.vertices[S.i1]),S.v2.Copy(this.m_polygonB.vertices[S.i2]),S.normal.Copy(this.m_polygonB.normals[S.i1])}S.sideNormal1.Set(S.normal.y,-S.normal.x),S.sideNormal2.Copy(S.sideNormal1).SelfNeg(),S.sideOffset1=xt.DotVV(S.sideNormal1,S.v1),S.sideOffset2=xt.DotVV(S.sideNormal2,S.v2);const C=$i.s_clipPoints1,A=$i.s_clipPoints2;let b=0;if(b=Ae(C,x,S.sideNormal1,S.sideOffset1,S.i1),b<a)return;if(b=Ae(A,C,S.sideNormal2,S.sideOffset2,S.i2),b<a)return;y.type===qi.e_edgeA?(e.localNormal.Copy(S.normal),e.localPoint.Copy(S.v1)):(e.localNormal.Copy(s.m_normals[S.i1]),e.localPoint.Copy(s.m_vertices[S.i1]));let T=0;for(let t=0;t<a;++t){let i;if(i=xt.DotVV(S.normal,xt.SubVV(A[t].v,S.v1,xt.s_t0)),i<=this.m_radius){const i=e.points[T];y.type===qi.e_edgeA?(Et.MulTXV(this.m_xf,A[t].v,i.localPoint),i.id.Copy(A[t].id)):(i.localPoint.Copy(A[t].v),i.id.cf.typeA=A[t].id.cf.typeB,i.id.cf.typeB=A[t].id.cf.typeA,i.id.cf.indexA=A[t].id.cf.indexB,i.id.cf.indexB=A[t].id.cf.indexA),++T}}e.pointCount=T}ComputeEdgeSeparation(t){const e=t;e.type=qi.e_edgeA,e.index=this.m_front?0:1,e.separation=n;for(let t=0;t<this.m_polygonB.count;++t){const i=xt.DotVV(this.m_normal,xt.SubVV(this.m_polygonB.vertices[t],this.m_v1,xt.s_t0));i<e.separation&&(e.separation=i)}return e}ComputePolygonSeparation(t){const e=t;e.type=qi.e_unknown,e.index=-1,e.separation=-n;const i=$i.s_perp.Set(-this.m_normal.y,this.m_normal.x);for(let t=0;t<this.m_polygonB.count;++t){const n=xt.NegV(this.m_polygonB.normals[t],$i.s_n),s=tt(xt.DotVV(n,xt.SubVV(this.m_polygonB.vertices[t],this.m_v1,xt.s_t0)),xt.DotVV(n,xt.SubVV(this.m_polygonB.vertices[t],this.m_v2,xt.s_t0)));if(s>this.m_radius)return e.type=qi.e_edgeB,e.index=t,e.separation=s,e;if(xt.DotVV(n,i)>=0){if(xt.DotVV(xt.SubVV(n,this.m_upperLimit,xt.s_t0),this.m_normal)<-u)continue}else if(xt.DotVV(xt.SubVV(n,this.m_lowerLimit,xt.s_t0),this.m_normal)<-u)continue;s>e.separation&&(e.type=qi.e_edgeB,e.index=t,e.separation=s)}return e}}$i.s_edge1=new xt,$i.s_edge0=new xt,$i.s_edge2=new xt,$i.s_ie=ve.MakeArray(2),$i.s_rf=new Ji,$i.s_clipPoints1=ve.MakeArray(2),$i.s_clipPoints2=ve.MakeArray(2),$i.s_edgeAxis=new Yi,$i.s_polygonAxis=new Yi,$i.s_n=new xt,$i.s_perp=new xt;const Zi=new $i;function Qi(t,e,i,n,s){Zi.Collide(t,e,i,n,s)}class tn{constructor(){this.mass=0,this.center=new xt(0,0),this.I=0}}var en,nn,sn,rn;(en=t.b2ShapeType||(t.b2ShapeType={}))[en.e_unknown=-1]="e_unknown",en[en.e_circleShape=0]="e_circleShape",en[en.e_edgeShape=1]="e_edgeShape",en[en.e_polygonShape=2]="e_polygonShape",en[en.e_chainShape=3]="e_chainShape",en[en.e_shapeTypeCount=4]="e_shapeTypeCount";class on{constructor(e,i){this.m_type=t.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=e,this.m_radius=i}Copy(t){return this.m_radius=t.m_radius,this}GetType(){return this.m_type}}class an extends on{constructor(e=0){super(t.b2ShapeType.e_circleShape,e),this.m_p=new xt}Set(t,e=this.m_radius){return this.m_p.Copy(t),this.m_radius=e,this}Clone(){return(new an).Copy(this)}Copy(t){return super.Copy(t),this.m_p.Copy(t.m_p),this}GetChildCount(){return 1}TestPoint(t,e){const i=Et.MulXV(t,this.m_p,an.TestPoint_s_center),n=xt.SubVV(e,i,an.TestPoint_s_d);return xt.DotVV(n,n)<=rt(this.m_radius)}ComputeDistance(t,e,i,n){const s=Et.MulXV(t,this.m_p,an.ComputeDistance_s_center);return xt.SubVV(e,s,i),i.Normalize()-this.m_radius}RayCast(t,e,i,n){const r=Et.MulXV(i,this.m_p,an.RayCast_s_position),o=xt.SubVV(e.p1,r,an.RayCast_s_s),a=xt.DotVV(o,o)-rt(this.m_radius),c=xt.SubVV(e.p2,e.p1,an.RayCast_s_r),l=xt.DotVV(o,c),h=xt.DotVV(c,c),_=l*l-h*a;if(_<0||h<s)return!1;let u=-(l+at(_));return 0<=u&&u<=e.maxFraction*h&&(u/=h,t.fraction=u,xt.AddVMulSV(o,u,c,t.normal).SelfNormalize(),!0)}ComputeAABB(t,e,i){const n=Et.MulXV(e,this.m_p,an.ComputeAABB_s_p);t.lowerBound.Set(n.x-this.m_radius,n.y-this.m_radius),t.upperBound.Set(n.x+this.m_radius,n.y+this.m_radius)}ComputeMass(t,e){const i=rt(this.m_radius);t.mass=e*o*i,t.center.Copy(this.m_p),t.I=t.mass*(.5*i+xt.DotVV(this.m_p,this.m_p))}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){const r=Et.MulXV(i,this.m_p,new xt),a=-(xt.DotVV(t,r)-e);if(a<-this.m_radius+s)return 0;if(a>this.m_radius)return n.Copy(r),o*this.m_radius*this.m_radius;const c=this.m_radius*this.m_radius,l=a*a,h=c*(mt(a/this.m_radius)+o/2)+a*at(c-l),_=-2/3*ct(c-l,1.5)/h;return n.x=r.x+t.x*_,n.y=r.y+t.y*_,h}Dump(t){t("    const shape: b2CircleShape = new b2CircleShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)}}an.TestPoint_s_center=new xt,an.TestPoint_s_d=new xt,an.ComputeDistance_s_center=new xt,an.RayCast_s_position=new xt,an.RayCast_s_s=new xt,an.RayCast_s_r=new xt,an.ComputeAABB_s_p=new xt;class cn extends on{constructor(){super(t.b2ShapeType.e_polygonShape,d),this.m_centroid=new xt(0,0),this.m_vertices=[],this.m_normals=[],this.m_count=0}Clone(){return(new cn).Copy(this)}Copy(t){super.Copy(t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=xt.MakeArray(this.m_count),this.m_normals=xt.MakeArray(this.m_count);for(let e=0;e<this.m_count;++e)this.m_vertices[e].Copy(t.m_vertices[e]),this.m_normals[e].Copy(t.m_normals[e]);return this}GetChildCount(){return 1}Set(...t){if("number"==typeof t[0][0]){const e=t[0];if(e.length%2!=0)throw new Error;return this._Set((t=>({x:e[2*t],y:e[2*t+1]})),e.length/2)}{const e=t[0],i=t[1]||e.length;return this._Set((t=>e[t]),i)}}_Set(t,e){if(e<3)return this.SetAsBox(1,1);let i=e;const n=[];for(let e=0;e<i;++e){const i=t(e);let s=!0;for(let t=0;t<n.length;++t)if(xt.DistanceSquaredVV(i,n[t])<.25*_*_){s=!1;break}s&&n.push(i)}if(i=n.length,i<3)return this.SetAsBox(1,1);let s=0,r=n[0].x;for(let t=1;t<i;++t){const e=n[t].x;(e>r||e===r&&n[t].y<n[s].y)&&(s=t,r=e)}const o=[];let a=0,c=s;for(;;){o[a]=c;let t=0;for(let e=1;e<i;++e){if(t===c){t=e;continue}const i=xt.SubVV(n[t],n[o[a]],cn.Set_s_r),s=xt.SubVV(n[e],n[o[a]],cn.Set_s_v),r=xt.CrossVV(i,s);r<0&&(t=e),0===r&&s.LengthSquared()>i.LengthSquared()&&(t=e)}if(++a,c=t,t===s)break}this.m_count=a,this.m_vertices=xt.MakeArray(this.m_count),this.m_normals=xt.MakeArray(this.m_count);for(let t=0;t<a;++t)this.m_vertices[t].Copy(n[o[t]]);for(let t=0;t<a;++t){const e=this.m_vertices[t],i=this.m_vertices[(t+1)%a],n=xt.SubVV(i,e,xt.s_t0);xt.CrossVOne(n,this.m_normals[t]).SelfNormalize()}return cn.ComputeCentroid(this.m_vertices,a,this.m_centroid),this}SetAsBox(t,e,i,n=0){if(this.m_count=4,this.m_vertices=xt.MakeArray(this.m_count),this.m_normals=xt.MakeArray(this.m_count),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),i){this.m_centroid.Copy(i);const t=new Et;t.SetPosition(i),t.SetRotationAngle(n);for(let e=0;e<this.m_count;++e)Et.MulXV(t,this.m_vertices[e],this.m_vertices[e]),Tt.MulRV(t.q,this.m_normals[e],this.m_normals[e])}return this}TestPoint(t,e){const i=Et.MulTXV(t,e,cn.TestPoint_s_pLocal);for(let t=0;t<this.m_count;++t)if(xt.DotVV(this.m_normals[t],xt.SubVV(i,this.m_vertices[t],xt.s_t0))>0)return!1;return!0}ComputeDistance(t,e,i,s){const r=Et.MulTXV(t,e,cn.ComputeDistance_s_pLocal);let o=-n;const a=cn.ComputeDistance_s_normalForMaxDistance.Copy(r);for(let t=0;t<this.m_count;++t){const e=xt.DotVV(this.m_normals[t],xt.SubVV(r,this.m_vertices[t],xt.s_t0));e>o&&(o=e,a.Copy(this.m_normals[t]))}if(o>0){const e=cn.ComputeDistance_s_minDistance.Copy(a);let n=o*o;for(let t=0;t<this.m_count;++t){const i=xt.SubVV(r,this.m_vertices[t],cn.ComputeDistance_s_distance),s=i.LengthSquared();n>s&&(e.Copy(i),n=s)}return Tt.MulRV(t.q,e,i),i.Normalize(),Math.sqrt(n)}return Tt.MulRV(t.q,a,i),o}RayCast(t,e,i,n){const s=Et.MulTXV(i,e.p1,cn.RayCast_s_p1),r=Et.MulTXV(i,e.p2,cn.RayCast_s_p2),o=xt.SubVV(r,s,cn.RayCast_s_d);let a=0,c=e.maxFraction,l=-1;for(let t=0;t<this.m_count;++t){const e=xt.DotVV(this.m_normals[t],xt.SubVV(this.m_vertices[t],s,xt.s_t0)),i=xt.DotVV(this.m_normals[t],o);if(0===i){if(e<0)return!1}else i<0&&e<a*i?(a=e/i,l=t):i>0&&e<c*i&&(c=e/i);if(c<a)return!1}return l>=0&&(t.fraction=a,Tt.MulRV(i.q,this.m_normals[l],t.normal),!0)}ComputeAABB(t,e,i){const n=Et.MulXV(e,this.m_vertices[0],t.lowerBound),s=t.upperBound.Copy(n);for(let t=0;t<this.m_count;++t){const i=Et.MulXV(e,this.m_vertices[t],cn.ComputeAABB_s_v);xt.MinV(i,n,n),xt.MaxV(i,s,s)}const r=this.m_radius;n.SelfSubXY(r,r),s.SelfAddXY(r,r)}ComputeMass(t,e){const i=cn.ComputeMass_s_center.SetZero();let n=0,s=0;const r=cn.ComputeMass_s_s.SetZero();for(let t=0;t<this.m_count;++t)r.SelfAdd(this.m_vertices[t]);r.SelfMul(1/this.m_count);const o=1/3;for(let t=0;t<this.m_count;++t){const e=xt.SubVV(this.m_vertices[t],r,cn.ComputeMass_s_e1),a=xt.SubVV(this.m_vertices[(t+1)%this.m_count],r,cn.ComputeMass_s_e2),c=xt.CrossVV(e,a),l=.5*c;n+=l,i.SelfAdd(xt.MulSV(l*o,xt.AddVV(e,a,xt.s_t0),xt.s_t1));const h=e.x,_=e.y,u=a.x,d=a.y;s+=.25*o*c*(h*h+u*h+u*u+_*_+d*_+d*d)}t.mass=e*n,i.SelfMul(1/n),xt.AddVV(i,r,t.center),t.I=e*s,t.I+=t.mass*(xt.DotVV(t.center,t.center)-xt.DotVV(i,i))}Validate(){for(let t=0;t<this.m_count;++t){const e=t,i=(t+1)%this.m_count,n=this.m_vertices[e],s=xt.SubVV(this.m_vertices[i],n,cn.Validate_s_e);for(let t=0;t<this.m_count;++t){if(t===e||t===i)continue;const r=xt.SubVV(this.m_vertices[t],n,cn.Validate_s_v);if(xt.CrossVV(s,r)<0)return!1}}return!0}SetupDistanceProxy(t,e){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){const r=Tt.MulTRV(i.q,t,cn.ComputeSubmergedArea_s_normalL),o=e-xt.DotVV(t,i.p),a=[];let c=0,l=-1,h=-1,_=!1;for(let t=0;t<this.m_count;++t){a[t]=xt.DotVV(r,this.m_vertices[t])-o;const e=a[t]<-s;t>0&&(e?_||(l=t-1,c++):_&&(h=t-1,c++)),_=e}switch(c){case 0:if(_){const t=cn.ComputeSubmergedArea_s_md;return this.ComputeMass(t,1),Et.MulXV(i,t.center,n),t.mass}return 0;case 1:-1===l?l=this.m_count-1:h=this.m_count-1}const u=(l+1)%this.m_count,d=(h+1)%this.m_count,m=(0-a[l])/(a[u]-a[l]),p=(0-a[h])/(a[d]-a[h]),f=cn.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[l].x*(1-m)+this.m_vertices[u].x*m,this.m_vertices[l].y*(1-m)+this.m_vertices[u].y*m),g=cn.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[h].x*(1-p)+this.m_vertices[d].x*p,this.m_vertices[h].y*(1-p)+this.m_vertices[d].y*p);let v=0;const y=cn.ComputeSubmergedArea_s_center.SetZero();let x,S=this.m_vertices[u],C=u;for(;C!==d;){C=(C+1)%this.m_count,x=C===d?g:this.m_vertices[C];const t=.5*((S.x-f.x)*(x.y-f.y)-(S.y-f.y)*(x.x-f.x));v+=t,y.x+=t*(f.x+S.x+x.x)/3,y.y+=t*(f.y+S.y+x.y)/3,S=x}return y.SelfMul(1/v),Et.MulXV(i,y,n),v}Dump(t){t("    const shape: b2PolygonShape = new b2PolygonShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(let e=0;e<this.m_count;++e)t("    vs[%d] = new b2Vec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.Set(vs, %d);\n",this.m_count)}static ComputeCentroid(t,e,i){const n=i;n.SetZero();let s=0;const r=cn.ComputeCentroid_s_pRef.SetZero(),o=1/3;for(let i=0;i<e;++i){const a=r,c=t[i],l=t[(i+1)%e],h=xt.SubVV(c,a,cn.ComputeCentroid_s_e1),_=xt.SubVV(l,a,cn.ComputeCentroid_s_e2),u=.5*xt.CrossVV(h,_);s+=u,n.x+=u*o*(a.x+c.x+l.x),n.y+=u*o*(a.y+c.y+l.y)}return n.SelfMul(1/s),n}}cn.Set_s_r=new xt,cn.Set_s_v=new xt,cn.TestPoint_s_pLocal=new xt,cn.ComputeDistance_s_pLocal=new xt,cn.ComputeDistance_s_normalForMaxDistance=new xt,cn.ComputeDistance_s_minDistance=new xt,cn.ComputeDistance_s_distance=new xt,cn.RayCast_s_p1=new xt,cn.RayCast_s_p2=new xt,cn.RayCast_s_d=new xt,cn.ComputeAABB_s_v=new xt,cn.ComputeMass_s_center=new xt,cn.ComputeMass_s_s=new xt,cn.ComputeMass_s_e1=new xt,cn.ComputeMass_s_e2=new xt,cn.Validate_s_e=new xt,cn.Validate_s_v=new xt,cn.ComputeSubmergedArea_s_normalL=new xt,cn.ComputeSubmergedArea_s_md=new tn,cn.ComputeSubmergedArea_s_intoVec=new xt,cn.ComputeSubmergedArea_s_outoVec=new xt,cn.ComputeSubmergedArea_s_center=new xt,cn.ComputeCentroid_s_pRef=new xt,cn.ComputeCentroid_s_e1=new xt,cn.ComputeCentroid_s_e2=new xt;class ln extends on{constructor(){super(t.b2ShapeType.e_edgeShape,d),this.m_vertex1=new xt,this.m_vertex2=new xt,this.m_vertex0=new xt,this.m_vertex3=new xt,this.m_hasVertex0=!1,this.m_hasVertex3=!1}Set(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this}Clone(){return(new ln).Copy(this)}Copy(t){return super.Copy(t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_hasVertex0=t.m_hasVertex0,this.m_hasVertex3=t.m_hasVertex3,this}GetChildCount(){return 1}TestPoint(t,e){return!1}ComputeDistance(t,e,i,n){const s=Et.MulXV(t,this.m_vertex1,ln.ComputeDistance_s_v1),r=Et.MulXV(t,this.m_vertex2,ln.ComputeDistance_s_v2),o=xt.SubVV(e,s,ln.ComputeDistance_s_d),a=xt.SubVV(r,s,ln.ComputeDistance_s_s),c=xt.DotVV(o,a);if(c>0){const t=xt.DotVV(a,a);c>t?xt.SubVV(e,r,o):o.SelfMulSub(c/t,a)}return i.Copy(o),i.Normalize()}RayCast(t,e,i,n){const s=Et.MulTXV(i,e.p1,ln.RayCast_s_p1),r=Et.MulTXV(i,e.p2,ln.RayCast_s_p2),o=xt.SubVV(r,s,ln.RayCast_s_d),a=this.m_vertex1,c=this.m_vertex2,l=xt.SubVV(c,a,ln.RayCast_s_e),h=t.normal.Set(l.y,-l.x).SelfNormalize(),_=xt.DotVV(h,xt.SubVV(a,s,xt.s_t0)),u=xt.DotVV(h,o);if(0===u)return!1;const d=_/u;if(d<0||e.maxFraction<d)return!1;const m=xt.AddVMulSV(s,d,o,ln.RayCast_s_q),p=xt.SubVV(c,a,ln.RayCast_s_r),f=xt.DotVV(p,p);if(0===f)return!1;const g=xt.DotVV(xt.SubVV(m,a,xt.s_t0),p)/f;return!(g<0||1<g||(t.fraction=d,Tt.MulRV(i.q,t.normal,t.normal),_>0&&t.normal.SelfNeg(),0))}ComputeAABB(t,e,i){const n=Et.MulXV(e,this.m_vertex1,ln.ComputeAABB_s_v1),s=Et.MulXV(e,this.m_vertex2,ln.ComputeAABB_s_v2);xt.MinV(n,s,t.lowerBound),xt.MaxV(n,s,t.upperBound);const r=this.m_radius;t.lowerBound.SelfSubXY(r,r),t.upperBound.SelfAddXY(r,r)}ComputeMass(t,e){t.mass=0,xt.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){return n.SetZero(),0}Dump(t){t("    const shape: b2EdgeShape = new b2EdgeShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),t("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),t("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),t("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),t("    shape.m_hasVertex0 = %s;\n",this.m_hasVertex0),t("    shape.m_hasVertex3 = %s;\n",this.m_hasVertex3)}}ln.ComputeDistance_s_v1=new xt,ln.ComputeDistance_s_v2=new xt,ln.ComputeDistance_s_d=new xt,ln.ComputeDistance_s_s=new xt,ln.RayCast_s_p1=new xt,ln.RayCast_s_p2=new xt,ln.RayCast_s_d=new xt,ln.RayCast_s_e=new xt,ln.RayCast_s_q=new xt,ln.RayCast_s_r=new xt,ln.ComputeAABB_s_v1=new xt,ln.ComputeAABB_s_v2=new xt;class hn extends on{constructor(){super(t.b2ShapeType.e_chainShape,d),this.m_vertices=[],this.m_count=0,this.m_prevVertex=new xt,this.m_nextVertex=new xt,this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1}CreateLoop(...t){if("number"==typeof t[0][0]){const e=t[0];if(e.length%2!=0)throw new Error;return this._CreateLoop((t=>({x:e[2*t],y:e[2*t+1]})),e.length/2)}{const e=t[0],i=t[1]||e.length;return this._CreateLoop((t=>e[t]),i)}}_CreateLoop(t,e){if(e<3)return this;this.m_count=e+1,this.m_vertices=xt.MakeArray(this.m_count);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this}CreateChain(...t){if("number"==typeof t[0][0]){const e=t[0];if(e.length%2!=0)throw new Error;return this._CreateChain((t=>({x:e[2*t],y:e[2*t+1]})),e.length/2)}{const e=t[0],i=t[1]||e.length;return this._CreateChain((t=>e[t]),i)}}_CreateChain(t,e){this.m_count=e,this.m_vertices=xt.MakeArray(e);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this}SetPrevVertex(t){return this.m_prevVertex.Copy(t),this.m_hasPrevVertex=!0,this}SetNextVertex(t){return this.m_nextVertex.Copy(t),this.m_hasNextVertex=!0,this}Clone(){return(new hn).Copy(this)}Copy(t){return super.Copy(t),this._CreateChain((e=>t.m_vertices[e]),t.m_count),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this.m_hasPrevVertex=t.m_hasPrevVertex,this.m_hasNextVertex=t.m_hasNextVertex,this}GetChildCount(){return this.m_count-1}GetChildEdge(t,e){t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),e>0?(t.m_vertex0.Copy(this.m_vertices[e-1]),t.m_hasVertex0=!0):(t.m_vertex0.Copy(this.m_prevVertex),t.m_hasVertex0=this.m_hasPrevVertex),e<this.m_count-2?(t.m_vertex3.Copy(this.m_vertices[e+2]),t.m_hasVertex3=!0):(t.m_vertex3.Copy(this.m_nextVertex),t.m_hasVertex3=this.m_hasNextVertex)}TestPoint(t,e){return!1}ComputeDistance(t,e,i,n){const s=hn.ComputeDistance_s_edgeShape;return this.GetChildEdge(s,n),s.ComputeDistance(t,e,i,0)}RayCast(t,e,i,n){const s=hn.RayCast_s_edgeShape;return s.m_vertex1.Copy(this.m_vertices[n]),s.m_vertex2.Copy(this.m_vertices[(n+1)%this.m_count]),s.RayCast(t,e,i,0)}ComputeAABB(t,e,i){const n=this.m_vertices[i],s=this.m_vertices[(i+1)%this.m_count],r=Et.MulXV(e,n,hn.ComputeAABB_s_v1),o=Et.MulXV(e,s,hn.ComputeAABB_s_v2);xt.MinV(r,o,t.lowerBound),xt.MaxV(r,o,t.upperBound)}ComputeMass(t,e){t.mass=0,t.center.SetZero(),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){return n.SetZero(),0}Dump(t){t("    const shape: b2ChainShape = new b2ChainShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(let e=0;e<this.m_count;++e)t("    vs[%d] = new bVec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.m_count),t("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),t("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y),t("    shape.m_hasPrevVertex = %s;\n",this.m_hasPrevVertex?"true":"false"),t("    shape.m_hasNextVertex = %s;\n",this.m_hasNextVertex?"true":"false")}}hn.ComputeDistance_s_edgeShape=new ln,hn.RayCast_s_edgeShape=new ln,hn.ComputeAABB_s_v1=new xt,hn.ComputeAABB_s_v2=new xt;class _n{constructor(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}Clone(){return(new _n).Copy(this)}Copy(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this}}_n.DEFAULT=new _n;class un{constructor(){this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new _n}}class dn{constructor(t,e){this.aabb=new Se,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),e),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}Reset(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)}Touch(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)}Synchronize(t,e,i){if(t===e)this.fixture.m_shape.ComputeAABB(this.aabb,t,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i);else{const n=dn.Synchronize_s_aabb1,s=dn.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(n,t,this.childIndex),this.fixture.m_shape.ComputeAABB(s,e,this.childIndex),this.aabb.Combine2(n,s),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i)}}}dn.Synchronize_s_aabb1=new Se,dn.Synchronize_s_aabb2=new Se;class mn{constructor(t,e){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=[],this.m_filter=new _n,this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=e.shape.Clone(),this.m_userData=i(e.userData,null),this.m_friction=i(e.friction,.2),this.m_restitution=i(e.restitution,0),this.m_filter.Copy(i(e.filter,_n.DEFAULT)),this.m_isSensor=i(e.isSensor,!1),this.m_density=i(e.density,0)}get m_proxyCount(){return this.m_proxies.length}Reset(){}GetType(){return this.m_shape.GetType()}GetShape(){return this.m_shape}SetSensor(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)}IsSensor(){return this.m_isSensor}SetFilterData(t){this.m_filter.Copy(t),this.Refilter()}GetFilterData(){return this.m_filter}Refilter(){let t=this.m_body.GetContactList();for(;t;){const e=t.contact,i=e.GetFixtureA(),n=e.GetFixtureB();i!==this&&n!==this||e.FlagForFiltering(),t=t.next}this.TouchProxies()}GetBody(){return this.m_body}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}TestPoint(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)}ComputeDistance(t,e,i){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,i)}RayCast(t,e,i){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),i)}GetMassData(t=new tn){return this.m_shape.ComputeMass(t,this.m_density),t}SetDensity(t){this.m_density=t}GetDensity(){return this.m_density}GetFriction(){return this.m_friction}SetFriction(t){this.m_friction=t}GetRestitution(){return this.m_restitution}SetRestitution(t){this.m_restitution=t}GetAABB(t){return this.m_proxies[t].aabb}Dump(t,e){t("    const fd: b2FixtureDef = new b2FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.m_friction),t("    fd.restitution = %.15f;\n",this.m_restitution),t("    fd.density = %.15f;\n",this.m_density),t("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)}CreateProxies(){if(0!==this.m_proxies.length)throw new Error;for(let t=0;t<this.m_shape.GetChildCount();++t)this.m_proxies[t]=new dn(this,t)}DestroyProxies(){for(const t of this.m_proxies)t.Reset();this.m_proxies.length=0}TouchProxies(){for(const t of this.m_proxies)t.Touch()}SynchronizeProxies(t,e,i){for(const n of this.m_proxies)n.Synchronize(t,e,i)}}(nn=t.b2BodyType||(t.b2BodyType={}))[nn.b2_unknown=-1]="b2_unknown",nn[nn.b2_staticBody=0]="b2_staticBody",nn[nn.b2_kinematicBody=1]="b2_kinematicBody",nn[nn.b2_dynamicBody=2]="b2_dynamicBody";class pn{constructor(){this.type=t.b2BodyType.b2_staticBody,this.position=new xt(0,0),this.angle=0,this.linearVelocity=new xt(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1}}class fn{constructor(e,n){this.m_type=t.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new Et,this.m_xf0=new Et,this.m_sweep=new Pt,this.m_linearVelocity=new xt,this.m_angularVelocity=0,this.m_force=new xt,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=i(e.bullet,!1),this.m_fixedRotationFlag=i(e.fixedRotation,!1),this.m_autoSleepFlag=i(e.allowSleep,!0),this.m_awakeFlag=i(e.awake,!0),this.m_activeFlag=i(e.active,!0),this.m_world=n,this.m_xf.p.Copy(i(e.position,xt.ZERO)),this.m_xf.q.SetAngle(i(e.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(i(e.linearVelocity,xt.ZERO)),this.m_angularVelocity=i(e.angularVelocity,0),this.m_linearDamping=i(e.linearDamping,0),this.m_angularDamping=i(e.angularDamping,0),this.m_gravityScale=i(e.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=i(e.type,t.b2BodyType.b2_staticBody),e.type===t.b2BodyType.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=e.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}CreateFixture(t,e=0){return t instanceof on?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)}CreateFixtureDef(t){if(this.m_world.IsLocked())throw new Error;const e=new mn(this,t);return this.m_activeFlag&&e.CreateProxies(),e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,e}CreateFixtureShapeDensity(t,e=0){const i=fn.CreateFixtureShapeDensity_s_def;return i.shape=t,i.density=e,this.CreateFixtureDef(i)}DestroyFixture(t){if(this.m_world.IsLocked())throw new Error;let e=this.m_fixtureList,i=null;for(;null!==e;){if(e===t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}let n=this.m_contactList;for(;n;){const e=n.contact;n=n.next;const i=e.GetFixtureA(),s=e.GetFixtureB();t!==i&&t!==s||this.m_world.m_contactManager.Destroy(e)}this.m_activeFlag&&t.DestroyProxies(),t.m_next=null,t.Reset(),--this.m_fixtureCount,this.ResetMassData()}SetTransformVec(t,e){this.SetTransformXY(t.x,t.y,e)}SetTransformXY(t,e,i){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(i),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),Et.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;for(let t=this.m_fixtureList;t;t=t.m_next)t.SynchronizeProxies(this.m_xf,this.m_xf,xt.ZERO);this.m_world.m_contactManager.FindNewContacts()}SetTransform(t){this.SetTransformVec(t.p,t.GetAngle())}GetTransform(){return this.m_xf}GetPosition(){return this.m_xf.p}SetPosition(t){this.SetTransformVec(t,this.GetAngle())}SetPositionXY(t,e){this.SetTransformXY(t,e,this.GetAngle())}GetAngle(){return this.m_sweep.a}SetAngle(t){this.SetTransformVec(this.GetPosition(),t)}GetWorldCenter(){return this.m_sweep.c}GetLocalCenter(){return this.m_sweep.localCenter}SetLinearVelocity(e){this.m_type!==t.b2BodyType.b2_staticBody&&(xt.DotVV(e,e)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(e))}GetLinearVelocity(){return this.m_linearVelocity}SetAngularVelocity(e){this.m_type!==t.b2BodyType.b2_staticBody&&(e*e>0&&this.SetAwake(!0),this.m_angularVelocity=e)}GetAngularVelocity(){return this.m_angularVelocity}GetDefinition(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t}ApplyForce(e,i,n=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y,this.m_torque+=(i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x))}ApplyForceToCenter(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y))}ApplyTorque(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=e))}ApplyLinearImpulse(e,i,n=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y,this.m_angularVelocity+=this.m_invI*((i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x)))}ApplyLinearImpulseToCenter(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y))}ApplyAngularImpulse(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*e))}GetMass(){return this.m_mass}GetInertia(){return this.m_I+this.m_mass*xt.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)}GetMassData(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*xt.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t}SetMassData(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==t.b2BodyType.b2_dynamicBody)return;this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=e.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,e.I>0&&!this.m_fixedRotationFlag&&(this.m_I=e.I-this.m_mass*xt.DotVV(e.center,e.center),this.m_invI=1/this.m_I);const i=fn.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(e.center),Et.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),xt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,xt.SubVV(this.m_sweep.c,i,xt.s_t0),this.m_linearVelocity)}ResetMassData(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===t.b2BodyType.b2_staticBody||this.m_type===t.b2BodyType.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);const e=fn.ResetMassData_s_localCenter.SetZero();for(let t=this.m_fixtureList;t;t=t.m_next){if(0===t.m_density)continue;const i=t.GetMassData(fn.ResetMassData_s_massData);this.m_mass+=i.mass,e.x+=i.center.x*i.mass,e.y+=i.center.y*i.mass,this.m_I+=i.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,e.x*=this.m_invMass,e.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*xt.DotVV(e,e),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);const i=fn.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(e),Et.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),xt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,xt.SubVV(this.m_sweep.c,i,xt.s_t0),this.m_linearVelocity)}GetWorldPoint(t,e){return Et.MulXV(this.m_xf,t,e)}GetWorldVector(t,e){return Tt.MulRV(this.m_xf.q,t,e)}GetLocalPoint(t,e){return Et.MulTXV(this.m_xf,t,e)}GetLocalVector(t,e){return Tt.MulTRV(this.m_xf.q,t,e)}GetLinearVelocityFromWorldPoint(t,e){return xt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,xt.SubVV(t,this.m_sweep.c,xt.s_t0),e)}GetLinearVelocityFromLocalPoint(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)}GetLinearDamping(){return this.m_linearDamping}SetLinearDamping(t){this.m_linearDamping=t}GetAngularDamping(){return this.m_angularDamping}SetAngularDamping(t){this.m_angularDamping=t}GetGravityScale(){return this.m_gravityScale}SetGravityScale(t){this.m_gravityScale=t}SetType(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type===e)return;this.m_type=e,this.ResetMassData(),this.m_type===t.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;let i=this.m_contactList;for(;i;){const t=i;i=i.next,this.m_world.m_contactManager.Destroy(t.contact)}this.m_contactList=null;for(let t=this.m_fixtureList;t;t=t.m_next)t.TouchProxies()}GetType(){return this.m_type}SetBullet(t){this.m_bulletFlag=t}IsBullet(){return this.m_bulletFlag}SetSleepingAllowed(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)}IsSleepingAllowed(){return this.m_autoSleepFlag}SetAwake(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)}IsAwake(){return this.m_awakeFlag}SetActive(t){if(this.m_world.IsLocked())throw new Error;if(t!==this.IsActive())if(this.m_activeFlag=t,t)for(let t=this.m_fixtureList;t;t=t.m_next)t.CreateProxies();else{for(let t=this.m_fixtureList;t;t=t.m_next)t.DestroyProxies();let t=this.m_contactList;for(;t;){const e=t;t=t.next,this.m_world.m_contactManager.Destroy(e.contact)}this.m_contactList=null}}IsActive(){return this.m_activeFlag}SetFixedRotation(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())}IsFixedRotation(){return this.m_fixedRotationFlag}GetFixtureList(){return this.m_fixtureList}GetJointList(){return this.m_jointList}GetContactList(){return this.m_contactList}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}GetWorld(){return this.m_world}Dump(e){const i=this.m_islandIndex;e("{\n"),e("  const bd: b2BodyDef = new b2BodyDef();\n");let n="";switch(this.m_type){case t.b2BodyType.b2_staticBody:n="b2BodyType.b2_staticBody";break;case t.b2BodyType.b2_kinematicBody:n="b2BodyType.b2_kinematicBody";break;case t.b2BodyType.b2_dynamicBody:n="b2BodyType.b2_dynamicBody"}e("  bd.type = %s;\n",n),e("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),e("  bd.angle = %.15f;\n",this.m_sweep.a),e("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),e("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),e("  bd.linearDamping = %.15f;\n",this.m_linearDamping),e("  bd.angularDamping = %.15f;\n",this.m_angularDamping),e("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),e("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),e("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),e("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),e("  bd.active = %s;\n",this.m_activeFlag?"true":"false"),e("  bd.gravityScale = %.15f;\n",this.m_gravityScale),e("\n"),e("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),e("\n");for(let t=this.m_fixtureList;t;t=t.m_next)e("  {\n"),t.Dump(e,i),e("  }\n");e("}\n")}SynchronizeFixtures(){const t=fn.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),Tt.MulRV(t.q,this.m_sweep.localCenter,t.p),xt.SubVV(this.m_sweep.c0,t.p,t.p);const e=xt.SubVV(this.m_sweep.c,this.m_sweep.c0,fn.SynchronizeFixtures_s_displacement);for(let i=this.m_fixtureList;i;i=i.m_next)i.SynchronizeProxies(t,this.m_xf,e)}SynchronizeTransform(){this.m_xf.q.SetAngle(this.m_sweep.a),Tt.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),xt.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}ShouldCollide(e){return(this.m_type!==t.b2BodyType.b2_staticBody||e.m_type!==t.b2BodyType.b2_staticBody)&&this.ShouldCollideConnected(e)}ShouldCollideConnected(t){for(let e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0}Advance(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),Tt.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),xt.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}GetControllerList(){return this.m_controllerList}GetControllerCount(){return this.m_controllerCount}}fn.CreateFixtureShapeDensity_s_def=new un,fn.SetMassData_s_oldCenter=new xt,fn.ResetMassData_s_localCenter=new xt,fn.ResetMassData_s_oldCenter=new xt,fn.ResetMassData_s_massData=new tn,fn.SynchronizeFixtures_s_xf1=new Et,fn.SynchronizeFixtures_s_displacement=new xt,(rn=t.b2JointType||(t.b2JointType={}))[rn.e_unknownJoint=0]="e_unknownJoint",rn[rn.e_revoluteJoint=1]="e_revoluteJoint",rn[rn.e_prismaticJoint=2]="e_prismaticJoint",rn[rn.e_distanceJoint=3]="e_distanceJoint",rn[rn.e_pulleyJoint=4]="e_pulleyJoint",rn[rn.e_mouseJoint=5]="e_mouseJoint",rn[rn.e_gearJoint=6]="e_gearJoint",rn[rn.e_wheelJoint=7]="e_wheelJoint",rn[rn.e_weldJoint=8]="e_weldJoint",rn[rn.e_frictionJoint=9]="e_frictionJoint",rn[rn.e_ropeJoint=10]="e_ropeJoint",rn[rn.e_motorJoint=11]="e_motorJoint",rn[rn.e_areaJoint=12]="e_areaJoint",(sn=t.b2LimitState||(t.b2LimitState={}))[sn.e_inactiveLimit=0]="e_inactiveLimit",sn[sn.e_atLowerLimit=1]="e_atLowerLimit",sn[sn.e_atUpperLimit=2]="e_atUpperLimit",sn[sn.e_equalLimits=3]="e_equalLimits";class gn{constructor(){this.linear=new xt,this.angularA=0,this.angularB=0}SetZero(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this}Set(t,e,i){return this.linear.Copy(t),this.angularA=e,this.angularB=i,this}}class vn{constructor(t){this._other=null,this.prev=null,this.next=null,this.joint=t}get other(){if(null===this._other)throw new Error;return this._other}set other(t){if(null!==this._other)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class yn{constructor(e){this.type=t.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=e}}class xn{constructor(e){this.m_type=t.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new vn(this),this.m_edgeB=new vn(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=e.type,this.m_edgeA.other=e.bodyB,this.m_edgeB.other=e.bodyA,this.m_bodyA=e.bodyA,this.m_bodyB=e.bodyB,this.m_collideConnected=i(e.collideConnected,!1),this.m_userData=i(e.userData,null)}GetType(){return this.m_type}GetBodyA(){return this.m_bodyA}GetBodyB(){return this.m_bodyB}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}IsActive(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()}GetCollideConnected(){return this.m_collideConnected}Dump(t){t("// Dump is not supported for this joint type.\n")}ShiftOrigin(t){}}class Sn extends yn{constructor(){super(t.b2JointType.e_distanceJoint),this.localAnchorA=new xt,this.localAnchorB=new xt,this.length=1,this.frequencyHz=0,this.dampingRatio=0}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.length=xt.DistanceVV(i,n),this.frequencyHz=0,this.dampingRatio=0}}class Cn extends xn{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_bias=0,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_gamma=0,this.m_impulse=0,this.m_length=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_frequencyHz=i(t.frequencyHz,0),this.m_dampingRatio=i(t.dampingRatio,0),this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_length=t.length}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse*this.m_u.x,e.y=t*this.m_impulse*this.m_u.y,e}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetLength(t){this.m_length=t}Length(){return this.m_length}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.length = %.15f;\n",this.m_length),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,c=t.velocities[this.m_indexB].v;let l=t.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(i),u=this.m_qB.SetAngle(a);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(h,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(u,this.m_lalcB,this.m_rB),this.m_u.x=r.x+this.m_rB.x-e.x-this.m_rA.x,this.m_u.y=r.y+this.m_rB.y-e.y-this.m_rA.y;const d=this.m_u.Length();d>_?this.m_u.SelfMul(1/d):this.m_u.SetZero();const m=xt.CrossVV(this.m_rA,this.m_u),p=xt.CrossVV(this.m_rB,this.m_u);let f=this.m_invMassA+this.m_invIA*m*m+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=0!==f?1/f:0,this.m_frequencyHz>0){const e=d-this.m_length,i=2*o*this.m_frequencyHz,n=2*this.m_mass*this.m_dampingRatio*i,s=this.m_mass*i*i,r=t.step.dt;this.m_gamma=r*(n+r*s),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=e*r*s*this.m_gamma,f+=this.m_gamma,this.m_mass=0!==f?1/f:0}else this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const e=xt.MulSV(this.m_impulse,this.m_u,Cn.InitVelocityConstraints_s_P);n.SelfMulSub(this.m_invMassA,e),s-=this.m_invIA*xt.CrossVV(this.m_rA,e),c.SelfMulAdd(this.m_invMassB,e),l+=this.m_invIB*xt.CrossVV(this.m_rB,e)}else this.m_impulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=l}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=xt.AddVCrossSV(e,i,this.m_rA,Cn.SolveVelocityConstraints_s_vpA),o=xt.AddVCrossSV(n,s,this.m_rB,Cn.SolveVelocityConstraints_s_vpB),a=xt.DotVV(this.m_u,xt.SubVV(o,r,xt.s_t0)),c=-this.m_mass*(a+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=c;const l=xt.MulSV(c,this.m_u,Cn.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,l),i-=this.m_invIA*xt.CrossVV(this.m_rA,l),n.SelfMulAdd(this.m_invMassB,l),s+=this.m_invIB*xt.CrossVV(this.m_rB,l),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){if(this.m_frequencyHz>0)return!0;const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s),a=Tt.MulRV(r,this.m_lalcA,this.m_rA),c=Tt.MulRV(o,this.m_lalcB,this.m_rB),l=this.m_u;l.x=n.x+c.x-e.x-a.x,l.y=n.y+c.y-e.y-a.y;let h=this.m_u.Normalize()-this.m_length;h=it(h,-g,g);const u=-this.m_mass*h,d=xt.MulSV(u,l,Cn.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,d),i-=this.m_invIA*xt.CrossVV(a,d),n.SelfMulAdd(this.m_invMassB,d),s+=this.m_invIB*xt.CrossVV(c,d),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,Q(h)<_}}Cn.InitVelocityConstraints_s_P=new xt,Cn.SolveVelocityConstraints_s_vpA=new xt,Cn.SolveVelocityConstraints_s_vpB=new xt,Cn.SolveVelocityConstraints_s_P=new xt,Cn.SolvePositionConstraints_s_P=new xt;class An extends yn{constructor(){super(t.b2JointType.e_areaJoint),this.bodies=[],this.frequencyHz=0,this.dampingRatio=0}AddBody(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)}}class bn extends xn{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_impulse=0,this.m_targetArea=0,this.m_delta=new xt,this.m_bodies=t.bodies,this.m_frequencyHz=i(t.frequencyHz,0),this.m_dampingRatio=i(t.dampingRatio,0),this.m_targetLengths=K(t.bodies.length),this.m_normals=xt.MakeArray(t.bodies.length),this.m_joints=[],this.m_deltas=xt.MakeArray(t.bodies.length);const e=new Sn;e.frequencyHz=this.m_frequencyHz,e.dampingRatio=this.m_dampingRatio,this.m_targetArea=0;for(let t=0;t<this.m_bodies.length;++t){const i=this.m_bodies[t],n=this.m_bodies[(t+1)%this.m_bodies.length],s=i.GetWorldCenter(),r=n.GetWorldCenter();this.m_targetLengths[t]=xt.DistanceVV(s,r),this.m_targetArea+=xt.CrossVV(s,r),e.Initialize(i,n,s,r),this.m_joints[t]=i.GetWorld().CreateJoint(e)}this.m_targetArea*=.5}GetAnchorA(t){return t}GetAnchorB(t){return t}GetReactionForce(t,e){return e}GetReactionTorque(t){return 0}SetFrequency(t){this.m_frequencyHz=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetFrequency(t)}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDampingRatio(t)}GetDampingRatio(){return this.m_dampingRatio}Dump(t){t("Area joint dumping is not supported.\n")}InitVelocityConstraints(t){for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],n=this.m_bodies[(e+1)%this.m_bodies.length],s=t.positions[i.m_islandIndex].c,r=t.positions[n.m_islandIndex].c,o=this.m_deltas[e];xt.SubVV(r,s,o)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],n=t.velocities[i.m_islandIndex].v,s=this.m_deltas[e];n.x+=i.m_invMass*s.y*.5*this.m_impulse,n.y+=i.m_invMass*-s.x*.5*this.m_impulse}}else this.m_impulse=0}SolveVelocityConstraints(t){let e=0,i=0;for(let n=0;n<this.m_bodies.length;++n){const s=this.m_bodies[n],r=t.velocities[s.m_islandIndex].v,o=this.m_deltas[n];e+=o.LengthSquared()/s.GetMass(),i+=xt.CrossVV(r,o)}const n=-2*i/e;this.m_impulse+=n;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],s=t.velocities[i.m_islandIndex].v,r=this.m_deltas[e];s.x+=i.m_invMass*r.y*.5*n,s.y+=i.m_invMass*-r.x*.5*n}}SolvePositionConstraints(t){let e=0,i=0;for(let n=0;n<this.m_bodies.length;++n){const r=this.m_bodies[n],o=this.m_bodies[(n+1)%this.m_bodies.length],a=t.positions[r.m_islandIndex].c,c=t.positions[o.m_islandIndex].c,l=xt.SubVV(c,a,this.m_delta);let h=l.Length();h<s&&(h=1),this.m_normals[n].x=l.y/h,this.m_normals[n].y=-l.x/h,e+=h,i+=xt.CrossVV(a,c)}i*=.5;const n=.5*(this.m_targetArea-i)/e;let r=!0;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],s=t.positions[i.m_islandIndex].c,o=(e+1)%this.m_bodies.length,a=xt.AddVV(this.m_normals[e],this.m_normals[o],this.m_delta);a.SelfMul(n);const c=a.LengthSquared();c>rt(g)&&a.SelfMul(g/at(c)),c>rt(_)&&(r=!1),s.x+=a.x,s.y+=a.y}return r}}class Tn extends yn{constructor(){super(t.b2JointType.e_frictionJoint),this.localAnchorA=new xt,this.localAnchorB=new xt,this.maxForce=0,this.maxTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB)}}class En extends xn{constructor(t){super(t),this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_linearImpulse=new xt,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new At,this.m_angularMass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_K=new At,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_linearImpulse.SetZero(),this.m_maxForce=i(t.maxForce,0),this.m_maxTorque=i(t.maxTorque,0),this.m_linearMass.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const s=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const a=this.m_qA.SetAngle(e),c=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const l=Tt.MulRV(a,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const h=Tt.MulRV(c,this.m_lalcB,this.m_rB),_=this.m_invMassA,u=this.m_invMassB,d=this.m_invIA,m=this.m_invIB,p=this.m_K;if(p.ex.x=_+u+d*l.y*l.y+m*h.y*h.y,p.ex.y=-d*l.x*l.y-m*h.x*h.y,p.ey.x=p.ex.y,p.ey.y=_+u+d*l.x*l.x+m*h.x*h.x,p.GetInverse(this.m_linearMass),this.m_angularMass=d+m,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;i.SelfMulSub(_,e),n-=d*(xt.CrossVV(this.m_rA,e)+this.m_angularImpulse),r.SelfMulAdd(u,e),o+=m*(xt.CrossVV(this.m_rB,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=this.m_invMassA,o=this.m_invMassB,a=this.m_invIA,c=this.m_invIB,l=t.step.dt;{const t=s-i;let e=-this.m_angularMass*t;const n=this.m_angularImpulse,r=l*this.m_maxTorque;this.m_angularImpulse=it(this.m_angularImpulse+e,-r,r),e=this.m_angularImpulse-n,i-=a*e,s+=c*e}{const t=xt.SubVV(xt.AddVCrossSV(n,s,this.m_rB,xt.s_t0),xt.AddVCrossSV(e,i,this.m_rA,xt.s_t1),En.SolveVelocityConstraints_s_Cdot_v2),h=At.MulMV(this.m_linearMass,t,En.SolveVelocityConstraints_s_impulseV).SelfNeg(),_=En.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(h);const u=l*this.m_maxForce;this.m_linearImpulse.LengthSquared()>u*u&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(u)),xt.SubVV(this.m_linearImpulse,_,h),e.SelfMulSub(r,h),i-=a*xt.CrossVV(this.m_rA,h),n.SelfMulAdd(o,h),s+=c*xt.CrossVV(this.m_rB,h)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){return!0}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e}GetReactionTorque(t){return t*this.m_angularImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}En.SolveVelocityConstraints_s_Cdot_v2=new xt,En.SolveVelocityConstraints_s_impulseV=new xt,En.SolveVelocityConstraints_s_oldImpulseV=new xt;class Pn extends yn{constructor(){super(t.b2JointType.e_gearJoint),this.ratio=1}}class wn extends xn{constructor(e){let n,s;super(e),this.m_typeA=t.b2JointType.e_unknownJoint,this.m_typeB=t.b2JointType.e_unknownJoint,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_localAnchorC=new xt,this.m_localAnchorD=new xt,this.m_localAxisC=new xt,this.m_localAxisD=new xt,this.m_referenceAngleA=0,this.m_referenceAngleB=0,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_indexC=0,this.m_indexD=0,this.m_lcA=new xt,this.m_lcB=new xt,this.m_lcC=new xt,this.m_lcD=new xt,this.m_mA=0,this.m_mB=0,this.m_mC=0,this.m_mD=0,this.m_iA=0,this.m_iB=0,this.m_iC=0,this.m_iD=0,this.m_JvAC=new xt,this.m_JvBD=new xt,this.m_JwA=0,this.m_JwB=0,this.m_JwC=0,this.m_JwD=0,this.m_mass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_qC=new Tt,this.m_qD=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_lalcC=new xt,this.m_lalcD=new xt,this.m_joint1=e.joint1,this.m_joint2=e.joint2,this.m_typeA=this.m_joint1.GetType(),this.m_typeB=this.m_joint2.GetType(),this.m_bodyC=this.m_joint1.GetBodyA(),this.m_bodyA=this.m_joint1.GetBodyB();const r=this.m_bodyA.m_xf,o=this.m_bodyA.m_sweep.a,a=this.m_bodyC.m_xf,c=this.m_bodyC.m_sweep.a;if(this.m_typeA===t.b2JointType.e_revoluteJoint){const t=e.joint1;this.m_localAnchorC.Copy(t.m_localAnchorA),this.m_localAnchorA.Copy(t.m_localAnchorB),this.m_referenceAngleA=t.m_referenceAngle,this.m_localAxisC.SetZero(),n=o-c-this.m_referenceAngleA}else{const t=e.joint1;this.m_localAnchorC.Copy(t.m_localAnchorA),this.m_localAnchorA.Copy(t.m_localAnchorB),this.m_referenceAngleA=t.m_referenceAngle,this.m_localAxisC.Copy(t.m_localXAxisA);const i=this.m_localAnchorC,s=Tt.MulTRV(a.q,xt.AddVV(Tt.MulRV(r.q,this.m_localAnchorA,xt.s_t0),xt.SubVV(r.p,a.p,xt.s_t1),xt.s_t0),xt.s_t0);n=xt.DotVV(xt.SubVV(s,i,xt.s_t0),this.m_localAxisC)}this.m_bodyD=this.m_joint2.GetBodyA(),this.m_bodyB=this.m_joint2.GetBodyB();const l=this.m_bodyB.m_xf,h=this.m_bodyB.m_sweep.a,_=this.m_bodyD.m_xf,u=this.m_bodyD.m_sweep.a;if(this.m_typeB===t.b2JointType.e_revoluteJoint){const t=e.joint2;this.m_localAnchorD.Copy(t.m_localAnchorA),this.m_localAnchorB.Copy(t.m_localAnchorB),this.m_referenceAngleB=t.m_referenceAngle,this.m_localAxisD.SetZero(),s=h-u-this.m_referenceAngleB}else{const t=e.joint2;this.m_localAnchorD.Copy(t.m_localAnchorA),this.m_localAnchorB.Copy(t.m_localAnchorB),this.m_referenceAngleB=t.m_referenceAngle,this.m_localAxisD.Copy(t.m_localXAxisA);const i=this.m_localAnchorD,n=Tt.MulTRV(_.q,xt.AddVV(Tt.MulRV(l.q,this.m_localAnchorB,xt.s_t0),xt.SubVV(l.p,_.p,xt.s_t1),xt.s_t0),xt.s_t0);s=xt.DotVV(xt.SubVV(n,i,xt.s_t0),this.m_localAxisD)}this.m_ratio=i(e.ratio,1),this.m_constant=n+this.m_ratio*s,this.m_impulse=0}InitVelocityConstraints(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;const i=e.positions[this.m_indexA].a,n=e.velocities[this.m_indexA].v;let s=e.velocities[this.m_indexA].w;const r=e.positions[this.m_indexB].a,o=e.velocities[this.m_indexB].v;let a=e.velocities[this.m_indexB].w;const c=e.positions[this.m_indexC].a,l=e.velocities[this.m_indexC].v;let h=e.velocities[this.m_indexC].w;const _=e.positions[this.m_indexD].a,u=e.velocities[this.m_indexD].v;let d=e.velocities[this.m_indexD].w;const m=this.m_qA.SetAngle(i),p=this.m_qB.SetAngle(r),f=this.m_qC.SetAngle(c),g=this.m_qD.SetAngle(_);if(this.m_mass=0,this.m_typeA===t.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{const t=Tt.MulRV(f,this.m_localAxisC,wn.InitVelocityConstraints_s_u);xt.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);const e=Tt.MulRV(f,this.m_lalcC,wn.InitVelocityConstraints_s_rC);xt.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);const i=Tt.MulRV(m,this.m_lalcA,wn.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(t),this.m_JwC=xt.CrossVV(e,t),this.m_JwA=xt.CrossVV(i,t),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===t.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{const t=Tt.MulRV(g,this.m_localAxisD,wn.InitVelocityConstraints_s_u);xt.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);const e=Tt.MulRV(g,this.m_lalcD,wn.InitVelocityConstraints_s_rD);xt.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);const i=Tt.MulRV(p,this.m_lalcB,wn.InitVelocityConstraints_s_rB);xt.MulSV(this.m_ratio,t,this.m_JvBD),this.m_JwD=this.m_ratio*xt.CrossVV(e,t),this.m_JwB=this.m_ratio*xt.CrossVV(i,t),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,e.step.warmStarting?(n.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),s+=this.m_iA*this.m_impulse*this.m_JwA,o.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),a+=this.m_iB*this.m_impulse*this.m_JwB,l.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),h-=this.m_iC*this.m_impulse*this.m_JwC,u.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),d-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,e.velocities[this.m_indexA].w=s,e.velocities[this.m_indexB].w=a,e.velocities[this.m_indexC].w=h,e.velocities[this.m_indexD].w=d}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=t.velocities[this.m_indexC].v;let o=t.velocities[this.m_indexC].w;const a=t.velocities[this.m_indexD].v;let c=t.velocities[this.m_indexD].w,l=xt.DotVV(this.m_JvAC,xt.SubVV(e,r,xt.s_t0))+xt.DotVV(this.m_JvBD,xt.SubVV(n,a,xt.s_t0));l+=this.m_JwA*i-this.m_JwC*o+(this.m_JwB*s-this.m_JwD*c);const h=-this.m_mass*l;this.m_impulse+=h,e.SelfMulAdd(this.m_mA*h,this.m_JvAC),i+=this.m_iA*h*this.m_JwA,n.SelfMulAdd(this.m_mB*h,this.m_JvBD),s+=this.m_iB*h*this.m_JwB,r.SelfMulSub(this.m_mC*h,this.m_JvAC),o-=this.m_iC*h*this.m_JwC,a.SelfMulSub(this.m_mD*h,this.m_JvBD),c-=this.m_iD*h*this.m_JwD,t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s,t.velocities[this.m_indexC].w=o,t.velocities[this.m_indexD].w=c}SolvePositionConstraints(e){const i=e.positions[this.m_indexA].c;let n=e.positions[this.m_indexA].a;const s=e.positions[this.m_indexB].c;let r=e.positions[this.m_indexB].a;const o=e.positions[this.m_indexC].c;let a=e.positions[this.m_indexC].a;const c=e.positions[this.m_indexD].c;let l=e.positions[this.m_indexD].a;const h=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(r),d=this.m_qC.SetAngle(a),m=this.m_qD.SetAngle(l),p=0;let f,g;const v=this.m_JvAC,y=this.m_JvBD;let x,S,C,A,b=0;if(this.m_typeA===t.b2JointType.e_revoluteJoint)v.SetZero(),x=1,C=1,b+=this.m_iA+this.m_iC,f=n-a-this.m_referenceAngleA;else{const t=Tt.MulRV(d,this.m_localAxisC,wn.SolvePositionConstraints_s_u),e=Tt.MulRV(d,this.m_lalcC,wn.SolvePositionConstraints_s_rC),n=Tt.MulRV(h,this.m_lalcA,wn.SolvePositionConstraints_s_rA);v.Copy(t),C=xt.CrossVV(e,t),x=xt.CrossVV(n,t),b+=this.m_mC+this.m_mA+this.m_iC*C*C+this.m_iA*x*x;const s=this.m_lalcC,r=Tt.MulTRV(d,xt.AddVV(n,xt.SubVV(i,o,xt.s_t0),xt.s_t0),xt.s_t0);f=xt.DotVV(xt.SubVV(r,s,xt.s_t0),this.m_localAxisC)}if(this.m_typeB===t.b2JointType.e_revoluteJoint)y.SetZero(),S=this.m_ratio,A=this.m_ratio,b+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),g=r-l-this.m_referenceAngleB;else{const t=Tt.MulRV(m,this.m_localAxisD,wn.SolvePositionConstraints_s_u),e=Tt.MulRV(m,this.m_lalcD,wn.SolvePositionConstraints_s_rD),i=Tt.MulRV(u,this.m_lalcB,wn.SolvePositionConstraints_s_rB);xt.MulSV(this.m_ratio,t,y),A=this.m_ratio*xt.CrossVV(e,t),S=this.m_ratio*xt.CrossVV(i,t),b+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*A*A+this.m_iB*S*S;const n=this.m_lalcD,r=Tt.MulTRV(m,xt.AddVV(i,xt.SubVV(s,c,xt.s_t0),xt.s_t0),xt.s_t0);g=xt.DotVV(xt.SubVV(r,n,xt.s_t0),this.m_localAxisD)}const T=f+this.m_ratio*g-this.m_constant;let E=0;return b>0&&(E=-T/b),i.SelfMulAdd(this.m_mA*E,v),n+=this.m_iA*E*x,s.SelfMulAdd(this.m_mB*E,y),r+=this.m_iB*E*S,o.SelfMulSub(this.m_mC*E,v),a-=this.m_iC*E*C,c.SelfMulSub(this.m_mD*E,y),l-=this.m_iD*E*A,e.positions[this.m_indexA].a=n,e.positions[this.m_indexB].a=r,e.positions[this.m_indexC].a=a,e.positions[this.m_indexD].a=l,p<_}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return xt.MulSV(t*this.m_impulse,this.m_JvAC,e)}GetReactionTorque(t){return t*this.m_impulse*this.m_JwA}GetJoint1(){return this.m_joint1}GetJoint2(){return this.m_joint2}GetRatio(){return this.m_ratio}SetRatio(t){this.m_ratio=t}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex,n=this.m_joint1.m_index,s=this.m_joint2.m_index;t("  const jd: b2GearJointDef = new b2GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",n),t("  jd.joint2 = joints[%d];\n",s),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}wn.InitVelocityConstraints_s_u=new xt,wn.InitVelocityConstraints_s_rA=new xt,wn.InitVelocityConstraints_s_rB=new xt,wn.InitVelocityConstraints_s_rC=new xt,wn.InitVelocityConstraints_s_rD=new xt,wn.SolvePositionConstraints_s_u=new xt,wn.SolvePositionConstraints_s_rA=new xt,wn.SolvePositionConstraints_s_rB=new xt,wn.SolvePositionConstraints_s_rC=new xt,wn.SolvePositionConstraints_s_rD=new xt;class In extends yn{constructor(){super(t.b2JointType.e_motorJoint),this.linearOffset=new xt(0,0),this.angularOffset=0,this.maxForce=1,this.maxTorque=1,this.correctionFactor=.3}Initialize(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);const i=this.bodyA.GetAngle(),n=this.bodyB.GetAngle();this.angularOffset=n-i}}class Rn extends xn{constructor(t){super(t),this.m_linearOffset=new xt,this.m_angularOffset=0,this.m_linearImpulse=new xt,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_correctionFactor=.3,this.m_indexA=0,this.m_indexB=0,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_linearError=new xt,this.m_angularError=0,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new At,this.m_angularMass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_K=new At,this.m_linearOffset.Copy(i(t.linearOffset,xt.ZERO)),this.m_linearImpulse.SetZero(),this.m_maxForce=i(t.maxForce,0),this.m_maxTorque=i(t.maxTorque,0),this.m_correctionFactor=i(t.correctionFactor,.3)}GetAnchorA(t){const e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t}GetAnchorB(t){const e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t}GetReactionForce(t,e){return xt.MulSV(t,this.m_linearImpulse,e)}GetReactionTorque(t){return t*this.m_angularImpulse}SetLinearOffset(t){xt.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))}GetLinearOffset(){return this.m_linearOffset}SetAngularOffset(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)}GetAngularOffset(){return this.m_angularOffset}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v;let c=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(o),_=Tt.MulRV(l,xt.SubVV(this.m_linearOffset,this.m_localCenterA,xt.s_t0),this.m_rA),u=Tt.MulRV(h,xt.NegV(this.m_localCenterB,xt.s_t0),this.m_rB),d=this.m_invMassA,m=this.m_invMassB,p=this.m_invIA,f=this.m_invIB,g=this.m_K;if(g.ex.x=d+m+p*_.y*_.y+f*u.y*u.y,g.ex.y=-p*_.x*_.y-f*u.x*u.y,g.ey.x=g.ex.y,g.ey.y=d+m+p*_.x*_.x+f*u.x*u.x,g.GetInverse(this.m_linearMass),this.m_angularMass=p+f,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),xt.SubVV(xt.AddVV(r,u,xt.s_t0),xt.AddVV(e,_,xt.s_t1),this.m_linearError),this.m_angularError=o-i-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;n.SelfMulSub(d,e),s-=p*(xt.CrossVV(_,e)+this.m_angularImpulse),a.SelfMulAdd(m,e),c+=f*(xt.CrossVV(u,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=c}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=this.m_invMassA,o=this.m_invMassB,a=this.m_invIA,c=this.m_invIB,l=t.step.dt,h=t.step.inv_dt;{const t=s-i+h*this.m_correctionFactor*this.m_angularError;let e=-this.m_angularMass*t;const n=this.m_angularImpulse,r=l*this.m_maxTorque;this.m_angularImpulse=it(this.m_angularImpulse+e,-r,r),e=this.m_angularImpulse-n,i-=a*e,s+=c*e}{const t=this.m_rA,_=this.m_rB,u=xt.AddVV(xt.SubVV(xt.AddVV(n,xt.CrossSV(s,_,xt.s_t0),xt.s_t0),xt.AddVV(e,xt.CrossSV(i,t,xt.s_t1),xt.s_t1),xt.s_t2),xt.MulSV(h*this.m_correctionFactor,this.m_linearError,xt.s_t3),Rn.SolveVelocityConstraints_s_Cdot_v2),d=At.MulMV(this.m_linearMass,u,Rn.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),m=Rn.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(d);const p=l*this.m_maxForce;this.m_linearImpulse.LengthSquared()>p*p&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(p)),xt.SubVV(this.m_linearImpulse,m,d),e.SelfMulSub(r,d),i-=a*xt.CrossVV(t,d),n.SelfMulAdd(o,d),s+=c*xt.CrossVV(_,d)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){return!0}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.m_angularOffset),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Rn.SolveVelocityConstraints_s_Cdot_v2=new xt,Rn.SolveVelocityConstraints_s_impulse_v2=new xt,Rn.SolveVelocityConstraints_s_oldImpulse_v2=new xt;class Dn extends yn{constructor(){super(t.b2JointType.e_mouseJoint),this.target=new xt,this.maxForce=0,this.frequencyHz=5,this.dampingRatio=.7}}class Mn extends xn{constructor(t){super(t),this.m_localAnchorB=new xt,this.m_targetA=new xt,this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_beta=0,this.m_impulse=new xt,this.m_maxForce=0,this.m_gamma=0,this.m_indexA=0,this.m_indexB=0,this.m_rB=new xt,this.m_localCenterB=new xt,this.m_invMassB=0,this.m_invIB=0,this.m_mass=new At,this.m_C=new xt,this.m_qB=new Tt,this.m_lalcB=new xt,this.m_K=new At,this.m_targetA.Copy(i(t.target,xt.ZERO)),Et.MulTXV(this.m_bodyB.GetTransform(),this.m_targetA,this.m_localAnchorB),this.m_maxForce=i(t.maxForce,0),this.m_impulse.SetZero(),this.m_frequencyHz=i(t.frequencyHz,0),this.m_dampingRatio=i(t.dampingRatio,0),this.m_beta=0,this.m_gamma=0}SetTarget(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)}GetTarget(){return this.m_targetA}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}InitVelocityConstraints(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexB].c,i=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=this.m_qB.SetAngle(i),a=this.m_bodyB.GetMass(),c=2*o*this.m_frequencyHz,l=2*a*this.m_dampingRatio*c,h=a*c*c,_=t.step.dt;this.m_gamma=_*(l+_*h),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=_*h*this.m_gamma,xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(r,this.m_lalcB,this.m_rB);const u=this.m_K;u.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,u.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,u.ey.x=u.ex.y,u.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,u.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),s*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),n.x+=this.m_invMassB*this.m_impulse.x,n.y+=this.m_invMassB*this.m_impulse.y,s+=this.m_invIB*xt.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=s}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexB].v;let i=t.velocities[this.m_indexB].w;const n=xt.AddVCrossSV(e,i,this.m_rB,Mn.SolveVelocityConstraints_s_Cdot),s=At.MulMV(this.m_mass,xt.AddVV(n,xt.AddVV(this.m_C,xt.MulSV(this.m_gamma,this.m_impulse,xt.s_t0),xt.s_t0),xt.s_t0).SelfNeg(),Mn.SolveVelocityConstraints_s_impulse),r=Mn.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(s);const o=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>o*o&&this.m_impulse.SelfMul(o/this.m_impulse.Length()),xt.SubVV(this.m_impulse,r,s),e.SelfMulAdd(this.m_invMassB,s),i+=this.m_invIB*xt.CrossVV(this.m_rB,s),t.velocities[this.m_indexB].w=i}SolvePositionConstraints(t){return!0}GetAnchorA(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return xt.MulSV(t,this.m_impulse,e)}GetReactionTorque(t){return 0}Dump(t){t("Mouse joint dumping is not supported.\n")}ShiftOrigin(t){this.m_targetA.SelfSub(t)}}Mn.SolveVelocityConstraints_s_Cdot=new xt,Mn.SolveVelocityConstraints_s_impulse=new xt,Mn.SolveVelocityConstraints_s_oldImpulse=new xt;class On extends yn{constructor(){super(t.b2JointType.e_prismaticJoint),this.localAnchorA=new xt,this.localAnchorB=new xt,this.localAxisA=new xt(1,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class Bn extends xn{constructor(e){super(e),this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_localXAxisA=new xt,this.m_localYAxisA=new xt,this.m_referenceAngle=0,this.m_impulse=new Ct(0,0,0),this.m_motorImpulse=0,this.m_lowerTranslation=0,this.m_upperTranslation=0,this.m_maxMotorForce=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_enableMotor=!1,this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_axis=new xt(0,0),this.m_perp=new xt(0,0),this.m_s1=0,this.m_s2=0,this.m_a1=0,this.m_a2=0,this.m_K=new bt,this.m_K3=new bt,this.m_K2=new At,this.m_motorMass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_localAnchorA.Copy(i(e.localAnchorA,xt.ZERO)),this.m_localAnchorB.Copy(i(e.localAnchorB,xt.ZERO)),this.m_localXAxisA.Copy(i(e.localAxisA,new xt(1,0))).SelfNormalize(),xt.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_referenceAngle=i(e.referenceAngle,0),this.m_lowerTranslation=i(e.lowerTranslation,0),this.m_upperTranslation=i(e.upperTranslation,0),this.m_maxMotorForce=i(e.maxMotorForce,0),this.m_motorSpeed=i(e.motorSpeed,0),this.m_enableLimit=i(e.enableLimit,!1),this.m_enableMotor=i(e.enableMotor,!1)}InitVelocityConstraints(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const i=e.positions[this.m_indexA].c,n=e.positions[this.m_indexA].a,s=e.velocities[this.m_indexA].v;let r=e.velocities[this.m_indexA].w;const o=e.positions[this.m_indexB].c,a=e.positions[this.m_indexB].a,c=e.velocities[this.m_indexB].v;let l=e.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const d=Tt.MulRV(h,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const m=Tt.MulRV(u,this.m_lalcB,this.m_rB),p=xt.AddVV(xt.SubVV(o,i,xt.s_t0),xt.SubVV(m,d,xt.s_t1),Bn.InitVelocityConstraints_s_d),f=this.m_invMassA,g=this.m_invMassB,v=this.m_invIA,y=this.m_invIB;if(Tt.MulRV(h,this.m_localXAxisA,this.m_axis),this.m_a1=xt.CrossVV(xt.AddVV(p,d,xt.s_t0),this.m_axis),this.m_a2=xt.CrossVV(m,this.m_axis),this.m_motorMass=f+g+v*this.m_a1*this.m_a1+y*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),Tt.MulRV(h,this.m_localYAxisA,this.m_perp),this.m_s1=xt.CrossVV(xt.AddVV(p,d,xt.s_t0),this.m_perp),this.m_s2=xt.CrossVV(m,this.m_perp),this.m_K.ex.x=f+g+v*this.m_s1*this.m_s1+y*this.m_s2*this.m_s2,this.m_K.ex.y=v*this.m_s1+y*this.m_s2,this.m_K.ex.z=v*this.m_s1*this.m_a1+y*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=v+y,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_K.ey.z=v*this.m_a1+y*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=f+g+v*this.m_a1*this.m_a1+y*this.m_a2*this.m_a2,this.m_enableLimit){const e=xt.DotVV(this.m_axis,p);Q(this.m_upperTranslation-this.m_lowerTranslation)<2*_?this.m_limitState=t.b2LimitState.e_equalLimits:e<=this.m_lowerTranslation?this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_limitState=t.b2LimitState.e_atLowerLimit,this.m_impulse.z=0):e>=this.m_upperTranslation?this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_limitState=t.b2LimitState.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;const t=xt.AddVV(xt.MulSV(this.m_impulse.x,this.m_perp,xt.s_t0),xt.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,xt.s_t1),Bn.InitVelocityConstraints_s_P),i=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,n=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;s.SelfMulSub(f,t),r-=v*i,c.SelfMulAdd(g,t),l+=y*n}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=l}SolveVelocityConstraints(e){const i=e.velocities[this.m_indexA].v;let n=e.velocities[this.m_indexA].w;const s=e.velocities[this.m_indexB].v;let r=e.velocities[this.m_indexB].w;const o=this.m_invMassA,a=this.m_invMassB,c=this.m_invIA,l=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits){const t=xt.DotVV(this.m_axis,xt.SubVV(s,i,xt.s_t0))+this.m_a2*r-this.m_a1*n;let h=this.m_motorMass*(this.m_motorSpeed-t);const _=this.m_motorImpulse,u=e.step.dt*this.m_maxMotorForce;this.m_motorImpulse=it(this.m_motorImpulse+h,-u,u),h=this.m_motorImpulse-_;const d=xt.MulSV(h,this.m_axis,Bn.SolveVelocityConstraints_s_P),m=h*this.m_a1,p=h*this.m_a2;i.SelfMulSub(o,d),n-=c*m,s.SelfMulAdd(a,d),r+=l*p}const h=xt.DotVV(this.m_perp,xt.SubVV(s,i,xt.s_t0))+this.m_s2*r-this.m_s1*n,_=r-n;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit){const e=xt.DotVV(this.m_axis,xt.SubVV(s,i,xt.s_t0))+this.m_a2*r-this.m_a1*n,u=Bn.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),d=this.m_K.Solve33(-h,-_,-e,Bn.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(d),this.m_limitState===t.b2LimitState.e_atLowerLimit?this.m_impulse.z=et(this.m_impulse.z,0):this.m_limitState===t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=tt(this.m_impulse.z,0));const m=-h-(this.m_impulse.z-u.z)*this.m_K.ez.x,p=-_-(this.m_impulse.z-u.z)*this.m_K.ez.y,f=this.m_K.Solve22(m,p,Bn.SolveVelocityConstraints_s_f2r);f.x+=u.x,f.y+=u.y,this.m_impulse.x=f.x,this.m_impulse.y=f.y,d.x=this.m_impulse.x-u.x,d.y=this.m_impulse.y-u.y,d.z=this.m_impulse.z-u.z;const g=xt.AddVV(xt.MulSV(d.x,this.m_perp,xt.s_t0),xt.MulSV(d.z,this.m_axis,xt.s_t1),Bn.SolveVelocityConstraints_s_P),v=d.x*this.m_s1+d.y+d.z*this.m_a1,y=d.x*this.m_s2+d.y+d.z*this.m_a2;i.SelfMulSub(o,g),n-=c*v,s.SelfMulAdd(a,g),r+=l*y}else{const t=this.m_K.Solve22(-h,-_,Bn.SolveVelocityConstraints_s_df2);this.m_impulse.x+=t.x,this.m_impulse.y+=t.y;const e=xt.MulSV(t.x,this.m_perp,Bn.SolveVelocityConstraints_s_P),u=t.x*this.m_s1+t.y,d=t.x*this.m_s2+t.y;i.SelfMulSub(o,e),n-=c*u,s.SelfMulAdd(a,e),r+=l*d}e.velocities[this.m_indexA].w=n,e.velocities[this.m_indexB].w=r}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s),a=this.m_invMassA,c=this.m_invMassB,l=this.m_invIA,h=this.m_invIB,d=Tt.MulRV(r,this.m_lalcA,this.m_rA),m=Tt.MulRV(o,this.m_lalcB,this.m_rB),p=xt.SubVV(xt.AddVV(n,m,xt.s_t0),xt.AddVV(e,d,xt.s_t1),Bn.SolvePositionConstraints_s_d),f=Tt.MulRV(r,this.m_localXAxisA,this.m_axis),v=xt.CrossVV(xt.AddVV(p,d,xt.s_t0),f),y=xt.CrossVV(m,f),x=Tt.MulRV(r,this.m_localYAxisA,this.m_perp),S=xt.CrossVV(xt.AddVV(p,d,xt.s_t0),x),C=xt.CrossVV(m,x);let A=Bn.SolvePositionConstraints_s_impulse;const b=xt.DotVV(x,p),T=s-i-this.m_referenceAngle;let E=Q(b);const P=Q(T);let w=!1,I=0;if(this.m_enableLimit){const t=xt.DotVV(f,p);Q(this.m_upperTranslation-this.m_lowerTranslation)<2*_?(I=it(t,-g,g),E=et(E,Q(t)),w=!0):t<=this.m_lowerTranslation?(I=it(t-this.m_lowerTranslation+_,-g,0),E=et(E,this.m_lowerTranslation-t),w=!0):t>=this.m_upperTranslation&&(I=it(t-this.m_upperTranslation-_,0,g),E=et(E,t-this.m_upperTranslation),w=!0)}if(w){const t=a+c+l*S*S+h*C*C,e=l*S+h*C,i=l*S*v+h*C*y;let n=l+h;0===n&&(n=1);const s=l*v+h*y,r=a+c+l*v*v+h*y*y,o=this.m_K3;o.ex.SetXYZ(t,e,i),o.ey.SetXYZ(e,n,s),o.ez.SetXYZ(i,s,r),A=o.Solve33(-b,-T,-I,A)}else{const t=a+c+l*S*S+h*C*C,e=l*S+h*C;let i=l+h;0===i&&(i=1);const n=this.m_K2;n.ex.Set(t,e),n.ey.Set(e,i);const s=n.Solve(-b,-T,Bn.SolvePositionConstraints_s_impulse1);A.x=s.x,A.y=s.y,A.z=0}const R=xt.AddVV(xt.MulSV(A.x,x,xt.s_t0),xt.MulSV(A.z,f,xt.s_t1),Bn.SolvePositionConstraints_s_P),D=A.x*S+A.y+A.z*v,M=A.x*C+A.y+A.z*y;return e.SelfMulSub(a,R),i-=l*D,n.SelfMulAdd(c,R),s+=h*M,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,E<=_&&P<=u}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),e.y=t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y),e}GetReactionTorque(t){return t*this.m_impulse.y}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetReferenceAngle(){return this.m_referenceAngle}GetJointTranslation(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,Bn.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,Bn.GetJointTranslation_s_pB),i=xt.SubVV(e,t,Bn.GetJointTranslation_s_d),n=this.m_bodyA.GetWorldVector(this.m_localXAxisA,Bn.GetJointTranslation_s_axis);return xt.DotVV(i,n)}GetJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;xt.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=Tt.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const n=Tt.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),s=xt.AddVV(t.m_sweep.c,i,xt.s_t0),r=xt.AddVV(e.m_sweep.c,n,xt.s_t1),o=xt.SubVV(r,s,xt.s_t2),a=t.GetWorldVector(this.m_localXAxisA,this.m_axis),c=t.m_linearVelocity,l=e.m_linearVelocity,h=t.m_angularVelocity,_=e.m_angularVelocity;return xt.DotVV(o,xt.CrossSV(h,a,xt.s_t0))+xt.DotVV(a,xt.SubVV(xt.AddVCrossSV(l,_,n,xt.s_t0),xt.AddVCrossSV(c,h,i,xt.s_t1),xt.s_t0))}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)}GetLowerLimit(){return this.m_lowerTranslation}GetUpperLimit(){return this.m_upperTranslation}SetLimits(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorForce(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)}GetMaxMotorForce(){return this.m_maxMotorForce}GetMotorForce(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Bn.InitVelocityConstraints_s_d=new xt,Bn.InitVelocityConstraints_s_P=new xt,Bn.SolveVelocityConstraints_s_P=new xt,Bn.SolveVelocityConstraints_s_f2r=new xt,Bn.SolveVelocityConstraints_s_f1=new Ct,Bn.SolveVelocityConstraints_s_df3=new Ct,Bn.SolveVelocityConstraints_s_df2=new xt,Bn.SolvePositionConstraints_s_d=new xt,Bn.SolvePositionConstraints_s_impulse=new Ct,Bn.SolvePositionConstraints_s_impulse1=new xt,Bn.SolvePositionConstraints_s_P=new xt,Bn.GetJointTranslation_s_pA=new xt,Bn.GetJointTranslation_s_pB=new xt,Bn.GetJointTranslation_s_d=new xt,Bn.GetJointTranslation_s_axis=new xt;const Nn=2;class Ln extends yn{constructor(){super(t.b2JointType.e_pulleyJoint),this.groundAnchorA=new xt(-1,1),this.groundAnchorB=new xt(1,1),this.localAnchorA=new xt(-1,0),this.localAnchorB=new xt(1,0),this.lengthA=0,this.lengthB=0,this.ratio=1,this.collideConnected=!0}Initialize(t,e,i,n,s,r,o){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(i),this.groundAnchorB.Copy(n),this.bodyA.GetLocalPoint(s,this.localAnchorA),this.bodyB.GetLocalPoint(r,this.localAnchorB),this.lengthA=xt.DistanceVV(s,i),this.lengthB=xt.DistanceVV(r,n),this.ratio=o}}class Fn extends xn{constructor(t){super(t),this.m_groundAnchorA=new xt,this.m_groundAnchorB=new xt,this.m_lengthA=0,this.m_lengthB=0,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_uA=new xt,this.m_uB=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_groundAnchorA.Copy(i(t.groundAnchorA,new xt(-1,1))),this.m_groundAnchorB.Copy(i(t.groundAnchorB,new xt(1,0))),this.m_localAnchorA.Copy(i(t.localAnchorA,new xt(-1,0))),this.m_localAnchorB.Copy(i(t.localAnchorB,new xt(1,0))),this.m_lengthA=i(t.lengthA,0),this.m_lengthB=i(t.lengthB,0),this.m_ratio=i(t.ratio,1),this.m_constant=i(t.lengthA,0)+this.m_ratio*i(t.lengthB,0),this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v;let c=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(o);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(l,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(h,this.m_lalcB,this.m_rB),this.m_uA.Copy(e).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(r).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);const u=this.m_uA.Length(),d=this.m_uB.Length();u>10*_?this.m_uA.SelfMul(1/u):this.m_uA.SetZero(),d>10*_?this.m_uB.SelfMul(1/d):this.m_uB.SetZero();const m=xt.CrossVV(this.m_rA,this.m_uA),p=xt.CrossVV(this.m_rB,this.m_uB),f=this.m_invMassA+this.m_invIA*m*m,g=this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=f+this.m_ratio*this.m_ratio*g,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const e=xt.MulSV(-this.m_impulse,this.m_uA,Fn.InitVelocityConstraints_s_PA),i=xt.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,Fn.InitVelocityConstraints_s_PB);n.SelfMulAdd(this.m_invMassA,e),s+=this.m_invIA*xt.CrossVV(this.m_rA,e),a.SelfMulAdd(this.m_invMassB,i),c+=this.m_invIB*xt.CrossVV(this.m_rB,i)}else this.m_impulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=c}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=xt.AddVCrossSV(e,i,this.m_rA,Fn.SolveVelocityConstraints_s_vpA),o=xt.AddVCrossSV(n,s,this.m_rB,Fn.SolveVelocityConstraints_s_vpB),a=-xt.DotVV(this.m_uA,r)-this.m_ratio*xt.DotVV(this.m_uB,o),c=-this.m_mass*a;this.m_impulse+=c;const l=xt.MulSV(-c,this.m_uA,Fn.SolveVelocityConstraints_s_PA),h=xt.MulSV(-this.m_ratio*c,this.m_uB,Fn.SolveVelocityConstraints_s_PB);e.SelfMulAdd(this.m_invMassA,l),i+=this.m_invIA*xt.CrossVV(this.m_rA,l),n.SelfMulAdd(this.m_invMassB,h),s+=this.m_invIB*xt.CrossVV(this.m_rB,h),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const a=Tt.MulRV(r,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const c=Tt.MulRV(o,this.m_lalcB,this.m_rB),l=this.m_uA.Copy(e).SelfAdd(a).SelfSub(this.m_groundAnchorA),h=this.m_uB.Copy(n).SelfAdd(c).SelfSub(this.m_groundAnchorB),u=l.Length(),d=h.Length();u>10*_?l.SelfMul(1/u):l.SetZero(),d>10*_?h.SelfMul(1/d):h.SetZero();const m=xt.CrossVV(a,l),p=xt.CrossVV(c,h),f=this.m_invMassA+this.m_invIA*m*m,g=this.m_invMassB+this.m_invIB*p*p;let v=f+this.m_ratio*this.m_ratio*g;v>0&&(v=1/v);const y=this.m_constant-u-this.m_ratio*d,x=Q(y),S=-v*y,C=xt.MulSV(-S,l,Fn.SolvePositionConstraints_s_PA),A=xt.MulSV(-this.m_ratio*S,h,Fn.SolvePositionConstraints_s_PB);return e.SelfMulAdd(this.m_invMassA,C),i+=this.m_invIA*xt.CrossVV(a,C),n.SelfMulAdd(this.m_invMassB,A),s+=this.m_invIB*xt.CrossVV(c,A),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,x<_}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e}GetReactionTorque(t){return 0}GetGroundAnchorA(){return this.m_groundAnchorA}GetGroundAnchorB(){return this.m_groundAnchorB}GetLengthA(){return this.m_lengthA}GetLengthB(){return this.m_lengthB}GetRatio(){return this.m_ratio}GetCurrentLengthA(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,Fn.GetCurrentLengthA_s_p),e=this.m_groundAnchorA;return xt.DistanceVV(t,e)}GetCurrentLengthB(){const t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,Fn.GetCurrentLengthB_s_p),e=this.m_groundAnchorB;return xt.DistanceVV(t,e)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.m_lengthA),t("  jd.lengthB = %.15f;\n",this.m_lengthB),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}ShiftOrigin(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)}}Fn.InitVelocityConstraints_s_PA=new xt,Fn.InitVelocityConstraints_s_PB=new xt,Fn.SolveVelocityConstraints_s_vpA=new xt,Fn.SolveVelocityConstraints_s_vpB=new xt,Fn.SolveVelocityConstraints_s_PA=new xt,Fn.SolveVelocityConstraints_s_PB=new xt,Fn.SolvePositionConstraints_s_PA=new xt,Fn.SolvePositionConstraints_s_PB=new xt,Fn.GetCurrentLengthA_s_p=new xt,Fn.GetCurrentLengthB_s_p=new xt;class zn extends yn{constructor(){super(t.b2JointType.e_revoluteJoint),this.localAnchorA=new xt(0,0),this.localAnchorB=new xt(0,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerAngle=0,this.upperAngle=0,this.enableMotor=!1,this.motorSpeed=0,this.maxMotorTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class Vn extends xn{constructor(e){super(e),this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_impulse=new Ct,this.m_motorImpulse=0,this.m_enableMotor=!1,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_referenceAngle=0,this.m_lowerAngle=0,this.m_upperAngle=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new bt,this.m_motorMass=0,this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_K=new At,this.m_localAnchorA.Copy(i(e.localAnchorA,xt.ZERO)),this.m_localAnchorB.Copy(i(e.localAnchorB,xt.ZERO)),this.m_referenceAngle=i(e.referenceAngle,0),this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=i(e.lowerAngle,0),this.m_upperAngle=i(e.upperAngle,0),this.m_maxMotorTorque=i(e.maxMotorTorque,0),this.m_motorSpeed=i(e.motorSpeed,0),this.m_enableLimit=i(e.enableLimit,!1),this.m_enableMotor=i(e.enableMotor,!1),this.m_limitState=t.b2LimitState.e_inactiveLimit}InitVelocityConstraints(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const i=e.positions[this.m_indexA].a,n=e.velocities[this.m_indexA].v;let s=e.velocities[this.m_indexA].w;const r=e.positions[this.m_indexB].a,o=e.velocities[this.m_indexB].v;let a=e.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),l=this.m_qB.SetAngle(r);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(c,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(l,this.m_lalcB,this.m_rB);const h=this.m_invMassA,_=this.m_invMassB,d=this.m_invIA,m=this.m_invIB,p=d+m===0;if(this.m_mass.ex.x=h+_+this.m_rA.y*this.m_rA.y*d+this.m_rB.y*this.m_rB.y*m,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*d-this.m_rB.y*this.m_rB.x*m,this.m_mass.ez.x=-this.m_rA.y*d-this.m_rB.y*m,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=h+_+this.m_rA.x*this.m_rA.x*d+this.m_rB.x*this.m_rB.x*m,this.m_mass.ez.y=this.m_rA.x*d+this.m_rB.x*m,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=d+m,this.m_motorMass=d+m,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),this.m_enableMotor&&!p||(this.m_motorImpulse=0),this.m_enableLimit&&!p){const e=r-i-this.m_referenceAngle;Q(this.m_upperAngle-this.m_lowerAngle)<2*u?this.m_limitState=t.b2LimitState.e_equalLimits:e<=this.m_lowerAngle?(this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atLowerLimit):e>=this.m_upperAngle?(this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atUpperLimit):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit;if(e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;const t=Vn.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);n.SelfMulSub(h,t),s-=d*(xt.CrossVV(this.m_rA,t)+this.m_motorImpulse+this.m_impulse.z),o.SelfMulAdd(_,t),a+=m*(xt.CrossVV(this.m_rB,t)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=s,e.velocities[this.m_indexB].w=a}SolveVelocityConstraints(e){const i=e.velocities[this.m_indexA].v;let n=e.velocities[this.m_indexA].w;const s=e.velocities[this.m_indexB].v;let r=e.velocities[this.m_indexB].w;const o=this.m_invMassA,a=this.m_invMassB,c=this.m_invIA,l=this.m_invIB,h=c+l===0;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits&&!h){const t=r-n-this.m_motorSpeed;let i=-this.m_motorMass*t;const s=this.m_motorImpulse,o=e.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=it(this.m_motorImpulse+i,-o,o),i=this.m_motorImpulse-s,n-=c*i,r+=l*i}if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!h){const e=xt.SubVV(xt.AddVCrossSV(s,r,this.m_rB,xt.s_t0),xt.AddVCrossSV(i,n,this.m_rA,xt.s_t1),Vn.SolveVelocityConstraints_s_Cdot1),h=r-n,_=this.m_mass.Solve33(e.x,e.y,h,Vn.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===t.b2LimitState.e_equalLimits)this.m_impulse.SelfAdd(_);else if(this.m_limitState===t.b2LimitState.e_atLowerLimit)if(this.m_impulse.z+_.z<0){const t=-e.x+this.m_impulse.z*this.m_mass.ez.x,i=-e.y+this.m_impulse.z*this.m_mass.ez.y,n=this.m_mass.Solve22(t,i,Vn.SolveVelocityConstraints_s_reduced_v2);_.x=n.x,_.y=n.y,_.z=-this.m_impulse.z,this.m_impulse.x+=n.x,this.m_impulse.y+=n.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(_);else if(this.m_limitState===t.b2LimitState.e_atUpperLimit)if(this.m_impulse.z+_.z>0){const t=-e.x+this.m_impulse.z*this.m_mass.ez.x,i=-e.y+this.m_impulse.z*this.m_mass.ez.y,n=this.m_mass.Solve22(t,i,Vn.SolveVelocityConstraints_s_reduced_v2);_.x=n.x,_.y=n.y,_.z=-this.m_impulse.z,this.m_impulse.x+=n.x,this.m_impulse.y+=n.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(_);const u=Vn.SolveVelocityConstraints_s_P.Set(_.x,_.y);i.SelfMulSub(o,u),n-=c*(xt.CrossVV(this.m_rA,u)+_.z),s.SelfMulAdd(a,u),r+=l*(xt.CrossVV(this.m_rB,u)+_.z)}else{const t=xt.SubVV(xt.AddVCrossSV(s,r,this.m_rB,xt.s_t0),xt.AddVCrossSV(i,n,this.m_rA,xt.s_t1),Vn.SolveVelocityConstraints_s_Cdot_v2),e=this.m_mass.Solve22(-t.x,-t.y,Vn.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=e.x,this.m_impulse.y+=e.y,i.SelfMulSub(o,e),n-=c*xt.CrossVV(this.m_rA,e),s.SelfMulAdd(a,e),r+=l*xt.CrossVV(this.m_rB,e)}e.velocities[this.m_indexA].w=n,e.velocities[this.m_indexB].w=r}SolvePositionConstraints(e){const i=e.positions[this.m_indexA].c;let n=e.positions[this.m_indexA].a;const s=e.positions[this.m_indexB].c;let r=e.positions[this.m_indexB].a;const o=this.m_qA.SetAngle(n),a=this.m_qB.SetAngle(r);let c=0,l=0;const h=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!h){const e=r-n-this.m_referenceAngle;let i=0;if(this.m_limitState===t.b2LimitState.e_equalLimits){const t=it(e-this.m_lowerAngle,-v,v);i=-this.m_motorMass*t,c=Q(t)}else if(this.m_limitState===t.b2LimitState.e_atLowerLimit){let t=e-this.m_lowerAngle;c=-t,t=it(t+u,-v,0),i=-this.m_motorMass*t}else if(this.m_limitState===t.b2LimitState.e_atUpperLimit){let t=e-this.m_upperAngle;c=t,t=it(t-u,0,v),i=-this.m_motorMass*t}n-=this.m_invIA*i,r+=this.m_invIB*i}{o.SetAngle(n),a.SetAngle(r),xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const t=Tt.MulRV(o,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const e=Tt.MulRV(a,this.m_lalcB,this.m_rB),c=xt.SubVV(xt.AddVV(s,e,xt.s_t0),xt.AddVV(i,t,xt.s_t1),Vn.SolvePositionConstraints_s_C_v2);l=c.Length();const h=this.m_invMassA,_=this.m_invMassB,u=this.m_invIA,d=this.m_invIB,m=this.m_K;m.ex.x=h+_+u*t.y*t.y+d*e.y*e.y,m.ex.y=-u*t.x*t.y-d*e.x*e.y,m.ey.x=m.ex.y,m.ey.y=h+_+u*t.x*t.x+d*e.x*e.x;const p=m.Solve(c.x,c.y,Vn.SolvePositionConstraints_s_impulse).SelfNeg();i.SelfMulSub(h,p),n-=u*xt.CrossVV(t,p),s.SelfMulAdd(_,p),r+=d*xt.CrossVV(e,p)}return e.positions[this.m_indexA].a=n,e.positions[this.m_indexB].a=r,l<=_&&c<=u}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}GetJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle}GetJointSpeed(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}GetMotorTorque(t){return t*this.m_motorImpulse}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMaxMotorTorque(){return this.m_maxMotorTorque}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)}GetLowerLimit(){return this.m_lowerAngle}GetUpperLimit(){return this.m_upperAngle}SetLimits(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),t("  jd.upperAngle = %.15f;\n",this.m_upperAngle),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Vn.InitVelocityConstraints_s_P=new xt,Vn.SolveVelocityConstraints_s_P=new xt,Vn.SolveVelocityConstraints_s_Cdot_v2=new xt,Vn.SolveVelocityConstraints_s_Cdot1=new xt,Vn.SolveVelocityConstraints_s_impulse_v3=new Ct,Vn.SolveVelocityConstraints_s_reduced_v2=new xt,Vn.SolveVelocityConstraints_s_impulse_v2=new xt,Vn.SolvePositionConstraints_s_C_v2=new xt,Vn.SolvePositionConstraints_s_impulse=new xt;class Gn extends yn{constructor(){super(t.b2JointType.e_ropeJoint),this.localAnchorA=new xt(-1,0),this.localAnchorB=new xt(1,0),this.maxLength=0}}class Un extends xn{constructor(e){super(e),this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_maxLength=0,this.m_length=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_state=t.b2LimitState.e_inactiveLimit,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_localAnchorA.Copy(i(e.localAnchorA,new xt(-1,0))),this.m_localAnchorB.Copy(i(e.localAnchorB,new xt(1,0))),this.m_maxLength=i(e.maxLength,0)}InitVelocityConstraints(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const i=e.positions[this.m_indexA].c,n=e.positions[this.m_indexA].a,s=e.velocities[this.m_indexA].v;let r=e.velocities[this.m_indexA].w;const o=e.positions[this.m_indexB].c,a=e.positions[this.m_indexB].a,c=e.velocities[this.m_indexB].v;let l=e.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(h,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(u,this.m_lalcB,this.m_rB),this.m_u.Copy(o).SelfAdd(this.m_rB).SelfSub(i).SelfSub(this.m_rA),this.m_length=this.m_u.Length();const d=this.m_length-this.m_maxLength;if(this.m_state=d>0?t.b2LimitState.e_atUpperLimit:t.b2LimitState.e_inactiveLimit,!(this.m_length>_))return this.m_u.SetZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.SelfMul(1/this.m_length);const m=xt.CrossVV(this.m_rA,this.m_u),p=xt.CrossVV(this.m_rB,this.m_u),f=this.m_invMassA+this.m_invIA*m*m+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=0!==f?1/f:0,e.step.warmStarting){this.m_impulse*=e.step.dtRatio;const t=xt.MulSV(this.m_impulse,this.m_u,Un.InitVelocityConstraints_s_P);s.SelfMulSub(this.m_invMassA,t),r-=this.m_invIA*xt.CrossVV(this.m_rA,t),c.SelfMulAdd(this.m_invMassB,t),l+=this.m_invIB*xt.CrossVV(this.m_rB,t)}else this.m_impulse=0;e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=l}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=xt.AddVCrossSV(e,i,this.m_rA,Un.SolveVelocityConstraints_s_vpA),o=xt.AddVCrossSV(n,s,this.m_rB,Un.SolveVelocityConstraints_s_vpB),a=this.m_length-this.m_maxLength;let c=xt.DotVV(this.m_u,xt.SubVV(o,r,xt.s_t0));a<0&&(c+=t.step.inv_dt*a);let l=-this.m_mass*c;const h=this.m_impulse;this.m_impulse=tt(0,this.m_impulse+l),l=this.m_impulse-h;const _=xt.MulSV(l,this.m_u,Un.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,_),i-=this.m_invIA*xt.CrossVV(this.m_rA,_),n.SelfMulAdd(this.m_invMassB,_),s+=this.m_invIB*xt.CrossVV(this.m_rB,_),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const a=Tt.MulRV(r,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const c=Tt.MulRV(o,this.m_lalcB,this.m_rB),l=this.m_u.Copy(n).SelfAdd(c).SelfSub(e).SelfSub(a),h=l.Normalize();let u=h-this.m_maxLength;u=it(u,0,g);const d=-this.m_mass*u,m=xt.MulSV(d,l,Un.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,m),i-=this.m_invIA*xt.CrossVV(a,m),n.SelfMulAdd(this.m_invMassB,m),s+=this.m_invIB*xt.CrossVV(c,m),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,h-this.m_maxLength<_}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return xt.MulSV(t*this.m_impulse,this.m_u,e)}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxLength(t){this.m_maxLength=t}GetMaxLength(){return this.m_maxLength}GetLimitState(){return this.m_state}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RopeJointDef = new b2RopeJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxLength = %.15f;\n",this.m_maxLength),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Un.InitVelocityConstraints_s_P=new xt,Un.SolveVelocityConstraints_s_vpA=new xt,Un.SolveVelocityConstraints_s_vpB=new xt,Un.SolveVelocityConstraints_s_P=new xt,Un.SolvePositionConstraints_s_P=new xt;class kn extends yn{constructor(){super(t.b2JointType.e_weldJoint),this.localAnchorA=new xt,this.localAnchorB=new xt,this.referenceAngle=0,this.frequencyHz=0,this.dampingRatio=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class Hn extends xn{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_bias=0,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_referenceAngle=0,this.m_gamma=0,this.m_impulse=new Ct(0,0,0),this.m_indexA=0,this.m_indexB=0,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new bt,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_K=new bt,this.m_frequencyHz=i(t.frequencyHz,0),this.m_dampingRatio=i(t.dampingRatio,0),this.m_localAnchorA.Copy(i(t.localAnchorA,xt.ZERO)),this.m_localAnchorB.Copy(i(t.localAnchorB,xt.ZERO)),this.m_referenceAngle=i(t.referenceAngle,0),this.m_impulse.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const s=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(e),l=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(c,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(l,this.m_lalcB,this.m_rB);const h=this.m_invMassA,_=this.m_invMassB,u=this.m_invIA,d=this.m_invIB,m=this.m_K;if(m.ex.x=h+_+this.m_rA.y*this.m_rA.y*u+this.m_rB.y*this.m_rB.y*d,m.ey.x=-this.m_rA.y*this.m_rA.x*u-this.m_rB.y*this.m_rB.x*d,m.ez.x=-this.m_rA.y*u-this.m_rB.y*d,m.ex.y=m.ey.x,m.ey.y=h+_+this.m_rA.x*this.m_rA.x*u+this.m_rB.x*this.m_rB.x*d,m.ez.y=this.m_rA.x*u+this.m_rB.x*d,m.ex.z=m.ez.x,m.ey.z=m.ez.y,m.ez.z=u+d,this.m_frequencyHz>0){m.GetInverse22(this.m_mass);let i=u+d;const n=i>0?1/i:0,r=s-e-this.m_referenceAngle,a=2*o*this.m_frequencyHz,c=2*n*this.m_dampingRatio*a,l=n*a*a,h=t.step.dt;this.m_gamma=h*(c+h*l),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=r*h*l*this.m_gamma,i+=this.m_gamma,this.m_mass.ez.z=0!==i?1/i:0}else m.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);const e=Hn.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(h,e),n-=u*(xt.CrossVV(this.m_rA,e)+this.m_impulse.z),r.SelfMulAdd(_,e),a+=d*(xt.CrossVV(this.m_rB,e)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=this.m_invMassA,o=this.m_invMassB,a=this.m_invIA,c=this.m_invIB;if(this.m_frequencyHz>0){const t=s-i,l=-this.m_mass.ez.z*(t+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=l,i-=a*l,s+=c*l;const h=xt.SubVV(xt.AddVCrossSV(n,s,this.m_rB,xt.s_t0),xt.AddVCrossSV(e,i,this.m_rA,xt.s_t1),Hn.SolveVelocityConstraints_s_Cdot1),_=bt.MulM33XY(this.m_mass,h.x,h.y,Hn.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=_.x,this.m_impulse.y+=_.y;const u=_;e.SelfMulSub(r,u),i-=a*xt.CrossVV(this.m_rA,u),n.SelfMulAdd(o,u),s+=c*xt.CrossVV(this.m_rB,u)}else{const t=xt.SubVV(xt.AddVCrossSV(n,s,this.m_rB,xt.s_t0),xt.AddVCrossSV(e,i,this.m_rA,xt.s_t1),Hn.SolveVelocityConstraints_s_Cdot1),l=s-i,h=bt.MulM33XYZ(this.m_mass,t.x,t.y,l,Hn.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(h);const _=Hn.SolveVelocityConstraints_s_P.Set(h.x,h.y);e.SelfMulSub(r,_),i-=a*(xt.CrossVV(this.m_rA,_)+h.z),n.SelfMulAdd(o,_),s+=c*(xt.CrossVV(this.m_rB,_)+h.z)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s),a=this.m_invMassA,c=this.m_invMassB,l=this.m_invIA,h=this.m_invIB;xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const d=Tt.MulRV(r,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const m=Tt.MulRV(o,this.m_lalcB,this.m_rB);let p,f;const g=this.m_K;if(g.ex.x=a+c+d.y*d.y*l+m.y*m.y*h,g.ey.x=-d.y*d.x*l-m.y*m.x*h,g.ez.x=-d.y*l-m.y*h,g.ex.y=g.ey.x,g.ey.y=a+c+d.x*d.x*l+m.x*m.x*h,g.ez.y=d.x*l+m.x*h,g.ex.z=g.ez.x,g.ey.z=g.ez.y,g.ez.z=l+h,this.m_frequencyHz>0){const t=xt.SubVV(xt.AddVV(n,m,xt.s_t0),xt.AddVV(e,d,xt.s_t1),Hn.SolvePositionConstraints_s_C1);p=t.Length(),f=0;const r=g.Solve22(t.x,t.y,Hn.SolvePositionConstraints_s_P).SelfNeg();e.SelfMulSub(a,r),i-=l*xt.CrossVV(d,r),n.SelfMulAdd(c,r),s+=h*xt.CrossVV(m,r)}else{const t=xt.SubVV(xt.AddVV(n,m,xt.s_t0),xt.AddVV(e,d,xt.s_t1),Hn.SolvePositionConstraints_s_C1),r=s-i-this.m_referenceAngle;p=t.Length(),f=Q(r);const o=g.Solve33(t.x,t.y,r,Hn.SolvePositionConstraints_s_impulse).SelfNeg(),_=Hn.SolvePositionConstraints_s_P.Set(o.x,o.y);e.SelfMulSub(a,_),i-=l*(xt.CrossVV(this.m_rA,_)+o.z),n.SelfMulAdd(c,_),s+=h*(xt.CrossVV(this.m_rB,_)+o.z)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,p<=_&&f<=u}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Hn.InitVelocityConstraints_s_P=new xt,Hn.SolveVelocityConstraints_s_Cdot1=new xt,Hn.SolveVelocityConstraints_s_impulse1=new xt,Hn.SolveVelocityConstraints_s_impulse=new Ct,Hn.SolveVelocityConstraints_s_P=new xt,Hn.SolvePositionConstraints_s_C1=new xt,Hn.SolvePositionConstraints_s_P=new xt,Hn.SolvePositionConstraints_s_impulse=new Ct;class jn extends yn{constructor(){super(t.b2JointType.e_wheelJoint),this.localAnchorA=new xt(0,0),this.localAnchorB=new xt(0,0),this.localAxisA=new xt(1,0),this.enableMotor=!1,this.maxMotorTorque=0,this.motorSpeed=0,this.frequencyHz=2,this.dampingRatio=.7}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA)}}class Wn extends xn{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_localXAxisA=new xt,this.m_localYAxisA=new xt,this.m_impulse=0,this.m_motorImpulse=0,this.m_springImpulse=0,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableMotor=!1,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_ax=new xt,this.m_ay=new xt,this.m_sAx=0,this.m_sBx=0,this.m_sAy=0,this.m_sBy=0,this.m_mass=0,this.m_motorMass=0,this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_frequencyHz=i(t.frequencyHz,2),this.m_dampingRatio=i(t.dampingRatio,.7),this.m_localAnchorA.Copy(i(t.localAnchorA,xt.ZERO)),this.m_localAnchorB.Copy(i(t.localAnchorB,xt.ZERO)),this.m_localXAxisA.Copy(i(t.localAxisA,xt.UNITX)),xt.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_maxMotorTorque=i(t.maxMotorTorque,0),this.m_motorSpeed=i(t.motorSpeed,0),this.m_enableMotor=i(t.enableMotor,!1),this.m_ax.SetZero(),this.m_ay.SetZero()}GetMotorSpeed(){return this.m_motorSpeed}GetMaxMotorTorque(){return this.m_maxMotorTorque}SetSpringFrequencyHz(t){this.m_frequencyHz=t}GetSpringFrequencyHz(){return this.m_frequencyHz}SetSpringDampingRatio(t){this.m_dampingRatio=t}GetSpringDampingRatio(){return this.m_dampingRatio}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=this.m_invMassA,i=this.m_invMassB,n=this.m_invIA,s=this.m_invIB,r=t.positions[this.m_indexA].c,a=t.positions[this.m_indexA].a,c=t.velocities[this.m_indexA].v;let l=t.velocities[this.m_indexA].w;const h=t.positions[this.m_indexB].c,_=t.positions[this.m_indexB].a,u=t.velocities[this.m_indexB].v;let d=t.velocities[this.m_indexB].w;const m=this.m_qA.SetAngle(a),p=this.m_qB.SetAngle(_);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const f=Tt.MulRV(m,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const g=Tt.MulRV(p,this.m_lalcB,this.m_rB),v=xt.SubVV(xt.AddVV(h,g,xt.s_t0),xt.AddVV(r,f,xt.s_t1),Wn.InitVelocityConstraints_s_d);if(Tt.MulRV(m,this.m_localYAxisA,this.m_ay),this.m_sAy=xt.CrossVV(xt.AddVV(v,f,xt.s_t0),this.m_ay),this.m_sBy=xt.CrossVV(g,this.m_ay),this.m_mass=e+i+n*this.m_sAy*this.m_sAy+s*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){Tt.MulRV(m,this.m_localXAxisA,this.m_ax),this.m_sAx=xt.CrossVV(xt.AddVV(v,f,xt.s_t0),this.m_ax),this.m_sBx=xt.CrossVV(g,this.m_ax);const r=e+i+n*this.m_sAx*this.m_sAx+s*this.m_sBx*this.m_sBx;if(r>0){this.m_springMass=1/r;const e=xt.DotVV(v,this.m_ax),i=2*o*this.m_frequencyHz,n=2*this.m_springMass*this.m_dampingRatio*i,s=this.m_springMass*i*i,a=t.step.dt;this.m_gamma=a*(n+a*s),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=e*a*s*this.m_gamma,this.m_springMass=r+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=n+s,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;const e=xt.AddVV(xt.MulSV(this.m_impulse,this.m_ay,xt.s_t0),xt.MulSV(this.m_springImpulse,this.m_ax,xt.s_t1),Wn.InitVelocityConstraints_s_P),i=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,n=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;c.SelfMulSub(this.m_invMassA,e),l-=this.m_invIA*i,u.SelfMulAdd(this.m_invMassB,e),d+=this.m_invIB*n}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;t.velocities[this.m_indexA].w=l,t.velocities[this.m_indexB].w=d}SolveVelocityConstraints(t){const e=this.m_invMassA,i=this.m_invMassB,n=this.m_invIA,s=this.m_invIB,r=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const a=t.velocities[this.m_indexB].v;let c=t.velocities[this.m_indexB].w;{const t=xt.DotVV(this.m_ax,xt.SubVV(a,r,xt.s_t0))+this.m_sBx*c-this.m_sAx*o,l=-this.m_springMass*(t+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=l;const h=xt.MulSV(l,this.m_ax,Wn.SolveVelocityConstraints_s_P),_=l*this.m_sAx,u=l*this.m_sBx;r.SelfMulSub(e,h),o-=n*_,a.SelfMulAdd(i,h),c+=s*u}{const e=c-o-this.m_motorSpeed;let i=-this.m_motorMass*e;const r=this.m_motorImpulse,a=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=it(this.m_motorImpulse+i,-a,a),i=this.m_motorImpulse-r,o-=n*i,c+=s*i}{const t=xt.DotVV(this.m_ay,xt.SubVV(a,r,xt.s_t0))+this.m_sBy*c-this.m_sAy*o,l=-this.m_mass*t;this.m_impulse+=l;const h=xt.MulSV(l,this.m_ay,Wn.SolveVelocityConstraints_s_P),_=l*this.m_sAy,u=l*this.m_sBy;r.SelfMulSub(e,h),o-=n*_,a.SelfMulAdd(i,h),c+=s*u}t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=c}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const a=Tt.MulRV(r,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const c=Tt.MulRV(o,this.m_lalcB,this.m_rB),l=xt.AddVV(xt.SubVV(n,e,xt.s_t0),xt.SubVV(c,a,xt.s_t1),Wn.SolvePositionConstraints_s_d),h=Tt.MulRV(r,this.m_localYAxisA,this.m_ay),u=xt.CrossVV(xt.AddVV(l,a,xt.s_t0),h),d=xt.CrossVV(c,h),m=xt.DotVV(l,this.m_ay),p=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;let f;f=0!==p?-m/p:0;const g=xt.MulSV(f,h,Wn.SolvePositionConstraints_s_P),v=f*u,y=f*d;return e.SelfMulSub(this.m_invMassA,g),i-=this.m_invIA*v,n.SelfMulAdd(this.m_invMassB,g),s+=this.m_invIB*y,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,Q(m)<=_}GetDefinition(t){return t}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),e}GetReactionTorque(t){return t*this.m_motorImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetJointTranslation(){return this.GetPrismaticJointTranslation()}GetJointLinearSpeed(){return this.GetPrismaticJointSpeed()}GetJointAngle(){return this.GetRevoluteJointAngle()}GetJointAngularSpeed(){return this.GetRevoluteJointSpeed()}GetPrismaticJointTranslation(){const t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchorA,new xt),n=e.GetWorldPoint(this.m_localAnchorB,new xt),s=xt.SubVV(n,i,new xt),r=t.GetWorldVector(this.m_localXAxisA,new xt);return xt.DotVV(s,r)}GetPrismaticJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;xt.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=Tt.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const n=Tt.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),s=xt.AddVV(t.m_sweep.c,i,xt.s_t0),r=xt.AddVV(e.m_sweep.c,n,xt.s_t1),o=xt.SubVV(r,s,xt.s_t2),a=t.GetWorldVector(this.m_localXAxisA,new xt),c=t.m_linearVelocity,l=e.m_linearVelocity,h=t.m_angularVelocity,_=e.m_angularVelocity;return xt.DotVV(o,xt.CrossSV(h,a,xt.s_t0))+xt.DotVV(a,xt.SubVV(xt.AddVCrossSV(l,_,n,xt.s_t0),xt.AddVCrossSV(c,h,i,xt.s_t1),xt.s_t0))}GetRevoluteJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a}GetRevoluteJointSpeed(){const t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMotorTorque(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}function qn(t,e){return at(t*e)}function Xn(t,e){return t>e?t:e}Wn.InitVelocityConstraints_s_d=new xt,Wn.InitVelocityConstraints_s_P=new xt,Wn.SolveVelocityConstraints_s_P=new xt,Wn.SolvePositionConstraints_s_d=new xt,Wn.SolvePositionConstraints_s_P=new xt;class Yn{constructor(t){this._other=null,this.prev=null,this.next=null,this.contact=t}get other(){if(null===this._other)throw new Error;return this._other}set other(t){if(null!==this._other)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class Kn{constructor(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new Yn(this),this.m_nodeB=new Yn(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new pe,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new pe}GetManifold(){return this.m_manifold}GetWorldManifold(t){const e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),n=this.GetShapeA(),s=this.GetShapeB();t.Initialize(this.m_manifold,e.GetTransform(),n.m_radius,i.GetTransform(),s.m_radius)}IsTouching(){return this.m_touchingFlag}SetEnabled(t){this.m_enabledFlag=t}IsEnabled(){return this.m_enabledFlag}GetNext(){return this.m_next}GetFixtureA(){return this.m_fixtureA}GetChildIndexA(){return this.m_indexA}GetShapeA(){return this.m_fixtureA.GetShape()}GetFixtureB(){return this.m_fixtureB}GetChildIndexB(){return this.m_indexB}GetShapeB(){return this.m_fixtureB.GetShape()}FlagForFiltering(){this.m_filterFlag=!0}SetFriction(t){this.m_friction=t}GetFriction(){return this.m_friction}ResetFriction(){this.m_friction=qn(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)}SetRestitution(t){this.m_restitution=t}GetRestitution(){return this.m_restitution}ResetRestitution(){this.m_restitution=Xn(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}SetTangentSpeed(t){this.m_tangentSpeed=t}GetTangentSpeed(){return this.m_tangentSpeed}Reset(t,e,i,n){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=n,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=qn(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=Xn(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}Update(t){const e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;let i=!1;const n=this.m_touchingFlag,s=this.m_fixtureA.IsSensor(),r=this.m_fixtureB.IsSensor(),o=s||r,a=this.m_fixtureA.GetBody(),c=this.m_fixtureB.GetBody(),l=a.GetTransform(),h=c.GetTransform();if(o){const t=this.GetShapeA(),e=this.GetShapeB();i=Pe(t,this.m_indexA,e,this.m_indexB,l,h),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,l,h),i=this.m_manifold.pointCount>0;for(let t=0;t<this.m_manifold.pointCount;++t){const e=this.m_manifold.points[t];e.normalImpulse=0,e.tangentImpulse=0;const i=e.id;for(let t=0;t<this.m_oldManifold.pointCount;++t){const n=this.m_oldManifold.points[t];if(n.id.key===i.key){e.normalImpulse=n.normalImpulse,e.tangentImpulse=n.tangentImpulse;break}}}i!==n&&(a.SetAwake(!0),c.SetAwake(!0))}this.m_touchingFlag=i,!n&&i&&t&&t.BeginContact(this),n&&!i&&t&&t.EndContact(this),!o&&i&&t&&t.PreSolve(this,this.m_oldManifold)}ComputeTOI(t,e){const i=Kn.ComputeTOI_s_input;i.proxyA.SetShape(this.GetShapeA(),this.m_indexA),i.proxyB.SetShape(this.GetShapeB(),this.m_indexB),i.sweepA.Copy(t),i.sweepB.Copy(e),i.tMax=_;const n=Kn.ComputeTOI_s_output;return ri(n,i),n.t}}Kn.ComputeTOI_s_input=new We,Kn.ComputeTOI_s_output=new Ye;class Jn extends Kn{static Create(){return new Jn}static Destroy(t){}Evaluate(t,e,i){ci(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class $n extends Kn{static Create(){return new $n}static Destroy(t){}Evaluate(t,e,i){Li(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class Zn extends Kn{static Create(){return new Zn}static Destroy(t){}Evaluate(t,e,i){ui(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class Qn extends Kn{static Create(){return new Qn}static Destroy(t){}Evaluate(t,e,i){Wi(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class ts extends Kn{static Create(){return new ts}static Destroy(t){}Evaluate(t,e,i){Qi(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class es extends Kn{static Create(){return new es}static Destroy(t){}Evaluate(t,e,i){const n=es.Evaluate_s_edge;this.GetShapeA().GetChildEdge(n,this.m_indexA),Wi(t,n,e,this.GetShapeB(),i)}}es.Evaluate_s_edge=new ln;class is extends Kn{static Create(){return new is}static Destroy(t){}Evaluate(t,e,i){const n=is.Evaluate_s_edge;this.GetShapeA().GetChildEdge(n,this.m_indexA),Qi(t,n,e,this.GetShapeB(),i)}}is.Evaluate_s_edge=new ln;class ns{constructor(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1}}class ss{constructor(){this.m_registers=[],this.InitializeRegisters()}AddType(t,e,i,n){const s=[];function r(){return s.pop()||t()}function o(t){s.push(t)}this.m_registers[i][n].pool=s,this.m_registers[i][n].createFcn=r,this.m_registers[i][n].destroyFcn=o,this.m_registers[i][n].primary=!0,i!==n&&(this.m_registers[n][i].pool=s,this.m_registers[n][i].createFcn=r,this.m_registers[n][i].destroyFcn=o,this.m_registers[n][i].primary=!1)}InitializeRegisters(){for(let e=0;e<t.b2ShapeType.e_shapeTypeCount;e++){this.m_registers[e]=[];for(let i=0;i<t.b2ShapeType.e_shapeTypeCount;i++)this.m_registers[e][i]=new ns}this.AddType(Jn.Create,Jn.Destroy,t.b2ShapeType.e_circleShape,t.b2ShapeType.e_circleShape),this.AddType(Zn.Create,Zn.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_circleShape),this.AddType($n.Create,$n.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_polygonShape),this.AddType(Qn.Create,Qn.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_circleShape),this.AddType(ts.Create,ts.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_polygonShape),this.AddType(es.Create,es.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_circleShape),this.AddType(is.Create,is.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_polygonShape)}Create(t,e,i,n){const s=t.GetType(),r=i.GetType(),o=this.m_registers[s][r];if(o.createFcn){const s=o.createFcn();return o.primary?s.Reset(t,e,i,n):s.Reset(i,n,t,e),s}return null}Destroy(t){const e=t.m_fixtureA.GetType(),i=t.m_fixtureB.GetType(),n=this.m_registers[e][i];n.destroyFcn&&n.destroyFcn(t)}}class rs{SayGoodbyeJoint(t){}SayGoodbyeFixture(t){}SayGoodbyeParticleGroup(t){}SayGoodbyeParticle(t,e){}}class os{ShouldCollide(e,i){const n=e.GetBody(),s=i.GetBody();if(s.GetType()===t.b2BodyType.b2_staticBody&&n.GetType()===t.b2BodyType.b2_staticBody)return!1;if(!s.ShouldCollideConnected(n))return!1;const r=e.GetFilterData(),o=i.GetFilterData();return r.groupIndex===o.groupIndex&&0!==r.groupIndex?r.groupIndex>0:0!=(r.maskBits&o.categoryBits)&&0!=(r.categoryBits&o.maskBits)}ShouldCollideFixtureParticle(t,e,i){return!0}ShouldCollideParticleParticle(t,e,i){return!0}}os.b2_defaultFilter=new os;class as{constructor(){this.normalImpulses=K(a),this.tangentImpulses=K(a),this.count=0}}class cs{BeginContact(t){}EndContact(t){}BeginContactFixtureParticle(t,e){}EndContactFixtureParticle(t,e){}BeginContactParticleParticle(t,e){}EndContactParticleParticle(t,e){}PreSolve(t,e){}PostSolve(t,e){}}cs.b2_defaultListener=new cs;class ls{ReportFixture(t){return!0}ReportParticle(t,e){return!1}ShouldQueryParticleSystem(t){return!0}}class hs{ReportFixture(t,e,i,n){return n}ReportParticle(t,e,i,n,s){return 0}ShouldQueryParticleSystem(t){return!0}}class _s{constructor(){this.m_broadPhase=new Ne,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=os.b2_defaultFilter,this.m_contactListener=cs.b2_defaultListener,this.m_contactFactory=new ss}AddPair(t,e){let i=t.fixture,n=e.fixture,s=t.childIndex,r=e.childIndex,o=i.GetBody(),a=n.GetBody();if(o===a)return;let c=a.GetContactList();for(;c;){if(c.other===o){const t=c.contact.GetFixtureA(),e=c.contact.GetFixtureB(),o=c.contact.GetChildIndexA(),a=c.contact.GetChildIndexB();if(t===i&&e===n&&o===s&&a===r)return;if(t===n&&e===i&&o===r&&a===s)return}c=c.next}if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,n))return;const l=this.m_contactFactory.Create(i,s,n,r);null!==l&&(i=l.GetFixtureA(),n=l.GetFixtureB(),s=l.GetChildIndexA(),r=l.GetChildIndexB(),o=i.m_body,a=n.m_body,l.m_prev=null,l.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=l),this.m_contactList=l,l.m_nodeA.other=a,l.m_nodeA.prev=null,l.m_nodeA.next=o.m_contactList,null!==o.m_contactList&&(o.m_contactList.prev=l.m_nodeA),o.m_contactList=l.m_nodeA,l.m_nodeB.other=o,l.m_nodeB.prev=null,l.m_nodeB.next=a.m_contactList,null!==a.m_contactList&&(a.m_contactList.prev=l.m_nodeB),a.m_contactList=l.m_nodeB,i.IsSensor()||n.IsSensor()||(o.SetAwake(!0),a.SetAwake(!0)),++this.m_contactCount)}FindNewContacts(){this.m_broadPhase.UpdatePairs(((t,e)=>{this.AddPair(t,e)}))}Destroy(t){const e=t.GetFixtureA(),i=t.GetFixtureB(),n=e.GetBody(),s=i.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===n.m_contactList&&(n.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===s.m_contactList&&(s.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(t),--this.m_contactCount}Collide(){let e=this.m_contactList;for(;e;){const i=e.GetFixtureA(),n=e.GetFixtureB(),s=e.GetChildIndexA(),r=e.GetChildIndexB(),o=i.GetBody(),a=n.GetBody();if(e.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,n)){const t=e;e=t.m_next,this.Destroy(t);continue}e.m_filterFlag=!1}const c=o.IsAwake()&&o.m_type!==t.b2BodyType.b2_staticBody,l=a.IsAwake()&&a.m_type!==t.b2BodyType.b2_staticBody;if(!c&&!l){e=e.m_next;continue}const h=i.m_proxies[s].treeNode,_=n.m_proxies[r].treeNode;if(Ce(h.aabb,_.aabb))e.Update(this.m_contactListener),e=e.m_next;else{const t=e;e=t.m_next,this.Destroy(t)}}}}class us{constructor(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}Reset(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this}}class ds{constructor(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}Copy(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this}}class ms{constructor(){this.c=new xt,this.a=0}static MakeArray(t){return X(t,(()=>new ms))}}class ps{constructor(){this.v=new xt,this.w=0}static MakeArray(t){return X(t,(()=>new ps))}}class fs{constructor(){this.step=new ds}}let gs=!1;class vs{constructor(){this.rA=new xt,this.rB=new xt,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}static MakeArray(t){return X(t,(()=>new vs))}}class ys{constructor(){this.points=vs.MakeArray(a),this.normal=new xt,this.tangent=new xt,this.normalMass=new At,this.K=new At,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}static MakeArray(t){return X(t,(()=>new ys))}}class xs{constructor(){this.localPoints=xt.MakeArray(a),this.localNormal=new xt,this.localPoint=new xt,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new xt,this.localCenterB=new xt,this.invIA=0,this.invIB=0,this.type=t.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}static MakeArray(t){return X(t,(()=>new xs))}}class Ss{constructor(){this.step=new ds,this.count=0}}class Cs{constructor(){this.normal=new xt,this.point=new xt,this.separation=0}Initialize(e,i,n,s){const r=Cs.Initialize_s_pointA,o=Cs.Initialize_s_pointB,a=Cs.Initialize_s_planePoint,c=Cs.Initialize_s_clipPoint;switch(e.type){case t.b2ManifoldType.e_circles:Et.MulXV(i,e.localPoint,r),Et.MulXV(n,e.localPoints[0],o),xt.SubVV(o,r,this.normal).SelfNormalize(),xt.MidVV(r,o,this.point),this.separation=xt.DotVV(xt.SubVV(o,r,xt.s_t0),this.normal)-e.radiusA-e.radiusB;break;case t.b2ManifoldType.e_faceA:Tt.MulRV(i.q,e.localNormal,this.normal),Et.MulXV(i,e.localPoint,a),Et.MulXV(n,e.localPoints[s],c),this.separation=xt.DotVV(xt.SubVV(c,a,xt.s_t0),this.normal)-e.radiusA-e.radiusB,this.point.Copy(c);break;case t.b2ManifoldType.e_faceB:Tt.MulRV(n.q,e.localNormal,this.normal),Et.MulXV(n,e.localPoint,a),Et.MulXV(i,e.localPoints[s],c),this.separation=xt.DotVV(xt.SubVV(c,a,xt.s_t0),this.normal)-e.radiusA-e.radiusB,this.point.Copy(c),this.normal.SelfNeg()}}}Cs.Initialize_s_pointA=new xt,Cs.Initialize_s_pointB=new xt,Cs.Initialize_s_planePoint=new xt,Cs.Initialize_s_clipPoint=new xt;class As{constructor(){this.m_step=new ds,this.m_positionConstraints=xs.MakeArray(1024),this.m_velocityConstraints=ys.MakeArray(1024),this.m_count=0}Initialize(t){if(this.m_step.Copy(t.step),this.m_count=t.count,this.m_positionConstraints.length<this.m_count){const t=et(2*this.m_positionConstraints.length,this.m_count);for(;this.m_positionConstraints.length<t;)this.m_positionConstraints[this.m_positionConstraints.length]=new xs}if(this.m_velocityConstraints.length<this.m_count){const t=et(2*this.m_velocityConstraints.length,this.m_count);for(;this.m_velocityConstraints.length<t;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new ys}this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(let t=0;t<this.m_count;++t){const e=this.m_contacts[t],i=e.m_fixtureA,n=e.m_fixtureB,s=i.GetShape(),r=n.GetShape(),o=s.m_radius,a=r.m_radius,c=i.GetBody(),l=n.GetBody(),h=e.GetManifold(),_=h.pointCount,u=this.m_velocityConstraints[t];u.friction=e.m_friction,u.restitution=e.m_restitution,u.tangentSpeed=e.m_tangentSpeed,u.indexA=c.m_islandIndex,u.indexB=l.m_islandIndex,u.invMassA=c.m_invMass,u.invMassB=l.m_invMass,u.invIA=c.m_invI,u.invIB=l.m_invI,u.contactIndex=t,u.pointCount=_,u.K.SetZero(),u.normalMass.SetZero();const d=this.m_positionConstraints[t];d.indexA=c.m_islandIndex,d.indexB=l.m_islandIndex,d.invMassA=c.m_invMass,d.invMassB=l.m_invMass,d.localCenterA.Copy(c.m_sweep.localCenter),d.localCenterB.Copy(l.m_sweep.localCenter),d.invIA=c.m_invI,d.invIB=l.m_invI,d.localNormal.Copy(h.localNormal),d.localPoint.Copy(h.localPoint),d.pointCount=_,d.radiusA=o,d.radiusB=a,d.type=h.type;for(let t=0;t<_;++t){const e=h.points[t],i=u.points[t];this.m_step.warmStarting?(i.normalImpulse=this.m_step.dtRatio*e.normalImpulse,i.tangentImpulse=this.m_step.dtRatio*e.tangentImpulse):(i.normalImpulse=0,i.tangentImpulse=0),i.rA.SetZero(),i.rB.SetZero(),i.normalMass=0,i.tangentMass=0,i.velocityBias=0,d.localPoints[t].Copy(e.localPoint)}}return this}InitializeVelocityConstraints(){const t=As.InitializeVelocityConstraints_s_xfA,e=As.InitializeVelocityConstraints_s_xfB,i=As.InitializeVelocityConstraints_s_worldManifold,n=1e3;for(let s=0;s<this.m_count;++s){const r=this.m_velocityConstraints[s],o=this.m_positionConstraints[s],a=o.radiusA,c=o.radiusB,l=this.m_contacts[r.contactIndex].GetManifold(),h=r.indexA,_=r.indexB,u=r.invMassA,d=r.invMassB,m=r.invIA,p=r.invIB,g=o.localCenterA,v=o.localCenterB,y=this.m_positions[h].c,x=this.m_positions[h].a,S=this.m_velocities[h].v,C=this.m_velocities[h].w,A=this.m_positions[_].c,b=this.m_positions[_].a,T=this.m_velocities[_].v,E=this.m_velocities[_].w;t.q.SetAngle(x),e.q.SetAngle(b),xt.SubVV(y,Tt.MulRV(t.q,g,xt.s_t0),t.p),xt.SubVV(A,Tt.MulRV(e.q,v,xt.s_t0),e.p),i.Initialize(l,t,a,e,c),r.normal.Copy(i.normal),xt.CrossVOne(r.normal,r.tangent);const P=r.pointCount;for(let t=0;t<P;++t){const e=r.points[t];xt.SubVV(i.points[t],y,e.rA),xt.SubVV(i.points[t],A,e.rB);const n=xt.CrossVV(e.rA,r.normal),s=xt.CrossVV(e.rB,r.normal),o=u+d+m*n*n+p*s*s;e.normalMass=o>0?1/o:0;const a=r.tangent,c=xt.CrossVV(e.rA,a),l=xt.CrossVV(e.rB,a),h=u+d+m*c*c+p*l*l;e.tangentMass=h>0?1/h:0,e.velocityBias=0;const _=xt.DotVV(r.normal,xt.SubVV(xt.AddVCrossSV(T,E,e.rB,xt.s_t0),xt.AddVCrossSV(S,C,e.rA,xt.s_t1),xt.s_t0));_<-f&&(e.velocityBias+=-r.restitution*_)}if(2===r.pointCount&&gs){const t=r.points[0],e=r.points[1],i=xt.CrossVV(t.rA,r.normal),s=xt.CrossVV(t.rB,r.normal),o=xt.CrossVV(e.rA,r.normal),a=xt.CrossVV(e.rB,r.normal),c=u+d+m*i*i+p*s*s,l=u+d+m*o*o+p*a*a,h=u+d+m*i*o+p*s*a;c*c<n*(c*l-h*h)?(r.K.ex.Set(c,h),r.K.ey.Set(h,l),r.K.GetInverse(r.normalMass)):r.pointCount=1}}}WarmStart(){const t=As.WarmStart_s_P;for(let e=0;e<this.m_count;++e){const i=this.m_velocityConstraints[e],n=i.indexA,s=i.indexB,r=i.invMassA,o=i.invIA,a=i.invMassB,c=i.invIB,l=i.pointCount,h=this.m_velocities[n].v;let _=this.m_velocities[n].w;const u=this.m_velocities[s].v;let d=this.m_velocities[s].w;const m=i.normal,p=i.tangent;for(let e=0;e<l;++e){const n=i.points[e];xt.AddVV(xt.MulSV(n.normalImpulse,m,xt.s_t0),xt.MulSV(n.tangentImpulse,p,xt.s_t1),t),_-=o*xt.CrossVV(n.rA,t),h.SelfMulSub(r,t),d+=c*xt.CrossVV(n.rB,t),u.SelfMulAdd(a,t)}this.m_velocities[n].w=_,this.m_velocities[s].w=d}}SolveVelocityConstraints(){const t=As.SolveVelocityConstraints_s_dv,e=As.SolveVelocityConstraints_s_dv1,i=As.SolveVelocityConstraints_s_dv2,n=As.SolveVelocityConstraints_s_P,s=As.SolveVelocityConstraints_s_a,r=As.SolveVelocityConstraints_s_b,o=As.SolveVelocityConstraints_s_x,a=As.SolveVelocityConstraints_s_d,c=As.SolveVelocityConstraints_s_P1,l=As.SolveVelocityConstraints_s_P2,h=As.SolveVelocityConstraints_s_P1P2;for(let _=0;_<this.m_count;++_){const u=this.m_velocityConstraints[_],d=u.indexA,m=u.indexB,p=u.invMassA,f=u.invIA,g=u.invMassB,v=u.invIB,y=u.pointCount,x=this.m_velocities[d].v;let S=this.m_velocities[d].w;const C=this.m_velocities[m].v;let A=this.m_velocities[m].w;const b=u.normal,T=u.tangent,E=u.friction;for(let e=0;e<y;++e){const i=u.points[e];xt.SubVV(xt.AddVCrossSV(C,A,i.rB,xt.s_t0),xt.AddVCrossSV(x,S,i.rA,xt.s_t1),t);const s=xt.DotVV(t,T)-u.tangentSpeed;let r=i.tangentMass*-s;const o=E*i.normalImpulse,a=it(i.tangentImpulse+r,-o,o);r=a-i.tangentImpulse,i.tangentImpulse=a,xt.MulSV(r,T,n),x.SelfMulSub(p,n),S-=f*xt.CrossVV(i.rA,n),C.SelfMulAdd(g,n),A+=v*xt.CrossVV(i.rB,n)}if(1===u.pointCount||!1===gs)for(let e=0;e<y;++e){const i=u.points[e];xt.SubVV(xt.AddVCrossSV(C,A,i.rB,xt.s_t0),xt.AddVCrossSV(x,S,i.rA,xt.s_t1),t);const s=xt.DotVV(t,b);let r=-i.normalMass*(s-i.velocityBias);const o=et(i.normalImpulse+r,0);r=o-i.normalImpulse,i.normalImpulse=o,xt.MulSV(r,b,n),x.SelfMulSub(p,n),S-=f*xt.CrossVV(i.rA,n),C.SelfMulAdd(g,n),A+=v*xt.CrossVV(i.rB,n)}else{const t=u.points[0],n=u.points[1];s.Set(t.normalImpulse,n.normalImpulse),xt.SubVV(xt.AddVCrossSV(C,A,t.rB,xt.s_t0),xt.AddVCrossSV(x,S,t.rA,xt.s_t1),e),xt.SubVV(xt.AddVCrossSV(C,A,n.rB,xt.s_t0),xt.AddVCrossSV(x,S,n.rA,xt.s_t1),i);let _=xt.DotVV(e,b),d=xt.DotVV(i,b);for(r.x=_-t.velocityBias,r.y=d-n.velocityBias,r.SelfSub(At.MulMV(u.K,s,xt.s_t0));;){if(At.MulMV(u.normalMass,r,o).SelfNeg(),o.x>=0&&o.y>=0){xt.SubVV(o,s,a),xt.MulSV(a.x,b,c),xt.MulSV(a.y,b,l),xt.AddVV(c,l,h),x.SelfMulSub(p,h),S-=f*(xt.CrossVV(t.rA,c)+xt.CrossVV(n.rA,l)),C.SelfMulAdd(g,h),A+=v*(xt.CrossVV(t.rB,c)+xt.CrossVV(n.rB,l)),t.normalImpulse=o.x,n.normalImpulse=o.y;break}if(o.x=-t.normalMass*r.x,o.y=0,_=0,d=u.K.ex.y*o.x+r.y,o.x>=0&&d>=0){xt.SubVV(o,s,a),xt.MulSV(a.x,b,c),xt.MulSV(a.y,b,l),xt.AddVV(c,l,h),x.SelfMulSub(p,h),S-=f*(xt.CrossVV(t.rA,c)+xt.CrossVV(n.rA,l)),C.SelfMulAdd(g,h),A+=v*(xt.CrossVV(t.rB,c)+xt.CrossVV(n.rB,l)),t.normalImpulse=o.x,n.normalImpulse=o.y;break}if(o.x=0,o.y=-n.normalMass*r.y,_=u.K.ey.x*o.y+r.x,d=0,o.y>=0&&_>=0){xt.SubVV(o,s,a),xt.MulSV(a.x,b,c),xt.MulSV(a.y,b,l),xt.AddVV(c,l,h),x.SelfMulSub(p,h),S-=f*(xt.CrossVV(t.rA,c)+xt.CrossVV(n.rA,l)),C.SelfMulAdd(g,h),A+=v*(xt.CrossVV(t.rB,c)+xt.CrossVV(n.rB,l)),t.normalImpulse=o.x,n.normalImpulse=o.y;break}if(o.x=0,o.y=0,_=r.x,d=r.y,_>=0&&d>=0){xt.SubVV(o,s,a),xt.MulSV(a.x,b,c),xt.MulSV(a.y,b,l),xt.AddVV(c,l,h),x.SelfMulSub(p,h),S-=f*(xt.CrossVV(t.rA,c)+xt.CrossVV(n.rA,l)),C.SelfMulAdd(g,h),A+=v*(xt.CrossVV(t.rB,c)+xt.CrossVV(n.rB,l)),t.normalImpulse=o.x,n.normalImpulse=o.y;break}break}}this.m_velocities[d].w=S,this.m_velocities[m].w=A}}StoreImpulses(){for(let t=0;t<this.m_count;++t){const e=this.m_velocityConstraints[t],i=this.m_contacts[e.contactIndex].GetManifold();for(let t=0;t<e.pointCount;++t)i.points[t].normalImpulse=e.points[t].normalImpulse,i.points[t].tangentImpulse=e.points[t].tangentImpulse}}SolvePositionConstraints(){const t=As.SolvePositionConstraints_s_xfA,e=As.SolvePositionConstraints_s_xfB,i=As.SolvePositionConstraints_s_psm,n=As.SolvePositionConstraints_s_rA,s=As.SolvePositionConstraints_s_rB,r=As.SolvePositionConstraints_s_P;let o=0;for(let a=0;a<this.m_count;++a){const c=this.m_positionConstraints[a],l=c.indexA,h=c.indexB,u=c.localCenterA,d=c.invMassA,m=c.invIA,p=c.localCenterB,f=c.invMassB,v=c.invIB,y=c.pointCount,x=this.m_positions[l].c;let S=this.m_positions[l].a;const C=this.m_positions[h].c;let b=this.m_positions[h].a;for(let a=0;a<y;++a){t.q.SetAngle(S),e.q.SetAngle(b),xt.SubVV(x,Tt.MulRV(t.q,u,xt.s_t0),t.p),xt.SubVV(C,Tt.MulRV(e.q,p,xt.s_t0),e.p),i.Initialize(c,t,e,a);const l=i.normal,h=i.point,y=i.separation;xt.SubVV(h,x,n),xt.SubVV(h,C,s),o=tt(o,y);const T=it(A*(y+_),-g,0),E=xt.CrossVV(n,l),P=xt.CrossVV(s,l),w=d+f+m*E*E+v*P*P,I=w>0?-T/w:0;xt.MulSV(I,l,r),x.SelfMulSub(d,r),S-=m*xt.CrossVV(n,r),C.SelfMulAdd(f,r),b+=v*xt.CrossVV(s,r)}this.m_positions[l].a=S,this.m_positions[h].a=b}return o>-3*_}SolveTOIPositionConstraints(t,e){const i=As.SolveTOIPositionConstraints_s_xfA,n=As.SolveTOIPositionConstraints_s_xfB,s=As.SolveTOIPositionConstraints_s_psm,r=As.SolveTOIPositionConstraints_s_rA,o=As.SolveTOIPositionConstraints_s_rB,a=As.SolveTOIPositionConstraints_s_P;let c=0;for(let l=0;l<this.m_count;++l){const h=this.m_positionConstraints[l],u=h.indexA,d=h.indexB,m=h.localCenterA,p=h.localCenterB,f=h.pointCount;let v=0,y=0;u!==t&&u!==e||(v=h.invMassA,y=h.invIA);let x=0,S=0;d!==t&&d!==e||(x=h.invMassB,S=h.invIB);const C=this.m_positions[u].c;let A=this.m_positions[u].a;const T=this.m_positions[d].c;let E=this.m_positions[d].a;for(let t=0;t<f;++t){i.q.SetAngle(A),n.q.SetAngle(E),xt.SubVV(C,Tt.MulRV(i.q,m,xt.s_t0),i.p),xt.SubVV(T,Tt.MulRV(n.q,p,xt.s_t0),n.p),s.Initialize(h,i,n,t);const e=s.normal,l=s.point,u=s.separation;xt.SubVV(l,C,r),xt.SubVV(l,T,o),c=tt(c,u);const d=it(b*(u+_),-g,0),f=xt.CrossVV(r,e),P=xt.CrossVV(o,e),w=v+x+y*f*f+S*P*P,I=w>0?-d/w:0;xt.MulSV(I,e,a),C.SelfMulSub(v,a),A-=y*xt.CrossVV(r,a),T.SelfMulAdd(x,a),E+=S*xt.CrossVV(o,a)}this.m_positions[u].a=A,this.m_positions[d].a=E}return c>=-1.5*_}}As.InitializeVelocityConstraints_s_xfA=new Et,As.InitializeVelocityConstraints_s_xfB=new Et,As.InitializeVelocityConstraints_s_worldManifold=new fe,As.WarmStart_s_P=new xt,As.SolveVelocityConstraints_s_dv=new xt,As.SolveVelocityConstraints_s_dv1=new xt,As.SolveVelocityConstraints_s_dv2=new xt,As.SolveVelocityConstraints_s_P=new xt,As.SolveVelocityConstraints_s_a=new xt,As.SolveVelocityConstraints_s_b=new xt,As.SolveVelocityConstraints_s_x=new xt,As.SolveVelocityConstraints_s_d=new xt,As.SolveVelocityConstraints_s_P1=new xt,As.SolveVelocityConstraints_s_P2=new xt,As.SolveVelocityConstraints_s_P1P2=new xt,As.SolvePositionConstraints_s_xfA=new Et,As.SolvePositionConstraints_s_xfB=new Et,As.SolvePositionConstraints_s_psm=new Cs,As.SolvePositionConstraints_s_rA=new xt,As.SolvePositionConstraints_s_rB=new xt,As.SolvePositionConstraints_s_P=new xt,As.SolveTOIPositionConstraints_s_xfA=new Et,As.SolveTOIPositionConstraints_s_xfB=new Et,As.SolveTOIPositionConstraints_s_psm=new Cs,As.SolveTOIPositionConstraints_s_rA=new xt,As.SolveTOIPositionConstraints_s_rB=new xt,As.SolveTOIPositionConstraints_s_P=new xt;class bs{constructor(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=ms.MakeArray(1024),this.m_velocities=ps.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}Initialize(t,e,i,n){if(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=n,this.m_positions.length<t){const e=et(2*this.m_positions.length,t);for(;this.m_positions.length<e;)this.m_positions[this.m_positions.length]=new ms}if(this.m_velocities.length<t){const e=et(2*this.m_velocities.length,t);for(;this.m_velocities.length<e;)this.m_velocities[this.m_velocities.length]=new ps}}Clear(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0}AddBody(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t}AddContact(t){this.m_contacts[this.m_contactCount++]=t}AddJoint(t){this.m_joints[this.m_jointCount++]=t}Solve(e,i,s,r){const o=bs.s_timer.Reset(),a=i.dt;for(let e=0;e<this.m_bodyCount;++e){const i=this.m_bodies[e];this.m_positions[e].c.Copy(i.m_sweep.c);const n=i.m_sweep.a,r=this.m_velocities[e].v.Copy(i.m_linearVelocity);let o=i.m_angularVelocity;i.m_sweep.c0.Copy(i.m_sweep.c),i.m_sweep.a0=i.m_sweep.a,i.m_type===t.b2BodyType.b2_dynamicBody&&(r.x+=a*(i.m_gravityScale*s.x+i.m_invMass*i.m_force.x),r.y+=a*(i.m_gravityScale*s.y+i.m_invMass*i.m_force.y),o+=a*i.m_invI*i.m_torque,r.SelfMul(1/(1+a*i.m_linearDamping)),o*=1/(1+a*i.m_angularDamping)),this.m_positions[e].a=n,this.m_velocities[e].w=o}o.Reset();const c=bs.s_solverData;c.step.Copy(i),c.positions=this.m_positions,c.velocities=this.m_velocities;const l=bs.s_contactSolverDef;l.step.Copy(i),l.contacts=this.m_contacts,l.count=this.m_contactCount,l.positions=this.m_positions,l.velocities=this.m_velocities;const h=bs.s_contactSolver.Initialize(l);h.InitializeVelocityConstraints(),i.warmStarting&&h.WarmStart();for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].InitVelocityConstraints(c);e.solveInit=o.GetMilliseconds(),o.Reset();for(let t=0;t<i.velocityIterations;++t){for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].SolveVelocityConstraints(c);h.SolveVelocityConstraints()}h.StoreImpulses(),e.solveVelocity=o.GetMilliseconds();for(let t=0;t<this.m_bodyCount;++t){const e=this.m_positions[t].c;let i=this.m_positions[t].a;const n=this.m_velocities[t].v;let s=this.m_velocities[t].w;const r=xt.MulSV(a,n,bs.s_translation);if(xt.DotVV(r,r)>x){const t=y/r.Length();n.SelfMul(t)}const o=a*s;o*o>C&&(s*=S/Q(o)),e.x+=a*n.x,e.y+=a*n.y,i+=a*s,this.m_positions[t].a=i,this.m_velocities[t].w=s}o.Reset();let _=!1;for(let t=0;t<i.positionIterations;++t){const t=h.SolvePositionConstraints();let e=!0;for(let t=0;t<this.m_jointCount;++t){const i=this.m_joints[t].SolvePositionConstraints(c);e=e&&i}if(t&&e){_=!0;break}}for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];e.m_sweep.c.Copy(this.m_positions[t].c),e.m_sweep.a=this.m_positions[t].a,e.m_linearVelocity.Copy(this.m_velocities[t].v),e.m_angularVelocity=this.m_velocities[t].w,e.SynchronizeTransform()}if(e.solvePosition=o.GetMilliseconds(),this.Report(h.m_velocityConstraints),r){let e=n;const i=L*L,s=F*F;for(let n=0;n<this.m_bodyCount;++n){const r=this.m_bodies[n];r.GetType()!==t.b2BodyType.b2_staticBody&&(!r.m_autoSleepFlag||r.m_angularVelocity*r.m_angularVelocity>s||xt.DotVV(r.m_linearVelocity,r.m_linearVelocity)>i?(r.m_sleepTime=0,e=0):(r.m_sleepTime+=a,e=tt(e,r.m_sleepTime)))}if(e>=N&&_)for(let t=0;t<this.m_bodyCount;++t)this.m_bodies[t].SetAwake(!1)}}SolveTOI(t,e,i){for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];this.m_positions[t].c.Copy(e.m_sweep.c),this.m_positions[t].a=e.m_sweep.a,this.m_velocities[t].v.Copy(e.m_linearVelocity),this.m_velocities[t].w=e.m_angularVelocity}const n=bs.s_contactSolverDef;n.contacts=this.m_contacts,n.count=this.m_contactCount,n.step.Copy(t),n.positions=this.m_positions,n.velocities=this.m_velocities;const s=bs.s_contactSolver.Initialize(n);for(let n=0;n<t.positionIterations&&!s.SolveTOIPositionConstraints(e,i);++n);this.m_bodies[e].m_sweep.c0.Copy(this.m_positions[e].c),this.m_bodies[e].m_sweep.a0=this.m_positions[e].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,s.InitializeVelocityConstraints();for(let e=0;e<t.velocityIterations;++e)s.SolveVelocityConstraints();const r=t.dt;for(let t=0;t<this.m_bodyCount;++t){const e=this.m_positions[t].c;let i=this.m_positions[t].a;const n=this.m_velocities[t].v;let s=this.m_velocities[t].w;const o=xt.MulSV(r,n,bs.s_translation);if(xt.DotVV(o,o)>x){const t=y/o.Length();n.SelfMul(t)}const a=r*s;a*a>C&&(s*=S/Q(a)),e.SelfMulAdd(r,n),i+=r*s,this.m_positions[t].a=i,this.m_velocities[t].w=s;const c=this.m_bodies[t];c.m_sweep.c.Copy(e),c.m_sweep.a=i,c.m_linearVelocity.Copy(n),c.m_angularVelocity=s,c.SynchronizeTransform()}this.Report(s.m_velocityConstraints)}Report(t){if(null!==this.m_listener)for(let e=0;e<this.m_contactCount;++e){const i=this.m_contacts[e];if(!i)continue;const n=t[e],s=bs.s_impulse;s.count=n.pointCount;for(let t=0;t<n.pointCount;++t)s.normalImpulses[t]=n.points[t].normalImpulse,s.tangentImpulses[t]=n.points[t].tangentImpulse;this.m_listener.PostSolve(i,s)}}}var Ts,Es;bs.s_timer=new Dt,bs.s_solverData=new fs,bs.s_contactSolverDef=new Ss,bs.s_contactSolver=new As,bs.s_translation=new xt,bs.s_impulse=new as,(Ts=t.b2ParticleFlag||(t.b2ParticleFlag={}))[Ts.b2_waterParticle=0]="b2_waterParticle",Ts[Ts.b2_zombieParticle=2]="b2_zombieParticle",Ts[Ts.b2_wallParticle=4]="b2_wallParticle",Ts[Ts.b2_springParticle=8]="b2_springParticle",Ts[Ts.b2_elasticParticle=16]="b2_elasticParticle",Ts[Ts.b2_viscousParticle=32]="b2_viscousParticle",Ts[Ts.b2_powderParticle=64]="b2_powderParticle",Ts[Ts.b2_tensileParticle=128]="b2_tensileParticle",Ts[Ts.b2_colorMixingParticle=256]="b2_colorMixingParticle",Ts[Ts.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",Ts[Ts.b2_barrierParticle=1024]="b2_barrierParticle",Ts[Ts.b2_staticPressureParticle=2048]="b2_staticPressureParticle",Ts[Ts.b2_reactiveParticle=4096]="b2_reactiveParticle",Ts[Ts.b2_repulsiveParticle=8192]="b2_repulsiveParticle",Ts[Ts.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",Ts[Ts.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",Ts[Ts.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",Ts[Ts.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle";class Ps{constructor(){this.flags=0,this.position=new xt,this.velocity=new xt,this.color=new wt(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null}}function ws(t,e,i){const n=8,s=.01;return it(Math.ceil(Math.sqrt(t/(s*e))*i),1,n)}class Is{constructor(){this.m_index=T}GetIndex(){return this.m_index}SetIndex(t){this.m_index=t}}(Es=t.b2ParticleGroupFlag||(t.b2ParticleGroupFlag={}))[Es.b2_solidParticleGroup=1]="b2_solidParticleGroup",Es[Es.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",Es[Es.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",Es[Es.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",Es[Es.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",Es[Es.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask";class Rs{constructor(){this.flags=0,this.groupFlags=0,this.position=new xt,this.angle=0,this.linearVelocity=new xt,this.angularVelocity=0,this.color=new wt,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null}}class Ds{constructor(t){this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new xt,this.m_linearVelocity=new xt,this.m_angularVelocity=0,this.m_transform=new Et,this.m_userData=null,this.m_system=t}GetNext(){return this.m_next}GetParticleSystem(){return this.m_system}GetParticleCount(){return this.m_lastIndex-this.m_firstIndex}GetBufferIndex(){return this.m_firstIndex}ContainsParticle(t){return this.m_firstIndex<=t&&t<this.m_lastIndex}GetAllParticleFlags(){if(!this.m_system.m_flagsBuffer.data)throw new Error;let t=0;for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t}GetGroupFlags(){return this.m_groupFlags}SetGroupFlags(e){e|=this.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,e)}GetMass(){return this.UpdateStatistics(),this.m_mass}GetInertia(){return this.UpdateStatistics(),this.m_inertia}GetCenter(){return this.UpdateStatistics(),this.m_center}GetLinearVelocity(){return this.UpdateStatistics(),this.m_linearVelocity}GetAngularVelocity(){return this.UpdateStatistics(),this.m_angularVelocity}GetTransform(){return this.m_transform}GetPosition(){return this.m_transform.p}GetAngle(){return this.m_transform.q.GetAngle()}GetLinearVelocityFromWorldPoint(t,e){const i=Ds.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),xt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,xt.SubVV(t,this.m_center,i),e)}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}ApplyForce(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)}ApplyLinearImpulse(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)}DestroyParticles(t){if(this.m_system.m_world.IsLocked())throw new Error;for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)}UpdateStatistics(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;const t=new xt,e=new xt;if(this.m_timestamp!==this.m_system.m_timestamp){const i=this.m_system.GetParticleMass();this.m_mass=i*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(let t=this.m_firstIndex;t<this.m_lastIndex;t++)this.m_center.SelfMulAdd(i,this.m_system.m_positionBuffer.data[t]),this.m_linearVelocity.SelfMulAdd(i,this.m_system.m_velocityBuffer.data[t]);if(this.m_mass>0){const t=1/this.m_mass;this.m_center.SelfMul(t),this.m_linearVelocity.SelfMul(t)}this.m_inertia=0,this.m_angularVelocity=0;for(let n=this.m_firstIndex;n<this.m_lastIndex;n++)xt.SubVV(this.m_system.m_positionBuffer.data[n],this.m_center,t),xt.SubVV(this.m_system.m_velocityBuffer.data[n],this.m_linearVelocity,e),this.m_inertia+=i*xt.DotVV(t,t),this.m_angularVelocity+=i*xt.CrossVV(t,e);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}}}Ds.GetLinearVelocityFromWorldPoint_s_t0=new xt;class Ms{constructor(t){this.m_buffer=[],this.m_front=0,this.m_back=0,this.m_buffer.fill(null,0,t)}get m_capacity(){return this.m_buffer.length}Push(t){if(this.m_back>=this.m_capacity){for(let t=this.m_front;t<this.m_back;t++)this.m_buffer[t-this.m_front]=this.m_buffer[t];this.m_back-=this.m_front,this.m_front=0}this.m_buffer[this.m_back]=t,this.m_back++}Pop(){this.m_buffer[this.m_front]=null,this.m_front++}Empty(){return this.m_front===this.m_back}Front(){const t=this.m_buffer[this.m_front];if(!t)throw new Error;return t}}class Os{constructor(t){this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=X(t,(()=>new Bs)),this.m_generatorCapacity=t}AddGenerator(t,e,i){const n=this.m_generatorBuffer[this.m_generatorCount++];n.center.Copy(t),n.tag=e,n.necessary=i}Generate(t,e){const i=1/t,s=new xt(+n,+n),r=new xt(-n,-n);let o=0;for(let t=0;t<this.m_generatorCount;t++){const e=this.m_generatorBuffer[t];e.necessary&&(xt.MinV(s,e.center,s),xt.MaxV(r,e.center,r),++o)}if(0===o)return this.m_countX=0,void(this.m_countY=0);s.x-=e,s.y-=e,r.x+=e,r.y+=e,this.m_countX=1+Math.floor(i*(r.x-s.x)),this.m_countY=1+Math.floor(i*(r.y-s.y)),this.m_diagram=[];const a=new Ms(4*this.m_countX*this.m_countY);for(let t=0;t<this.m_generatorCount;t++){const e=this.m_generatorBuffer[t];e.center.SelfSub(s).SelfMul(i);const n=Math.floor(e.center.x),r=Math.floor(e.center.y);n>=0&&r>=0&&n<this.m_countX&&r<this.m_countY&&a.Push(new Ns(n,r,n+r*this.m_countX,e))}for(;!a.Empty();){const t=a.Front(),e=t.m_x,i=t.m_y,n=t.m_i,s=t.m_generator;a.Pop(),this.m_diagram[n]||(this.m_diagram[n]=s,e>0&&a.Push(new Ns(e-1,i,n-1,s)),i>0&&a.Push(new Ns(e,i-1,n-this.m_countX,s)),e<this.m_countX-1&&a.Push(new Ns(e+1,i,n+1,s)),i<this.m_countY-1&&a.Push(new Ns(e,i+1,n+this.m_countX,s)))}for(let t=0;t<this.m_countY;t++)for(let e=0;e<this.m_countX-1;e++){const i=e+t*this.m_countX,n=this.m_diagram[i],s=this.m_diagram[i+1];n!==s&&(a.Push(new Ns(e,t,i,s)),a.Push(new Ns(e+1,t,i+1,n)))}for(let t=0;t<this.m_countY-1;t++)for(let e=0;e<this.m_countX;e++){const i=e+t*this.m_countX,n=this.m_diagram[i],s=this.m_diagram[i+this.m_countX];n!==s&&(a.Push(new Ns(e,t,i,s)),a.Push(new Ns(e,t+1,i+this.m_countX,n)))}for(;!a.Empty();){const t=a.Front(),e=t.m_x,i=t.m_y,n=t.m_i,s=t.m_generator;a.Pop();const r=this.m_diagram[n],o=s;if(r!==o){const t=r.center.x-e,s=r.center.y-i,c=o.center.x-e,l=o.center.y-i;t*t+s*s>c*c+l*l&&(this.m_diagram[n]=o,e>0&&a.Push(new Ns(e-1,i,n-1,o)),i>0&&a.Push(new Ns(e,i-1,n-this.m_countX,o)),e<this.m_countX-1&&a.Push(new Ns(e+1,i,n+1,o)),i<this.m_countY-1&&a.Push(new Ns(e,i+1,n+this.m_countX,o)))}}}GetNodes(t){for(let e=0;e<this.m_countY-1;e++)for(let i=0;i<this.m_countX-1;i++){const n=i+e*this.m_countX,s=this.m_diagram[n],r=this.m_diagram[n+1],o=this.m_diagram[n+this.m_countX],a=this.m_diagram[n+1+this.m_countX];r!==o&&(s!==r&&s!==o&&(s.necessary||r.necessary||o.necessary)&&t(s.tag,r.tag,o.tag),a!==r&&a!==o&&(s.necessary||r.necessary||o.necessary)&&t(r.tag,a.tag,o.tag))}}}class Bs{constructor(){this.center=new xt,this.tag=0,this.necessary=!1}}class Ns{constructor(t,e,i,n){this.m_x=t,this.m_y=e,this.m_i=i,this.m_generator=n}}function Ls(t,e,i){const n=t[e];t[e]=t[i],t[i]=n}function Fs(t,e){return t<e}function zs(t,e=0,i=t.length-e,n=Fs){let s=e;const r=[];let o=0;for(;;){for(;s+1<i;i++){const e=t[s+Math.floor(Math.random()*(i-s))];r[o++]=i;for(let r=s-1;;){for(;n(t[++r],e););for(;n(e,t[--i]););if(r>=i)break;Ls(t,r,i)}}if(0===o)break;s=i,i=r[--o]}return t}function Vs(t,e=0,i=t.length-e,n=Fs){return zs(t,e,i,n)}function Gs(t,e,i=t.length){let n=0;for(let s=0;s<i;++s)e(t[s])||(s!==n?Ls(t,n++,s):++n);return n}function Us(t,e,i,n,s){let r=i-e;for(;r>0;){const i=Math.floor(r/2);let o=e+i;s(t[o],n)?(e=++o,r-=i+1):r=i}return e}function ks(t,e,i,n,s){let r=i-e;for(;r>0;){const i=Math.floor(r/2);let o=e+i;s(n,t[o])?r=i:(e=++o,r-=i+1)}return e}function Hs(t,e,i,n){let s=i;for(;e!==s;)Ls(t,e++,s++),s===n?s=i:e===i&&(i=s)}function js(t,e,i,n){if(e===i)return i;let s=e;for(;++e!==i;)n(t[s],t[e])||Ls(t,++s,e);return++s}class Ws{constructor(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}Append(){return this.count>=this.capacity&&this.Grow(),this.count++}Reserve(t){if(!(this.capacity>=t)){for(let e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}}Grow(){const t=this.capacity?2*this.capacity:O;this.Reserve(t)}Free(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)}Shorten(t){}Data(){return this.data}GetCount(){return this.count}SetCount(t){this.count=t}GetCapacity(){return this.capacity}RemoveIf(t){this.count=Gs(this.data,t,this.count)}Unique(t){this.count=js(this.data,0,this.count,t)}}class qs extends ls{constructor(t){super(),this.m_system=t}ShouldQueryParticleSystem(t){return!1}ReportFixture(t){if(t.IsSensor())return!0;const e=t.GetShape().GetChildCount();for(let i=0;i<e;i++){const e=t.GetAABB(i),n=this.m_system.GetInsideBoundsEnumerator(e);let s;for(;(s=n.GetNext())>=0;)this.ReportFixtureAndParticle(t,i,s)}return!0}ReportParticle(t,e){return!1}ReportFixtureAndParticle(t,e,i){}}class Xs{constructor(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new xt,this.flags=0}SetIndices(t,e){this.indexA=t,this.indexB=e}SetWeight(t){this.weight=t}SetNormal(t){this.normal.Copy(t)}SetFlags(t){this.flags=t}GetIndexA(){return this.indexA}GetIndexB(){return this.indexB}GetWeight(){return this.weight}GetNormal(){return this.normal}GetFlags(){return this.flags}IsEqual(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y}IsNotEqual(t){return!this.IsEqual(t)}ApproximatelyEqual(t){const e=.01,i=1e-4;return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&Q(this.weight-t.weight)<e&&xt.DistanceSquaredVV(this.normal,t.normal)<i}}class Ys{constructor(){this.index=0,this.weight=0,this.normal=new xt,this.mass=0}}class Ks{constructor(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0}}class Js{constructor(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new xt(0,0),this.pb=new xt(0,0),this.pc=new xt(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0}}class $s{constructor(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}Copy(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this}Clone(){return(new $s).Copy(this)}}class Zs{constructor(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new Qs,this.m_flagsBuffer=new Qs,this.m_positionBuffer=new Qs,this.m_velocityBuffer=new Qs,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new Qs,this.m_groupBuffer=[],this.m_userDataBuffer=new Qs,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new Qs,this.m_bodyContactCountBuffer=new Qs,this.m_consecutiveContactStepsBuffer=new Qs,this.m_stuckParticleBuffer=new Ws((()=>0)),this.m_proxyBuffer=new Ws((()=>new tr)),this.m_contactBuffer=new Ws((()=>new Xs)),this.m_bodyContactBuffer=new Ws((()=>new Ys)),this.m_pairBuffer=new Ws((()=>new Ks)),this.m_triadBuffer=new Ws((()=>new Js)),this.m_expirationTimeBuffer=new Qs,this.m_indexByExpirationTimeBuffer=new Qs,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new $s,this.m_prev=null,this.m_next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}static computeTag(t,e){return(e+Zs.yOffset>>>0<<Zs.yShift)+(Zs.xScale*t+Zs.xOffset>>>0)>>>0}static computeRelativeTag(t,e,i){return t+(i<<Zs.yShift)+(e<<Zs.xShift)>>>0}Drop(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)}CreateParticle(t){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){const t=this.m_count?2*this.m_count:O;this.ReallocateInternalAllocatedBuffers(t)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return T;this.DestroyOldestParticle(0,!1),this.SolveZombie()}const e=this.m_count++;this.m_flagsBuffer.data[e]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=0),this.m_positionBuffer.data[e]=(this.m_positionBuffer.data[e]||new xt).Copy(i(t.position,xt.ZERO)),this.m_velocityBuffer.data[e]=(this.m_velocityBuffer.data[e]||new xt).Copy(i(t.velocity,xt.ZERO)),this.m_weightBuffer[e]=0,this.m_forceBuffer[e]=(this.m_forceBuffer[e]||new xt).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=0),this.m_depthBuffer&&(this.m_depthBuffer[e]=0);const n=(new wt).Copy(i(t.color,wt.ZERO));!this.m_colorBuffer.data&&n.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[e]=(this.m_colorBuffer.data[e]||new wt).Copy(n)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[e]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[e]=null);const s=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],r=i(t.lifetime,0),o=r>0;(this.m_expirationTimeBuffer.data||o)&&(this.SetParticleLifetime(e,o?r:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[e]=e),s.index=e;const a=i(t.group,null);return this.m_groupBuffer[e]=a,a&&(a.m_firstIndex<a.m_lastIndex?(this.RotateBuffer(a.m_firstIndex,a.m_lastIndex,e),a.m_lastIndex=e+1):(a.m_firstIndex=e,a.m_lastIndex=e+1)),this.SetParticleFlags(e,i(t.flags,0)),e}GetParticleHandleFromIndex(t){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);let e=this.m_handleIndexBuffer.data[t];return e||(e=new Is,e.SetIndex(t),this.m_handleIndexBuffer.data[t]=e,e)}DestroyParticle(e,i=!1){let n=t.b2ParticleFlag.b2_zombieParticle;i&&(n|=t.b2ParticleFlag.b2_destructionListenerParticle),this.SetParticleFlags(e,this.m_flagsBuffer.data[e]|n)}DestroyOldestParticle(t,e=!1){const i=this.GetParticleCount(),n=this.m_indexByExpirationTimeBuffer.data[i-(t+1)],s=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(this.m_expirationTimeBuffer.data[n]>0?n:s,e)}DestroyParticlesInShape(t,e,i=!1){const n=Zs.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;const s=new lr(this,t,e,i),r=n;return t.ComputeAABB(r,e,0),this.m_world.QueryAABB(s,r),s.Destroyed()}CreateParticleGroup(t){const e=Zs.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;const n=e;n.SetPositionAngle(i(t.position,xt.ZERO),i(t.angle,0));const s=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,n),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,i(t.shapeCount,t.shapes.length),t,n),t.positionData){const e=i(t.particleCount,t.positionData.length);for(let i=0;i<e;i++){const e=t.positionData[i];this.CreateParticleForGroup(t,n,e)}}const r=this.m_count;let o=new Ds(this);o.m_firstIndex=s,o.m_lastIndex=r,o.m_strength=i(t.strength,1),o.m_userData=t.userData,o.m_transform.Copy(n),o.m_prev=null,o.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=o),this.m_groupList=o,++this.m_groupCount;for(let t=s;t<r;t++)this.m_groupBuffer[t]=o;this.SetGroupFlags(o,i(t.groupFlags,0));const a=new cr;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(s,r,a),t.group&&(this.JoinParticleGroups(t.group,o),o=t.group),o}JoinParticleGroups(t,e){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex);const i=new hr(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,i);for(let i=e.m_firstIndex;i<e.m_lastIndex;i++)this.m_groupBuffer[i]=t;const n=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,n),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)}SplitParticleGroup(t){this.UpdateContacts(!0);const e=X(t.GetParticleCount(),(()=>new ir));Zs.InitializeParticleLists(t,e),this.MergeParticleListsInContact(t,e);const i=Zs.FindLongestParticleList(t,e);this.MergeZombieParticleListNodes(t,e,i),this.CreateParticleGroupsFromParticleList(t,e,i),this.UpdatePairsAndTriadsWithParticleList(t,e)}GetParticleGroupList(){return this.m_groupList}GetParticleGroupCount(){return this.m_groupCount}GetParticleCount(){return this.m_count}GetMaxParticleCount(){return this.m_def.maxCount}SetMaxParticleCount(t){this.m_def.maxCount=t}GetAllParticleFlags(){return this.m_allParticleFlags}GetAllGroupFlags(){return this.m_allGroupFlags}SetPaused(t){this.m_paused=t}GetPaused(){return this.m_paused}SetDensity(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density}GetDensity(){return this.m_def.density}SetGravityScale(t){this.m_def.gravityScale=t}GetGravityScale(){return this.m_def.gravityScale}SetDamping(t){this.m_def.dampingStrength=t}GetDamping(){return this.m_def.dampingStrength}SetStaticPressureIterations(t){this.m_def.staticPressureIterations=t}GetStaticPressureIterations(){return this.m_def.staticPressureIterations}SetRadius(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter}GetRadius(){return this.m_particleDiameter/2}GetPositionBuffer(){return this.m_positionBuffer.data}GetVelocityBuffer(){return this.m_velocityBuffer.data}GetColorBuffer(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data}GetGroupBuffer(){return this.m_groupBuffer}GetWeightBuffer(){return this.m_weightBuffer}GetUserDataBuffer(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data}GetFlagsBuffer(){return this.m_flagsBuffer.data}SetParticleFlags(e,i){this.m_flagsBuffer.data[e]&~i&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&i&&(i&t.b2ParticleFlag.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),i&t.b2ParticleFlag.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=i),this.m_flagsBuffer.data[e]=i}GetParticleFlags(t){return this.m_flagsBuffer.data[t]}SetFlagsBuffer(t){this.SetUserOverridableBuffer(this.m_flagsBuffer,t)}SetPositionBuffer(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;const e=t.length/2,i=new Array(e);for(let n=0;n<e;++n)i[n]=new xt(t.subarray(2*n,2*n+2));t=i}this.SetUserOverridableBuffer(this.m_positionBuffer,t)}SetVelocityBuffer(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;const e=t.length/2,i=new Array(e);for(let n=0;n<e;++n)i[n]=new xt(t.subarray(2*n,2*n+2));t=i}this.SetUserOverridableBuffer(this.m_velocityBuffer,t)}SetColorBuffer(t){if(t instanceof Float32Array){if(t.length%4!=0)throw new Error;const e=t.length/4,i=new Array(e);for(let n=0;n<e;++n)i[n]=new wt(t.subarray(4*n,4*n+4));t=i}this.SetUserOverridableBuffer(this.m_colorBuffer,t)}SetUserDataBuffer(t){this.SetUserOverridableBuffer(this.m_userDataBuffer,t)}GetContacts(){return this.m_contactBuffer.data}GetContactCount(){return this.m_contactBuffer.count}GetBodyContacts(){return this.m_bodyContactBuffer.data}GetBodyContactCount(){return this.m_bodyContactBuffer.count}GetPairs(){return this.m_pairBuffer.data}GetPairCount(){return this.m_pairBuffer.count}GetTriads(){return this.m_triadBuffer.data}GetTriadCount(){return this.m_triadBuffer.count}SetStuckThreshold(t){this.m_stuckThreshold=t,t>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))}GetStuckCandidates(){return this.m_stuckParticleBuffer.Data()}GetStuckCandidateCount(){return this.m_stuckParticleBuffer.GetCount()}ComputeCollisionEnergy(){const t=Zs.ComputeCollisionEnergy_s_v,e=this.m_velocityBuffer.data;let i=0;for(let n=0;n<this.m_contactBuffer.count;n++){const s=this.m_contactBuffer.data[n],r=s.indexA,o=s.indexB,a=s.normal,c=xt.SubVV(e[o],e[r],t),l=xt.DotVV(c,a);l<0&&(i+=l*l)}return.5*this.GetParticleMass()*i}SetStrictContactCheck(t){this.m_def.strictContactCheck=t}GetStrictContactCheck(){return this.m_def.strictContactCheck}SetParticleLifetime(t,e){const i=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),i){const t=this.GetParticleCount();for(let e=0;e<t;++e)this.m_indexByExpirationTimeBuffer.data[e]=e}const n=e/this.m_def.lifetimeGranularity,s=n>0?this.GetQuantizedTimeElapsed()+n:n;s!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=s,this.m_expirationTimeBufferRequiresSorting=!0)}GetParticleLifetime(t){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])}SetDestructionByAge(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t}GetDestructionByAge(){return this.m_def.destroyByAge}GetExpirationTimeBuffer(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data}ExpirationTimeToLifetime(t){return(t>0?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity}GetIndexByExpirationTimeBuffer(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data}ParticleApplyLinearImpulse(t,e){this.ApplyLinearImpulse(t,t+1,e)}ApplyLinearImpulse(t,e,i){const n=this.m_velocityBuffer.data,s=(e-t)*this.GetParticleMass(),r=(new xt).Copy(i).SelfMul(1/s);for(let i=t;i<e;i++)n[i].SelfAdd(r)}static IsSignificantForce(t){return 0!==t.x||0!==t.y}ParticleApplyForce(t,e){Zs.IsSignificantForce(e)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(e))}ApplyForce(t,e,i){const n=(new xt).Copy(i).SelfMul(1/(e-t));if(Zs.IsSignificantForce(n)){this.PrepareForceBuffer();for(let i=t;i<e;i++)this.m_forceBuffer[i].SelfAdd(n)}}GetNext(){return this.m_next}QueryAABB(t,e){if(0===this.m_proxyBuffer.count)return;const i=0,n=this.m_proxyBuffer.count,s=Us(this.m_proxyBuffer.data,i,n,Zs.computeTag(this.m_inverseDiameter*e.lowerBound.x,this.m_inverseDiameter*e.lowerBound.y),tr.CompareProxyTag),r=ks(this.m_proxyBuffer.data,s,n,Zs.computeTag(this.m_inverseDiameter*e.upperBound.x,this.m_inverseDiameter*e.upperBound.y),tr.CompareTagProxy),o=this.m_positionBuffer.data;for(let i=s;i<r;++i){const n=this.m_proxyBuffer.data[i].index,s=o[n];if(e.lowerBound.x<s.x&&s.x<e.upperBound.x&&e.lowerBound.y<s.y&&s.y<e.upperBound.y&&!t.ReportParticle(this,n))break}}QueryShapeAABB(t,e,i,n=0){const s=Zs.QueryShapeAABB_s_aabb;e.ComputeAABB(s,i,n),this.QueryAABB(t,s)}QueryPointAABB(t,e,i=_){const n=Zs.QueryPointAABB_s_aabb;n.lowerBound.Set(e.x-i,e.y-i),n.upperBound.Set(e.x+i,e.y+i),this.QueryAABB(t,n)}RayCast(t,e,i){const n=Zs.RayCast_s_aabb,s=Zs.RayCast_s_p,r=Zs.RayCast_s_v,o=Zs.RayCast_s_n,a=Zs.RayCast_s_point;if(0===this.m_proxyBuffer.count)return;const c=this.m_positionBuffer.data,l=n;xt.MinV(e,i,l.lowerBound),xt.MaxV(e,i,l.upperBound);let h=1;const _=xt.SubVV(i,e,r),u=xt.DotVV(_,_),d=this.GetInsideBoundsEnumerator(l);let m;for(;(m=d.GetNext())>=0;){const i=xt.SubVV(e,c[m],s),n=xt.DotVV(i,_),r=n*n-u*(xt.DotVV(i,i)-this.m_squaredDiameter);if(r>=0){const s=at(r);let c=(-n-s)/u;if(c>h)continue;if(c<0&&(c=(-n+s)/u,c<0||c>h))continue;const l=xt.AddVMulSV(i,c,_,o);if(l.Normalize(),h=tt(h,t.ReportParticle(this,m,xt.AddVMulSV(e,c,_,a),l,c)),h<=0)break}}}ComputeAABB(t){const e=this.GetParticleCount();t.lowerBound.x=+n,t.lowerBound.y=+n,t.upperBound.x=-n,t.upperBound.y=-n;const i=this.m_positionBuffer.data;for(let n=0;n<e;n++){const e=i[n];xt.MinV(t.lowerBound,e,t.lowerBound),xt.MaxV(t.upperBound,e,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter}FreeBuffer(t,e){null!==t&&(t.length=0)}FreeUserOverridableBuffer(t){0===t.userSuppliedCapacity&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)}ReallocateBuffer3(t,e,i){if(i<=e)throw new Error;const n=t?t.slice():[];return n.length=i,n}ReallocateBuffer5(t,e,i,n,s){if(n<=i)throw new Error;if(e&&!(n<=e))throw new Error;return s&&!t||e||(t=this.ReallocateBuffer3(t,i,n)),t}ReallocateBuffer4(t,e,i,n){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,i,n)}RequestBuffer(t){return t||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(O),(t=[]).length=this.m_internalAllocatedCapacity),t}ReallocateHandleBuffers(t){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)}ReallocateInternalAllocatedBuffers(t){function e(t,e){return e&&t>e?e:t}if(t=e(t,this.m_def.maxCount),t=e(t,this.m_flagsBuffer.userSuppliedCapacity),t=e(t,this.m_positionBuffer.userSuppliedCapacity),t=e(t,this.m_velocityBuffer.userSuppliedCapacity),t=e(t,this.m_colorBuffer.userSuppliedCapacity),t=e(t,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);const e=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,e),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,e),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,e),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}}CreateParticleForGroup(t,e,n){const s=new Ps;s.flags=i(t.flags,0),Et.MulXV(e,n,s.position),xt.AddVV(i(t.linearVelocity,xt.ZERO),xt.CrossSV(i(t.angularVelocity,0),xt.SubVV(s.position,i(t.position,xt.ZERO),xt.s_t0),xt.s_t0),s.velocity),s.color.Copy(i(t.color,wt.ZERO)),s.lifetime=i(t.lifetime,0),s.userData=t.userData,this.CreateParticle(s)}CreateParticlesStrokeShapeForGroup(e,n,s){const r=Zs.CreateParticlesStrokeShapeForGroup_s_edge,o=Zs.CreateParticlesStrokeShapeForGroup_s_d,a=Zs.CreateParticlesStrokeShapeForGroup_s_p;let c=i(n.stride,0);0===c&&(c=this.GetParticleStride());let l=0;const h=e.GetChildCount();for(let i=0;i<h;i++){let h=null;e.GetType()===t.b2ShapeType.e_edgeShape?h=e:(h=r,e.GetChildEdge(h,i));const _=xt.SubVV(h.m_vertex2,h.m_vertex1,o),u=_.Length();for(;l<u;){const t=xt.AddVMulSV(h.m_vertex1,l/u,_,a);this.CreateParticleForGroup(n,s,t),l+=c}l-=u}}CreateParticlesFillShapeForGroup(t,e,n){const s=Zs.CreateParticlesFillShapeForGroup_s_aabb,r=Zs.CreateParticlesFillShapeForGroup_s_p;let o=i(e.stride,0);0===o&&(o=this.GetParticleStride());const a=Et.IDENTITY,c=s;t.ComputeAABB(c,a,0);for(let i=Math.floor(c.lowerBound.y/o)*o;i<c.upperBound.y;i+=o)for(let s=Math.floor(c.lowerBound.x/o)*o;s<c.upperBound.x;s+=o){const o=r.Set(s,i);t.TestPoint(a,o)&&this.CreateParticleForGroup(e,n,o)}}CreateParticlesWithShapeForGroup(e,i,n){switch(e.GetType()){case t.b2ShapeType.e_edgeShape:case t.b2ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(e,i,n);break;case t.b2ShapeType.e_polygonShape:case t.b2ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(e,i,n)}}CreateParticlesWithShapesForGroup(t,e,i,n){const s=new _r(t,e);this.CreateParticlesFillShapeForGroup(s,i,n)}CloneParticle(t,e){const i=new Ps;i.flags=this.m_flagsBuffer.data[t],i.position.Copy(this.m_positionBuffer.data[t]),i.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&i.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(i.userData=this.m_userDataBuffer.data[t]),i.group=e;const n=this.CreateParticle(i);if(this.m_handleIndexBuffer.data){const e=this.m_handleIndexBuffer.data[t];e&&e.SetIndex(n),this.m_handleIndexBuffer.data[n]=e,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[n]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[n]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[n]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[n].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[n]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[n]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[n]=this.m_expirationTimeBuffer.data[t]),n}DestroyParticlesInGroup(t,e=!1){for(let i=t.m_firstIndex;i<t.m_lastIndex;i++)this.DestroyParticle(i,e)}DestroyParticleGroup(t){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(let e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount}static ParticleCanBeConnected(e,i){return 0!=(e&(t.b2ParticleFlag.b2_wallParticle|t.b2ParticleFlag.b2_springParticle|t.b2ParticleFlag.b2_elasticParticle))||null!==i&&0!=(i.GetGroupFlags()&t.b2ParticleGroupFlag.b2_rigidParticleGroup)}UpdatePairsAndTriads(e,i,n){const s=Zs.UpdatePairsAndTriads_s_dab,r=Zs.UpdatePairsAndTriads_s_dbc,o=Zs.UpdatePairsAndTriads_s_dca,a=this.m_positionBuffer.data;let c=0;for(let t=e;t<i;t++)c|=this.m_flagsBuffer.data[t];if(c&Zs.k_pairFlags)for(let s=0;s<this.m_contactBuffer.count;s++){const r=this.m_contactBuffer.data[s],o=r.indexA,c=r.indexB,l=this.m_flagsBuffer.data[o],h=this.m_flagsBuffer.data[c],_=this.m_groupBuffer[o],u=this.m_groupBuffer[c];if(o>=e&&o<i&&c>=e&&c<i&&!((l|h)&t.b2ParticleFlag.b2_zombieParticle)&&(l|h)&Zs.k_pairFlags&&(n.IsNecessary(o)||n.IsNecessary(c))&&Zs.ParticleCanBeConnected(l,_)&&Zs.ParticleCanBeConnected(h,u)&&n.ShouldCreatePair(o,c)){const t=this.m_pairBuffer.data[this.m_pairBuffer.Append()];t.indexA=o,t.indexB=c,t.flags=r.flags,t.strength=tt(_?_.m_strength:1,u?u.m_strength:1),t.distance=xt.DistanceVV(a[o],a[c])}Vs(this.m_pairBuffer.data,0,this.m_pairBuffer.count,Zs.ComparePairIndices),this.m_pairBuffer.Unique(Zs.MatchPairIndices)}if(c&Zs.k_triadFlags){const c=new Os(i-e);for(let s=e;s<i;s++){const e=this.m_flagsBuffer.data[s],i=this.m_groupBuffer[s];e&t.b2ParticleFlag.b2_zombieParticle||!Zs.ParticleCanBeConnected(e,i)||c.AddGenerator(a[s],s,n.IsNecessary(s))}const l=this.GetParticleStride();c.Generate(l/2,2*l);const h=this,_=(t,e,i)=>{const c=h.m_flagsBuffer.data[t],l=h.m_flagsBuffer.data[e],_=h.m_flagsBuffer.data[i];if((c|l|_)&Zs.k_triadFlags&&n.ShouldCreateTriad(t,e,i)){const n=a[t],u=a[e],d=a[i],m=xt.SubVV(n,u,s),p=xt.SubVV(u,d,r),f=xt.SubVV(d,n,o),g=M*h.m_squaredDiameter;if(xt.DotVV(m,m)>g||xt.DotVV(p,p)>g||xt.DotVV(f,f)>g)return;const v=h.m_groupBuffer[t],y=h.m_groupBuffer[e],x=h.m_groupBuffer[i],S=h.m_triadBuffer.data[h.m_triadBuffer.Append()];S.indexA=t,S.indexB=e,S.indexC=i,S.flags=c|l|_,S.strength=tt(tt(v?v.m_strength:1,y?y.m_strength:1),x?x.m_strength:1);const C=(n.x+u.x+d.x)/3,A=(n.y+u.y+d.y)/3;S.pa.x=n.x-C,S.pa.y=n.y-A,S.pb.x=u.x-C,S.pb.y=u.y-A,S.pc.x=d.x-C,S.pc.y=d.y-A,S.ka=-xt.DotVV(f,m),S.kb=-xt.DotVV(m,p),S.kc=-xt.DotVV(p,f),S.s=xt.CrossVV(n,u)+xt.CrossVV(u,d)+xt.CrossVV(d,n)}};c.GetNodes(_),Vs(this.m_triadBuffer.data,0,this.m_triadBuffer.count,Zs.CompareTriadIndices),this.m_triadBuffer.Unique(Zs.MatchTriadIndices)}}UpdatePairsAndTriadsWithReactiveParticles(){const e=new ur(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,e);for(let e=0;e<this.m_count;e++)this.m_flagsBuffer.data[e]&=~t.b2ParticleFlag.b2_reactiveParticle;this.m_allParticleFlags&=~t.b2ParticleFlag.b2_reactiveParticle}static ComparePairIndices(t,e){const i=t.indexA-e.indexA;return 0!==i?i<0:t.indexB<e.indexB}static MatchPairIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB}static CompareTriadIndices(t,e){const i=t.indexA-e.indexA;if(0!==i)return i<0;const n=t.indexB-e.indexB;return 0!==n?n<0:t.indexC<e.indexC}static MatchTriadIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC}static InitializeParticleLists(t,e){const i=t.GetBufferIndex(),n=t.GetParticleCount();for(let t=0;t<n;t++){const n=e[t];n.list=n,n.next=null,n.count=1,n.index=t+i}}MergeParticleListsInContact(t,e){const i=t.GetBufferIndex();for(let n=0;n<this.m_contactBuffer.count;n++){const s=this.m_contactBuffer.data[n],r=s.indexA,o=s.indexB;if(!t.ContainsParticle(r)||!t.ContainsParticle(o))continue;let a=e[r-i].list,c=e[o-i].list;if(a!==c){if(a.count<c.count){const t=a;a=c,c=t}Zs.MergeParticleLists(a,c)}}}static MergeParticleLists(t,e){for(let i=e;;){i.list=t;const e=i.next;if(!e){i.next=t.next;break}i=e}t.next=e,t.count+=e.count,e.count=0}static FindLongestParticleList(t,e){const i=t.GetParticleCount();let n=e[0];for(let t=0;t<i;t++){const i=e[t];n.count<i.count&&(n=i)}return n}MergeZombieParticleListNodes(e,i,n){const s=e.GetParticleCount();for(let e=0;e<s;e++){const s=i[e];s!==n&&this.m_flagsBuffer.data[s.index]&t.b2ParticleFlag.b2_zombieParticle&&Zs.MergeParticleListAndNode(n,s)}}static MergeParticleListAndNode(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0}CreateParticleGroupsFromParticleList(e,i,n){const s=e.GetParticleCount(),r=new Rs;r.groupFlags=e.GetGroupFlags(),r.userData=e.GetUserData();for(let e=0;e<s;e++){const s=i[e];if(!s.count||s===n)continue;const o=this.CreateParticleGroup(r);for(let e=s;e;e=e.next){const i=e.index,n=this.CloneParticle(i,o);this.m_flagsBuffer.data[i]|=t.b2ParticleFlag.b2_zombieParticle,e.index=n}}}UpdatePairsAndTriadsWithParticleList(t,e){const i=t.GetBufferIndex();for(let n=0;n<this.m_pairBuffer.count;n++){const s=this.m_pairBuffer.data[n],r=s.indexA,o=s.indexB;t.ContainsParticle(r)&&(s.indexA=e[r-i].index),t.ContainsParticle(o)&&(s.indexB=e[o-i].index)}for(let n=0;n<this.m_triadBuffer.count;n++){const s=this.m_triadBuffer.data[n],r=s.indexA,o=s.indexB,a=s.indexC;t.ContainsParticle(r)&&(s.indexA=e[r-i].index),t.ContainsParticle(o)&&(s.indexB=e[o-i].index),t.ContainsParticle(a)&&(s.indexC=e[a-i].index)}}ComputeDepth(){const e=[];let i=0;for(let n=0;n<this.m_contactBuffer.count;n++){const s=this.m_contactBuffer.data[n],r=s.indexA,o=s.indexB,a=this.m_groupBuffer[r],c=this.m_groupBuffer[o];a&&a===c&&a.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&(e[i++]=s)}const s=[];let r=0;for(let e=this.m_groupList;e;e=e.GetNext())if(e.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth){s[r++]=e,this.SetGroupFlags(e,e.m_groupFlags&~t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth);for(let t=e.m_firstIndex;t<e.m_lastIndex;t++)this.m_accumulationBuffer[t]=0}for(let t=0;t<i;t++){const i=e[t],n=i.indexA,s=i.indexB,r=i.weight;this.m_accumulationBuffer[n]+=r,this.m_accumulationBuffer[s]+=r}for(let t=0;t<r;t++){const e=s[t];for(let t=e.m_firstIndex;t<e.m_lastIndex;t++){const e=this.m_accumulationBuffer[t];this.m_depthBuffer[t]=e<.8?0:n}}const o=at(this.m_count)>>0;for(let t=0;t<o;t++){let t=!1;for(let n=0;n<i;n++){const i=e[n],s=i.indexA,r=i.indexB,o=1-i.weight,a=this.m_depthBuffer[s],c=this.m_depthBuffer[r],l=c+o,h=a+o;a>l&&(this.m_depthBuffer[s]=l,t=!0),c>h&&(this.m_depthBuffer[r]=h,t=!0)}if(!t)break}for(let t=0;t<r;t++){const e=s[t];for(let t=e.m_firstIndex;t<e.m_lastIndex;t++)this.m_depthBuffer[t]<n?this.m_depthBuffer[t]*=this.m_particleDiameter:this.m_depthBuffer[t]=0}}GetInsideBoundsEnumerator(t){const e=Zs.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),i=Zs.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),n=0,s=this.m_proxyBuffer.count,r=Us(this.m_proxyBuffer.data,n,s,e,tr.CompareProxyTag),o=ks(this.m_proxyBuffer.data,n,s,i,tr.CompareTagProxy);return new er(this,e,i,r,o)}UpdateAllParticleFlags(){this.m_allParticleFlags=0;for(let t=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1}UpdateAllGroupFlags(){this.m_allGroupFlags=0;for(let t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1}AddContact(t,e,i){const n=this.m_flagsBuffer.data,s=this.m_positionBuffer.data,r=xt.SubVV(s[e],s[t],Zs.AddContact_s_d),o=xt.DotVV(r,r);if(0<o&&o<this.m_squaredDiameter){const i=ot(o),s=this.m_contactBuffer.data[this.m_contactBuffer.Append()];s.indexA=t,s.indexB=e,s.flags=n[t]|n[e],s.weight=1-o*i*this.m_inverseDiameter,s.normal.x=i*r.x,s.normal.y=i*r.y}}FindContacts_Reference(t){const e=0,i=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(let t=e,n=e;t<i;t++){const e=Zs.computeRelativeTag(this.m_proxyBuffer.data[t].tag,1,0);for(let n=t+1;n<i&&!(e<this.m_proxyBuffer.data[n].tag);n++)this.AddContact(this.m_proxyBuffer.data[t].index,this.m_proxyBuffer.data[n].index,this.m_contactBuffer);const s=Zs.computeRelativeTag(this.m_proxyBuffer.data[t].tag,-1,1);for(;n<i&&!(s<=this.m_proxyBuffer.data[n].tag);n++);const r=Zs.computeRelativeTag(this.m_proxyBuffer.data[t].tag,1,1);for(let e=n;e<i&&!(r<this.m_proxyBuffer.data[e].tag);e++)this.AddContact(this.m_proxyBuffer.data[t].index,this.m_proxyBuffer.data[e].index,this.m_contactBuffer)}}FindContacts(t){this.FindContacts_Reference(t)}UpdateProxies_Reference(t){const e=this.m_positionBuffer.data,i=this.m_inverseDiameter;for(let t=0;t<this.m_proxyBuffer.count;++t){const n=this.m_proxyBuffer.data[t],s=e[n.index];n.tag=Zs.computeTag(i*s.x,i*s.y)}}UpdateProxies(t){this.UpdateProxies_Reference(t)}SortProxies(t){zs(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,tr.CompareProxyProxy)}FilterContacts(e){const i=this.GetParticleContactFilter();if(null===i)return;const n=this,s=e=>0!=(e.flags&t.b2ParticleFlag.b2_particleContactFilterParticle)&&!i.ShouldCollideParticleParticle(n,e.indexA,e.indexB);this.m_contactBuffer.RemoveIf(s)}NotifyContactListenerPreContact(t){if(null!==this.GetParticleContactListener())throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error}NotifyContactListenerPostContact(t){const e=this.GetParticleContactListener();if(null!==e){for(let t=0;t<this.m_contactBuffer.count;++t){const i=this.m_contactBuffer.data[t];e.BeginContactParticleParticle(this,i)}throw new Error}}static b2ParticleContactIsZombie(e){return(e.flags&t.b2ParticleFlag.b2_zombieParticle)===t.b2ParticleFlag.b2_zombieParticle}UpdateContacts(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);const e=new ar;this.NotifyContactListenerPreContact(e),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(e),t&&this.m_contactBuffer.RemoveIf(Zs.b2ParticleContactIsZombie)}NotifyBodyContactListenerPreContact(t){if(null!==this.GetFixtureContactListener())throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error}NotifyBodyContactListenerPostContact(t){const e=this.GetFixtureContactListener();if(null!==e){for(let t=0;t<this.m_bodyContactBuffer.count;t++){const i=this.m_bodyContactBuffer.data[t];e.BeginContactFixtureParticle(this,i)}throw new Error}}UpdateBodyContacts(){const t=Zs.UpdateBodyContacts_s_aabb,e=new rr;if(this.NotifyBodyContactListenerPreContact(e),this.m_stuckThreshold>0){const t=this.GetParticleCount();for(let e=0;e<t;e++)this.m_bodyContactCountBuffer.data[e]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[e]+1&&(this.m_consecutiveContactStepsBuffer.data[e]=0)}this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);const i=t;this.ComputeAABB(i),null===this.UpdateBodyContacts_callback&&(this.UpdateBodyContacts_callback=new dr(this));const n=this.UpdateBodyContacts_callback;n.m_contactFilter=this.GetFixtureContactFilter(),this.m_world.QueryAABB(n,i),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(e)}Solve(e){const i=Zs.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(e),this.m_allParticleFlags&t.b2ParticleFlag.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<e.particleIterations;this.m_iterationIndex++){++this.m_timestamp;const n=i.Copy(e);n.dt/=e.particleIterations,n.inv_dt*=e.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&t.b2ParticleFlag.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&t.b2ParticleFlag.b2_repulsiveParticle&&this.SolveRepulsive(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_powderParticle&&this.SolvePowder(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_tensileParticle&&this.SolveTensile(n),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SolveSolid(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle&&this.SolveStaticPressure(n),this.SolvePressure(n),this.SolveDamping(n),this.m_allParticleFlags&Zs.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_elasticParticle&&this.SolveElastic(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_springParticle&&this.SolveSpring(n),this.LimitVelocity(n),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_barrierParticle&&this.SolveBarrier(n),this.SolveCollision(n),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigid(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_wallParticle&&this.SolveWall();for(let t=0;t<this.m_count;t++)this.m_positionBuffer.data[t].SelfMulAdd(n.dt,this.m_velocityBuffer.data[t])}}SolveCollision(t){const e=Zs.SolveCollision_s_aabb,i=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=e;r.lowerBound.x=+n,r.lowerBound.y=+n,r.upperBound.x=-n,r.upperBound.y=-n;for(let e=0;e<this.m_count;e++){const n=s[e],o=i[e],a=o.x+t.dt*n.x,c=o.y+t.dt*n.y;r.lowerBound.x=tt(r.lowerBound.x,tt(o.x,a)),r.lowerBound.y=tt(r.lowerBound.y,tt(o.y,c)),r.upperBound.x=et(r.upperBound.x,et(o.x,a)),r.upperBound.y=et(r.upperBound.y,et(o.y,c))}null===this.SolveCollision_callback&&(this.SolveCollision_callback=new mr(this,t));const o=this.SolveCollision_callback;o.m_step=t,this.m_world.QueryAABB(o,r)}LimitVelocity(t){const e=this.m_velocityBuffer.data,i=this.GetCriticalVelocitySquared(t);for(let t=0;t<this.m_count;t++){const n=e[t],s=xt.DotVV(n,n);s>i&&n.SelfMul(at(i/s))}}SolveGravity(t){const e=Zs.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,n=xt.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),e);for(let t=0;t<this.m_count;t++)i[t].SelfAdd(n)}SolveBarrier(e){const i=Zs.SolveBarrier_s_aabb,n=Zs.SolveBarrier_s_va,s=Zs.SolveBarrier_s_vb,r=Zs.SolveBarrier_s_pba,o=Zs.SolveBarrier_s_vba,a=Zs.SolveBarrier_s_vc,c=Zs.SolveBarrier_s_pca,l=Zs.SolveBarrier_s_vca,h=Zs.SolveBarrier_s_qba,_=Zs.SolveBarrier_s_qca,u=Zs.SolveBarrier_s_dv,d=Zs.SolveBarrier_s_f,m=this.m_positionBuffer.data,p=this.m_velocityBuffer.data;for(let t=0;t<this.m_count;t++)0!=(this.m_flagsBuffer.data[t]&Zs.k_barrierWallFlags)&&p[t].SetZero();const f=B*e.dt,g=this.GetParticleMass();for(let v=0;v<this.m_pairBuffer.count;v++){const y=this.m_pairBuffer.data[v];if(y.flags&t.b2ParticleFlag.b2_barrierParticle){const t=y.indexA,v=y.indexB,x=m[t],S=m[v],C=i;xt.MinV(x,S,C.lowerBound),xt.MaxV(x,S,C.upperBound);const A=this.m_groupBuffer[t],b=this.m_groupBuffer[v],T=this.GetLinearVelocity(A,t,x,n),E=this.GetLinearVelocity(b,v,S,s),P=xt.SubVV(S,x,r),w=xt.SubVV(E,T,o),I=this.GetInsideBoundsEnumerator(C);let R;for(;(R=I.GetNext())>=0;){const t=m[R],i=this.m_groupBuffer[R];if(A!==i&&b!==i){const n=this.GetLinearVelocity(i,R,t,a),s=xt.SubVV(t,x,c),r=xt.SubVV(n,T,l),o=xt.CrossVV(w,r),m=xt.CrossVV(P,r)-xt.CrossVV(s,w),v=xt.CrossVV(P,s);let y,S;const C=h,A=_;if(0===o){if(0===m)continue;if(S=-v/m,!(S>=0&&S<f))continue;if(xt.AddVMulSV(P,S,w,C),xt.AddVMulSV(s,S,r,A),y=xt.DotVV(C,A)/xt.DotVV(C,C),!(y>=0&&y<=1))continue}else{const t=m*m-4*v*o;if(t<0)continue;const e=at(t);let i=(-m-e)/(2*o),n=(-m+e)/(2*o);if(i>n){const t=i;i=n,n=t}if(S=i,xt.AddVMulSV(P,S,w,C),xt.AddVMulSV(s,S,r,A),y=xt.DotVV(C,A)/xt.DotVV(C,C),!(S>=0&&S<f&&y>=0&&y<=1)){if(S=n,!(S>=0&&S<f))continue;if(xt.AddVMulSV(P,S,w,C),xt.AddVMulSV(s,S,r,A),y=xt.DotVV(C,A)/xt.DotVV(C,C),!(y>=0&&y<=1))continue}}const b=u;b.x=T.x+y*w.x-n.x,b.y=T.y+y*w.y-n.y;const E=xt.MulSV(g,b,d);if(i&&this.IsRigidGroup(i)){const e=i.GetMass(),n=i.GetInertia();e>0&&i.m_linearVelocity.SelfMulAdd(1/e,E),n>0&&(i.m_angularVelocity+=xt.CrossVV(xt.SubVV(t,i.GetCenter(),xt.s_t0),E)/n)}else p[R].SelfAdd(b);this.ParticleApplyForce(R,E.SelfMul(-e.inv_dt))}}}}}SolveStaticPressure(e){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);const i=this.GetCriticalPressure(e),n=this.m_def.staticPressureStrength*i,s=I*i,r=this.m_def.staticPressureRelaxation;for(let e=0;e<this.m_def.staticPressureIterations;e++){for(let t=0;t<this.m_count;t++)this.m_accumulationBuffer[t]=0;for(let e=0;e<this.m_contactBuffer.count;e++){const i=this.m_contactBuffer.data[e];if(i.flags&t.b2ParticleFlag.b2_staticPressureParticle){const t=i.indexA,e=i.indexB,n=i.weight;this.m_accumulationBuffer[t]+=n*this.m_staticPressureBuffer[e],this.m_accumulationBuffer[e]+=n*this.m_staticPressureBuffer[t]}}for(let e=0;e<this.m_count;e++){const i=this.m_weightBuffer[e];if(this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_staticPressureParticle){const t=(this.m_accumulationBuffer[e]+n*(i-w))/(i+r);this.m_staticPressureBuffer[e]=it(t,0,s)}else this.m_staticPressureBuffer[e]=0}}}ComputeWeight(){for(let t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t],i=e.index,n=e.weight;this.m_weightBuffer[i]+=n}for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t],i=e.indexA,n=e.indexB,s=e.weight;this.m_weightBuffer[i]+=s,this.m_weightBuffer[n]+=s}}SolvePressure(e){const i=Zs.SolvePressure_s_f,n=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.GetCriticalPressure(e),o=this.m_def.pressureStrength*r,a=I*r;for(let t=0;t<this.m_count;t++){const e=o*et(0,this.m_weightBuffer[t]-w);this.m_accumulationBuffer[t]=tt(e,a)}if(this.m_allParticleFlags&Zs.k_noPressureFlags)for(let t=0;t<this.m_count;t++)this.m_flagsBuffer.data[t]&Zs.k_noPressureFlags&&(this.m_accumulationBuffer[t]=0);if(this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle)for(let e=0;e<this.m_count;e++)this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_staticPressureParticle&&(this.m_accumulationBuffer[e]+=this.m_staticPressureBuffer[e]);const c=e.dt/(this.m_def.density*this.m_particleDiameter),l=this.GetParticleInvMass();for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t],r=e.index,a=e.body,h=e.weight,_=e.mass,u=e.normal,d=n[r],m=this.m_accumulationBuffer[r]+o*h,p=xt.MulSV(c*h*_*m,u,i);s[r].SelfMulSub(l,p),a.ApplyLinearImpulse(p,d,!0)}for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t],n=e.indexA,r=e.indexB,o=e.weight,a=e.normal,l=this.m_accumulationBuffer[n]+this.m_accumulationBuffer[r],h=xt.MulSV(c*o*l,a,i);s[n].SelfSub(h),s[r].SelfAdd(h)}}SolveDamping(t){const e=Zs.SolveDamping_s_v,i=Zs.SolveDamping_s_f,n=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.m_def.dampingStrength,o=1/this.GetCriticalVelocity(t),a=this.GetParticleInvMass();for(let t=0;t<this.m_bodyContactBuffer.count;t++){const c=this.m_bodyContactBuffer.data[t],l=c.index,h=c.body,_=c.weight,u=c.mass,d=c.normal,m=n[l],p=xt.SubVV(h.GetLinearVelocityFromWorldPoint(m,xt.s_t0),s[l],e),f=xt.DotVV(p,d);if(f<0){const t=et(r*_,tt(-o*f,.5)),e=xt.MulSV(t*u*f,d,i);s[l].SelfMulAdd(a,e),h.ApplyLinearImpulse(e.SelfNeg(),m,!0)}}for(let t=0;t<this.m_contactBuffer.count;t++){const n=this.m_contactBuffer.data[t],a=n.indexA,c=n.indexB,l=n.weight,h=n.normal,_=xt.SubVV(s[c],s[a],e),u=xt.DotVV(_,h);if(u<0){const t=et(r*l,tt(-o*u,.5)),e=xt.MulSV(t*u,h,i);s[a].SelfAdd(e),s[c].SelfSub(e)}}}SolveRigidDamping(){const t=Zs.SolveRigidDamping_s_t0,e=Zs.SolveRigidDamping_s_t1,i=Zs.SolveRigidDamping_s_p,n=Zs.SolveRigidDamping_s_v,s=[0],r=[0],o=[0],a=[0],c=[0],l=[0],h=this.m_positionBuffer.data,_=this.m_def.dampingStrength;for(let i=0;i<this.m_bodyContactBuffer.count;i++){const u=this.m_bodyContactBuffer.data[i],d=u.index,m=this.m_groupBuffer[d];if(m&&this.IsRigidGroup(m)){const i=u.body,p=u.normal,f=u.weight,g=h[d],v=xt.SubVV(i.GetLinearVelocityFromWorldPoint(g,t),m.GetLinearVelocityFromWorldPoint(g,e),n),y=xt.DotVV(v,p);if(y<0){this.InitDampingParameterWithRigidGroupOrParticle(s,r,o,!0,m,d,g,p),this.InitDampingParameter(a,c,l,i.GetMass(),i.GetInertia()-i.GetMass()*i.GetLocalCenter().LengthSquared(),i.GetWorldCenter(),g,p);const t=_*tt(f,1)*this.ComputeDampingImpulse(s[0],r[0],o[0],a[0],c[0],l[0],y);this.ApplyDamping(s[0],r[0],o[0],!0,m,d,t,p),i.ApplyLinearImpulse(xt.MulSV(-t,p,xt.s_t0),g,!0)}}}for(let u=0;u<this.m_contactBuffer.count;u++){const d=this.m_contactBuffer.data[u],m=d.indexA,p=d.indexB,f=d.normal,g=d.weight,v=this.m_groupBuffer[m],y=this.m_groupBuffer[p],x=this.IsRigidGroup(v),S=this.IsRigidGroup(y);if(v!==y&&(x||S)){const u=xt.MidVV(h[m],h[p],i),d=xt.SubVV(this.GetLinearVelocity(y,p,u,t),this.GetLinearVelocity(v,m,u,e),n),C=xt.DotVV(d,f);if(C<0){this.InitDampingParameterWithRigidGroupOrParticle(s,r,o,x,v,m,u,f),this.InitDampingParameterWithRigidGroupOrParticle(a,c,l,S,y,p,u,f);const t=_*g*this.ComputeDampingImpulse(s[0],r[0],o[0],a[0],c[0],l[0],C);this.ApplyDamping(s[0],r[0],o[0],x,v,m,t,f),this.ApplyDamping(a[0],c[0],l[0],S,y,p,-t,f)}}}}SolveExtraDamping(){const t=Zs.SolveExtraDamping_s_v,e=Zs.SolveExtraDamping_s_f,i=this.m_velocityBuffer.data,n=this.m_positionBuffer.data,s=this.GetParticleInvMass();for(let r=0;r<this.m_bodyContactBuffer.count;r++){const o=this.m_bodyContactBuffer.data[r],a=o.index;if(this.m_flagsBuffer.data[a]&Zs.k_extraDampingFlags){const r=o.body,c=o.mass,l=o.normal,h=n[a],_=xt.SubVV(r.GetLinearVelocityFromWorldPoint(h,xt.s_t0),i[a],t),u=xt.DotVV(_,l);if(u<0){const t=xt.MulSV(.5*c*u,l,e);i[a].SelfMulAdd(s,t),r.ApplyLinearImpulse(t.SelfNeg(),h,!0)}}}}SolveWall(){const e=this.m_velocityBuffer.data;for(let i=0;i<this.m_count;i++)this.m_flagsBuffer.data[i]&t.b2ParticleFlag.b2_wallParticle&&e[i].SetZero()}SolveRigid(e){const i=Zs.SolveRigid_s_position,n=Zs.SolveRigid_s_rotation,s=Zs.SolveRigid_s_transform,r=Zs.SolveRigid_s_velocityTransform,o=this.m_positionBuffer.data,a=this.m_velocityBuffer.data;for(let c=this.m_groupList;c;c=c.GetNext())if(c.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup){c.UpdateStatistics();const t=n;t.SetAngle(e.dt*c.m_angularVelocity);const l=xt.AddVV(c.m_center,xt.SubVV(xt.MulSV(e.dt,c.m_linearVelocity,xt.s_t0),Tt.MulRV(t,c.m_center,xt.s_t1),xt.s_t0),i),h=s;h.SetPositionRotation(l,t),Et.MulXX(h,c.m_transform,c.m_transform);const _=r;_.p.x=e.inv_dt*h.p.x,_.p.y=e.inv_dt*h.p.y,_.q.s=e.inv_dt*h.q.s,_.q.c=e.inv_dt*(h.q.c-1);for(let t=c.m_firstIndex;t<c.m_lastIndex;t++)Et.MulXV(_,o[t],a[t])}}SolveElastic(e){const i=Zs.SolveElastic_s_pa,n=Zs.SolveElastic_s_pb,s=Zs.SolveElastic_s_pc,r=Zs.SolveElastic_s_r,o=Zs.SolveElastic_s_t0,a=this.m_positionBuffer.data,c=this.m_velocityBuffer.data,l=e.inv_dt*this.m_def.elasticStrength;for(let h=0;h<this.m_triadBuffer.count;h++){const _=this.m_triadBuffer.data[h];if(_.flags&t.b2ParticleFlag.b2_elasticParticle){const t=_.indexA,h=_.indexB,u=_.indexC,d=_.pa,m=_.pb,p=_.pc,f=i.Copy(a[t]),g=n.Copy(a[h]),v=s.Copy(a[u]),y=c[t],x=c[h],S=c[u];f.SelfMulAdd(e.dt,y),g.SelfMulAdd(e.dt,x),v.SelfMulAdd(e.dt,S);const C=(f.x+g.x+v.x)/3,A=(f.y+g.y+v.y)/3;f.x-=C,f.y-=A,g.x-=C,g.y-=A,v.x-=C,v.y-=A;const b=r;b.s=xt.CrossVV(d,f)+xt.CrossVV(m,g)+xt.CrossVV(p,v),b.c=xt.DotVV(d,f)+xt.DotVV(m,g)+xt.DotVV(p,v);let T=ot(b.s*b.s+b.c*b.c);isFinite(T)||(T=198177537e11),b.s*=T,b.c*=T;const E=l*_.strength;Tt.MulRV(b,d,o),xt.SubVV(o,f,o),xt.MulSV(E,o,o),y.SelfAdd(o),Tt.MulRV(b,m,o),xt.SubVV(o,g,o),xt.MulSV(E,o,o),x.SelfAdd(o),Tt.MulRV(b,p,o),xt.SubVV(o,v,o),xt.MulSV(E,o,o),S.SelfAdd(o)}}}SolveSpring(e){const i=Zs.SolveSpring_s_pa,n=Zs.SolveSpring_s_pb,s=Zs.SolveSpring_s_d,r=Zs.SolveSpring_s_f,o=this.m_positionBuffer.data,a=this.m_velocityBuffer.data,c=e.inv_dt*this.m_def.springStrength;for(let l=0;l<this.m_pairBuffer.count;l++){const h=this.m_pairBuffer.data[l];if(h.flags&t.b2ParticleFlag.b2_springParticle){const t=h.indexA,l=h.indexB,_=i.Copy(o[t]),u=n.Copy(o[l]),d=a[t],m=a[l];_.SelfMulAdd(e.dt,d),u.SelfMulAdd(e.dt,m);const p=xt.SubVV(u,_,s),f=h.distance,g=p.Length(),v=c*h.strength,y=xt.MulSV(v*(f-g)/g,p,r);d.SelfSub(y),m.SelfAdd(y)}}}SolveTensile(e){const i=Zs.SolveTensile_s_weightedNormal,n=Zs.SolveTensile_s_s,s=Zs.SolveTensile_s_f,r=this.m_velocityBuffer.data;for(let t=0;t<this.m_count;t++)this.m_accumulation2Buffer[t]=new xt,this.m_accumulation2Buffer[t].SetZero();for(let e=0;e<this.m_contactBuffer.count;e++){const n=this.m_contactBuffer.data[e];if(n.flags&t.b2ParticleFlag.b2_tensileParticle){const t=n.indexA,e=n.indexB,s=n.weight,r=n.normal,o=xt.MulSV((1-s)*s,r,i);this.m_accumulation2Buffer[t].SelfSub(o),this.m_accumulation2Buffer[e].SelfAdd(o)}}const o=this.GetCriticalVelocity(e),a=this.m_def.surfaceTensionPressureStrength*o,c=this.m_def.surfaceTensionNormalStrength*o,l=R*o;for(let e=0;e<this.m_contactBuffer.count;e++){const i=this.m_contactBuffer.data[e];if(i.flags&t.b2ParticleFlag.b2_tensileParticle){const t=i.indexA,e=i.indexB,o=i.weight,h=i.normal,_=this.m_weightBuffer[t]+this.m_weightBuffer[e],u=xt.SubVV(this.m_accumulation2Buffer[e],this.m_accumulation2Buffer[t],n),d=tt(a*(_-2)+c*xt.DotVV(u,h),l)*o,m=xt.MulSV(d,h,s);r[t].SelfSub(m),r[e].SelfAdd(m)}}}SolveViscous(){const e=Zs.SolveViscous_s_v,i=Zs.SolveViscous_s_f,n=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.m_def.viscousStrength,o=this.GetParticleInvMass();for(let a=0;a<this.m_bodyContactBuffer.count;a++){const c=this.m_bodyContactBuffer.data[a],l=c.index;if(this.m_flagsBuffer.data[l]&t.b2ParticleFlag.b2_viscousParticle){const t=c.body,a=c.weight,h=c.mass,_=n[l],u=xt.SubVV(t.GetLinearVelocityFromWorldPoint(_,xt.s_t0),s[l],e),d=xt.MulSV(r*h*a,u,i);s[l].SelfMulAdd(o,d),t.ApplyLinearImpulse(d.SelfNeg(),_,!0)}}for(let n=0;n<this.m_contactBuffer.count;n++){const o=this.m_contactBuffer.data[n];if(o.flags&t.b2ParticleFlag.b2_viscousParticle){const t=o.indexA,n=o.indexB,a=o.weight,c=xt.SubVV(s[n],s[t],e),l=xt.MulSV(r*a,c,i);s[t].SelfAdd(l),s[n].SelfSub(l)}}}SolveRepulsive(e){const i=Zs.SolveRepulsive_s_f,n=this.m_velocityBuffer.data,s=this.m_def.repulsiveStrength*this.GetCriticalVelocity(e);for(let e=0;e<this.m_contactBuffer.count;e++){const r=this.m_contactBuffer.data[e];if(r.flags&t.b2ParticleFlag.b2_repulsiveParticle){const t=r.indexA,e=r.indexB;if(this.m_groupBuffer[t]!==this.m_groupBuffer[e]){const o=r.weight,a=r.normal,c=xt.MulSV(s*o,a,i);n[t].SelfSub(c),n[e].SelfAdd(c)}}}}SolvePowder(e){const i=Zs.SolvePowder_s_f,n=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.m_def.powderStrength*this.GetCriticalVelocity(e),o=1-P,a=this.GetParticleInvMass();for(let e=0;e<this.m_bodyContactBuffer.count;e++){const c=this.m_bodyContactBuffer.data[e],l=c.index;if(this.m_flagsBuffer.data[l]&t.b2ParticleFlag.b2_powderParticle){const t=c.weight;if(t>o){const e=c.body,h=c.mass,_=n[l],u=c.normal,d=xt.MulSV(r*h*(t-o),u,i);s[l].SelfMulSub(a,d),e.ApplyLinearImpulse(d,_,!0)}}}for(let e=0;e<this.m_contactBuffer.count;e++){const n=this.m_contactBuffer.data[e];if(n.flags&t.b2ParticleFlag.b2_powderParticle){const t=n.weight;if(t>o){const e=n.indexA,a=n.indexB,c=n.normal,l=xt.MulSV(r*(t-o),c,i);s[e].SelfSub(l),s[a].SelfAdd(l)}}}}SolveSolid(t){const e=Zs.SolveSolid_s_f,i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);const n=t.inv_dt*this.m_def.ejectionStrength;for(let t=0;t<this.m_contactBuffer.count;t++){const s=this.m_contactBuffer.data[t],r=s.indexA,o=s.indexB;if(this.m_groupBuffer[r]!==this.m_groupBuffer[o]){const t=s.weight,a=s.normal,c=this.m_depthBuffer[r]+this.m_depthBuffer[o],l=xt.MulSV(n*c*t,a,e);i[r].SelfSub(l),i[o].SelfAdd(l)}}}SolveForce(t){const e=this.m_velocityBuffer.data,i=t.dt*this.GetParticleInvMass();for(let t=0;t<this.m_count;t++)e[t].SelfMulAdd(i,this.m_forceBuffer[t]);this.m_hasForce=!1}SolveColorMixing(){const e=.5*this.m_def.colorMixingStrength;if(e)for(let i=0;i<this.m_contactBuffer.count;i++){const n=this.m_contactBuffer.data[i],s=n.indexA,r=n.indexB;if(this.m_flagsBuffer.data[s]&this.m_flagsBuffer.data[r]&t.b2ParticleFlag.b2_colorMixingParticle){const t=this.m_colorBuffer.data[s],i=this.m_colorBuffer.data[r];wt.MixColors(t,i,e)}}}SolveZombie(){let e=0;const i=[];for(let t=0;t<this.m_count;t++)i[t]=T;let n=0;for(let s=0;s<this.m_count;s++){const r=this.m_flagsBuffer.data[s];if(r&t.b2ParticleFlag.b2_zombieParticle){const e=this.m_world.m_destructionListener;if(r&t.b2ParticleFlag.b2_destructionListenerParticle&&e&&e.SayGoodbyeParticle(this,s),this.m_handleIndexBuffer.data){const t=this.m_handleIndexBuffer.data[s];t&&(t.SetIndex(T),this.m_handleIndexBuffer.data[s]=null)}i[s]=T}else{if(i[s]=e,s!==e){if(this.m_handleIndexBuffer.data){const t=this.m_handleIndexBuffer.data[s];t&&t.SetIndex(e),this.m_handleIndexBuffer.data[e]=t}this.m_flagsBuffer.data[e]=this.m_flagsBuffer.data[s],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=this.m_lastBodyContactStepBuffer.data[s]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=this.m_bodyContactCountBuffer.data[s]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=this.m_consecutiveContactStepsBuffer.data[s]),this.m_positionBuffer.data[e].Copy(this.m_positionBuffer.data[s]),this.m_velocityBuffer.data[e].Copy(this.m_velocityBuffer.data[s]),this.m_groupBuffer[e]=this.m_groupBuffer[s],this.m_hasForce&&this.m_forceBuffer[e].Copy(this.m_forceBuffer[s]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=this.m_staticPressureBuffer[s]),this.m_depthBuffer&&(this.m_depthBuffer[e]=this.m_depthBuffer[s]),this.m_colorBuffer.data&&this.m_colorBuffer.data[e].Copy(this.m_colorBuffer.data[s]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[e]=this.m_userDataBuffer.data[s]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[e]=this.m_expirationTimeBuffer.data[s])}e++,n|=r}}const s={IsProxyInvalid:t=>t.index<0,IsContactInvalid:t=>t.indexA<0||t.indexB<0,IsBodyContactInvalid:t=>t.index<0,IsPairInvalid:t=>t.indexA<0||t.indexB<0,IsTriadInvalid:t=>t.indexA<0||t.indexB<0||t.indexC<0};for(let t=0;t<this.m_proxyBuffer.count;t++){const e=this.m_proxyBuffer.data[t];e.index=i[e.index]}this.m_proxyBuffer.RemoveIf(s.IsProxyInvalid);for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t];e.indexA=i[e.indexA],e.indexB=i[e.indexB]}this.m_contactBuffer.RemoveIf(s.IsContactInvalid);for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t];e.index=i[e.index]}this.m_bodyContactBuffer.RemoveIf(s.IsBodyContactInvalid);for(let t=0;t<this.m_pairBuffer.count;t++){const e=this.m_pairBuffer.data[t];e.indexA=i[e.indexA],e.indexB=i[e.indexB]}this.m_pairBuffer.RemoveIf(s.IsPairInvalid);for(let t=0;t<this.m_triadBuffer.count;t++){const e=this.m_triadBuffer.data[t];e.indexA=i[e.indexA],e.indexB=i[e.indexB],e.indexC=i[e.indexC]}if(this.m_triadBuffer.RemoveIf(s.IsTriadInvalid),this.m_indexByExpirationTimeBuffer.data){let t=0;for(let e=0;e<this.m_count;e++){const n=i[this.m_indexByExpirationTimeBuffer.data[e]];n!==T&&(this.m_indexByExpirationTimeBuffer.data[t++]=n)}}for(let n=this.m_groupList;n;n=n.GetNext()){let s=e,r=0,o=!1;for(let t=n.m_firstIndex;t<n.m_lastIndex;t++){const e=i[t];e>=0?(s=tt(s,e),r=et(r,e+1)):o=!0}s<r?(n.m_firstIndex=s,n.m_lastIndex=r,o&&n.m_groupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SetGroupFlags(n,n.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth)):(n.m_firstIndex=0,n.m_lastIndex=0,n.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupCanBeEmpty||this.SetGroupFlags(n,n.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed))}this.m_count=e,this.m_allParticleFlags=n,this.m_needsUpdateAllParticleFlags=!1;for(let e=this.m_groupList;e;){const i=e.GetNext();e.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(e),e=i}}SolveLifetimes(t){this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);const e=this.GetQuantizedTimeElapsed(),i=this.m_expirationTimeBuffer.data,n=this.m_indexByExpirationTimeBuffer.data,s=this.GetParticleCount();this.m_expirationTimeBufferRequiresSorting&&(zs(n,0,s,((t,e)=>{const n=i[t],s=i[e],r=n<=0;return r===s<=0?n>s:r})),this.m_expirationTimeBufferRequiresSorting=!1);for(let t=s-1;t>=0;--t){const s=n[t],r=i[s];if(e<r||r<=0)break;this.DestroyParticle(s)}}RotateBuffer(t,e,i){if(t!==e&&e!==i){if(Hs(this.m_flagsBuffer.data,t,e,i),this.m_lastBodyContactStepBuffer.data&&Hs(this.m_lastBodyContactStepBuffer.data,t,e,i),this.m_bodyContactCountBuffer.data&&Hs(this.m_bodyContactCountBuffer.data,t,e,i),this.m_consecutiveContactStepsBuffer.data&&Hs(this.m_consecutiveContactStepsBuffer.data,t,e,i),Hs(this.m_positionBuffer.data,t,e,i),Hs(this.m_velocityBuffer.data,t,e,i),Hs(this.m_groupBuffer,t,e,i),this.m_hasForce&&Hs(this.m_forceBuffer,t,e,i),this.m_staticPressureBuffer&&Hs(this.m_staticPressureBuffer,t,e,i),this.m_depthBuffer&&Hs(this.m_depthBuffer,t,e,i),this.m_colorBuffer.data&&Hs(this.m_colorBuffer.data,t,e,i),this.m_userDataBuffer.data&&Hs(this.m_userDataBuffer.data,t,e,i),this.m_handleIndexBuffer.data){Hs(this.m_handleIndexBuffer.data,t,e,i);for(let e=t;e<i;++e){const t=this.m_handleIndexBuffer.data[e];t&&t.SetIndex(n(t.GetIndex()))}}if(this.m_expirationTimeBuffer.data){Hs(this.m_expirationTimeBuffer.data,t,e,i);const s=this.GetParticleCount(),r=this.m_indexByExpirationTimeBuffer.data;for(let t=0;t<s;++t)r[t]=n(r[t])}for(let t=0;t<this.m_proxyBuffer.count;t++){const e=this.m_proxyBuffer.data[t];e.index=n(e.index)}for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t];e.indexA=n(e.indexA),e.indexB=n(e.indexB)}for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t];e.index=n(e.index)}for(let t=0;t<this.m_pairBuffer.count;t++){const e=this.m_pairBuffer.data[t];e.indexA=n(e.indexA),e.indexB=n(e.indexB)}for(let t=0;t<this.m_triadBuffer.count;t++){const e=this.m_triadBuffer.data[t];e.indexA=n(e.indexA),e.indexB=n(e.indexB),e.indexC=n(e.indexC)}for(let t=this.m_groupList;t;t=t.GetNext())t.m_firstIndex=n(t.m_firstIndex),t.m_lastIndex=n(t.m_lastIndex-1)+1}function n(n){return n<t?n:n<e?n+i-e:n<i?n+t-e:n}}GetCriticalVelocity(t){return this.m_particleDiameter*t.inv_dt}GetCriticalVelocitySquared(t){const e=this.GetCriticalVelocity(t);return e*e}GetCriticalPressure(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)}GetParticleStride(){return P*this.m_particleDiameter}GetParticleMass(){const t=this.GetParticleStride();return this.m_def.density*t*t}GetParticleInvMass(){const t=this.m_inverseDiameter*(1/P);return this.m_inverseDensity*t*t}GetFixtureContactFilter(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetParticleContactFilter(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetFixtureContactListener(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}GetParticleContactListener(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}SetUserOverridableBuffer(t,e){t.data=e,t.userSuppliedCapacity=e.length}SetGroupFlags(e,i){const n=e.m_groupFlags;(n^i)&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(i|=t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth),n&~i&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&i&&(i&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=i),e.m_groupFlags=i}static BodyContactCompare(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index}RemoveSpuriousBodyContacts(){zs(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,Zs.BodyContactCompare);const t=Zs.RemoveSpuriousBodyContacts_s_n,e=Zs.RemoveSpuriousBodyContacts_s_pos,i=Zs.RemoveSpuriousBodyContacts_s_normal,n=3,s=this;let r=-1,o=0;const a=a=>{if(a.index!==r&&(o=0,r=a.index),o++>n)return!0;const c=t.Copy(a.normal);c.SelfMul(s.m_particleDiameter*(1-a.weight));const l=xt.AddVV(s.m_positionBuffer.data[a.index],c,e);if(!a.fixture.TestPoint(l)){const t=a.fixture.GetShape().GetChildCount();for(let e=0;e<t;e++){const t=i;if(a.fixture.ComputeDistance(l,t,e)<_)return!1}return!0}return!1};this.m_bodyContactBuffer.count=Gs(this.m_bodyContactBuffer.data,a,this.m_bodyContactBuffer.count)}DetectStuckParticle(t){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[t],2===this.m_bodyContactCountBuffer.data[t]&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp)}ValidateParticleIndex(t){return t>=0&&t<this.GetParticleCount()&&t!==T}GetQuantizedTimeElapsed(){return Math.floor(this.m_timeElapsed/4294967296)}LifetimeToExpirationTime(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)}ForceCanBeApplied(e){return!(e&t.b2ParticleFlag.b2_wallParticle)}PrepareForceBuffer(){if(!this.m_hasForce){for(let t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}}IsRigidGroup(e){return null!==e&&0!=(e.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup)}GetLinearVelocity(t,e,i,n){return t&&this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(i,n):n.Copy(this.m_velocityBuffer.data[e])}InitDampingParameter(t,e,i,n,s,r,o,a){t[0]=n>0?1/n:0,e[0]=s>0?1/s:0,i[0]=xt.CrossVV(xt.SubVV(o,r,xt.s_t0),a)}InitDampingParameterWithRigidGroupOrParticle(e,i,n,s,r,o,a,c){if(r&&s)this.InitDampingParameter(e,i,n,r.GetMass(),r.GetInertia(),r.GetCenter(),a,c);else{const s=this.m_flagsBuffer.data[o];this.InitDampingParameter(e,i,n,s&t.b2ParticleFlag.b2_wallParticle?0:this.GetParticleMass(),0,a,a,c)}}ComputeDampingImpulse(t,e,i,n,s,r,o){const a=t+e*i*i+n+s*r*r;return a>0?o/a:0}ApplyDamping(t,e,i,n,s,r,o,a){s&&n?(s.m_linearVelocity.SelfMulAdd(o*t,a),s.m_angularVelocity+=o*i*e):this.m_velocityBuffer.data[r].SelfMulAdd(o*t,a)}}Zs.xTruncBits=12,Zs.yTruncBits=12,Zs.tagBits=32,Zs.yOffset=1<<Zs.yTruncBits-1,Zs.yShift=Zs.tagBits-Zs.yTruncBits,Zs.xShift=Zs.tagBits-Zs.yTruncBits-Zs.xTruncBits,Zs.xScale=1<<Zs.xShift,Zs.xOffset=Zs.xScale*(1<<Zs.xTruncBits-1),Zs.yMask=(1<<Zs.yTruncBits)-1<<Zs.yShift,Zs.xMask=~Zs.yMask,Zs.DestroyParticlesInShape_s_aabb=new Se,Zs.CreateParticleGroup_s_transform=new Et,Zs.ComputeCollisionEnergy_s_v=new xt,Zs.QueryShapeAABB_s_aabb=new Se,Zs.QueryPointAABB_s_aabb=new Se,Zs.RayCast_s_aabb=new Se,Zs.RayCast_s_p=new xt,Zs.RayCast_s_v=new xt,Zs.RayCast_s_n=new xt,Zs.RayCast_s_point=new xt,Zs.k_pairFlags=t.b2ParticleFlag.b2_springParticle,Zs.k_triadFlags=t.b2ParticleFlag.b2_elasticParticle,Zs.k_noPressureFlags=t.b2ParticleFlag.b2_powderParticle|t.b2ParticleFlag.b2_tensileParticle,Zs.k_extraDampingFlags=t.b2ParticleFlag.b2_staticPressureParticle,Zs.k_barrierWallFlags=t.b2ParticleFlag.b2_barrierParticle|t.b2ParticleFlag.b2_wallParticle,Zs.CreateParticlesStrokeShapeForGroup_s_edge=new ln,Zs.CreateParticlesStrokeShapeForGroup_s_d=new xt,Zs.CreateParticlesStrokeShapeForGroup_s_p=new xt,Zs.CreateParticlesFillShapeForGroup_s_aabb=new Se,Zs.CreateParticlesFillShapeForGroup_s_p=new xt,Zs.UpdatePairsAndTriads_s_dab=new xt,Zs.UpdatePairsAndTriads_s_dbc=new xt,Zs.UpdatePairsAndTriads_s_dca=new xt,Zs.AddContact_s_d=new xt,Zs.UpdateBodyContacts_s_aabb=new Se,Zs.Solve_s_subStep=new ds,Zs.SolveCollision_s_aabb=new Se,Zs.SolveGravity_s_gravity=new xt,Zs.SolveBarrier_s_aabb=new Se,Zs.SolveBarrier_s_va=new xt,Zs.SolveBarrier_s_vb=new xt,Zs.SolveBarrier_s_pba=new xt,Zs.SolveBarrier_s_vba=new xt,Zs.SolveBarrier_s_vc=new xt,Zs.SolveBarrier_s_pca=new xt,Zs.SolveBarrier_s_vca=new xt,Zs.SolveBarrier_s_qba=new xt,Zs.SolveBarrier_s_qca=new xt,Zs.SolveBarrier_s_dv=new xt,Zs.SolveBarrier_s_f=new xt,Zs.SolvePressure_s_f=new xt,Zs.SolveDamping_s_v=new xt,Zs.SolveDamping_s_f=new xt,Zs.SolveRigidDamping_s_t0=new xt,Zs.SolveRigidDamping_s_t1=new xt,Zs.SolveRigidDamping_s_p=new xt,Zs.SolveRigidDamping_s_v=new xt,Zs.SolveExtraDamping_s_v=new xt,Zs.SolveExtraDamping_s_f=new xt,Zs.SolveRigid_s_position=new xt,Zs.SolveRigid_s_rotation=new Tt,Zs.SolveRigid_s_transform=new Et,Zs.SolveRigid_s_velocityTransform=new Et,Zs.SolveElastic_s_pa=new xt,Zs.SolveElastic_s_pb=new xt,Zs.SolveElastic_s_pc=new xt,Zs.SolveElastic_s_r=new Tt,Zs.SolveElastic_s_t0=new xt,Zs.SolveSpring_s_pa=new xt,Zs.SolveSpring_s_pb=new xt,Zs.SolveSpring_s_d=new xt,Zs.SolveSpring_s_f=new xt,Zs.SolveTensile_s_weightedNormal=new xt,Zs.SolveTensile_s_s=new xt,Zs.SolveTensile_s_f=new xt,Zs.SolveViscous_s_v=new xt,Zs.SolveViscous_s_f=new xt,Zs.SolveRepulsive_s_f=new xt,Zs.SolvePowder_s_f=new xt,Zs.SolveSolid_s_f=new xt,Zs.RemoveSpuriousBodyContacts_s_n=new xt,Zs.RemoveSpuriousBodyContacts_s_pos=new xt,Zs.RemoveSpuriousBodyContacts_s_normal=new xt;class Qs{constructor(){this._data=null,this.userSuppliedCapacity=0}get data(){return this._data}set data(t){this._data=t}}class tr{constructor(){this.index=T,this.tag=0}static CompareProxyProxy(t,e){return t.tag<e.tag}static CompareTagProxy(t,e){return t<e.tag}static CompareProxyTag(t,e){return t.tag<e}}class er{constructor(t,e,i,n,s){this.m_system=t,this.m_xLower=(e&Zs.xMask)>>>0,this.m_xUpper=(i&Zs.xMask)>>>0,this.m_yLower=(e&Zs.yMask)>>>0,this.m_yUpper=(i&Zs.yMask)>>>0,this.m_first=n,this.m_last=s}GetNext(){for(;this.m_first<this.m_last;){const t=(this.m_system.m_proxyBuffer.data[this.m_first].tag&Zs.xMask)>>>0;if(t>=this.m_xLower&&t<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return T}}class ir{constructor(){this.next=null,this.count=0,this.index=0}}class nr{Allocate(t,e){return e}Clear(){}GetCount(){return 0}Invalidate(t){}GetValidBuffer(){return[]}GetBuffer(){return[]}SetCount(t){}}class sr{constructor(t,e){this.second=T,this.first=t,this.second=e}}class rr extends nr{Initialize(t,e){}Find(t){return T}}class or{constructor(t,e){this.first=T,this.second=T,this.first=t,this.second=e}}class ar extends nr{Initialize(t,e){}Find(t){return T}}class cr{IsNecessary(t){return!0}ShouldCreatePair(t,e){return!0}ShouldCreateTriad(t,e,i){return!0}}class lr extends ls{constructor(t,e,i,n){super(),this.m_callDestructionListener=!1,this.m_destroyed=0,this.m_system=t,this.m_shape=e,this.m_xf=i,this.m_callDestructionListener=n,this.m_destroyed=0}ReportFixture(t){return!1}ReportParticle(t,e){return t===this.m_system&&(this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0)}Destroyed(){return this.m_destroyed}}class hr extends cr{constructor(t){super(),this.m_threshold=0,this.m_threshold=t}ShouldCreatePair(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t}ShouldCreateTriad(t,e,i){return(t<this.m_threshold||e<this.m_threshold||i<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=i)}}class _r extends on{constructor(e,i=e.length){super(t.b2ShapeType.e_unknown,0),this.m_shapeCount=0,this.m_shapes=e,this.m_shapeCount=i}Clone(){throw new Error}GetChildCount(){return 1}TestPoint(t,e){for(let i=0;i<this.m_shapeCount;i++)if(this.m_shapes[i].TestPoint(t,e))return!0;return!1}ComputeDistance(t,e,i,n){return 0}RayCast(t,e,i,n){return!1}ComputeAABB(t,e,i){const s=new Se;t.lowerBound.x=+n,t.lowerBound.y=+n,t.upperBound.x=-n,t.upperBound.y=-n;for(let i=0;i<this.m_shapeCount;i++){const n=this.m_shapes[i].GetChildCount();for(let r=0;r<n;r++){const n=s;this.m_shapes[i].ComputeAABB(n,e,r),t.Combine1(n)}}}ComputeMass(t,e){}SetupDistanceProxy(t,e){}ComputeSubmergedArea(t,e,i,n){return 0}Dump(t){}}class ur extends cr{constructor(t){super(),this.m_flagsBuffer=t}IsNecessary(e){return 0!=(this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_reactiveParticle)}}class dr extends qs{constructor(t,e=null){super(t),this.m_contactFilter=null,this.m_contactFilter=e}ShouldCollideFixtureParticle(e,i,n){return!(this.m_contactFilter&&this.m_system.GetFlagsBuffer()[n]&t.b2ParticleFlag.b2_fixtureContactFilterParticle)||this.m_contactFilter.ShouldCollideFixtureParticle(e,this.m_system,n)}ReportFixtureAndParticle(e,i,n){const s=dr.ReportFixtureAndParticle_s_n,r=dr.ReportFixtureAndParticle_s_rp,o=this.m_system.m_positionBuffer.data[n],a=s,c=e.ComputeDistance(o,a,i);if(c<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(e,this.m_system,n)){const i=e.GetBody(),s=i.GetWorldCenter(),l=i.GetMass(),h=i.GetInertia()-l*i.GetLocalCenter().LengthSquared(),_=l>0?1/l:0,u=h>0?1/h:0,d=this.m_system.m_flagsBuffer.data[n]&t.b2ParticleFlag.b2_wallParticle?0:this.m_system.GetParticleInvMass(),m=xt.SubVV(o,s,r),p=xt.CrossVV(m,a),f=d+_+u*p*p,g=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];g.index=n,g.body=i,g.fixture=e,g.weight=1-c*this.m_system.m_inverseDiameter,g.normal.Copy(a.SelfNeg()),g.mass=f>0?1/f:0,this.m_system.DetectStuckParticle(n)}}}dr.ReportFixtureAndParticle_s_n=new xt,dr.ReportFixtureAndParticle_s_rp=new xt;class mr extends qs{constructor(t,e){super(t),this.m_step=e}ReportFixtureAndParticle(e,i,n){const s=mr.ReportFixtureAndParticle_s_p1,r=mr.ReportFixtureAndParticle_s_output,o=mr.ReportFixtureAndParticle_s_input,a=mr.ReportFixtureAndParticle_s_p,c=mr.ReportFixtureAndParticle_s_v,l=mr.ReportFixtureAndParticle_s_f,h=e.GetBody(),u=this.m_system.m_positionBuffer.data[n],d=this.m_system.m_velocityBuffer.data[n],m=r,p=o;if(0===this.m_system.m_iterationIndex){const i=Et.MulTXV(h.m_xf0,u,s);e.GetShape().GetType()===t.b2ShapeType.e_circleShape&&(i.SelfSub(h.GetLocalCenter()),Tt.MulRV(h.m_xf0.q,i,i),Tt.MulTRV(h.m_xf.q,i,i),i.SelfAdd(h.GetLocalCenter())),Et.MulXV(h.m_xf,i,p.p1)}else p.p1.Copy(u);if(xt.AddVMulSV(u,this.m_step.dt,d,p.p2),p.maxFraction=1,e.RayCast(m,p,i)){const t=m.normal,e=a;e.x=(1-m.fraction)*p.p1.x+m.fraction*p.p2.x+_*t.x,e.y=(1-m.fraction)*p.p1.y+m.fraction*p.p2.y+_*t.y;const i=c;i.x=this.m_step.inv_dt*(e.x-u.x),i.y=this.m_step.inv_dt*(e.y-u.y),this.m_system.m_velocityBuffer.data[n].Copy(i);const s=l;s.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(d.x-i.x),s.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(d.y-i.y),this.m_system.ParticleApplyForce(n,s)}}ReportParticle(t,e){return!1}}mr.ReportFixtureAndParticle_s_p1=new xt,mr.ReportFixtureAndParticle_s_output=new xe,mr.ReportFixtureAndParticle_s_input=new ye,mr.ReportFixtureAndParticle_s_p=new xt,mr.ReportFixtureAndParticle_s_v=new xt,mr.ReportFixtureAndParticle_s_f=new xt;class pr{constructor(t){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new _s,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new xt,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new us,this.m_island=new bs,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(t)}SetDestructionListener(t){this.m_destructionListener=t}SetContactFilter(t){this.m_contactManager.m_contactFilter=t}SetContactListener(t){this.m_contactManager.m_contactListener=t}SetDebugDraw(t){this.m_debugDraw=t}CreateBody(t={}){if(this.IsLocked())throw new Error;const e=new fn(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e}DestroyBody(t){if(this.IsLocked())throw new Error;let e=t.m_jointList;for(;e;){const i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint),t.m_jointList=e}t.m_jointList=null;let i=t.m_controllerList;for(;i;){const e=i;i=i.nextController,e.controller.RemoveBody(t)}let n=t.m_contactList;for(;n;){const t=n;n=n.next,this.m_contactManager.Destroy(t.contact)}t.m_contactList=null;let s=t.m_fixtureList;for(;s;){const e=s;s=s.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(e),e.DestroyProxies(),e.Reset(),t.m_fixtureList=s,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}static _Joint_Create(e){switch(e.type){case t.b2JointType.e_distanceJoint:return new Cn(e);case t.b2JointType.e_mouseJoint:return new Mn(e);case t.b2JointType.e_prismaticJoint:return new Bn(e);case t.b2JointType.e_revoluteJoint:return new Vn(e);case t.b2JointType.e_pulleyJoint:return new Fn(e);case t.b2JointType.e_gearJoint:return new wn(e);case t.b2JointType.e_wheelJoint:return new Wn(e);case t.b2JointType.e_weldJoint:return new Hn(e);case t.b2JointType.e_frictionJoint:return new En(e);case t.b2JointType.e_ropeJoint:return new Un(e);case t.b2JointType.e_motorJoint:return new Rn(e);case t.b2JointType.e_areaJoint:return new bn(e)}throw new Error}static _Joint_Destroy(t){}CreateJoint(t){if(this.IsLocked())throw new Error;const e=pr._Joint_Create(t);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;const i=e.m_bodyA,n=e.m_bodyB;if(!e.m_collideConnected){let t=n.GetContactList();for(;t;)t.other===i&&t.contact.FlagForFiltering(),t=t.next}return e}DestroyJoint(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);const e=t.m_bodyA,i=t.m_bodyB,n=t.m_collideConnected;if(e.SetAwake(!0),i.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===e.m_jointList&&(e.m_jointList=t.m_edgeA.next),t.m_edgeA.Reset(),t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.Reset(),pr._Joint_Destroy(t),--this.m_jointCount,!n){let t=i.GetContactList();for(;t;)t.other===e&&t.contact.FlagForFiltering(),t=t.next}}CreateParticleSystem(t){if(this.IsLocked())throw new Error;const e=new Zs(t,this);return e.m_prev=null,e.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=e),this.m_particleSystemList=e,e}DestroyParticleSystem(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next)}CalculateReasonableParticleIterations(t){if(null===this.m_particleSystemList)return 1;function e(t){let e=n;for(let i=t.GetParticleSystemList();null!==i;i=i.m_next)e=tt(e,i.GetRadius());return e}return ws(this.m_gravity.Length(),e(this),t)}Step(t,e,i,n=this.CalculateReasonableParticleIterations(t)){const s=pr.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;const r=pr.Step_s_step;r.dt=t,r.velocityIterations=e,r.positionIterations=i,r.particleIterations=n,r.inv_dt=t>0?1/t:0,r.dtRatio=this.m_inv_dt0*t,r.warmStarting=this.m_warmStarting;const o=pr.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=o.GetMilliseconds(),this.m_stepComplete&&r.dt>0){const t=pr.Step_s_timer.Reset();for(let t=this.m_particleSystemList;t;t=t.m_next)t.Solve(r);this.Solve(r),this.m_profile.solve=t.GetMilliseconds()}if(this.m_continuousPhysics&&r.dt>0){const t=pr.Step_s_timer.Reset();this.SolveTOI(r),this.m_profile.solveTOI=t.GetMilliseconds()}r.dt>0&&(this.m_inv_dt0=r.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=s.GetMilliseconds()}ClearForces(){for(let t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0}DrawParticleSystem(t){if(null===this.m_debugDraw)return;const e=t.GetParticleCount();if(e){const i=t.GetRadius(),n=t.GetPositionBuffer();if(t.m_colorBuffer.data){const s=t.GetColorBuffer();this.m_debugDraw.DrawParticles(n,i,s,e)}else this.m_debugDraw.DrawParticles(n,i,null,e)}}DrawDebugData(){if(null===this.m_debugDraw)return;const e=this.m_debugDraw.GetFlags(),i=pr.DrawDebugData_s_color.SetRGB(0,0,0);if(e&t.b2DrawFlags.e_shapeBit)for(let e=this.m_bodyList;e;e=e.m_next){const n=e.m_xf;this.m_debugDraw.PushTransform(n);for(let n=e.GetFixtureList();n;n=n.m_next)e.IsActive()?e.GetType()===t.b2BodyType.b2_staticBody?(i.SetRGB(.5,.9,.5),this.DrawShape(n,i)):e.GetType()===t.b2BodyType.b2_kinematicBody?(i.SetRGB(.5,.5,.9),this.DrawShape(n,i)):e.IsAwake()?(i.SetRGB(.9,.7,.7),this.DrawShape(n,i)):(i.SetRGB(.6,.6,.6),this.DrawShape(n,i)):(i.SetRGB(.5,.5,.3),this.DrawShape(n,i));this.m_debugDraw.PopTransform(n)}if(e&t.b2DrawFlags.e_particleBit)for(let t=this.m_particleSystemList;t;t=t.m_next)this.DrawParticleSystem(t);if(e&t.b2DrawFlags.e_jointBit)for(let t=this.m_jointList;t;t=t.m_next)this.DrawJoint(t);if(e&t.b2DrawFlags.e_aabbBit){i.SetRGB(.9,.3,.9);const t=pr.DrawDebugData_s_vs;for(let e=this.m_bodyList;e;e=e.m_next)if(e.IsActive())for(let n=e.GetFixtureList();n;n=n.m_next)for(let e=0;e<n.m_proxyCount;++e){const s=n.m_proxies[e].treeNode.aabb;t[0].Set(s.lowerBound.x,s.lowerBound.y),t[1].Set(s.upperBound.x,s.lowerBound.y),t[2].Set(s.upperBound.x,s.upperBound.y),t[3].Set(s.lowerBound.x,s.upperBound.y),this.m_debugDraw.DrawPolygon(t,4,i)}}if(e&t.b2DrawFlags.e_centerOfMassBit)for(let t=this.m_bodyList;t;t=t.m_next){const e=pr.DrawDebugData_s_xf;e.q.Copy(t.m_xf.q),e.p.Copy(t.GetWorldCenter()),this.m_debugDraw.DrawTransform(e)}if(e&t.b2DrawFlags.e_controllerBit)for(let t=this.m_controllerList;t;t=t.m_next)t.Draw(this.m_debugDraw)}QueryAABB(...t){t[0]instanceof ls?this._QueryAABB(t[0],t[1]):this._QueryAABB(null,t[0],t[1])}_QueryAABB(t,e,i){if(this.m_contactManager.m_broadPhase.Query(e,(e=>{const n=e.userData.fixture;return t?t.ReportFixture(n):!i||i(n)})),t instanceof ls)for(let i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryAABB(t,e)}QueryAllAABB(t,e=[]){return this.QueryAABB(t,(t=>(e.push(t),!0))),e}QueryPointAABB(...t){t[0]instanceof ls?this._QueryPointAABB(t[0],t[1]):this._QueryPointAABB(null,t[0],t[1])}_QueryPointAABB(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(e=>{const n=e.userData.fixture;return t?t.ReportFixture(n):!i||i(n)})),t instanceof ls)for(let i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)}QueryAllPointAABB(t,e=[]){return this.QueryPointAABB(t,(t=>(e.push(t),!0))),e}QueryFixtureShape(...t){t[0]instanceof ls?this._QueryFixtureShape(t[0],t[1],t[2],t[3]):this._QueryFixtureShape(null,t[0],t[1],t[2],t[3])}_QueryFixtureShape(t,e,i,n,s){const r=pr.QueryFixtureShape_s_aabb;if(e.ComputeAABB(r,n,i),this.m_contactManager.m_broadPhase.Query(r,(r=>{const o=r.userData,a=o.fixture;if(Pe(e,i,a.GetShape(),o.childIndex,n,a.GetBody().GetTransform())){if(t)return t.ReportFixture(a);if(s)return s(a)}return!0})),t instanceof ls)for(let e=this.m_particleSystemList;e;e=e.m_next)t.ShouldQueryParticleSystem(e)&&e.QueryAABB(t,r)}QueryAllFixtureShape(t,e,i,n=[]){return this.QueryFixtureShape(t,e,i,(t=>(n.push(t),!0))),n}QueryFixturePoint(...t){t[0]instanceof ls?this._QueryFixturePoint(t[0],t[1]):this._QueryFixturePoint(null,t[0],t[1])}_QueryFixturePoint(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(n=>{const s=n.userData.fixture;if(s.TestPoint(e)){if(t)return t.ReportFixture(s);if(i)return i(s)}return!0})),t)for(let i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)}QueryAllFixturePoint(t,e=[]){return this.QueryFixturePoint(t,(t=>(e.push(t),!0))),e}RayCast(...t){t[0]instanceof hs?this._RayCast(t[0],t[1],t[2]):this._RayCast(null,t[0],t[1],t[2])}_RayCast(t,e,i,n){const s=pr.RayCast_s_input;if(s.maxFraction=1,s.p1.Copy(e),s.p2.Copy(i),this.m_contactManager.m_broadPhase.RayCast(s,((s,r)=>{const o=r.userData,a=o.fixture,c=o.childIndex,l=pr.RayCast_s_output;if(a.RayCast(l,s,c)){const s=l.fraction,r=pr.RayCast_s_point;if(r.Set((1-s)*e.x+s*i.x,(1-s)*e.y+s*i.y),t)return t.ReportFixture(a,r,l.normal,s);if(n)return n(a,r,l.normal,s)}return s.maxFraction})),t)for(let n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.RayCast(t,e,i)}RayCastOne(t,e){let i=null,n=1;return this.RayCast(t,e,((t,e,s,r)=>(r<n&&(n=r,i=t),n))),i}RayCastAll(t,e,i=[]){return this.RayCast(t,e,(t=>(i.push(t),1))),i}GetBodyList(){return this.m_bodyList}GetJointList(){return this.m_jointList}GetParticleSystemList(){return this.m_particleSystemList}GetContactList(){return this.m_contactManager.m_contactList}SetAllowSleeping(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(let t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}GetAllowSleeping(){return this.m_allowSleep}SetWarmStarting(t){this.m_warmStarting=t}GetWarmStarting(){return this.m_warmStarting}SetContinuousPhysics(t){this.m_continuousPhysics=t}GetContinuousPhysics(){return this.m_continuousPhysics}SetSubStepping(t){this.m_subStepping=t}GetSubStepping(){return this.m_subStepping}GetProxyCount(){return this.m_contactManager.m_broadPhase.GetProxyCount()}GetBodyCount(){return this.m_bodyCount}GetJointCount(){return this.m_jointCount}GetContactCount(){return this.m_contactManager.m_contactCount}GetTreeHeight(){return this.m_contactManager.m_broadPhase.GetTreeHeight()}GetTreeBalance(){return this.m_contactManager.m_broadPhase.GetTreeBalance()}GetTreeQuality(){return this.m_contactManager.m_broadPhase.GetTreeQuality()}SetGravity(t,e=!0){if(!xt.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(let t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}GetGravity(){return this.m_gravity}IsLocked(){return this.m_locked}SetAutoClearForces(t){this.m_clearForces=t}GetAutoClearForces(){return this.m_clearForces}ShiftOrigin(t){if(this.IsLocked())throw new Error;for(let e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(let e=this.m_jointList;e;e=e.m_next)e.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)}GetContactManager(){return this.m_contactManager}GetProfile(){return this.m_profile}Dump(e){if(this.m_locked)return;e("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),e("this.m_world.SetGravity(g);\n"),e("const bodies: b2Body[] = [];\n"),e("const joints: b2Joint[] = [];\n");let i=0;for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandIndex=i,t.Dump(e),++i;i=0;for(let t=this.m_jointList;t;t=t.m_next)t.m_index=i,++i;for(let i=this.m_jointList;i;i=i.m_next)i.m_type!==t.b2JointType.e_gearJoint&&(e("{\n"),i.Dump(e),e("}\n"));for(let i=this.m_jointList;i;i=i.m_next)i.m_type===t.b2JointType.e_gearJoint&&(e("{\n"),i.Dump(e),e("}\n"))}DrawJoint(e){if(null===this.m_debugDraw)return;const i=e.GetBodyA(),n=e.GetBodyB(),s=i.m_xf,r=n.m_xf,o=s.p,a=r.p,c=e.GetAnchorA(pr.DrawJoint_s_p1),l=e.GetAnchorB(pr.DrawJoint_s_p2),h=pr.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(e.m_type){case t.b2JointType.e_distanceJoint:this.m_debugDraw.DrawSegment(c,l,h);break;case t.b2JointType.e_pulleyJoint:{const t=e,i=t.GetGroundAnchorA(),n=t.GetGroundAnchorB();this.m_debugDraw.DrawSegment(i,c,h),this.m_debugDraw.DrawSegment(n,l,h),this.m_debugDraw.DrawSegment(i,n,h);break}case t.b2JointType.e_mouseJoint:{const t=pr.DrawJoint_s_c;t.Set(0,1,0),this.m_debugDraw.DrawPoint(c,4,t),this.m_debugDraw.DrawPoint(l,4,t),t.Set(.8,.8,.8),this.m_debugDraw.DrawSegment(c,l,t);break}default:this.m_debugDraw.DrawSegment(o,c,h),this.m_debugDraw.DrawSegment(c,l,h),this.m_debugDraw.DrawSegment(a,l,h)}}DrawShape(e,i){if(null===this.m_debugDraw)return;const n=e.GetShape();switch(n.m_type){case t.b2ShapeType.e_circleShape:{const t=n,e=t.m_p,s=t.m_radius,r=xt.UNITX;this.m_debugDraw.DrawSolidCircle(e,s,r,i);break}case t.b2ShapeType.e_edgeShape:{const t=n,e=t.m_vertex1,s=t.m_vertex2;this.m_debugDraw.DrawSegment(e,s,i);break}case t.b2ShapeType.e_chainShape:{const t=n,e=t.m_count,s=t.m_vertices,r=pr.DrawShape_s_ghostColor.SetRGBA(.75*i.r,.75*i.g,.75*i.b,i.a);let o=s[0];if(this.m_debugDraw.DrawPoint(o,4,i),t.m_hasPrevVertex){const e=t.m_prevVertex;this.m_debugDraw.DrawSegment(e,o,r),this.m_debugDraw.DrawCircle(e,.1,r)}for(let t=1;t<e;++t){const e=s[t];this.m_debugDraw.DrawSegment(o,e,i),this.m_debugDraw.DrawPoint(e,4,i),o=e}if(t.m_hasNextVertex){const e=t.m_nextVertex;this.m_debugDraw.DrawSegment(e,o,r),this.m_debugDraw.DrawCircle(e,.1,r)}break}case t.b2ShapeType.e_polygonShape:{const t=n,e=t.m_count,s=t.m_vertices;this.m_debugDraw.DrawSolidPolygon(s,e,i);break}}}Solve(e){for(let t=this.m_bodyList;t;t=t.m_next)t.m_xf0.Copy(t.m_xf);for(let t=this.m_controllerList;t;t=t.m_next)t.Step(e);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;const i=this.m_island;i.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_jointList;t;t=t.m_next)t.m_islandFlag=!1;const n=this.s_stack;for(let s=this.m_bodyList;s;s=s.m_next){if(s.m_islandFlag)continue;if(!s.IsAwake()||!s.IsActive())continue;if(s.GetType()===t.b2BodyType.b2_staticBody)continue;i.Clear();let r=0;for(n[r++]=s,s.m_islandFlag=!0;r>0;){const e=n[--r];if(!e)throw new Error;if(i.AddBody(e),e.m_awakeFlag=!0,e.GetType()!==t.b2BodyType.b2_staticBody){for(let t=e.m_contactList;t;t=t.next){const e=t.contact;if(e.m_islandFlag)continue;if(!e.IsEnabled()||!e.IsTouching())continue;const s=e.m_fixtureA.m_isSensor,o=e.m_fixtureB.m_isSensor;if(s||o)continue;i.AddContact(e),e.m_islandFlag=!0;const a=t.other;a.m_islandFlag||(n[r++]=a,a.m_islandFlag=!0)}for(let t=e.m_jointList;t;t=t.next){if(t.joint.m_islandFlag)continue;const e=t.other;e.IsActive()&&(i.AddJoint(t.joint),t.joint.m_islandFlag=!0,e.m_islandFlag||(n[r++]=e,e.m_islandFlag=!0))}}}const o=new us;i.Solve(o,e,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=o.solveInit,this.m_profile.solveVelocity+=o.solveVelocity,this.m_profile.solvePosition+=o.solvePosition;for(let e=0;e<i.m_bodyCount;++e){const n=i.m_bodies[e];n.GetType()===t.b2BodyType.b2_staticBody&&(n.m_islandFlag=!1)}}for(let t=0;t<n.length&&n[t];++t)n[t]=null;const s=new Dt;for(let e=this.m_bodyList;e;e=e.m_next)e.m_islandFlag&&e.GetType()!==t.b2BodyType.b2_staticBody&&e.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=s.GetMilliseconds()}SolveTOI(e){const i=this.m_island;if(i.Initialize(2*p,p,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1,t.m_sweep.alpha0=0;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_toiFlag=!1,t.m_islandFlag=!1,t.m_toiCount=0,t.m_toi=1}for(;;){let n=null,r=1;for(let e=this.m_contactManager.m_contactList;e;e=e.m_next){if(!e.IsEnabled())continue;if(e.m_toiCount>m)continue;let i=1;if(e.m_toiFlag)i=e.m_toi;else{const n=e.GetFixtureA(),s=e.GetFixtureB();if(n.IsSensor()||s.IsSensor())continue;const r=n.GetBody(),o=s.GetBody(),a=r.m_type,c=o.m_type,l=r.IsAwake()&&a!==t.b2BodyType.b2_staticBody,h=o.IsAwake()&&c!==t.b2BodyType.b2_staticBody;if(!l&&!h)continue;const _=r.IsBullet()||a!==t.b2BodyType.b2_dynamicBody,u=o.IsBullet()||c!==t.b2BodyType.b2_dynamicBody;if(!_&&!u)continue;let d=r.m_sweep.alpha0;r.m_sweep.alpha0<o.m_sweep.alpha0?(d=o.m_sweep.alpha0,r.m_sweep.Advance(d)):o.m_sweep.alpha0<r.m_sweep.alpha0&&(d=r.m_sweep.alpha0,o.m_sweep.Advance(d));const m=e.GetChildIndexA(),p=e.GetChildIndexB(),f=pr.SolveTOI_s_toi_input;f.proxyA.SetShape(n.GetShape(),m),f.proxyB.SetShape(s.GetShape(),p),f.sweepA.Copy(r.m_sweep),f.sweepB.Copy(o.m_sweep),f.tMax=1;const g=pr.SolveTOI_s_toi_output;ri(g,f);const v=g.t;i=g.state===t.b2TOIOutputState.e_touching?tt(d+(1-d)*v,1):1,e.m_toi=i,e.m_toiFlag=!0}i<r&&(n=e,r=i)}if(null===n||1-10*s<r){this.m_stepComplete=!0;break}const o=n.GetFixtureA(),a=n.GetFixtureB(),c=o.GetBody(),l=a.GetBody(),h=pr.SolveTOI_s_backup1.Copy(c.m_sweep),_=pr.SolveTOI_s_backup2.Copy(l.m_sweep);if(c.Advance(r),l.Advance(r),n.Update(this.m_contactManager.m_contactListener),n.m_toiFlag=!1,++n.m_toiCount,!n.IsEnabled()||!n.IsTouching()){n.SetEnabled(!1),c.m_sweep.Copy(h),l.m_sweep.Copy(_),c.SynchronizeTransform(),l.SynchronizeTransform();continue}c.SetAwake(!0),l.SetAwake(!0),i.Clear(),i.AddBody(c),i.AddBody(l),i.AddContact(n),c.m_islandFlag=!0,l.m_islandFlag=!0,n.m_islandFlag=!0;for(let e=0;e<2;++e){const n=0===e?c:l;if(n.m_type===t.b2BodyType.b2_dynamicBody)for(let e=n.m_contactList;e&&i.m_bodyCount!==i.m_bodyCapacity&&i.m_contactCount!==i.m_contactCapacity;e=e.next){const s=e.contact;if(s.m_islandFlag)continue;const o=e.other;if(o.m_type===t.b2BodyType.b2_dynamicBody&&!n.IsBullet()&&!o.IsBullet())continue;const a=s.m_fixtureA.m_isSensor,c=s.m_fixtureB.m_isSensor;if(a||c)continue;const l=pr.SolveTOI_s_backup.Copy(o.m_sweep);o.m_islandFlag||o.Advance(r),s.Update(this.m_contactManager.m_contactListener),s.IsEnabled()&&s.IsTouching()?(s.m_islandFlag=!0,i.AddContact(s),o.m_islandFlag||(o.m_islandFlag=!0,o.m_type!==t.b2BodyType.b2_staticBody&&o.SetAwake(!0),i.AddBody(o))):(o.m_sweep.Copy(l),o.SynchronizeTransform())}}const u=pr.SolveTOI_s_subStep;u.dt=(1-r)*e.dt,u.inv_dt=1/u.dt,u.dtRatio=1,u.positionIterations=20,u.velocityIterations=e.velocityIterations,u.particleIterations=e.particleIterations,u.warmStarting=!1,i.SolveTOI(u,c.m_islandIndex,l.m_islandIndex);for(let e=0;e<i.m_bodyCount;++e){const n=i.m_bodies[e];if(n.m_islandFlag=!1,n.m_type===t.b2BodyType.b2_dynamicBody){n.SynchronizeFixtures();for(let t=n.m_contactList;t;t=t.next)t.contact.m_toiFlag=!1,t.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}}AddController(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t}RemoveController(t){return t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList===t&&(this.m_controllerList=t.m_next),--this.m_controllerCount,t.m_prev=null,t.m_next=null,t}}pr.Step_s_step=new ds,pr.Step_s_stepTimer=new Dt,pr.Step_s_timer=new Dt,pr.DrawDebugData_s_color=new wt(0,0,0),pr.DrawDebugData_s_vs=xt.MakeArray(4),pr.DrawDebugData_s_xf=new Et,pr.QueryFixtureShape_s_aabb=new Se,pr.RayCast_s_input=new ye,pr.RayCast_s_output=new xe,pr.RayCast_s_point=new xt,pr.DrawJoint_s_p1=new xt,pr.DrawJoint_s_p2=new xt,pr.DrawJoint_s_color=new wt(.5,.8,.8),pr.DrawJoint_s_c=new wt,pr.DrawShape_s_ghostColor=new wt,pr.SolveTOI_s_subStep=new ds,pr.SolveTOI_s_backup=new Pt,pr.SolveTOI_s_backup1=new Pt,pr.SolveTOI_s_backup2=new Pt,pr.SolveTOI_s_toi_input=new We,pr.SolveTOI_s_toi_output=new Ye;class fr{constructor(t,e){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=e}}class gr{constructor(){this.m_bodyList=null,this.m_bodyCount=0,this.m_prev=null,this.m_next=null}GetNext(){return this.m_next}GetPrev(){return this.m_prev}GetBodyList(){return this.m_bodyList}AddBody(t){const e=new fr(this,t);e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList&&(this.m_bodyList.prevBody=e),this.m_bodyList=e,++this.m_bodyCount,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList&&(t.m_controllerList.prevController=e),t.m_controllerList=e,++t.m_controllerCount}RemoveBody(t){if(this.m_bodyCount<=0)throw new Error;let e=this.m_bodyList;for(;e&&e.body!==t;)e=e.nextBody;if(null===e)throw new Error;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),this.m_bodyList===e&&(this.m_bodyList=e.nextBody),--this.m_bodyCount,e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),t.m_controllerList===e&&(t.m_controllerList=e.nextController),--t.m_controllerCount}Clear(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body);this.m_bodyCount=0}}class vr extends gr{constructor(){super(...arguments),this.normal=new xt(0,1),this.offset=0,this.density=0,this.velocity=new xt(0,0),this.linearDrag=0,this.angularDrag=0,this.useDensity=!1,this.useWorldGravity=!0,this.gravity=new xt(0,0)}Step(t){if(this.m_bodyList){this.useWorldGravity&&this.gravity.Copy(this.m_bodyList.body.GetWorld().GetGravity());for(let t=this.m_bodyList;t;t=t.nextBody){const e=t.body;if(!e.IsAwake())continue;const i=new xt,n=new xt;let r=0,o=0;for(let t=e.GetFixtureList();t;t=t.m_next){const s=new xt,a=t.GetShape().ComputeSubmergedArea(this.normal,this.offset,e.GetTransform(),s);r+=a,i.x+=a*s.x,i.y+=a*s.y;let c=0;c=this.useDensity?t.GetDensity():1,o+=a*c,n.x+=a*s.x*c,n.y+=a*s.y*c}if(i.x/=r,i.y/=r,n.x/=o,n.y/=o,r<s)continue;const a=this.gravity.Clone().SelfNeg();a.SelfMul(this.density*r),e.ApplyForce(a,n);const c=e.GetLinearVelocityFromWorldPoint(i,new xt);c.SelfSub(this.velocity),c.SelfMul(-this.linearDrag*r),e.ApplyForce(c,i),e.ApplyTorque(-e.GetInertia()/e.GetMass()*r*e.GetAngularVelocity()*this.angularDrag)}}}Draw(t){const e=100,i=new xt,n=new xt;i.x=this.normal.x*this.offset+this.normal.y*e,i.y=this.normal.y*this.offset-this.normal.x*e,n.x=this.normal.x*this.offset-this.normal.y*e,n.y=this.normal.y*this.offset+this.normal.x*e;const s=new wt(0,0,.8);t.DrawSegment(i,n,s)}}class yr extends gr{constructor(){super(...arguments),this.A=new xt(0,0)}Step(t){const e=xt.MulSV(t.dt,this.A,yr.Step_s_dtA);for(let t=this.m_bodyList;t;t=t.nextBody){const i=t.body;i.IsAwake()&&i.SetLinearVelocity(xt.AddVV(i.GetLinearVelocity(),e,xt.s_t0))}}Draw(t){}}yr.Step_s_dtA=new xt;class xr extends gr{constructor(){super(...arguments),this.F=new xt(0,0)}Step(t){for(let t=this.m_bodyList;t;t=t.nextBody){const e=t.body;e.IsAwake()&&e.ApplyForce(this.F,e.GetWorldCenter())}}Draw(t){}}class Sr extends gr{constructor(){super(...arguments),this.G=1,this.invSqr=!0}Step(t){if(this.invSqr)for(let t=this.m_bodyList;t;t=t.nextBody){const e=t.body,i=e.GetWorldCenter(),n=e.GetMass();for(let r=this.m_bodyList;r&&r!==t;r=r.nextBody){const t=r.body,o=t.GetWorldCenter(),a=t.GetMass(),c=o.x-i.x,l=o.y-i.y,h=c*c+l*l;if(h<s)continue;const _=Sr.Step_s_f.Set(c,l);_.SelfMul(this.G/h/at(h)*n*a),e.IsAwake()&&e.ApplyForce(_,i),t.IsAwake()&&t.ApplyForce(_.SelfMul(-1),o)}}else for(let t=this.m_bodyList;t;t=t.nextBody){const e=t.body,i=e.GetWorldCenter(),n=e.GetMass();for(let r=this.m_bodyList;r&&r!==t;r=r.nextBody){const t=r.body,o=t.GetWorldCenter(),a=t.GetMass(),c=o.x-i.x,l=o.y-i.y,h=c*c+l*l;if(h<s)continue;const _=Sr.Step_s_f.Set(c,l);_.SelfMul(this.G/h*n*a),e.IsAwake()&&e.ApplyForce(_,i),t.IsAwake()&&t.ApplyForce(_.SelfMul(-1),o)}}}Draw(t){}}Sr.Step_s_f=new xt;class Cr extends gr{constructor(){super(...arguments),this.T=new At,this.maxTimestep=0}Step(t){let e=t.dt;if(!(e<=s)){e>this.maxTimestep&&this.maxTimestep>0&&(e=this.maxTimestep);for(let t=this.m_bodyList;t;t=t.nextBody){const i=t.body;if(!i.IsAwake())continue;const n=i.GetWorldVector(At.MulMV(this.T,i.GetLocalVector(i.GetLinearVelocity(),xt.s_t0),xt.s_t1),Cr.Step_s_damping);i.SetLinearVelocity(xt.AddVV(i.GetLinearVelocity(),xt.MulSV(e,n,xt.s_t0),xt.s_t1))}}}Draw(t){}SetAxisAligned(t,e){this.T.ex.x=-t,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-e,this.maxTimestep=t>0||e>0?1/et(t,e):0}}Cr.Step_s_damping=new xt;class Ar{constructor(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new xt(0,0),this.damping=.1,this.k2=.9,this.k3=.1}}class br{constructor(){this.m_count=0,this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_ims=[],this.m_Ls=[],this.m_as=[],this.m_gravity=new xt,this.m_damping=0,this.m_k2=1,this.m_k3=.1}GetVertexCount(){return this.m_count}GetVertices(){return this.m_ps}Initialize(t){this.m_count=t.count,this.m_ps=xt.MakeArray(this.m_count),this.m_p0s=xt.MakeArray(this.m_count),this.m_vs=xt.MakeArray(this.m_count),this.m_ims=K(this.m_count);for(let e=0;e<this.m_count;++e){this.m_ps[e].Copy(t.vertices[e]),this.m_p0s[e].Copy(t.vertices[e]),this.m_vs[e].SetZero();const i=t.masses[e];this.m_ims[e]=i>0?1/i:0}const e=this.m_count-1,i=this.m_count-2;this.m_Ls=K(e),this.m_as=K(i);for(let t=0;t<e;++t){const e=this.m_ps[t],i=this.m_ps[t+1];this.m_Ls[t]=xt.DistanceVV(e,i)}for(let t=0;t<i;++t){const e=this.m_ps[t],i=this.m_ps[t+1],n=this.m_ps[t+2],s=xt.SubVV(i,e,xt.s_t0),r=xt.SubVV(n,i,xt.s_t1),o=xt.CrossVV(s,r),a=xt.DotVV(s,r);this.m_as[t]=pt(o,a)}this.m_gravity.Copy(t.gravity),this.m_damping=t.damping,this.m_k2=t.k2,this.m_k3=t.k3}Step(t,e){if(0===t)return;const i=Math.exp(-t*this.m_damping);for(let e=0;e<this.m_count;++e)this.m_p0s[e].Copy(this.m_ps[e]),this.m_ims[e]>0&&this.m_vs[e].SelfMulAdd(t,this.m_gravity),this.m_vs[e].SelfMul(i),this.m_ps[e].SelfMulAdd(t,this.m_vs[e]);for(let t=0;t<e;++t)this.SolveC2(),this.SolveC3(),this.SolveC2();const n=1/t;for(let t=0;t<this.m_count;++t)xt.MulSV(n,xt.SubVV(this.m_ps[t],this.m_p0s[t],xt.s_t0),this.m_vs[t])}SolveC2(){const t=this.m_count-1;for(let e=0;e<t;++e){const t=this.m_ps[e],i=this.m_ps[e+1],n=xt.SubVV(i,t,br.s_d),s=n.Normalize(),r=this.m_ims[e],o=this.m_ims[e+1];if(r+o===0)continue;const a=r/(r+o),c=o/(r+o);t.SelfMulSub(this.m_k2*a*(this.m_Ls[e]-s),n),i.SelfMulAdd(this.m_k2*c*(this.m_Ls[e]-s),n)}}SetAngle(t){const e=this.m_count-2;for(let i=0;i<e;++i)this.m_as[i]=t}SolveC3(){const t=this.m_count-2;for(let e=0;e<t;++e){const t=this.m_ps[e],i=this.m_ps[e+1],n=this.m_ps[e+2],s=this.m_ims[e],r=this.m_ims[e+1],a=this.m_ims[e+2],c=xt.SubVV(i,t,br.s_d1),l=xt.SubVV(n,i,br.s_d2),h=c.LengthSquared(),_=l.LengthSquared();if(h*_==0)continue;const u=xt.CrossVV(c,l),d=xt.DotVV(c,l);let m=pt(u,d);const p=xt.MulSV(-1/h,c.SelfSkew(),br.s_Jd1),f=xt.MulSV(1/_,l.SelfSkew(),br.s_Jd2),g=xt.NegV(p,br.s_J1),v=xt.SubVV(p,f,br.s_J2),y=f;let x=s*xt.DotVV(g,g)+r*xt.DotVV(v,v)+a*xt.DotVV(y,y);if(0===x)continue;x=1/x;let S=m-this.m_as[e];for(;S>o;)m-=2*o,S=m-this.m_as[e];for(;S<-o;)m+=2*o,S=m-this.m_as[e];const C=-this.m_k3*x*S;t.SelfMulAdd(s*C,g),i.SelfMulAdd(r*C,v),n.SelfMulAdd(a*C,y)}}Draw(t){const e=new wt(.4,.5,.7);for(let i=0;i<this.m_count-1;++i)t.DrawSegment(this.m_ps[i],this.m_ps[i+1],e)}}br.s_d=new xt,br.s_d1=new xt,br.s_d2=new xt,br.s_Jd1=new xt,br.s_Jd2=new xt,br.s_J1=new xt,br.s_J2=new xt,t.b2AABB=Se,t.b2Abs=Q,t.b2Acos=dt,t.b2Alloc=z,t.b2AreaJoint=bn,t.b2AreaJointDef=An,t.b2Asin=mt,t.b2Assert=e,t.b2Atan2=pt,t.b2BlockAllocator=Bt,t.b2Body=fn,t.b2BodyDef=pn,t.b2BroadPhase=Ne,t.b2BuoyancyController=vr,t.b2CalculateParticleIterations=ws,t.b2ChainAndCircleContact=es,t.b2ChainAndPolygonContact=is,t.b2ChainShape=hn,t.b2CircleContact=Jn,t.b2CircleShape=an,t.b2Clamp=it,t.b2ClipSegmentToLine=Ae,t.b2ClipVertex=ve,t.b2CollideCircles=ci,t.b2CollideEdgeAndCircle=Wi,t.b2CollideEdgeAndPolygon=Qi,t.b2CollidePolygonAndCircle=ui,t.b2CollidePolygons=Li,t.b2Color=wt,t.b2ConstantAccelController=yr,t.b2ConstantForceController=xr,t.b2Contact=Kn,t.b2ContactEdge=Yn,t.b2ContactFactory=ss,t.b2ContactFeature=ue,t.b2ContactFilter=os,t.b2ContactID=de,t.b2ContactImpulse=as,t.b2ContactListener=cs,t.b2ContactManager=_s,t.b2ContactPositionConstraint=xs,t.b2ContactRegister=ns,t.b2ContactSolver=As,t.b2ContactSolverDef=Ss,t.b2ContactVelocityConstraint=ys,t.b2Controller=gr,t.b2ControllerEdge=fr,t.b2Cos=_t,t.b2Counter=Mt,t.b2DegToRad=lt,t.b2DestructionListener=rs,t.b2Distance=Qt,t.b2DistanceInput=zt,t.b2DistanceJoint=Cn,t.b2DistanceJointDef=Sn,t.b2DistanceOutput=Vt,t.b2DistanceProxy=Lt,t.b2Draw=Rt,t.b2DynamicTree=Re,t.b2EdgeAndCircleContact=Qn,t.b2EdgeAndPolygonContact=ts,t.b2EdgeShape=ln,t.b2Filter=_n,t.b2Fixture=mn,t.b2FixtureDef=un,t.b2FixtureParticleQueryCallback=qs,t.b2FixtureProxy=dn,t.b2Free=V,t.b2FrictionJoint=En,t.b2FrictionJointDef=Tn,t.b2GearJoint=wn,t.b2GearJointDef=Pn,t.b2GetPointStates=ge,t.b2GravityController=Sr,t.b2GrowableBuffer=Ws,t.b2GrowableStack=Ot,t.b2InvSqrt=ot,t.b2IsPowerOfTwo=gt,t.b2IsValid=st,t.b2Island=bs,t.b2Jacobian=gn,t.b2Joint=xn,t.b2JointDef=yn,t.b2JointEdge=vn,t.b2Log=G,t.b2MakeArray=X,t.b2MakeNullArray=Y,t.b2MakeNumberArray=K,t.b2Manifold=pe,t.b2ManifoldPoint=me,t.b2MassData=tn,t.b2Mat22=At,t.b2Mat33=bt,t.b2Max=et,t.b2Maybe=i,t.b2Min=tt,t.b2MixFriction=qn,t.b2MixRestitution=Xn,t.b2MotorJoint=Rn,t.b2MotorJointDef=In,t.b2MouseJoint=Mn,t.b2MouseJointDef=Dn,t.b2NextPowerOfTwo=ft,t.b2Pair=Be,t.b2PairLessThan=Le,t.b2ParseInt=W,t.b2ParseUInt=q,t.b2ParticleBodyContact=Ys,t.b2ParticleContact=Xs,t.b2ParticleDef=Ps,t.b2ParticleGroup=Ds,t.b2ParticleGroupDef=Rs,t.b2ParticleHandle=Is,t.b2ParticlePair=Ks,t.b2ParticlePairSet=ar,t.b2ParticleSystem=Zs,t.b2ParticleSystemDef=$s,t.b2ParticleSystem_CompositeShape=_r,t.b2ParticleSystem_ConnectionFilter=cr,t.b2ParticleSystem_DestroyParticlesInShapeCallback=lr,t.b2ParticleSystem_FixedSetAllocator=nr,t.b2ParticleSystem_FixtureParticle=sr,t.b2ParticleSystem_FixtureParticleSet=rr,t.b2ParticleSystem_InsideBoundsEnumerator=er,t.b2ParticleSystem_JoinParticleGroupsFilter=hr,t.b2ParticleSystem_ParticleListNode=ir,t.b2ParticleSystem_ParticlePair=or,t.b2ParticleSystem_Proxy=tr,t.b2ParticleSystem_ReactiveFilter=ur,t.b2ParticleSystem_SolveCollisionCallback=mr,t.b2ParticleSystem_UpdateBodyContactsCallback=dr,t.b2ParticleSystem_UserOverridableBuffer=Qs,t.b2ParticleTriad=Js,t.b2PolygonAndCircleContact=Zn,t.b2PolygonContact=$n,t.b2PolygonShape=cn,t.b2Position=ms,t.b2PositionSolverManifold=Cs,t.b2Pow=ct,t.b2PrismaticJoint=Bn,t.b2PrismaticJointDef=On,t.b2Profile=us,t.b2PulleyJoint=Fn,t.b2PulleyJointDef=Ln,t.b2QueryCallback=ls,t.b2RadToDeg=ht,t.b2Random=vt,t.b2RandomRange=yt,t.b2RayCastCallback=hs,t.b2RayCastInput=ye,t.b2RayCastOutput=xe,t.b2RevoluteJoint=Vn,t.b2RevoluteJointDef=zn,t.b2Rope=br,t.b2RopeDef=Ar,t.b2RopeJoint=Un,t.b2RopeJointDef=Gn,t.b2Rot=Tt,t.b2SeparationFunction=Ke,t.b2Shape=on,t.b2ShapeCast=ce,t.b2ShapeCastInput=Gt,t.b2ShapeCastOutput=Ut,t.b2Simplex=jt,t.b2SimplexCache=Ft,t.b2SimplexVertex=Ht,t.b2Sin=ut,t.b2SolverData=fs,t.b2Sq=rt,t.b2Sqrt=at,t.b2StackAllocator=Nt,t.b2Swap=nt,t.b2Sweep=Pt,t.b2TOIInput=We,t.b2TOIOutput=Ye,t.b2TensorDampingController=Cr,t.b2TestOverlapAABB=Ce,t.b2TestOverlapShape=Pe,t.b2TimeOfImpact=ri,t.b2TimeStep=ds,t.b2Timer=Dt,t.b2Transform=Et,t.b2TreeNode=Ie,t.b2Vec2=xt,t.b2Vec2_zero=St,t.b2Vec3=Ct,t.b2Velocity=ps,t.b2VelocityConstraintPoint=vs,t.b2Version=U,t.b2WeldJoint=Hn,t.b2WeldJointDef=kn,t.b2WheelJoint=Wn,t.b2WheelJointDef=jn,t.b2World=pr,t.b2WorldManifold=fe,t.b2_180_over_pi=$,t.b2_aabbExtension=l,t.b2_aabbMultiplier=h,t.b2_angularSleepTolerance=F,t.b2_angularSlop=u,t.b2_barrierCollisionTime=B,t.b2_baumgarte=A,t.b2_branch=H,t.b2_commit=j,t.b2_epsilon=s,t.b2_epsilon_sq=r,t.b2_gjk_reset=kt,t.b2_invalidParticleIndex=T,t.b2_linearSleepTolerance=L,t.b2_linearSlop=_,t.b2_maxAngularCorrection=v,t.b2_maxFloat=n,t.b2_maxLinearCorrection=g,t.b2_maxManifoldPoints=a,t.b2_maxParticleForce=R,t.b2_maxParticleIndex=E,t.b2_maxParticlePressure=I,t.b2_maxPolygonVertices=c,t.b2_maxRotation=S,t.b2_maxRotationSquared=C,t.b2_maxSubSteps=m,t.b2_maxTOIContacts=p,t.b2_maxTranslation=y,t.b2_maxTranslationSquared=x,t.b2_maxTriadDistance=D,t.b2_maxTriadDistanceSquared=M,t.b2_minParticleSystemBufferCapacity=O,t.b2_minParticleWeight=w,t.b2_minPulleyLength=Nn,t.b2_particleStride=P,t.b2_pi=o,t.b2_pi_over_180=J,t.b2_polygonRadius=d,t.b2_timeToSleep=N,t.b2_toiBaumgarte=b,t.b2_toi_reset=Fe,t.b2_two_pi=Z,t.b2_velocityThreshold=f,t.b2_version=k,t.g_blockSolve=gs,Object.defineProperty(t,"__esModule",{value:!0})}(e)}(e={exports:{}},e.exports),e.exports}();(_6=u6)&&_6.__esModule&&Object.prototype.hasOwnProperty.call(_6,"default")&&_6.default;let d6={};for(var m6 in u6)-1===m6.indexOf("b2_")&&(d6[m6.replace("b2","")]=u6[m6]);var p6=d6;let f6,g6,v6,y6,x6;!function(t){t[t.Static=0]="Static",t[t.Kinematic=1]="Kinematic",t[t.Dynamic=2]="Dynamic",t[t.Animated=3]="Animated"}(f6||(f6=t("ERigidBody2DType",{}))),jt(f6),function(t){t[t.None=0]="None",t[t.BOX=1]="BOX",t[t.CIRCLE=2]="CIRCLE",t[t.POLYGON=3]="POLYGON"}(g6||(g6=t("ECollider2DType",{}))),jt(g6),function(t){t[t.None=0]="None",t[t.DISTANCE=1]="DISTANCE",t[t.SPRING=2]="SPRING",t[t.WHEEL=3]="WHEEL",t[t.MOUSE=4]="MOUSE",t[t.FIXED=5]="FIXED",t[t.SLIDER=6]="SLIDER",t[t.RELATIVE=7]="RELATIVE",t[t.HINGE=8]="HINGE"}(v6||(v6=t("EJoint2DType",{}))),jt(v6),function(t){t[t.DEFAULT=1]="DEFAULT"}(y6||(y6=t("PhysicsGroup",{}))),jt(y6),function(t){t[t.Closest=0]="Closest",t[t.Any=1]="Any",t[t.AllClosest=2]="AllClosest",t[t.All=3]="All"}(x6||(x6=t("ERaycast2DType",{})));const S6=t("Contact2DType",{None:"none-contact",BEGIN_CONTACT:"begin-contact",END_CONTACT:"end-contact",PRE_SOLVE:"pre-solve",POST_SOLVE:"post-solve"});let C6;!function(t){t[t.None=0]="None",t[t.Shape=1]="Shape",t[t.Joint=2]="Joint",t[t.Aabb=4]="Aabb",t[t.Pair=8]="Pair",t[t.CenterOfMass=16]="CenterOfMass",t[t.Particle=32]="Particle",t[t.Controller=64]="Controller",t[t.All=63]="All"}(C6||(C6=t("EPhysics2DDrawFlags",{})));const A6=t("PHYSICS_2D_PTM_RATIO",32);class b6 extends p6.ContactListener{constructor(...t){super(...t),this._contactFixtures=[],this._BeginContact=null,this._EndContact=null,this._PreSolve=null,this._PostSolve=null}setBeginContact(t){this._BeginContact=t}setEndContact(t){this._EndContact=t}setPreSolve(t){this._PreSolve=t}setPostSolve(t){this._PostSolve=t}BeginContact(t){if(!this._BeginContact)return;const e=t.GetFixtureA(),i=t.GetFixtureB(),n=this._contactFixtures;t._shouldReport=!1,-1===n.indexOf(e)&&-1===n.indexOf(i)||(t._shouldReport=!0,this._BeginContact(t))}EndContact(t){this._EndContact&&t._shouldReport&&(t._shouldReport=!1,this._EndContact(t))}PreSolve(t,e){this._PreSolve&&t._shouldReport&&this._PreSolve(t,e)}PostSolve(t,e){this._PostSolve&&t._shouldReport&&this._PostSolve(t,e)}registerContactFixture(t){this._contactFixtures.push(t)}unregisterContactFixture(t){$(this._contactFixtures,t)}}class T6 extends p6.QueryCallback{constructor(...t){super(...t),this._point=new p6.Vec2,this._isPoint=!1,this._fixtures=[]}init(t){t?(this._isPoint=!0,this._point.x=t.x,this._point.y=t.y):this._isPoint=!1,this._fixtures.length=0}ReportFixture(t){return this._isPoint?t.TestPoint(this._point)&&this._fixtures.push(t):this._fixtures.push(t),!0}getFixture(){return this._fixtures[0]}getFixtures(){return this._fixtures}}function E6(t,e){const i=e.length;return e[t<0?i- -t%i:t%i]}function P6(t,e,i){const n=[];for(;e<t;)e+=i.length;for(;t<=e;++t)n.push(E6(t,i));return n}function w6(t){L6(t);let e,i,n,s,r,o,a=[],c=new Oi,l=new Oi,h=0,_=0;for(let u=0;u<t.length;++u)if(R6(u,t)){i=n=1e8;for(let r=0;r<t.length;++r)M6(E6(u-1,t),E6(u,t),E6(r,t))&&B6(E6(u-1,t),E6(u,t),E6(r-1,t))&&(s=z6(E6(u-1,t),E6(u,t),E6(r,t),E6(r-1,t)),D6(E6(u+1,t),E6(u,t),s)&&(e=N6(E6(u,t),s),e<i&&(i=e,c=s,h=r))),M6(E6(u+1,t),E6(u,t),E6(r+1,t))&&B6(E6(u+1,t),E6(u,t),E6(r,t))&&(s=z6(E6(u+1,t),E6(u,t),E6(r,t),E6(r+1,t)),M6(E6(u-1,t),E6(u,t),s)&&(e=N6(E6(u,t),s),e<n&&(n=e,_=r,l=s)));if(h==(_+1)%t.length){const e=c.add(l).multiplyScalar(.5);r=P6(u,_,t),r.push(e),o=P6(h,u,t),o.push(e)}else{let e=0,i=h;for(;_<h;)_+=t.length;for(let n=h;n<=_;++n)if(I6(u,n,t)){let s=1/(N6(E6(u,t),E6(n,t))+1);R6(n,t)?B6(E6(n-1,t),E6(n,t),E6(u,t))&&O6(E6(n+1,t),E6(n,t),E6(u,t))?s+=3:s+=2:s+=1,s>e&&(i=n,e=s)}r=P6(u,i,t),o=P6(i,u,t)}return a=a.concat(w6(r)),a=a.concat(w6(o)),a}a.push(t);for(let t=a.length-1;t>=0;t--)0==a[t].length&&a.splice(t,0);return a}function I6(t,e,i){if(R6(t,i)){if(O6(E6(t,i),E6(t-1,i),E6(e,i))&&B6(E6(t,i),E6(t+1,i),E6(e,i)))return!1}else if(B6(E6(t,i),E6(t+1,i),E6(e,i))||O6(E6(t,i),E6(t-1,i),E6(e,i)))return!1;if(R6(e,i)){if(O6(E6(e,i),E6(e-1,i),E6(t,i))&&B6(E6(e,i),E6(e+1,i),E6(t,i)))return!1}else if(B6(E6(e,i),E6(e+1,i),E6(t,i))||O6(E6(e,i),E6(e-1,i),E6(t,i)))return!1;for(let n=0;n<i.length;++n){if((n+1)%i.length==t||n==t||(n+1)%i.length==e||n==e)continue;const s=new Oi;if(V6(E6(t,i),E6(e,i),E6(n,i),E6(n+1,i),s))return!1}return!0}function R6(t,e){return D6(t,e)}function D6(t,e,i){if(void 0===i){const n=t,s=e;t=E6(n-1,s),e=E6(n,s),i=E6(n+1,s)}return G6(t,e,i)<0}function M6(t,e,i){return G6(t,e,i)>0}function O6(t,e,i){return G6(t,e,i)>=0}function B6(t,e,i){return G6(t,e,i)<=0}function N6(t,e){const i=e.x-t.x,n=e.y-t.y;return i*i+n*n}function L6(t){F6(t)||t.reverse()}function F6(t){return t.length<3||function(t){let e,i=0;for(e=0;e<t.length;e++){const n=(e+1)%t.length;i+=t[e].x*t[n].y,i-=t[e].y*t[n].x}return i/=2,i}(t)>0}function z6(t,e,i,n){const s=new Oi,r=e.y-t.y,o=t.x-e.x,a=r*t.x+o*t.y,c=n.y-i.y,l=i.x-n.x,h=c*i.x+l*i.y,_=r*l-c*o;var u;return u=_,0,Math.abs(u-0)<=1e-6||(s.x=(l*a-o*h)/_,s.y=(r*h-c*a)/_),s}function V6(t,e,i,n,s){if(t==i||t==n||e==i||e==n)return!1;const r=t.x,o=t.y,a=e.x,c=e.y,l=i.x,h=i.y,_=n.x,u=n.y;if(Math.max(r,a)<Math.min(l,_)||Math.max(l,_)<Math.min(r,a))return!1;if(Math.max(o,c)<Math.min(h,u)||Math.max(h,u)<Math.min(o,c))return!1;let d=(_-l)*(o-h)-(u-h)*(r-l),m=(a-r)*(o-h)-(c-o)*(r-l);const p=(u-h)*(a-r)-(_-l)*(c-o);return!(Math.abs(p)<1e-6)&&(d/=p,m/=p,d>0&&d<1&&m>0&&m<1&&(s.x=r+d*(a-r),s.y=o+d*(c-o),!0))}function G6(t,e,i){return t.x*(e.y-i.y)+e.x*(i.y-t.y)+i.x*(t.y-e.y)}var U6=Object.freeze({__proto__:null,ConvexPartition:w6,ForceCounterClockWise:L6,IsCounterClockWise:F6});const k6=()=>0,H6={impl:null,rigidBody:null,isAwake:!1,isSleeping:!1,initialize:k6,setType:k6,setLinearDamping:k6,setAngularDamping:k6,setGravityScale:k6,setFixedRotation:k6,setAllowSleep:k6,isActive:k6,setActive:k6,wakeUp:k6,sleep:k6,getMass:k6,getInertia:k6,getLinearVelocity:k6,setLinearVelocity:k6,getLinearVelocityFromWorldPoint:k6,getAngularVelocity:k6,setAngularVelocity:k6,getLocalVector:k6,getWorldVector:k6,getLocalPoint:k6,getWorldPoint:k6,getLocalCenter:k6,getWorldCenter:k6,applyForce:k6,applyForceToCenter:k6,applyTorque:k6,applyLinearImpulse:k6,applyLinearImpulseToCenter:k6,applyAngularImpulse:k6,onEnable:k6,onDisable:k6,onDestroy:k6},j6={INITED:!1};const W6={INITED:!1},q6={impl:null,initialize:k6,setDampingRatio:k6,setFrequency:k6,setMaxForce:k6,setTarget:k6,setDistance:k6,setAngularOffset:k6,setCorrectionFactor:k6,setLinearOffset:k6,setMaxLength:k6,setMaxTorque:k6,setLowerLimit:k6,setUpperLimit:k6,setMaxMotorForce:k6,setMaxMotorTorque:k6,setMotorSpeed:k6,enableLimit:k6,enableMotor:k6,setLowerAngle:k6,setUpperAngle:k6};let X6,Y6,K6,J6,$6,Z6;!function(t){t[t.DYNAMIC=1]="DYNAMIC",t[t.STATIC=2]="STATIC",t[t.KINEMATIC=4]="KINEMATIC"}(X6||(X6={})),jt(X6),function(t){t[t.X_AXIS=0]="X_AXIS",t[t.Y_AXIS=1]="Y_AXIS",t[t.Z_AXIS=2]="Z_AXIS"}(Y6||(Y6={})),jt(Y6),function(t){t[t.VERTEX=1]="VERTEX",t[t.LINE=2]="LINE",t[t.TRIANGLE=3]="TRIANGLE",t[t.TETRAHEDRON=4]="TETRAHEDRON"}(K6||(K6={})),jt(K6),function(t){t[t.BOX=0]="BOX",t[t.SPHERE=1]="SPHERE",t[t.CAPSULE=2]="CAPSULE",t[t.CYLINDER=3]="CYLINDER",t[t.CONE=4]="CONE",t[t.MESH=5]="MESH",t[t.PLANE=6]="PLANE",t[t.SIMPLEX=7]="SIMPLEX",t[t.TERRAIN=8]="TERRAIN"}(J6||(J6={})),jt(J6),function(t){t[t.POINT_TO_POINT=0]="POINT_TO_POINT",t[t.HINGE=1]="HINGE",t[t.CONE_TWIST=2]="CONE_TWIST"}($6||($6={})),jt($6),function(t){t[t.DEFAULT=1]="DEFAULT"}(Z6||(Z6={})),jt(Z6);class Q6{constructor(t){if(1===t){const t=this;for(let e=0;e<32;e++){const i="_"+(1<<e);t[i]=0,t.updateArray=[],Object.defineProperty(t,1<<e,{get(){return this[i]},set(t){this[i]!==t&&(this[i]=t,this.updateArray.indexOf(e)<0&&this.updateArray.push(e))}})}this._1=Z6.DEFAULT}else{for(let t=0;t<32;t++)this[""+(1<<t)]=0;this[1]=Z6.DEFAULT}}}let t8,e8=null;l.internal.PhysicsGroup2D=y6;class i8 extends(kl(ew)){get enable(){return this._enable}set enable(t){this._enable=t}get allowSleep(){return this._allowSleep}set allowSleep(t){this._allowSleep=t,this.physicsWorld.setAllowSleep(t)}get gravity(){return this._gravity}set gravity(t){this._gravity.set(t),this.physicsWorld.setGravity(new Oi(t.x/A6,t.y/A6))}get maxSubSteps(){return this._maxSubSteps}set maxSubSteps(t){this._maxSubSteps=t}get fixedTimeStep(){return this._fixedTimeStep}set fixedTimeStep(t){this._fixedTimeStep=t}get autoSimulation(){return this._autoSimulation}set autoSimulation(t){this._autoSimulation=t}get debugDrawFlags(){return this.physicsWorld.debugDrawFlags}set debugDrawFlags(t){this.physicsWorld.debugDrawFlags=t}static get PHYSICS_NONE(){return!h6}static get PHYSICS_BUILTIN(){return"builtin"===h6}static get PHYSICS_BOX2D(){return"box2d"===h6}static get PhysicsGroup(){return y6}static get instance(){return e8||(e8=new i8),e8}get stepping(){return this._steping}constructor(){super(),this.velocityIterations=10,this.positionIterations=10,this.physicsWorld=void 0,this.collisionMatrix=new Q6,this._enable=!0,this._allowSleep=!0,this._maxSubSteps=1,this._fixedTimeStep=1/60,this._autoSimulation=!0,this._accumulator=0,this._steping=!1,this._gravity=new Oi(0,-10*A6),this._delayEvents=[];const t=uw.config?uw.config.physics:null;if(t){if(Oi.copy(this._gravity,t.gravity),this._gravity.multiplyScalar(A6),this._allowSleep=t.allowSleep,this._fixedTimeStep=t.fixedTimeStep,this._maxSubSteps=t.maxSubSteps,this._autoSimulation=t.autoSimulation,t.collisionMatrix)for(const e in t.collisionMatrix){const i=parseInt(e),n=1<<parseInt(e);this.collisionMatrix[`${n}`]=t.collisionMatrix[i]}if(t.collisionGroups){const e=t.collisionGroups;e instanceof Array&&(e.forEach((t=>{y6[t.name]=1<<t.index})),jt.update(y6))}}this.physicsWorld=new l6.PhysicsWorld,this.gravity=this._gravity,this.allowSleep=this._allowSleep}postUpdate(t){if(!this._enable)return;if(!this._autoSimulation)return;mw.emit(dw.EVENT_BEFORE_PHYSICS),this._steping=!0;const e=this._fixedTimeStep,i=this.velocityIterations,n=this.positionIterations;this._accumulator+=t;let s=0;for(;s++<this._maxSubSteps&&this._accumulator>e;)this.physicsWorld.step(e,i,n),this._accumulator-=e;const r=this._delayEvents;for(let t=0,e=r.length;t<e;t++){const e=r[t];e.func.call(e.target)}r.length=0,this.physicsWorld.syncPhysicsToScene(),this.debugDrawFlags&&this.physicsWorld.drawDebug(),this._steping=!1,mw.emit(dw.EVENT_AFTER_PHYSICS)}_callAfterStep(t,e){this._steping?this._delayEvents.push({target:t,func:e}):e.call(t)}resetAccumulator(t=0){this._accumulator=t}step(t){this.physicsWorld.step(t,this.velocityIterations,this.positionIterations)}raycast(t,e,i=x6.Closest,n=4294967295){return this.physicsWorld.raycast(t,e,i,n)}testPoint(t){return this.physicsWorld.testPoint(t)}testAABB(t){return this.physicsWorld.testAABB(t)}}var n8,s8,r8,o8,a8,c8,l8,h8,_8,u8,d8,m8,p8,f8,g8,v8,y8,x8;t("PhysicsSystem2D",i8),i8.ID="PHYSICS_2D",mw.once(dw.EVENT_INIT,(()=>{i8.PHYSICS_NONE||mw.registerSystem(i8.ID,i8.instance,ew.Priority.LOW)})),function(t){t[t.Circles=0]="Circles",t[t.FaceA=1]="FaceA",t[t.FaceB=2]="FaceB"}(t8||(t8=t("Physics2DManifoldType",{})));const{property:S8,type:C8,menu:A8}=Qc;let b8=t("RigidBody2D",(n8=dc("cc.RigidBody2D"),s8=A8("Physics2D/RigidBody2D"),r8=C8(Z6),o8=C8(f6),n8(a8=s8((sc((c8=class extends Lh{constructor(...t){super(...t),nc(this,"enabledContactListener",l8,this),nc(this,"bullet",h8,this),nc(this,"awakeOnLoad",_8,this),this._body=null,nc(this,"_group",u8,this),nc(this,"_type",d8,this),nc(this,"_allowSleep",m8,this),nc(this,"_gravityScale",p8,this),nc(this,"_linearDamping",f8,this),nc(this,"_angularDamping",g8,this),nc(this,"_linearVelocity",v8,this),nc(this,"_angularVelocity",y8,this),nc(this,"_fixedRotation",x8,this)}get group(){return this._group}set group(t){this._group=t}get type(){return this._type}set type(t){this._type=t,this._body&&(t===f6.Animated?this._body.setType(f6.Kinematic):this._body.setType(t))}get allowSleep(){return this._allowSleep}set allowSleep(t){this._allowSleep=t,this._body&&this._body.setAllowSleep(t)}get gravityScale(){return this._gravityScale}set gravityScale(t){this._gravityScale=t,this._body&&this._body.setGravityScale(t)}get linearDamping(){return this._linearDamping}set linearDamping(t){this._linearDamping=t,this._body&&this._body.setLinearDamping(t)}get angularDamping(){return this._angularDamping}set angularDamping(t){this._angularDamping=t,this._body&&this._body.setAngularDamping(t)}get linearVelocity(){return this._body&&this._body.getLinearVelocity(this._linearVelocity),this._linearVelocity}set linearVelocity(t){this._linearVelocity=t,this._body&&this._body.setLinearVelocity(t)}get angularVelocity(){return this._body&&(this._angularVelocity=this._body.getAngularVelocity()),this._angularVelocity}set angularVelocity(t){this._angularVelocity=t,this._body&&this._body.setAngularVelocity(t)}get fixedRotation(){return this._fixedRotation}set fixedRotation(t){this._fixedRotation=t,this._body&&this._body.setFixedRotation(t)}isAwake(){return!!this._body&&this._body.isAwake}wakeUp(){this._body&&this._body.wakeUp()}sleep(){this._body&&this._body.sleep()}getMass(){return this._body?this._body.getMass():0}applyForce(t,e,i){this._body&&this._body.applyForce(t,e,i)}applyForceToCenter(t,e){this._body&&this._body.applyForceToCenter(t,e)}applyTorque(t,e){this._body&&this._body.applyTorque(t,e)}applyLinearImpulse(t,e,i){this._body&&this._body.applyLinearImpulse(t,e,i)}applyLinearImpulseToCenter(t,e){this._body&&this._body.applyLinearImpulseToCenter(t,e)}applyAngularImpulse(t,e){this._body&&this._body.applyAngularImpulse(t,e)}getLinearVelocityFromWorldPoint(t,e){return this._body?this._body.getLinearVelocityFromWorldPoint(t,e):e}getLocalVector(t,e){return this._body?this._body.getLocalVector(t,e):e}getWorldVector(t,e){return this._body?this._body.getWorldVector(t,e):e}getLocalPoint(t,e){return this._body?this._body.getLocalPoint(t,e):e}getWorldPoint(t,e){return this._body?this._body.getWorldPoint(t,e):e}getLocalCenter(t){return this._body?this._body.getLocalCenter(t):t}getWorldCenter(t){return this._body?this._body.getWorldCenter(t):t}getInertia(){return this._body&&this._body.getInertia(),0}onLoad(){this._body=l._global.CC_PHYSICS_2D_BUILTIN?H6:new l6.RigidBody,this._body.initialize(this)}onEnable(){this._body&&this._body.onEnable()}onDisable(){this._body&&this._body.onDisable()}onDestroy(){this._body&&this._body.onDestroy()}get impl(){return this._body}}).prototype,"group",[r8],Object.getOwnPropertyDescriptor(c8.prototype,"group"),c8.prototype),l8=sc(c8.prototype,"enabledContactListener",[S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),h8=sc(c8.prototype,"bullet",[S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sc(c8.prototype,"type",[o8],Object.getOwnPropertyDescriptor(c8.prototype,"type"),c8.prototype),sc(c8.prototype,"allowSleep",[S8],Object.getOwnPropertyDescriptor(c8.prototype,"allowSleep"),c8.prototype),sc(c8.prototype,"gravityScale",[S8],Object.getOwnPropertyDescriptor(c8.prototype,"gravityScale"),c8.prototype),sc(c8.prototype,"linearDamping",[S8],Object.getOwnPropertyDescriptor(c8.prototype,"linearDamping"),c8.prototype),sc(c8.prototype,"angularDamping",[S8],Object.getOwnPropertyDescriptor(c8.prototype,"angularDamping"),c8.prototype),sc(c8.prototype,"linearVelocity",[S8],Object.getOwnPropertyDescriptor(c8.prototype,"linearVelocity"),c8.prototype),sc(c8.prototype,"angularVelocity",[S8],Object.getOwnPropertyDescriptor(c8.prototype,"angularVelocity"),c8.prototype),sc(c8.prototype,"fixedRotation",[S8],Object.getOwnPropertyDescriptor(c8.prototype,"fixedRotation"),c8.prototype),_8=sc(c8.prototype,"awakeOnLoad",[S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),u8=sc(c8.prototype,"_group",[S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Z6.DEFAULT}}),d8=sc(c8.prototype,"_type",[S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return f6.Dynamic}}),m8=sc(c8.prototype,"_allowSleep",[S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),p8=sc(c8.prototype,"_gravityScale",[S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),f8=sc(c8.prototype,"_linearDamping",[S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),g8=sc(c8.prototype,"_angularDamping",[S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v8=sc(c8.prototype,"_linearVelocity",[S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi}}),y8=sc(c8.prototype,"_angularVelocity",[S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),x8=sc(c8.prototype,"_fixedRotation",[S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a8=c8))||a8)||a8));var T8,E8,P8,w8,I8,R8,D8,M8,O8,B8,N8,L8,F8;let z8=t("Collider2D",(T8=dc("cc.Collider2D"),E8=Kc(Z6),T8((F8=class extends(kl(Lh)){constructor(...t){super(...t),nc(this,"editing",I8,this),nc(this,"tag",R8,this),this.TYPE=g6.None,this._shape=null,this._body=null,nc(this,"_group",D8,this),nc(this,"_density",M8,this),nc(this,"_sensor",O8,this),nc(this,"_friction",B8,this),nc(this,"_restitution",N8,this),nc(this,"_offset",L8,this)}get group(){return this._group}set group(t){this._group=t,this._shape&&this._shape.onGroupChanged&&this._shape.onGroupChanged()}get density(){return this._density}set density(t){this._density=t}get sensor(){return this._sensor}set sensor(t){this._sensor=t}get friction(){return this._friction}set friction(t){this._friction=t}get restitution(){return this._restitution}set restitution(t){this._restitution=t}get offset(){return this._offset}set offset(t){this._offset=t}get body(){return this._body}get impl(){return this._shape}onLoad(){this._shape=function(t){return j6.INITED||(j6.INITED=!0,j6[g6.BOX]=function(){return new l6.BoxShape},j6[g6.CIRCLE]=function(){return new l6.CircleShape},j6[g6.POLYGON]=function(){return new l6.PolygonShape}),j6[t]()}(this.TYPE),this._shape.initialize(this),this._shape.onLoad&&this._shape.onLoad(),this._body=this.getComponent(b8)}onEnable(){this._shape&&this._shape.onEnable()}onDisable(){this._shape&&this._shape.onDisable&&this._shape.onDisable()}onDestroy(){this._shape&&this._shape.onDestroy&&this._shape.onDestroy()}apply(){this._shape&&this._shape.apply&&this._shape.apply()}get worldAABB(){return this._shape?this._shape.worldAABB:new ki}},I8=sc((w8=F8).prototype,"editing",[Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),R8=sc(w8.prototype,"tag",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sc(w8.prototype,"group",[E8],Object.getOwnPropertyDescriptor(w8.prototype,"group"),w8.prototype),sc(w8.prototype,"density",[gc],Object.getOwnPropertyDescriptor(w8.prototype,"density"),w8.prototype),sc(w8.prototype,"sensor",[gc],Object.getOwnPropertyDescriptor(w8.prototype,"sensor"),w8.prototype),sc(w8.prototype,"friction",[gc],Object.getOwnPropertyDescriptor(w8.prototype,"friction"),w8.prototype),sc(w8.prototype,"restitution",[gc],Object.getOwnPropertyDescriptor(w8.prototype,"restitution"),w8.prototype),sc(w8.prototype,"offset",[gc],Object.getOwnPropertyDescriptor(w8.prototype,"offset"),w8.prototype),D8=sc(w8.prototype,"_group",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Z6.DEFAULT}}),M8=sc(w8.prototype,"_density",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),O8=sc(w8.prototype,"_sensor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),B8=sc(w8.prototype,"_friction",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.2}}),N8=sc(w8.prototype,"_restitution",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),L8=sc(w8.prototype,"_offset",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi}}),P8=w8))||P8));var V8,G8,U8,k8,H8,j8,W8,q8,X8,Y8,K8,J8,$8,Z8,Q8,t7,e7,i7,n7,s7,r7,o7;t("BoxCollider2D",dc("cc.BoxCollider2D")(V8=Pc()((U8=sc((G8=class extends z8{constructor(...t){super(...t),nc(this,"_size",U8,this),this.TYPE=g6.BOX}get size(){return this._size}set size(t){this._size=t}get worldPoints(){return this._shape?this._shape.worldPoints:[]}}).prototype,"_size",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi(1,1)}}),sc(G8.prototype,"size",[gc],Object.getOwnPropertyDescriptor(G8.prototype,"size"),G8.prototype),V8=G8))||V8)||V8),t("CircleCollider2D",dc("cc.CircleCollider2D")(k8=Pc()((j8=sc((H8=class extends z8{constructor(...t){super(...t),nc(this,"_radius",j8,this),this.TYPE=g6.CIRCLE}get radius(){return this._radius}set radius(t){this._radius=t<0?0:t}get worldPosition(){return this._shape?this._shape.worldPosition:new Oi}get worldRadius(){return this._shape?this._shape.worldRadius:0}}).prototype,"_radius",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sc(H8.prototype,"radius",[gc],Object.getOwnPropertyDescriptor(H8.prototype,"radius"),H8.prototype),k8=H8))||k8)||k8),t("PolygonCollider2D",(W8=dc("cc.PolygonCollider2D"),q8=Pc(),X8=gc({serializable:!1,displayOrder:0}),Y8=gc({type:Oi}),W8(K8=q8(($8=sc((J8=class extends z8{constructor(...t){super(...t),nc(this,"threshold",$8,this),nc(this,"_points",Z8,this),this.TYPE=g6.POLYGON}get points(){return this._points}set points(t){this._points=t}get worldPoints(){return this._shape?this._shape.worldPoints:[]}}).prototype,"threshold",[X8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Z8=sc(J8.prototype,"_points",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new Oi(-1,-1),new Oi(1,-1),new Oi(1,1),new Oi(-1,1)]}}),sc(J8.prototype,"points",[Y8],Object.getOwnPropertyDescriptor(J8.prototype,"points"),J8.prototype),K8=J8))||K8)||K8));let a7=t("Joint2D",(Q8=dc("cc.Joint2D"),t7=Kc(b8),Q8((n7=sc((i7=class extends Lh{constructor(...t){super(...t),nc(this,"anchor",n7,this),nc(this,"connectedAnchor",s7,this),nc(this,"collideConnected",r7,this),nc(this,"connectedBody",o7,this),this._body=null,this._joint=null,this.TYPE=v6.None}get body(){return this._body}get impl(){return this._joint}onLoad(){this._joint=function(t){return function(){if(W6.INITED)return;W6.INITED=!0;const t=l._global.CC_PHYSICS_2D_BUILTIN;W6[v6.SPRING]=function(){return t?q6:new l6.SpringJoint},W6[v6.DISTANCE]=function(){return t?q6:new l6.DistanceJoint},W6[v6.FIXED]=function(){return t?q6:new l6.FixedJoint},W6[v6.MOUSE]=function(){return t?q6:new l6.MouseJoint},W6[v6.RELATIVE]=function(){return t?q6:new l6.RelativeJoint},W6[v6.SLIDER]=function(){return t?q6:new l6.SliderJoint},W6[v6.WHEEL]=function(){return t?q6:new l6.WheelJoint},W6[v6.HINGE]=function(){return t?q6:new l6.HingeJoint}}(),W6[t]()}(this.TYPE),this._joint.initialize(this),this._body=this.getComponent(b8)}onEnable(){this._joint&&this._joint.onEnable&&this._joint.onEnable()}onDisable(){this._joint&&this._joint.onDisable&&this._joint.onDisable()}start(){this._joint&&this._joint.start&&this._joint.start()}onDestroy(){this._joint&&this._joint.onDestroy&&this._joint.onDestroy()}}).prototype,"anchor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi}}),s7=sc(i7.prototype,"connectedAnchor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi}}),r7=sc(i7.prototype,"collideConnected",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),o7=sc(i7.prototype,"connectedBody",[t7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),e7=i7))||e7));var c7,l7,h7,_7,u7,d7,m7,p7,f7,g7,v7,y7,x7,S7,C7,A7,b7,T7,E7,P7,w7,I7,R7;t("DistanceJoint2D",dc("cc.DistanceJoint2D")(c7=Pc()((sc((l7=class extends a7{constructor(...t){super(...t),this.TYPE=v6.DISTANCE,nc(this,"_maxLength",h7,this),nc(this,"_autoCalcDistance",_7,this)}get maxLength(){return this._autoCalcDistance&&this.connectedBody?mi.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._maxLength}set maxLength(t){this._maxLength=t,this._joint&&this._joint.setMaxLength(t)}get autoCalcDistance(){return this._autoCalcDistance}set autoCalcDistance(t){this._autoCalcDistance=t}}).prototype,"maxLength",[gc],Object.getOwnPropertyDescriptor(l7.prototype,"maxLength"),l7.prototype),sc(l7.prototype,"autoCalcDistance",[gc],Object.getOwnPropertyDescriptor(l7.prototype,"autoCalcDistance"),l7.prototype),h7=sc(l7.prototype,"_maxLength",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),_7=sc(l7.prototype,"_autoCalcDistance",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),c7=l7))||c7)||c7),t("SpringJoint2D",dc("cc.SpringJoint2D")(u7=Pc()((sc((d7=class extends a7{constructor(...t){super(...t),this.TYPE=v6.SPRING,nc(this,"_frequency",m7,this),nc(this,"_dampingRatio",p7,this),nc(this,"_distance",f7,this),nc(this,"_autoCalcDistance",g7,this)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}get dampingRatio(){return this._dampingRatio}set dampingRatio(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}get distance(){return this._autoCalcDistance&&this.connectedBody?mi.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._distance}set distance(t){this._distance=t,this._joint&&this._joint.setDistance(t)}get autoCalcDistance(){return this._autoCalcDistance}set autoCalcDistance(t){this._autoCalcDistance=t}}).prototype,"frequency",[gc],Object.getOwnPropertyDescriptor(d7.prototype,"frequency"),d7.prototype),sc(d7.prototype,"dampingRatio",[gc],Object.getOwnPropertyDescriptor(d7.prototype,"dampingRatio"),d7.prototype),sc(d7.prototype,"distance",[gc],Object.getOwnPropertyDescriptor(d7.prototype,"distance"),d7.prototype),sc(d7.prototype,"autoCalcDistance",[gc],Object.getOwnPropertyDescriptor(d7.prototype,"autoCalcDistance"),d7.prototype),m7=sc(d7.prototype,"_frequency",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),p7=sc(d7.prototype,"_dampingRatio",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),f7=sc(d7.prototype,"_distance",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),g7=sc(d7.prototype,"_autoCalcDistance",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),u7=d7))||u7)||u7),t("MouseJoint2D",dc("cc.MouseJoint2D")(v7=Pc()((sc((y7=class extends a7{constructor(...t){super(...t),this.TYPE=v6.MOUSE,nc(this,"_maxForce",x7,this),nc(this,"_dampingRatio",S7,this),nc(this,"_frequency",C7,this),this._target=new Oi}get target(){return this._target}set target(t){this._target=t,this._joint&&this._joint.setTarget(t)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}get dampingRatio(){return this._dampingRatio}set dampingRatio(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}get maxForce(){return this._maxForce}set maxForce(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}update(t){this._joint.update(t)}}).prototype,"frequency",[gc],Object.getOwnPropertyDescriptor(y7.prototype,"frequency"),y7.prototype),sc(y7.prototype,"dampingRatio",[gc],Object.getOwnPropertyDescriptor(y7.prototype,"dampingRatio"),y7.prototype),sc(y7.prototype,"maxForce",[gc],Object.getOwnPropertyDescriptor(y7.prototype,"maxForce"),y7.prototype),x7=sc(y7.prototype,"_maxForce",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),S7=sc(y7.prototype,"_dampingRatio",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),C7=sc(y7.prototype,"_frequency",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),v7=y7))||v7)||v7);const D7=new mi,M7=new mi;var O7,B7,N7,L7,F7,z7,V7,G7,U7,k7;t("RelativeJoint2D",dc("cc.RelativeJoint2D")(A7=Pc()((sc((b7=class extends a7{constructor(...t){super(...t),this.TYPE=v6.RELATIVE,nc(this,"_maxForce",T7,this),nc(this,"_maxTorque",E7,this),nc(this,"_correctionFactor",P7,this),nc(this,"_angularOffset",w7,this),nc(this,"_linearOffset",I7,this),nc(this,"_autoCalcOffset",R7,this)}get maxForce(){return this._maxForce}set maxForce(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}get maxTorque(){return this._maxTorque}set maxTorque(t){this._maxTorque=t,this._joint&&this._joint.setMaxTorque(t)}get correctionFactor(){return this._correctionFactor}set correctionFactor(t){this._correctionFactor=t,this._joint&&this._joint.setCorrectionFactor(t)}get linearOffset(){return this._autoCalcOffset&&this.connectedBody?Oi.subtract(this._linearOffset,this.connectedBody.node.worldPosition,this.node.worldPosition):this._linearOffset}set linearOffset(t){this._linearOffset.set(t),this._joint&&this._joint.setLinearOffset(t)}get angularOffset(){return this._autoCalcOffset&&this.connectedBody&&(Si.toEuler(D7,this.node.worldRotation),Si.toEuler(M7,this.connectedBody.node.worldRotation),this._angularOffset=M7.z-D7.z),this._angularOffset}set angularOffset(t){this._angularOffset=t,this._joint&&this._joint.setAngularOffset(t)}get autoCalcOffset(){return this._autoCalcOffset}set autoCalcOffset(t){this._autoCalcOffset=t}}).prototype,"maxForce",[gc],Object.getOwnPropertyDescriptor(b7.prototype,"maxForce"),b7.prototype),sc(b7.prototype,"maxTorque",[gc],Object.getOwnPropertyDescriptor(b7.prototype,"maxTorque"),b7.prototype),sc(b7.prototype,"correctionFactor",[gc],Object.getOwnPropertyDescriptor(b7.prototype,"correctionFactor"),b7.prototype),sc(b7.prototype,"linearOffset",[gc],Object.getOwnPropertyDescriptor(b7.prototype,"linearOffset"),b7.prototype),sc(b7.prototype,"angularOffset",[gc],Object.getOwnPropertyDescriptor(b7.prototype,"angularOffset"),b7.prototype),sc(b7.prototype,"autoCalcOffset",[gc],Object.getOwnPropertyDescriptor(b7.prototype,"autoCalcOffset"),b7.prototype),T7=sc(b7.prototype,"_maxForce",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),E7=sc(b7.prototype,"_maxTorque",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),P7=sc(b7.prototype,"_correctionFactor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),w7=sc(b7.prototype,"_angularOffset",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),I7=sc(b7.prototype,"_linearOffset",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi}}),R7=sc(b7.prototype,"_autoCalcOffset",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),A7=b7))||A7)||A7);const H7=new Oi;var j7,W7,q7,X7,Y7,K7,J7,$7,Z7,Q7,t9,e9,i9,n9,s9,r9,o9,a9,c9,l9;t("SliderJoint2D",dc("cc.SliderJoint2D")(O7=Pc()((sc((B7=class extends a7{constructor(...t){super(...t),this.TYPE=v6.SLIDER,nc(this,"_angle",N7,this),nc(this,"_autoCalcAngle",L7,this),nc(this,"_enableMotor",F7,this),nc(this,"_maxMotorForce",z7,this),nc(this,"_motorSpeed",V7,this),nc(this,"_enableLimit",G7,this),nc(this,"_lowerLimit",U7,this),nc(this,"_upperLimit",k7,this)}get angle(){return this._autoCalcAngle&&this.connectedBody&&(Oi.subtract(H7,this.connectedBody.node.worldPosition,this.node.worldPosition),this._angle=Ke(Math.atan2(H7.y,H7.x))),this._angle}set angle(t){this._angle=t}get autoCalcAngle(){return this._autoCalcAngle}set autoCalcAngle(t){this._autoCalcAngle=t}get enableMotor(){return this._enableMotor}set enableMotor(t){this._enableMotor=t}get maxMotorForce(){return this._maxMotorForce}set maxMotorForce(t){this._maxMotorForce=t,this._joint&&this._joint.setMaxMotorForce(t)}get motorSpeed(){return this._motorSpeed}set motorSpeed(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}get enableLimit(){return this._enableLimit}set enableLimit(t){this._enableLimit=t}get lowerLimit(){return this._lowerLimit}set lowerLimit(t){this._lowerLimit=t,this._joint&&this._joint.setLowerLimit(t)}get upperLimit(){return this._upperLimit}set upperLimit(t){this._upperLimit=t,this._joint&&this._joint.setUpperLimit(t)}}).prototype,"angle",[gc],Object.getOwnPropertyDescriptor(B7.prototype,"angle"),B7.prototype),sc(B7.prototype,"autoCalcAngle",[gc],Object.getOwnPropertyDescriptor(B7.prototype,"autoCalcAngle"),B7.prototype),sc(B7.prototype,"enableMotor",[gc],Object.getOwnPropertyDescriptor(B7.prototype,"enableMotor"),B7.prototype),sc(B7.prototype,"maxMotorForce",[gc],Object.getOwnPropertyDescriptor(B7.prototype,"maxMotorForce"),B7.prototype),sc(B7.prototype,"motorSpeed",[gc],Object.getOwnPropertyDescriptor(B7.prototype,"motorSpeed"),B7.prototype),sc(B7.prototype,"enableLimit",[gc],Object.getOwnPropertyDescriptor(B7.prototype,"enableLimit"),B7.prototype),sc(B7.prototype,"lowerLimit",[gc],Object.getOwnPropertyDescriptor(B7.prototype,"lowerLimit"),B7.prototype),sc(B7.prototype,"upperLimit",[gc],Object.getOwnPropertyDescriptor(B7.prototype,"upperLimit"),B7.prototype),N7=sc(B7.prototype,"_angle",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),L7=sc(B7.prototype,"_autoCalcAngle",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),F7=sc(B7.prototype,"_enableMotor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),z7=sc(B7.prototype,"_maxMotorForce",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),V7=sc(B7.prototype,"_motorSpeed",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),G7=sc(B7.prototype,"_enableLimit",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),U7=sc(B7.prototype,"_lowerLimit",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),k7=sc(B7.prototype,"_upperLimit",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),O7=B7))||O7)||O7),t("FixedJoint2D",dc("cc.FixedJoint2D")(j7=Pc()((sc((W7=class extends a7{constructor(...t){super(...t),this.TYPE=v6.FIXED,nc(this,"_frequency",q7,this),nc(this,"_dampingRatio",X7,this)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}get dampingRatio(){return this._dampingRatio}set dampingRatio(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}).prototype,"frequency",[gc],Object.getOwnPropertyDescriptor(W7.prototype,"frequency"),W7.prototype),sc(W7.prototype,"dampingRatio",[gc],Object.getOwnPropertyDescriptor(W7.prototype,"dampingRatio"),W7.prototype),q7=sc(W7.prototype,"_frequency",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),X7=sc(W7.prototype,"_dampingRatio",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),j7=W7))||j7)||j7),t("WheelJoint2D",dc("cc.WheelJoint2D")(Y7=Pc()((sc((K7=class extends a7{constructor(...t){super(...t),this.TYPE=v6.WHEEL,nc(this,"_angle",J7,this),nc(this,"_enableMotor",$7,this),nc(this,"_maxMotorTorque",Z7,this),nc(this,"_motorSpeed",Q7,this),nc(this,"_frequency",t9,this),nc(this,"_dampingRatio",e9,this)}get angle(){return this._angle}set angle(t){this._angle=t}get enableMotor(){return this._enableMotor}set enableMotor(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}get maxMotorTorque(){return this._maxMotorTorque}set maxMotorTorque(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}get motorSpeed(){return this._motorSpeed}set motorSpeed(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}get dampingRatio(){return this._dampingRatio}set dampingRatio(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}).prototype,"angle",[gc],Object.getOwnPropertyDescriptor(K7.prototype,"angle"),K7.prototype),sc(K7.prototype,"enableMotor",[gc],Object.getOwnPropertyDescriptor(K7.prototype,"enableMotor"),K7.prototype),sc(K7.prototype,"maxMotorTorque",[gc],Object.getOwnPropertyDescriptor(K7.prototype,"maxMotorTorque"),K7.prototype),sc(K7.prototype,"motorSpeed",[gc],Object.getOwnPropertyDescriptor(K7.prototype,"motorSpeed"),K7.prototype),sc(K7.prototype,"frequency",[gc],Object.getOwnPropertyDescriptor(K7.prototype,"frequency"),K7.prototype),sc(K7.prototype,"dampingRatio",[gc],Object.getOwnPropertyDescriptor(K7.prototype,"dampingRatio"),K7.prototype),J7=sc(K7.prototype,"_angle",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),$7=sc(K7.prototype,"_enableMotor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Z7=sc(K7.prototype,"_maxMotorTorque",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),Q7=sc(K7.prototype,"_motorSpeed",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),t9=sc(K7.prototype,"_frequency",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),e9=sc(K7.prototype,"_dampingRatio",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),Y7=K7))||Y7)||Y7),t("HingeJoint2D",dc("cc.HingeJoint2D")(i9=Pc()((sc((n9=class extends a7{constructor(...t){super(...t),this.TYPE=v6.HINGE,nc(this,"_enableLimit",s9,this),nc(this,"_lowerAngle",r9,this),nc(this,"_upperAngle",o9,this),nc(this,"_enableMotor",a9,this),nc(this,"_maxMotorTorque",c9,this),nc(this,"_motorSpeed",l9,this)}get enableLimit(){return this._enableLimit}set enableLimit(t){this._enableLimit=t}get lowerAngle(){return this._lowerAngle}set lowerAngle(t){this._lowerAngle=t,this._joint&&this._joint.setLowerAngle(t)}get upperAngle(){return this._upperAngle}set upperAngle(t){this._upperAngle=t,this._joint&&this._joint.setUpperAngle(t)}get enableMotor(){return this._enableMotor}set enableMotor(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}get maxMotorTorque(){return this._maxMotorTorque}set maxMotorTorque(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}get motorSpeed(){return this._motorSpeed}set motorSpeed(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}}).prototype,"enableLimit",[gc],Object.getOwnPropertyDescriptor(n9.prototype,"enableLimit"),n9.prototype),sc(n9.prototype,"lowerAngle",[gc],Object.getOwnPropertyDescriptor(n9.prototype,"lowerAngle"),n9.prototype),sc(n9.prototype,"upperAngle",[gc],Object.getOwnPropertyDescriptor(n9.prototype,"upperAngle"),n9.prototype),sc(n9.prototype,"enableMotor",[gc],Object.getOwnPropertyDescriptor(n9.prototype,"enableMotor"),n9.prototype),sc(n9.prototype,"maxMotorTorque",[gc],Object.getOwnPropertyDescriptor(n9.prototype,"maxMotorTorque"),n9.prototype),sc(n9.prototype,"motorSpeed",[gc],Object.getOwnPropertyDescriptor(n9.prototype,"motorSpeed"),n9.prototype),s9=sc(n9.prototype,"_enableLimit",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),r9=sc(n9.prototype,"_lowerAngle",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),o9=sc(n9.prototype,"_upperAngle",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),a9=sc(n9.prototype,"_enableMotor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c9=sc(n9.prototype,"_maxMotorTorque",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),l9=sc(n9.prototype,"_motorSpeed",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i9=n9))||i9)||i9),t("Physics2DUtils",{PolygonSeparator:U6});class h9 extends p6.RayCastCallback{constructor(...t){super(...t),this._type=x6.Closest,this._fixtures=[],this._points=[],this._normals=[],this._fractions=[],this._mask=4294967295}init(t,e){this._type=t,this._mask=e,this._fixtures.length=0,this._points.length=0,this._normals.length=0,this._fractions.length=0}ReportFixture(t,e,i,n){return 0==(t.GetFilterData().categoryBits&this._mask)?0:this._type===x6.Closest?(this._fixtures[0]=t,this._points[0]=e,this._normals[0]=i,this._fractions[0]=n,n):(this._fixtures.push(t),this._points.push(new Oi(e.x,e.y)),this._normals.push(new Oi(i.x,i.y)),this._fractions.push(n),this._type===x6.Any?0:this._type>=x6.All?1:n)}getFixtures(){return this._fixtures}getPoints(){return this._points}getNormals(){return this._normals}getFractions(){return this._fractions}}const _9=[],u9=[new Oi,new Oi],d9=new p6.WorldManifold,m9={points:[],separations:[],normal:new Oi};class p9{constructor(){this.localPoint=new Oi,this.normalImpulse=0,this.tangentImpulse=0}}const f9=[new p9,new p9],g9={type:0,localPoint:new Oi,localNormal:new Oi,points:[]},v9={normalImpulses:[],tangentImpulses:[]};class y9{constructor(){this.colliderA=null,this.colliderB=null,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=null}static get(t){let e=_9.pop();return e||(e=new y9),e.init(t),e}static put(t){const e=t.m_userData;e&&(_9.push(e),e.reset())}_setImpulse(t){this._impulse=t}init(t){this.colliderA=t.m_fixtureA.m_userData.collider,this.colliderB=t.m_fixtureB.m_userData.collider,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=t,t.m_userData=this}reset(){this.setTangentSpeed(0),this.resetFriction(),this.resetRestitution(),this.colliderA=null,this.colliderB=null,this.disabled=!1,this._impulse=null,this._b2contact.m_userData=null,this._b2contact=null}getWorldManifold(){const t=m9.points,e=m9.separations,i=m9.normal;this._b2contact.GetWorldManifold(d9);const n=d9.points,s=d9.separations,r=this._b2contact.GetManifold().pointCount;t.length=e.length=r;for(let i=0;i<r;i++){const r=u9[i];r.x=n[i].x*A6,r.y=n[i].y*A6,t[i]=r,e[i]=s[i]*A6}return i.x=d9.normal.x,i.y=d9.normal.y,this._inverted&&(i.x*=-1,i.y*=-1),m9}getManifold(){const t=g9.points,e=g9.localNormal,i=g9.localPoint,n=this._b2contact.GetManifold(),s=n.points,r=t.length=n.pointCount;for(let e=0;e<r;e++){const i=f9[e],n=s[e];i.localPoint.x=n.localPoint.x*A6,i.localPoint.y=n.localPoint.y*A6,i.normalImpulse=n.normalImpulse*A6,i.tangentImpulse=n.tangentImpulse,t[e]=i}return i.x=n.localPoint.x*A6,i.y=n.localPoint.y*A6,e.x=n.localNormal.x,e.y=n.localNormal.y,g9.type=n.type,this._inverted&&(e.x*=-1,e.y*=-1),g9}getImpulse(){const t=this._impulse;if(!t)return null;const e=v9.normalImpulses,i=v9.tangentImpulses,n=t.count;for(let s=0;s<n;s++)e[s]=t.normalImpulses[s]*A6,i[s]=t.tangentImpulses[s];return i.length=e.length=n,v9}emit(t){const e=this.colliderA,i=this.colliderB,n=e.body,s=i.body;n.enabledContactListener&&(null==e||e.emit(t,e,i,this)),s.enabledContactListener&&(null==i||i.emit(t,i,e,this)),(n.enabledContactListener||s.enabledContactListener)&&i8.instance.emit(t,e,i,this),(this.disabled||this.disabledOnce)&&(this.setEnabled(!1),this.disabledOnce=!1)}setEnabled(t){this._b2contact.SetEnabled(t)}isTouching(){return this._b2contact.IsTouching()}setTangentSpeed(t){this._b2contact.SetTangentSpeed(t)}getTangentSpeed(){return this._b2contact.GetTangentSpeed()}setFriction(t){this._b2contact.SetFriction(t)}getFriction(){return this._b2contact.GetFriction()}resetFriction(){return this._b2contact.ResetFriction()}setRestitution(t){this._b2contact.SetRestitution(t)}getRestitution(){return this._b2contact.GetRestitution()}resetRestitution(){return this._b2contact.ResetRestitution()}}const x9=new p6.Vec2,S9=new hi,C9=hi.GREEN,A9=hi.RED;class b9 extends p6.Draw{constructor(t){super(),this._drawer=null,this._xf=new p6.Transform,this._dxf=new p6.Transform,this._drawer=t}_DrawPolygon(t,e){const i=this._drawer;for(let n=0;n<e;n++){p6.Transform.MulXV(this._xf,t[n],x9);const e=x9.x*A6,s=x9.y*A6;0===n?i.moveTo(e,s):i.lineTo(e,s)}i.close()}DrawPolygon(t,e,i){this._applyStrokeColor(i),this._DrawPolygon(t,e),this._drawer.stroke()}DrawSolidPolygon(t,e,i){this._applyFillColor(i),this._DrawPolygon(t,e),this._drawer.fill(),this._drawer.stroke()}_DrawCircle(t,e){const i=this._xf.p;this._drawer.circle((t.x+i.x)*A6,(t.y+i.y)*A6,e*A6)}DrawCircle(t,e,i){this._applyStrokeColor(i),this._DrawCircle(t,e),this._drawer.stroke()}DrawSolidCircle(t,e,i,n){this._applyFillColor(n),this._DrawCircle(t,e),this._drawer.fill()}DrawSegment(t,e,i){const n=this._drawer;if(t.x===e.x&&t.y===e.y)return this._applyFillColor(i),this._DrawCircle(t,2/A6),void n.fill();this._applyStrokeColor(i),p6.Transform.MulXV(this._xf,t,x9),n.moveTo(x9.x*A6,x9.y*A6),p6.Transform.MulXV(this._xf,e,x9),n.lineTo(x9.x*A6,x9.y*A6),n.stroke()}DrawTransform(t){const e=this._drawer;e.strokeColor=A9,x9.x=x9.y=0,p6.Transform.MulXV(t,x9,x9),e.moveTo(x9.x*A6,x9.y*A6),x9.x=1,x9.y=0,p6.Transform.MulXV(t,x9,x9),e.lineTo(x9.x*A6,x9.y*A6),e.stroke(),e.strokeColor=C9,x9.x=x9.y=0,p6.Transform.MulXV(t,x9,x9),e.moveTo(x9.x*A6,x9.y*A6),x9.x=0,x9.y=1,p6.Transform.MulXV(t,x9,x9),e.lineTo(x9.x*A6,x9.y*A6),e.stroke()}DrawPoint(t,e,i){}DrawParticles(){}_applyStrokeColor(t){this._drawer.strokeColor=S9.set(255*t.r,255*t.g,255*t.b,150)}_applyFillColor(t){this._drawer.fillColor=S9.set(255*t.r,255*t.g,255*t.b,150)}PushTransform(t){this._xf=t}PopTransform(){this._xf=this._dxf}}const T9=new mi,E9=new Oi,P9=new Oi,w9=new p6.BodyDef,I9=new p6.AABB,R9=[];new mi;const D9=new p6.Vec2,M9=new p6.Filter;function O9(t){const e=t.collider;return M9.categoryBits=e.group===Z6.DEFAULT?e.body.group:e.group,M9.maskBits=i8.instance.collisionMatrix[M9.categoryBits],M9}class B9{constructor(){this._shapes=[],this._fixtures=[],this._collider=null,this._body=null,this._inited=!1,this._rect=new ki}get impl(){return this._shapes}get collider(){return this._collider}initialize(t){this._collider=t}onLoad(){}onEnable(){i8.instance._callAfterStep(this,this._init)}onDisable(){i8.instance._callAfterStep(this,this._destroy)}start(){}onGroupChanged(){const t=O9(this);this._fixtures.forEach((e=>{e.SetFilterData(t)}))}apply(){this._destroy(),this._init()}get worldAABB(){const t=1e7;let e=t,i=t,n=-t,s=-t;const r=this._fixtures;for(let t=0;t<r.length;t++){const o=r[t],a=o.GetShape().GetChildCount();for(let t=0;t<a;t++){const r=o.GetAABB(t);r.lowerBound.x<e&&(e=r.lowerBound.x),r.lowerBound.y<i&&(i=r.lowerBound.y),r.upperBound.x>n&&(n=r.upperBound.x),r.upperBound.y>s&&(s=r.upperBound.y)}}e*=A6,i*=A6,n*=A6,s*=A6;const o=this._rect;return o.x=e,o.y=i,o.width=n-e,o.height=s-i,o}getFixtureIndex(t){return this._fixtures.indexOf(t)}_createShapes(t,e){return[]}_init(){var t;if(this._inited)return;const e=this.collider,i=e.getComponent(b8);if(!i)return;const n=null===(t=i.impl)||void 0===t?void 0:t.impl;if(!n)return;const s=i.node.worldScale,r=0===s.x&&0===s.y?[]:this._createShapes(s.x,s.y),o=O9(this);for(let t=0;t<r.length;t++){const s=r[t],a={density:e.density,isSensor:e.sensor,friction:e.friction,restitution:e.restitution,shape:s,filter:o},c=n.CreateFixture(a);c.m_userData=this,i.enabledContactListener&&i8.instance.physicsWorld.registerContactFixture(c),this._shapes.push(s),this._fixtures.push(c)}this._body=n,this._inited=!0}_destroy(){if(!this._inited)return;const t=this._fixtures,e=this._body;for(let i=t.length-1;i>=0;i--){const n=t[i];n.m_userData=null,i8.instance.physicsWorld.unregisterContactFixture(n),e&&e.DestroyFixture(n)}this._body=null,this._fixtures.length=0,this._shapes.length=0,this._inited=!1}}const N9=new ki;class L9{constructor(){this._b2joint=null,this._jointComp=null,this._body=null,this._inited=!1}get impl(){return this._b2joint}get comp(){return this._jointComp}get body(){return this._body}initialize(t){this._jointComp=t}onEnable(){i8.instance._callAfterStep(this,this._init)}onDisable(){i8.instance._callAfterStep(this,this._destroy)}start(){i8.instance._callAfterStep(this,this._init)}_init(){if(this._inited)return;const t=this._jointComp;if(!t.isValid)return;this._body=t.getComponent(b8);const e=this._createJointDef();if(!e)return;const i=t.connectedBody;i&&i.enabledInHierarchy&&(e.bodyA=this._body.impl.impl,e.bodyB=i.impl.impl,e.collideConnected=t.collideConnected,this._b2joint=i8.instance.physicsWorld.impl.CreateJoint(e),this._inited=!0)}_destroy(){this._inited&&(i8.instance.physicsWorld.impl.DestroyJoint(this._b2joint),this._b2joint=null,this._inited=!1)}_createJointDef(){return null}isValid(){return this._b2joint&&this._body&&this._body.impl&&this._jointComp&&this._jointComp.connectedBody&&this._jointComp.connectedBody.impl}}const F9=new p6.Vec2;var z9,V9,G9,U9,k9,H9;z9="box2d",V9={PhysicsWorld:class{get impl(){return this._world}constructor(){this._world=void 0,this._bodies=[],this._animatedBodies=[],this._rotationAxis=new mi,this._contactListener=void 0,this._aabbQueryCallback=void 0,this._raycastQueryCallback=void 0,this._debugGraphics=null,this._b2DebugDrawer=null,this._debugDrawFlags=0,this._world=new p6.World(new p6.Vec2(0,-10));const t=new b6;t.setBeginContact(this._onBeginContact),t.setEndContact(this._onEndContact),t.setPreSolve(this._onPreSolve),t.setPostSolve(this._onPostSolve),this._world.SetContactListener(t),this._contactListener=t,this._aabbQueryCallback=new T6,this._raycastQueryCallback=new h9}get debugDrawFlags(){return this._debugDrawFlags}set debugDrawFlags(t){t||this._debugGraphics&&(this._debugGraphics.node.parent=null),this._debugDrawFlags=t}_checkDebugDrawValid(){if(!this._debugGraphics||!this._debugGraphics.isValid){let t=YE("Canvas");if(!t){const e=mw.getScene();if(!e)return;t=new iS("Canvas"),t.addComponent(tz),t.parent=e}const e=new iS("PHYSICS_2D_DEBUG_DRAW");e.hideFlags|=il.Flags.DontSave,e.parent=t,e.worldPosition=mi.ZERO,e.layer=Yd.Enum.UI_2D,this._debugGraphics=e.addComponent(KN),this._debugGraphics.lineWidth=2;const i=new b9(this._debugGraphics);this._b2DebugDrawer=i,this._world.SetDebugDraw(i)}const t=this._debugGraphics.node.parent;this._debugGraphics.node.setSiblingIndex(t.children.length-1),this._b2DebugDrawer&&this._b2DebugDrawer.SetFlags(this.debugDrawFlags)}setGravity(t){this._world.SetGravity(t)}setAllowSleep(t){this._world.SetAllowSleeping(!0)}step(t,e=10,i=10){const n=this._animatedBodies;for(let e=0,i=n.length;e<i;e++)n[e].animate(t);this._world.Step(t,e,i)}raycast(t,e,i,n){if(t.equals(e))return[];i=i||x6.Closest,E9.x=t.x/A6,E9.y=t.y/A6,P9.x=e.x/A6,P9.y=e.y/A6;const s=this._raycastQueryCallback;s.init(i,n),this._world.RayCast(s,E9,P9);const r=s.getFixtures();if(r.length>0){const t=s.getPoints(),e=s.getNormals(),n=s.getFractions(),o=[];for(let s=0,a=r.length;s<a;s++){const a=r[s],c=a.m_userData,l=c.collider;if(i===x6.AllClosest){let i;for(let t=0;t<o.length;t++)o[t].collider===l&&(i=o[t]);if(i){n[s]<i.fraction&&(i.fixtureIndex=c.getFixtureIndex(a),i.point.x=t[s].x*A6,i.point.y=t[s].y*A6,i.normal.x=e[s].x,i.normal.y=e[s].y,i.fraction=n[s]);continue}}o.push({collider:l,fixtureIndex:c.getFixtureIndex(a),point:new Oi(t[s].x*A6,t[s].y*A6),normal:new Oi(e[s].x,e[s].y),fraction:n[s]})}return o}return[]}syncPhysicsToScene(){const t=this._bodies;for(let e=0,i=t.length;e<i;e++){const i=t[e],n=i.rigidBody;if(n.type===f6.Animated){i.resetVelocity();continue}const s=n.node,r=i.impl,o=r.GetPosition();T9.x=o.x*A6,T9.y=o.y*A6,T9.z=0,s.worldPosition=T9;const a=Ke(r.GetAngle());s.setWorldRotationFromEuler(0,0,a)}}syncSceneToPhysics(){const t=this._bodies;for(let e=0;e<t.length;e++)t[e].syncRotationToPhysics(),t[e].syncPositionToPhysics()}addBody(t){if(this._bodies.includes(t))return;const e=w9,i=t.rigidBody;e.allowSleep=i.allowSleep,e.gravityScale=i.gravityScale,e.linearDamping=i.linearDamping,e.angularDamping=i.angularDamping,e.fixedRotation=i.fixedRotation,e.bullet=i.bullet;const n=i.node,s=n.worldPosition;e.position.Set(s.x/A6,s.y/A6),T9.z=Si.getAxisAngle(this._rotationAxis,n.worldRotation),this._rotationAxis.z<0&&(T9.z=2*Math.PI-T9.z),e.angle=T9.z,e.awake=i.awakeOnLoad,i.type===f6.Animated?(e.type=f6.Kinematic,this._animatedBodies.push(t),t._animatedPos.set(e.position.x,e.position.y),t._animatedAngle=e.angle):e.type=i.type;const r=i,o=r._linearVelocity;e.linearVelocity.Set(o.x,o.y),e.angularVelocity=Ye(r._angularVelocity);const a=this._world.CreateBody(e);a.m_userData=t,t._imp=a,this._bodies.push(t)}removeBody(t){this._bodies.includes(t)&&(t.impl&&(t.impl.m_userData=null,this._world.DestroyBody(t.impl),t._imp=null),Gt.remove(this._bodies,t),t.rigidBody.type===f6.Animated&&Gt.remove(this._animatedBodies,t))}registerContactFixture(t){this._contactListener.registerContactFixture(t)}unregisterContactFixture(t){this._contactListener.unregisterContactFixture(t)}testPoint(t){const e=E9.x=t.x/A6,i=E9.y=t.y/A6,n=.2/A6;I9.lowerBound.x=e-n,I9.lowerBound.y=i-n,I9.upperBound.x=e+n,I9.upperBound.y=i+n;const s=this._aabbQueryCallback;s.init(E9),this._world.QueryAABB(s,I9);const r=s.getFixtures();R9.length=0;for(let t=0;t<r.length;t++){const e=r[t].m_userData.collider;R9.includes(e)||R9.push(e)}return R9}testAABB(t){I9.lowerBound.x=t.xMin/A6,I9.lowerBound.y=t.yMin/A6,I9.upperBound.x=t.xMax/A6,I9.upperBound.y=t.yMax/A6;const e=this._aabbQueryCallback;e.init(),this._world.QueryAABB(e,I9);const i=e.getFixtures();R9.length=0;for(let t=0;t<i.length;t++){const e=i[t].m_userData.collider;R9.includes(e)||R9.push(e)}return R9}drawDebug(){this._checkDebugDrawValid(),this._debugGraphics&&(this._debugGraphics.clear(),this._world.DrawDebugData())}_onBeginContact(t){y9.get(t).emit(S6.BEGIN_CONTACT)}_onEndContact(t){const e=t.m_userData;e&&(e.emit(S6.END_CONTACT),y9.put(t))}_onPreSolve(t){const e=t.m_userData;e&&e.emit(S6.PRE_SOLVE)}_onPostSolve(t,e){const i=t.m_userData;i&&(i._setImpulse(e),i.emit(S6.POST_SOLVE),i._setImpulse(null))}},RigidBody:class{constructor(){this._animatedPos=new Oi,this._animatedAngle=0,this._body=null,this._inited=!1}get impl(){return this._body}set _imp(t){this._body=t}get rigidBody(){return this._rigidBody}get isAwake(){return this._body.IsAwake()}get isSleeping(){return!this._body.IsAwake()}initialize(t){this._rigidBody=t,i8.instance._callAfterStep(this,this._init)}onDestroy(){i8.instance._callAfterStep(this,this._destroy)}onEnable(){this.setActive(!0)}onDisable(){this.setActive(!1)}_registerNodeEvents(){this.rigidBody.node.on(fx.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)}_unregisterNodeEvents(){this.rigidBody.node.off(fx.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)}_onNodeTransformChanged(t){if(!i8.instance.stepping){if(t&iS.TransformBit.SCALE){const t=this.rigidBody.getComponents(z8);for(let e=0;e<t.length;e++)t[e].apply()}t&iS.TransformBit.POSITION&&this.syncPositionToPhysics(!0),t&iS.TransformBit.ROTATION&&this.syncRotationToPhysics(!0)}}_init(){this._inited||(this._registerNodeEvents(),i8.instance.physicsWorld.addBody(this),this._inited=!0)}_destroy(){this._inited&&(i8.instance.physicsWorld.removeBody(this),this._unregisterNodeEvents(),this._inited=!1)}animate(t){const e=this._body;if(!e)return;const i=e.GetPosition();e.SetAwake(!0);const n=1/t;D9.x=(this._animatedPos.x-i.x)*n,D9.y=(this._animatedPos.y-i.y)*n,e.SetLinearVelocity(D9);const s=e.GetAngle();e.SetAngularVelocity((this._animatedAngle-s)*n)}syncPositionToPhysics(t=!1){const e=this._body;if(!e)return;const i=this._rigidBody.node.worldPosition;let n;const s=this._rigidBody.type;n=s===f6.Animated?e.GetLinearVelocity():e.GetPosition(),n.x=i.x/A6,n.y=i.y/A6,s===f6.Animated&&t?this._animatedPos.set(n.x,n.y):e.SetTransformVec(n,e.GetAngle())}syncRotationToPhysics(t=!1){const e=this._body;if(!e)return;const i=Ye(this._rigidBody.node.eulerAngles.z);this._rigidBody.type===f6.Animated&&t?this._animatedAngle=i:e.SetTransformVec(e.GetPosition(),i)}resetVelocity(){const t=this._body;if(!t)return;const e=t.m_linearVelocity;e.Set(0,0),t.SetLinearVelocity(e),t.SetAngularVelocity(0)}setType(t){this._body.SetType(t)}setLinearDamping(t){this._body.SetLinearDamping(t)}setAngularDamping(t){this._body.SetAngularDamping(t)}setGravityScale(t){this._body.SetGravityScale(t)}setFixedRotation(t){this._body.SetFixedRotation(t)}setAllowSleep(t){this._body.SetSleepingAllowed(t)}isActive(){return this._body.IsActive()}setActive(t){this._body.SetActive(t)}wakeUp(){this._body.SetAwake(!0)}sleep(){this._body.SetAwake(!1)}getMass(){return this._body.GetMass()}setLinearVelocity(t){this._body.SetLinearVelocity(t)}getLinearVelocity(t){const e=this._body.GetLinearVelocity();return t.x=e.x,t.y=e.y,t}getLinearVelocityFromWorldPoint(t,e){return D9.Set(t.x/A6,t.y/A6),this._body.GetLinearVelocityFromWorldPoint(D9,e),e.x*=A6,e.y*=A6,e}setAngularVelocity(t){this._body.SetAngularVelocity(t)}getAngularVelocity(){return Ke(this._body.GetAngularVelocity())}getLocalVector(t,e){return e=e||new Oi,D9.Set(t.x/A6,t.y/A6),this._body.GetLocalVector(D9,e),e.x*=A6,e.y*=A6,e}getWorldVector(t,e){return D9.Set(t.x/A6,t.y/A6),this._body.GetWorldVector(D9,e),e.x*=A6,e.y*=A6,e}getLocalPoint(t,e){return e=e||new Oi,D9.Set(t.x/A6,t.y/A6),this._body.GetLocalPoint(D9,e),e.x*=A6,e.y*=A6,e}getWorldPoint(t,e){return e=e||new Oi,D9.Set(t.x/A6,t.y/A6),this._body.GetWorldPoint(D9,e),e.x*=A6,e.y*=A6,e}getLocalCenter(t){t=t||new Oi;const e=this._body.GetLocalCenter();return t.x=e.x*A6,t.y=e.y*A6,t}getWorldCenter(t){t=t||new Oi;const e=this._body.GetWorldCenter();return t.x=e.x*A6,t.y=e.y*A6,t}getInertia(){return this._body.GetInertia()}applyForce(t,e,i){this._body&&(D9.Set(e.x/A6,e.y/A6),this._body.ApplyForce(t,D9,i))}applyForceToCenter(t,e){this._body&&this._body.ApplyForceToCenter(t,e)}applyTorque(t,e){this._body&&this._body.ApplyTorque(t,e)}applyLinearImpulse(t,e,i){this._body&&(D9.Set(e.x/A6,e.y/A6),this._body.ApplyLinearImpulse(t,D9,i))}applyLinearImpulseToCenter(t,e){this._body&&this._body.ApplyLinearImpulse(t,this._body.GetPosition(),e)}applyAngularImpulse(t,e){this._body&&this._body.ApplyAngularImpulse(t,e)}},BoxShape:class extends B9{constructor(...t){super(...t),this._worldPoints=[new Oi,new Oi,new Oi,new Oi]}get worldPoints(){const t=N9,e=this.collider,i=e.size,n=e.offset;t.x=n.x-i.width/2,t.y=n.y-i.height/2,t.width=i.width,t.height=i.height;const s=this._worldPoints,r=s[0],o=s[1],a=s[2],c=s[3];return t.transformMat4ToPoints(e.node.worldMatrix,r,o,a,c),s}_createShapes(t,e){t=Math.abs(t),e=Math.abs(e);const i=this.collider,n=i.size.width/2/A6*t,s=i.size.height/2/A6*e,r=i.offset.x/A6*t,o=i.offset.y/A6*e,a=new p6.PolygonShape;return a.SetAsBox(n,s,new p6.Vec2(r,o),0),[a]}},CircleShape:class extends B9{constructor(...t){super(...t),this._worldPosition=new Oi}get worldRadius(){return this._shapes[0].m_radius*A6}get worldPosition(){const t=this._shapes[0].m_p;return this._worldPosition.set(t.x*A6,t.y*A6)}_createShapes(t,e){t=Math.abs(t),e=Math.abs(e);const i=this.collider,n=i.offset.x/A6*t,s=i.offset.y/A6*e,r=new p6.CircleShape;return r.m_radius=i.radius/A6*t,r.m_p.Set(n,s),[r]}},PolygonShape:class extends B9{constructor(...t){super(...t),this._worldPoints=[]}get worldPoints(){const t=this.collider,e=t.points,i=this._worldPoints,n=t.node.worldMatrix;for(let t=0;t<e.length;t++)i[t]||(i[t]=new Oi),Oi.transformMat4(i[t],e[t],n);return i.length=e.length,this._worldPoints}_createShapes(t,e){const i=[],n=this.collider,s=n.points;s.length>0&&s[0].equals(s[s.length-1])&&(s.length-=1);const r=w6(s),o=n.offset;for(let n=0;n<r.length;n++){const s=r[n];let a=null,c=[],l=null;for(let n=0,r=s.length;n<r;n++){a||(a=new p6.PolygonShape);const h=s[n],_=(h.x+o.x)/A6*t,u=(h.y+o.y)/A6*e,d=new p6.Vec2(_,u);c.push(d),l||(l=d),c.length===p6.maxPolygonVertices&&(a.Set(c,c.length),i.push(a),a=null,n<r-1&&(c=[l,c[c.length-1]]))}a&&(a.Set(c,c.length),i.push(a))}return i}},MouseJoint:class extends L9{constructor(...t){super(...t),this._touchPoint=new Oi,this._isTouched=!1}setTarget(t){this._b2joint&&(F9.x=t.x/A6,F9.y=t.y/A6,this._b2joint.SetTarget(F9))}setDampingRatio(t){this._b2joint&&this._b2joint.SetDampingRatio(t)}setFrequency(t){this._b2joint&&this._b2joint.SetFrequency(t)}setMaxForce(t){this._b2joint&&this._b2joint.SetMaxForce(t)}_createJointDef(){const t=new p6.MouseJointDef,e=this._jointComp;return t.target.Set(this._touchPoint.x/A6,this._touchPoint.y/A6),t.maxForce=e.maxForce,t.dampingRatio=e.dampingRatio,t.frequencyHz=e.frequency,t}initialize(t){super.initialize(t);const e=YE("Canvas");e&&(e.on(fx.TOUCH_START,this.onTouchBegan,this),e.on(fx.TOUCH_MOVE,this.onTouchMove,this),e.on(fx.TOUCH_END,this.onTouchEnd,this),e.on(fx.TOUCH_CANCEL,this.onTouchEnd,this))}onEnable(){}start(){}onTouchBegan(t){this._isTouched=!0;const e=this._touchPoint.set(t.getUILocation()),i=i8.instance.physicsWorld.testPoint(e);if(i.length<=0)return;const n=i[0].body;n.wakeUp();const s=this._jointComp;s.connectedBody=n,this._init(),this.setMaxForce(s.maxForce*n.getMass()),this.setTarget(e)}onTouchMove(t){this._touchPoint=t.getUILocation()}onTouchEnd(t){this._destroy(),this._isTouched=!1}update(){this._isTouched&&this.isValid()&&this.setTarget(this._touchPoint)}},DistanceJoint:class extends L9{setMaxLength(t){this._b2joint&&this._b2joint.SetMaxLength(t)}_createJointDef(){const t=this._jointComp,e=new p6.RopeJointDef;return e.localAnchorA.Set(t.anchor.x/A6,t.anchor.y/A6),e.localAnchorB.Set(t.connectedAnchor.x/A6,t.connectedAnchor.y/A6),e.maxLength=t.maxLength/A6,e}},SpringJoint:class extends L9{setDampingRatio(t){this._b2joint&&this._b2joint.SetDampingRatio(t)}setFrequency(t){this._b2joint&&this._b2joint.SetFrequency(t)}setDistance(t){this._b2joint&&this._b2joint.SetLength(t)}_createJointDef(){const t=this._jointComp,e=new p6.DistanceJointDef;return e.localAnchorA.Set(t.anchor.x/A6,t.anchor.y/A6),e.localAnchorB.Set(t.connectedAnchor.x/A6,t.connectedAnchor.y/A6),e.length=t.distance/A6,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e}},RelativeJoint:class extends L9{setMaxForce(t){this._b2joint&&this._b2joint.SetMaxForce(t)}setAngularOffset(t){this._b2joint&&this._b2joint.SetAngularOffset(Ye(t))}setLinearOffset(t){this._b2joint&&this._b2joint.SetLinearOffset(new p6.Vec2(t.x/A6,t.y/A6))}setCorrectionFactor(t){this._b2joint&&(this._b2joint.m_correctionFactor=t)}setMaxTorque(t){this._b2joint&&this._b2joint.SetMaxTorque(t)}_createJointDef(){const t=this._jointComp,e=new p6.MotorJointDef;return e.linearOffset.Set(t.linearOffset.x/A6,t.linearOffset.y/A6),e.angularOffset=Ye(t.angularOffset),e.maxForce=t.maxForce,e.maxTorque=t.maxTorque,e.correctionFactor=t.correctionFactor,e}},SliderJoint:class extends L9{enableLimit(t){this._b2joint&&this._b2joint.EnableLimit(t)}setLowerLimit(t){this.updateLimits()}setUpperLimit(t){this.updateLimits()}updateLimits(){if(this._b2joint){const t=this._jointComp;this._b2joint.SetLimits(t.lowerLimit/A6,t.upperLimit/A6)}}enableMotor(t){this._b2joint&&this._b2joint.EnableMotor(t)}setMaxMotorForce(t){this._b2joint&&this._b2joint.SetMaxMotorForce(t)}setMotorSpeed(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)}_createJointDef(){const t=this._jointComp,e=new p6.PrismaticJointDef;e.localAnchorA.Set(t.anchor.x/A6,t.anchor.y/A6),e.localAnchorB.Set(t.connectedAnchor.x/A6,t.connectedAnchor.y/A6);const i=Ye(t.angle);return e.localAxisA.Set(Math.cos(i),Math.sin(i)),e.referenceAngle=0,e.enableLimit=t.enableLimit,e.lowerTranslation=t.lowerLimit/A6,e.upperTranslation=t.upperLimit/A6,e.enableMotor=t.enableMotor,e.maxMotorForce=t.maxMotorForce,e.motorSpeed=t.motorSpeed,e}},FixedJoint:class extends L9{setFrequency(t){this._b2joint&&this._b2joint.SetFrequency(t)}setDampingRatio(t){this._b2joint&&this._b2joint.SetDampingRatio(t)}_createJointDef(){const t=this._jointComp,e=new p6.WeldJointDef;return e.localAnchorA.Set(t.anchor.x/A6,t.anchor.y/A6),e.localAnchorB.Set(t.connectedAnchor.x/A6,t.connectedAnchor.y/A6),e.referenceAngle=0,e.frequencyHz=t.frequency,e.dampingRatio=t.dampingRatio,e}},WheelJoint:class extends L9{setDampingRatio(t){this._b2joint&&this._b2joint.SetSpringDampingRatio(t)}setFrequency(t){this._b2joint&&this._b2joint.SetSpringFrequencyHz(t)}enableMotor(t){this._b2joint&&this._b2joint.EnableMotor(t)}setMaxMotorTorque(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)}setMotorSpeed(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)}_createJointDef(){const t=this._jointComp,e=new p6.WheelJointDef;e.localAnchorA.Set(t.anchor.x/A6,t.anchor.y/A6),e.localAnchorB.Set(t.connectedAnchor.x/A6,t.connectedAnchor.y/A6);const i=Ye(t.angle);return e.localAxisA.Set(Math.cos(i),Math.sin(i)),e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=Ye(t.motorSpeed),e.enableMotor=t.enableMotor,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e}},HingeJoint:class extends L9{enableLimit(t){this._b2joint&&this._b2joint.EnableLimit(t)}setLowerAngle(t){this.updateLimits()}setUpperAngle(t){this.updateLimits()}updateLimits(){if(this._b2joint){const t=this._jointComp;this._b2joint.SetLimits(Ye(t.lowerAngle),Ye(t.upperAngle))}}enableMotor(t){this._b2joint&&this._b2joint.EnableMotor(t)}setMaxMotorTorque(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)}setMotorSpeed(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)}_createJointDef(){const t=this._jointComp,e=new p6.RevoluteJointDef;return e.localAnchorA.Set(t.anchor.x/A6,t.anchor.y/A6),e.localAnchorB.Set(t.connectedAnchor.x/A6,t.connectedAnchor.y/A6),e.enableMotor=t.enableMotor,e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=Ye(t.motorSpeed),e.enableLimit=t.enableLimit,e.lowerAngle=t.lowerAngle,e.upperAngle=t.upperAngle,e}}},h6=z9,l._global.CC_PHYSICS_2D_BUILTIN=!1,l._global.CC_PHYSICS_2D_BOX2D=!0,l6=V9;class j9{constructor(){this._arrayBufferOrPaddings=[],this._length=0}setNextAlignment(t){if(0!==t){const e=this._length%t;if(0!==e){const i=t-e;this._arrayBufferOrPaddings.push(i),this._length+=i}}}addBuffer(t){const e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e}getLength(){return this._length}getCombined(){const t=new Uint8Array(this._length);let e=0;return this._arrayBufferOrPaddings.forEach((i=>{"number"==typeof i?e+=i:(t.set(new Uint8Array(i),e),e+=i.byteLength)})),t.buffer}}class W9{constructor(t,e){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,!this._mesh.struct.morph)return;const i=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(i).fill(null);for(let t=0;t<i;++t){const i=this._mesh.struct.morph.subMeshMorphs[t];i&&(i.targets.length>Rm.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[t]=new X9(this._mesh,t,this._mesh.struct.morph,e):this._subMeshRenderings[t]=new q9(this._mesh,t,this._mesh.struct.morph,e))}}createInstance(){const t=this._mesh.struct.primitives.length,e=new Array(t);for(let s=0;s<t;++s){var i,n;e[s]=null!==(i=null===(n=this._subMeshRenderings[s])||void 0===n?void 0:n.createInstance())&&void 0!==i?i:null}return{setWeights(t,i){var n;null===(n=e[t])||void 0===n||n.setWeights(i)},requiredPatches:t=>{this._mesh.struct.morph;const i=this._mesh.struct.morph.subMeshMorphs[t],n=e[t];if(null===n)return null;const s=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(Ln.ATTR_POSITION)&&s.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(Ln.ATTR_NORMAL)&&s.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(Ln.ATTR_TANGENT)&&s.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),s.push(...n.requiredPatches()),s},adaptPipelineState:(t,i)=>{var n;null===(n=e[t])||void 0===n||n.adaptPipelineState(i)},destroy:()=>{for(const t of e)null==t||t.destroy()}}}}class q9{constructor(t,e,i,n){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=n;const s=i.subMeshMorphs[e];this._subMeshMorph=s,$9(t,e,n);const r=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=r;const o=s.targets.length,a=J9(n,r*o);this._textureInfo={width:a.width,height:a.height},this._attributes=s.attributes.map(((e,i)=>{const n=a.create(),o=n.valueView;return s.targets.forEach(((e,n)=>{const s=e.displacements[i],a=new Float32Array(t.data.buffer,t.data.byteOffset+s.offset,s.count),c=r*n*4;for(let t=0;t<r;++t)o[c+4*t+0]=a[3*t+0],o[c+4*t+1]=a[3*t+1],o[c+4*t+2]=a[3*t+2]})),n.updatePixels(),{name:e,morphTexture:n}}))}destroy(){for(const t of this._attributes)t.morphTexture.destroy()}createInstance(){const t=new K9(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:e=>{t.setWeights(e),t.commit()},requiredPatches:()=>[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}],adaptPipelineState:e=>{for(const t of this._attributes){let i;switch(t.name){case Ln.ATTR_POSITION:i=Nm;break;case Ln.ATTR_NORMAL:i=zm;break;case Ln.ATTR_TANGENT:i=Um;break;default:y("Unexpected attribute!")}void 0!==i&&(e.bindSampler(i,t.morphTexture.sampler),e.bindTexture(i,t.morphTexture.texture))}e.bindBuffer(Rm.BINDING,t.buffer),e.update()},destroy:()=>{}}}}class X9{constructor(t,e,i,n){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=n;const s=i.subMeshMorphs[e];$9(t,e,n),this._attributes=s.attributes.map(((e,i)=>({name:e,targets:s.targets.map((e=>({displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[i].offset,e.displacements[i].count)})))})))}get data(){return this._attributes}createInstance(){return new Y9(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)}}class Y9{constructor(t,e,i){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=t,this._morphUniforms=new K9(i,0);const n=J9(i,e);this._morphUniforms.setMorphTextureInfo(n.width,n.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((t=>{const e=n.create();return{attributeName:t.name,morphTexture:e}}))}setWeights(t){for(let e=0;e<this._attributes.length;++e){const i=this._attributes[e],n=i.morphTexture.valueView,s=this._owner.data[e];t.length,s.targets.length;for(let e=0;e<s.targets.length;++e){const i=s.targets[e].displacements,r=t[e],o=i.length/3;if(0===e)for(let t=0;t<o;++t)n[4*t+0]=i[3*t+0]*r,n[4*t+1]=i[3*t+1]*r,n[4*t+2]=i[3*t+2]*r;else if(0!==r)for(let t=0;t<o;++t)n[4*t+0]+=i[3*t+0]*r,n[4*t+1]+=i[3*t+1]*r,n[4*t+2]+=i[3*t+2]*r}i.morphTexture.updatePixels()}}requiredPatches(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]}adaptPipelineState(t){for(const e of this._attributes){let i;switch(e.attributeName){case Ln.ATTR_POSITION:i=Nm;break;case Ln.ATTR_NORMAL:i=zm;break;case Ln.ATTR_TANGENT:i=Um;break;default:y("Unexpected attribute!")}void 0!==i&&(t.bindSampler(i,e.morphTexture.sampler),t.bindTexture(i,e.morphTexture.texture))}t.bindBuffer(Rm.BINDING,this._morphUniforms.buffer),t.update()}destroy(){this._morphUniforms.destroy();for(let t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()}}class K9{constructor(t,e){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer(Rm.SIZE)),this._remoteBuffer=t.createBuffer(new Zn(en.UNIFORM|en.TRANSFER_DST,rn.HOST|rn.DEVICE,Rm.SIZE,Rm.SIZE))}destroy(){this._remoteBuffer.destroy()}get buffer(){return this._remoteBuffer}setWeights(t){t.length,this._targetCount;for(let e=0;e<t.length;++e)this._localBuffer.setFloat32(Rm.OFFSET_OF_WEIGHTS+4*e,t[e],l.sys.isLittleEndian)}setMorphTextureInfo(t,e){this._localBuffer.setFloat32(Rm.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,t,l.sys.isLittleEndian),this._localBuffer.setFloat32(Rm.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,e,l.sys.isLittleEndian)}setVerticesCount(t){this._localBuffer.setFloat32(Rm.OFFSET_OF_VERTICES_COUNT,t,l.sys.isLittleEndian)}commit(){this._remoteBuffer.update(this._localBuffer.buffer)}}function J9(t,e){let n,s,o,a;t.getFormatFeatures(Zi.RGBA32F)&ln.SAMPLED_TEXTURE?(n=e,o=16,s=xf.PixelFormat.RGBA32F,a=Float32Array):(n=4*e,o=4,s=xf.PixelFormat.RGBA8888,a=Uint8Array);const{width:c,height:l}=function(t){t<5&&(t=5);const e=i(r(t)),n=e>>1;return{width:1<<(1&e?n+1:n),height:1<<n}}(n);return{width:c,height:l,create:()=>{const e=new ArrayBuffer(c*l*o),i=new Float32Array(e),n=a===Float32Array?i:new a(e),r=new rf({width:c,height:l,_data:n,_compressed:!1,format:s}),h=new xf;h.setFilters(xf.Filter.NEAREST,xf.Filter.NEAREST),h.setMipFilter(xf.Filter.NONE),h.setWrapMode(xf.WrapMode.CLAMP_TO_EDGE,xf.WrapMode.CLAMP_TO_EDGE,xf.WrapMode.CLAMP_TO_EDGE),h.image=r,h.getGFXTexture()||y("Unexpected: failed to create morph texture?");const _=t.getSampler(h.getSamplerInfo());return{get texture(){return h.getGFXTexture()},get sampler(){return _},get valueView(){return i},destroy(){h.destroy()},updatePixels(){h.uploadData(n)}}}}}function $9(t,e,i){t.renderingSubMeshes[e].enableVertexIdChannel(i)}function Z9(t){switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}const Q9=new mi,ttt=new mi,ett=new Uint8Array;let itt=dc("cc.Mesh")((k9=sc((U9=class extends fh{get _nativeAsset(){return this._data.buffer}set _nativeAsset(t){this._data=new Uint8Array(t)}get subMeshCount(){const t=this.renderingSubMeshes;return t?t.length:0}get minPosition(){return this.struct.minPosition}get maxPosition(){return this.struct.maxPosition}get struct(){return this._struct}get data(){return this._data}get hash(){return this._hash||(this._hash=ur(this._data,666)),this._hash}get jointBufferIndices(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((t=>t.jointMapIndex||0))}get renderingSubMeshes(){return this.initialize(),this._renderingSubMeshes}constructor(){super(),this.morphRendering=null,nc(this,"_struct",k9,this),nc(this,"_hash",H9,this),this._data=ett,this._initialized=!1,this._renderingSubMeshes=null,this._boneSpaceBounds=new Map,this._jointBufferIndices=null}onLoaded(){this.initialize()}initialize(){if(this._initialized)return;this._initialized=!0;const{buffer:t}=this._data,e=l.director.root.device,i=this._createVertexBuffers(e,t),n=[];for(let s=0;s<this._struct.primitives.length;s++){const r=this._struct.primitives[s];if(0===r.vertexBundelIndices.length)continue;let o=null,a=null;if(r.indexView){const i=r.indexView;let n=i.stride,s=i.length;if(4===n&&!e.hasFeature($i.ELEMENT_INDEX_UINT)){const t=this._struct.vertexBundles[r.vertexBundelIndices[0]].view.count;if(t>=65536){I(10001,t,65536);continue}n>>=1,s>>=1}o=e.createBuffer(new Zn(en.INDEX,rn.DEVICE,s,n)),a=new(Z9(i.stride))(t,i.offset,i.count),i.stride!==n&&(a=Z9(n).from(a)),o.update(a)}const c=r.vertexBundelIndices.map((t=>i[t])),l=[];if(r.vertexBundelIndices.length>0){const t=r.vertexBundelIndices[0],e=this._struct.vertexBundles[t].attributes;for(let t=0;t<e.length;++t){const i=e[t];l[t]=new fs(i.name,i.format,i.isNormalized,i.stream,i.isInstanced,i.location)}}const h=new uA(c,l,r.primitiveMode,o);h.mesh=this,h.subMeshIdx=s,n.push(h)}this._renderingSubMeshes=n,this._struct.morph&&(this.morphRendering=function(t,e){return new W9(t,e)}(this,e))}destroy(){return this.destroyRenderingMesh(),super.destroy()}destroyRenderingMesh(){if(this._renderingSubMeshes){for(let t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1}}assign(t,e){this.reset({struct:t,data:e})}reset(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._hash=0}getBoneSpaceBounds(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);const e=[];this._boneSpaceBounds.set(t.hash,e);const i=[],{bindposes:n}=t;for(let t=0;t<n.length;t++)e.push(new La(1/0,1/0,1/0,-1/0,-1/0,-1/0)),i.push(!1);const{primitives:s}=this._struct;for(let t=0;t<s.length;t++){const s=this.readAttribute(t,Ln.ATTR_JOINTS),r=this.readAttribute(t,Ln.ATTR_WEIGHTS),o=this.readAttribute(t,Ln.ATTR_POSITION);if(!s||!r||!o)continue;const a=Math.min(s.length/4,r.length/4,o.length/3);for(let t=0;t<a;t++){mi.set(Q9,o[3*t+0],o[3*t+1],o[3*t+2]);for(let o=0;o<4;++o){const a=4*t+o,c=s[a];if(0===r[a]||c>=n.length)continue;mi.transformMat4(ttt,Q9,n[c]),i[c]=!0;const l=e[c];mi.min(l.center,l.center,ttt),mi.max(l.halfExtents,l.halfExtents,ttt)}}}for(let t=0;t<n.length;t++){const n=e[t];i[t]?La.fromPoints(n,n.center,n.halfExtents):e[t]=null}return e}merge(t,e,i){if(i&&!this.validateMergingMesh(t))return!1;const n=new mi,s=e&&new Si,r=e&&new La;if(s&&e.getRotation(s),!this._initialized){const i=JSON.parse(JSON.stringify(t._struct)),o=t._data.slice();if(e){i.maxPosition&&i.minPosition&&(mi.add(r.center,i.maxPosition,i.minPosition),mi.multiplyScalar(r.center,r.center,.5),mi.subtract(r.halfExtents,i.maxPosition,i.minPosition),mi.multiplyScalar(r.halfExtents,r.halfExtents,.5),La.transform(r,r,e),mi.add(i.maxPosition,r.center,r.halfExtents),mi.subtract(i.minPosition,r.center,r.halfExtents));for(let t=0;t<i.vertexBundles.length;t++){const r=i.vertexBundles[t];for(let t=0;t<r.attributes.length;t++)if(r.attributes[t].name===Ln.ATTR_POSITION||r.attributes[t].name===Ln.ATTR_NORMAL){const{format:i}=r.attributes[t],a=new DataView(o.buffer,r.view.offset+ntt(r.attributes,t)),c=ott(a,i),l=att(a,i);if(!c||!l)continue;const h=r.view.count,_=r.view.stride,u=rtt(i);for(let i=0;i<h;i++){const o=i*_,a=o+u,h=a+u;switch(n.set(c(o),c(a),c(h)),r.attributes[t].name){case Ln.ATTR_POSITION:n.transformMat4(e);break;case Ln.ATTR_NORMAL:mi.transformQuat(n,n,s)}l(o,n.x),l(a,n.y),l(h,n.z)}}}}return this.reset({struct:i,data:o}),this.initialize(),!0}const o=new j9;let a,c,l,h,_,u=0,d=0,m=0,p=0,f=0,g=0,v=0,y=0,x=!1;const S=new Array(this._struct.vertexBundles.length);for(let i=0;i<this._struct.vertexBundles.length;++i){const r=this._struct.vertexBundles[i],C=t._struct.vertexBundles[i];m=r.view.offset,p=C.view.offset,d=r.view.stride,u=r.view.count+C.view.count,a=new ArrayBuffer(u*d),c=new Uint8Array(a),l=this._data.subarray(m,m+r.view.length),m+=l.length,h=t._data.subarray(p,p+C.view.length),p+=h.length,c.set(l),f=0;for(const t of r.attributes){v=0,x=!1;for(const e of C.attributes){if(t.name===e.name&&t.format===e.format){x=!0;break}v+=Gs[e.format].size}if(x){y=Gs[t.format].size,g=r.view.length+f;for(let i=0;i<C.view.count;++i){if(_=h.subarray(v,v+y),c.set(_,g),(t.name===Ln.ATTR_POSITION||t.name===Ln.ATTR_NORMAL)&&e){const i=new Float32Array(c.buffer,g,3);switch(n.set(i[0],i[1],i[2]),t.name){case Ln.ATTR_POSITION:n.transformMat4(e);break;case Ln.ATTR_NORMAL:mi.transformQuat(n,n,s)}i[0]=n.x,i[1]=n.y,i[2]=n.z}g+=r.view.stride,v+=C.view.stride}}f+=Gs[t.format].size}S[i]={attributes:r.attributes,view:{offset:o.getLength(),length:a.byteLength,count:u,stride:d}},o.addBuffer(a)}let C,A,b,T=0,E=2,P=0;const w=new Array(this._struct.primitives.length);for(let e=0;e<this._struct.primitives.length;++e){const i=this._struct.primitives[e],n=t._struct.primitives[e];w[e]={primitiveMode:i.primitiveMode,vertexBundelIndices:i.vertexBundelIndices};for(const t of i.vertexBundelIndices)P=Math.max(P,this._struct.vertexBundles[t].view.count);if(i.indexView&&n.indexView){T=i.indexView.count,T+=n.indexView.count,m=i.indexView.offset,p=n.indexView.offset,E=T<256?1:T<65536?2:4;const s=new ArrayBuffer(T*E);if(C=2===E?new Uint16Array(s):1===E?new Uint8Array(s):new Uint32Array(s),A=2===i.indexView.stride?new Uint16Array(this._data.buffer,m,i.indexView.count):1===i.indexView.stride?new Uint8Array(this._data.buffer,m,i.indexView.count):new Uint32Array(this._data.buffer,m,i.indexView.count),E===i.indexView.stride)C.set(A);else for(let t=0;t<i.indexView.count;++t)C[t]=A[t];m+=i.indexView.length,b=2===n.indexView.stride?new Uint16Array(t._data.buffer,p,n.indexView.count):1===n.indexView.stride?new Uint8Array(t._data.buffer,p,n.indexView.count):new Uint32Array(t._data.buffer,p,n.indexView.count);for(let t=0;t<n.indexView.count;++t)C[i.indexView.count+t]=P+b[t];p+=n.indexView.length,w[e].indexView={offset:o.getLength(),length:s.byteLength,count:T,stride:E},o.setNextAlignment(E),o.addBuffer(s)}}const I={vertexBundles:S,primitives:w,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return I.minPosition&&t._struct.minPosition&&I.maxPosition&&t._struct.maxPosition&&(e?(mi.add(r.center,t._struct.maxPosition,t._struct.minPosition),mi.multiplyScalar(r.center,r.center,.5),mi.subtract(r.halfExtents,t._struct.maxPosition,t._struct.minPosition),mi.multiplyScalar(r.halfExtents,r.halfExtents,.5),La.transform(r,r,e),mi.add(n,r.center,r.halfExtents),mi.max(I.maxPosition,I.maxPosition,n),mi.subtract(n,r.center,r.halfExtents),mi.min(I.minPosition,I.minPosition,n)):(mi.min(I.minPosition,I.minPosition,t._struct.minPosition),mi.max(I.maxPosition,I.maxPosition,t._struct.maxPosition))),this.reset({struct:I,data:new Uint8Array(o.getCombined())}),this.initialize(),!0}validateMergingMesh(t){if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(let e=0;e<this._struct.vertexBundles.length;++e){const i=this._struct.vertexBundles[e],n=t._struct.vertexBundles[e];if(i.attributes.length!==n.attributes.length)return!1;for(let t=0;t<i.attributes.length;++t)if(i.attributes[t].format!==n.attributes[t].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(let e=0;e<this._struct.primitives.length;++e){const i=this._struct.primitives[e],n=t._struct.primitives[e];if(i.vertexBundelIndices.length!==n.vertexBundelIndices.length)return!1;for(let t=0;t<i.vertexBundelIndices.length;++t)if(i.vertexBundelIndices[t]!==n.vertexBundelIndices[t])return!1;if(i.primitiveMode!==n.primitiveMode)return!1;if(i.indexView){if(void 0===n.indexView)return!1}else if(n.indexView)return!1}return!0}readAttribute(t,e){let i=null;return this._accessAttribute(t,e,((t,e)=>{const n=t.view.count,{format:s}=t.attributes[e],r=Ks(Gs[s]);if(0===n)return;const o=new DataView(this._data.buffer,t.view.offset+ntt(t.attributes,e)),a=Gs[s],c=ott(o,s);if(!r||!c)return;const l=a.count,h=new r(n*l),_=t.view.stride;for(let t=0;t<n;++t)for(let e=0;e<l;++e)h[l*t+e]=c(_*t+h.BYTES_PER_ELEMENT*e);i=h})),i}copyAttribute(t,e,i,n,s){let r=!1;return this._accessAttribute(t,e,((t,e)=>{const o=t.view.count;if(0===o)return void(r=!0);const{format:a}=t.attributes[e],c=new DataView(this._data.buffer,t.view.offset+ntt(t.attributes,e)),l=new DataView(i,s),h=Gs[a],_=ott(c,a),u=att(l,a);if(!_||!u)return;const d=h.count,m=t.view.stride,p=rtt(a),f=n,g=p;for(let t=0;t<o;++t)for(let e=0;e<d;++e)u(f*t+g*e,_(m*t+p*e));r=!0})),r}readIndices(t){if(t>=this._struct.primitives.length)return null;const e=this._struct.primitives[t];if(!e.indexView)return null;const{stride:i}=e.indexView;return new(1===i?Uint8Array:2===i?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)}copyIndices(t,e){if(t>=this._struct.primitives.length)return!1;const i=this._struct.primitives[t];if(!i.indexView)return!1;const n=i.indexView.count,s=1===i.indexView.stride?Zi.R8UI:2===i.indexView.stride?Zi.R16UI:Zi.R32UI,r=ott(new DataView(this._data.buffer),s);for(let t=0;t<n;++t)e[t]=r(i.indexView.offset+Gs[s].size*t);return!0}_accessAttribute(t,e,i){if(t>=this._struct.primitives.length)return;const n=this._struct.primitives[t];for(const t of n.vertexBundelIndices){const n=this._struct.vertexBundles[t],s=n.attributes.findIndex((t=>t.name===e));if(!(s<0)){i(n,s);break}}}_createVertexBuffers(t,e){return this._struct.vertexBundles.map((i=>{const n=t.createBuffer(new Zn(en.VERTEX,rn.DEVICE,i.view.length,i.view.stride)),s=new Uint8Array(e,i.view.offset,i.view.length);return n.update(s),n}))}initDefault(t){super.initDefault(t),this.reset({struct:{vertexBundles:[],primitives:[]},data:ett})}}).prototype,"_struct",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),H9=sc(U9.prototype,"_hash",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),G9=U9))||G9;function ntt(t,e){let i=0;for(let n=0;n<e;++n){const e=t[n];i+=Gs[e.format].size}return i}l.Mesh=itt;const{isLittleEndian:stt}=qh;function rtt(t){const e=Gs[t];return e.size/e.count}function ott(t,e){const i=Gs[e],n=i.size/i.count;switch(i.type){case Qi.UNORM:switch(n){case 1:return e=>t.getUint8(e);case 2:return e=>t.getUint16(e,stt);case 4:return e=>t.getUint32(e,stt)}break;case Qi.SNORM:case Qi.INT:switch(n){case 1:return e=>t.getInt8(e);case 2:return e=>t.getInt16(e,stt);case 4:return e=>t.getInt32(e,stt)}break;case Qi.UINT:switch(n){case 1:return e=>t.getUint8(e);case 2:return e=>t.getUint16(e,stt);case 4:return e=>t.getUint32(e,stt)}break;case Qi.FLOAT:return e=>t.getFloat32(e,stt)}return null}function att(t,e){const i=Gs[e],n=i.size/i.count;switch(i.type){case Qi.UNORM:switch(n){case 1:return(e,i)=>t.setUint8(e,i);case 2:return(e,i)=>t.setUint16(e,i,stt);case 4:return(e,i)=>t.setUint32(e,i,stt)}break;case Qi.SNORM:case Qi.INT:switch(n){case 1:return(e,i)=>t.setInt8(e,i);case 2:return(e,i)=>t.setInt16(e,i,stt);case 4:return(e,i)=>t.setInt32(e,i,stt)}break;case Qi.UINT:switch(n){case 1:return(e,i)=>t.setUint8(e,i);case 2:return(e,i)=>t.setUint16(e,i,stt);case 4:return(e,i)=>t.setUint32(e,i,stt)}break;case Qi.FLOAT:return(e,i)=>t.setFloat32(e,i,stt)}return null}class ctt extends hv{constructor(...t){super(...t),this._morphRenderingInstance=null,this._usedMaterials=new Set}getMacroPatches(t){const e=super.getMacroPatches(t);if(this._morphRenderingInstance){const i=this._morphRenderingInstance.requiredPatches(t);if(i)return i.concat(null!=e?e:[])}return e}initSubModel(t,e,i){return super.initSubModel(t,e,this._launderMaterial(i))}destroy(){super.destroy(),this._morphRenderingInstance=null}setSubModelMaterial(t,e){return super.setSubModelMaterial(t,this._launderMaterial(e))}setMorphRendering(t){this._morphRenderingInstance=t}_updateLocalDescriptors(t,e){super._updateLocalDescriptors(t,e),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,e)}_launderMaterial(t){return t}}var ltt,htt,_tt,utt,dtt,mtt,ptt,ftt,gtt,vtt,ytt,xtt,Stt,Ctt,Att,btt,Ttt,Ett,Ptt,wtt,Itt,Rtt,Dtt,Mtt,Ott,Btt,Ntt,Ltt,Ftt,ztt,Vtt,Gtt,Utt,ktt,Htt,jtt,Wtt,qtt,Xtt,Ytt;const Ktt=jt({OFF:0,ON:1}),Jtt=jt({OFF:0,ON:1});let $tt=(ltt=dc("cc.ModelLightmapSettings"),htt=Cc("_recieveShadow"),ltt((dtt=sc((utt=class{constructor(){nc(this,"texture",dtt,this),nc(this,"uvParam",mtt,this),nc(this,"_bakeable",ptt,this),nc(this,"_castShadow",ftt,this),nc(this,"_receiveShadow",gtt,this),nc(this,"_lightmapSize",vtt,this)}get bakeable(){return this._bakeable}set bakeable(t){this._bakeable=t}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t}get receiveShadow(){return this._receiveShadow}set receiveShadow(t){this._receiveShadow=t}get lightmapSize(){return this._lightmapSize}set lightmapSize(t){this._lightmapSize=t}}).prototype,"texture",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mtt=sc(utt.prototype,"uvParam",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi}}),ptt=sc(utt.prototype,"_bakeable",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ftt=sc(utt.prototype,"_castShadow",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gtt=sc(utt.prototype,"_receiveShadow",[htt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vtt=sc(utt.prototype,"_lightmapSize",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),sc(utt.prototype,"bakeable",[Mc],Object.getOwnPropertyDescriptor(utt.prototype,"bakeable"),utt.prototype),sc(utt.prototype,"castShadow",[Mc],Object.getOwnPropertyDescriptor(utt.prototype,"castShadow"),utt.prototype),sc(utt.prototype,"receiveShadow",[Mc],Object.getOwnPropertyDescriptor(utt.prototype,"receiveShadow"),utt.prototype),sc(utt.prototype,"lightmapSize",[Mc],Object.getOwnPropertyDescriptor(utt.prototype,"lightmapSize"),utt.prototype),_tt=utt))||_tt),Ztt=(ytt=dc("cc.MeshRenderer"),xtt=Dc(),Stt=pc(100),Ctt=Pc(),Att=Kc(fe),btt=Lc(),Ttt=gc({group:{name:"DynamicShadowSettings",displayOrder:0}}),Ett=Kc(fe),Ptt=Lc(),wtt=gc({group:{name:"DynamicShadowSettings",displayOrder:1}}),Itt=Kc(Ktt),Rtt=Lc(),Dtt=gc({group:{name:"DynamicShadowSettings",displayOrder:2}}),Mtt=Kc(Jtt),Ott=Lc(),Btt=gc({group:{name:"DynamicShadowSettings",displayOrder:3}}),Ntt=Kc(itt),Ltt=Lc(),Ftt=Oc(),ytt(ztt=xtt(ztt=Stt(ztt=Ctt(ztt=Ec((Ytt=Xtt=class extends DD{get shadowBias(){return this._shadowBias}set shadowBias(t){this._shadowBias=t,this._updateShadowBias(),this._onUpdateLocalShadowBias()}get shadowNormalBias(){return this._shadowNormalBias}set shadowNormalBias(t){this._shadowNormalBias=t,this._updateShadowNormalBias(),this._onUpdateLocalShadowBias()}get shadowCastingMode(){return this._shadowCastingMode}set shadowCastingMode(t){this._shadowCastingMode=t,this._updateCastShadow()}get receiveShadow(){return this._shadowReceivingMode}set receiveShadow(t){this._shadowReceivingMode=t,this._updateReceiveShadow()}get mesh(){return this._mesh}set mesh(t){const e=this._mesh,i=this._mesh=t;null==i||i.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(e),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}get model(){return this._model}get enableMorph(){return this._enableMorph}set enableMorph(t){this._enableMorph=t}constructor(){super(),nc(this,"lightmapSettings",Gtt,this),nc(this,"_mesh",Utt,this),nc(this,"_shadowCastingMode",ktt,this),nc(this,"_shadowReceivingMode",Htt,this),nc(this,"_shadowBias",jtt,this),nc(this,"_shadowNormalBias",Wtt,this),this._subMeshShapesWeights=[],this._modelType=void 0,this._model=null,this._morphInstance=null,nc(this,"_enableMorph",qtt,this),this._modelType=hv}onLoad(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias()}onRestore(){this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias()}onEnable(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias(),this._onUpdateLocalShadowBias(),this._attachToScene()}onDisable(){this._model&&this._detachFromScene()}onDestroy(){this._model&&(l.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()}getWeight(t,e){const{_subMeshShapesWeights:i}=this;i.length;const n=this._subMeshShapesWeights[t];return n.length,n[e]}setWeights(t,e){const{_subMeshShapesWeights:i}=this;e>=i.length||i[e].length===t.length&&(i[e]=t.slice(0),this._uploadSubMeshShapesWeights(e))}setWeight(t,e,i){const{_subMeshShapesWeights:n}=this;if(e>=n.length)return;const s=n[e];i>=s.length||(s[i]=t,this._uploadSubMeshShapesWeights(e))}setInstancedAttribute(t,e){if(!this.model)return;const{attributes:i,views:n}=this.model.instancedAttributes;for(let s=0;s<i.length;s++)if(i[s].name===t){n[s].set(e);break}}_updateLightmap(t,e,i,n,s){this.lightmapSettings.texture=t,this.lightmapSettings.uvParam.x=e,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=n,this.lightmapSettings.uvParam.w=s,this._onUpdateLightingmap()}_updateModels(){if(!this.enabledInHierarchy)return;const t=this._model;t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model&&(this._mesh&&this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap(),this._onUpdateLocalShadowBias())}_createModel(){const t=this._morphInstance&&this._modelType===hv?ctt:this._modelType,e=this._model=l.director.root.createModel(t);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&e instanceof ctt&&e.setMorphRendering(this._morphInstance)}_attachToScene(){if(!this.node.scene||!this._model)return;const t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}_detachFromScene(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}_updateModelParams(){if(!this._mesh||!this._model)return;this.node.hasChangedFlags|=bv.POSITION,this._model.transform.hasChangedFlags|=bv.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();const t=this._mesh?this._mesh.renderingSubMeshes.length:0,e=this._mesh.renderingSubMeshes;if(e)for(let i=0;i<t;++i){let t=this.getRenderMaterial(i);t&&!t.isValid&&(t=null);const n=e[i];n&&this._model.initSubModel(i,n,t||this._getBuiltinMaterial())}this._model.enabled=!0}_onUpdateLightingmap(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])}_onUpdateLocalShadowBias(){null!==this.model&&this.model.updateLocalShadowBias(),this.setInstancedAttribute("a_localShadowBias",[this._shadowBias,this._shadowNormalBias])}_onMaterialModified(t,e){this._model&&this._model.inited&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())}_onRebuildPSO(t,e){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(t,e),this._onUpdateLightingmap(),this._onUpdateLocalShadowBias())}_onMeshChanged(t){}_clearMaterials(){if(!this._model)return;const t=this._model.subModels;for(let e=0;e<t.length;++e)this._onMaterialModified(e,null)}_getBuiltinMaterial(){return Mf.get("missing-material")}_onVisibilityChange(t){this._model&&(this._model.visFlags=t)}_updateShadowBias(){this._model&&(this._model.shadowBias=this._shadowBias)}_updateShadowNormalBias(){this._model&&(this._model.shadowNormalBias=this._shadowNormalBias)}_updateCastShadow(){this._model&&(this._shadowCastingMode===Ktt.OFF?this._model.castShadow=!1:(this._shadowCastingMode,Ktt.ON,this._shadowCastingMode,this._model.castShadow=!0))}_updateReceiveShadow(){this._model&&(this._shadowReceivingMode===Jtt.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)}_isBatchingEnabled(){for(let t=0;t<this._materials.length;++t){const e=this._materials[t];if(e)for(let t=0;t<e.passes.length;++t)if(e.passes[t].batchingScheme)return!0}return!1}_watchMorphInMesh(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),!this._enableMorph)return;if(!this._mesh||!this._mesh.struct.morph||!this._mesh.morphRendering)return;this._morphInstance=this._mesh.morphRendering.createInstance();const t=this._mesh.struct.primitives.length;for(let e=0;e<t;++e)this._uploadSubMeshShapesWeights(e);this._model&&this._model instanceof ctt&&this._model.setMorphRendering(this._morphInstance)}_initSubMeshShapesWeights(){const{_mesh:t}=this;if(this._subMeshShapesWeights.length=0,!t)return;const e=t.struct.morph;if(!e)return;const i=e.weights;this._subMeshShapesWeights=e.subMeshMorphs.map((t=>t?t.weights?t.weights.slice(0):i?(i.length,t.targets.length,i.slice(0)):new Array(t.targets.length).fill(0):[]))}_validateShapeWeights(){const{_mesh:t,_subMeshShapesWeights:e}=this;if(!t||!t.struct.morph)return 0===e.length;const{morph:i}=t.struct;return i.subMeshMorphs.length===e.length&&e.every((({length:t},e)=>{var n,s;return(null!==(n=null===(s=i.subMeshMorphs[e])||void 0===s?void 0:s.targets.length)&&void 0!==n?n:0)===t}))}_uploadSubMeshShapesWeights(t){var e;null===(e=this._morphInstance)||void 0===e||e.setWeights(t,this._subMeshShapesWeights[t])}},Xtt.ShadowCastingMode=Ktt,Xtt.ShadowReceivingMode=Jtt,Gtt=sc((Vtt=Ytt).prototype,"lightmapSettings",[Sc,Mc,jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $tt}}),Utt=sc(Vtt.prototype,"_mesh",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ktt=sc(Vtt.prototype,"_shadowCastingMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ktt.OFF}}),Htt=sc(Vtt.prototype,"_shadowReceivingMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jtt.ON}}),jtt=sc(Vtt.prototype,"_shadowBias",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wtt=sc(Vtt.prototype,"_shadowNormalBias",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sc(Vtt.prototype,"shadowBias",[Att,btt,Ttt,jc],Object.getOwnPropertyDescriptor(Vtt.prototype,"shadowBias"),Vtt.prototype),sc(Vtt.prototype,"shadowNormalBias",[Ett,Ptt,wtt,jc],Object.getOwnPropertyDescriptor(Vtt.prototype,"shadowNormalBias"),Vtt.prototype),sc(Vtt.prototype,"shadowCastingMode",[Itt,Rtt,Dtt,jc],Object.getOwnPropertyDescriptor(Vtt.prototype,"shadowCastingMode"),Vtt.prototype),sc(Vtt.prototype,"receiveShadow",[Mtt,Ott,Btt,jc],Object.getOwnPropertyDescriptor(Vtt.prototype,"receiveShadow"),Vtt.prototype),sc(Vtt.prototype,"mesh",[Ntt,Ltt],Object.getOwnPropertyDescriptor(Vtt.prototype,"mesh"),Vtt.prototype),sc(Vtt.prototype,"enableMorph",[Ftt,jc],Object.getOwnPropertyDescriptor(Vtt.prototype,"enableMorph"),Vtt.prototype),qtt=sc(Vtt.prototype,"_enableMorph",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ztt=Vtt))||ztt)||ztt)||ztt)||ztt)||ztt);var Qtt;!function(t){t[t.positions=Ln.ATTR_POSITION]="positions",t[t.normals=Ln.ATTR_NORMAL]="normals",t[t.uvs=Ln.ATTR_TEX_COORD]="uvs",t[t.colors=Ln.ATTR_COLOR]="colors"}(Qtt||(Qtt={}));const tet=[new fs(Ln.ATTR_POSITION,Zi.RGB32F),new fs(Ln.ATTR_NORMAL,Zi.RGB32F),new fs(Ln.ATTR_TEX_COORD,Zi.RG32F),new fs(Ln.ATTR_TANGENT,Zi.RGBA32F),new fs(Ln.ATTR_COLOR,Zi.RGBA32F)],eet=new mi;var iet;let net=dc("cc.PerfCounter")(iet=class extends class{get value(){return this._value}set value(t){this._value=t}constructor(t,e,i){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=e,this._accumStart=i}sample(t){this._average(this._value,t)}human(){const{average:t,isInteger:e}=this._opts,i=t?this._averageValue:this._value;return e?Math.round(i):Math.round(100*i)/100}alarm(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}_average(t,e=0){if(this._opts.average){this._accumValue+=t,++this._accumSamples;const i=e;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}}}{constructor(t,e,i){super(t,e,i),this._time=void 0,this._time=i}start(t=0){this._time=t}end(t=0){this._value=t-this._time,this._average(this._value)}tick(){this.end(),this.start()}frame(t){const e=t,i=e-this._time;this._total++,i>(this._opts.average||1e3)&&(this._value=1e3*this._total/i,this._total=0,this._time=e,this._average(this._value))}})||iet;const set="0123456789. ",ret=500,oet={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},aet={fps:{desc:"Framerate (FPS)",below:30,average:ret,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:ret},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:ret,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:ret},render:{desc:"Renderer (ms)",min:0,max:50,average:ret,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},cet={fontSize:23,quadHeight:.4,segmentsPerLine:8,textureWidth:256,textureHeight:256};class het{constructor(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new qn,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=cet.textureHeight/(Object.keys(aet).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}reset(){this._stats=null,this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer&&this._meshRenderer.destroy(),this._meshRenderer=null,this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=cet.textureHeight/(Object.keys(aet).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0}isShowingStats(){return this._showFPS}hideStats(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),l.director.off(l.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),l.director.off(l.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),l.director.off(l.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),l.director.off(l.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),l.director.off(l.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),l.director.off(l.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,this._pipeline.profiler=null,l.game.config.showFPS=!1)}showStats(){if(!this._showFPS){if(!this._device){const t=l.director.root;this._device=t.device,this._swapchain=t.mainWindow.swapchain,this._pipeline=t.pipeline}this.generateCanvas(),this.generateStats(),l.game.once(l.Game.EVENT_ENGINE_INITED,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),l.director.on(l.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),l.director.on(l.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),l.director.on(l.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),l.director.on(l.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),l.director.on(l.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),l.director.on(l.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,l.game.config.showFPS=!0}}generateCanvas(){if(this._canvasDone)return;const{textureWidth:t,textureHeight:e}=cet;this._ctx&&this._canvas&&(this._canvas.width=t,this._canvas.height=e,this._canvas.style.width=`${this._canvas.width}`,this._canvas.style.height=`${this._canvas.height}`,this._ctx.font=`${cet.fontSize}px Arial`,this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new ss(on.TEX2D,an.SAMPLED|an.TRANSFER_DST,Zi.RGBA8,t,e)),this._region.texExtent.width=t,this._region.texExtent.height=e)}generateStats(){if(this._statsDone||!this._ctx||!this._canvas)return;this._stats=null;const t=performance.now();this._ctx.textAlign="left";let e=0;for(const i in aet){const n=aet[i];this._ctx.fillText(n.desc,0,e*this._lineHeight),n.counter=new net(i,n,t),e++}this._totalLines=e,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(let t=0;t<set.length;++t){const e=this._ctx.measureText(set[t]).width;this._eachNumWidth=Math.max(this._eachNumWidth,e)}for(let t=0;t<set.length;++t)this._ctx.fillText(set[t],t*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=aet,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}generateNode(){if(this._rootNode&&this._rootNode.isValid)return;this._rootNode=new iS("PROFILER_NODE"),l.game.addPersistRootNode(this._rootNode);const t=new iS("Profiler_Root");t.parent=this._rootNode;const e=cet.quadHeight,i=e/this._totalLines,n=e/this._wordHeight,s=i/cet.fontSize,r=this._eachNumWidth*this._canvas.width*s,o=[0,e,0,n,e,0,n,0,0,0,0,0],a=[0,2,1,0,3,2],c=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0];let h=0;for(let t=0;t<this._totalLines;t++)for(let s=0;s<cet.segmentsPerLine;s++){o.push(n+s*r,e-t*i,0),o.push(n+(s+1)*r,e-t*i,0),o.push(n+(s+1)*r,e-(t+1)*i,0),o.push(n+s*r,e-(t+1)*i,0),h=4*(t*cet.segmentsPerLine+s+1),a.push(0+h,2+h,1+h,0+h,3+h,2+h);const l=t*cet.segmentsPerLine+s,_=Math.floor(l/4),u=l-4*_;c.push(0,this._wordHeight,_,u),c.push(this._eachNumWidth,this._wordHeight,_,u),c.push(this._eachNumWidth,1,_,u),c.push(0,1,_,u)}this._meshRenderer=t.addComponent(Ztt),this._meshRenderer.mesh=function(t,e,i){i=i||{};const n=[];let s=0;const r=[];let o,a=0;const c=t.positions.slice();if(c.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===Ln.ATTR_POSITION){o=e;break}o||(o=tet[0]),n.push(o);const e=Gs[o.format];a=Math.max(a,Math.floor(c.length/e.count)),r.push({offset:s,data:c,attribute:o}),s+=e.size}if(t.normals&&t.normals.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===Ln.ATTR_NORMAL){o=e;break}o||(o=tet[1]);const e=Gs[o.format];n.push(o),a=Math.max(a,Math.floor(t.normals.length/e.count)),r.push({offset:s,data:t.normals,attribute:o}),s+=e.size}if(t.uvs&&t.uvs.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===Ln.ATTR_TEX_COORD){o=e;break}o||(o=tet[2]);const e=Gs[o.format];n.push(o),a=Math.max(a,Math.floor(t.uvs.length/e.count)),r.push({offset:s,data:t.uvs,attribute:o}),s+=e.size}if(t.tangents&&t.tangents.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===Ln.ATTR_TANGENT){o=e;break}o||(o=tet[3]);const e=Gs[o.format];n.push(o),a=Math.max(a,Math.floor(t.tangents.length/e.count)),r.push({offset:s,data:t.tangents,attribute:o}),s+=e.size}if(t.colors&&t.colors.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===Ln.ATTR_COLOR){o=e;break}o||(o=tet[4]);const e=Gs[o.format];n.push(o),a=Math.max(a,Math.floor(t.colors.length/e.count)),r.push({offset:s,data:t.colors,attribute:o}),s+=e.size}if(t.customAttributes)for(const e of t.customAttributes){const t=Gs[e.attr.format];n.push(e.attr),a=Math.max(a,Math.floor(e.values.length/t.count)),r.push({offset:s,data:e.values,attribute:e.attr}),s+=t.size}const l=new j9,h=new ArrayBuffer(a*s),_=new DataView(h);for(const t of r)lA(_,t.data,t.attribute.format,t.offset,s);l.setNextAlignment(0);const u={attributes:n,view:{offset:l.getLength(),length:h.byteLength,count:a,stride:s}};l.addBuffer(h);let d=null,m=0;if(t.indices){const{indices:e}=t;m=e.length,d=new ArrayBuffer(2*m),lA(new DataView(d),e,Zi.R16UI)}const p={primitiveMode:t.primitiveMode||Tn.TRIANGLE_LIST,vertexBundelIndices:[0]};d&&(l.setNextAlignment(2),p.indexView={offset:l.getLength(),length:d.byteLength,count:m,stride:2},l.addBuffer(d));let f=t.minPos;if(!f&&i.calculateBounds){f=mi.set(new mi,1/0,1/0,1/0);for(let t=0;t<a;++t)mi.set(eet,c[3*t+0],c[3*t+1],c[3*t+2]),mi.min(f,f,eet)}let g=t.maxPos;if(!g&&i.calculateBounds){g=mi.set(new mi,-1/0,-1/0,-1/0);for(let t=0;t<a;++t)mi.set(eet,c[3*t+0],c[3*t+1],c[3*t+2]),mi.max(g,g,eet)}const v={vertexBundles:[u],primitives:[p]};return f&&(v.minPosition=new mi(f.x,f.y,f.z)),g&&(v.maxPosition=new mi(g.x,g.y,g.z)),e||(e=new itt),e.reset({struct:v,data:new Uint8Array(l.getCombined())}),e}({positions:o,indices:a,colors:c});const _=new sg;_.initialize({effectName:"profiler"});const u=this.pass=_.passes[0],d=u.getBinding("mainTexture"),m=u.getBinding("digits"),p=u.getBinding("offset");u.bindTexture(d,this._texture),this.digitsData=u.blocks[m],this.offsetData=u.blocks[p],this.offsetData[3]=-1,this._meshRenderer.material=_,this._meshRenderer.node.layer=Yd.Enum.PROFILER,this._inited=!0}beforeUpdate(){if(!this._stats)return;const t=performance.now();this._stats.frame.counter.start(t),this._stats.logic.counter.start(t)}afterUpdate(){if(!this._stats)return;const t=performance.now();l.director.isPaused()?this._stats.frame.counter.start(t):this._stats.logic.counter.end(t)}beforePhysics(){if(!this._stats)return;const t=performance.now();this._stats.physics.counter.start(t)}afterPhysics(){if(!this._stats)return;const t=performance.now();this._stats.physics.counter.end(t)}beforeDraw(){if(!this._stats||!this._inited)return;{const t=this._swapchain.surfaceTransform,e=this._device.capabilities.clipSpaceSignY;if(t!==this.offsetData[3]){const i=wi[t],n=-.9,s=-.9*e;this.offsetData[0]=n*i[0]+s*i[2],this.offsetData[1]=n*i[1]+s*i[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=t}this.pass._setRootBufferDirty(!0)}this._meshRenderer.model&&(this._pipeline.profiler=this._meshRenderer.model);const t=performance.now();this._stats.render.counter.start(t)}afterDraw(){if(!this._stats||!this._inited)return;const t=performance.now();if(this._stats.frame.counter.end(t),this._stats.fps.counter.frame(t),this._stats.render.counter.end(t),t-this.lastTime<ret)return;this.lastTime=t;const e=this._device;this._stats.draws.counter.value=e.numDrawCalls,this._stats.instances.counter.value=e.numInstances,this._stats.bufferMemory.counter.value=e.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=e.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=e.numTris;let i=0;{const e=this.digitsData;for(const n in this._stats){const s=this._stats[n];s.counter.sample(t);const r=s.counter.human().toString();for(let t=cet.segmentsPerLine-1;t>=0;t--){const n=i*cet.segmentsPerLine+t,s=r[r.length-(cet.segmentsPerLine-t)];let o=oet[s];void 0===o&&(o=11),e[n]=o}i++}}}}t("Profiler",het);const _et=t("profiler",new het);l.profiler=_et;const uet=new os(un.POINT,un.POINT,un.NONE,dn.CLAMP,dn.CLAMP,dn.CLAMP),det=function(t,e,i){t[e+0]=i.m00,t[e+1]=i.m01,t[e+2]=i.m02,t[e+3]=i.m12,t[e+4]=i.m04,t[e+5]=i.m05,t[e+6]=i.m06,t[e+7]=i.m13,t[e+8]=i.m08,t[e+9]=i.m09,t[e+10]=i.m10,t[e+11]=i.m14};function met(t,e){const i=4/Math.sqrt(e);return 12*Math.ceil(Math.max(480*i,t)/12)}new Si,new Si,new mi,new Si,new mi;const pet=new mi,fet=new mi,get=new mi,vet=new mi,yet=new Ii,xet=new Ii,Cet=new La,Aet=Number.MAX_SAFE_INTEGER;class bet{get pixelsPerJoint(){return this._pixelsPerJoint}constructor(t){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;const e=function(t){return t.getFormatFeatures(Zi.RGBA32F)&ln.SAMPLED_TEXTURE?Zi.RGBA32F:Zi.RGBA8}(this._device);this._formatSize=Gs[e].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new jv(t),this._pool.initialize({format:e,roundUpFn:met}),this._customPool=new jv(t),this._customPool.initialize({format:e,roundUpFn:met})}clear(){this._pool.destroy(),this._textureBuffers.clear()}registerCustomTextureLayouts(t){for(let e=0;e<t.length;e++){const i=t[e],n=this._customPool.createChunk(i.textureLength);for(let t=0;t<i.contents.length;t++){const e=i.contents[t],{skeleton:s}=e;this._chunkIdxMap.set(s,n);for(let t=0;t<e.clips.length;t++){const i=e.clips[t];this._chunkIdxMap.set(s^i,n)}}}}getDefaultPoseTexture(t,e,i){const n=0^t.hash;let s=this._textureBuffers.get(n)||null;if(s&&s.bounds.has(e.hash))return s.refCount++,s;const{joints:r,bindposes:o}=t;let a=null,c=!1;const l=r.length;if(s)s.refCount++;else{const e=12*l,i=this._chunkIdxMap.get(n),r=void 0!==i?this._customPool.alloc(e*Float32Array.BYTES_PER_ELEMENT,i):this._pool.alloc(e*Float32Array.BYTES_PER_ELEMENT);if(!r)return s;s={pixelOffset:r.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:0,readyToBeDeleted:!1,handle:r},a=new Float32Array(e),c=!0}mi.set(get,Aet,Aet,Aet),mi.set(vet,-Aet,-Aet,-Aet);const h=e.getBoneSpaceBounds(t);for(let e=0,n=0;e<l;e++,n+=12){const s=i.getChildByPath(r[e]),l=s?zJ(s,i,yet):t.inverseBindposes[e],_=h[e];_&&(La.transform(Cet,_,l),Cet.getBoundary(pet,fet),mi.min(get,get,pet),mi.max(vet,vet,fet)),c&&(s&&Ii.multiply(l,l,o[e]),det(a,n,s?l:Ii.IDENTITY))}const _=[new La];return s.bounds.set(e.hash,_),La.fromPoints(_[0],get,vet),c&&(this._pool.update(s.handle,a.buffer),this._textureBuffers.set(n,s)),s}getSequencePoseTexture(t,e,i,n){const s=t.hash^e.hash;let r=this._textureBuffers.get(s)||null;if(r&&r.bounds.has(i.hash))return r.refCount++,r;const{joints:o,bindposes:a}=t,c=KW.getOrExtract(e),{frames:l}=c;let h=null,_=!1;const u=o.length;if(r)r.refCount++;else{const i=12*u*l,o=this._chunkIdxMap.get(s),a=void 0!==o?this._customPool.alloc(i*Float32Array.BYTES_PER_ELEMENT,o):this._pool.alloc(i*Float32Array.BYTES_PER_ELEMENT);if(!a)return null;const c=this._createAnimInfos(t,e,n);r={pixelOffset:a.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:e.hash,readyToBeDeleted:!1,handle:a,animInfos:c},h=new Float32Array(i),_=!0}const d=i.getBoneSpaceBounds(t),m=[];r.bounds.set(i.hash,m);for(let t=0;t<l;t++)m.push(new La(Aet,Aet,Aet,-Aet,-Aet,-Aet));for(let e=0,i=0;e<l;e++){const n=m[e];for(let s=0;s<u;s++,i+=12){const{curveData:o,downstream:c,bindposeIdx:l,bindposeCorrection:u}=r.animInfos[s];let m,p=!0;o&&c?m=Ii.multiply(yet,o[e],c):o?m=o[e]:c?m=c:(m=t.inverseBindposes[l],p=!1);const f=d[s];if(f){const t=u?Ii.multiply(xet,m,u):m;La.transform(Cet,f,t),Cet.getBoundary(pet,fet),mi.min(n.center,n.center,pet),mi.max(n.halfExtents,n.halfExtents,fet)}_&&(p&&Ii.multiply(yet,m,a[l]),det(h,i,p?yet:Ii.IDENTITY))}La.fromPoints(n,n.center,n.halfExtents)}return _&&(this._pool.update(r.handle,h.buffer),this._textureBuffers.set(s,r)),r}releaseHandle(t){if(t.refCount>0&&t.refCount--,!t.refCount&&t.readyToBeDeleted){const e=t.skeletonHash^t.clipHash;(void 0!==this._chunkIdxMap.get(e)?this._customPool:this._pool).free(t.handle),this._textureBuffers.get(e)===t&&this._textureBuffers.delete(e)}}releaseSkeleton(t){const e=this._textureBuffers.values();let i=e.next();for(;!i.done;){const n=i.value;n.skeletonHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}}releaseAnimationClip(t){const e=this._textureBuffers.values();let i=e.next();for(;!i.done;){const n=i.value;n.clipHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}}_createAnimInfos(t,e,i){const n=[],{joints:s,bindposes:r}=t,o=s.length,a=KW.getOrExtract(e);for(let e=0;e<o;e++){let c,l,h=s[e],_=a.joints[h],u=i.getChildByPath(h);for(;!_;){const t=h.lastIndexOf("/");if(h=h.substring(0,t),_=a.joints[h],u?(c||(c=new Ii),Ii.fromRTS(yet,u.rotation,u.position,u.scale),Ii.multiply(c,yet,c),u=u.parent):l=h,t<0)break}let d,m=e;if(void 0!==l&&_){m=e-1;for(let i=0;i<o;i++)if(s[i]===l){m=i,d=new Ii,Ii.multiply(d,r[i],t.inverseBindposes[e]);break}}n.push({curveData:_&&_.transforms,downstream:c,bindposeIdx:m,bindposeCorrection:d})}return n}}class Tet{constructor(t){this._pool=new Map,this._device=void 0,this._device=t}getData(t="-1"){const e=this._pool.get(t);if(e)return e;const i=this._device.createBuffer(new Zn(en.UNIFORM|en.TRANSFER_DST,rn.HOST|rn.DEVICE,wm.SIZE,wm.SIZE)),n=new Float32Array([0,0,0,0]);i.update(n);const s={buffer:i,data:n,dirty:!1,currentClip:null};return this._setAnimInfoDirty(s,!1),this._pool.set(t,s),s}destroy(t){const e=this._pool.get(t);e&&(e.buffer.destroy(),this._pool.delete(t))}_setAnimInfoDirty(t,e){t.dirty=e;{const i="nativeDirty",n=e?1:0;if(!t[i])return void Object.defineProperty(t,i,{value:new Uint32Array(1).fill(n),enumerable:!0});t[i].fill(n)}}switchClip(t,e){return t.currentClip=e,t.data[0]=-1,t.buffer.update(t.data),this._setAnimInfoDirty(t,!1),t}clear(){for(const t of this._pool.values())t.buffer.destroy();this._pool.clear()}}l.internal.DataPoolManager=class{constructor(t){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new bet(t),this.jointAnimationInfo=new Tet(t)}releaseSkeleton(t){this.jointTexturePool.releaseSkeleton(t)}releaseAnimationClip(t){this.jointTexturePool.releaseAnimationClip(t)}clear(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()}};const Eet=new Ii,Pet=new Ii;class wet extends LX{constructor(t,e=""){super(t,e),this._frames=1,this._bakedDuration=0,this._animInfo=null,this._sockets=[],this._animInfoMgr=void 0,this._parent=null,this._curvesInited=!1,this._animInfoMgr=l.director.root.dataPoolManager.jointAnimationInfo}initialize(t){if(this._curveLoaded)return;this._parent=t.getComponent("cc.SkeletalAnimation");const e=this._parent.useBakedAnimation;this._doNotCreateEval=e,super.initialize(t),this._curvesInited=!e;const{frames:i,samples:n}=KW.getOrExtract(this.clip);this._frames=i-1,this._animInfo=this._animInfoMgr.getData(t.uuid),this._bakedDuration=this._frames/n,this.setUseBaked(e)}setUseBaked(t){t?(this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration):(this._sampleCurves=super._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,super.initialize(this._targetNode),this._curvesInited=!0))}rebuildSocketCurves(t){if(this._sockets.length=0,!this._targetNode)return;const e=this._targetNode;for(let i=0;i<t.length;++i){const n=t[i],s=e.getChildByPath(n.path);if(!n.target)continue;const r=KW.getOrExtract(this.clip);let o,a=n.path,c=r.joints[a],l=s;for(;!c;){const t=a.lastIndexOf("/");if(a=a.substring(0,t),c=r.joints[a],l&&(o||(o=Ii.identity(Pet)),Ii.fromRTS(Eet,l.rotation,l.position,l.scale),Ii.multiply(o,Eet,o),l=l.parent),t<0)break}const h=c&&c.transforms,{frames:_}=r,u=[];for(let t=0;t<_;t++){let e;e=h&&o?Ii.multiply(Eet,h[t],o):h?h[t]:o||new Ii;const i={pos:new mi,rot:new Si,scale:new mi};Ii.toRTS(e,i.rot,i.pos,i.scale),u.push(i)}this._sockets.push({target:n.target,frames:u})}}_setAnimInfoDirty(t,e){t.dirty=e,t.nativeDirty.fill(e?1:0)}_sampleCurvesBaked(t){const e=t/this.duration,i=this._animInfo,n=this.clip;i.currentClip!==n&&(this._animInfoMgr.switchClip(this._animInfo,n),this._parent.getUsers().forEach((t=>{t.uploadAnimation(n)})));const s=e*this._frames+.5|0;if(s!==i.data[0]){i.data[0]=s,this._setAnimInfoDirty(i,!0);for(let t=0;t<this._sockets.length;++t){const{target:e,frames:i}=this._sockets[t],{pos:n,rot:r,scale:o}=i[s];e.setRTS(r,n,o)}}}}var Iet,Ret,Det,Met,Oet,Bet,Net,Let;t("SkeletalAnimationState",wet);let Fet=(Iet=dc("cc.Skeleton"),Ret=Kc([ve]),Det=Kc([Ii]),Iet((Bet=sc((Oet=class extends fh{constructor(...t){super(...t),nc(this,"_joints",Bet,this),nc(this,"_bindposes",Net,this),nc(this,"_hash",Let,this),this._invBindposes=null}get joints(){return this._joints}set joints(t){this._joints=t}get bindposes(){return this._bindposes}set bindposes(t){this._bindposes=t}get inverseBindposes(){if(!this._invBindposes){this._invBindposes=[];for(let t=0;t<this._bindposes.length;t++){const e=new Ii;Ii.invert(e,this._bindposes[t]),this._invBindposes.push(e)}}return this._invBindposes}get hash(){if(!this._hash){let t="";for(let e=0;e<this._bindposes.length;e++){const i=this._bindposes[e];t+=`${i.m00.toPrecision(2)} ${i.m01.toPrecision(2)} ${i.m02.toPrecision(2)} ${i.m03.toPrecision(2)} ${i.m04.toPrecision(2)} ${i.m05.toPrecision(2)} ${i.m06.toPrecision(2)} ${i.m07.toPrecision(2)} ${i.m08.toPrecision(2)} ${i.m09.toPrecision(2)} ${i.m10.toPrecision(2)} ${i.m11.toPrecision(2)} ${i.m12.toPrecision(2)} ${i.m13.toPrecision(2)} ${i.m14.toPrecision(2)} ${i.m15.toPrecision(2)}\n`}this._hash=ur(t,666)}return this._hash}destroy(){var t,e;return null===(t=null===(e=l.director.root)||void 0===e?void 0:e.dataPoolManager)||void 0===t||t.releaseSkeleton(this),super.destroy()}validate(){return this.joints.length>0&&this.bindposes.length>0}}).prototype,"_joints",[Ret],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Net=sc(Oet.prototype,"_bindposes",[Det],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Let=sc(Oet.prototype,"_hash",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Met=Oet))||Met);l.Skeleton=Fet;const zet=[{name:"CC_USE_SKINNING",value:!0}];function Vet(t,e,i,n){for(let s=0;s<i.length;s++){const r=i[s];let o=-1;for(let t=0;t<r.length;t++)if(r[t]===n){o=t;break}o>=0&&(e.push(s),t.push(o))}}const Get=new mi,Uet=new mi,ket=new mi,Het=new mi,jet=new Ii,Wet=new La;class qet extends ctt{constructor(){super(),this._buffers=[],this._dataArray=[],this._joints=[],this._bufferIndices=null,this.type=av.SKINNING}_init(){this._nativeObj=new la}destroy(){if(this.bindSkeleton(),this._buffers.length){for(let t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers.length=0}super.destroy()}uploadAnimation(){}bindSkeleton(t=null,e=null,i=null){for(let t=0;t<this._joints.length;t++)uJ(this._joints[t].target);if(this._bufferIndices=null,this._joints.length=0,!t||!e||!i)return;this.transform=e;const n=i.getBoneSpaceBounds(t),s=i.struct.jointMaps;this._ensureEnoughBuffers(s&&s.length||1),this._bufferIndices=i.jointBufferIndices;const r=[];for(let i=0;i<t.joints.length;i++){const o=n[i],a=e.getChildByPath(t.joints[i]);if(!o||!a)continue;const c=_J(a,e),l=t.bindposes[i],h=[],_=[];s?Vet(h,_,s,i):(h.push(i),_.push(0)),this._joints.push({indices:h,buffers:_,bound:o,target:a,bindpose:l,transform:c});{let t=c.parent;const e=[];for(;t;)e.push({node:t.node.native,local:t.local,world:t.local,stamp:t.stamp}),t=t.parent;r.push({indices:h,buffers:_,bound:o.native,target:a.native,bindpose:l,transform:{node:c.node.native,local:c.local,world:c.world,stamp:c.stamp},parents:e})}}this._nativeObj.setIndicesAndJoints(this._bufferIndices,r)}updateTransform(t){const e=this.transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._localDataUpdated=!0),mi.set(Get,1/0,1/0,1/0),mi.set(Uet,-1/0,-1/0,-1/0);for(let e=0;e<this._joints.length;e++){const{bound:i,transform:n}=this._joints[e],s=hJ(n,t);La.transform(Wet,i,s),Wet.getBoundary(ket,Het),mi.min(Get,Get,ket),mi.max(Uet,Uet,Het)}const i=this._worldBounds;this._modelBounds&&i&&(La.fromPoints(this._modelBounds,Get,Uet),this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds),this._updateNativeBounds())}updateUBOs(t){super.updateUBOs(t);for(let t=0;t<this._joints.length;t++){const{indices:e,buffers:i,transform:n,bindpose:s}=this._joints[t];Ii.multiply(jet,n.world,s);for(let t=0;t<i.length;t++)det(this._dataArray[i[t]],12*e[t],jet)}for(let t=0;t<this._buffers.length;t++)this._buffers[t].update(this._dataArray[t]);return!0}initSubModel(t,e,i){const n=e.vertexBuffers,s=e.iaInfo;s.vertexBuffers=e.jointMappedBuffers,super.initSubModel(t,e,i),s.vertexBuffers=n}getMacroPatches(t){const e=super.getMacroPatches(t);return e?zet.concat(e):zet}_updateLocalDescriptors(t,e){super._updateLocalDescriptors(t,e),this._nativeObj.updateLocalDescriptors(t,e)}_updateInstancedAttributes(t,e){e.batchingScheme!==Vf.NONE&&I(3936,this.node.getPathInHierarchy()),super._updateInstancedAttributes(t,e)}_ensureEnoughBuffers(t){for(let e=0;e<t;e++)this._buffers[e]||(this._buffers[e]=this._device.createBuffer(new Zn(en.UNIFORM|en.TRANSFER_DST,rn.HOST|rn.DEVICE,Im.SIZE,Im.SIZE))),this._dataArray[e]||(this._dataArray[e]=new Float32Array(Im.COUNT));this._nativeObj.setBuffers(this._buffers)}}const Xet=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}];class Yet extends ctt{constructor(){super(),this.uploadedAnim=void 0,this._jointsMedium=void 0,this._skeleton=null,this._mesh=null,this._dataPoolManager=void 0,this._instAnimInfoIdx=-1,this.type=av.BAKED_SKINNING,this._dataPoolManager=l.director.root.dataPoolManager;const t=new Float32Array(4),e=this._dataPoolManager.jointAnimationInfo.getData();this._jointsMedium={buffer:null,jointTextureInfo:t,animInfo:e,texture:null,boundsInfo:null}}_init(){this._nativeObj=new ha}destroy(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),super.destroy()}bindSkeleton(t=null,e=null,i=null){if(this._skeleton=t,this._mesh=i,!t||!e||!i)return;this.transform=e;const n=this._dataPoolManager;this._jointsMedium.animInfo=n.jointAnimationInfo.getData(e.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new Zn(en.UNIFORM|en.TRANSFER_DST,rn.DEVICE,Pm.SIZE,Pm.SIZE)))}updateTransform(t){if(super.updateTransform(t),!this.uploadedAnim)return;const{animInfo:e,boundsInfo:i}=this._jointsMedium,n=i[e.data[0]],s=this._worldBounds;if(s&&n){const t=this.transform;n.transform(t._mat,t._pos,t._rot,t._scale,s)}}updateUBOs(t){super.updateUBOs(t);const e=this._jointsMedium.animInfo,i=this._instAnimInfoIdx;return i>=0?this.instancedAttributes.views[i][0]=e.data[0]:e.dirty&&(e.buffer.update(e.data),e.dirty=!1),!0}getMacroPatches(t){const e=super.getMacroPatches(t);return e?e.concat(Xet):Xet}uploadAnimation(t){if(!this._skeleton||!this._mesh||this.uploadedAnim===t)return;this.uploadedAnim=t;const e=this._dataPoolManager;let i=null;t?(i=e.jointTexturePool.getSequencePoseTexture(this._skeleton,t,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(i=e.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(i&&i.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(i),this._applyNativeJointMedium()}_applyNativeJointMedium(){if(this._nativeObj){const t=[];this._jointsMedium.boundsInfo&&this._jointsMedium.boundsInfo.forEach((e=>{t.push(e.native)}));const e="nativeDirty";this._nativeObj.setJointMedium(!!this.uploadedAnim,{boundsInfo:t,jointTextureInfo:this._jointsMedium.jointTextureInfo.buffer,animInfo:{buffer:this._jointsMedium.animInfo.buffer,data:this._jointsMedium.animInfo.data.buffer,dirty:this._jointsMedium.animInfo[e].buffer},buffer:this._jointsMedium.buffer})}}_updateModelBounds(t){this._modelBounds=t,this._nativeObj.updateModelBounds(t?t.native:null)}_applyJointTexture(t=null){const e=this._jointsMedium.texture;if(e&&e!==t&&this._dataPoolManager.jointTexturePool.releaseHandle(e),this._jointsMedium.texture=t,!t)return;const{buffer:i,jointTextureInfo:n}=this._jointsMedium;n[0]=t.handle.texture.width,n[1]=this._skeleton.joints.length,n[2]=t.pixelOffset+.1,n[3]=1/n[0],this.updateInstancedJointTextureInfo(),i&&i.update(n);const s=t.handle.texture;for(let t=0;t<this._subModels.length;++t)this._subModels[t].descriptorSet.bindTexture(Mm,s)}_updateLocalDescriptors(t,e){super._updateLocalDescriptors(t,e);const{buffer:i,texture:n,animInfo:s}=this._jointsMedium;if(e.bindBuffer(Pm.BINDING,i),e.bindBuffer(wm.BINDING,s.buffer),n){const t=this._device.getSampler(uet);e.bindTexture(Mm,n.handle.texture),e.bindSampler(Mm,t)}}_updateInstancedAttributes(t,e){super._updateInstancedAttributes(t,e),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex("a_jointAnimInfo")),this.updateInstancedJointTextureInfo()}_setInstAnimInfoIdx(t){this._instAnimInfoIdx=t,this._nativeObj.setAnimInfoIdx(t)}updateInstancedJointTextureInfo(){const{jointTextureInfo:t,animInfo:e}=this._jointsMedium,i=this._instAnimInfoIdx;if(i>=0){const n=this.instancedAttributes.views[i];n[0]=e.data[0],n[1]=t[1],n[2]=t[2]}}}var Ket,Jet,$et,Zet,Qet,tit,eit,iit,nit,sit,rit,oit,ait;let cit=(Ket=dc("cc.SkinnedMeshRenderer"),Jet=Dc(),$et=pc(100),Zet=Pc(),Qet=Kc(Fet),tit=Kc(iS),eit=Kc(Fet),iit=Kc(iS),nit=Lc(),Ket(sit=Jet(sit=$et(sit=Ec(sit=Zet((oit=sc((rit=class extends Ztt{get skeleton(){return this._skeleton}set skeleton(t){t!==this._skeleton&&(this._skeleton=t,this._update())}get skinningRoot(){return this._skinningRoot}set skinningRoot(t){this._skinningRoot=t,this._tryBindAnimation(),t!==this._skinningRoot&&this._update()}get model(){return this._model}constructor(){super(),nc(this,"_skeleton",oit,this),nc(this,"_skinningRoot",ait,this),this._clip=null,this.associatedAnimation=null,this._modelType=Yet}onLoad(){super.onLoad(),this._tryBindAnimation()}onDestroy(){this.associatedAnimation&&(this.associatedAnimation.notifySkinnedMeshRemoved(this),this.associatedAnimation),super.onDestroy()}uploadAnimation(t){this._clip=t,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(t)}setUseBakedAnimation(t=!0,e=!1){const i=t?Yet:qet;(e||this._modelType!==i)&&(this._modelType=i,this._model&&(l.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this.enabledInHierarchy&&this._attachToScene()))}setMaterial(t,e){super.setMaterial(t,e),this._modelType===qet&&this.getMaterialInstance(e)}_updateModelParams(){this._update(),super._updateModelParams()}_tryBindAnimation(){const{_skinningRoot:t}=this;if(!t)return;let e=!1;for(let i=this.node;i;i=i.parent)if(i===t){e=!0;break}if(!e)return;const i=t.getComponent("cc.SkeletalAnimation");i?i.notifySkinnedMeshAdded(this):this.setUseBakedAnimation(!1)}_update(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))}}).prototype,"_skeleton",[Qet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ait=sc(rit.prototype,"_skinningRoot",[tit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sc(rit.prototype,"skeleton",[eit],Object.getOwnPropertyDescriptor(rit.prototype,"skeleton"),rit.prototype),sc(rit.prototype,"skinningRoot",[iit,nit],Object.getOwnPropertyDescriptor(rit.prototype,"skinningRoot"),rit.prototype),sit=rit))||sit)||sit)||sit)||sit)||sit);var lit,hit,_it,uit,dit,mit,pit,fit,git,vit,yit,xit,Sit,Cit,Ait,bit,Tit,Eit,Pit,wit,Iit,Rit,Dit,Mit,Oit,Bit,Nit,Lit,Fit;const zit=new fs(Ln.ATTR_BATCH_ID,Zi.R32F),Vit=new fs(Ln.ATTR_BATCH_UV,Zi.RG32F),Git=Gs[zit.format].size+Gs[Vit.format].size;let Uit=(lit=dc("cc.SkinnedMeshUnit"),hit=Kc(itt),_it=Kc(Fet),uit=Kc(sg),dit=Kc(cit),lit((fit=sc((pit=class{constructor(){nc(this,"mesh",fit,this),nc(this,"skeleton",git,this),nc(this,"material",vit,this),nc(this,"_localTransform",yit,this),nc(this,"_offset",xit,this),nc(this,"_size",Sit,this)}set offset(t){Oi.copy(this._offset,t)}get offset(){return this._offset}set size(t){Oi.copy(this._size,t)}get size(){return this._size}set copyFrom(t){t&&(this.mesh=t.mesh,this.skeleton=t.skeleton,this.material=t.getMaterial(0),t.skinningRoot&&zJ(t.node,t.skinningRoot,this._localTransform))}get copyFrom(){return null}}).prototype,"mesh",[hit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),git=sc(pit.prototype,"skeleton",[_it],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vit=sc(pit.prototype,"material",[uit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yit=sc(pit.prototype,"_localTransform",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii}}),xit=sc(pit.prototype,"_offset",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi(0,0)}}),Sit=sc(pit.prototype,"_size",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi(1,1)}}),sc(pit.prototype,"offset",[Mc],Object.getOwnPropertyDescriptor(pit.prototype,"offset"),pit.prototype),sc(pit.prototype,"size",[Mc],Object.getOwnPropertyDescriptor(pit.prototype,"size"),pit.prototype),sc(pit.prototype,"copyFrom",[dit],Object.getOwnPropertyDescriptor(pit.prototype,"copyFrom"),pit.prototype),mit=pit))||mit);const kit=new Ii,Hit=(new Ii,new mi);let jit=(Cit=dc("cc.SkinnedMeshBatchRenderer"),Ait=Dc(),bit=pc(100),Tit=Pc(),Eit=Lc(),Pit=Kc([ve]),wit=Lc(),Iit=Kc([Uit]),Rit=Lc(),Dit=Oc(),Mit=Oc(),Cit(Oit=Ait(Oit=bit(Oit=Ec(Oit=Tit((Nit=sc((Bit=class extends cit{constructor(...t){super(...t),nc(this,"atlasSize",Nit,this),nc(this,"batchableTextureNames",Lit,this),nc(this,"units",Fit,this),this._textures={},this._batchMaterial=null}get mesh(){return super.mesh}set mesh(t){super.mesh=t}get skeleton(){return super.skeleton}set skeleton(t){super.skeleton=t}onLoad(){super.onLoad(),this.cook()}onDestroy(){for(const t in this._textures)this._textures[t].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),super.onDestroy()}_onMaterialModified(t,e){this.cookMaterials(),super._onMaterialModified(t,this.getMaterialInstance(t))}cook(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}cookMaterials(){this._batchMaterial||(this._batchMaterial=this.getMaterial(0));const t=this.getMaterialInstance(0);if(!t||!this._batchMaterial||!this._batchMaterial.effectAsset)return void console.warn("incomplete batch material!");t.copy(this._batchMaterial),this.resizeAtlases();const e=t.effectAsset.techniques[t.technique];for(let i=0;i<e.passes.length;i++){const n=e.passes[i];if(n.properties)for(const e in n.properties)if(n.properties[e].type>=tn.SAMPLER1D){let n=null;this.batchableTextureNames.find((t=>t===e))?(n=this._textures[e],n||(n=this.createTexture(e)),this.cookTextures(n,e,i)):this.units.some((t=>n=t.material&&t.material.getProperty(e,i))),n&&t.setProperty(e,n,i)}else{const n=[];for(let t=0;t<this.units.length;t++){const s=this.units[t];s.material&&n.push(s.material.getProperty(e.slice(0,-3),i))}t.setProperty(e,n,i)}}}cookSkeletons(){if(!this._skinningRoot)return void console.warn("no skinning root specified!");const t=[],e=[];for(let i=0;i<this.units.length;i++){const n=this.units[i];if(!n||!n.skeleton)continue;const s=n.skeleton;Ii.invert(kit,n._localTransform);for(let i=0;i<s.joints.length;i++){const n=s.joints[i];t.findIndex((t=>t===n))>=0||(t.push(n),e.push(Ii.multiply(new Ii,s.bindposes[i]||Ii.IDENTITY,kit)))}}const i=Array.from(Array(t.length).keys()).sort(((e,i)=>t[e]>t[i]?1:t[e]<t[i]?-1:0)),n=new Fet;n.joints=t.map(((t,e,n)=>n[i[e]])),n.bindposes=e.map(((t,e,n)=>n[i[e]])),this._skeleton&&this._skeleton.destroy(),this.skeleton=n}cookMeshes(){let t=!1;for(let e=0;e<this.units.length;e++)if(this.units[e].mesh){t=!0;break}if(!t||!this._skinningRoot)return;this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new itt;let e=0,i=Zi.UNKNOWN,n=0,s=Zi.UNKNOWN,r=0,o=Zi.UNKNOWN,a=0,c=Zi.UNKNOWN,l=0,h=Zi.UNKNOWN;const _=new Array(this.units.length),u=this.units.length;for(let t=0;t<u;t++){const e=this.units[t];e&&e.skeleton&&(_[t]=e.skeleton.joints.map((t=>this._skeleton.joints.findIndex((e=>t===e)))))}for(let t=0;t<u;t++){const u=this.units[t];if(!u||!u.mesh||!u.mesh.data)continue;const d=this._createUnitMesh(t,u.mesh),m=new DataView(d.data.buffer);Ii.inverseTranspose(kit,u._localTransform);const{offset:p}=u,{size:f}=u;for(let g=0;g<d.struct.vertexBundles.length;g++){const v=d.struct.vertexBundles[g];e=v.view.offset,i=Zi.UNKNOWN;for(let t=0;t<v.attributes.length;t++){const n=v.attributes[t];if(n.name===Ln.ATTR_POSITION){i=n.format;break}e+=Gs[n.format].size}if(i){const t=hA(m,i,e,v.view.length,v.view.stride);for(let e=0;e<t.length;e+=3)mi.fromArray(Hit,t,e),mi.transformMat4(Hit,Hit,u._localTransform),mi.toArray(t,Hit,e);lA(m,t,i,e,v.view.stride)}n=v.view.offset,s=Zi.UNKNOWN;for(let t=0;t<v.attributes.length;t++){const e=v.attributes[t];if(e.name===Ln.ATTR_NORMAL){s=e.format;break}n+=Gs[e.format].size}if(s){const t=hA(m,s,n,v.view.length,v.view.stride);for(let e=0;e<t.length;e+=3)mi.fromArray(Hit,t,e),mi.transformMat4Normal(Hit,Hit,kit),mi.toArray(t,Hit,e);lA(m,t,s,n,v.view.stride)}r=v.view.offset,o=Zi.UNKNOWN;for(let t=0;t<v.attributes.length;t++){const e=v.attributes[t];if(e.name===Ln.ATTR_TANGENT){o=e.format;break}r+=Gs[e.format].size}if(o){const t=hA(m,o,r,v.view.length,v.view.stride);for(let e=0;e<t.length;e+=3)mi.fromArray(Hit,t,e),mi.transformMat4Normal(Hit,Hit,kit),mi.toArray(t,Hit,e);lA(m,t,o,r,v.view.stride)}a=v.view.offset,c=Zi.UNKNOWN;for(let t=0;t<v.attributes.length;t++){const e=v.attributes[t];if(e.name===Ln.ATTR_BATCH_UV){c=e.format;break}a+=Gs[e.format].size}c&&_A(m,((t,e)=>{var i;const n=0===e?"x":"y";return(t=(i=t)-Math.floor(i))*f[n]+p[n]}),c,a,v.view.length,v.view.stride,m);const y=_[t];if(y){l=v.view.offset,h=Zi.UNKNOWN;for(let t=0;t<v.attributes.length;t++){const e=v.attributes[t];if(e.name===Ln.ATTR_JOINTS){h=e.format;break}l+=Gs[e.format].size}h&&_A(m,(t=>y[t]),h,l,v.view.length,v.view.stride,m)}}this._mesh.merge(d)}this._onMeshChanged(this._mesh),this._updateModels()}cookTextures(t,e,i){const n=[],s=[],r=[],o=[];for(let t=0;t<this.units.length;t++){const a=this.units[t];if(!a.material)continue;const c=a.material.getProperty(e,i);if(c&&c.image&&c.image.data){const t=new qn;t.texOffset.x=a.offset.x*this.atlasSize,t.texOffset.y=a.offset.y*this.atlasSize,t.texExtent.width=a.size.x*this.atlasSize,t.texExtent.height=a.size.y*this.atlasSize;const{data:e}=c.image;ArrayBuffer.isView(e)?(r.push(e),o.push(t)):(n.push(e),s.push(t))}}const a=t.getGFXTexture(),{device:c}=l.director.root;r.length>0&&c.copyBuffersToTexture(r,a,o),n.length>0&&c.copyTexImagesToTexture(n,a,s)}createTexture(t){const e=new xf;return e.setFilters(Fp.LINEAR,Fp.LINEAR),e.setMipFilter(Fp.NEAREST),e.reset({width:this.atlasSize,height:this.atlasSize,format:Np.RGBA8888}),this._textures[t]=e,e}resizeAtlases(){for(const t in this._textures)this._textures[t].reset({width:this.atlasSize,height:this.atlasSize,format:Np.RGBA8888})}_createUnitMesh(t,e){const i=JSON.parse(JSON.stringify(e.struct)),n={};for(let t=0;t<e.struct.primitives.length;t++){const s=e.struct.primitives[t];let r=0,o=Zi.UNKNOWN,a=0;for(;a<s.vertexBundelIndices.length;a++){const t=e.struct.vertexBundles[s.vertexBundelIndices[a]];r=t.view.offset,o=Zi.UNKNOWN;for(let e=0;e<t.attributes.length;e++){const i=t.attributes[e];if(i.name===Ln.ATTR_TEX_COORD){o=i.format;break}r+=Gs[i.format].size}if(o)break}if(void 0!==n[a])continue;n[a]=[o,r];const c=i.vertexBundles[a];c.attributes.push(zit),c.attributes.push(Vit),c.view.offset=0,c.view.length+=c.view.count*Git,c.view.stride+=Git}let s=0;for(let t=0;t<i.vertexBundles.length;t++)s+=i.vertexBundles[t].view.length;for(let t=0;t<i.primitives.length;t++){const e=i.primitives[t];e.indexView&&(e.indexView.offset=s,s+=e.indexView.length)}const r=new Uint8Array(s),o=e.data,a=new DataView(r.buffer),c=new DataView(o.buffer),{isLittleEndian:h}=l.sys;for(const s in n){const l=i.vertexBundles[s],_=e.struct.vertexBundles[s],[u,d]=n[s],m=hA(c,u,d,_.view.length,_.view.stride),p=_.view,f=l.view,g=p.stride,v=f.stride;let y=p.offset,x=f.offset;for(let e=0;e<f.count;e++){const i=o.subarray(y,y+g);r.set(i,x),a.setFloat32(x+g,t),a.setFloat32(x+g+4,m[2*e],h),a.setFloat32(x+g+8,m[2*e+1],h),x+=v,y+=g}}for(let t=0;t<i.primitives.length;t++){const n=e.struct.primitives[t],s=i.primitives[t];if(n.indexView&&s.indexView){const t=n.indexView.stride,e=s.indexView.stride;let i=n.indexView.offset,a=s.indexView.offset;for(let n=0;n<s.indexView.count;n++){const n=o.subarray(i,i+t);r.set(n,a),a+=e,i+=t}}}const _=new itt;return _.reset({struct:i,data:r}),_}}).prototype,"atlasSize",[Sc,Eit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),Lit=sc(Bit.prototype,"batchableTextureNames",[Pit,Sc,wit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fit=sc(Bit.prototype,"units",[Iit,Sc,Rit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sc(Bit.prototype,"mesh",[Jc,Dit],Object.getOwnPropertyDescriptor(Bit.prototype,"mesh"),Bit.prototype),sc(Bit.prototype,"skeleton",[Jc,Mit],Object.getOwnPropertyDescriptor(Bit.prototype,"skeleton"),Bit.prototype),Oit=Bit))||Oit)||Oit)||Oit)||Oit)||Oit);var Wit,qit,Xit,Yit,Kit,Jit,$it,Zit,Qit,tnt,ent,int,nnt,snt,rnt,ont,ant,cnt,lnt,hnt;l.SkinningModelComponent=cit,Ut.setClassAlias(cit,"cc.SkinningModelComponent"),l.SkinningModelUnit=Uit,Ut.setClassAlias(Uit,"cc.SkinningModelUnit"),l.BatchedSkinningModelComponent=jit,Ut.setClassAlias(jit,"cc.BatchedSkinningModelComponent");let _nt=t("Socket",(Wit=dc("cc.SkeletalAnimation.Socket"),qit=Kc(iS),Wit((Kit=sc((Yit=class{constructor(t="",e=null){nc(this,"path",Kit,this),nc(this,"target",Jit,this),this.path=t,this.target=e}}).prototype,"path",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Jit=sc(Yit.prototype,"target",[qit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xit=Yit))||Xit));Ut.setClassAlias(_nt,"cc.SkeletalAnimationComponent.Socket");const unt=new Ii,dnt=new Ii;function mnt(t,e="",i=[]){for(let n=0;n<t.children.length;n++){const s=t.children[n];if(!s)continue;const r=e?`${e}/${s.name}`:s.name;i.push(r),mnt(s,r,i)}return i}let pnt=function(e){return t({SkeletalAnimation:e,SkeletalAnimationComponent:e}),e}(($it=dc("cc.SkeletalAnimation"),Zit=Dc(),Qit=pc(99),tnt=Pc(),ent=Kc([_nt]),int=Lc(),nnt=Lc(),snt=Kc([_nt]),$it(rnt=Zit(rnt=Qit(rnt=Ec(rnt=tnt((hnt=lnt=class extends NJ{constructor(...t){super(...t),nc(this,"_useBakedAnimation",ant,this),nc(this,"_sockets",cnt,this),this._users=new Set,this._currentBakedState=null}get sockets(){return this._sockets}set sockets(t){if(!this._useBakedAnimation){const e=oX();e.removeSockets(this.node,this._sockets),e.addSockets(this.node,t)}this._sockets=t,this.rebuildSocketAnimations()}get useBakedAnimation(){return this._useBakedAnimation}set useBakedAnimation(t){this._useBakedAnimation=t;for(const e in this._nameToState)this._nameToState[e].setUseBaked(t);this._users.forEach((e=>{e.setUseBakedAnimation(t)})),this._useBakedAnimation?oX().removeSockets(this.node,this._sockets):(oX().addSockets(this.node,this._sockets),this._currentBakedState=null)}onLoad(){super.onLoad();const t=this.node.getComponentsInChildren(cit);for(let e=0;e<t.length;++e){const i=t[e];i.skinningRoot===this.node&&this.notifySkinnedMeshAdded(i)}}onDestroy(){super.onDestroy(),l.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),oX().removeSockets(this.node,this._sockets),this._removeAllUsers()}start(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,super.start()}pause(){var t;this._useBakedAnimation?null===(t=this._currentBakedState)||void 0===t||t.pause():super.pause()}resume(){var t;this._useBakedAnimation?null===(t=this._currentBakedState)||void 0===t||t.resume():super.resume()}stop(){this._useBakedAnimation?this._currentBakedState&&(this._currentBakedState.stop(),this._currentBakedState=null):super.stop()}querySockets(){const t=this._defaultClip&&Object.keys(KW.getOrExtract(this._defaultClip).joints).sort().reduce(((t,e)=>(e.startsWith(t[t.length-1])||t.push(e),t)),[])||[];if(!t.length)return["please specify a valid default animation clip first"];const e=[];for(let i=0;i<t.length;i++){const n=t[i],s=this.node.getChildByPath(n);s&&(e.push(n),mnt(s,n,e))}return e}rebuildSocketAnimations(){for(const t of this._sockets){const e=this.node.getChildByPath(t.path),{target:i}=t;e&&i&&(i.name=`${t.path.substring(t.path.lastIndexOf("/")+1)} Socket`,i.parent=this.node,zJ(e,this.node,unt),Ii.fromRTS(dnt,i.rotation,i.position,i.scale),Ii.equals(dnt,unt)||(i.matrix=unt))}for(const t of Object.keys(this._nameToState))this._nameToState[t].rebuildSocketCurves(this._sockets)}createSocket(t){const e=this._sockets.find((e=>e.path===t));if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;const i=new iS;return i.parent=this.node,this._sockets.push(new _nt(t,i)),this.rebuildSocketAnimations(),i}notifySkinnedMeshAdded(t){const{_useBakedAnimation:e}=this,i=t.associatedAnimation;if(i&&i._users.delete(t),t.associatedAnimation=this,t.setUseBakedAnimation(e,!0),e){const{_currentBakedState:e}=this;e&&t.uploadAnimation(e.clip)}this._users.add(t)}notifySkinnedMeshRemoved(t){t.associatedAnimation===this||t.associatedAnimation,t.setUseBakedAnimation(!1),t.associatedAnimation=null,this._users.delete(t)}getUsers(){return this._users}_createState(t,e){return new wet(t,e)}_doCreateState(t,e){const i=super._doCreateState(t,e);return i.rebuildSocketCurves(this._sockets),i}doPlayOrCrossFade(t,e){if(this._useBakedAnimation){this._currentBakedState&&this._currentBakedState.stop();const e=t;this._currentBakedState=e,e.play()}else super.doPlayOrCrossFade(t,e)}_removeAllUsers(){Array.from(this._users).forEach((t=>{this.notifySkinnedMeshRemoved(t)}))}},lnt.Socket=_nt,sc((ont=hnt).prototype,"sockets",[ent,int],Object.getOwnPropertyDescriptor(ont.prototype,"sockets"),ont.prototype),sc(ont.prototype,"useBakedAnimation",[nnt],Object.getOwnPropertyDescriptor(ont.prototype,"useBakedAnimation"),ont.prototype),ant=sc(ont.prototype,"_useBakedAnimation",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),cnt=sc(ont.prototype,"_sockets",[snt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rnt=ont))||rnt)||rnt)||rnt)||rnt)||rnt));l.SkeletalAnimationComponent=pnt,Ut.setClassAlias(pnt,"cc.SkeletalAnimationComponent");class fnt{constructor(){this.start=void 0,this.interrupt=void 0,this.end=void 0,this.dispose=void 0,this.complete=void 0,this.event=void 0}static getListeners(t){return t.listener||(t.listener=new fnt),t.listener}}var gnt,vnt=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(t){var e,i,n,s=function(){function t(t,e,i){if(null==t)throw new Error("name cannot be null.");if(null==e)throw new Error("timelines cannot be null.");this.name=t,this.timelines=e,this.timelineIds=[];for(var n=0;n<e.length;n++)this.timelineIds[e[n].getPropertyId()]=!0;this.duration=i}return t.prototype.hasTimeline=function(t){return 1==this.timelineIds[t]},t.prototype.apply=function(t,e,i,n,s,r,o,a){if(null==t)throw new Error("skeleton cannot be null.");n&&0!=this.duration&&(i%=this.duration,e>0&&(e%=this.duration));for(var c=this.timelines,l=0,h=c.length;l<h;l++)c[l].apply(t,e,i,s,r,o,a)},t.binarySearch=function(t,e,i){void 0===i&&(i=1);var n=0,s=t.length/i-2;if(0==s)return i;for(var r=s>>>1;;){if(t[(r+1)*i]<=e?n=r+1:s=r,n==s)return(n+1)*i;r=n+s>>>1}},t.linearSearch=function(t,e,i){for(var n=0,s=t.length-i;n<=s;n+=i)if(t[n]>e)return n;return-1},t}();t.Animation=s,function(t){t[t.setup=0]="setup",t[t.first=1]="first",t[t.replace=2]="replace",t[t.add=3]="add"}(e=t.MixBlend||(t.MixBlend={})),function(t){t[t.mixIn=0]="mixIn",t[t.mixOut=1]="mixOut"}(i=t.MixDirection||(t.MixDirection={})),function(t){t[t.rotate=0]="rotate",t[t.translate=1]="translate",t[t.scale=2]="scale",t[t.shear=3]="shear",t[t.attachment=4]="attachment",t[t.color=5]="color",t[t.deform=6]="deform",t[t.event=7]="event",t[t.drawOrder=8]="drawOrder",t[t.ikConstraint=9]="ikConstraint",t[t.transformConstraint=10]="transformConstraint",t[t.pathConstraintPosition=11]="pathConstraintPosition",t[t.pathConstraintSpacing=12]="pathConstraintSpacing",t[t.pathConstraintMix=13]="pathConstraintMix",t[t.twoColor=14]="twoColor"}(n=t.TimelineType||(t.TimelineType={}));var r=function(){function e(i){if(i<=0)throw new Error("frameCount must be > 0: "+i);this.curves=t.Utils.newFloatArray((i-1)*e.BEZIER_SIZE)}return e.prototype.getFrameCount=function(){return this.curves.length/e.BEZIER_SIZE+1},e.prototype.setLinear=function(t){this.curves[t*e.BEZIER_SIZE]=e.LINEAR},e.prototype.setStepped=function(t){this.curves[t*e.BEZIER_SIZE]=e.STEPPED},e.prototype.getCurveType=function(t){var i=t*e.BEZIER_SIZE;if(i==this.curves.length)return e.LINEAR;var n=this.curves[i];return n==e.LINEAR?e.LINEAR:n==e.STEPPED?e.STEPPED:e.BEZIER},e.prototype.setCurve=function(t,i,n,s,r){var o=.03*(2*-i+s),a=.03*(2*-n+r),c=.006*(3*(i-s)+1),l=.006*(3*(n-r)+1),h=2*o+c,_=2*a+l,u=.3*i+o+.16666667*c,d=.3*n+a+.16666667*l,m=t*e.BEZIER_SIZE,p=this.curves;p[m++]=e.BEZIER;for(var f=u,g=d,v=m+e.BEZIER_SIZE-1;m<v;m+=2)p[m]=f,p[m+1]=g,u+=h,d+=_,h+=c,_+=l,f+=u,g+=d},e.prototype.getCurvePercent=function(i,n){n=t.MathUtils.clamp(n,0,1);var s=this.curves,r=i*e.BEZIER_SIZE,o=s[r];if(o==e.LINEAR)return n;if(o==e.STEPPED)return 0;for(var a=0,c=++r,l=r+e.BEZIER_SIZE-1;r<l;r+=2)if((a=s[r])>=n){var h=void 0,_=void 0;return r==c?(h=0,_=0):(h=s[r-2],_=s[r-1]),_+(s[r+1]-_)*(n-h)/(a-h)}var u=s[r-1];return u+(1-u)*(n-a)/(1-a)},e.LINEAR=0,e.STEPPED=1,e.BEZIER=2,e.BEZIER_SIZE=19,e}();t.CurveTimeline=r;var o=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e<<1),n}return vnt(r,i),r.prototype.getPropertyId=function(){return(n.rotate<<24)+this.boneIndex},r.prototype.setFrame=function(t,e,i){t<<=1,this.frames[t]=e,this.frames[t+r.ROTATION]=i},r.prototype.apply=function(t,i,n,o,a,c){var l=this.frames,h=t.bones[this.boneIndex];if(h.active)if(n<l[0])switch(c){case e.setup:return void(h.rotation=h.data.rotation);case e.first:var _=h.data.rotation-h.rotation;h.rotation+=(_-360*(16384-(16384.499999999996-_/360|0)))*a}else if(n>=l[l.length-r.ENTRIES]){var u=l[l.length+r.PREV_ROTATION];switch(c){case e.setup:h.rotation=h.data.rotation+u*a;break;case e.first:case e.replace:u+=h.data.rotation-h.rotation,u-=360*(16384-(16384.499999999996-u/360|0));case e.add:h.rotation+=u*a}}else{var d=s.binarySearch(l,n,r.ENTRIES),m=l[d+r.PREV_ROTATION],p=l[d],f=this.getCurvePercent((d>>1)-1,1-(n-p)/(l[d+r.PREV_TIME]-p)),g=l[d+r.ROTATION]-m;switch(g=m+(g-360*(16384-(16384.499999999996-g/360|0)))*f,c){case e.setup:h.rotation=h.data.rotation+(g-360*(16384-(16384.499999999996-g/360|0)))*a;break;case e.first:case e.replace:g+=h.data.rotation-h.rotation;case e.add:h.rotation+=(g-360*(16384-(16384.499999999996-g/360|0)))*a}}},r.ENTRIES=2,r.PREV_TIME=-2,r.PREV_ROTATION=-1,r.ROTATION=1,r}(r);t.RotateTimeline=o;var a=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return vnt(r,i),r.prototype.getPropertyId=function(){return(n.translate<<24)+this.boneIndex},r.prototype.setFrame=function(t,e,i,n){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.X]=i,this.frames[t+r.Y]=n},r.prototype.apply=function(t,i,n,o,a,c){var l=this.frames,h=t.bones[this.boneIndex];if(h.active)if(n<l[0])switch(c){case e.setup:return h.x=h.data.x,void(h.y=h.data.y);case e.first:h.x+=(h.data.x-h.x)*a,h.y+=(h.data.y-h.y)*a}else{var _=0,u=0;if(n>=l[l.length-r.ENTRIES])_=l[l.length+r.PREV_X],u=l[l.length+r.PREV_Y];else{var d=s.binarySearch(l,n,r.ENTRIES);_=l[d+r.PREV_X],u=l[d+r.PREV_Y];var m=l[d],p=this.getCurvePercent(d/r.ENTRIES-1,1-(n-m)/(l[d+r.PREV_TIME]-m));_+=(l[d+r.X]-_)*p,u+=(l[d+r.Y]-u)*p}switch(c){case e.setup:h.x=h.data.x+_*a,h.y=h.data.y+u*a;break;case e.first:case e.replace:h.x+=(h.data.x+_-h.x)*a,h.y+=(h.data.y+u-h.y)*a;break;case e.add:h.x+=_*a,h.y+=u*a}}},r.ENTRIES=3,r.PREV_TIME=-3,r.PREV_X=-2,r.PREV_Y=-1,r.X=1,r.Y=2,r}(r);t.TranslateTimeline=a;var c=function(r){function o(t){return r.call(this,t)||this}return vnt(o,r),o.prototype.getPropertyId=function(){return(n.scale<<24)+this.boneIndex},o.prototype.apply=function(n,r,a,c,l,h,_){var u=this.frames,d=n.bones[this.boneIndex];if(d.active)if(a<u[0])switch(h){case e.setup:return d.scaleX=d.data.scaleX,void(d.scaleY=d.data.scaleY);case e.first:d.scaleX+=(d.data.scaleX-d.scaleX)*l,d.scaleY+=(d.data.scaleY-d.scaleY)*l}else{var m=0,p=0;if(a>=u[u.length-o.ENTRIES])m=u[u.length+o.PREV_X]*d.data.scaleX,p=u[u.length+o.PREV_Y]*d.data.scaleY;else{var f=s.binarySearch(u,a,o.ENTRIES);m=u[f+o.PREV_X],p=u[f+o.PREV_Y];var g=u[f],v=this.getCurvePercent(f/o.ENTRIES-1,1-(a-g)/(u[f+o.PREV_TIME]-g));m=(m+(u[f+o.X]-m)*v)*d.data.scaleX,p=(p+(u[f+o.Y]-p)*v)*d.data.scaleY}if(1==l)h==e.add?(d.scaleX+=m-d.data.scaleX,d.scaleY+=p-d.data.scaleY):(d.scaleX=m,d.scaleY=p);else{var y=0,x=0;if(_==i.mixOut)switch(h){case e.setup:y=d.data.scaleX,x=d.data.scaleY,d.scaleX=y+(Math.abs(m)*t.MathUtils.signum(y)-y)*l,d.scaleY=x+(Math.abs(p)*t.MathUtils.signum(x)-x)*l;break;case e.first:case e.replace:y=d.scaleX,x=d.scaleY,d.scaleX=y+(Math.abs(m)*t.MathUtils.signum(y)-y)*l,d.scaleY=x+(Math.abs(p)*t.MathUtils.signum(x)-x)*l;break;case e.add:y=d.scaleX,x=d.scaleY,d.scaleX=y+(Math.abs(m)*t.MathUtils.signum(y)-d.data.scaleX)*l,d.scaleY=x+(Math.abs(p)*t.MathUtils.signum(x)-d.data.scaleY)*l}else switch(h){case e.setup:y=Math.abs(d.data.scaleX)*t.MathUtils.signum(m),x=Math.abs(d.data.scaleY)*t.MathUtils.signum(p),d.scaleX=y+(m-y)*l,d.scaleY=x+(p-x)*l;break;case e.first:case e.replace:y=Math.abs(d.scaleX)*t.MathUtils.signum(m),x=Math.abs(d.scaleY)*t.MathUtils.signum(p),d.scaleX=y+(m-y)*l,d.scaleY=x+(p-x)*l;break;case e.add:y=t.MathUtils.signum(m),x=t.MathUtils.signum(p),d.scaleX=Math.abs(d.scaleX)*y+(m-Math.abs(d.data.scaleX)*y)*l,d.scaleY=Math.abs(d.scaleY)*x+(p-Math.abs(d.data.scaleY)*x)*l}}}},o}(a);t.ScaleTimeline=c;var l=function(t){function i(e){return t.call(this,e)||this}return vnt(i,t),i.prototype.getPropertyId=function(){return(n.shear<<24)+this.boneIndex},i.prototype.apply=function(t,n,r,o,a,c){var l=this.frames,h=t.bones[this.boneIndex];if(h.active)if(r<l[0])switch(c){case e.setup:return h.shearX=h.data.shearX,void(h.shearY=h.data.shearY);case e.first:h.shearX+=(h.data.shearX-h.shearX)*a,h.shearY+=(h.data.shearY-h.shearY)*a}else{var _=0,u=0;if(r>=l[l.length-i.ENTRIES])_=l[l.length+i.PREV_X],u=l[l.length+i.PREV_Y];else{var d=s.binarySearch(l,r,i.ENTRIES);_=l[d+i.PREV_X],u=l[d+i.PREV_Y];var m=l[d],p=this.getCurvePercent(d/i.ENTRIES-1,1-(r-m)/(l[d+i.PREV_TIME]-m));_+=(l[d+i.X]-_)*p,u+=(l[d+i.Y]-u)*p}switch(c){case e.setup:h.shearX=h.data.shearX+_*a,h.shearY=h.data.shearY+u*a;break;case e.first:case e.replace:h.shearX+=(h.data.shearX+_-h.shearX)*a,h.shearY+=(h.data.shearY+u-h.shearY)*a;break;case e.add:h.shearX+=_*a,h.shearY+=u*a}}},i}(a);t.ShearTimeline=l;var h=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return vnt(r,i),r.prototype.getPropertyId=function(){return(n.color<<24)+this.slotIndex},r.prototype.setFrame=function(t,e,i,n,s,o){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.R]=i,this.frames[t+r.G]=n,this.frames[t+r.B]=s,this.frames[t+r.A]=o},r.prototype.apply=function(t,i,n,o,a,c){var l=t.slots[this.slotIndex];if(l.bone.active){var h=this.frames;if(n<h[0])switch(c){case e.setup:return void l.color.setFromColor(l.data.color);case e.first:var _=l.color,u=l.data.color;_.add((u.r-_.r)*a,(u.g-_.g)*a,(u.b-_.b)*a,(u.a-_.a)*a)}else{var d=0,m=0,p=0,f=0;if(n>=h[h.length-r.ENTRIES]){var g=h.length;d=h[g+r.PREV_R],m=h[g+r.PREV_G],p=h[g+r.PREV_B],f=h[g+r.PREV_A]}else{var v=s.binarySearch(h,n,r.ENTRIES);d=h[v+r.PREV_R],m=h[v+r.PREV_G],p=h[v+r.PREV_B],f=h[v+r.PREV_A];var y=h[v],x=this.getCurvePercent(v/r.ENTRIES-1,1-(n-y)/(h[v+r.PREV_TIME]-y));d+=(h[v+r.R]-d)*x,m+=(h[v+r.G]-m)*x,p+=(h[v+r.B]-p)*x,f+=(h[v+r.A]-f)*x}1==a?l.color.set(d,m,p,f):(_=l.color,c==e.setup&&_.setFromColor(l.data.color),_.add((d-_.r)*a,(m-_.g)*a,(p-_.b)*a,(f-_.a)*a))}}},r.ENTRIES=5,r.PREV_TIME=-5,r.PREV_R=-4,r.PREV_G=-3,r.PREV_B=-2,r.PREV_A=-1,r.R=1,r.G=2,r.B=3,r.A=4,r}(r);t.ColorTimeline=h;var _=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return vnt(r,i),r.prototype.getPropertyId=function(){return(n.twoColor<<24)+this.slotIndex},r.prototype.setFrame=function(t,e,i,n,s,o,a,c,l){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.R]=i,this.frames[t+r.G]=n,this.frames[t+r.B]=s,this.frames[t+r.A]=o,this.frames[t+r.R2]=a,this.frames[t+r.G2]=c,this.frames[t+r.B2]=l},r.prototype.apply=function(t,i,n,o,a,c){var l=t.slots[this.slotIndex];if(l.bone.active){var h=this.frames;if(n<h[0])switch(c){case e.setup:return l.color.setFromColor(l.data.color),void l.darkColor.setFromColor(l.data.darkColor);case e.first:var _=l.color,u=l.darkColor,d=l.data.color,m=l.data.darkColor;_.add((d.r-_.r)*a,(d.g-_.g)*a,(d.b-_.b)*a,(d.a-_.a)*a),u.add((m.r-u.r)*a,(m.g-u.g)*a,(m.b-u.b)*a,0)}else{var p=0,f=0,g=0,v=0,y=0,x=0,S=0;if(n>=h[h.length-r.ENTRIES]){var C=h.length;p=h[C+r.PREV_R],f=h[C+r.PREV_G],g=h[C+r.PREV_B],v=h[C+r.PREV_A],y=h[C+r.PREV_R2],x=h[C+r.PREV_G2],S=h[C+r.PREV_B2]}else{var A=s.binarySearch(h,n,r.ENTRIES);p=h[A+r.PREV_R],f=h[A+r.PREV_G],g=h[A+r.PREV_B],v=h[A+r.PREV_A],y=h[A+r.PREV_R2],x=h[A+r.PREV_G2],S=h[A+r.PREV_B2];var b=h[A],T=this.getCurvePercent(A/r.ENTRIES-1,1-(n-b)/(h[A+r.PREV_TIME]-b));p+=(h[A+r.R]-p)*T,f+=(h[A+r.G]-f)*T,g+=(h[A+r.B]-g)*T,v+=(h[A+r.A]-v)*T,y+=(h[A+r.R2]-y)*T,x+=(h[A+r.G2]-x)*T,S+=(h[A+r.B2]-S)*T}1==a?(l.color.set(p,f,g,v),l.darkColor.set(y,x,S,1)):(_=l.color,u=l.darkColor,c==e.setup&&(_.setFromColor(l.data.color),u.setFromColor(l.data.darkColor)),_.add((p-_.r)*a,(f-_.g)*a,(g-_.b)*a,(v-_.a)*a),u.add((y-u.r)*a,(x-u.g)*a,(S-u.b)*a,0))}}},r.ENTRIES=8,r.PREV_TIME=-8,r.PREV_R=-7,r.PREV_G=-6,r.PREV_B=-5,r.PREV_A=-4,r.PREV_R2=-3,r.PREV_G2=-2,r.PREV_B2=-1,r.R=1,r.G=2,r.B=3,r.A=4,r.R2=5,r.G2=6,r.B2=7,r}(r);t.TwoColorTimeline=_;var u=function(){function r(e){this.frames=t.Utils.newFloatArray(e),this.attachmentNames=new Array(e)}return r.prototype.getPropertyId=function(){return(n.attachment<<24)+this.slotIndex},r.prototype.getFrameCount=function(){return this.frames.length},r.prototype.setFrame=function(t,e,i){this.frames[t]=e,this.attachmentNames[t]=i},r.prototype.apply=function(t,n,r,o,a,c,l){var h=t.slots[this.slotIndex];if(h.bone.active)if(l!=i.mixOut||c!=e.setup){var _=this.frames;if(r<_[0]){if(c==e.setup||c==e.first){var u=h.data.attachmentName;h.setAttachment(null==u?null:t.getAttachment(this.slotIndex,u))}}else{var d;d=r>=_[_.length-1]?_.length-1:s.binarySearch(_,r,1)-1;var m=this.attachmentNames[d];t.slots[this.slotIndex].setAttachment(null==m?null:t.getAttachment(this.slotIndex,m))}}else{var p=h.data.attachmentName;h.setAttachment(null==p?null:t.getAttachment(this.slotIndex,p))}},r}();t.AttachmentTimeline=u;var d=null,m=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e),n.frameVertices=new Array(e),null==d&&(d=t.Utils.newFloatArray(64)),n}return vnt(r,i),r.prototype.getPropertyId=function(){return(n.deform<<27)+ +this.attachment.id+this.slotIndex},r.prototype.setFrame=function(t,e,i){this.frames[t]=e,this.frameVertices[t]=i},r.prototype.apply=function(i,n,r,o,a,c){var l=i.slots[this.slotIndex];if(l.bone.active){var h=l.getAttachment();if(h instanceof t.VertexAttachment&&h.deformAttachment==this.attachment){var _=l.deform;0==_.length&&(c=e.setup);var u=this.frameVertices,d=u[0].length,m=this.frames;if(r<m[0]){var p=h;switch(c){case e.setup:return void(_.length=0);case e.first:if(1==a){_.length=0;break}var f=t.Utils.setArraySize(_,d);if(null==p.bones)for(var g=p.vertices,v=0;v<d;v++)f[v]+=(g[v]-f[v])*a;else for(a=1-a,v=0;v<d;v++)f[v]*=a}}else{var y=t.Utils.setArraySize(_,d);if(r>=m[m.length-1]){var x=u[m.length-1];if(1==a)if(c==e.add)if(null==(p=h).bones){g=p.vertices;for(var S=0;S<d;S++)y[S]+=x[S]-g[S]}else for(var C=0;C<d;C++)y[C]+=x[C];else t.Utils.arrayCopy(x,0,y,0,d);else switch(c){case e.setup:var A=h;if(null==A.bones){g=A.vertices;for(var b=0;b<d;b++){var T=g[b];y[b]=T+(x[b]-T)*a}}else for(var E=0;E<d;E++)y[E]=x[E]*a;break;case e.first:case e.replace:for(var P=0;P<d;P++)y[P]+=(x[P]-y[P])*a;case e.add:if(null==(p=h).bones){g=p.vertices;for(var w=0;w<d;w++)y[w]+=(x[w]-g[w])*a}else for(var I=0;I<d;I++)y[I]+=x[I]*a}}else{var R=s.binarySearch(m,r),D=u[R-1],M=u[R],O=m[R],B=this.getCurvePercent(R-1,1-(r-O)/(m[R-1]-O));if(1==a)if(c==e.add)if(null==(p=h).bones){g=p.vertices;for(var N=0;N<d;N++){var L=D[N];y[N]+=L+(M[N]-L)*B-g[N]}}else for(var F=0;F<d;F++)L=D[F],y[F]+=L+(M[F]-L)*B;else for(var z=0;z<d;z++)L=D[z],y[z]=L+(M[z]-L)*B;else switch(c){case e.setup:var V=h;if(null==V.bones){g=V.vertices;for(var G=0;G<d;G++)L=D[G],T=g[G],y[G]=T+(L+(M[G]-L)*B-T)*a}else for(var U=0;U<d;U++)L=D[U],y[U]=(L+(M[U]-L)*B)*a;break;case e.first:case e.replace:for(var k=0;k<d;k++)L=D[k],y[k]+=(L+(M[k]-L)*B-y[k])*a;break;case e.add:if(null==(p=h).bones){g=p.vertices;for(var H=0;H<d;H++)L=D[H],y[H]+=(L+(M[H]-L)*B-g[H])*a}else for(var j=0;j<d;j++)L=D[j],y[j]+=(L+(M[j]-L)*B)*a}}}}}},r}(r);t.DeformTimeline=m;var p=function(){function e(e){this.frames=t.Utils.newFloatArray(e),this.events=new Array(e)}return e.prototype.getPropertyId=function(){return n.event<<24},e.prototype.getFrameCount=function(){return this.frames.length},e.prototype.setFrame=function(t,e){this.frames[t]=e.time,this.events[t]=e},e.prototype.apply=function(t,e,i,n,r,o,a){if(null!=n){var c=this.frames,l=this.frames.length;if(e>i)this.apply(t,e,Number.MAX_VALUE,n,r,o,a),e=-1;else if(e>=c[l-1])return;if(!(i<c[0])){var h=0;if(e<c[0])h=0;else for(var _=c[h=s.binarySearch(c,e)];h>0&&c[h-1]==_;)h--;for(;h<l&&i>=c[h];h++)n.push(this.events[h])}}},e}();t.EventTimeline=p;var f=function(){function r(e){this.frames=t.Utils.newFloatArray(e),this.drawOrders=new Array(e)}return r.prototype.getPropertyId=function(){return n.drawOrder<<24},r.prototype.getFrameCount=function(){return this.frames.length},r.prototype.setFrame=function(t,e,i){this.frames[t]=e,this.drawOrders[t]=i},r.prototype.apply=function(n,r,o,a,c,l,h){var _=n.drawOrder,u=n.slots;if(h!=i.mixOut||l!=e.setup){var d=this.frames;if(o<d[0])l!=e.setup&&l!=e.first||t.Utils.arrayCopy(n.slots,0,n.drawOrder,0,n.slots.length);else{var m;m=o>=d[d.length-1]?d.length-1:s.binarySearch(d,o)-1;var p=this.drawOrders[m];if(null==p)t.Utils.arrayCopy(u,0,_,0,u.length);else for(var f=0,g=p.length;f<g;f++)_[f]=u[p[f]]}}else t.Utils.arrayCopy(n.slots,0,n.drawOrder,0,n.slots.length)},r}();t.DrawOrderTimeline=f;var g=function(r){function o(e){var i=r.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return vnt(o,r),o.prototype.getPropertyId=function(){return(n.ikConstraint<<24)+this.ikConstraintIndex},o.prototype.setFrame=function(t,e,i,n,s,r,a){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.MIX]=i,this.frames[t+o.SOFTNESS]=n,this.frames[t+o.BEND_DIRECTION]=s,this.frames[t+o.COMPRESS]=r?1:0,this.frames[t+o.STRETCH]=a?1:0},o.prototype.apply=function(t,n,r,a,c,l,h){var _=this.frames,u=t.ikConstraints[this.ikConstraintIndex];if(u.active)if(r<_[0])switch(l){case e.setup:return u.mix=u.data.mix,u.softness=u.data.softness,u.bendDirection=u.data.bendDirection,u.compress=u.data.compress,void(u.stretch=u.data.stretch);case e.first:u.mix+=(u.data.mix-u.mix)*c,u.softness+=(u.data.softness-u.softness)*c,u.bendDirection=u.data.bendDirection,u.compress=u.data.compress,u.stretch=u.data.stretch}else if(r>=_[_.length-o.ENTRIES])l==e.setup?(u.mix=u.data.mix+(_[_.length+o.PREV_MIX]-u.data.mix)*c,u.softness=u.data.softness+(_[_.length+o.PREV_SOFTNESS]-u.data.softness)*c,h==i.mixOut?(u.bendDirection=u.data.bendDirection,u.compress=u.data.compress,u.stretch=u.data.stretch):(u.bendDirection=_[_.length+o.PREV_BEND_DIRECTION],u.compress=0!=_[_.length+o.PREV_COMPRESS],u.stretch=0!=_[_.length+o.PREV_STRETCH])):(u.mix+=(_[_.length+o.PREV_MIX]-u.mix)*c,u.softness+=(_[_.length+o.PREV_SOFTNESS]-u.softness)*c,h==i.mixIn&&(u.bendDirection=_[_.length+o.PREV_BEND_DIRECTION],u.compress=0!=_[_.length+o.PREV_COMPRESS],u.stretch=0!=_[_.length+o.PREV_STRETCH]));else{var d=s.binarySearch(_,r,o.ENTRIES),m=_[d+o.PREV_MIX],p=_[d+o.PREV_SOFTNESS],f=_[d],g=this.getCurvePercent(d/o.ENTRIES-1,1-(r-f)/(_[d+o.PREV_TIME]-f));l==e.setup?(u.mix=u.data.mix+(m+(_[d+o.MIX]-m)*g-u.data.mix)*c,u.softness=u.data.softness+(p+(_[d+o.SOFTNESS]-p)*g-u.data.softness)*c,h==i.mixOut?(u.bendDirection=u.data.bendDirection,u.compress=u.data.compress,u.stretch=u.data.stretch):(u.bendDirection=_[d+o.PREV_BEND_DIRECTION],u.compress=0!=_[d+o.PREV_COMPRESS],u.stretch=0!=_[d+o.PREV_STRETCH])):(u.mix+=(m+(_[d+o.MIX]-m)*g-u.mix)*c,u.softness+=(p+(_[d+o.SOFTNESS]-p)*g-u.softness)*c,h==i.mixIn&&(u.bendDirection=_[d+o.PREV_BEND_DIRECTION],u.compress=0!=_[d+o.PREV_COMPRESS],u.stretch=0!=_[d+o.PREV_STRETCH]))}},o.ENTRIES=6,o.PREV_TIME=-6,o.PREV_MIX=-5,o.PREV_SOFTNESS=-4,o.PREV_BEND_DIRECTION=-3,o.PREV_COMPRESS=-2,o.PREV_STRETCH=-1,o.MIX=1,o.SOFTNESS=2,o.BEND_DIRECTION=3,o.COMPRESS=4,o.STRETCH=5,o}(r);t.IkConstraintTimeline=g;var v=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return vnt(r,i),r.prototype.getPropertyId=function(){return(n.transformConstraint<<24)+this.transformConstraintIndex},r.prototype.setFrame=function(t,e,i,n,s,o){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.ROTATE]=i,this.frames[t+r.TRANSLATE]=n,this.frames[t+r.SCALE]=s,this.frames[t+r.SHEAR]=o},r.prototype.apply=function(t,i,n,o,a,c){var l=this.frames,h=t.transformConstraints[this.transformConstraintIndex];if(h.active)if(n<l[0]){var _=h.data;switch(c){case e.setup:return h.rotateMix=_.rotateMix,h.translateMix=_.translateMix,h.scaleMix=_.scaleMix,void(h.shearMix=_.shearMix);case e.first:h.rotateMix+=(_.rotateMix-h.rotateMix)*a,h.translateMix+=(_.translateMix-h.translateMix)*a,h.scaleMix+=(_.scaleMix-h.scaleMix)*a,h.shearMix+=(_.shearMix-h.shearMix)*a}}else{var u=0,d=0,m=0,p=0;if(n>=l[l.length-r.ENTRIES]){var f=l.length;u=l[f+r.PREV_ROTATE],d=l[f+r.PREV_TRANSLATE],m=l[f+r.PREV_SCALE],p=l[f+r.PREV_SHEAR]}else{var g=s.binarySearch(l,n,r.ENTRIES);u=l[g+r.PREV_ROTATE],d=l[g+r.PREV_TRANSLATE],m=l[g+r.PREV_SCALE],p=l[g+r.PREV_SHEAR];var v=l[g],y=this.getCurvePercent(g/r.ENTRIES-1,1-(n-v)/(l[g+r.PREV_TIME]-v));u+=(l[g+r.ROTATE]-u)*y,d+=(l[g+r.TRANSLATE]-d)*y,m+=(l[g+r.SCALE]-m)*y,p+=(l[g+r.SHEAR]-p)*y}c==e.setup?(_=h.data,h.rotateMix=_.rotateMix+(u-_.rotateMix)*a,h.translateMix=_.translateMix+(d-_.translateMix)*a,h.scaleMix=_.scaleMix+(m-_.scaleMix)*a,h.shearMix=_.shearMix+(p-_.shearMix)*a):(h.rotateMix+=(u-h.rotateMix)*a,h.translateMix+=(d-h.translateMix)*a,h.scaleMix+=(m-h.scaleMix)*a,h.shearMix+=(p-h.shearMix)*a)}},r.ENTRIES=5,r.PREV_TIME=-5,r.PREV_ROTATE=-4,r.PREV_TRANSLATE=-3,r.PREV_SCALE=-2,r.PREV_SHEAR=-1,r.ROTATE=1,r.TRANSLATE=2,r.SCALE=3,r.SHEAR=4,r}(r);t.TransformConstraintTimeline=v;var y=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return vnt(r,i),r.prototype.getPropertyId=function(){return(n.pathConstraintPosition<<24)+this.pathConstraintIndex},r.prototype.setFrame=function(t,e,i){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.VALUE]=i},r.prototype.apply=function(t,i,n,o,a,c){var l=this.frames,h=t.pathConstraints[this.pathConstraintIndex];if(h.active)if(n<l[0])switch(c){case e.setup:return void(h.position=h.data.position);case e.first:h.position+=(h.data.position-h.position)*a}else{var _=0;if(n>=l[l.length-r.ENTRIES])_=l[l.length+r.PREV_VALUE];else{var u=s.binarySearch(l,n,r.ENTRIES);_=l[u+r.PREV_VALUE];var d=l[u],m=this.getCurvePercent(u/r.ENTRIES-1,1-(n-d)/(l[u+r.PREV_TIME]-d));_+=(l[u+r.VALUE]-_)*m}c==e.setup?h.position=h.data.position+(_-h.data.position)*a:h.position+=(_-h.position)*a}},r.ENTRIES=2,r.PREV_TIME=-2,r.PREV_VALUE=-1,r.VALUE=1,r}(r);t.PathConstraintPositionTimeline=y;var x=function(t){function i(e){return t.call(this,e)||this}return vnt(i,t),i.prototype.getPropertyId=function(){return(n.pathConstraintSpacing<<24)+this.pathConstraintIndex},i.prototype.apply=function(t,n,r,o,a,c){var l=this.frames,h=t.pathConstraints[this.pathConstraintIndex];if(h.active)if(r<l[0])switch(c){case e.setup:return void(h.spacing=h.data.spacing);case e.first:h.spacing+=(h.data.spacing-h.spacing)*a}else{var _=0;if(r>=l[l.length-i.ENTRIES])_=l[l.length+i.PREV_VALUE];else{var u=s.binarySearch(l,r,i.ENTRIES);_=l[u+i.PREV_VALUE];var d=l[u],m=this.getCurvePercent(u/i.ENTRIES-1,1-(r-d)/(l[u+i.PREV_TIME]-d));_+=(l[u+i.VALUE]-_)*m}c==e.setup?h.spacing=h.data.spacing+(_-h.data.spacing)*a:h.spacing+=(_-h.spacing)*a}},i}(y);t.PathConstraintSpacingTimeline=x;var S=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return vnt(r,i),r.prototype.getPropertyId=function(){return(n.pathConstraintMix<<24)+this.pathConstraintIndex},r.prototype.setFrame=function(t,e,i,n){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.ROTATE]=i,this.frames[t+r.TRANSLATE]=n},r.prototype.apply=function(t,i,n,o,a,c){var l=this.frames,h=t.pathConstraints[this.pathConstraintIndex];if(h.active)if(n<l[0])switch(c){case e.setup:return h.rotateMix=h.data.rotateMix,void(h.translateMix=h.data.translateMix);case e.first:h.rotateMix+=(h.data.rotateMix-h.rotateMix)*a,h.translateMix+=(h.data.translateMix-h.translateMix)*a}else{var _=0,u=0;if(n>=l[l.length-r.ENTRIES])_=l[l.length+r.PREV_ROTATE],u=l[l.length+r.PREV_TRANSLATE];else{var d=s.binarySearch(l,n,r.ENTRIES);_=l[d+r.PREV_ROTATE],u=l[d+r.PREV_TRANSLATE];var m=l[d],p=this.getCurvePercent(d/r.ENTRIES-1,1-(n-m)/(l[d+r.PREV_TIME]-m));_+=(l[d+r.ROTATE]-_)*p,u+=(l[d+r.TRANSLATE]-u)*p}c==e.setup?(h.rotateMix=h.data.rotateMix+(_-h.data.rotateMix)*a,h.translateMix=h.data.translateMix+(u-h.data.translateMix)*a):(h.rotateMix+=(_-h.rotateMix)*a,h.translateMix+=(u-h.translateMix)*a)}},r.ENTRIES=3,r.PREV_TIME=-3,r.PREV_ROTATE=-2,r.PREV_TRANSLATE=-1,r.ROTATE=1,r.TRANSLATE=2,r}(r);t.PathConstraintMixTimeline=S}(gnt||(gnt={})),function(t){var e=function(){function e(e){this.tracks=new Array,this.timeScale=1,this.events=new Array,this.listeners=new Array,this.queue=new s(this),this.propertyIDs=new t.IntSet,this.animationsChanged=!1,this.trackEntryPool=new t.Pool((function(){return new i})),this.data=e}return e.prototype.update=function(t){t*=this.timeScale;for(var e=this.tracks,i=0,n=e.length;i<n;i++){var s=e[i];if(null!=s){s.animationLast=s.nextAnimationLast,s.trackLast=s.nextTrackLast;var r=t*s.timeScale;if(s.delay>0){if(s.delay-=r,s.delay>0)continue;r=-s.delay,s.delay=0}var o=s.next;if(null!=o){var a=s.trackLast-o.delay;if(a>=0){for(o.delay=0,o.trackTime+=0==s.timeScale?0:(a/s.timeScale+t)*o.timeScale,s.trackTime+=r,this.setCurrent(i,o,!0);null!=o.mixingFrom;)o.mixTime+=t,o=o.mixingFrom;continue}}else if(s.trackLast>=s.trackEnd&&null==s.mixingFrom){e[i]=null,this.queue.end(s),this.disposeNext(s);continue}if(null!=s.mixingFrom&&this.updateMixingFrom(s,t)){var c=s.mixingFrom;for(s.mixingFrom=null,null!=c&&(c.mixingTo=null);null!=c;)this.queue.end(c),c=c.mixingFrom}s.trackTime+=r}}this.queue.drain()},e.prototype.updateMixingFrom=function(t,e){var i=t.mixingFrom;if(null==i)return!0;var n=this.updateMixingFrom(i,e);return i.animationLast=i.nextAnimationLast,i.trackLast=i.nextTrackLast,t.mixTime>0&&t.mixTime>=t.mixDuration?(0!=i.totalAlpha&&0!=t.mixDuration||(t.mixingFrom=i.mixingFrom,null!=i.mixingFrom&&(i.mixingFrom.mixingTo=t),t.interruptAlpha=i.interruptAlpha,this.queue.end(i)),n):(i.trackTime+=e*i.timeScale,t.mixTime+=e,!1)},e.prototype.apply=function(i){if(null==i)throw new Error("skeleton cannot be null.");this.animationsChanged&&this._animationsChanged();for(var n=this.events,s=this.tracks,r=!1,o=0,a=s.length;o<a;o++){var c=s[o];if(!(null==c||c.delay>0)){r=!0;var l=0==o?t.MixBlend.first:c.mixBlend,h=c.alpha;null!=c.mixingFrom?h*=this.applyMixingFrom(c,i,l):c.trackTime>=c.trackEnd&&null==c.next&&(h=0);var _=c.animationLast,u=c.getAnimationTime(),d=c.animation.timelines.length,m=c.animation.timelines;if(0==o&&1==h||l==t.MixBlend.add)for(var p=0;p<d;p++)t.Utils.webkit602BugfixHelper(h,l),m[p].apply(i,_,u,n,h,l,t.MixDirection.mixIn);else{var f=c.timelineMode,g=0==c.timelinesRotation.length;g&&t.Utils.setArraySize(c.timelinesRotation,d<<1,null);var v=c.timelinesRotation;for(p=0;p<d;p++){var y=m[p],x=(f[p]&e.NOT_LAST-1)==e.SUBSEQUENT?l:t.MixBlend.setup;y instanceof t.RotateTimeline?this.applyRotateTimeline(y,i,u,h,x,v,p<<1,g):(t.Utils.webkit602BugfixHelper(h,l),y.apply(i,_,u,n,h,x,t.MixDirection.mixIn))}}this.queueEvents(c,u),n.length=0,c.nextAnimationLast=u,c.nextTrackLast=c.trackTime}}return this.queue.drain(),r},e.prototype.applyMixingFrom=function(i,n,s){var r=i.mixingFrom;null!=r.mixingFrom&&this.applyMixingFrom(r,n,s);var o=0;0==i.mixDuration?(o=1,s==t.MixBlend.first&&(s=t.MixBlend.setup)):((o=i.mixTime/i.mixDuration)>1&&(o=1),s!=t.MixBlend.first&&(s=r.mixBlend));var a=o<r.eventThreshold?this.events:null,c=o<r.attachmentThreshold,l=o<r.drawOrderThreshold,h=r.animationLast,_=r.getAnimationTime(),u=r.animation.timelines.length,d=r.animation.timelines,m=r.alpha*i.interruptAlpha,p=m*(1-o);if(s==t.MixBlend.add)for(var f=0;f<u;f++)d[f].apply(n,h,_,a,p,s,t.MixDirection.mixOut);else{var g=r.timelineMode,v=r.timelineHoldMix,y=0==r.timelinesRotation.length;y&&t.Utils.setArraySize(r.timelinesRotation,u<<1,null);var x=r.timelinesRotation;for(r.totalAlpha=0,f=0;f<u;f++){var S=d[f],C=t.MixDirection.mixOut,A=void 0,b=0;switch(g[f]&e.NOT_LAST-1){case e.SUBSEQUENT:if(A=s,!c&&S instanceof t.AttachmentTimeline){if((g[f]&e.NOT_LAST)==e.NOT_LAST)continue;A=t.MixBlend.setup}if(!l&&S instanceof t.DrawOrderTimeline)continue;b=p;break;case e.FIRST:A=t.MixBlend.setup,b=p;break;case e.HOLD:A=t.MixBlend.setup,b=m;break;default:A=t.MixBlend.setup;var T=v[f];b=m*Math.max(0,1-T.mixTime/T.mixDuration)}r.totalAlpha+=b,S instanceof t.RotateTimeline?this.applyRotateTimeline(S,n,_,b,A,x,f<<1,y):(t.Utils.webkit602BugfixHelper(b,s),A==t.MixBlend.setup&&(S instanceof t.AttachmentTimeline?(c||(g[f]&e.NOT_LAST)==e.NOT_LAST)&&(C=t.MixDirection.mixIn):S instanceof t.DrawOrderTimeline&&l&&(C=t.MixDirection.mixIn)),S.apply(n,h,_,a,b,A,C))}}return i.mixDuration>0&&this.queueEvents(r,_),this.events.length=0,r.nextAnimationLast=_,r.nextTrackLast=r.trackTime,o},e.prototype.applyRotateTimeline=function(e,i,n,s,r,o,a,c){if(c&&(o[a]=0),1!=s){var l=e,h=l.frames,_=i.bones[l.boneIndex];if(_.active){var u=0,d=0;if(n<h[0])switch(r){case t.MixBlend.setup:_.rotation=_.data.rotation;default:return;case t.MixBlend.first:u=_.rotation,d=_.data.rotation}else if(u=r==t.MixBlend.setup?_.data.rotation:_.rotation,n>=h[h.length-t.RotateTimeline.ENTRIES])d=_.data.rotation+h[h.length+t.RotateTimeline.PREV_ROTATION];else{var m=t.Animation.binarySearch(h,n,t.RotateTimeline.ENTRIES),p=h[m+t.RotateTimeline.PREV_ROTATION],f=h[m],g=l.getCurvePercent((m>>1)-1,1-(n-f)/(h[m+t.RotateTimeline.PREV_TIME]-f));d=h[m+t.RotateTimeline.ROTATION]-p,d=p+(d-=360*(16384-(16384.499999999996-d/360|0)))*g+_.data.rotation,d-=360*(16384-(16384.499999999996-d/360|0))}var v=0,y=d-u;if(0==(y-=360*(16384-(16384.499999999996-y/360|0))))v=o[a];else{var x=0,S=0;c?(x=0,S=y):(x=o[a],S=o[a+1]);var C=y>0,A=x>=0;t.MathUtils.signum(S)!=t.MathUtils.signum(y)&&Math.abs(S)<=90&&(Math.abs(x)>180&&(x+=360*t.MathUtils.signum(x)),A=C),v=y+x-x%360,A!=C&&(v+=360*t.MathUtils.signum(x)),o[a]=v}o[a+1]=y,u+=v*s,_.rotation=u-360*(16384-(16384.499999999996-u/360|0))}}else e.apply(i,0,n,null,1,r,t.MixDirection.mixIn)},e.prototype.queueEvents=function(t,e){for(var i=t.animationStart,n=t.animationEnd,s=n-i,r=t.trackLast%s,o=this.events,a=0,c=o.length;a<c;a++){var l=o[a];if(l.time<r)break;l.time>n||this.queue.event(t,l)}for((t.loop?0==s||r>t.trackTime%s:e>=n&&t.animationLast<n)&&this.queue.complete(t);a<c;a++)o[a].time<i||this.queue.event(t,o[a])},e.prototype.clearTracks=function(){var t=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(var e=0,i=this.tracks.length;e<i;e++)this.clearTrack(e);this.tracks.length=0,this.queue.drainDisabled=t,this.queue.drain()},e.prototype.clearTrack=function(t){if(!(t>=this.tracks.length)){var e=this.tracks[t];if(null!=e){this.queue.end(e),this.disposeNext(e);for(var i=e;;){var n=i.mixingFrom;if(null==n)break;this.queue.end(n),i.mixingFrom=null,i.mixingTo=null,i=n}this.tracks[e.trackIndex]=null,this.queue.drain()}}},e.prototype.setCurrent=function(t,e,i){var n=this.expandToIndex(t);this.tracks[t]=e,null!=n&&(i&&this.queue.interrupt(n),e.mixingFrom=n,n.mixingTo=e,e.mixTime=0,null!=n.mixingFrom&&n.mixDuration>0&&(e.interruptAlpha*=Math.min(1,n.mixTime/n.mixDuration)),n.timelinesRotation.length=0),this.queue.start(e)},e.prototype.setAnimation=function(t,e,i){var n=this.data.skeletonData.findAnimation(e);if(null==n)throw new Error("Animation not found: "+e);return this.setAnimationWith(t,n,i)},e.prototype.setAnimationWith=function(t,e,i){if(null==e)throw new Error("animation cannot be null.");var n=!0,s=this.expandToIndex(t);null!=s&&(-1==s.nextTrackLast?(this.tracks[t]=s.mixingFrom,this.queue.interrupt(s),this.queue.end(s),this.disposeNext(s),s=s.mixingFrom,n=!1):this.disposeNext(s));var r=this.trackEntry(t,e,i,s);return this.setCurrent(t,r,n),this.queue.drain(),r},e.prototype.addAnimation=function(t,e,i,n){var s=this.data.skeletonData.findAnimation(e);if(null==s)throw new Error("Animation not found: "+e);return this.addAnimationWith(t,s,i,n)},e.prototype.addAnimationWith=function(t,e,i,n){if(null==e)throw new Error("animation cannot be null.");var s=this.expandToIndex(t);if(null!=s)for(;null!=s.next;)s=s.next;var r=this.trackEntry(t,e,i,s);if(null==s)this.setCurrent(t,r,!0),this.queue.drain();else if(s.next=r,n<=0){var o=s.animationEnd-s.animationStart;0!=o?(s.loop?n+=o*(1+(s.trackTime/o|0)):n+=Math.max(o,s.trackTime),n-=this.data.getMix(s.animation,e)):n=s.trackTime}return r.delay=n,r},e.prototype.setEmptyAnimation=function(t,i){var n=this.setAnimationWith(t,e.emptyAnimation,!1);return n.mixDuration=i,n.trackEnd=i,n},e.prototype.addEmptyAnimation=function(t,i,n){n<=0&&(n-=i);var s=this.addAnimationWith(t,e.emptyAnimation,!1,n);return s.mixDuration=i,s.trackEnd=i,s},e.prototype.setEmptyAnimations=function(t){var e=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(var i=0,n=this.tracks.length;i<n;i++){var s=this.tracks[i];null!=s&&this.setEmptyAnimation(s.trackIndex,t)}this.queue.drainDisabled=e,this.queue.drain()},e.prototype.expandToIndex=function(e){return e<this.tracks.length?this.tracks[e]:(t.Utils.ensureArrayCapacity(this.tracks,e+1,null),this.tracks.length=e+1,null)},e.prototype.trackEntry=function(t,e,i,n){var s=this.trackEntryPool.obtain();return s.trackIndex=t,s.animation=e,s.loop=i,s.holdPrevious=!1,s.eventThreshold=0,s.attachmentThreshold=0,s.drawOrderThreshold=0,s.animationStart=0,s.animationEnd=e.duration,s.animationLast=-1,s.nextAnimationLast=-1,s.delay=0,s.trackTime=0,s.trackLast=-1,s.nextTrackLast=-1,s.trackEnd=Number.MAX_VALUE,s.timeScale=1,s.alpha=1,s.interruptAlpha=1,s.mixTime=0,s.mixDuration=null==n?0:this.data.getMix(n.animation,e),s},e.prototype.disposeNext=function(t){for(var e=t.next;null!=e;)this.queue.dispose(e),e=e.next;t.next=null},e.prototype._animationsChanged=function(){this.animationsChanged=!1,this.propertyIDs.clear();for(var e=0,i=this.tracks.length;e<i;e++)if(null!=(n=this.tracks[e])){for(;null!=n.mixingFrom;)n=n.mixingFrom;do{null!=n.mixingFrom&&n.mixBlend==t.MixBlend.add||this.computeHold(n),n=n.mixingTo}while(null!=n)}for(this.propertyIDs.clear(),e=this.tracks.length-1;e>=0;e--)for(var n=this.tracks[e];null!=n;)this.computeNotLast(n),n=n.mixingFrom},e.prototype.computeHold=function(i){var n=i.mixingTo,s=i.animation.timelines,r=i.animation.timelines.length,o=t.Utils.setArraySize(i.timelineMode,r);i.timelineHoldMix.length=0;var a=t.Utils.setArraySize(i.timelineHoldMix,r),c=this.propertyIDs;if(null!=n&&n.holdPrevious)for(var l=0;l<r;l++)c.add(s[l].getPropertyId()),o[l]=e.HOLD;else t:for(l=0;l<r;l++){var h=s[l],_=h.getPropertyId();if(c.add(_))if(null==n||h instanceof t.AttachmentTimeline||h instanceof t.DrawOrderTimeline||h instanceof t.EventTimeline||!n.animation.hasTimeline(_))o[l]=e.FIRST;else{for(var u=n.mixingTo;null!=u;u=u.mixingTo)if(!u.animation.hasTimeline(_)){if(i.mixDuration>0){o[l]=e.HOLD_MIX,a[l]=u;continue t}break}o[l]=e.HOLD}else o[l]=e.SUBSEQUENT}},e.prototype.computeNotLast=function(i){for(var n=i.animation.timelines,s=i.animation.timelines.length,r=i.timelineMode,o=this.propertyIDs,a=0;a<s;a++)if(n[a]instanceof t.AttachmentTimeline){var c=n[a];o.add(c.slotIndex)||(r[a]|=e.NOT_LAST)}},e.prototype.getCurrent=function(t){return t>=this.tracks.length?null:this.tracks[t]},e.prototype.addListener=function(t){if(null==t)throw new Error("listener cannot be null.");this.listeners.push(t)},e.prototype.removeListener=function(t){var e=this.listeners.indexOf(t);e>=0&&this.listeners.splice(e,1)},e.prototype.clearListeners=function(){this.listeners.length=0},e.prototype.clearListenerNotifications=function(){this.queue.clear()},e.emptyAnimation=new t.Animation("<empty>",[],0),e.SUBSEQUENT=0,e.FIRST=1,e.HOLD=2,e.HOLD_MIX=3,e.NOT_LAST=4,e}();t.AnimationState=e;var i=function(){function e(){this.mixBlend=t.MixBlend.replace,this.timelineMode=new Array,this.timelineHoldMix=new Array,this.timelinesRotation=new Array}return e.prototype.reset=function(){this.next=null,this.mixingFrom=null,this.mixingTo=null,this.animation=null,this.listener=null,this.timelineMode.length=0,this.timelineHoldMix.length=0,this.timelinesRotation.length=0},e.prototype.getAnimationTime=function(){if(this.loop){var t=this.animationEnd-this.animationStart;return 0==t?this.animationStart:this.trackTime%t+this.animationStart}return Math.min(this.trackTime+this.animationStart,this.animationEnd)},e.prototype.setAnimationLast=function(t){this.animationLast=t,this.nextAnimationLast=t},e.prototype.isComplete=function(){return this.trackTime>=this.animationEnd-this.animationStart},e.prototype.resetRotationDirections=function(){this.timelinesRotation.length=0},e}();t.TrackEntry=i;var n,s=function(){function t(t){this.objects=[],this.drainDisabled=!1,this.animState=t}return t.prototype.start=function(t){this.objects.push(n.start),this.objects.push(t),this.animState.animationsChanged=!0},t.prototype.interrupt=function(t){this.objects.push(n.interrupt),this.objects.push(t)},t.prototype.end=function(t){this.objects.push(n.end),this.objects.push(t),this.animState.animationsChanged=!0},t.prototype.dispose=function(t){this.objects.push(n.dispose),this.objects.push(t)},t.prototype.complete=function(t){this.objects.push(n.complete),this.objects.push(t)},t.prototype.event=function(t,e){this.objects.push(n.event),this.objects.push(t),this.objects.push(e)},t.prototype.drain=function(){if(!this.drainDisabled){this.drainDisabled=!0;for(var t=this.objects,e=this.animState.listeners,i=0;i<t.length;i+=2){var s=t[i],r=t[i+1];switch(s){case n.start:null!=r.listener&&r.listener.start&&r.listener.start(r);for(var o=0;o<e.length;o++)e[o].start&&e[o].start(r);break;case n.interrupt:for(null!=r.listener&&r.listener.interrupt&&r.listener.interrupt(r),o=0;o<e.length;o++)e[o].interrupt&&e[o].interrupt(r);break;case n.end:for(null!=r.listener&&r.listener.end&&r.listener.end(r),o=0;o<e.length;o++)e[o].end&&e[o].end(r);case n.dispose:for(null!=r.listener&&r.listener.dispose&&r.listener.dispose(r),o=0;o<e.length;o++)e[o].dispose&&e[o].dispose(r);this.animState.trackEntryPool.free(r);break;case n.complete:for(null!=r.listener&&r.listener.complete&&r.listener.complete(r),o=0;o<e.length;o++)e[o].complete&&e[o].complete(r);break;case n.event:var a=t[2+i++];for(null!=r.listener&&r.listener.event&&r.listener.event(r,a),o=0;o<e.length;o++)e[o].event&&e[o].event(r,a)}}this.clear(),this.drainDisabled=!1}},t.prototype.clear=function(){this.objects.length=0},t}();t.EventQueue=s,function(t){t[t.start=0]="start",t[t.interrupt=1]="interrupt",t[t.end=2]="end",t[t.dispose=3]="dispose",t[t.complete=4]="complete",t[t.event=5]="event"}(n=t.EventType||(t.EventType={}));var r=function(){function t(){}return t.prototype.start=function(){},t.prototype.interrupt=function(){},t.prototype.end=function(){},t.prototype.dispose=function(){},t.prototype.complete=function(){},t.prototype.event=function(){},t}();t.AnimationStateAdapter=r}(gnt||(gnt={})),function(t){var e=function(){function t(t){if(this.animationToMixTime={},this.defaultMix=0,null==t)throw new Error("skeletonData cannot be null.");this.skeletonData=t}return t.prototype.setMix=function(t,e,i){var n=this.skeletonData.findAnimation(t);if(null==n)throw new Error("Animation not found: "+t);var s=this.skeletonData.findAnimation(e);if(null==s)throw new Error("Animation not found: "+e);this.setMixWith(n,s,i)},t.prototype.setMixWith=function(t,e,i){if(null==t)throw new Error("from cannot be null.");if(null==e)throw new Error("to cannot be null.");var n=t.name+"."+e.name;this.animationToMixTime[n]=i},t.prototype.getMix=function(t,e){var i=t.name+"."+e.name,n=this.animationToMixTime[i];return void 0===n?this.defaultMix:n},t}();t.AnimationStateData=e}(gnt||(gnt={})),function(t){var e=function(){function e(t,e){void 0===e&&(e=""),this.assets={},this.errors={},this.toLoad=0,this.loaded=0,this.textureLoader=t,this.pathPrefix=e}return e.downloadText=function(t,e,i){var n=new XMLHttpRequest;n.open("GET",t,!0),n.onload=function(){200==n.status?e(n.responseText):i(n.status,n.responseText)},n.onerror=function(){i(n.status,n.responseText)},n.send()},e.downloadBinary=function(t,e,i){var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){200==n.status?e(new Uint8Array(n.response)):i(n.status,n.responseText)},n.onerror=function(){i(n.status,n.responseText)},n.send()},e.prototype.loadBinary=function(t,i,n){var s=this;void 0===i&&(i=null),void 0===n&&(n=null),t=this.pathPrefix+t,this.toLoad++,e.downloadBinary(t,(function(e){s.assets[t]=e,i&&i(t,e),s.toLoad--,s.loaded++}),(function(e,i){s.errors[t]="Couldn't load binary "+t+": status "+status+", "+i,n&&n(t,"Couldn't load binary "+t+": status "+status+", "+i),s.toLoad--,s.loaded++}))},e.prototype.loadText=function(t,i,n){var s=this;void 0===i&&(i=null),void 0===n&&(n=null),t=this.pathPrefix+t,this.toLoad++,e.downloadText(t,(function(e){s.assets[t]=e,i&&i(t,e),s.toLoad--,s.loaded++}),(function(e,i){s.errors[t]="Couldn't load text "+t+": status "+status+", "+i,n&&n(t,"Couldn't load text "+t+": status "+status+", "+i),s.toLoad--,s.loaded++}))},e.prototype.loadTexture=function(t,e,i){var n=this;void 0===e&&(e=null),void 0===i&&(i=null),t=this.pathPrefix+t,this.toLoad++;var s=new Image;s.crossOrigin="anonymous",s.onload=function(){var i=n.textureLoader(s);n.assets[t]=i,n.toLoad--,n.loaded++,e&&e(t,s)},s.onerror=function(){n.errors[t]="Couldn't load image "+t,n.toLoad--,n.loaded++,i&&i(t,"Couldn't load image "+t)},s.src=t},e.prototype.loadTextureData=function(t,e,i,n){var s=this;void 0===i&&(i=null),void 0===n&&(n=null),t=this.pathPrefix+t,this.toLoad++;var r=new Image;r.onload=function(){var e=s.textureLoader(r);s.assets[t]=e,s.toLoad--,s.loaded++,i&&i(t,r)},r.onerror=function(){s.errors[t]="Couldn't load image "+t,s.toLoad--,s.loaded++,n&&n(t,"Couldn't load image "+t)},r.src=e},e.prototype.loadTextureAtlas=function(i,n,s){var r=this;void 0===n&&(n=null),void 0===s&&(s=null);var o=i.lastIndexOf("/")>=0?i.substring(0,i.lastIndexOf("/")):"";i=this.pathPrefix+i,this.toLoad++,e.downloadText(i,(function(e){var a={count:0},c=new Array;try{new t.TextureAtlas(e,(function(e){c.push(o+"/"+e);var i=document.createElement("img");return i.width=16,i.height=16,new t.FakeTexture(i)}))}catch(t){var l=t;return r.errors[i]="Couldn't load texture atlas "+i+": "+l.message,s&&s(i,"Couldn't load texture atlas "+i+": "+l.message),r.toLoad--,void r.loaded++}for(var h=function(l){var h=!1;r.loadTexture(l,(function(l){if(a.count++,a.count==c.length)if(h)r.errors[i]="Couldn't load texture atlas page "+l+"} of atlas "+i,s&&s(i,"Couldn't load texture atlas page "+l+" of atlas "+i),r.toLoad--,r.loaded++;else try{var _=new t.TextureAtlas(e,(function(t){return r.get(o+"/"+t)}));r.assets[i]=_,n&&n(i,_),r.toLoad--,r.loaded++}catch(t){var u=t;r.errors[i]="Couldn't load texture atlas "+i+": "+u.message,s&&s(i,"Couldn't load texture atlas "+i+": "+u.message),r.toLoad--,r.loaded++}}),(function(t){h=!0,a.count++,a.count==c.length&&(r.errors[i]="Couldn't load texture atlas page "+t+"} of atlas "+i,s&&s(i,"Couldn't load texture atlas page "+t+" of atlas "+i),r.toLoad--,r.loaded++)}))},_=0,u=c;_<u.length;_++)h(u[_])}),(function(t,e){r.errors[i]="Couldn't load texture atlas "+i+": status "+status+", "+e,s&&s(i,"Couldn't load texture atlas "+i+": status "+status+", "+e),r.toLoad--,r.loaded++}))},e.prototype.get=function(t){return t=this.pathPrefix+t,this.assets[t]},e.prototype.remove=function(t){t=this.pathPrefix+t;var e=this.assets[t];e.dispose&&e.dispose(),this.assets[t]=null},e.prototype.removeAll=function(){for(var t in this.assets){var e=this.assets[t];e.dispose&&e.dispose()}this.assets={}},e.prototype.isLoadingComplete=function(){return 0==this.toLoad},e.prototype.getToLoad=function(){return this.toLoad},e.prototype.getLoaded=function(){return this.loaded},e.prototype.dispose=function(){this.removeAll()},e.prototype.hasErrors=function(){return Object.keys(this.errors).length>0},e.prototype.getErrors=function(){return this.errors},e}();t.AssetManager=e}(gnt||(gnt={})),function(t){var e=function(){function e(t){this.atlas=t}return e.prototype.newRegionAttachment=function(e,i,n){var s=this.atlas.findRegion(n);if(null==s)return null;s.renderObject=s;var r=new t.RegionAttachment(i);return r.setRegion(s),r},e.prototype.newMeshAttachment=function(e,i,n){var s=this.atlas.findRegion(n);if(null==s)return null;s.renderObject=s;var r=new t.MeshAttachment(i);return r.region=s,r},e.prototype.newBoundingBoxAttachment=function(e,i){return new t.BoundingBoxAttachment(i)},e.prototype.newPathAttachment=function(e,i){return new t.PathAttachment(i)},e.prototype.newPointAttachment=function(e,i){return new t.PointAttachment(i)},e.prototype.newClippingAttachment=function(e,i){return new t.ClippingAttachment(i)},e}();t.AtlasAttachmentLoader=e}(gnt||(gnt={})),function(t){var e;(e=t.BlendMode||(t.BlendMode={}))[e.Normal=0]="Normal",e[e.Additive=1]="Additive",e[e.Multiply=2]="Multiply",e[e.Screen=3]="Screen"}(gnt||(gnt={})),function(t){var e=function(){function e(t,e,i){if(this.children=new Array,this.x=0,this.y=0,this.rotation=0,this.scaleX=0,this.scaleY=0,this.shearX=0,this.shearY=0,this.ax=0,this.ay=0,this.arotation=0,this.ascaleX=0,this.ascaleY=0,this.ashearX=0,this.ashearY=0,this.appliedValid=!1,this.a=0,this.b=0,this.c=0,this.d=0,this.worldY=0,this.worldX=0,this.sorted=!1,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.skeleton=e,this.parent=i,this.setToSetupPose()}return e.prototype.isActive=function(){return this.active},e.prototype.update=function(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)},e.prototype.updateWorldTransform=function(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)},e.prototype.updateWorldTransformWith=function(e,i,n,s,r,o,a){this.ax=e,this.ay=i,this.arotation=n,this.ascaleX=s,this.ascaleY=r,this.ashearX=o,this.ashearY=a,this.appliedValid=!0;var c=this.parent;if(null==c){var l=this.skeleton,h=n+90+a,_=l.scaleX,u=l.scaleY;return this.a=t.MathUtils.cosDeg(n+o)*s*_,this.b=t.MathUtils.cosDeg(h)*r*_,this.c=t.MathUtils.sinDeg(n+o)*s*u,this.d=t.MathUtils.sinDeg(h)*r*u,this.worldX=e*_+l.x,void(this.worldY=i*u+l.y)}var d=c.a,m=c.b,p=c.c,f=c.d;switch(this.worldX=d*e+m*i+c.worldX,this.worldY=p*e+f*i+c.worldY,this.data.transformMode){case t.TransformMode.Normal:h=n+90+a;var g=t.MathUtils.cosDeg(n+o)*s,v=t.MathUtils.cosDeg(h)*r,y=t.MathUtils.sinDeg(n+o)*s,x=t.MathUtils.sinDeg(h)*r;return this.a=d*g+m*y,this.b=d*v+m*x,this.c=p*g+f*y,void(this.d=p*v+f*x);case t.TransformMode.OnlyTranslation:h=n+90+a,this.a=t.MathUtils.cosDeg(n+o)*s,this.b=t.MathUtils.cosDeg(h)*r,this.c=t.MathUtils.sinDeg(n+o)*s,this.d=t.MathUtils.sinDeg(h)*r;break;case t.TransformMode.NoRotationOrReflection:var S=0;(b=d*d+p*p)>1e-4?(m=p*(b=Math.abs(d*f-m*p)/b),f=d*b,S=Math.atan2(p,d)*t.MathUtils.radDeg):(d=0,p=0,S=90-Math.atan2(f,m)*t.MathUtils.radDeg);var C=n+o-S,A=n+a-S+90;g=t.MathUtils.cosDeg(C)*s,v=t.MathUtils.cosDeg(A)*r,y=t.MathUtils.sinDeg(C)*s,x=t.MathUtils.sinDeg(A)*r,this.a=d*g-m*y,this.b=d*v-m*x,this.c=p*g+f*y,this.d=p*v+f*x;break;case t.TransformMode.NoScale:case t.TransformMode.NoScaleOrReflection:var b,T=t.MathUtils.cosDeg(n),E=t.MathUtils.sinDeg(n),P=(d*T+m*E)/this.skeleton.scaleX,w=(p*T+f*E)/this.skeleton.scaleY;(b=Math.sqrt(P*P+w*w))>1e-5&&(b=1/b),P*=b,w*=b,b=Math.sqrt(P*P+w*w),this.data.transformMode==t.TransformMode.NoScale&&d*f-m*p<0!=(this.skeleton.scaleX<0!=this.skeleton.scaleY<0)&&(b=-b);var I=Math.PI/2+Math.atan2(w,P),R=Math.cos(I)*b,D=Math.sin(I)*b;g=t.MathUtils.cosDeg(o)*s,v=t.MathUtils.cosDeg(90+a)*r,y=t.MathUtils.sinDeg(o)*s,x=t.MathUtils.sinDeg(90+a)*r,this.a=P*g+R*y,this.b=P*v+R*x,this.c=w*g+D*y,this.d=w*v+D*x}this.a*=this.skeleton.scaleX,this.b*=this.skeleton.scaleX,this.c*=this.skeleton.scaleY,this.d*=this.skeleton.scaleY},e.prototype.setToSetupPose=function(){var t=this.data;this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.shearX=t.shearX,this.shearY=t.shearY},e.prototype.getWorldRotationX=function(){return Math.atan2(this.c,this.a)*t.MathUtils.radDeg},e.prototype.getWorldRotationY=function(){return Math.atan2(this.d,this.b)*t.MathUtils.radDeg},e.prototype.getWorldScaleX=function(){return Math.sqrt(this.a*this.a+this.c*this.c)},e.prototype.getWorldScaleY=function(){return Math.sqrt(this.b*this.b+this.d*this.d)},e.prototype.updateAppliedTransform=function(){this.appliedValid=!0;var e=this.parent;if(null==e)return this.ax=this.worldX,this.ay=this.worldY,this.arotation=Math.atan2(this.c,this.a)*t.MathUtils.radDeg,this.ascaleX=Math.sqrt(this.a*this.a+this.c*this.c),this.ascaleY=Math.sqrt(this.b*this.b+this.d*this.d),this.ashearX=0,void(this.ashearY=Math.atan2(this.a*this.b+this.c*this.d,this.a*this.d-this.b*this.c)*t.MathUtils.radDeg);var i=e.a,n=e.b,s=e.c,r=e.d,o=1/(i*r-n*s),a=this.worldX-e.worldX,c=this.worldY-e.worldY;this.ax=a*r*o-c*n*o,this.ay=c*i*o-a*s*o;var l=o*r,h=o*i,_=o*n,u=o*s,d=l*this.a-_*this.c,m=l*this.b-_*this.d,p=h*this.c-u*this.a,f=h*this.d-u*this.b;if(this.ashearX=0,this.ascaleX=Math.sqrt(d*d+p*p),this.ascaleX>1e-4){var g=d*f-m*p;this.ascaleY=g/this.ascaleX,this.ashearY=Math.atan2(d*m+p*f,g)*t.MathUtils.radDeg,this.arotation=Math.atan2(p,d)*t.MathUtils.radDeg}else this.ascaleX=0,this.ascaleY=Math.sqrt(m*m+f*f),this.ashearY=0,this.arotation=90-Math.atan2(f,m)*t.MathUtils.radDeg},e.prototype.worldToLocal=function(t){var e=this.a,i=this.b,n=this.c,s=this.d,r=1/(e*s-i*n),o=t.x-this.worldX,a=t.y-this.worldY;return t.x=o*s*r-a*i*r,t.y=a*e*r-o*n*r,t},e.prototype.localToWorld=function(t){var e=t.x,i=t.y;return t.x=e*this.a+i*this.b+this.worldX,t.y=e*this.c+i*this.d+this.worldY,t},e.prototype.worldToLocalRotation=function(e){var i=t.MathUtils.sinDeg(e),n=t.MathUtils.cosDeg(e);return Math.atan2(this.a*i-this.c*n,this.d*n-this.b*i)*t.MathUtils.radDeg+this.rotation-this.shearX},e.prototype.localToWorldRotation=function(e){e-=this.rotation-this.shearX;var i=t.MathUtils.sinDeg(e),n=t.MathUtils.cosDeg(e);return Math.atan2(n*this.c+i*this.d,n*this.a+i*this.b)*t.MathUtils.radDeg},e.prototype.rotateWorld=function(e){var i=this.a,n=this.b,s=this.c,r=this.d,o=t.MathUtils.cosDeg(e),a=t.MathUtils.sinDeg(e);this.a=o*i-a*s,this.b=o*n-a*r,this.c=a*i+o*s,this.d=a*n+o*r,this.appliedValid=!1},e}();t.Bone=e}(gnt||(gnt={})),function(t){var e;t.BoneData=function(i,n,s){if(this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.shearX=0,this.shearY=0,this.transformMode=e.Normal,this.skinRequired=!1,this.color=new t.Color,i<0)throw new Error("index must be >= 0.");if(null==n)throw new Error("name cannot be null.");this.index=i,this.name=n,this.parent=s},function(t){t[t.Normal=0]="Normal",t[t.OnlyTranslation=1]="OnlyTranslation",t[t.NoRotationOrReflection=2]="NoRotationOrReflection",t[t.NoScale=3]="NoScale",t[t.NoScaleOrReflection=4]="NoScaleOrReflection"}(e=t.TransformMode||(t.TransformMode={}))}(gnt||(gnt={})),function(t){t.ConstraintData=function(t,e,i){this.name=t,this.order=e,this.skinRequired=i}}(gnt||(gnt={})),function(t){t.Event=function(t,e){if(null==e)throw new Error("data cannot be null.");this.time=t,this.data=e}}(gnt||(gnt={})),function(t){t.EventData=function(t){this.name=t}}(gnt||(gnt={})),function(t){var e=function(){function e(t,e){if(this.bendDirection=0,this.compress=!1,this.stretch=!1,this.mix=1,this.softness=0,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.mix=t.mix,this.softness=t.softness,this.bendDirection=t.bendDirection,this.compress=t.compress,this.stretch=t.stretch,this.bones=new Array;for(var i=0;i<t.bones.length;i++)this.bones.push(e.findBone(t.bones[i].name));this.target=e.findBone(t.target.name)}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){var t=this.target,e=this.bones;switch(e.length){case 1:this.apply1(e[0],t.worldX,t.worldY,this.compress,this.stretch,this.data.uniform,this.mix);break;case 2:this.apply2(e[0],e[1],t.worldX,t.worldY,this.bendDirection,this.stretch,this.softness,this.mix)}},e.prototype.apply1=function(e,i,n,s,r,o,a){e.appliedValid||e.updateAppliedTransform();var c=e.parent,l=1/(c.a*c.d-c.b*c.c),h=i-c.worldX,_=n-c.worldY,u=(h*c.d-_*c.b)*l-e.ax,d=(_*c.a-h*c.c)*l-e.ay,m=Math.atan2(d,u)*t.MathUtils.radDeg-e.ashearX-e.arotation;e.ascaleX<0&&(m+=180),m>180?m-=360:m<-180&&(m+=360);var p=e.ascaleX,f=e.ascaleY;if(s||r){var g=e.data.length*p,v=Math.sqrt(u*u+d*d);if(s&&v<g||r&&v>g&&g>1e-4){var y=(v/g-1)*a+1;p*=y,o&&(f*=y)}}e.updateWorldTransformWith(e.ax,e.ay,e.arotation+m*a,p,f,e.ashearX,e.ashearY)},e.prototype.apply2=function(e,i,n,s,r,o,a,c){if(0!=c){e.appliedValid||e.updateAppliedTransform(),i.appliedValid||i.updateAppliedTransform();var l=e.ax,h=e.ay,_=e.ascaleX,u=_,d=e.ascaleY,m=i.ascaleX,p=0,f=0,g=0;_<0?(_=-_,p=180,g=-1):(p=0,g=1),d<0&&(d=-d,g=-g),m<0?(m=-m,f=180):f=0;var v=i.ax,y=0,x=0,S=0,C=e.a,A=e.b,b=e.c,T=e.d,E=Math.abs(_-d)<=1e-4;E?(x=C*v+A*(y=i.ay)+e.worldX,S=b*v+T*y+e.worldY):(y=0,x=C*v+e.worldX,S=b*v+e.worldY);var P=e.parent;C=P.a,A=P.b,b=P.c;var w,I,R=1/(C*(T=P.d)-A*b),D=x-P.worldX,M=S-P.worldY,O=(D*T-M*A)*R-l,B=(M*C-D*b)*R-h,N=Math.sqrt(O*O+B*B),L=i.data.length*m;if(N<1e-4)return this.apply1(e,n,s,!1,o,!1,c),void i.updateWorldTransformWith(v,y,0,i.ascaleX,i.ascaleY,i.ashearX,i.ashearY);var F=((D=n-P.worldX)*T-(M=s-P.worldY)*A)*R-l,z=(M*C-D*b)*R-h,V=F*F+z*z;if(0!=a){a*=_*(m+1)/2;var G=Math.sqrt(V),U=G-N-L*_+a;if(U>0){var k=Math.min(1,U/(2*a))-1;V=(F-=(k=(U-a*(1-k*k))/G)*F)*F+(z-=k*z)*z}}t:if(E){var H=(V-N*N-(L*=_)*L)/(2*N*L);H<-1?H=-1:H>1&&(H=1,o&&(u*=(Math.sqrt(V)/(N+L)-1)*c+1)),I=Math.acos(H)*r,C=N+L*H,A=L*Math.sin(I),w=Math.atan2(z*C-F*A,F*C+z*A)}else{var j=(C=_*L)*C,W=(A=d*L)*A,q=Math.atan2(z,F),X=-2*W*N,Y=W-j;if((T=X*X-4*Y*(b=W*N*N+j*V-j*W))>=0){var K=Math.sqrt(T);X<0&&(K=-K);var J=(K=-(X+K)/2)/Y,$=b/K,Z=Math.abs(J)<Math.abs($)?J:$;if(Z*Z<=V){M=Math.sqrt(V-Z*Z)*r,w=q-Math.atan2(M,Z),I=Math.atan2(M/d,(Z-N)/_);break t}}var Q=t.MathUtils.PI,tt=N-C,et=tt*tt,it=0,nt=0,st=N+C,rt=st*st,ot=0;(b=-C*N/(j-W))>=-1&&b<=1&&(b=Math.acos(b),(T=(D=C*Math.cos(b)+N)*D+(M=A*Math.sin(b))*M)<et&&(Q=b,et=T,tt=D,it=M),T>rt&&(nt=b,rt=T,st=D,ot=M)),V<=(et+rt)/2?(w=q-Math.atan2(it*r,tt),I=Q*r):(w=q-Math.atan2(ot*r,st),I=nt*r)}var at=Math.atan2(y,v)*g,ct=e.arotation;(w=(w-at)*t.MathUtils.radDeg+p-ct)>180?w-=360:w<-180&&(w+=360),e.updateWorldTransformWith(l,h,ct+w*c,u,e.ascaleY,0,0),ct=i.arotation,(I=((I+at)*t.MathUtils.radDeg-i.ashearX)*g+f-ct)>180?I-=360:I<-180&&(I+=360),i.updateWorldTransformWith(v,y,ct+I*c,i.ascaleX,i.ascaleY,i.ashearX,i.ashearY)}else i.updateWorldTransform()},e}();t.IkConstraint=e}(gnt||(gnt={})),function(t){var e=function(t){function e(e){var i=t.call(this,e,0,!1)||this;return i.bones=new Array,i.bendDirection=1,i.compress=!1,i.stretch=!1,i.uniform=!1,i.mix=1,i.softness=0,i}return vnt(e,t),e}(t.ConstraintData);t.IkConstraintData=e}(gnt||(gnt={})),function(t){var e=function(){function e(t,e){if(this.position=0,this.spacing=0,this.rotateMix=0,this.translateMix=0,this.spaces=new Array,this.positions=new Array,this.world=new Array,this.curves=new Array,this.lengths=new Array,this.segments=new Array,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.bones=new Array;for(var i=0,n=t.bones.length;i<n;i++)this.bones.push(e.findBone(t.bones[i].name));this.target=e.findSlot(t.target.name),this.position=t.position,this.spacing=t.spacing,this.rotateMix=t.rotateMix,this.translateMix=t.translateMix}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){var i=this.target.getAttachment();if(i instanceof t.PathAttachment){var n=this.rotateMix,s=this.translateMix,r=n>0;if(s>0||r){var o=this.data,a=o.spacingMode==t.SpacingMode.Percent,c=o.rotateMode,l=c==t.RotateMode.Tangent,h=c==t.RotateMode.ChainScale,_=this.bones.length,u=l?_:_+1,d=this.bones,m=t.Utils.setArraySize(this.spaces,u),p=null,f=this.spacing;if(h||!a){h&&(p=t.Utils.setArraySize(this.lengths,_));for(var g=o.spacingMode==t.SpacingMode.Length,v=0,y=u-1;v<y;){var x=(D=d[v]).data.length;if(x<e.epsilon)h&&(p[v]=0),m[++v]=0;else if(a){if(h){var S=x*D.a,C=x*D.c,A=Math.sqrt(S*S+C*C);p[v]=A}m[++v]=f}else{S=x*D.a,C=x*D.c;var b=Math.sqrt(S*S+C*C);h&&(p[v]=b),m[++v]=(g?x+f:f)*b/x}}}else for(v=1;v<u;v++)m[v]=f;var T=this.computeWorldPositions(i,u,l,o.positionMode==t.PositionMode.Percent,a),E=T[0],P=T[1],w=o.offsetRotation,I=!1;0==w?I=c==t.RotateMode.Chain:(I=!1,w*=(R=this.target.bone).a*R.d-R.b*R.c>0?t.MathUtils.degRad:-t.MathUtils.degRad),v=0;for(var R=3;v<_;v++,R+=3){var D;(D=d[v]).worldX+=(E-D.worldX)*s,D.worldY+=(P-D.worldY)*s;var M=(S=T[R])-E,O=(C=T[R+1])-P;if(h){var B=p[v];if(0!=B){var N=(Math.sqrt(M*M+O*O)/B-1)*n+1;D.a*=N,D.c*=N}}if(E=S,P=C,r){var L=D.a,F=D.b,z=D.c,V=D.d,G=0,U=0,k=0;if(G=l?T[R-1]:0==m[v+1]?T[R+2]:Math.atan2(O,M),G-=Math.atan2(z,L),I){U=Math.cos(G),k=Math.sin(G);var H=D.data.length;E+=(H*(U*L-k*z)-M)*n,P+=(H*(k*L+U*z)-O)*n}else G+=w;G>t.MathUtils.PI?G-=t.MathUtils.PI2:G<-t.MathUtils.PI&&(G+=t.MathUtils.PI2),G*=n,U=Math.cos(G),k=Math.sin(G),D.a=U*L-k*z,D.b=U*F-k*V,D.c=k*L+U*z,D.d=k*F+U*V}D.appliedValid=!1}}}},e.prototype.computeWorldPositions=function(i,n,s,r,o){var a=this.target,c=this.position,l=this.spaces,h=t.Utils.setArraySize(this.positions,3*n+2),_=null,u=i.closed,d=i.worldVerticesLength,m=d/6,p=e.NONE;if(!i.constantSpeed){var f=i.lengths,g=f[m-=u?1:2];if(r&&(c*=g),o)for(var v=1;v<n;v++)l[v]*=g;_=t.Utils.setArraySize(this.world,8),v=0;for(var y=0,x=0;v<n;v++,y+=3){var S=c+=W=l[v];if(u)(S%=g)<0&&(S+=g),x=0;else{if(S<0){p!=e.BEFORE&&(p=e.BEFORE,i.computeWorldVertices(a,2,4,_,0,2)),this.addBeforePosition(S,_,0,h,y);continue}if(S>g){p!=e.AFTER&&(p=e.AFTER,i.computeWorldVertices(a,d-6,4,_,0,2)),this.addAfterPosition(S-g,_,0,h,y);continue}}for(;;x++){var C=f[x];if(!(S>C)){0==x?S/=C:S=(S-(K=f[x-1]))/(C-K);break}}x!=p&&(p=x,u&&x==m?(i.computeWorldVertices(a,d-4,4,_,0,2),i.computeWorldVertices(a,0,4,_,4,2)):i.computeWorldVertices(a,6*x+2,8,_,0,2)),this.addCurvePosition(S,_[0],_[1],_[2],_[3],_[4],_[5],_[6],_[7],h,y,s||v>0&&0==W)}return h}u?(d+=2,_=t.Utils.setArraySize(this.world,d),i.computeWorldVertices(a,2,d-4,_,0,2),i.computeWorldVertices(a,0,2,_,d-4,2),_[d-2]=_[0],_[d-1]=_[1]):(m--,d-=4,_=t.Utils.setArraySize(this.world,d),i.computeWorldVertices(a,2,d,_,0,2));for(var A=t.Utils.setArraySize(this.curves,m),b=0,T=_[0],E=_[1],P=0,w=0,I=0,R=0,D=0,M=0,O=0,B=0,N=0,L=0,F=0,z=0,V=0,G=0,U=(v=0,2);v<m;v++,U+=6)P=_[U],w=_[U+1],I=_[U+2],R=_[U+3],F=2*(O=.1875*(T-2*P+I))+(N=.09375*(3*(P-I)-T+(D=_[U+4]))),z=2*(B=.1875*(E-2*w+R))+(L=.09375*(3*(w-R)-E+(M=_[U+5]))),V=.75*(P-T)+O+.16666667*N,G=.75*(w-E)+B+.16666667*L,b+=Math.sqrt(V*V+G*G),V+=F,G+=z,F+=N,z+=L,b+=Math.sqrt(V*V+G*G),V+=F,G+=z,b+=Math.sqrt(V*V+G*G),V+=F+N,G+=z+L,b+=Math.sqrt(V*V+G*G),A[v]=b,T=D,E=M;if(c*=r?b:b/i.lengths[m-1],o)for(v=1;v<n;v++)l[v]*=b;for(var k=this.segments,H=0,j=(v=0,y=0,x=0,0);v<n;v++,y+=3){var W;if(S=c+=W=l[v],u)(S%=b)<0&&(S+=b),x=0;else{if(S<0){this.addBeforePosition(S,_,0,h,y);continue}if(S>b){this.addAfterPosition(S-b,_,d-4,h,y);continue}}for(;;x++){var q=A[x];if(!(S>q)){0==x?S/=q:S=(S-(K=A[x-1]))/(q-K);break}}if(x!=p){p=x;var X=6*x;for(T=_[X],E=_[X+1],P=_[X+2],w=_[X+3],I=_[X+4],R=_[X+5],F=2*(O=.03*(T-2*P+I))+(N=.006*(3*(P-I)-T+(D=_[X+6]))),z=2*(B=.03*(E-2*w+R))+(L=.006*(3*(w-R)-E+(M=_[X+7]))),V=.3*(P-T)+O+.16666667*N,G=.3*(w-E)+B+.16666667*L,H=Math.sqrt(V*V+G*G),k[0]=H,X=1;X<8;X++)V+=F,G+=z,F+=N,z+=L,H+=Math.sqrt(V*V+G*G),k[X]=H;V+=F,G+=z,H+=Math.sqrt(V*V+G*G),k[8]=H,V+=F+N,G+=z+L,H+=Math.sqrt(V*V+G*G),k[9]=H,j=0}for(S*=H;;j++){var Y=k[j];if(!(S>Y)){var K;0==j?S/=Y:S=j+(S-(K=k[j-1]))/(Y-K);break}}this.addCurvePosition(.1*S,T,E,P,w,I,R,D,M,h,y,s||v>0&&0==W)}return h},e.prototype.addBeforePosition=function(t,e,i,n,s){var r=e[i],o=e[i+1],a=e[i+2]-r,c=e[i+3]-o,l=Math.atan2(c,a);n[s]=r+t*Math.cos(l),n[s+1]=o+t*Math.sin(l),n[s+2]=l},e.prototype.addAfterPosition=function(t,e,i,n,s){var r=e[i+2],o=e[i+3],a=r-e[i],c=o-e[i+1],l=Math.atan2(c,a);n[s]=r+t*Math.cos(l),n[s+1]=o+t*Math.sin(l),n[s+2]=l},e.prototype.addCurvePosition=function(t,e,i,n,s,r,o,a,c,l,h,_){if(0==t||isNaN(t))return l[h]=e,l[h+1]=i,void(l[h+2]=Math.atan2(s-i,n-e));var u=t*t,d=u*t,m=1-t,p=m*m,f=p*m,g=m*t,v=3*g,y=m*v,x=v*t,S=e*f+n*y+r*x+a*d,C=i*f+s*y+o*x+c*d;l[h]=S,l[h+1]=C,_&&(l[h+2]=t<.001?Math.atan2(s-i,n-e):Math.atan2(C-(i*p+s*g*2+o*u),S-(e*p+n*g*2+r*u)))},e.NONE=-1,e.BEFORE=-2,e.AFTER=-3,e.epsilon=1e-5,e}();t.PathConstraint=e}(gnt||(gnt={})),function(t){var e,i,n,s=function(t){function e(e){var i=t.call(this,e,0,!1)||this;return i.bones=new Array,i}return vnt(e,t),e}(t.ConstraintData);t.PathConstraintData=s,(n=t.PositionMode||(t.PositionMode={}))[n.Fixed=0]="Fixed",n[n.Percent=1]="Percent",(i=t.SpacingMode||(t.SpacingMode={}))[i.Length=0]="Length",i[i.Fixed=1]="Fixed",i[i.Percent=2]="Percent",(e=t.RotateMode||(t.RotateMode={}))[e.Tangent=0]="Tangent",e[e.Chain=1]="Chain",e[e.ChainScale=2]="ChainScale"}(gnt||(gnt={})),function(t){var e=function(){function t(t){this.toLoad=new Array,this.assets={},this.clientId=t}return t.prototype.loaded=function(){var t=0;for(var e in this.assets)t++;return t},t}(),i=function(){function t(t){void 0===t&&(t=""),this.clientAssets={},this.queuedAssets={},this.rawAssets={},this.errors={},this.pathPrefix=t}return t.prototype.queueAsset=function(t,i,n){var s=this.clientAssets[t];return null==s&&(s=new e(t),this.clientAssets[t]=s),null!==i&&(s.textureLoader=i),s.toLoad.push(n),this.queuedAssets[n]!==n&&(this.queuedAssets[n]=n,!0)},t.prototype.loadText=function(t,e){var i=this;if(e=this.pathPrefix+e,this.queueAsset(t,null,e)){var n=new XMLHttpRequest;n.onreadystatechange=function(){n.readyState==XMLHttpRequest.DONE&&(n.status>=200&&n.status<300?i.rawAssets[e]=n.responseText:i.errors[e]="Couldn't load text "+e+": status "+n.status+", "+n.responseText)},n.open("GET",e,!0),n.send()}},t.prototype.loadJson=function(t,e){var i=this;if(e=this.pathPrefix+e,this.queueAsset(t,null,e)){var n=new XMLHttpRequest;n.onreadystatechange=function(){n.readyState==XMLHttpRequest.DONE&&(n.status>=200&&n.status<300?i.rawAssets[e]=JSON.parse(n.responseText):i.errors[e]="Couldn't load text "+e+": status "+n.status+", "+n.responseText)},n.open("GET",e,!0),n.send()}},t.prototype.loadTexture=function(t,e,i){var n=this;if(i=this.pathPrefix+i,this.queueAsset(t,e,i)){var s=new Image;s.src=i,s.crossOrigin="anonymous",s.onload=function(){n.rawAssets[i]=s},s.onerror=function(){n.errors[i]="Couldn't load image "+i}}},t.prototype.get=function(t,e){e=this.pathPrefix+e;var i=this.clientAssets[t];return null==i||i.assets[e]},t.prototype.updateClientAssets=function(t){for(var e=0;e<t.toLoad.length;e++){var i=t.toLoad[e];if(null==t.assets[i]){var n=this.rawAssets[i];if(null==n)continue;n instanceof HTMLImageElement?t.assets[i]=t.textureLoader(n):t.assets[i]=n}}},t.prototype.isLoadingComplete=function(t){var e=this.clientAssets[t];return null==e||(this.updateClientAssets(e),e.toLoad.length==e.loaded())},t.prototype.dispose=function(){},t.prototype.hasErrors=function(){return Object.keys(this.errors).length>0},t.prototype.getErrors=function(){return this.errors},t}();t.SharedAssetManager=i}(gnt||(gnt={})),function(t){var e=function(){function e(e){if(this._updateCache=new Array,this.updateCacheReset=new Array,this.time=0,this.scaleX=1,this.scaleY=1,this.x=0,this.y=0,null==e)throw new Error("data cannot be null.");this.data=e,this.bones=new Array;for(var i=0;i<e.bones.length;i++){var n=e.bones[i],s=void 0;if(null==n.parent)s=new t.Bone(n,this,null);else{var r=this.bones[n.parent.index];s=new t.Bone(n,this,r),r.children.push(s)}this.bones.push(s)}for(this.slots=new Array,this.drawOrder=new Array,i=0;i<e.slots.length;i++){var o=e.slots[i],a=(s=this.bones[o.boneData.index],new t.Slot(o,s));this.slots.push(a),this.drawOrder.push(a)}for(this.ikConstraints=new Array,i=0;i<e.ikConstraints.length;i++){var c=e.ikConstraints[i];this.ikConstraints.push(new t.IkConstraint(c,this))}for(this.transformConstraints=new Array,i=0;i<e.transformConstraints.length;i++){var l=e.transformConstraints[i];this.transformConstraints.push(new t.TransformConstraint(l,this))}for(this.pathConstraints=new Array,i=0;i<e.pathConstraints.length;i++){var h=e.pathConstraints[i];this.pathConstraints.push(new t.PathConstraint(h,this))}this.color=new t.Color(1,1,1,1),this.updateCache()}return e.prototype.updateCache=function(){this._updateCache.length=0,this.updateCacheReset.length=0;for(var t=this.bones,e=0,i=t.length;e<i;e++)(s=t[e]).sorted=s.data.skinRequired,s.active=!s.sorted;if(null!=this.skin){var n=this.skin.bones;for(e=0,i=this.skin.bones.length;e<i;e++){var s=this.bones[n[e].index];do{s.sorted=!1,s.active=!0,s=s.parent}while(null!=s)}}var r=this.ikConstraints,o=this.transformConstraints,a=this.pathConstraints,c=r.length,l=o.length,h=a.length,_=c+l+h;t:for(e=0;e<_;e++){for(var u=0;u<c;u++)if((d=r[u]).data.order==e){this.sortIkConstraint(d);continue t}for(u=0;u<l;u++)if((d=o[u]).data.order==e){this.sortTransformConstraint(d);continue t}for(u=0;u<h;u++){var d;if((d=a[u]).data.order==e){this.sortPathConstraint(d);continue t}}}for(e=0,i=t.length;e<i;e++)this.sortBone(t[e])},e.prototype.sortIkConstraint=function(e){if(e.active=e.target.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){var i=e.target;this.sortBone(i);var n=e.bones,s=n[0];if(this.sortBone(s),n.length>1){var r=n[n.length-1];this._updateCache.indexOf(r)>-1||this.updateCacheReset.push(r)}this._updateCache.push(e),this.sortReset(s.children),n[n.length-1].sorted=!0}},e.prototype.sortPathConstraint=function(e){if(e.active=e.target.bone.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){var i=e.target,n=i.data.index,s=i.bone;null!=this.skin&&this.sortPathConstraintAttachment(this.skin,n,s),null!=this.data.defaultSkin&&this.data.defaultSkin!=this.skin&&this.sortPathConstraintAttachment(this.data.defaultSkin,n,s);for(var r=0,o=this.data.skins.length;r<o;r++)this.sortPathConstraintAttachment(this.data.skins[r],n,s);var a=i.getAttachment();a instanceof t.PathAttachment&&this.sortPathConstraintAttachmentWith(a,s);var c=e.bones,l=c.length;for(r=0;r<l;r++)this.sortBone(c[r]);for(this._updateCache.push(e),r=0;r<l;r++)this.sortReset(c[r].children);for(r=0;r<l;r++)c[r].sorted=!0}},e.prototype.sortTransformConstraint=function(e){if(e.active=e.target.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){this.sortBone(e.target);var i=e.bones,n=i.length;if(e.data.local)for(var s=0;s<n;s++){var r=i[s];this.sortBone(r.parent),this._updateCache.indexOf(r)>-1||this.updateCacheReset.push(r)}else for(s=0;s<n;s++)this.sortBone(i[s]);this._updateCache.push(e);for(var o=0;o<n;o++)this.sortReset(i[o].children);for(o=0;o<n;o++)i[o].sorted=!0}},e.prototype.sortPathConstraintAttachment=function(t,e,i){var n=t.attachments[e];if(n)for(var s in n)this.sortPathConstraintAttachmentWith(n[s],i)},e.prototype.sortPathConstraintAttachmentWith=function(e,i){if(e instanceof t.PathAttachment){var n=e.bones;if(null==n)this.sortBone(i);else for(var s=this.bones,r=0;r<n.length;)for(var o=n[r++],a=r+o;r<a;r++){var c=n[r];this.sortBone(s[c])}}},e.prototype.sortBone=function(t){if(!t.sorted){var e=t.parent;null!=e&&this.sortBone(e),t.sorted=!0,this._updateCache.push(t)}},e.prototype.sortReset=function(t){for(var e=0,i=t.length;e<i;e++){var n=t[e];n.active&&(n.sorted&&this.sortReset(n.children),n.sorted=!1)}},e.prototype.updateWorldTransform=function(){for(var t=this.updateCacheReset,e=0,i=t.length;e<i;e++){var n=t[e];n.ax=n.x,n.ay=n.y,n.arotation=n.rotation,n.ascaleX=n.scaleX,n.ascaleY=n.scaleY,n.ashearX=n.shearX,n.ashearY=n.shearY,n.appliedValid=!0}var s=this._updateCache;for(e=0,i=s.length;e<i;e++)s[e].update()},e.prototype.setToSetupPose=function(){this.setBonesToSetupPose(),this.setSlotsToSetupPose()},e.prototype.setBonesToSetupPose=function(){for(var t=this.bones,e=0,i=t.length;e<i;e++)t[e].setToSetupPose();var n=this.ikConstraints;for(e=0,i=n.length;e<i;e++)(a=n[e]).mix=a.data.mix,a.softness=a.data.softness,a.bendDirection=a.data.bendDirection,a.compress=a.data.compress,a.stretch=a.data.stretch;var s=this.transformConstraints;for(e=0,i=s.length;e<i;e++){var r=(a=s[e]).data;a.rotateMix=r.rotateMix,a.translateMix=r.translateMix,a.scaleMix=r.scaleMix,a.shearMix=r.shearMix}var o=this.pathConstraints;for(e=0,i=o.length;e<i;e++){var a;r=(a=o[e]).data,a.position=r.position,a.spacing=r.spacing,a.rotateMix=r.rotateMix,a.translateMix=r.translateMix}},e.prototype.setSlotsToSetupPose=function(){var e=this.slots;t.Utils.arrayCopy(e,0,this.drawOrder,0,e.length);for(var i=0,n=e.length;i<n;i++)e[i].setToSetupPose()},e.prototype.getRootBone=function(){return 0==this.bones.length?null:this.bones[0]},e.prototype.findBone=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.findBoneIndex=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,i=0,n=e.length;i<n;i++)if(e[i].data.name==t)return i;return-1},e.prototype.findSlot=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.findSlotIndex=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,i=0,n=e.length;i<n;i++)if(e[i].data.name==t)return i;return-1},e.prototype.setSkinByName=function(t){var e=this.data.findSkin(t);if(null==e)throw new Error("Skin not found: "+t);this.setSkin(e)},e.prototype.setSkin=function(t){if(t!=this.skin){if(null!=t)if(null!=this.skin)t.attachAll(this,this.skin);else for(var e=this.slots,i=0,n=e.length;i<n;i++){var s=e[i],r=s.data.attachmentName;if(null!=r){var o=t.getAttachment(i,r);null!=o&&s.setAttachment(o)}}this.skin=t,this.updateCache()}},e.prototype.getAttachmentByName=function(t,e){return this.getAttachment(this.data.findSlotIndex(t),e)},e.prototype.getAttachment=function(t,e){if(null==e)throw new Error("attachmentName cannot be null.");if(null!=this.skin){var i=this.skin.getAttachment(t,e);if(null!=i)return i}return null!=this.data.defaultSkin?this.data.defaultSkin.getAttachment(t,e):null},e.prototype.setAttachment=function(t,e){if(null==t)throw new Error("slotName cannot be null.");for(var i=this.slots,n=0,s=i.length;n<s;n++){var r=i[n];if(r.data.name==t){var o=null;if(null!=e&&null==(o=this.getAttachment(n,e)))throw new Error("Attachment not found: "+e+", for slot: "+t);return void r.setAttachment(o)}}throw new Error("Slot not found: "+t)},e.prototype.findIkConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.ikConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.findTransformConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.transformConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.findPathConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.pathConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.getBounds=function(e,i,n){if(void 0===n&&(n=new Array(2)),null==e)throw new Error("offset cannot be null.");if(null==i)throw new Error("size cannot be null.");for(var s=this.drawOrder,r=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,l=0,h=s.length;l<h;l++){var _=s[l];if(_.bone.active){var u=0,d=null,m=_.getAttachment();if(m instanceof t.RegionAttachment)u=8,d=t.Utils.setArraySize(n,u,0),m.computeWorldVertices(_.bone,d,0,2);else if(m instanceof t.MeshAttachment){var p=m;u=p.worldVerticesLength,d=t.Utils.setArraySize(n,u,0),p.computeWorldVertices(_,0,u,d,0,2)}if(null!=d)for(var f=0,g=d.length;f<g;f+=2){var v=d[f],y=d[f+1];r=Math.min(r,v),o=Math.min(o,y),a=Math.max(a,v),c=Math.max(c,y)}}}e.set(r,o),i.set(a-r,c-o)},e.prototype.update=function(t){this.time+=t},e}();t.Skeleton=e}(gnt||(gnt={})),function(t){var e=function(){function e(t){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=t}return e.prototype.readSkeletonData=function(n){var s=this.scale,r=new t.SkeletonData;r.name="";var o=new i(n);r.hash=o.readString(),r.version=o.readString(),r.x=o.readFloat(),r.y=o.readFloat(),r.width=o.readFloat(),r.height=o.readFloat();var a=o.readBoolean();a&&(r.fps=o.readFloat(),r.imagesPath=o.readString(),r.audioPath=o.readString());var c=0;c=o.readInt(!0);for(var l=0;l<c;l++)o.strings.push(o.readString());for(c=o.readInt(!0),l=0;l<c;l++){var h=o.readString(),_=0==l?null:r.bones[o.readInt(!0)];(m=new t.BoneData(l,h,_)).rotation=o.readFloat(),m.x=o.readFloat()*s,m.y=o.readFloat()*s,m.scaleX=o.readFloat(),m.scaleY=o.readFloat(),m.shearX=o.readFloat(),m.shearY=o.readFloat(),m.length=o.readFloat()*s,m.transformMode=e.TransformModeValues[o.readInt(!0)],m.skinRequired=o.readBoolean(),a&&t.Color.rgba8888ToColor(m.color,o.readInt32()),r.bones.push(m)}for(c=o.readInt(!0),l=0;l<c;l++){var u=o.readString(),d=r.bones[o.readInt(!0)],m=new t.SlotData(l,u,d);t.Color.rgba8888ToColor(m.color,o.readInt32());var p=o.readInt32();-1!=p&&t.Color.rgb888ToColor(m.darkColor=new t.Color,p),m.attachmentName=o.readStringRef(),m.blendMode=e.BlendModeValues[o.readInt(!0)],r.slots.push(m)}c=o.readInt(!0),l=0;for(var f=void 0;l<c;l++){(m=new t.IkConstraintData(o.readString())).order=o.readInt(!0),m.skinRequired=o.readBoolean(),f=o.readInt(!0);for(var g=0;g<f;g++)m.bones.push(r.bones[o.readInt(!0)]);m.target=r.bones[o.readInt(!0)],m.mix=o.readFloat(),m.softness=o.readFloat()*s,m.bendDirection=o.readByte(),m.compress=o.readBoolean(),m.stretch=o.readBoolean(),m.uniform=o.readBoolean(),r.ikConstraints.push(m)}for(c=o.readInt(!0),l=0,f=void 0;l<c;l++){for((m=new t.TransformConstraintData(o.readString())).order=o.readInt(!0),m.skinRequired=o.readBoolean(),f=o.readInt(!0),g=0;g<f;g++)m.bones.push(r.bones[o.readInt(!0)]);m.target=r.bones[o.readInt(!0)],m.local=o.readBoolean(),m.relative=o.readBoolean(),m.offsetRotation=o.readFloat(),m.offsetX=o.readFloat()*s,m.offsetY=o.readFloat()*s,m.offsetScaleX=o.readFloat(),m.offsetScaleY=o.readFloat(),m.offsetShearY=o.readFloat(),m.rotateMix=o.readFloat(),m.translateMix=o.readFloat(),m.scaleMix=o.readFloat(),m.shearMix=o.readFloat(),r.transformConstraints.push(m)}for(c=o.readInt(!0),l=0,f=void 0;l<c;l++){for((m=new t.PathConstraintData(o.readString())).order=o.readInt(!0),m.skinRequired=o.readBoolean(),f=o.readInt(!0),g=0;g<f;g++)m.bones.push(r.bones[o.readInt(!0)]);m.target=r.slots[o.readInt(!0)],m.positionMode=e.PositionModeValues[o.readInt(!0)],m.spacingMode=e.SpacingModeValues[o.readInt(!0)],m.rotateMode=e.RotateModeValues[o.readInt(!0)],m.offsetRotation=o.readFloat(),m.position=o.readFloat(),m.positionMode==t.PositionMode.Fixed&&(m.position*=s),m.spacing=o.readFloat(),m.spacingMode!=t.SpacingMode.Length&&m.spacingMode!=t.SpacingMode.Fixed||(m.spacing*=s),m.rotateMix=o.readFloat(),m.translateMix=o.readFloat(),r.pathConstraints.push(m)}var v=this.readSkin(o,r,!0,a);for(null!=v&&(r.defaultSkin=v,r.skins.push(v)),l=r.skins.length,t.Utils.setArraySize(r.skins,c=l+o.readInt(!0));l<c;l++)r.skins[l]=this.readSkin(o,r,!1,a);for(c=this.linkedMeshes.length,l=0;l<c;l++){var y=this.linkedMeshes[l],x=null==y.skin?r.defaultSkin:r.findSkin(y.skin);if(null==x)throw new Error("Skin not found: "+y.skin);var S=x.getAttachment(y.slotIndex,y.parent);if(null==S)throw new Error("Parent mesh not found: "+y.parent);y.mesh.deformAttachment=y.inheritDeform?S:y.mesh,y.mesh.setParentMesh(S),y.mesh.updateUVs()}for(this.linkedMeshes.length=0,c=o.readInt(!0),l=0;l<c;l++)(m=new t.EventData(o.readStringRef())).intValue=o.readInt(!1),m.floatValue=o.readFloat(),m.stringValue=o.readString(),m.audioPath=o.readString(),null!=m.audioPath&&(m.volume=o.readFloat(),m.balance=o.readFloat()),r.events.push(m);for(c=o.readInt(!0),l=0;l<c;l++)r.animations.push(this.readAnimation(o,o.readString(),r));return r},e.prototype.readSkin=function(e,i,n,s){var r=null,o=0;if(n){if(0==(o=e.readInt(!0)))return null;r=new t.Skin("default")}else{(r=new t.Skin(e.readStringRef())).bones.length=e.readInt(!0);for(var a=0,c=r.bones.length;a<c;a++)r.bones[a]=i.bones[e.readInt(!0)];for(a=0,c=e.readInt(!0);a<c;a++)r.constraints.push(i.ikConstraints[e.readInt(!0)]);for(a=0,c=e.readInt(!0);a<c;a++)r.constraints.push(i.transformConstraints[e.readInt(!0)]);for(a=0,c=e.readInt(!0);a<c;a++)r.constraints.push(i.pathConstraints[e.readInt(!0)]);o=e.readInt(!0)}for(a=0;a<o;a++)for(var l=e.readInt(!0),h=0,_=e.readInt(!0);h<_;h++){var u=e.readStringRef(),d=this.readAttachment(e,i,r,l,u,s);null!=d&&r.setAttachment(l,u,d)}return r},e.prototype.readAttachment=function(i,s,r,o,a,c){var l=this.scale,h=i.readStringRef();null==h&&(h=a);var _=i.readByte();switch(e.AttachmentTypeValues[_]){case t.AttachmentType.Region:var u=i.readStringRef(),d=i.readFloat(),m=i.readFloat(),p=i.readFloat(),f=i.readFloat(),g=i.readFloat(),v=i.readFloat(),y=i.readFloat(),x=i.readInt32();null==u&&(u=h);var S=this.attachmentLoader.newRegionAttachment(r,h,u);return null==S?null:(S.path=u,S.x=m*l,S.y=p*l,S.scaleX=f,S.scaleY=g,S.rotation=d,S.width=v*l,S.height=y*l,t.Color.rgba8888ToColor(S.color,x),S.updateOffset(),S);case t.AttachmentType.BoundingBox:var C=i.readInt(!0),A=this.readVertices(i,C),b=(x=c?i.readInt32():0,this.attachmentLoader.newBoundingBoxAttachment(r,h));return null==b?null:(b.worldVerticesLength=C<<1,b.vertices=A.vertices,b.bones=A.bones,c&&t.Color.rgba8888ToColor(b.color,x),b);case t.AttachmentType.Mesh:u=i.readStringRef(),x=i.readInt32(),C=i.readInt(!0);var T=this.readFloatArray(i,C<<1,1),E=this.readShortArray(i),P=(A=this.readVertices(i,C),i.readInt(!0)),w=null;return v=0,y=0,c&&(w=this.readShortArray(i),v=i.readFloat(),y=i.readFloat()),null==u&&(u=h),null==(I=this.attachmentLoader.newMeshAttachment(r,h,u))?null:(I.path=u,t.Color.rgba8888ToColor(I.color,x),I.bones=A.bones,I.vertices=A.vertices,I.worldVerticesLength=C<<1,I.triangles=E,I.regionUVs=T,I.updateUVs(),I.hullLength=P<<1,c&&(I.edges=w,I.width=v*l,I.height=y*l),I);case t.AttachmentType.LinkedMesh:u=i.readStringRef(),x=i.readInt32();var I,R=i.readStringRef(),D=i.readStringRef(),M=i.readBoolean();return v=0,y=0,c&&(v=i.readFloat(),y=i.readFloat()),null==u&&(u=h),null==(I=this.attachmentLoader.newMeshAttachment(r,h,u))?null:(I.path=u,t.Color.rgba8888ToColor(I.color,x),c&&(I.width=v*l,I.height=y*l),this.linkedMeshes.push(new n(I,R,o,D,M)),I);case t.AttachmentType.Path:for(var O=i.readBoolean(),B=i.readBoolean(),N=(C=i.readInt(!0),A=this.readVertices(i,C),t.Utils.newArray(C/3,0)),L=0,F=N.length;L<F;L++)N[L]=i.readFloat()*l;return x=c?i.readInt32():0,null==(u=this.attachmentLoader.newPathAttachment(r,h))?null:(u.closed=O,u.constantSpeed=B,u.worldVerticesLength=C<<1,u.vertices=A.vertices,u.bones=A.bones,u.lengths=N,c&&t.Color.rgba8888ToColor(u.color,x),u);case t.AttachmentType.Point:d=i.readFloat(),m=i.readFloat(),p=i.readFloat(),x=c?i.readInt32():0;var z=this.attachmentLoader.newPointAttachment(r,h);return null==z?null:(z.x=m*l,z.y=p*l,z.rotation=d,c&&t.Color.rgba8888ToColor(z.color,x),z);case t.AttachmentType.Clipping:var V=i.readInt(!0),G=(C=i.readInt(!0),A=this.readVertices(i,C),x=c?i.readInt32():0,this.attachmentLoader.newClippingAttachment(r,h));return null==G?null:(G.endSlot=s.slots[V],G.worldVerticesLength=C<<1,G.vertices=A.vertices,G.bones=A.bones,c&&t.Color.rgba8888ToColor(G.color,x),G)}return null},e.prototype.readVertices=function(e,i){var n=i<<1,r=new s,o=this.scale;if(!e.readBoolean())return r.vertices=this.readFloatArray(e,n,o),r;for(var a=new Array,c=new Array,l=0;l<i;l++){var h=e.readInt(!0);c.push(h);for(var _=0;_<h;_++)c.push(e.readInt(!0)),a.push(e.readFloat()*o),a.push(e.readFloat()*o),a.push(e.readFloat())}return r.vertices=t.Utils.toFloatArray(a),r.bones=c,r},e.prototype.readFloatArray=function(t,e,i){var n=new Array(e);if(1==i)for(var s=0;s<e;s++)n[s]=t.readFloat();else for(s=0;s<e;s++)n[s]=t.readFloat()*i;return n},e.prototype.readShortArray=function(t){for(var e=t.readInt(!0),i=new Array(e),n=0;n<e;n++)i[n]=t.readShort();return i},e.prototype.readAnimation=function(i,n,s){for(var r=new Array,o=this.scale,a=0,c=new t.Color,l=new t.Color,h=0,_=i.readInt(!0);h<_;h++)for(var u=i.readInt(!0),d=0,m=i.readInt(!0);d<m;d++){var p=i.readByte(),f=i.readInt(!0);switch(p){case e.SLOT_ATTACHMENT:(x=new t.AttachmentTimeline(f)).slotIndex=u;for(var g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readStringRef());r.push(x),a=Math.max(a,x.frames[f-1]);break;case e.SLOT_COLOR:for((x=new t.ColorTimeline(f)).slotIndex=u,g=0;g<f;g++){var v=i.readFloat();t.Color.rgba8888ToColor(c,i.readInt32()),x.setFrame(g,v,c.r,c.g,c.b,c.a),g<f-1&&this.readCurve(i,g,x)}r.push(x),a=Math.max(a,x.frames[(f-1)*t.ColorTimeline.ENTRIES]);break;case e.SLOT_TWO_COLOR:for((x=new t.TwoColorTimeline(f)).slotIndex=u,g=0;g<f;g++)v=i.readFloat(),t.Color.rgba8888ToColor(c,i.readInt32()),t.Color.rgb888ToColor(l,i.readInt32()),x.setFrame(g,v,c.r,c.g,c.b,c.a,l.r,l.g,l.b),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.TwoColorTimeline.ENTRIES])}}for(h=0,_=i.readInt(!0);h<_;h++){var y=i.readInt(!0);for(d=0,m=i.readInt(!0);d<m;d++)switch(p=i.readByte(),f=i.readInt(!0),p){case e.BONE_ROTATE:for((x=new t.RotateTimeline(f)).boneIndex=y,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat()),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.RotateTimeline.ENTRIES]);break;case e.BONE_TRANSLATE:case e.BONE_SCALE:case e.BONE_SHEAR:var x=void 0,S=1;for(p==e.BONE_SCALE?x=new t.ScaleTimeline(f):p==e.BONE_SHEAR?x=new t.ShearTimeline(f):(x=new t.TranslateTimeline(f),S=o),x.boneIndex=y,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat()*S,i.readFloat()*S),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.TranslateTimeline.ENTRIES])}}for(h=0,_=i.readInt(!0);h<_;h++){var C=i.readInt(!0);for(f=i.readInt(!0),(x=new t.IkConstraintTimeline(f)).ikConstraintIndex=C,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat(),i.readFloat()*o,i.readByte(),i.readBoolean(),i.readBoolean()),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.IkConstraintTimeline.ENTRIES])}for(h=0,_=i.readInt(!0);h<_;h++){for(C=i.readInt(!0),f=i.readInt(!0),(x=new t.TransformConstraintTimeline(f)).transformConstraintIndex=C,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat(),i.readFloat(),i.readFloat(),i.readFloat()),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.TransformConstraintTimeline.ENTRIES])}for(h=0,_=i.readInt(!0);h<_;h++){C=i.readInt(!0);var A=s.pathConstraints[C];for(d=0,m=i.readInt(!0);d<m;d++)switch(p=i.readByte(),f=i.readInt(!0),p){case e.PATH_POSITION:case e.PATH_SPACING:for(x=void 0,S=1,p==e.PATH_SPACING?(x=new t.PathConstraintSpacingTimeline(f),A.spacingMode!=t.SpacingMode.Length&&A.spacingMode!=t.SpacingMode.Fixed||(S=o)):(x=new t.PathConstraintPositionTimeline(f),A.positionMode==t.PositionMode.Fixed&&(S=o)),x.pathConstraintIndex=C,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat()*S),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.PathConstraintPositionTimeline.ENTRIES]);break;case e.PATH_MIX:for((x=new t.PathConstraintMixTimeline(f)).pathConstraintIndex=C,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat(),i.readFloat()),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.PathConstraintMixTimeline.ENTRIES])}}for(h=0,_=i.readInt(!0);h<_;h++){var b=s.skins[i.readInt(!0)];for(d=0,m=i.readInt(!0);d<m;d++){u=i.readInt(!0);for(var T=0,E=i.readInt(!0);T<E;T++){var P=b.getAttachment(u,i.readStringRef()),w=null!=P.bones,I=P.vertices,R=w?I.length/3*2:I.length;for(f=i.readInt(!0),(x=new t.DeformTimeline(f)).slotIndex=u,x.attachment=P,g=0;g<f;g++){v=i.readFloat();var D=void 0,M=i.readInt(!0);if(0==M)D=w?t.Utils.newFloatArray(R):I;else{D=t.Utils.newFloatArray(R);var O=i.readInt(!0);if(M+=O,1==o)for(var B=O;B<M;B++)D[B]=i.readFloat();else for(B=O;B<M;B++)D[B]=i.readFloat()*o;if(!w){B=0;for(var N=D.length;B<N;B++)D[B]+=I[B]}}x.setFrame(g,v,D),g<f-1&&this.readCurve(i,g,x)}r.push(x),a=Math.max(a,x.frames[f-1])}}}var L=i.readInt(!0);if(L>0){x=new t.DrawOrderTimeline(L);var F=s.slots.length;for(h=0;h<L;h++){v=i.readFloat();var z=i.readInt(!0),V=t.Utils.newArray(F,0);for(d=F-1;d>=0;d--)V[d]=-1;var G=t.Utils.newArray(F-z,0),U=0,k=0;for(d=0;d<z;d++){for(u=i.readInt(!0);U!=u;)G[k++]=U++;V[U+i.readInt(!0)]=U++}for(;U<F;)G[k++]=U++;for(d=F-1;d>=0;d--)-1==V[d]&&(V[d]=G[--k]);x.setFrame(h,v,V)}r.push(x),a=Math.max(a,x.frames[L-1])}var H=i.readInt(!0);if(H>0){for(x=new t.EventTimeline(H),h=0;h<H;h++){v=i.readFloat();var j=s.events[i.readInt(!0)],W=new t.Event(v,j);W.intValue=i.readInt(!1),W.floatValue=i.readFloat(),W.stringValue=i.readBoolean()?i.readString():j.stringValue,null!=W.data.audioPath&&(W.volume=i.readFloat(),W.balance=i.readFloat()),x.setFrame(h,W)}r.push(x),a=Math.max(a,x.frames[H-1])}return new t.Animation(n,r,a)},e.prototype.readCurve=function(t,i,n){switch(t.readByte()){case e.CURVE_STEPPED:n.setStepped(i);break;case e.CURVE_BEZIER:this.setCurve(n,i,t.readFloat(),t.readFloat(),t.readFloat(),t.readFloat())}},e.prototype.setCurve=function(t,e,i,n,s,r){t.setCurve(e,i,n,s,r)},e.AttachmentTypeValues=[0,1,2,3,4,5,6],e.TransformModeValues=[t.TransformMode.Normal,t.TransformMode.OnlyTranslation,t.TransformMode.NoRotationOrReflection,t.TransformMode.NoScale,t.TransformMode.NoScaleOrReflection],e.PositionModeValues=[t.PositionMode.Fixed,t.PositionMode.Percent],e.SpacingModeValues=[t.SpacingMode.Length,t.SpacingMode.Fixed,t.SpacingMode.Percent],e.RotateModeValues=[t.RotateMode.Tangent,t.RotateMode.Chain,t.RotateMode.ChainScale],e.BlendModeValues=[t.BlendMode.Normal,t.BlendMode.Additive,t.BlendMode.Multiply,t.BlendMode.Screen],e.BONE_ROTATE=0,e.BONE_TRANSLATE=1,e.BONE_SCALE=2,e.BONE_SHEAR=3,e.SLOT_ATTACHMENT=0,e.SLOT_COLOR=1,e.SLOT_TWO_COLOR=2,e.PATH_POSITION=0,e.PATH_SPACING=1,e.PATH_MIX=2,e.CURVE_LINEAR=0,e.CURVE_STEPPED=1,e.CURVE_BEZIER=2,e}();t.SkeletonBinary=e;var i=function(){function t(t,e,i,n){void 0===e&&(e=new Array),void 0===i&&(i=0),void 0===n&&(n=new DataView(t.buffer)),this.strings=e,this.index=i,this.buffer=n}return t.prototype.readByte=function(){return this.buffer.getInt8(this.index++)},t.prototype.readShort=function(){var t=this.buffer.getInt16(this.index);return this.index+=2,t},t.prototype.readInt32=function(){var t=this.buffer.getInt32(this.index);return this.index+=4,t},t.prototype.readInt=function(t){var e=this.readByte(),i=127&e;return 0!=(128&e)&&(i|=(127&(e=this.readByte()))<<7,0!=(128&e)&&(i|=(127&(e=this.readByte()))<<14,0!=(128&e)&&(i|=(127&(e=this.readByte()))<<21,0!=(128&e)&&(i|=(127&(e=this.readByte()))<<28)))),t?i:i>>>1^-(1&i)},t.prototype.readStringRef=function(){var t=this.readInt(!0);return 0==t?null:this.strings[t-1]},t.prototype.readString=function(){var t=this.readInt(!0);switch(t){case 0:return null;case 1:return""}t--;for(var e="",i=0;i<t;){var n=this.readByte();switch(n>>4){case 12:case 13:e+=String.fromCharCode((31&n)<<6|63&this.readByte()),i+=2;break;case 14:e+=String.fromCharCode((15&n)<<12|(63&this.readByte())<<6|63&this.readByte()),i+=3;break;default:e+=String.fromCharCode(n),i++}}return e},t.prototype.readFloat=function(){var t=this.buffer.getFloat32(this.index);return this.index+=4,t},t.prototype.readBoolean=function(){return 0!=this.readByte()},t}(),n=function(t,e,i,n,s){this.mesh=t,this.skin=e,this.slotIndex=i,this.parent=n,this.inheritDeform=s},s=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.bones=t,this.vertices=e}}(gnt||(gnt={})),function(t){var e=function(){function e(){this.minX=0,this.minY=0,this.maxX=0,this.maxY=0,this.boundingBoxes=new Array,this.polygons=new Array,this.polygonPool=new t.Pool((function(){return t.Utils.newFloatArray(16)}))}return e.prototype.update=function(e,i){if(null==e)throw new Error("skeleton cannot be null.");var n=this.boundingBoxes,s=this.polygons,r=this.polygonPool,o=e.slots,a=o.length;n.length=0,r.freeAll(s),s.length=0;for(var c=0;c<a;c++){var l=o[c];if(l.bone.active){var h=l.getAttachment();if(h instanceof t.BoundingBoxAttachment){var _=h;n.push(_);var u=r.obtain();u.length!=_.worldVerticesLength&&(u=t.Utils.newFloatArray(_.worldVerticesLength)),s.push(u),_.computeWorldVertices(l,0,_.worldVerticesLength,u,0,2)}}}i?this.aabbCompute():(this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY)},e.prototype.aabbCompute=function(){for(var t=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,n=Number.NEGATIVE_INFINITY,s=this.polygons,r=0,o=s.length;r<o;r++)for(var a=s[r],c=a,l=0,h=a.length;l<h;l+=2){var _=c[l],u=c[l+1];t=Math.min(t,_),e=Math.min(e,u),i=Math.max(i,_),n=Math.max(n,u)}this.minX=t,this.minY=e,this.maxX=i,this.maxY=n},e.prototype.aabbContainsPoint=function(t,e){return t>=this.minX&&t<=this.maxX&&e>=this.minY&&e<=this.maxY},e.prototype.aabbIntersectsSegment=function(t,e,i,n){var s=this.minX,r=this.minY,o=this.maxX,a=this.maxY;if(t<=s&&i<=s||e<=r&&n<=r||t>=o&&i>=o||e>=a&&n>=a)return!1;var c=(n-e)/(i-t),l=c*(s-t)+e;if(l>r&&l<a)return!0;if((l=c*(o-t)+e)>r&&l<a)return!0;var h=(r-e)/c+t;return h>s&&h<o||(h=(a-e)/c+t)>s&&h<o},e.prototype.aabbIntersectsSkeleton=function(t){return this.minX<t.maxX&&this.maxX>t.minX&&this.minY<t.maxY&&this.maxY>t.minY},e.prototype.containsPoint=function(t,e){for(var i=this.polygons,n=0,s=i.length;n<s;n++)if(this.containsPointPolygon(i[n],t,e))return this.boundingBoxes[n];return null},e.prototype.containsPointPolygon=function(t,e,i){for(var n=t,s=t.length,r=s-2,o=!1,a=0;a<s;a+=2){var c=n[a+1],l=n[r+1];if(c<i&&l>=i||l<i&&c>=i){var h=n[a];h+(i-c)/(l-c)*(n[r]-h)<e&&(o=!o)}r=a}return o},e.prototype.intersectsSegment=function(t,e,i,n){for(var s=this.polygons,r=0,o=s.length;r<o;r++)if(this.intersectsSegmentPolygon(s[r],t,e,i,n))return this.boundingBoxes[r];return null},e.prototype.intersectsSegmentPolygon=function(t,e,i,n,s){for(var r=t,o=t.length,a=e-n,c=i-s,l=e*s-i*n,h=r[o-2],_=r[o-1],u=0;u<o;u+=2){var d=r[u],m=r[u+1],p=h*m-_*d,f=h-d,g=_-m,v=a*g-c*f,y=(l*f-a*p)/v;if((y>=h&&y<=d||y>=d&&y<=h)&&(y>=e&&y<=n||y>=n&&y<=e)){var x=(l*g-c*p)/v;if((x>=_&&x<=m||x>=m&&x<=_)&&(x>=i&&x<=s||x>=s&&x<=i))return!0}h=d,_=m}return!1},e.prototype.getPolygon=function(t){if(null==t)throw new Error("boundingBox cannot be null.");var e=this.boundingBoxes.indexOf(t);return-1==e?null:this.polygons[e]},e.prototype.getWidth=function(){return this.maxX-this.minX},e.prototype.getHeight=function(){return this.maxY-this.minY},e}();t.SkeletonBounds=e}(gnt||(gnt={})),function(t){var e=function(){function e(){this.triangulator=new t.Triangulator,this.clippingPolygon=new Array,this.clipOutput=new Array,this.clippedVertices=new Array,this.clippedTriangles=new Array,this.scratch=new Array}return e.prototype.clipStart=function(i,n){if(null!=this.clipAttachment)return 0;this.clipAttachment=n;var s=n.worldVerticesLength,r=t.Utils.setArraySize(this.clippingPolygon,s);n.computeWorldVertices(i,0,s,r,0,2);var o=this.clippingPolygon;e.makeClockwise(o);for(var a=this.clippingPolygons=this.triangulator.decompose(o,this.triangulator.triangulate(o)),c=0,l=a.length;c<l;c++){var h=a[c];e.makeClockwise(h),h.push(h[0]),h.push(h[1])}return a.length},e.prototype.clipEndWithSlot=function(t){null!=this.clipAttachment&&this.clipAttachment.endSlot==t.data&&this.clipEnd()},e.prototype.clipEnd=function(){null!=this.clipAttachment&&(this.clipAttachment=null,this.clippingPolygons=null,this.clippedVertices.length=0,this.clippedTriangles.length=0,this.clippingPolygon.length=0)},e.prototype.isClipping=function(){return null!=this.clipAttachment},e.prototype.clipTriangles=function(e,i,n,s,r,o,a,c,l,h,_){void 0===l&&(l=2),void 0===h&&(h=0),void 0===_&&(_=0);var u=this.clipOutput,d=this.clippedVertices,m=this.clippedTriangles,p=this.clippingPolygons,f=this.clippingPolygons.length,g=c?12:8,v=0;d.length=0,m.length=0;t:for(var y=0;y<s;y+=3)for(var x=n[y]*l,S=e[x+h],C=e[x+h+1],A=r[x+_],b=r[x+_+1],T=e[(x=n[y+1]*l)+h],E=e[x+h+1],P=r[x+_],w=r[x+_+1],I=e[(x=n[y+2]*l)+h],R=e[x+h+1],D=r[x+_],M=r[x+_+1],O=0;O<f;O++){var B=d.length;if(!this.clip(S,C,T,E,I,R,p[O],u)){(H=t.Utils.setArraySize(d,B+3*g))[B]=S,H[B+1]=C,H[B+2]=o.r,H[B+3]=o.g,H[B+4]=o.b,H[B+5]=o.a,c?(H[B+6]=A,H[B+7]=b,H[B+8]=a.r,H[B+9]=a.g,H[B+10]=a.b,H[B+11]=a.a,H[B+12]=T,H[B+13]=E,H[B+14]=o.r,H[B+15]=o.g,H[B+16]=o.b,H[B+17]=o.a,H[B+18]=P,H[B+19]=w,H[B+20]=a.r,H[B+21]=a.g,H[B+22]=a.b,H[B+23]=a.a,H[B+24]=I,H[B+25]=R,H[B+26]=o.r,H[B+27]=o.g,H[B+28]=o.b,H[B+29]=o.a,H[B+30]=D,H[B+31]=M,H[B+32]=a.r,H[B+33]=a.g,H[B+34]=a.b,H[B+35]=a.a):(H[B+6]=A,H[B+7]=b,H[B+8]=T,H[B+9]=E,H[B+10]=o.r,H[B+11]=o.g,H[B+12]=o.b,H[B+13]=o.a,H[B+14]=P,H[B+15]=w,H[B+16]=I,H[B+17]=R,H[B+18]=o.r,H[B+19]=o.g,H[B+20]=o.b,H[B+21]=o.a,H[B+22]=D,H[B+23]=M),B=m.length,(Z=t.Utils.setArraySize(m,B+3))[B]=v,Z[B+1]=v+1,Z[B+2]=v+2,v+=3;continue t}var N=u.length;if(0!=N){for(var L=E-R,F=I-T,z=S-I,V=R-C,G=1/(L*z+F*(C-R)),U=N>>1,k=this.clipOutput,H=t.Utils.setArraySize(d,B+U*g),j=0;j<N;j+=2){var W=k[j],q=k[j+1];H[B]=W,H[B+1]=q,H[B+2]=o.r,H[B+3]=o.g,H[B+4]=o.b,H[B+5]=o.a;var X=W-I,Y=q-R,K=(L*X+F*Y)*G,J=(V*X+z*Y)*G,$=1-K-J;H[B+6]=A*K+P*J+D*$,H[B+7]=b*K+w*J+M*$,c&&(H[B+8]=a.r,H[B+9]=a.g,H[B+10]=a.b,H[B+11]=a.a),B+=g}B=m.length;var Z=t.Utils.setArraySize(m,B+3*(U-2));for(U--,j=1;j<U;j++)Z[B]=v,Z[B+1]=v+j,Z[B+2]=v+j+1,B+=3;v+=U+1}}},e.prototype.clip=function(t,e,i,n,s,r,o,a){var c=a,l=!1,h=null;o.length%4>=2?(h=a,a=this.scratch):h=this.scratch,h.length=0,h.push(t),h.push(e),h.push(i),h.push(n),h.push(s),h.push(r),h.push(t),h.push(e),a.length=0;for(var _=o,u=o.length-4,d=0;;d+=2){for(var m=_[d],p=_[d+1],f=_[d+2],g=_[d+3],v=m-f,y=p-g,x=h,S=h.length-2,C=a.length,A=0;A<S;A+=2){var b=x[A],T=x[A+1],E=x[A+2],P=x[A+3],w=v*(P-g)-y*(E-f)>0;if(v*(T-g)-y*(b-f)>0){if(w){a.push(E),a.push(P);continue}var I=(D=P-T)*(f-m)-(M=E-b)*(g-p);if(Math.abs(I)>1e-6){var R=(M*(p-T)-D*(m-b))/I;a.push(m+(f-m)*R),a.push(p+(g-p)*R)}else a.push(m),a.push(p)}else if(w){var D,M;I=(D=P-T)*(f-m)-(M=E-b)*(g-p),Math.abs(I)>1e-6?(R=(M*(p-T)-D*(m-b))/I,a.push(m+(f-m)*R),a.push(p+(g-p)*R)):(a.push(m),a.push(p)),a.push(E),a.push(P)}l=!0}if(C==a.length)return c.length=0,!0;if(a.push(a[0]),a.push(a[1]),d==u)break;var O=a;(a=h).length=0,h=O}if(c!=a){c.length=0,d=0;for(var B=a.length-2;d<B;d++)c[d]=a[d]}else c.length=c.length-2;return l},e.makeClockwise=function(t){for(var e=t,i=t.length,n=e[i-2]*e[1]-e[0]*e[i-1],s=0,r=0,o=0,a=0,c=i-3;a<c;a+=2)s=e[a],r=e[a+1],o=e[a+2],n+=s*e[a+3]-o*r;if(!(n<0)){a=0;var l=i-2;for(c=i>>1;a<c;a+=2){var h=e[a],_=e[a+1],u=l-a;e[a]=e[u],e[a+1]=e[u+1],e[u]=h,e[u+1]=_}}},e}();t.SkeletonClipping=e}(gnt||(gnt={})),function(t){var e=function(){function t(){this.bones=new Array,this.slots=new Array,this.skins=new Array,this.events=new Array,this.animations=new Array,this.ikConstraints=new Array,this.transformConstraints=new Array,this.pathConstraints=new Array,this.fps=0}return t.prototype.findBone=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findBoneIndex=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,i=0,n=e.length;i<n;i++)if(e[i].name==t)return i;return-1},t.prototype.findSlot=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findSlotIndex=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,i=0,n=e.length;i<n;i++)if(e[i].name==t)return i;return-1},t.prototype.findSkin=function(t){if(null==t)throw new Error("skinName cannot be null.");for(var e=this.skins,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findEvent=function(t){if(null==t)throw new Error("eventDataName cannot be null.");for(var e=this.events,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findAnimation=function(t){if(null==t)throw new Error("animationName cannot be null.");for(var e=this.animations,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findIkConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.ikConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findTransformConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.transformConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findPathConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.pathConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findPathConstraintIndex=function(t){if(null==t)throw new Error("pathConstraintName cannot be null.");for(var e=this.pathConstraints,i=0,n=e.length;i<n;i++)if(e[i].name==t)return i;return-1},t}();t.SkeletonData=e}(gnt||(gnt={})),function(t){var e=function(){function e(t){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=t}return e.prototype.readSkeletonData=function(i){var n=this.scale,s=new t.SkeletonData,r="string"==typeof i?JSON.parse(i):i,o=r.skeleton;if(null!=o&&(s.hash=o.hash,s.version=o.spine,s.x=o.x,s.y=o.y,s.width=o.width,s.height=o.height,s.fps=o.fps,s.imagesPath=o.images),r.bones)for(var a=0;a<r.bones.length;a++){var c=r.bones[a],l=null,h=this.getValue(c,"parent",null);if(null!=h&&null==(l=s.findBone(h)))throw new Error("Parent bone not found: "+h);(m=new t.BoneData(s.bones.length,c.name,l)).length=this.getValue(c,"length",0)*n,m.x=this.getValue(c,"x",0)*n,m.y=this.getValue(c,"y",0)*n,m.rotation=this.getValue(c,"rotation",0),m.scaleX=this.getValue(c,"scaleX",1),m.scaleY=this.getValue(c,"scaleY",1),m.shearX=this.getValue(c,"shearX",0),m.shearY=this.getValue(c,"shearY",0),m.transformMode=e.transformModeFromString(this.getValue(c,"transform","normal")),m.skinRequired=this.getValue(c,"skin",!1),s.bones.push(m)}if(r.slots)for(a=0;a<r.slots.length;a++){var _=(I=r.slots[a]).name,u=I.bone,d=s.findBone(u);if(null==d)throw new Error("Slot bone not found: "+u);var m=new t.SlotData(s.slots.length,_,d),p=this.getValue(I,"color",null);null!=p&&m.color.setFromString(p);var f=this.getValue(I,"dark",null);null!=f&&(m.darkColor=new t.Color(1,1,1,1),m.darkColor.setFromString(f)),m.attachmentName=this.getValue(I,"attachment",null),m.blendMode=e.blendModeFromString(this.getValue(I,"blend","normal")),s.slots.push(m)}if(r.ik)for(a=0;a<r.ik.length;a++){var g=r.ik[a];(m=new t.IkConstraintData(g.name)).order=this.getValue(g,"order",0),m.skinRequired=this.getValue(g,"skin",!1);for(var v=0;v<g.bones.length;v++){if(u=g.bones[v],null==(E=s.findBone(u)))throw new Error("IK bone not found: "+u);m.bones.push(E)}var y=g.target;if(m.target=s.findBone(y),null==m.target)throw new Error("IK target bone not found: "+y);m.mix=this.getValue(g,"mix",1),m.softness=this.getValue(g,"softness",0)*n,m.bendDirection=this.getValue(g,"bendPositive",!0)?1:-1,m.compress=this.getValue(g,"compress",!1),m.stretch=this.getValue(g,"stretch",!1),m.uniform=this.getValue(g,"uniform",!1),s.ikConstraints.push(m)}if(r.transform)for(a=0;a<r.transform.length;a++){for(g=r.transform[a],(m=new t.TransformConstraintData(g.name)).order=this.getValue(g,"order",0),m.skinRequired=this.getValue(g,"skin",!1),v=0;v<g.bones.length;v++){if(u=g.bones[v],null==(E=s.findBone(u)))throw new Error("Transform constraint bone not found: "+u);m.bones.push(E)}if(y=g.target,m.target=s.findBone(y),null==m.target)throw new Error("Transform constraint target bone not found: "+y);m.local=this.getValue(g,"local",!1),m.relative=this.getValue(g,"relative",!1),m.offsetRotation=this.getValue(g,"rotation",0),m.offsetX=this.getValue(g,"x",0)*n,m.offsetY=this.getValue(g,"y",0)*n,m.offsetScaleX=this.getValue(g,"scaleX",0),m.offsetScaleY=this.getValue(g,"scaleY",0),m.offsetShearY=this.getValue(g,"shearY",0),m.rotateMix=this.getValue(g,"rotateMix",1),m.translateMix=this.getValue(g,"translateMix",1),m.scaleMix=this.getValue(g,"scaleMix",1),m.shearMix=this.getValue(g,"shearMix",1),s.transformConstraints.push(m)}if(r.path)for(a=0;a<r.path.length;a++){for(g=r.path[a],(m=new t.PathConstraintData(g.name)).order=this.getValue(g,"order",0),m.skinRequired=this.getValue(g,"skin",!1),v=0;v<g.bones.length;v++){if(u=g.bones[v],null==(E=s.findBone(u)))throw new Error("Transform constraint bone not found: "+u);m.bones.push(E)}if(y=g.target,m.target=s.findSlot(y),null==m.target)throw new Error("Path target slot not found: "+y);m.positionMode=e.positionModeFromString(this.getValue(g,"positionMode","percent")),m.spacingMode=e.spacingModeFromString(this.getValue(g,"spacingMode","length")),m.rotateMode=e.rotateModeFromString(this.getValue(g,"rotateMode","tangent")),m.offsetRotation=this.getValue(g,"rotation",0),m.position=this.getValue(g,"position",0),m.positionMode==t.PositionMode.Fixed&&(m.position*=n),m.spacing=this.getValue(g,"spacing",0),m.spacingMode!=t.SpacingMode.Length&&m.spacingMode!=t.SpacingMode.Fixed||(m.spacing*=n),m.rotateMix=this.getValue(g,"rotateMix",1),m.translateMix=this.getValue(g,"translateMix",1),s.pathConstraints.push(m)}if(r.skins){var x=r.skins;if(!(x instanceof Array)){var S=[];for(var C in x)S.push({name:C,attachments:x[C]});x=S}for(a=0;a<x.length;a++){var A=x[a],b=new t.Skin(A.name);if(A.bones)for(var T=0;T<A.bones.length;T++){var E;if(null==(E=s.findBone(A.bones[T])))throw new Error("Skin bone not found: "+A.bones[a]);b.bones.push(E)}if(A.ik)for(T=0;T<A.ik.length;T++){if(null==(P=s.findIkConstraint(A.ik[T])))throw new Error("Skin IK constraint not found: "+A.ik[a]);b.constraints.push(P)}if(A.transform)for(T=0;T<A.transform.length;T++){if(null==(P=s.findTransformConstraint(A.transform[T])))throw new Error("Skin transform constraint not found: "+A.transform[a]);b.constraints.push(P)}if(A.path)for(T=0;T<A.path.length;T++){var P;if(null==(P=s.findPathConstraint(A.path[T])))throw new Error("Skin path constraint not found: "+A.path[a]);b.constraints.push(P)}for(var _ in A.attachments){var w=s.findSlot(_);if(null==w)throw new Error("Slot not found: "+_);var I=A.attachments[_];for(var R in I){var D=this.readAttachment(I[R],b,w.index,R,s);null!=D&&b.setAttachment(w.index,R,D)}}s.skins.push(b),"default"==b.name&&(s.defaultSkin=b)}}a=0;for(var M=this.linkedMeshes.length;a<M;a++){var O=this.linkedMeshes[a];if(null==(b=null==O.skin?s.defaultSkin:s.findSkin(O.skin)))throw new Error("Skin not found: "+O.skin);var B=b.getAttachment(O.slotIndex,O.parent);if(null==B)throw new Error("Parent mesh not found: "+O.parent);O.mesh.deformAttachment=O.inheritDeform?B:O.mesh,O.mesh.setParentMesh(B),O.mesh.updateUVs()}if(this.linkedMeshes.length=0,r.events)for(var N in r.events){var L=r.events[N];(m=new t.EventData(N)).intValue=this.getValue(L,"int",0),m.floatValue=this.getValue(L,"float",0),m.stringValue=this.getValue(L,"string",""),m.audioPath=this.getValue(L,"audio",null),null!=m.audioPath&&(m.volume=this.getValue(L,"volume",1),m.balance=this.getValue(L,"balance",0)),s.events.push(m)}if(r.animations)for(var F in r.animations){var z=r.animations[F];this.readAnimation(z,F,s)}return s},e.prototype.readAttachment=function(e,n,s,r,o){var a=this.scale;switch(r=this.getValue(e,"name",r),this.getValue(e,"type","region")){case"region":var c=this.getValue(e,"path",r),l=this.attachmentLoader.newRegionAttachment(n,r,c);return null==l?null:(l.path=c,l.x=this.getValue(e,"x",0)*a,l.y=this.getValue(e,"y",0)*a,l.scaleX=this.getValue(e,"scaleX",1),l.scaleY=this.getValue(e,"scaleY",1),l.rotation=this.getValue(e,"rotation",0),l.width=e.width*a,l.height=e.height*a,null!=(y=this.getValue(e,"color",null))&&l.color.setFromString(y),l.updateOffset(),l);case"boundingbox":var h=this.attachmentLoader.newBoundingBoxAttachment(n,r);return null==h?null:(this.readVertices(e,h,e.vertexCount<<1),null!=(y=this.getValue(e,"color",null))&&h.color.setFromString(y),h);case"mesh":case"linkedmesh":c=this.getValue(e,"path",r);var _=this.attachmentLoader.newMeshAttachment(n,r,c);if(null==_)return null;_.path=c,null!=(y=this.getValue(e,"color",null))&&_.color.setFromString(y),_.width=this.getValue(e,"width",0)*a,_.height=this.getValue(e,"height",0)*a;var u=this.getValue(e,"parent",null);if(null!=u)return this.linkedMeshes.push(new i(_,this.getValue(e,"skin",null),s,u,this.getValue(e,"deform",!0))),_;var d=e.uvs;return this.readVertices(e,_,d.length),_.triangles=e.triangles,_.regionUVs=d,_.updateUVs(),_.edges=this.getValue(e,"edges",null),_.hullLength=2*this.getValue(e,"hull",0),_;case"path":if(null==(c=this.attachmentLoader.newPathAttachment(n,r)))return null;c.closed=this.getValue(e,"closed",!1),c.constantSpeed=this.getValue(e,"constantSpeed",!0);var m=e.vertexCount;this.readVertices(e,c,m<<1);for(var p=t.Utils.newArray(m/3,0),f=0;f<e.lengths.length;f++)p[f]=e.lengths[f]*a;return c.lengths=p,null!=(y=this.getValue(e,"color",null))&&c.color.setFromString(y),c;case"point":var g=this.attachmentLoader.newPointAttachment(n,r);return null==g?null:(g.x=this.getValue(e,"x",0)*a,g.y=this.getValue(e,"y",0)*a,g.rotation=this.getValue(e,"rotation",0),null!=(y=this.getValue(e,"color",null))&&g.color.setFromString(y),g);case"clipping":var v=this.attachmentLoader.newClippingAttachment(n,r);if(null==v)return null;var y,x=this.getValue(e,"end",null);if(null!=x){var S=o.findSlot(x);if(null==S)throw new Error("Clipping end slot not found: "+x);v.endSlot=S}return m=e.vertexCount,this.readVertices(e,v,m<<1),null!=(y=this.getValue(e,"color",null))&&v.color.setFromString(y),v}return null},e.prototype.readVertices=function(e,i,n){var s=this.scale;i.worldVerticesLength=n;var r=e.vertices;if(n!=r.length){var o=new Array,a=new Array;for(_=0,u=r.length;_<u;){var c=r[_++];a.push(c);for(var l=_+4*c;_<l;_+=4)a.push(r[_]),o.push(r[_+1]*s),o.push(r[_+2]*s),o.push(r[_+3])}i.bones=a,i.vertices=t.Utils.toFloatArray(o)}else{var h=t.Utils.toFloatArray(r);if(1!=s)for(var _=0,u=r.length;_<u;_++)h[_]*=s;i.vertices=h}},e.prototype.readAnimation=function(e,i,n){var s=this.scale,r=new Array,o=0;if(e.slots)for(var a in e.slots){var c=e.slots[a];if(-1==($=n.findSlotIndex(a)))throw new Error("Slot not found: "+a);for(var l in c){var h=c[l];if("attachment"==l){(x=new t.AttachmentTimeline(h.length)).slotIndex=$;for(var _=0,u=0;u<h.length;u++){var d=h[u];x.setFrame(_++,this.getValue(d,"time",0),d.name)}r.push(x),o=Math.max(o,x.frames[x.getFrameCount()-1])}else if("color"==l){for((x=new t.ColorTimeline(h.length)).slotIndex=$,_=0,u=0;u<h.length;u++){d=h[u];var m=new t.Color;m.setFromString(d.color),x.setFrame(_,this.getValue(d,"time",0),m.r,m.g,m.b,m.a),this.readCurve(d,x,_),_++}r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.ColorTimeline.ENTRIES])}else{if("twoColor"!=l)throw new Error("Invalid timeline type for a slot: "+l+" ("+a+")");for((x=new t.TwoColorTimeline(h.length)).slotIndex=$,_=0,u=0;u<h.length;u++){d=h[u];var p=new t.Color,f=new t.Color;p.setFromString(d.light),f.setFromString(d.dark),x.setFrame(_,this.getValue(d,"time",0),p.r,p.g,p.b,p.a,f.r,f.g,f.b),this.readCurve(d,x,_),_++}r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.TwoColorTimeline.ENTRIES])}}}if(e.bones)for(var g in e.bones){var v=e.bones[g],y=n.findBoneIndex(g);if(-1==y)throw new Error("Bone not found: "+g);for(var l in v)if(h=v[l],"rotate"===l){for((x=new t.RotateTimeline(h.length)).boneIndex=y,_=0,u=0;u<h.length;u++)d=h[u],x.setFrame(_,this.getValue(d,"time",0),this.getValue(d,"angle",0)),this.readCurve(d,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.RotateTimeline.ENTRIES])}else{if("translate"!==l&&"scale"!==l&&"shear"!==l)throw new Error("Invalid timeline type for a bone: "+l+" ("+g+")");var x=null,S=1,C=0;for("scale"===l?(x=new t.ScaleTimeline(h.length),C=1):"shear"===l?x=new t.ShearTimeline(h.length):(x=new t.TranslateTimeline(h.length),S=s),x.boneIndex=y,_=0,u=0;u<h.length;u++){d=h[u];var A=this.getValue(d,"x",C),b=this.getValue(d,"y",C);x.setFrame(_,this.getValue(d,"time",0),A*S,b*S),this.readCurve(d,x,_),_++}r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.TranslateTimeline.ENTRIES])}}if(e.ik)for(var T in e.ik){var E=e.ik[T],P=n.findIkConstraint(T);for((x=new t.IkConstraintTimeline(E.length)).ikConstraintIndex=n.ikConstraints.indexOf(P),_=0,u=0;u<E.length;u++)d=E[u],x.setFrame(_,this.getValue(d,"time",0),this.getValue(d,"mix",1),this.getValue(d,"softness",0)*s,this.getValue(d,"bendPositive",!0)?1:-1,this.getValue(d,"compress",!1),this.getValue(d,"stretch",!1)),this.readCurve(d,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.IkConstraintTimeline.ENTRIES])}if(e.transform)for(var T in e.transform){for(E=e.transform[T],P=n.findTransformConstraint(T),(x=new t.TransformConstraintTimeline(E.length)).transformConstraintIndex=n.transformConstraints.indexOf(P),_=0,u=0;u<E.length;u++)d=E[u],x.setFrame(_,this.getValue(d,"time",0),this.getValue(d,"rotateMix",1),this.getValue(d,"translateMix",1),this.getValue(d,"scaleMix",1),this.getValue(d,"shearMix",1)),this.readCurve(d,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.TransformConstraintTimeline.ENTRIES])}let w=e.path||e.paths;if(w)for(var T in w){E=w[T];var I=n.findPathConstraintIndex(T);if(-1==I)throw new Error("Path constraint not found: "+T);var R=n.pathConstraints[I];for(var l in E)if(h=E[l],"position"===l||"spacing"===l){for(x=null,S=1,"spacing"===l?(x=new t.PathConstraintSpacingTimeline(h.length),R.spacingMode!=t.SpacingMode.Length&&R.spacingMode!=t.SpacingMode.Fixed||(S=s)):(x=new t.PathConstraintPositionTimeline(h.length),R.positionMode==t.PositionMode.Fixed&&(S=s)),x.pathConstraintIndex=I,_=0,u=0;u<h.length;u++)d=h[u],x.setFrame(_,this.getValue(d,"time",0),this.getValue(d,l,0)*S),this.readCurve(d,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.PathConstraintPositionTimeline.ENTRIES])}else if("mix"===l){for((x=new t.PathConstraintMixTimeline(h.length)).pathConstraintIndex=I,_=0,u=0;u<h.length;u++)d=h[u],x.setFrame(_,this.getValue(d,"time",0),this.getValue(d,"rotateMix",1),this.getValue(d,"translateMix",1)),this.readCurve(d,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.PathConstraintMixTimeline.ENTRIES])}}if(e.deform)for(var D in e.deform){var M=e.deform[D],O=n.findSkin(D);if(null==O)throw new Error("Skin not found: "+D);for(var a in M){if(c=M[a],-1==($=n.findSlotIndex(a)))throw new Error("Slot not found: "+c.name);for(var l in c){h=c[l];var B=O.getAttachment($,l);if(null!=B){var N=null!=B.bones,L=B.vertices,F=N?L.length/3*2:L.length;(x=new t.DeformTimeline(h.length)).slotIndex=$,x.attachment=B,_=0;for(var z=0;z<h.length;z++){d=h[z];var V=void 0,G=this.getValue(d,"vertices",null);if(null==G)V=N?t.Utils.newFloatArray(F):L;else{V=t.Utils.newFloatArray(F);var U=this.getValue(d,"offset",0);if(t.Utils.arrayCopy(G,0,V,U,G.length),1!=s)for(var k=(u=U)+G.length;u<k;u++)V[u]*=s;if(!N)for(u=0;u<F;u++)V[u]+=L[u]}x.setFrame(_,this.getValue(d,"time",0),V),this.readCurve(d,x,_),_++}r.push(x),o=Math.max(o,x.frames[x.getFrameCount()-1])}}}}var H=e.drawOrder;if(null==H&&(H=e.draworder),null!=H){x=new t.DrawOrderTimeline(H.length);var j=n.slots.length;for(_=0,z=0;z<H.length;z++){var W=H[z],q=null,X=this.getValue(W,"offsets",null);if(null!=X){q=t.Utils.newArray(j,-1);var Y=t.Utils.newArray(j-X.length,0),K=0,J=0;for(u=0;u<X.length;u++){var $,Z=X[u];if(-1==($=n.findSlotIndex(Z.slot)))throw new Error("Slot not found: "+Z.slot);for(;K!=$;)Y[J++]=K++;q[K+Z.offset]=K++}for(;K<j;)Y[J++]=K++;for(u=j-1;u>=0;u--)-1==q[u]&&(q[u]=Y[--J])}x.setFrame(_++,this.getValue(W,"time",0),q)}r.push(x),o=Math.max(o,x.frames[x.getFrameCount()-1])}if(e.events){for(x=new t.EventTimeline(e.events.length),_=0,u=0;u<e.events.length;u++){var Q=e.events[u],tt=n.findEvent(Q.name);if(null==tt)throw new Error("Event not found: "+Q.name);var et=new t.Event(t.Utils.toSinglePrecision(this.getValue(Q,"time",0)),tt);et.intValue=this.getValue(Q,"int",tt.intValue),et.floatValue=this.getValue(Q,"float",tt.floatValue),et.stringValue=this.getValue(Q,"string",tt.stringValue),null!=et.data.audioPath&&(et.volume=this.getValue(Q,"volume",1),et.balance=this.getValue(Q,"balance",0)),x.setFrame(_++,et)}r.push(x),o=Math.max(o,x.frames[x.getFrameCount()-1])}if(isNaN(o))throw new Error("Error while parsing animation, duration is NaN");n.animations.push(new t.Animation(i,r,o))},e.prototype.readCurve=function(t,e,i){var n=t.curve;n&&("stepped"==n?e.setStepped(i):"[object Array]"===Object.prototype.toString.call(n)?e.setCurve(i,n[0],n[1],n[2],n[3]):e.setCurve(i,n,this.getValue(t,"c2",0),this.getValue(t,"c3",1),this.getValue(t,"c4",1)))},e.prototype.getValue=function(t,e,i){return void 0!==t[e]?t[e]:i},e.blendModeFromString=function(e){if("normal"==(e=e.toLowerCase()))return t.BlendMode.Normal;if("additive"==e)return t.BlendMode.Additive;if("multiply"==e)return t.BlendMode.Multiply;if("screen"==e)return t.BlendMode.Screen;throw new Error("Unknown blend mode: "+e)},e.positionModeFromString=function(e){if("fixed"==(e=e.toLowerCase()))return t.PositionMode.Fixed;if("percent"==e)return t.PositionMode.Percent;throw new Error("Unknown position mode: "+e)},e.spacingModeFromString=function(e){if("length"==(e=e.toLowerCase()))return t.SpacingMode.Length;if("fixed"==e)return t.SpacingMode.Fixed;if("percent"==e)return t.SpacingMode.Percent;throw new Error("Unknown position mode: "+e)},e.rotateModeFromString=function(e){if("tangent"==(e=e.toLowerCase()))return t.RotateMode.Tangent;if("chain"==e)return t.RotateMode.Chain;if("chainscale"==e)return t.RotateMode.ChainScale;throw new Error("Unknown rotate mode: "+e)},e.transformModeFromString=function(e){if("normal"==(e=e.toLowerCase()))return t.TransformMode.Normal;if("onlytranslation"==e)return t.TransformMode.OnlyTranslation;if("norotationorreflection"==e)return t.TransformMode.NoRotationOrReflection;if("noscale"==e)return t.TransformMode.NoScale;if("noscaleorreflection"==e)return t.TransformMode.NoScaleOrReflection;throw new Error("Unknown transform mode: "+e)},e}();t.SkeletonJson=e;var i=function(t,e,i,n,s){this.mesh=t,this.skin=e,this.slotIndex=i,this.parent=n,this.inheritDeform=s}}(gnt||(gnt={})),function(t){var e=function(t,e,i){this.slotIndex=t,this.name=e,this.attachment=i};t.SkinEntry=e;var i=function(){function i(t){if(this.attachments=new Array,this.bones=Array(),this.constraints=new Array,null==t)throw new Error("name cannot be null.");this.name=t}return i.prototype.setAttachment=function(t,e,i){if(null==i)throw new Error("attachment cannot be null.");var n=this.attachments;t>=n.length&&(n.length=t+1),n[t]||(n[t]={}),n[t][e]=i},i.prototype.addSkin=function(t){for(var e=0;e<t.bones.length;e++){for(var i=t.bones[e],n=!1,s=0;s<this.bones.length;s++)if(this.bones[s]==i){n=!0;break}n||this.bones.push(i)}for(e=0;e<t.constraints.length;e++){var r=t.constraints[e];for(n=!1,s=0;s<this.constraints.length;s++)if(this.constraints[s]==r){n=!0;break}n||this.constraints.push(r)}var o=t.getAttachments();for(e=0;e<o.length;e++){var a=o[e];this.setAttachment(a.slotIndex,a.name,a.attachment)}},i.prototype.copySkin=function(e){for(var i=0;i<e.bones.length;i++){for(var n=e.bones[i],s=!1,r=0;r<this.bones.length;r++)if(this.bones[r]==n){s=!0;break}s||this.bones.push(n)}for(i=0;i<e.constraints.length;i++){var o=e.constraints[i];for(s=!1,r=0;r<this.constraints.length;r++)if(this.constraints[r]==o){s=!0;break}s||this.constraints.push(o)}var a=e.getAttachments();for(i=0;i<a.length;i++){var c=a[i];null!=c.attachment&&(c.attachment instanceof t.MeshAttachment?(c.attachment=c.attachment.newLinkedMesh(),this.setAttachment(c.slotIndex,c.name,c.attachment)):(c.attachment=c.attachment.copy(),this.setAttachment(c.slotIndex,c.name,c.attachment)))}},i.prototype.getAttachment=function(t,e){var i=this.attachments[t];return i?i[e]:null},i.prototype.removeAttachment=function(t,e){var i=this.attachments[t];i&&(i[e]=null)},i.prototype.getAttachments=function(){for(var t=new Array,i=0;i<this.attachments.length;i++){var n=this.attachments[i];if(n)for(var s in n){var r=n[s];r&&t.push(new e(i,s,r))}}return t},i.prototype.getAttachmentsForSlot=function(t,i){var n=this.attachments[t];if(n)for(var s in n){var r=n[s];r&&i.push(new e(t,s,r))}},i.prototype.clear=function(){this.attachments.length=0,this.bones.length=0,this.constraints.length=0},i.prototype.attachAll=function(t,e){for(var i=0,n=0;n<t.slots.length;n++){var s=t.slots[n],r=s.getAttachment();if(r&&i<e.attachments.length){var o=e.attachments[i];for(var a in o)if(r==o[a]){var c=this.getAttachment(i,a);null!=c&&s.setAttachment(c);break}}i++}},i}();t.Skin=i}(gnt||(gnt={})),function(t){var e=function(){function e(e,i){if(this.deform=new Array,null==e)throw new Error("data cannot be null.");if(null==i)throw new Error("bone cannot be null.");this.data=e,this.bone=i,this.color=new t.Color,this.darkColor=null==e.darkColor?null:new t.Color,this.setToSetupPose()}return e.prototype.getSkeleton=function(){return this.bone.skeleton},e.prototype.getAttachment=function(){return this.attachment},e.prototype.setAttachment=function(t){this.attachment!=t&&(this.attachment=t,this.attachmentTime=this.bone.skeleton.time,this.deform.length=0)},e.prototype.setAttachmentTime=function(t){this.attachmentTime=this.bone.skeleton.time-t},e.prototype.getAttachmentTime=function(){return this.bone.skeleton.time-this.attachmentTime},e.prototype.setToSetupPose=function(){this.color.setFromColor(this.data.color),null!=this.darkColor&&this.darkColor.setFromColor(this.data.darkColor),null==this.data.attachmentName?this.attachment=null:(this.attachment=null,this.setAttachment(this.bone.skeleton.getAttachment(this.data.index,this.data.attachmentName)))},e}();t.Slot=e}(gnt||(gnt={})),function(t){t.SlotData=function(e,i,n){if(this.color=new t.Color(1,1,1,1),e<0)throw new Error("index must be >= 0.");if(null==i)throw new Error("name cannot be null.");if(null==n)throw new Error("boneData cannot be null.");this.index=e,this.name=i,this.boneData=n}}(gnt||(gnt={})),function(t){var e,i,n=function(){function t(t){this._image=t}return t.prototype.getImage=function(){return this._image},t.filterFromString=function(t){switch(t.toLowerCase()){case"nearest":return e.Nearest;case"linear":return e.Linear;case"mipmap":return e.MipMap;case"mipmapnearestnearest":return e.MipMapNearestNearest;case"mipmaplinearnearest":return e.MipMapLinearNearest;case"mipmapnearestlinear":return e.MipMapNearestLinear;case"mipmaplinearlinear":return e.MipMapLinearLinear;default:throw new Error("Unknown texture filter "+t)}},t.wrapFromString=function(t){switch(t.toLowerCase()){case"mirroredtepeat":return i.MirroredRepeat;case"clamptoedge":return i.ClampToEdge;case"repeat":return i.Repeat;default:throw new Error("Unknown texture wrap "+t)}},t}();t.Texture=n,function(t){t[t.Nearest=9728]="Nearest",t[t.Linear=9729]="Linear",t[t.MipMap=9987]="MipMap",t[t.MipMapNearestNearest=9984]="MipMapNearestNearest",t[t.MipMapLinearNearest=9985]="MipMapLinearNearest",t[t.MipMapNearestLinear=9986]="MipMapNearestLinear",t[t.MipMapLinearLinear=9987]="MipMapLinearLinear"}(e=t.TextureFilter||(t.TextureFilter={})),function(t){t[t.MirroredRepeat=33648]="MirroredRepeat",t[t.ClampToEdge=33071]="ClampToEdge",t[t.Repeat=10497]="Repeat"}(i=t.TextureWrap||(t.TextureWrap={}));t.TextureRegion=function(){this.u=0,this.v=0,this.u2=0,this.v2=0,this.width=0,this.height=0,this.rotate=!1,this.offsetX=0,this.offsetY=0,this.originalWidth=0,this.originalHeight=0};var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return vnt(e,t),e.prototype.setFilters=function(){},e.prototype.setWraps=function(){},e.prototype.dispose=function(){},e}(n);t.FakeTexture=s}(gnt||(gnt={})),function(t){var e=function(){function e(t,e){this.pages=new Array,this.regions=new Array,this.load(t,e)}return e.prototype.load=function(e,r){if(null==r)throw new Error("textureLoader cannot be null.");for(var o=new i(e),a=new Array(4),c=null;;){var l=o.readLine();if(null==l)break;if(0==(l=l.trim()).length)c=null;else if(c){var h=new s;h.name=l,h.page=c;var _=o.readValue();"true"==_.toLocaleLowerCase()?h.degrees=90:"false"==_.toLocaleLowerCase()?h.degrees=0:h.degrees=parseFloat(_),h.rotate=90==h.degrees,o.readTuple(a);var u=parseInt(a[0]),d=parseInt(a[1]);o.readTuple(a);var m=parseInt(a[0]),p=parseInt(a[1]);h.u=u/c.width,h.v=d/c.height,h.rotate?(h.u2=(u+p)/c.width,h.v2=(d+m)/c.height):(h.u2=(u+m)/c.width,h.v2=(d+p)/c.height),h.x=u,h.y=d,h.width=Math.abs(m),h.height=Math.abs(p),4==o.readTuple(a)&&4==o.readTuple(a)&&o.readTuple(a),h.originalWidth=parseInt(a[0]),h.originalHeight=parseInt(a[1]),o.readTuple(a),h.offsetX=parseInt(a[0]),h.offsetY=parseInt(a[1]),h.index=parseInt(o.readValue()),h.texture=c.texture,this.regions.push(h)}else{(c=new n).name=l,2==o.readTuple(a)&&(c.width=parseInt(a[0]),c.height=parseInt(a[1]),o.readTuple(a)),o.readTuple(a),c.minFilter=t.Texture.filterFromString(a[0]),c.magFilter=t.Texture.filterFromString(a[1]);var f=o.readValue();c.uWrap=t.TextureWrap.ClampToEdge,c.vWrap=t.TextureWrap.ClampToEdge,"x"==f?c.uWrap=t.TextureWrap.Repeat:"y"==f?c.vWrap=t.TextureWrap.Repeat:"xy"==f&&(c.uWrap=c.vWrap=t.TextureWrap.Repeat),c.texture=r(l),c.texture.setFilters(c.minFilter,c.magFilter),c.texture.setWraps(c.uWrap,c.vWrap),c.width=c.texture.getImage().width,c.height=c.texture.getImage().height,this.pages.push(c)}}},e.prototype.findRegion=function(t){for(var e=0;e<this.regions.length;e++)if(this.regions[e].name==t)return this.regions[e];return null},e.prototype.dispose=function(){for(var t=0;t<this.pages.length;t++)this.pages[t].texture.dispose()},e}();t.TextureAtlas=e;var i=function(){function t(t){this.index=0,this.lines=t.split(/\r\n|\r|\n/)}return t.prototype.readLine=function(){return this.index>=this.lines.length?null:this.lines[this.index++]},t.prototype.readValue=function(){var t=this.readLine(),e=t.indexOf(":");if(-1==e)throw new Error("Invalid line: "+t);return t.substring(e+1).trim()},t.prototype.readTuple=function(t){var e=this.readLine(),i=e.indexOf(":");if(-1==i)throw new Error("Invalid line: "+e);for(var n=0,s=i+1;n<3;n++){var r=e.indexOf(",",s);if(-1==r)break;t[n]=e.substr(s,r-s).trim(),s=r+1}return t[n]=e.substring(s).trim(),n+1},t}(),n=function(){};t.TextureAtlasPage=n;var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return vnt(e,t),e}(t.TextureRegion);t.TextureAtlasRegion=s}(gnt||(gnt={})),function(t){var e=function(){function e(e,i){if(this.rotateMix=0,this.translateMix=0,this.scaleMix=0,this.shearMix=0,this.temp=new t.Vector2,this.active=!1,null==e)throw new Error("data cannot be null.");if(null==i)throw new Error("skeleton cannot be null.");this.data=e,this.rotateMix=e.rotateMix,this.translateMix=e.translateMix,this.scaleMix=e.scaleMix,this.shearMix=e.shearMix,this.bones=new Array;for(var n=0;n<e.bones.length;n++)this.bones.push(i.findBone(e.bones[n].name));this.target=i.findBone(e.target.name)}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){this.data.local?this.data.relative?this.applyRelativeLocal():this.applyAbsoluteLocal():this.data.relative?this.applyRelativeWorld():this.applyAbsoluteWorld()},e.prototype.applyAbsoluteWorld=function(){for(var e=this.rotateMix,i=this.translateMix,n=this.scaleMix,s=this.shearMix,r=this.target,o=r.a,a=r.b,c=r.c,l=r.d,h=o*l-a*c>0?t.MathUtils.degRad:-t.MathUtils.degRad,_=this.data.offsetRotation*h,u=this.data.offsetShearY*h,d=this.bones,m=0,p=d.length;m<p;m++){var f=d[m],g=!1;if(0!=e){var v=f.a,y=f.b,x=f.c,S=f.d;(P=Math.atan2(c,o)-Math.atan2(x,v)+_)>t.MathUtils.PI?P-=t.MathUtils.PI2:P<-t.MathUtils.PI&&(P+=t.MathUtils.PI2),P*=e;var C=Math.cos(P),A=Math.sin(P);f.a=C*v-A*x,f.b=C*y-A*S,f.c=A*v+C*x,f.d=A*y+C*S,g=!0}if(0!=i){var b=this.temp;r.localToWorld(b.set(this.data.offsetX,this.data.offsetY)),f.worldX+=(b.x-f.worldX)*i,f.worldY+=(b.y-f.worldY)*i,g=!0}if(n>0){var T=Math.sqrt(f.a*f.a+f.c*f.c),E=Math.sqrt(o*o+c*c);T>1e-5&&(T=(T+(E-T+this.data.offsetScaleX)*n)/T),f.a*=T,f.c*=T,T=Math.sqrt(f.b*f.b+f.d*f.d),E=Math.sqrt(a*a+l*l),T>1e-5&&(T=(T+(E-T+this.data.offsetScaleY)*n)/T),f.b*=T,f.d*=T,g=!0}if(s>0){y=f.b,S=f.d;var P,w=Math.atan2(S,y);(P=Math.atan2(l,a)-Math.atan2(c,o)-(w-Math.atan2(f.c,f.a)))>t.MathUtils.PI?P-=t.MathUtils.PI2:P<-t.MathUtils.PI&&(P+=t.MathUtils.PI2),P=w+(P+u)*s,T=Math.sqrt(y*y+S*S),f.b=Math.cos(P)*T,f.d=Math.sin(P)*T,g=!0}g&&(f.appliedValid=!1)}},e.prototype.applyRelativeWorld=function(){for(var e=this.rotateMix,i=this.translateMix,n=this.scaleMix,s=this.shearMix,r=this.target,o=r.a,a=r.b,c=r.c,l=r.d,h=o*l-a*c>0?t.MathUtils.degRad:-t.MathUtils.degRad,_=this.data.offsetRotation*h,u=this.data.offsetShearY*h,d=this.bones,m=0,p=d.length;m<p;m++){var f,g=d[m],v=!1;if(0!=e){var y=g.a,x=g.b,S=g.c,C=g.d;(f=Math.atan2(c,o)+_)>t.MathUtils.PI?f-=t.MathUtils.PI2:f<-t.MathUtils.PI&&(f+=t.MathUtils.PI2),f*=e;var A=Math.cos(f),b=Math.sin(f);g.a=A*y-b*S,g.b=A*x-b*C,g.c=b*y+A*S,g.d=b*x+A*C,v=!0}if(0!=i){var T=this.temp;r.localToWorld(T.set(this.data.offsetX,this.data.offsetY)),g.worldX+=T.x*i,g.worldY+=T.y*i,v=!0}if(n>0){var E=(Math.sqrt(o*o+c*c)-1+this.data.offsetScaleX)*n+1;g.a*=E,g.c*=E,E=(Math.sqrt(a*a+l*l)-1+this.data.offsetScaleY)*n+1,g.b*=E,g.d*=E,v=!0}if(s>0)(f=Math.atan2(l,a)-Math.atan2(c,o))>t.MathUtils.PI?f-=t.MathUtils.PI2:f<-t.MathUtils.PI&&(f+=t.MathUtils.PI2),x=g.b,C=g.d,f=Math.atan2(C,x)+(f-t.MathUtils.PI/2+u)*s,E=Math.sqrt(x*x+C*C),g.b=Math.cos(f)*E,g.d=Math.sin(f)*E,v=!0;v&&(g.appliedValid=!1)}},e.prototype.applyAbsoluteLocal=function(){var t=this.rotateMix,e=this.translateMix,i=this.scaleMix,n=this.shearMix,s=this.target;s.appliedValid||s.updateAppliedTransform();for(var r=this.bones,o=0,a=r.length;o<a;o++){var c=r[o];c.appliedValid||c.updateAppliedTransform();var l=c.arotation;if(0!=t){var h=s.arotation-l+this.data.offsetRotation;l+=(h-=360*(16384-(16384.499999999996-h/360|0)))*t}var _=c.ax,u=c.ay;0!=e&&(_+=(s.ax-_+this.data.offsetX)*e,u+=(s.ay-u+this.data.offsetY)*e);var d=c.ascaleX,m=c.ascaleY;0!=i&&(d>1e-5&&(d=(d+(s.ascaleX-d+this.data.offsetScaleX)*i)/d),m>1e-5&&(m=(m+(s.ascaleY-m+this.data.offsetScaleY)*i)/m));var p=c.ashearY;0!=n&&(h=s.ashearY-p+this.data.offsetShearY,h-=360*(16384-(16384.499999999996-h/360|0)),c.shearY+=h*n),c.updateWorldTransformWith(_,u,l,d,m,c.ashearX,p)}},e.prototype.applyRelativeLocal=function(){var t=this.rotateMix,e=this.translateMix,i=this.scaleMix,n=this.shearMix,s=this.target;s.appliedValid||s.updateAppliedTransform();for(var r=this.bones,o=0,a=r.length;o<a;o++){var c=r[o];c.appliedValid||c.updateAppliedTransform();var l=c.arotation;0!=t&&(l+=(s.arotation+this.data.offsetRotation)*t);var h=c.ax,_=c.ay;0!=e&&(h+=(s.ax+this.data.offsetX)*e,_+=(s.ay+this.data.offsetY)*e);var u=c.ascaleX,d=c.ascaleY;0!=i&&(u>1e-5&&(u*=(s.ascaleX-1+this.data.offsetScaleX)*i+1),d>1e-5&&(d*=(s.ascaleY-1+this.data.offsetScaleY)*i+1));var m=c.ashearY;0!=n&&(m+=(s.ashearY+this.data.offsetShearY)*n),c.updateWorldTransformWith(h,_,l,u,d,c.ashearX,m)}},e}();t.TransformConstraint=e}(gnt||(gnt={})),function(t){var e=function(t){function e(e){var i=t.call(this,e,0,!1)||this;return i.bones=new Array,i.rotateMix=0,i.translateMix=0,i.scaleMix=0,i.shearMix=0,i.offsetRotation=0,i.offsetX=0,i.offsetY=0,i.offsetScaleX=0,i.offsetScaleY=0,i.offsetShearY=0,i.relative=!1,i.local=!1,i}return vnt(e,t),e}(t.ConstraintData);t.TransformConstraintData=e}(gnt||(gnt={})),function(t){var e=function(){function e(){this.convexPolygons=new Array,this.convexPolygonsIndices=new Array,this.indicesArray=new Array,this.isConcaveArray=new Array,this.triangles=new Array,this.polygonPool=new t.Pool((function(){return new Array})),this.polygonIndicesPool=new t.Pool((function(){return new Array}))}return e.prototype.triangulate=function(t){var i=t,n=t.length>>1,s=this.indicesArray;s.length=0;for(var r=0;r<n;r++)s[r]=r;var o=this.isConcaveArray;o.length=0,r=0;for(var a=n;r<a;++r)o[r]=e.isConcave(r,n,i,s);var c=this.triangles;for(c.length=0;n>3;){for(var l=n-1,h=(r=0,1);;){t:if(!o[r]){for(var _=s[l]<<1,u=s[r]<<1,d=s[h]<<1,m=i[_],p=i[_+1],f=i[u],g=i[u+1],v=i[d],y=i[d+1],x=(h+1)%n;x!=l;x=(x+1)%n)if(o[x]){var S=s[x]<<1,C=i[S],A=i[S+1];if(e.positiveArea(v,y,m,p,C,A)&&e.positiveArea(m,p,f,g,C,A)&&e.positiveArea(f,g,v,y,C,A))break t}break}if(0==h){do{if(!o[r])break;r--}while(r>0);break}l=r,r=h,h=(h+1)%n}c.push(s[(n+r-1)%n]),c.push(s[r]),c.push(s[(r+1)%n]),s.splice(r,1),o.splice(r,1);var b=(--n+r-1)%n,T=r==n?0:r;o[b]=e.isConcave(b,n,i,s),o[T]=e.isConcave(T,n,i,s)}return 3==n&&(c.push(s[2]),c.push(s[0]),c.push(s[1])),c},e.prototype.decompose=function(t,i){var n=t,s=this.convexPolygons;this.polygonPool.freeAll(s),s.length=0;var r=this.convexPolygonsIndices;this.polygonIndicesPool.freeAll(r),r.length=0;var o=this.polygonIndicesPool.obtain();o.length=0;var a=this.polygonPool.obtain();a.length=0;for(var c=-1,l=0,h=0,_=i.length;h<_;h+=3){var u=i[h]<<1,d=i[h+1]<<1,m=i[h+2]<<1,p=n[u],f=n[u+1],g=n[d],v=n[d+1],y=n[m],x=n[m+1],S=!1;if(c==u){var C=a.length-4,A=e.winding(a[C],a[C+1],a[C+2],a[C+3],y,x),b=e.winding(y,x,a[0],a[1],a[2],a[3]);A==l&&b==l&&(a.push(y),a.push(x),o.push(m),S=!0)}S||(a.length>0?(s.push(a),r.push(o)):(this.polygonPool.free(a),this.polygonIndicesPool.free(o)),(a=this.polygonPool.obtain()).length=0,a.push(p),a.push(f),a.push(g),a.push(v),a.push(y),a.push(x),(o=this.polygonIndicesPool.obtain()).length=0,o.push(u),o.push(d),o.push(m),l=e.winding(p,f,g,v,y,x),c=u)}for(a.length>0&&(s.push(a),r.push(o)),h=0,_=s.length;h<_;h++)if(0!=(o=r[h]).length)for(var T=o[0],E=o[o.length-1],P=(a=s[h])[C=a.length-4],w=a[C+1],I=a[C+2],R=a[C+3],D=a[0],M=a[1],O=a[2],B=a[3],N=e.winding(P,w,I,R,D,M),L=0;L<_;L++)if(L!=h){var F=r[L];if(3==F.length){var z=F[0],V=F[1],G=F[2],U=s[L];y=U[U.length-2],x=U[U.length-1],z==T&&V==E&&(A=e.winding(P,w,I,R,y,x),b=e.winding(y,x,D,M,O,B),A==N&&b==N&&(U.length=0,F.length=0,a.push(y),a.push(x),o.push(G),P=I,w=R,I=y,R=x,L=0))}}for(h=s.length-1;h>=0;h--)0==(a=s[h]).length&&(s.splice(h,1),this.polygonPool.free(a),o=r[h],r.splice(h,1),this.polygonIndicesPool.free(o));return s},e.isConcave=function(t,e,i,n){var s=n[(e+t-1)%e]<<1,r=n[t]<<1,o=n[(t+1)%e]<<1;return!this.positiveArea(i[s],i[s+1],i[r],i[r+1],i[o],i[o+1])},e.positiveArea=function(t,e,i,n,s,r){return t*(r-n)+i*(e-r)+s*(n-e)>=0},e.winding=function(t,e,i,n,s,r){var o=i-t,a=n-e;return s*a-r*o+o*e-t*a>=0?1:-1},e}();t.Triangulator=e}(gnt||(gnt={})),function(t){var e=function(){function t(){this.array=new Array}return t.prototype.add=function(t){var e=this.contains(t);return this.array[0|t]=0|t,!e},t.prototype.contains=function(t){return null!=this.array[0|t]},t.prototype.remove=function(t){this.array[0|t]=void 0},t.prototype.clear=function(){this.array.length=0},t}();t.IntSet=e;var i=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.r=t,this.g=e,this.b=i,this.a=n}return t.prototype.set=function(t,e,i,n){return this.r=t,this.g=e,this.b=i,this.a=n,this.clamp(),this},t.prototype.setFromColor=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},t.prototype.setFromString=function(t){return t="#"==t.charAt(0)?t.substr(1):t,this.r=parseInt(t.substr(0,2),16)/255,this.g=parseInt(t.substr(2,2),16)/255,this.b=parseInt(t.substr(4,2),16)/255,this.a=(8!=t.length?255:parseInt(t.substr(6,2),16))/255,this},t.prototype.add=function(t,e,i,n){return this.r+=t,this.g+=e,this.b+=i,this.a+=n,this.clamp(),this},t.prototype.clamp=function(){return this.r<0?this.r=0:this.r>1&&(this.r=1),this.g<0?this.g=0:this.g>1&&(this.g=1),this.b<0?this.b=0:this.b>1&&(this.b=1),this.a<0?this.a=0:this.a>1&&(this.a=1),this},t.rgba8888ToColor=function(t,e){t.r=((4278190080&e)>>>24)/255,t.g=((16711680&e)>>>16)/255,t.b=((65280&e)>>>8)/255,t.a=(255&e)/255},t.rgb888ToColor=function(t,e){t.r=((16711680&e)>>>16)/255,t.g=((65280&e)>>>8)/255,t.b=(255&e)/255},t.WHITE=new t(1,1,1,1),t.RED=new t(1,0,0,1),t.GREEN=new t(0,1,0,1),t.BLUE=new t(0,0,1,1),t.MAGENTA=new t(1,0,1,1),t}();t.Color=i;var n=function(){function t(){}return t.clamp=function(t,e,i){return t<e?e:t>i?i:t},t.cosDeg=function(e){return Math.cos(e*t.degRad)},t.sinDeg=function(e){return Math.sin(e*t.degRad)},t.signum=function(t){return t>0?1:t<0?-1:0},t.toInt=function(t){return t>0?Math.floor(t):Math.ceil(t)},t.cbrt=function(t){var e=Math.pow(Math.abs(t),1/3);return t<0?-e:e},t.randomTriangular=function(e,i){return t.randomTriangularWith(e,i,.5*(e+i))},t.randomTriangularWith=function(t,e,i){var n=Math.random(),s=e-t;return n<=(i-t)/s?t+Math.sqrt(n*s*(i-t)):e-Math.sqrt((1-n)*s*(e-i))},t.PI=3.1415927,t.PI2=2*t.PI,t.radiansToDegrees=180/t.PI,t.radDeg=t.radiansToDegrees,t.degreesToRadians=t.PI/180,t.degRad=t.degreesToRadians,t}();t.MathUtils=n;var s=function(){function t(){}return t.prototype.apply=function(t,e,i){return t+(e-t)*this.applyInternal(i)},t}();t.Interpolation=s;var r=function(t){function e(e){var i=t.call(this)||this;return i.power=2,i.power=e,i}return vnt(e,t),e.prototype.applyInternal=function(t){return t<=.5?Math.pow(2*t,this.power)/2:Math.pow(2*(t-1),this.power)/(this.power%2==0?-2:2)+1},e}(s);t.Pow=r;var o=function(t){function e(e){return t.call(this,e)||this}return vnt(e,t),e.prototype.applyInternal=function(t){return Math.pow(t-1,this.power)*(this.power%2==0?-1:1)+1},e}(r);t.PowOut=o;var a=function(){function t(){}return t.arrayCopy=function(t,e,i,n,s){for(var r=e,o=n;r<e+s;r++,o++)i[o]=t[r]},t.setArraySize=function(t,e,i){void 0===i&&(i=0);var n=t.length;if(n==e)return t;if(t.length=e,n<e)for(var s=n;s<e;s++)t[s]=i;return t},t.ensureArrayCapacity=function(e,i,n){return void 0===n&&(n=0),e.length>=i?e:t.setArraySize(e,i,n)},t.newArray=function(t,e){for(var i=new Array(t),n=0;n<t;n++)i[n]=e;return i},t.newFloatArray=function(e){if(t.SUPPORTS_TYPED_ARRAYS)return new Float32Array(e);for(var i=new Array(e),n=0;n<i.length;n++)i[n]=0;return i},t.newShortArray=function(e){if(t.SUPPORTS_TYPED_ARRAYS)return new Int16Array(e);for(var i=new Array(e),n=0;n<i.length;n++)i[n]=0;return i},t.toFloatArray=function(e){return t.SUPPORTS_TYPED_ARRAYS?new Float32Array(e):e},t.toSinglePrecision=function(e){return t.SUPPORTS_TYPED_ARRAYS?Math.fround(e):e},t.webkit602BugfixHelper=function(){},t.contains=function(t,e){for(var i=0;i<t.length;i++)if(t[i]==e)return!0;return!1},t.SUPPORTS_TYPED_ARRAYS="undefined"!=typeof Float32Array,t}();t.Utils=a;var c=function(){function t(){}return t.logBones=function(t){for(var e=0;e<t.bones.length;e++){var i=t.bones[e];console.log(i.data.name+", "+i.a+", "+i.b+", "+i.c+", "+i.d+", "+i.worldX+", "+i.worldY)}},t}();t.DebugUtils=c;var l=function(){function t(t){this.items=new Array,this.instantiator=t}return t.prototype.obtain=function(){return this.items.length>0?this.items.pop():this.instantiator()},t.prototype.free=function(t){t.reset&&t.reset(),this.items.push(t)},t.prototype.freeAll=function(t){for(var e=0;e<t.length;e++)t[e].reset&&t[e].reset(),this.items[e]=t[e]},t.prototype.clear=function(){this.items.length=0},t}();t.Pool=l;var h=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.set=function(t,e){return this.x=t,this.y=e,this},t.prototype.length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},t.prototype.normalize=function(){var t=this.length();return 0!=t&&(this.x/=t,this.y/=t),this},t}();t.Vector2=h;var _=function(){function t(){this.maxDelta=.064,this.framesPerSecond=0,this.delta=0,this.totalTime=0,this.lastTime=Date.now()/1e3,this.frameCount=0,this.frameTime=0}return t.prototype.update=function(){var t=Date.now()/1e3;this.delta=t-this.lastTime,this.frameTime+=this.delta,this.totalTime+=this.delta,this.delta>this.maxDelta&&(this.delta=this.maxDelta),this.lastTime=t,this.frameCount++,this.frameTime>1&&(this.framesPerSecond=this.frameCount/this.frameTime,this.frameTime=0,this.frameCount=0)},t}();t.TimeKeeper=_;var u=function(){function t(t){void 0===t&&(t=32),this.addedValues=0,this.lastValue=0,this.mean=0,this.dirty=!0,this.values=new Array(t)}return t.prototype.hasEnoughData=function(){return this.addedValues>=this.values.length},t.prototype.addValue=function(t){this.addedValues<this.values.length&&this.addedValues++,this.values[this.lastValue++]=t,this.lastValue>this.values.length-1&&(this.lastValue=0),this.dirty=!0},t.prototype.getMean=function(){if(this.hasEnoughData()){if(this.dirty){for(var t=0,e=0;e<this.values.length;e++)t+=this.values[e];this.mean=t/this.values.length,this.dirty=!1}return this.mean}return 0},t}();t.WindowedMean=u}(gnt||(gnt={})),Math.fround||(Math.fround=function(t){return function(e){return t[0]=e,t[0]}}(new Float32Array(1))),function(t){var e=function(t){if(null==t)throw new Error("name cannot be null.");this.name=t};t.Attachment=e;var i=function(e){function i(t){var n=e.call(this,t)||this;return n.id=(65535&i.nextID++)<<11,n.worldVerticesLength=0,n.deformAttachment=n,n}return vnt(i,e),i.prototype.computeWorldVertices=function(t,e,i,n,s,r){i=s+(i>>1)*r;var o=t.bone.skeleton,a=t.deform,c=this.vertices,l=this.bones;if(null!=l){for(var h=0,_=0,u=0;u<e;u+=2)h+=(f=l[h])+1,_+=f;var d=o.bones;if(0==a.length)for(w=s,b=3*_;w<i;w+=r){var m=0,p=0,f=l[h++];for(f+=h;h<f;h++,b+=3){x=d[l[h]],I=c[b],R=c[b+1];var g=c[b+2];m+=(I*x.a+R*x.b+x.worldX)*g,p+=(I*x.c+R*x.d+x.worldY)*g}n[w]=m,n[w+1]=p}else for(var v=a,y=(w=s,b=3*_,_<<1);w<i;w+=r){for(m=0,p=0,f=l[h++],f+=h;h<f;h++,b+=3,y+=2)x=d[l[h]],I=c[b]+v[y],R=c[b+1]+v[y+1],g=c[b+2],m+=(I*x.a+R*x.b+x.worldX)*g,p+=(I*x.c+R*x.d+x.worldY)*g;n[w]=m,n[w+1]=p}}else{a.length>0&&(c=a);for(var x,S=(x=t.bone).worldX,C=x.worldY,A=x.a,b=x.b,T=x.c,E=x.d,P=e,w=s;w<i;P+=2,w+=r){var I=c[P],R=c[P+1];n[w]=I*A+R*b+S,n[w+1]=I*T+R*E+C}}},i.prototype.copyTo=function(e){null!=this.bones?(e.bones=new Array(this.bones.length),t.Utils.arrayCopy(this.bones,0,e.bones,0,this.bones.length)):e.bones=null,null!=this.vertices?(e.vertices=t.Utils.newFloatArray(this.vertices.length),t.Utils.arrayCopy(this.vertices,0,e.vertices,0,this.vertices.length)):e.vertices=null,e.worldVerticesLength=this.worldVerticesLength,e.deformAttachment=this.deformAttachment},i.nextID=0,i}(e);t.VertexAttachment=i}(gnt||(gnt={})),function(t){var e;(e=t.AttachmentType||(t.AttachmentType={}))[e.Region=0]="Region",e[e.BoundingBox=1]="BoundingBox",e[e.Mesh=2]="Mesh",e[e.LinkedMesh=3]="LinkedMesh",e[e.Path=4]="Path",e[e.Point=5]="Point",e[e.Clipping=6]="Clipping"}(gnt||(gnt={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.color=new t.Color(1,1,1,1),n}return vnt(i,e),i.prototype.copy=function(){var t=new i(name);return this.copyTo(t),t.color.setFromColor(this.color),t},i}(t.VertexAttachment);t.BoundingBoxAttachment=e}(gnt||(gnt={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.color=new t.Color(.2275,.2275,.8078,1),n}return vnt(i,e),i.prototype.copy=function(){var t=new i(name);return this.copyTo(t),t.endSlot=this.endSlot,t.color.setFromColor(this.color),t},i}(t.VertexAttachment);t.ClippingAttachment=e}(gnt||(gnt={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.color=new t.Color(1,1,1,1),n.tempColor=new t.Color(0,0,0,0),n}return vnt(i,e),i.prototype.updateUVs=function(){var e=this.regionUVs;null!=this.uvs&&this.uvs.length==e.length||(this.uvs=t.Utils.newFloatArray(e.length));var i=this.uvs,n=this.uvs.length,s=this.region.u,r=this.region.v,o=0,a=0;if(this.region instanceof t.TextureAtlasRegion){var c=this.region,l=c.texture.getImage().width,h=c.texture.getImage().height;switch(c.degrees){case 90:s-=(c.originalHeight-c.offsetY-c.height)/l,r-=(c.originalWidth-c.offsetX-c.width)/h,o=c.originalHeight/l,a=c.originalWidth/h;for(var _=0;_<n;_+=2)i[_]=s+e[_+1]*o,i[_+1]=r+(1-e[_])*a;return;case 180:for(s-=(c.originalWidth-c.offsetX-c.width)/l,r-=c.offsetY/h,o=c.originalWidth/l,a=c.originalHeight/h,_=0;_<n;_+=2)i[_]=s+(1-e[_])*o,i[_+1]=r+(1-e[_+1])*a;return;case 270:for(s-=c.offsetY/l,r-=c.offsetX/h,o=c.originalHeight/l,a=c.originalWidth/h,_=0;_<n;_+=2)i[_]=s+(1-e[_+1])*o,i[_+1]=r+e[_]*a;return}s-=c.offsetX/l,r-=(c.originalHeight-c.offsetY-c.height)/h,o=c.originalWidth/l,a=c.originalHeight/h}else null==this.region?(s=r=0,o=a=1):(o=this.region.u2-s,a=this.region.v2-r);for(_=0;_<n;_+=2)i[_]=s+e[_]*o,i[_+1]=r+e[_+1]*a},i.prototype.getParentMesh=function(){return this.parentMesh},i.prototype.setParentMesh=function(t){this.parentMesh=t,null!=t&&(this.bones=t.bones,this.vertices=t.vertices,this.worldVerticesLength=t.worldVerticesLength,this.regionUVs=t.regionUVs,this.triangles=t.triangles,this.hullLength=t.hullLength,this.worldVerticesLength=t.worldVerticesLength)},i.prototype.copy=function(){if(null!=this.parentMesh)return this.newLinkedMesh();var e=new i(this.name);return e.region=this.region,e.path=this.path,e.color.setFromColor(this.color),this.copyTo(e),e.regionUVs=new Array(this.regionUVs.length),t.Utils.arrayCopy(this.regionUVs,0,e.regionUVs,0,this.regionUVs.length),e.uvs=new Array(this.uvs.length),t.Utils.arrayCopy(this.uvs,0,e.uvs,0,this.uvs.length),e.triangles=new Array(this.triangles.length),t.Utils.arrayCopy(this.triangles,0,e.triangles,0,this.triangles.length),e.hullLength=this.hullLength,null!=this.edges&&(e.edges=new Array(this.edges.length),t.Utils.arrayCopy(this.edges,0,e.edges,0,this.edges.length)),e.width=this.width,e.height=this.height,e},i.prototype.newLinkedMesh=function(){var t=new i(this.name);return t.region=this.region,t.path=this.path,t.color.setFromColor(this.color),t.deformAttachment=this.deformAttachment,t.setParentMesh(null!=this.parentMesh?this.parentMesh:this),t.updateUVs(),t},i}(t.VertexAttachment);t.MeshAttachment=e}(gnt||(gnt={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.closed=!1,n.constantSpeed=!1,n.color=new t.Color(1,1,1,1),n}return vnt(i,e),i.prototype.copy=function(){var e=new i(name);return this.copyTo(e),e.lengths=new Array(this.lengths.length),t.Utils.arrayCopy(this.lengths,0,e.lengths,0,this.lengths.length),e.closed=closed,e.constantSpeed=this.constantSpeed,e.color.setFromColor(this.color),e},i}(t.VertexAttachment);t.PathAttachment=e}(gnt||(gnt={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.color=new t.Color(.38,.94,0,1),n}return vnt(i,e),i.prototype.computeWorldPosition=function(t,e){return e.x=this.x*t.a+this.y*t.b+t.worldX,e.y=this.x*t.c+this.y*t.d+t.worldY,e},i.prototype.computeWorldRotation=function(e){var i=t.MathUtils.cosDeg(this.rotation),n=t.MathUtils.sinDeg(this.rotation),s=i*e.a+n*e.b,r=i*e.c+n*e.d;return Math.atan2(r,s)*t.MathUtils.radDeg},i.prototype.copy=function(){var t=new i(name);return t.x=this.x,t.y=this.y,t.rotation=this.rotation,t.color.setFromColor(this.color),t},i}(t.VertexAttachment);t.PointAttachment=e}(gnt||(gnt={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.x=0,n.y=0,n.scaleX=1,n.scaleY=1,n.rotation=0,n.width=0,n.height=0,n.color=new t.Color(1,1,1,1),n.offset=t.Utils.newFloatArray(8),n.uvs=t.Utils.newFloatArray(8),n.tempColor=new t.Color(1,1,1,1),n}return vnt(i,e),i.prototype.updateOffset=function(){var t=this.width/this.region.originalWidth*this.scaleX,e=this.height/this.region.originalHeight*this.scaleY,n=-this.width/2*this.scaleX+this.region.offsetX*t,s=-this.height/2*this.scaleY+this.region.offsetY*e,r=n+this.region.width*t,o=s+this.region.height*e,a=this.rotation*Math.PI/180,c=Math.cos(a),l=Math.sin(a),h=n*c+this.x,_=n*l,u=s*c+this.y,d=s*l,m=r*c+this.x,p=r*l,f=o*c+this.y,g=o*l,v=this.offset;v[i.OX1]=h-d,v[i.OY1]=u+_,v[i.OX2]=h-g,v[i.OY2]=f+_,v[i.OX3]=m-g,v[i.OY3]=f+p,v[i.OX4]=m-d,v[i.OY4]=u+p},i.prototype.setRegion=function(t){this.region=t;var e=this.uvs;t.rotate?(e[2]=t.u,e[3]=t.v2,e[4]=t.u,e[5]=t.v,e[6]=t.u2,e[7]=t.v,e[0]=t.u2,e[1]=t.v2):(e[0]=t.u,e[1]=t.v2,e[2]=t.u,e[3]=t.v,e[4]=t.u2,e[5]=t.v,e[6]=t.u2,e[7]=t.v2)},i.prototype.computeWorldVertices=function(t,e,n,s){var r=this.offset,o=t.worldX,a=t.worldY,c=t.a,l=t.b,h=t.c,_=t.d,u=0,d=0;u=r[i.OX1],d=r[i.OY1],e[n]=u*c+d*l+o,e[n+1]=u*h+d*_+a,n+=s,u=r[i.OX2],d=r[i.OY2],e[n]=u*c+d*l+o,e[n+1]=u*h+d*_+a,n+=s,u=r[i.OX3],d=r[i.OY3],e[n]=u*c+d*l+o,e[n+1]=u*h+d*_+a,n+=s,u=r[i.OX4],d=r[i.OY4],e[n]=u*c+d*l+o,e[n+1]=u*h+d*_+a},i.prototype.copy=function(){var e=new i(name);return e.region=this.region,e.rendererObject=this.rendererObject,e.path=this.path,e.x=this.x,e.y=this.y,e.scaleX=this.scaleX,e.scaleY=this.scaleY,e.rotation=this.rotation,e.width=this.width,e.height=this.height,t.Utils.arrayCopy(this.uvs,0,e.uvs,0,8),t.Utils.arrayCopy(this.offset,0,e.offset,0,8),e.color.setFromColor(this.color),e},i.OX1=0,i.OY1=1,i.OX2=2,i.OY2=3,i.OX3=4,i.OY3=5,i.OX4=6,i.OY4=7,i.X1=0,i.Y1=1,i.C1R=2,i.C1G=3,i.C1B=4,i.C1A=5,i.U1=6,i.V1=7,i.X2=8,i.Y2=9,i.C2R=10,i.C2G=11,i.C2B=12,i.C2A=13,i.U2=14,i.V2=15,i.X3=16,i.Y3=17,i.C3R=18,i.C3G=19,i.C3B=20,i.C3A=21,i.U3=22,i.V3=23,i.X4=24,i.Y4=25,i.C4R=26,i.C4G=27,i.C4B=28,i.C4A=29,i.U4=30,i.V4=31,i}(t.Attachment);t.RegionAttachment=e}(gnt||(gnt={})),function(t){var e=function(){function e(t,e){this.jitterX=0,this.jitterY=0,this.jitterX=t,this.jitterY=e}return e.prototype.begin=function(){},e.prototype.transform=function(e){e.x+=t.MathUtils.randomTriangular(-this.jitterX,this.jitterY),e.y+=t.MathUtils.randomTriangular(-this.jitterX,this.jitterY)},e.prototype.end=function(){},e}();t.JitterEffect=e}(gnt||(gnt={})),function(t){var e=function(){function e(t,e){this.centerX=0,this.centerY=0,this.radius=0,this.angle=0,this.worldX=0,this.worldY=0,this.radius=t,this.interpolation=e}return e.prototype.begin=function(t){this.worldX=t.x+this.centerX,this.worldY=t.y+this.centerY},e.prototype.transform=function(e){var i=this.angle*t.MathUtils.degreesToRadians,n=e.x-this.worldX,s=e.y-this.worldY,r=Math.sqrt(n*n+s*s);if(r<this.radius){var o=this.interpolation.apply(0,i,(this.radius-r)/this.radius),a=Math.cos(o),c=Math.sin(o);e.x=a*n-c*s+this.worldX,e.y=c*n+a*s+this.worldY}},e.prototype.end=function(){},e.interpolation=new t.PowOut(2),e}();t.SwirlEffect=e}(gnt||(gnt={}));var ynt=gnt;const xnt=1/60,Snt=[],Cnt=[];let Ant,bnt,Tnt,Ent,Pnt,wnt,Int=0,Rnt=0,Dnt=0,Mnt=null,Ont=null,Bnt=0,Nnt=0,Lnt=0,Fnt=0,znt=null,Vnt=null,Gnt=0,Unt=0;const knt=new ynt.Color(1,1,1,1),Hnt=new ynt.Color(1,1,1,1),jnt=[0,1,2,2,3,0];class Wnt{constructor(){this.frames=[],this.totalTime=0,this.isCompleted=!1,this.maxVertexCount=0,this.maxIndexCount=0,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this._frameIdx=-1,this._skeletonInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this.frames=[],this.totalTime=0,this._frameIdx=-1,this.isCompleted=!1,this._skeletonInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null}init(t,e){this._inited=!0,this._animationName=e,this._skeletonInfo=t}clear(){this._inited=!1;for(let t=0,e=this.frames.length;t<e;t++)this.frames[t].segments.length=0;this.invalidAllFrame()}bind(t){t.complete=t=>{t&&t.animation.name===this._animationName&&(this.isCompleted=!0)}}unbind(t){t.complete=null}begin(){if(!this._invalid)return;const t=this._skeletonInfo,e=null==t?void 0:t.curAnimationCache;e&&e!==this&&(this._privateMode?e.invalidAllFrame():e.updateToFrame());const i=null==t?void 0:t.skeleton,n=null==t?void 0:t.listener,s=null==t?void 0:t.state,r=null==i?void 0:i.data.findAnimation(this._animationName);null==s||s.setAnimationWith(0,r,!1),this.bind(n),t.curAnimationCache=this,this._frameIdx=-1,this.isCompleted=!1,this.totalTime=0,this._invalid=!1}end(){this.needToUpdate()||(this._skeletonInfo.curAnimationCache=null,this.frames.length=this._frameIdx+1,this.isCompleted=!0,this.unbind(this._skeletonInfo.listener))}updateToFrame(t){if(!this._inited)return;if(this.begin(),!this.needToUpdate(t))return;const e=this._skeletonInfo,i=null==e?void 0:e.skeleton,n=null==e?void 0:e.clipper,s=null==e?void 0:e.state;do{null==i||i.update(xnt),null==s||s.update(xnt),null==s||s.apply(i),null==i||i.updateWorldTransform(),this._frameIdx++,this.updateFrame(i,n,this._frameIdx),this.totalTime+=xnt}while(this.needToUpdate(t));this.end()}isInited(){return this._inited}isInvalid(){return this._invalid}invalidAllFrame(){this.isCompleted=!1,this._invalid=!0}updateAllFrame(){this.invalidAllFrame(),this.updateToFrame()}enableCacheAttachedInfo(){this._enableCacheAttachedInfo||(this._enableCacheAttachedInfo=!0,this.invalidAllFrame())}fillVertices(t,e,i,n,s){if(Ent=i.a*e.a*t.a*255,Ant=e.r*t.r*255,bnt=e.g*t.g*255,Tnt=e.b*t.b*255,knt.r=Ant*i.r,knt.g=bnt*i.g,knt.b=Tnt*i.b,knt.a=Ent,null==s.darkColor?Hnt.set(0,0,0,1):(Hnt.r=s.darkColor.r*Ant,Hnt.g=s.darkColor.g*bnt,Hnt.b=s.darkColor.b*Tnt),Hnt.a=0,Pnt=(knt.a<<24>>>0)+(knt.b<<16)+(knt.g<<8)+knt.r,wnt=(Hnt.a<<24>>>0)+(Hnt.b<<16)+(Hnt.g<<8)+Hnt.r,znt!==Pnt||Vnt!==wnt){const t=this._tempColors;znt=Pnt,Vnt=wnt,Fnt>0&&(t[Fnt-1].vfOffset=Dnt),t[Fnt++]={fr:knt.r,fg:knt.g,fb:knt.b,fa:knt.a,dr:Hnt.r,dg:Hnt.g,db:Hnt.b,da:Hnt.a,vfOffset:0}}if(n.isClipping()){n.clipTriangles(Snt,Gnt,Cnt,Unt,Snt,knt,Hnt,!0,6,Dnt,Dnt+2);const t=n.clippedVertices,e=n.clippedTriangles;Unt=e.length,Gnt=t.length/12*6;for(let t=0,i=Rnt,n=e.length;t<n;)Cnt[i++]=e[t++];for(let e=0,i=t.length,n=Dnt;e<i;e+=12,n+=6)Snt[n]=t[e],Snt[n+1]=t[e+1],Snt[n+2]=t[e+6],Snt[n+3]=t[e+7],Snt[n+4]=Pnt,Snt[n+5]=wnt}else for(let t=Dnt,e=Dnt+Gnt;t<e;t+=6)Snt[t+4]=Pnt,Snt[t+5]=wnt}updateFrame(t,e,i){Dnt=0,Int=0,Rnt=0,Mnt=null,Ont=null,Bnt=0,Nnt=0,Lnt=0,Fnt=0,znt=null,Vnt=null,this.frames[i]=this.frames[i]||{segments:[],colors:[],boneInfos:[],vertices:null,uintVert:null,indices:null};const n=this.frames[i],s=this._tempSegments=n.segments,r=this._tempColors=n.colors,o=this._tempBoneInfos=n.boneInfos;this.traverseSkeleton(t,e),Fnt>0&&(r[Fnt-1].vfOffset=Dnt),r.length=Fnt,o.length=Int;const a=Lnt-1;if(a>=0)if(Nnt>0){const t=s[a];t.indexCount=Nnt,t.vfCount=13*Bnt,t.vertexCount=Bnt,s.length=Lnt}else s.length=Lnt-1;if(0===s.length)return;let c=n.vertices;const l=Dnt/6,h=13*l;(!c||c.length<h)&&(c=n.vertices=new Float32Array(h));for(let t=0,e=0;t<h;)c[t]=Snt[e++],c[t+1]=Snt[e++],c[t+3]=Snt[e++],c[t+4]=Snt[e++],this._setVerticeColor(Snt[e++],c,t+5),this._setVerticeColor(Snt[e++],c,t+9),t+=13;let _=n.indices;(!_||_.length<Rnt)&&(_=n.indices=new Uint16Array(Rnt));for(let t=0;t<Rnt;t++)_[t]=Cnt[t];n.vertices=c,n.indices=_,this.maxVertexCount=l>this.maxVertexCount?l:this.maxVertexCount,this.maxIndexCount=_.length>this.maxIndexCount?_.length:this.maxIndexCount}needToUpdate(t){return!this.isCompleted&&this.totalTime<30&&(void 0===t||this._frameIdx<t)}traverseSkeleton(t,e){const i=this._tempSegments,n=this._tempBoneInfos,s=t.color;let r,o,a,c,l,h,_,u,d,m,p,f,g;const v=t.bones;if(this._enableCacheAttachedInfo)for(let t=0,e=v.length;t<e;t++,Int++){const e=v[t];let i=n[Int];i||(i=n[Int]={}),i.a=e.a,i.b=e.b,i.c=e.c,i.d=e.d,i.worldX=e.worldX,i.worldY=e.worldY}for(let n=0,v=t.drawOrder.length;n<v;n++)if(g=t.drawOrder[n],g.bone.active)if(Gnt=0,Unt=0,r=g.getAttachment(),r)if(h=r instanceof ynt.RegionAttachment,_=r instanceof ynt.MeshAttachment,u=r instanceof ynt.ClippingAttachment,u)e.clipStart(g,r);else if(h||_)if(d=r.region.texture.getRealTexture(),d){if(f=g.data.blendMode,Mnt===d.getId()&&Ont===f||(Mnt=d.getId(),Ont=f,m=Lnt-1,m>=0&&(Nnt>0?(p=i[m],p.indexCount=Nnt,p.vertexCount=Bnt,p.vfCount=13*Bnt):Lnt--),i[Lnt]={tex:d,blendMode:f,indexCount:0,vertexCount:0,vfCount:0},Lnt++,Nnt=0,Bnt=0),h)l=jnt,Gnt=24,Unt=6,r.computeWorldVertices(g.bone,Snt,Dnt,6);else if(_){const t=r;l=t.triangles,Gnt=6*(t.worldVerticesLength>>1),Unt=l.length,t.computeWorldVertices(g,0,t.worldVerticesLength,Snt,Dnt,6)}if(0!==Gnt&&0!==Unt){for(let t=0,e=Rnt,i=l.length;t<i;)Cnt[e++]=l[t++];c=r.uvs;for(let t=Dnt,e=Dnt+Gnt,i=0;t<e;t+=6,i+=2)Snt[t+2]=c[i],Snt[t+3]=c[i+1];if(o=r.color,a=g.color,this.fillVertices(s,o,a,e,g),Unt>0){for(let t=Rnt,e=Rnt+Unt;t<e;t++)Cnt[t]+=Bnt;Rnt+=Unt,Dnt+=Gnt,Nnt+=Unt,Bnt+=Gnt/6}e.clipEndWithSlot(g)}else e.clipEndWithSlot(g)}else e.clipEndWithSlot(g);else e.clipEndWithSlot(g);else e.clipEndWithSlot(g);e.clipEnd()}_setVerticeColor(t,e,i){e[i]=(255&t)/255,e[i+1]=(t>>8&255)/255,e[i+2]=(t>>16&255)/255,e[i+3]=(t>>24&255)/255}}class qnt{constructor(){this._privateMode=void 0,this._skeletonCache=void 0,this._animationPool=void 0,this._privateMode=!1,this._animationPool={},this._skeletonCache={}}enablePrivateMode(){this._privateMode=!0}clear(){this._animationPool={},this._skeletonCache={}}removeSkeleton(t){const e=this._skeletonCache[t];if(!e)return;const i=e.animationsCache;for(const e in i){const n=i[e];n&&(this._animationPool[`${t}#${e}`]=n,n.clear())}delete this._skeletonCache[t]}getSkeletonCache(t,e){let i=this._skeletonCache[t];if(!i){const n=new ynt.Skeleton(e),s=new ynt.SkeletonClipping,r=new ynt.AnimationStateData(n.data),o=new ynt.AnimationState(r),a=new fnt;o.addListener(a),this._skeletonCache[t]=i={skeleton:n,clipper:s,state:o,listener:a,animationsCache:{},curAnimationCache:null}}return i}getAnimationCache(t,e){const i=this._skeletonCache[t];return i?i.animationsCache[e]:null}invalidAnimationCache(t){const e=this._skeletonCache[t];if(!e||!e.skeleton)return;const i=e.animationsCache;for(const t in i)i[t].invalidAllFrame()}initAnimationCache(t,e){if(!e)return null;const i=this._skeletonCache[t],n=i&&i.skeleton;if(!n)return null;if(!n.data.findAnimation(e))return null;const s=i.animationsCache;let r=s[e];if(!r){const n=`${t}#${e}`;r=this._animationPool[n],r?delete this._animationPool[n]:(r=new Wnt,r._privateMode=this._privateMode),r.init(i,e),s[e]=r}return r}updateAnimationCache(t,e){if(e){const i=this.initAnimationCache(t,e);if(!i)return;i.updateAllFrame()}else{const e=this._skeletonCache[t];if(!e||!e.skeleton)return;const i=e.animationsCache;for(const t in i)i[t].updateAllFrame()}}}qnt.FrameTime=xnt,qnt.sharedCache=new qnt;const Xnt=new Ii;class Ynt{constructor(){this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null,this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null}init(t){this._inited=!0,this._skeleton=t._skeleton,this._skeletonNode=t.node,this._skeletonComp=t}reset(){this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null}_syncAttachedNode(){if(!this._inited)return;const t=this._skeletonComp.socketNodes;if(0===t.size)return;let e=null;if(e=this._skeletonComp.isAnimationCached()?this._skeletonComp._curFrame&&this._skeletonComp._curFrame.boneInfos:this._skeleton.bones,!e)return;const i=(t,e)=>{const i=Xnt;i.m00=e.a,i.m01=e.c,i.m04=e.b,i.m05=e.d,i.m12=e.worldX,i.m13=e.worldY,t.matrix=Xnt};for(const n of t.keys()){const s=t.get(n);if(!s||!s.isValid){t.delete(n);continue}const r=e[n];r?i(s,r):(s.removeFromParent(),s.destroy(),t.delete(n))}}}class Knt extends ynt.Texture{constructor(t){super(t),this.name="sp.SkeletonTexture",this._texture=null,this._material=null}setRealTexture(t){this._texture=t}getRealTexture(){return this._texture}setFilters(t,e){this._texture&&this.getRealTexture().setFilters(Jnt(t),Jnt(e))}setWraps(t,e){this._texture&&this.getRealTexture().setWrapMode($nt(t),$nt(e))}dispose(){}}function Jnt(t){switch(t){case ynt.TextureFilter.Nearest:case ynt.TextureFilter.MipMapNearestNearest:case ynt.TextureFilter.MipMapLinearNearest:return Fp.NEAREST;case ynt.TextureFilter.MipMap:case ynt.TextureFilter.MipMapNearestLinear:case ynt.TextureFilter.MipMapLinearLinear:case ynt.TextureFilter.Linear:default:return Fp.LINEAR}}function $nt(t){switch(t){case ynt.TextureWrap.MirroredRepeat:return Lp.MIRRORED_REPEAT;case ynt.TextureWrap.ClampToEdge:return Lp.CLAMP_TO_EDGE;case ynt.TextureWrap.Repeat:default:return Lp.REPEAT}}var Znt,Qnt,tst,est,ist,nst,sst,rst,ost,ast;let cst=(Znt=dc("sp.SkeletonData"),Qnt=Kc([xf]),tst=Kc([ve]),Znt((nst=sc((ist=class extends fh{get skeletonJsonStr(){return this._skeletonJson?JSON.stringify(this._skeletonJson):""}get skeletonJson(){return this._skeletonJson}set skeletonJson(t){this.reset(),this._skeletonJson="string"==typeof t?JSON.parse(t):t,!this._uuid&&t.skeleton&&(this._uuid=t.skeleton.hash)}get atlasText(){return this._atlasText}set atlasText(t){this._atlasText=t,this.reset()}get _nativeAsset(){return this._buffer}set _nativeAsset(t){this._buffer=t,this.reset()}constructor(){super(),nc(this,"_skeletonJson",nst,this),nc(this,"textures",sst,this),nc(this,"textureNames",rst,this),nc(this,"scale",ost,this),nc(this,"_atlasText",ast,this),this._buffer=void 0,this._skeletonCache=null,this._atlasCache=null,this._skinsEnum=null,this._animsEnum=null,this.reset()}createNode(t){const e=new iS(this.name);return e.addComponent("cc.Skeleton").skeletonData=this,t(null,e)}reset(){this._skeletonCache=null,this._atlasCache=null}resetEnums(){}getRuntimeData(t){if(this._skeletonCache)return this._skeletonCache;if(!(this.textures&&this.textures.length>0)&&this.textureNames&&this.textureNames.length>0)return t||console.error(`${this.name} no textures found!`),null;const e=this._getAtlas(t);if(!e)return null;const i=new ynt.AtlasAttachmentLoader(e);let n=null,s=null;return this.skeletonJson?(s=new ynt.SkeletonJson(i),n=this.skeletonJson):(s=new ynt.SkeletonBinary(i),n=new Uint8Array(this._nativeAsset)),s.scale=this.scale,this._skeletonCache=s.readSkeletonData(n),e.dispose(),this._skeletonCache}getSkinsEnum(){if(this._skinsEnum)return this._skinsEnum;const t=this.getRuntimeData(!0);if(t){const e=t.skins,i={};for(let t=0;t<e.length;t++)i[e[t].name]=t;return this._skinsEnum=jt(i)}return null}getAnimsEnum(){if(this._animsEnum&&Object.keys(this._animsEnum).length>1)return this._animsEnum;const t=this.getRuntimeData(!0);if(t){const e={"<None>":0},i=t.animations;for(let t=0;t<i.length;t++)e[i[t].name]=t+1;return this._animsEnum=jt(e)}return null}destroy(){return qnt.sharedCache.removeSkeleton(this._uuid),super.destroy()}_getTexture(t){const e=this.textureNames;for(let i=0;i<e.length;i++)if(e[i]===t){const t=this.textures[i],e=new Knt({width:t.width,height:t.height});return e.setRealTexture(t),e}return console.error(`${this.name} no textures found!`),null}_getAtlas(t){return this._atlasCache?this._atlasCache:this.atlasText?this._atlasCache=new ynt.TextureAtlas(this.atlasText,this._getTexture.bind(this)):(t||console.error(`${this.name} no atlas found!`),null)}}).prototype,"_skeletonJson",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sst=sc(ist.prototype,"textures",[Sc,Qnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rst=sc(ist.prototype,"textureNames",[Sc,tst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ost=sc(ist.prototype,"scale",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ast=sc(ist.prototype,"_atlasText",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),est=ist))||est);l.internal.SpineSkeletonData=cst;class lst extends ew{constructor(){super(),this._skeletons=new Set}static getInstance(){return lst._instance||(lst._instance=new lst,mw.registerSystem(lst.ID,lst._instance,ew.Priority.HIGH)),lst._instance}add(t){t&&(this._skeletons.has(t)||this._skeletons.add(t))}remove(t){t&&this._skeletons.has(t)&&this._skeletons.delete(t)}postUpdate(t){this._skeletons&&this._skeletons.forEach((e=>{e.updateAnimation(t)}))}}var hst,_st,ust,dst,mst,pst,fst,gst,vst,yst,xst,Sst,Cst,Ast,bst,Tst,Est,Pst,wst,Ist,Rst,Dst,Mst,Ost,Bst,Nst,Lst,Fst,zst,Vst,Gst,Ust,kst,Hst,jst,Wst,qst,Xst,Yst,Kst,Jst,$st,Zst,Qst,trt,ert,irt,nrt,srt,rrt,ort;let art,crt,lrt,hrt;function _rt(t,e,i){Le.Attr.setClassAttr(t,e,"type","Enum"),Le.Attr.setClassAttr(t,e,"enumList",jt.getList(i))}lst.ID="SKELETON",lst._instance=void 0,function(t){t[t.default=0]="default"}(art||(art={})),Xt(art),function(t){t[t["<None>"]=0]="<None>"}(crt||(crt={})),Xt(crt),function(t){t[t.REALTIME=0]="REALTIME",t[t.SHARED_CACHE=1]="SHARED_CACHE",t[t.PRIVATE_CACHE=2]="PRIVATE_CACHE"}(lrt||(lrt={})),Xt(lrt),function(t){t[t.COLORED_TEXTURED=0]="COLORED_TEXTURED",t[t.TWO_COLORED=1]="TWO_COLORED"}(hrt||(hrt={}));let urt=(hst=dc("sp.Skeleton.SpineSocket"),_st=Kc(iS),hst((mst=sc((dst=class{constructor(t="",e=null){nc(this,"path",mst,this),nc(this,"target",pst,this),this.path=t,this.target=e}}).prototype,"path",[Sc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),pst=sc(dst.prototype,"target",[_st,Mc,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ust=dst))||ust);Ut.setClassAlias(urt,"sp.Skeleton.SpineSocket");let drt=(fst=dc("sp.Skeleton"),gst=Dc(),vst=Pc(),yst=Kc(sg),xst=kc(),Sst=Nc(),Cst=Kc(cst),Ast=Nc(),bst=Kc(art),Tst=Lc(),Est=Nc(),Pst=Kc(crt),wst=Lc(),Ist=Nc(),Rst=Lc(),Dst=Kc(lrt),Mst=Lc(),Ost=Lc(),Bst=Lc(),Nst=Lc(),Lst=Lc(),Fst=Lc(),zst=Lc(),Vst=Kc([urt]),Gst=Lc(),Ust=Oc(),kst=Oc(),fst(Hst=gst(Hst=vst(Hst=Ec((ort=rrt=class t extends HO{get drawList(){return this._drawList}get customMaterial(){return this._customMaterial}set customMaterial(t){this._customMaterial=t,this._cleanMaterialCache()}get paused(){return this._paused}set paused(t){this._paused=t}get skeletonData(){return this._skeletonData}set skeletonData(t){t&&t.resetEnums(),this._skeletonData!==t&&(this.destroyRenderData(),this._skeletonData=t,this._needUpdateSkeltonData=!0,this.defaultSkin="",this.defaultAnimation="",this._updateSkeletonData())}get animation(){if(this.isAnimationCached())return this._animationName;const t=this.getCurrent(0);return t&&t.animation.name||""}set animation(t){t?(this.setAnimation(0,t,this.loop),this.markForUpdateRenderData()):this.isAnimationCached()||(this.clearTrack(0),this.setToSetupPose())}get _defaultSkinIndex(){if(this.skeletonData){const t=this.skeletonData.getSkinsEnum();if(t)if(""===this.defaultSkin){if(t.hasOwnProperty(0))return this._defaultSkinIndex=0,0}else{const e=t[this.defaultSkin];if(void 0!==e)return e}}return 0}set _defaultSkinIndex(t){let e;if(this.skeletonData&&(e=this.skeletonData.getSkinsEnum()),!e)return void console.error(`${this.name} skin enums are invalid`);const i=e[t];void 0!==i?(this.defaultSkin=i,this.setSkin(this.defaultSkin)):console.error(`${this.name} skin enums are invalid`)}get _animationIndex(){const t=this.animation;if(this.skeletonData)if(t){const e=this.skeletonData.getAnimsEnum();if(e){const i=e[t];if(void 0!==i)return i}}else this._refreshInspector();return 0}set _animationIndex(t){let e;if(this.skeletonData&&(e=this.skeletonData.getAnimsEnum()),!e)return void console.error(`${this.name} animation enums are invalid`);const i=e[t];void 0!==i?(this.animation=i,this.animation=i):console.error(`${this.name} animation enums are invalid`)}get defaultCacheMode(){return this._defaultCacheMode}set defaultCacheMode(t){this._defaultCacheMode=t,this.setAnimationCacheMode(this._defaultCacheMode)}get premultipliedAlpha(){return this._premultipliedAlpha}set premultipliedAlpha(t){t!==this._premultipliedAlpha&&(this._premultipliedAlpha=t,this.markForUpdateRenderData())}get timeScale(){return this._timeScale}set timeScale(t){t!==this._timeScale&&(this._timeScale=t)}get debugSlots(){return this._debugSlots}set debugSlots(t){t!==this._debugSlots&&(this._debugSlots=t,this._updateDebugDraw(),this.markForUpdateRenderData())}get debugBones(){return this._debugBones}set debugBones(t){t!==this._debugBones&&(this._debugBones=t,this._updateDebugDraw(),this.markForUpdateRenderData())}get debugMesh(){return this._debugMesh}set debugMesh(t){t!==this._debugMesh&&(this._debugMesh=t,this._updateDebugDraw(),this.markForUpdateRenderData())}get useTint(){return this._useTint}set useTint(t){t!==this._useTint&&(this._useTint=t,this._updateUseTint())}get sockets(){return this._sockets}set sockets(t){this._sockets=t,this._updateSocketBindings(),this.attachUtil._syncAttachedNode()}get socketNodes(){return this._socketNodes}constructor(){super(),nc(this,"loop",Wst,this),this._frameCache=null,this._curFrame=null,this._effectDelegate=null,this._skeleton=void 0,this._clipper=void 0,this._debugRenderer=void 0,this._startSlotIndex=void 0,this._endSlotIndex=void 0,this._startEntry=void 0,this._endEntry=void 0,this.attachUtil=void 0,this.maxVertexCount=0,this.maxIndexCount=0,this._materialCache={},this._enumSkins=jt({}),this._enumAnimations=jt({}),this._playTimes=0,nc(this,"_timeScale",qst,this),this._paused=!1,this._accTime=0,this._playCount=0,this._skeletonCache=null,this._animationName="",this._animationQueue=[],this._headAniInfo=null,this._isAniComplete=!0,this._needUpdateSkeltonData=!0,nc(this,"_useTint",Xst,this),nc(this,"_preCacheMode",Yst,this),nc(this,"_cacheMode",Kst,this),nc(this,"_defaultCacheMode",Jst,this),nc(this,"_debugBones",$st,this),nc(this,"_debugSlots",Zst,this),nc(this,"_skeletonData",Qst,this),nc(this,"_premultipliedAlpha",trt,this),nc(this,"defaultSkin",ert,this),nc(this,"defaultAnimation",irt,this),nc(this,"_sockets",nrt,this),this._drawIdx=0,this._drawList=new Ol((()=>({material:null,texture:null,indexOffset:0,indexCount:0})),1),nc(this,"_debugMesh",srt,this),this._rootBone=void 0,this._state=void 0,this._listener=void 0,this._socketNodes=new Map,this._cachedSockets=new Map,this._effectDelegate=null,this._skeleton=null,this._rootBone=null,this._listener=null,this._debugRenderer=null,this._startSlotIndex=-1,this._endSlotIndex=-1,this._startEntry={animation:{name:""},trackIndex:0},this._endEntry={animation:{name:""},trackIndex:0},this.attachUtil=new Ynt,_rt(this,"_defaultSkinIndex",this._enumSkins),_rt(this,"_animationIndex",this._enumAnimations),this._useVertexOpacity=!0}setSkeletonData(t){const e=this.node._uiProps.uiTransformComp;if(null!=t.width&&null!=t.height&&e.setContentSize(t.width,t.height),this._cacheMode===lrt.SHARED_CACHE?this._skeletonCache=qnt.sharedCache:this._cacheMode===lrt.PRIVATE_CACHE&&(this._skeletonCache=new qnt,this._skeletonCache.enablePrivateMode()),this.isAnimationCached()){(this.debugBones||this.debugSlots)&&y("Debug bones or slots is invalid in cached mode");const e=this._skeletonCache.getSkeletonCache(this.skeletonData._uuid,t);this._skeleton=e.skeleton,this._clipper=e.clipper,this._rootBone=this._skeleton.getRootBone()}else this._skeleton=new ynt.Skeleton(t),this._clipper=new ynt.SkeletonClipping,this._rootBone=this._skeleton.getRootBone();this._flushAssembler()}setSlotsRange(t,e){this.isAnimationCached()?y("Slots visible range can not be modified in cached mode."):(this._startSlotIndex=t,this._endSlotIndex=e)}setAnimationStateData(t){if(this.isAnimationCached())y("'setAnimationStateData' interface can not be invoked in cached mode.");else{const e=new ynt.AnimationState(t);this._listener&&(this._state&&this._state.removeListener(this._listener),e.addListener(this._listener)),this._state=e}}__preload(){super.__preload();const t=this.node.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];i&&"DEBUG_DRAW_NODE"===i.name&&i.destroy()}this._updateSkeletonData(),this._updateDebugDraw(),this._updateUseTint(),this._indexBoneSockets(),this._updateSocketBindings()}setAnimationCacheMode(t){this._preCacheMode!==t&&(this._cacheMode=t,this._needUpdateSkeltonData=!0,this._updateSkeletonData(),this._updateUseTint(),this._updateSocketBindings(),this.markForUpdateRenderData())}isAnimationCached(){return this._cacheMode!==lrt.REALTIME}updateAnimation(t){if(this.markForUpdateRenderData(),!this.paused)if(t*=1*this._timeScale,this.isAnimationCached()){if(this._isAniComplete){if(0===this._animationQueue.length&&!this._headAniInfo){const t=this._frameCache;if(t&&t.isInvalid()){t.updateToFrame();const e=t.frames;this._curFrame=e[e.length-1]}return}if(this._headAniInfo||(this._headAniInfo=this._animationQueue.shift()),this._accTime+=t,this._accTime>this._headAniInfo.delay){const t=this._headAniInfo;this._headAniInfo=null,this.setAnimation(0,t.animationName,t.loop)}return}this._updateCache(t)}else this._updateRealtime(t)}setVertexEffectDelegate(t){this._effectDelegate=t}setToSetupPose(){this._skeleton&&this._skeleton.setToSetupPose()}setBonesToSetupPose(){this._skeleton&&this._skeleton.setBonesToSetupPose()}setSlotsToSetupPose(){this._skeleton&&this._skeleton.setSlotsToSetupPose()}updateAnimationCache(t){if(!this.isAnimationCached())return;const e=this._skeletonData._uuid;this._skeletonCache&&this._skeletonCache.updateAnimationCache(e,t)}invalidAnimationCache(){this.isAnimationCached()&&this._skeletonCache&&this._skeletonCache.invalidAnimationCache(this._skeletonData._uuid)}findBone(t){return this._skeleton?this._skeleton.findBone(t):null}findSlot(t){return this._skeleton?this._skeleton.findSlot(t):null}setSkin(t){this._skeleton&&(this._skeleton.setSkinByName(t),this._skeleton.setSlotsToSetupPose()),this.invalidAnimationCache()}getAttachment(t,e){return this._skeleton?this._skeleton.getAttachmentByName(t,e):null}setAttachment(t,e){this._skeleton&&this._skeleton.setAttachment(t,e),this.invalidAnimationCache()}getTextureAtlas(t){return t.region}setMix(t,e,i){this._state&&this._state.data.setMix(t,e,i)}setAnimation(t,e,i){if(this._playTimes=i?0:1,this._animationName=e,this.isAnimationCached()){if(0!==t&&y("Track index can not greater than 0 in cached mode."),!this._skeletonCache)return null;let i=this._skeletonCache.getAnimationCache(this._skeletonData._uuid,e);i||(i=this._skeletonCache.initAnimationCache(this._skeletonData._uuid,e)),i&&(this._isAniComplete=!1,this._accTime=0,this._playCount=0,this._frameCache=i,this._socketNodes.size>0&&this._frameCache.enableCacheAttachedInfo(),this._frameCache.updateToFrame(0),this._curFrame=this._frameCache.frames[0])}else if(this._skeleton){const n=this._skeleton.data.findAnimation(e);if(!n)return P(7509,e),null;const s=this._state.setAnimationWith(t,n,i);return this._state.apply(this._skeleton),s}return null}addAnimation(t,e,i,n){if(n=n||0,this.isAnimationCached())0!==t&&y("Track index can not greater than 0 in cached mode."),this._animationQueue.push({animationName:e,loop:i,delay:n});else if(this._skeleton){var s;const r=this._skeleton.data.findAnimation(e);return r?null===(s=this._state)||void 0===s?void 0:s.addAnimationWith(t,r,i,n):(P(7510,e),null)}return null}findAnimation(t){return this._skeleton?this._skeleton.data.findAnimation(t):null}getCurrent(t){if(this.isAnimationCached())y("'getCurrent' interface can not be invoked in cached mode.");else if(this._state)return this._state.getCurrent(t);return null}clearTracks(){this.isAnimationCached()?y("'clearTracks' interface can not be invoked in cached mode."):this._state&&(this._state.clearTracks(),this.setToSetupPose())}clearTrack(t){this.isAnimationCached()?y("'clearTrack' interface can not be invoked in cached mode."):this._state&&this._state.clearTrack(t)}setStartListener(t){this._ensureListener(),this._listener.start=t}setInterruptListener(t){this._ensureListener(),this._listener.interrupt=t}setEndListener(t){this._ensureListener(),this._listener.end=t}setDisposeListener(t){this._ensureListener(),this._listener.dispose=t}setCompleteListener(t){this._ensureListener(),this._listener.complete=t}setEventListener(t){this._ensureListener(),this._listener.event=t}setTrackStartListener(t,e){fnt.getListeners(t).start=e}setTrackInterruptListener(t,e){fnt.getListeners(t).interrupt=e}setTrackEndListener(t,e){fnt.getListeners(t).end=e}setTrackDisposeListener(t,e){fnt.getListeners(t).dispose=e}setTrackCompleteListener(t,e){fnt.getListeners(t).complete=function(t){const i=Math.floor(t.trackTime/t.animationEnd);e(t,i)}}setTrackEventListener(t,e){fnt.getListeners(t).event=e}getState(){return this._state}onEnable(){super.onEnable(),this._flushAssembler(),lst.getInstance().add(this)}onDisable(){super.onDisable(),lst.getInstance().remove(this)}onDestroy(){this._cleanMaterialCache(),this._drawList.destroy(),super.onDestroy()}destroyRenderData(){this._drawList.reset(),super.destroyRenderData()}getMaterialForBlendAndTint(t,e,i){const n=`${i}/${t}/${e}`;let s=this._materialCache[n];if(s)return s;let r=this.customMaterial;null===r&&(r=Mf.get("default-spine-material"));let o=!1;switch(i){case hrt.TWO_COLORED:o=!0;break;case hrt.COLORED_TEXTURED:}return s=new dv({parent:r,subModelIdx:0,owner:this}),this._materialCache[n]=s,s.overridePipelineStates({blendState:{blendColor:hi.WHITE,targets:[{blendEq:gn.ADD,blendAlphaEq:gn.ADD,blendSrc:t,blendDst:e,blendSrcAlpha:t,blendDstAlpha:e}]}}),s.recompileShaders({TWO_COLORED:o,USE_LOCAL:!0}),s}onRestore(){this.updateMaterial(),this._renderFlag=this._canRender(),this.markForUpdateRenderData()}updateMaterial(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),void(this._blendHash=-1);const t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._updateBlendFunc(),this._blendHash=-1}querySockets(){return this._skeleton?(0===this._cachedSockets.size&&this._indexBoneSockets(),this._cachedSockets.size>0?Array.from(this._cachedSockets.keys()).sort():[]):[]}_requestDrawData(t,e,i,n){const s=this._drawList.add();return s.material=t,s.texture=e,s.indexOffset=i,s.indexCount=n,s}_render(t){if(this._renderData&&this._drawList){const e=this._renderData,i=e.chunk,n=i.vertexAccessor,s=e.getMeshBuffer(),r=s.indexOffset;n.appendIndices(i.bufferId,e.indices);for(let e=0;e<this._drawList.length;e++){this._drawIdx=e;const i=this._drawList.data[e];if(i.texture){const e=s.requireFreeIA(t.device);e.firstIndex=r+i.indexOffset,e.indexCount=i.indexCount,t.commitIA(this,e,i.texture,i.material,this.node)}}}}updateWorldTransform(){this.isAnimationCached()&&this._skeleton&&this._skeleton.updateWorldTransform()}_emitCacheCompleteEvent(){this._listener&&(this._endEntry.animation.name=this._animationName,this._listener.complete&&this._listener.complete(this._endEntry),this._listener.end&&this._listener.end(this._endEntry))}_updateCache(t){const e=this._frameCache;if(!e.isInited())return;const i=e.frames,n=qnt.FrameTime;0===this._accTime&&0===this._playCount&&(this._startEntry.animation.name=this._animationName,this._listener&&this._listener.start&&this._listener.start(this._startEntry)),this._accTime+=t;let s=Math.floor(this._accTime/n);if(e.isCompleted||(e.updateToFrame(s),this._renderData&&(this._renderData.vertexCount<e.maxVertexCount||this._renderData.indexCount<e.maxIndexCount)&&(this.maxVertexCount=e.maxVertexCount>this.maxVertexCount?e.maxVertexCount:this.maxVertexCount,this.maxIndexCount=e.maxIndexCount>this.maxIndexCount?e.maxIndexCount:this.maxIndexCount,this._renderData.resize(this.maxVertexCount,this.maxIndexCount),(!this._renderData.indices||this.maxIndexCount>this._renderData.indices.length)&&(this._renderData.indices=new Uint16Array(this.maxIndexCount)))),e.isCompleted&&s>=i.length){if(this._playCount++,this._playTimes>0&&this._playCount>=this._playTimes)return this._curFrame=i[i.length-1],this._accTime=0,this._playCount=0,this._isAniComplete=!0,void this._emitCacheCompleteEvent();this._accTime=0,s=0,this._emitCacheCompleteEvent()}this._curFrame=i[s]}_updateRealtime(t){const e=this._skeleton,i=this._state;e&&(e.update(t),i&&(i.update(t),i.apply(e)))}_indexBoneSockets(){if(!this._skeleton)return;this._cachedSockets.clear();const t=this._skeleton.bones,e=i=>null==i.parent?i.data.name||"<Unamed>":`${e(t[i.parent.data.index])}/${i.data.name}`;for(let i=0,n=t.length;i<n;i++){const n=t[i].data,s=e(t[i]);this._cachedSockets.set(s,n.index)}}_updateUseTint(){this._cleanMaterialCache(),this.destroyRenderData(),this._assembler&&this._skeleton&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())}_updateBatch(){this.markForUpdateRenderData()}_updateAnimEnum(){let t;t=this.skeletonData?this.skeletonData.getAnimsEnum():crt,this._enumAnimations=jt({}),Object.assign(this._enumAnimations,t),jt.update(this._enumAnimations),_rt(this,"_animationIndex",this._enumAnimations)}_updateSkinEnum(){let t;t=this.skeletonData?this.skeletonData.getSkinsEnum():art,this._enumSkins=jt({}),Object.assign(this._enumSkins,t),jt.update(this._enumSkins),_rt(this,"_defaultSkinIndex",this._enumSkins)}_ensureListener(){this._listener||(this._listener=new fnt,this._state&&this._state.addListener(this._listener))}_updateSkeletonData(){if(!this.skeletonData||!1===this._needUpdateSkeltonData)return;this._needUpdateSkeltonData=!1;const t=this.skeletonData.getRuntimeData();if(t){try{this.setSkeletonData(t),this.isAnimationCached()||this.setAnimationStateData(new ynt.AnimationStateData(this._skeleton.data)),this.defaultSkin&&this.setSkin(this.defaultSkin)}catch(t){y(t)}this._indexBoneSockets(),this.attachUtil.init(this),this._preCacheMode=this._cacheMode,this.animation=this.defaultAnimation}}_refreshInspector(){this._updateAnimEnum(),this._updateSkinEnum()}_updateDebugDraw(){if(this.debugBones||this.debugSlots||this.debugMesh){if(!this._debugRenderer){const t=new iS("DEBUG_DRAW_NODE");t.hideFlags|=il.Flags.DontSave|il.Flags.HideInHierarchy;const e=t.addComponent(KN);e.lineWidth=1,e.strokeColor=new hi(255,0,0,255),this._debugRenderer=e,t.parent=this.node}this.isAnimationCached()&&y("Debug bones or slots is invalid in cached mode")}else this._debugRenderer&&(this._debugRenderer.node.destroy(),this._debugRenderer=null)}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._skeleton&&this._assembler&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData(),this._updateColor())}_updateSocketBindings(){if(this._skeleton){this._socketNodes.clear();for(let t=0,e=this._sockets.length;t<e;t++){const e=this._sockets[t];if(e.path&&e.target){const t=this._cachedSockets.get(e.path);if(!t){console.error(`Skeleton data does not contain path ${e.path}`);continue}this._socketNodes.set(t,e.target)}}}}_verifySockets(t){for(let e=0,i=t.length;e<i;e++){const i=t[e].target;!i||i.parent&&i.parent===this.node||console.error(`Target node ${i.name} is expected to be a direct child of ${this.node.name}`)}const e=new Map;t.forEach((t=>{t.target&&(e.get(t.target)?console.error(`Target node ${t.target.name} has existed.`):e.set(t.target,!0))}))}_cleanMaterialCache(){for(const t in this._materialCache)this._materialCache[t].destroy();this._materialCache={}}},rrt.SpineSocket=urt,rrt.AnimationCacheMode=lrt,sc((jst=ort).prototype,"customMaterial",[Jc,yst,xst,Sst],Object.getOwnPropertyDescriptor(jst.prototype,"customMaterial"),jst.prototype),sc(jst.prototype,"skeletonData",[Mc,Cst],Object.getOwnPropertyDescriptor(jst.prototype,"skeletonData"),jst.prototype),sc(jst.prototype,"_defaultSkinIndex",[Ast,bst,Tst],Object.getOwnPropertyDescriptor(jst.prototype,"_defaultSkinIndex"),jst.prototype),sc(jst.prototype,"_animationIndex",[Est,Pst,wst],Object.getOwnPropertyDescriptor(jst.prototype,"_animationIndex"),jst.prototype),sc(jst.prototype,"defaultCacheMode",[Ist,Rst,Mc,Dst],Object.getOwnPropertyDescriptor(jst.prototype,"defaultCacheMode"),jst.prototype),Wst=sc(jst.prototype,"loop",[Sc,Mst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sc(jst.prototype,"premultipliedAlpha",[Mc,Ost],Object.getOwnPropertyDescriptor(jst.prototype,"premultipliedAlpha"),jst.prototype),sc(jst.prototype,"timeScale",[Bst,Mc],Object.getOwnPropertyDescriptor(jst.prototype,"timeScale"),jst.prototype),sc(jst.prototype,"debugSlots",[Mc,Nst],Object.getOwnPropertyDescriptor(jst.prototype,"debugSlots"),jst.prototype),sc(jst.prototype,"debugBones",[Mc,Lst],Object.getOwnPropertyDescriptor(jst.prototype,"debugBones"),jst.prototype),sc(jst.prototype,"debugMesh",[Mc,Fst],Object.getOwnPropertyDescriptor(jst.prototype,"debugMesh"),jst.prototype),sc(jst.prototype,"useTint",[Mc,zst],Object.getOwnPropertyDescriptor(jst.prototype,"useTint"),jst.prototype),sc(jst.prototype,"sockets",[Vst,Gst],Object.getOwnPropertyDescriptor(jst.prototype,"sockets"),jst.prototype),qst=sc(jst.prototype,"_timeScale",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Xst=sc(jst.prototype,"_useTint",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yst=sc(jst.prototype,"_preCacheMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Kst=sc(jst.prototype,"_cacheMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lrt.REALTIME}}),Jst=sc(jst.prototype,"_defaultCacheMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lrt.REALTIME}}),$st=sc(jst.prototype,"_debugBones",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zst=sc(jst.prototype,"_debugSlots",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qst=sc(jst.prototype,"_skeletonData",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),trt=sc(jst.prototype,"_premultipliedAlpha",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ert=sc(jst.prototype,"defaultSkin",[Sc,Ust],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),irt=sc(jst.prototype,"defaultAnimation",[kst,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),nrt=sc(jst.prototype,"_sockets",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),srt=sc(jst.prototype,"_debugMesh",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hst=jst))||Hst)||Hst)||Hst)||Hst);l.internal.SpineSkeleton=drt;const mrt=[0,1,2,2,3,0],prt=new hi(0,0,255,255),frt=new hi(255,0,0,255),grt=new hi(0,255,0,255),vrt=new hi(255,255,0,255),yrt=new ynt.Color(1,1,1,1),xrt=new ynt.Color(1,1,1,1),Srt=new ynt.Vector2,Crt=new ynt.Vector2;let Art,brt,Trt,Ert,Prt,wrt,Irt,Rrt,Drt,Mrt,Ort,Brt;const Nrt=new Float32Array(4),Lrt=new Float32Array(4);let Frt,zrt,Vrt,Grt,Urt,krt,Hrt,jrt,Wrt,qrt,Xrt,Yrt,Krt,Jrt,$rt,Zrt,Qrt,tot,eot,iot,not,sot,rot,oot,aot=0,cot=0,lot=0,hot=0,_ot=0,uot=0,dot=0,mot=0,pot=null,fot=null,got=null;function vot(t){let e,i;switch(t){case ynt.BlendMode.Additive:e=Art?fn.ONE:fn.SRC_ALPHA,i=fn.ONE;break;case ynt.BlendMode.Multiply:e=fn.DST_COLOR,i=fn.ONE_MINUS_SRC_ALPHA;break;case ynt.BlendMode.Screen:e=fn.ONE,i=fn.ONE_MINUS_SRC_COLOR;break;case ynt.BlendMode.Normal:default:e=Art?fn.ONE:fn.SRC_ALPHA,i=fn.ONE_MINUS_SRC_ALPHA}return eot.getMaterialForBlendAndTint(e,i,Prt?hrt.TWO_COLORED:hrt.COLORED_TEXTURED)}function yot(t){Jrt=t.fa*Brt,brt=Art?Jrt/255:1,jrt=Drt*brt,Wrt=Mrt*brt,qrt=Ort*brt,Xrt=t.fr*jrt,Yrt=t.fg*Wrt,Krt=t.fb*qrt,Nrt[0]=Xrt/255,Nrt[1]=Yrt/255,Nrt[2]=Krt/255,Nrt[3]=Jrt/255,$rt=t.dr*jrt,Zrt=t.dg*Wrt,Qrt=t.db*qrt,tot=Art?255:0,Lrt[0]=$rt/255,Lrt[1]=Zrt/255,Lrt[2]=Qrt/255,Lrt[3]=tot/255}const xot=new Float32Array(4);function Sot(t){return xot[0]=t.r/255,xot[1]=t.g/255,xot[2]=t.b/255,xot[3]=t.a/255,xot}let Cot=null,Aot=null;const bot={vCount:32767,ensureAccessor(t){let e=t?Aot:Cot;if(!e){const i=mw.root.device,n=mw.root.batcher2D,s=t?kM:UM;t?(e=Aot=new Ck(i,s,this.vCount),n.registerBufferAccessor(Number.parseInt("SPINETINT",36),Aot)):(e=Cot=new Ck(i,s,this.vCount),n.registerBufferAccessor(Number.parseInt("SPINE",36),Cot))}return e},createData(t){let e=t.renderData;if(!e){const i=t.useTint||t.isAnimationCached(),n=this.ensureAccessor(i),s=t._skeleton.data.skins;let r=0,o=0;for(let t=0;t<s.length;++t){const e=s[t].attachments;for(let t=0;t<e.length;t++){const i=e[t];for(const t in i){const e=i[t];e instanceof ynt.RegionAttachment?(r+=4,o+=6):e instanceof ynt.MeshAttachment&&(r+=e.worldVerticesLength>>1,o+=e.triangles.length)}}}e=KM.add(i?kM:UM,n),e.resize(r,o),e.indices&&o===e.indices.length||(e.indices=new Uint16Array(o)),t.maxVertexCount=r,t.maxIndexCount=o}return e},updateRenderData(t,e){eot=t;const i=t._skeleton;!t.isAnimationCached()&&i&&i.updateWorldTransform(),i&&function(t){if(!t._skeleton)return;const e=t.color;Drt=e.r/255,Mrt=e.g/255,Ort=e.b/255,Brt=t.node._uiProps.opacity,Prt=t.useTint||t.isAnimationCached(),Frt=Prt?13:9,t.drawList.reset(),eot=t,iot=t.node,not=t.renderData,fot=null,Hrt=!0,Art=t.premultipliedAlpha,brt=1,oot=!1,pot=t._effectDelegate&&t._effectDelegate._vertexEffect,(4294967295!==e._val||Art)&&(oot=!0),t.isAnimationCached()?function(){const t=eot._curFrame;if(!t)return;const e=t.segments;if(0===e.length)return;zrt=12,hot=0,_ot=0,lot=0,uot=0;let i=null;const n=t.vertices,s=t.indices;let r=0,o=0,a=0,c=0;const l=t.colors;let h=0,_=l[h++],u=_.vfOffset;yot(_);let d=0;const m=not,p=m.chunk.vb,f=m.indices;for(let t=0,g=e.length;t<g;t++){const g=e[t];if(i=vot(g.blendMode),i){if(fot||(fot=i),Hrt||i.hash!==fot.hash||g.tex&&g.tex!==got){Hrt=!1;const t=uot-d;t>0&&(eot._requestDrawData(fot,got,d,t),d=uot),fot=i,got=g.tex}cot=g.vertexCount,_ot=g.indexCount,r=m.chunk.vertexOffset;for(let t=uot,e=uot+_ot;t<e;t++)f[t]=r+lot+s[a++];if(c=g.vfCount,p.set(n.subarray(o,o+c),o),oot){let t=o/13*6;for(let e=o,i=o+c;e<i;e+=Frt,t+=6)t>=u&&(_=l[h++],yot(_),u=_.vfOffset),p.set(Nrt,e+5),p.set(Lrt,e+9)}o+=c,lot+=cot,uot+=_ot,cot=0,_ot=0}}const g=uot-d;got&&g>0&&eot._requestDrawData(fot,got,d,g)}():(pot&&pot.begin(t._skeleton),function(){const t=not;rot=t.chunk.vb,sot=t.indices,dot=eot.maxVertexCount,mot=eot.maxIndexCount;const e=eot._skeleton,i=e.color,n=eot._debugRenderer,s=eot._clipper;let r,o,a,c,l,h,_,u=null;Trt=eot._startSlotIndex,Ert=eot._endSlotIndex,krt=!1,-1===Trt&&(krt=!0),wrt=eot.debugSlots,Irt=eot.debugBones,Rrt=eot.debugMesh,n&&(Irt||wrt||Rrt)&&(n.clear(),n.lineWidth=5),zrt=12,aot=0,lot=0,hot=0,_ot=0,uot=0;let d=0;for(let m=0,p=e.drawOrder.length;m<p;m++){if(_=e.drawOrder[m],void 0===_||!_.bone.active)continue;if(Trt>=0&&Trt===_.data.index&&(krt=!0),!krt){s.clipEndWithSlot(_);continue}if(Ert>=0&&Ert===_.data.index&&(krt=!1),aot=0,_ot=0,r=_.getAttachment(),!r){s.clipEndWithSlot(_);continue}if(c=r instanceof ynt.RegionAttachment,l=r instanceof ynt.MeshAttachment,h=r instanceof ynt.ClippingAttachment,h){s.clipStart(_,r);continue}if(!c&&!l){s.clipEndWithSlot(_);continue}const p=r.region.texture.getRealTexture();if(u=vot(_.data.blendMode),!u){s.clipEndWithSlot(_);continue}if(fot||(fot=u),Hrt||u.hash!==fot.hash||p&&got!==p){Hrt=!1;const t=uot-d;t>0&&(eot._requestDrawData(fot,got,d,t),d=uot),got=p,fot=u}if(c){if(a=mrt,cot=4,aot=cot*Frt,_ot=6,r.computeWorldVertices(_.bone,rot,hot,Frt),n&&wrt){n.strokeColor=prt,n.moveTo(rot[hot],rot[hot+1]);for(let t=hot+Frt,e=hot+aot;t<e;t+=Frt)n.lineTo(rot[t],rot[t+1]);n.close(),n.stroke()}}else if(l){const t=r;if(a=t.triangles,cot=t.worldVerticesLength>>1,aot=cot*Frt,_ot=a.length,t.computeWorldVertices(_,0,t.worldVerticesLength,rot,hot,Frt),n&&Rrt){n.strokeColor=vrt;for(let t=0,e=a.length;t<e;t+=3){const e=a[t]*Frt+hot,i=a[t+1]*Frt+hot,s=a[t+2]*Frt+hot;n.moveTo(rot[e],rot[e+1]),n.lineTo(rot[i],rot[i+1]),n.lineTo(rot[s],rot[s+1]),n.close(),n.stroke()}}}if(0===aot||0===_ot){s.clipEndWithSlot(_);continue}const f=r;sot=t.indices,sot.set(a,uot),o=f.uvs;for(let t=hot,e=hot+aot,i=0;t<e;t+=Frt,i+=2)rot[t+3]=o[i],rot[t+4]=o[i+1];if(Tot(i,f.color,_.color,s,_),_ot>0){const e=t.chunk.vertexOffset;for(let t=uot,i=uot+_ot;t<i;t++)sot[t]+=lot+e}hot+=aot,lot+=cot,uot+=_ot,cot=0,_ot=0,s.clipEndWithSlot(_)}const m=uot-d;if(got&&m>0&&eot._requestDrawData(fot,got,d,m),s.clipEnd(),n&&Irt){let t;n.strokeColor=frt,n.fillColor=prt;for(let i=0,s=e.bones.length;i<s;i++){t=e.bones[i];const s=t.data.length*t.a+t.worldX,r=t.data.length*t.c+t.worldY;n.moveTo(t.worldX,t.worldY),n.lineTo(s,r),n.stroke(),n.circle(t.worldX,t.worldY,1.5*Math.PI),n.fill(),0===i&&(n.fillColor=grt)}}}(),pot&&pot.end()),(Prt?Aot:Cot).getMeshBuffer(not.chunk.bufferId).setDirty(),t.attachUtil._syncAttachedNode(),iot=void 0,eot=void 0,pot=null}(t)},updateColor(t){t&&(eot=t,eot.markForUpdateRenderData())},fillBuffers(t,e){}};function Tot(t,e,i,n,s){if(yrt.a=i.a*e.a*t.a*Brt*255,brt=Art?yrt.a:255,Vrt=Drt*e.r*t.r*brt,Grt=Mrt*e.g*t.g*brt,Urt=Ort*e.b*t.b*brt,yrt.r=Vrt*i.r,yrt.g=Grt*i.g,yrt.b=Urt*i.b,null==s.darkColor?xrt.set(0,0,0,1):(xrt.r=s.darkColor.r*Vrt,xrt.g=s.darkColor.g*Grt,xrt.b=s.darkColor.b*Urt),xrt.a=Art?255:0,n.isClipping()){zrt=Prt?12:8;const t=rot.subarray(hot),e=rot.subarray(hot+3);n.clipTriangles(t,aot,sot.subarray(uot),_ot,e,yrt,xrt,Prt,Frt);const i=n.clippedVertices,s=n.clippedTriangles;if(function(t,e){const i=cot,n=_ot,s=not;_ot=e.length,cot=t.length/zrt,aot=cot*Frt,dot+=cot-i,mot+=_ot-n;const r=sot,o=s.chunk.vertexOffset;let a=!1;if(dot>s.vertexCount&&(s.resizeAndCopy(dot,mot>s.indexCount?mot:s.indexCount),rot=s.chunk.vb,a=!0),mot>sot.length&&(sot=s.indices=new Uint16Array(mot),a=!0),a){const t=s.chunk.vertexOffset-o;for(let e=0;e<uot;++e)sot[e]=r[e]+t}}(i,s),s.length>0&&sot.set(s,uot),pot)for(let t=0,e=i.length,n=hot;t<e;t+=zrt,n+=Frt)Srt.x=i[t],Srt.y=i[t+1],yrt.set(i[t+2],i[t+3],i[t+4],i[t+5]),Crt.x=i[t+6],Crt.y=i[t+7],Prt?xrt.set(i[t+8],i[t+9],i[t+10],i[t+11]):xrt.set(0,0,0,0),pot.transform(Srt,Crt,yrt,xrt),rot[n]=Srt.x,rot[n+1]=Srt.y,rot[n+3]=Crt.x,rot[n+4]=Crt.y,rot.set(Sot(yrt),n+5),Prt&&rot.set(Sot(xrt),n+9);else for(let t=0,e=i.length,n=hot;t<e;t+=zrt,n+=Frt)rot[n]=i[t],rot[n+1]=i[t+1],rot[n+3]=i[t+6],rot[n+4]=i[t+7],rot[n+5]=i[t+2]/255,rot[n+6]=i[t+3]/255,rot[n+7]=i[t+4]/255,rot[n+8]=i[t+5]/255,Prt&&(rot[n+9]=i[t+8]/255,rot[n+10]=i[t+9]/255,rot[n+11]=i[t+10]/255,rot[n+12]=i[t+11]/255)}else if(pot)for(let t=hot,e=hot+aot;t<e;t+=Frt)Srt.x=rot[t],Srt.y=rot[t+1],Crt.x=rot[t+3],Crt.y=rot[t+4],pot.transform(Srt,Crt,yrt,xrt),rot[t]=Srt.x,rot[t+1]=Srt.y,rot[t+3]=Crt.x,rot[t+4]=Crt.y,rot.set(Sot(yrt),t+5),Prt&&rot.set(Sot(xrt),t+9);else{Nrt.set(Sot(yrt)),Lrt.set(Sot(xrt));for(let t=hot,e=hot+aot;t<e;t+=Frt)rot.set(Nrt,t+5),Prt&&rot.set(Lrt,t+9)}}l.internal.SpineAssembler=bot;const Eot={getAssembler:()=>bot};drt.Assembler=Eot;const Pot=window.spine,wot=Pot.VertexEffectDelegate;let Iot,Rot,Dot,Mot,Oot,Bot,Not,Lot,Fot;!function(t){t[t.REGION=0]="REGION",t[t.BOUNDING_BOX=1]="BOUNDING_BOX",t[t.MESH=2]="MESH",t[t.SKINNED_MESH=3]="SKINNED_MESH"}(Iot||(Iot={})),Xt(Iot),function(t){t[t.START=0]="START",t[t.INTERRUPT=1]="INTERRUPT",t[t.END=2]="END",t[t.DISPOSE=3]="DISPOSE",t[t.COMPLETE=4]="COMPLETE",t[t.EVENT=5]="EVENT"}(Rot||(Rot={})),Xt(Rot),l.internal.SpineAnimationEventType=Rot,t("sp",Object.freeze({__proto__:null,timeScale:1,get DefaultSkinsEnum(){return art},get DefaultAnimsEnum(){return crt},get AnimationCacheMode(){return lrt},get SpineMaterialType(){return hrt},SpineSocket:urt,Skeleton:drt,SkeletonData:cst,simpleSpineAssembler:Eot,spine:Pot,VertexEffectDelegate:wot,get ATTACHMENT_TYPE(){return Iot},get AnimationEventType(){return Rot}})),function(t){t[t.ORTHO=0]="ORTHO",t[t.HEX=1]="HEX",t[t.ISO=2]="ISO"}(Dot||(Dot={})),Xt(Dot),function(t){t[t.NONE=0]="NONE",t[t.MAP=1]="MAP",t[t.LAYER=2]="LAYER",t[t.OBJECTGROUP=3]="OBJECTGROUP",t[t.OBJECT=4]="OBJECT",t[t.TILE=5]="TILE"}(Mot||(Mot={})),Xt(Mot),function(t){t[t.HORIZONTAL=2147483648]="HORIZONTAL",t[t.VERTICAL=1073741824]="VERTICAL",t[t.DIAGONAL=536870912]="DIAGONAL",t[t.FLIPPED_ALL=4026531840]="FLIPPED_ALL",t[t.FLIPPED_MASK=268435455]="FLIPPED_MASK"}(Oot||(Oot={})),Xt(Oot),function(t){t[t.STAGGERAXIS_X=0]="STAGGERAXIS_X",t[t.STAGGERAXIS_Y=1]="STAGGERAXIS_Y"}(Bot||(Bot={})),Xt(Bot),function(t){t[t.STAGGERINDEX_ODD=0]="STAGGERINDEX_ODD",t[t.STAGGERINDEX_EVEN=1]="STAGGERINDEX_EVEN"}(Not||(Not={})),Xt(Not),function(t){t[t.RightDown=0]="RightDown",t[t.RightUp=1]="RightUp",t[t.LeftDown=2]="LeftDown",t[t.LeftUp=3]="LeftUp"}(Lot||(Lot={})),Xt(Lot),function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.POLYGON=2]="POLYGON",t[t.POLYLINE=3]="POLYLINE",t[t.IMAGE=4]="IMAGE",t[t.TEXT=5]="TEXT"}(Fot||(Fot={})),Xt(Fot);class zot{constructor(){this.name="",this.firstGid=0,this.spacing=0,this.margin=0,this.sourceImage=void 0,this.imageName=null,this.imageSize=new Gi(0,0),this.tileOffset=new Oi(0,0),this._tileSize=new Gi(0,0),this.collection=!1}rectForGID(t,e){const i=e||new ki(0,0,0,0);i.width=this._tileSize.width,i.height=this._tileSize.height;let n=t;n&=Oot.FLIPPED_MASK,n-=this.firstGid;const s=Math.floor((this.imageSize.width-2*this.margin+this.spacing)/(this._tileSize.width+this.spacing));return i.x=Math.round(n%s*(this._tileSize.width+this.spacing)+this.margin),i.y=Math.round(Math.floor(n/s)*(this._tileSize.height+this.spacing)+this.margin),i}}class Vot{constructor(){this.properties={},this.name="",this.objects=[],this.visible=!0,this.opacity=0,this.color=new hi(255,255,255,255),this.offset=new Oi(0,0),this.draworder="topdown",this.tintColor=null}getProperties(){return this.properties}setProperties(t){this.properties=t}}class Got{constructor(){this.properties={},this.name="",this.layerSize=null,this.tiles=[],this.visible=!0,this.opacity=0,this.ownTiles=!0,this.minGID=1e5,this.maxGID=0,this.offset=new Oi(0,0),this.tintColor=null}getProperties(){return this.properties}setProperties(t){this.properties=t}}Got.ATTRIB_NONE=1,Got.ATTRIB_BASE64=2,Got.ATTRIB_GZIP=4,Got.ATTRIB_ZLIB=8;class Uot{constructor(){this.name="",this.visible=!0,this.width=0,this.height=0,this.offset=new Oi(0,0),this.opacity=0,this.trans=new hi(255,255,255,255),this.sourceImage=void 0,this.tintColor=null}}function kot(t){const e=lN.HorizontalAlign;switch(t){case"center":return e.CENTER;case"right":return e.RIGHT;default:return e.LEFT}}function Hot(t){const e=lN.VerticalAlign;switch(t){case"center":return e.CENTER;case"bottom":return e.BOTTOM;default:return e.TOP}}function jot(t){if(!t)return new hi(0,0,0,255);if(8===(t=-1!==t.indexOf("#")?t.substring(1):t).length){const e=parseInt(t.substr(0,2),16)||255,i=parseInt(t.substr(2,2),16)||0,n=parseInt(t.substr(4,2),16)||0,s=parseInt(t.substr(6,2),16)||0;return new hi(i,n,s,e)}{const e=parseInt(t.substr(0,2),16)||0,i=parseInt(t.substr(2,2),16)||0,n=parseInt(t.substr(4,2),16)||0;return new hi(e,i,n,255)}}function Wot(t,e){const i=[],n=t.getElementsByTagName("properties");for(let t=0;t<n.length;++t){const e=n[t].getElementsByTagName("property");for(let t=0;t<e.length;++t)i.push(e[t])}e=e||{};for(let t=0;t<i.length;t++){const n=i[t],s=n.getAttribute("name"),r=n.getAttribute("type")||"string";let o=n.getAttribute("value");"int"===r?o=parseInt(o):"float"===r?o=parseFloat(o):"bool"===r?o="true"===o:"color"===r&&(o=jot(o)),e[s]=o}return e}class qot{get mapSize(){return this._mapSize}get tileSize(){return this._tileSize}constructor(t,e,i,n,s){this.properties={},this.orientation=null,this.parentElement=null,this.parentGID=0,this.layerAttrs=0,this.storingCharacters=!1,this.currentString=null,this.renderOrder=Lot.RightDown,this._supportVersion=[1,4,0],this._objectGroups=[],this._allChildren=[],this._mapSize=new Gi(0,0),this._tileSize=new Gi(0,0),this._layers=[],this._tilesets=[],this._imageLayers=[],this._tileProperties=new Map,this._tileAnimations={},this._tsxContentMap=null,this._spriteFrameMap=null,this._spfSizeMap={},this._staggerAxis=null,this._staggerIndex=null,this._hexSideLength=0,this._imageLayerSPF=null,this.initWithXML(t,e,i,n,s)}getOrientation(){return this.orientation}setOrientation(t){this.orientation=t}getStaggerAxis(){return this._staggerAxis}setStaggerAxis(t){this._staggerAxis=t}getStaggerIndex(){return this._staggerIndex}setStaggerIndex(t){this._staggerIndex=t}getHexSideLength(){return this._hexSideLength}setHexSideLength(t){this._hexSideLength=t}getMapSize(){return new Gi(this._mapSize.width,this._mapSize.height)}setMapSize(t){this._mapSize.width=t.width,this._mapSize.height=t.height}get mapWidth(){return this._mapSize.width}set mapWidth(t){this._mapSize.width=t}get mapHeight(){return this._mapSize.height}set mapHeight(t){this._mapSize.height=t}getTileSize(){return new Gi(this._tileSize.width,this._tileSize.height)}setTileSize(t){this._tileSize.width=t.width,this._tileSize.height=t.height}get tileWidth(){return this._tileSize.width}set tileWidth(t){this._tileSize.width=t}get tileHeight(){return this._tileSize.height}set tileHeight(t){this._tileSize.height=t}getLayers(){return this._layers}setLayers(t){this._allChildren.push(t),this._layers.push(t)}getImageLayers(){return this._imageLayers}setImageLayers(t){this._allChildren.push(t),this._imageLayers.push(t)}getTilesets(){return this._tilesets}setTilesets(t){this._tilesets.push(t)}getObjectGroups(){return this._objectGroups}setObjectGroups(t){this._allChildren.push(t),this._objectGroups.push(t)}getAllChildren(){return this._allChildren}getParentElement(){return this.parentElement}setParentElement(t){this.parentElement=t}getParentGID(){return this.parentGID}setParentGID(t){this.parentGID=t}getLayerAttribs(){return this.layerAttrs}setLayerAttribs(t){this.layerAttrs=t}getStoringCharacters(){return this.storingCharacters}setStoringCharacters(t){this.storingCharacters=t}getProperties(){return this.properties}setProperties(t){this.properties=t}initWithXML(t,e,i,n,s){return this._tilesets.length=0,this._layers.length=0,this._imageLayers.length=0,this._tsxContentMap=e,this._spriteFrameMap=i,this._imageLayerSPF=s,this._spfSizeMap=n,this._objectGroups.length=0,this._allChildren.length=0,this.properties={},this._tileProperties=new Map,this._tileAnimations=new Map,this.currentString="",this.storingCharacters=!1,this.layerAttrs=Got.ATTRIB_NONE,this.parentElement=null,this.parseXMLString(t)}parseXMLString(t,e){let i;const n=(new mI).parse(t).documentElement,s=n.getAttribute("orientation"),r=n.getAttribute("staggeraxis"),o=n.getAttribute("staggerindex"),a=n.getAttribute("hexsidelength"),c=n.getAttribute("renderorder"),l=n.getAttribute("version")||"1.0.0";if("map"===n.nodeName){const t=l.split("."),e=this._supportVersion;for(i=0;i<e.length;i++){const n=parseInt(t[i])||0;if(e[i]<n){P(7216,l);break}}"orthogonal"===s?this.orientation=Dot.ORTHO:"isometric"===s?this.orientation=Dot.ISO:"hexagonal"===s?this.orientation=Dot.HEX:null!==s&&P(7217,s),this.renderOrder="right-up"===c?Lot.RightUp:"left-up"===c?Lot.LeftUp:"left-down"===c?Lot.LeftDown:Lot.RightDown,"x"===r?this.setStaggerAxis(Bot.STAGGERAXIS_X):"y"===r&&this.setStaggerAxis(Bot.STAGGERAXIS_Y),"odd"===o?this.setStaggerIndex(Not.STAGGERINDEX_ODD):"even"===o&&this.setStaggerIndex(Not.STAGGERINDEX_EVEN),a&&this.setHexSideLength(parseFloat(a));let h=new Gi(0,0);h.width=parseFloat(n.getAttribute("width")),h.height=parseFloat(n.getAttribute("height")),this.setMapSize(h),h=new Gi(0,0),h.width=parseFloat(n.getAttribute("tilewidth")),h.height=parseFloat(n.getAttribute("tileheight")),this.setTileSize(h),this.properties=Wot(n)}let h=n.getElementsByTagName("tileset");for("map"!==n.nodeName&&(h=[],h.push(n)),i=0;i<h.length;i++){const t=h[i],n=t.getAttribute("source");if(n){const e=parseInt(t.getAttribute("firstgid")),i=this._tsxContentMap[n];i&&this.parseXMLString(i,e)}else{const i=t.getElementsByTagName("image"),n=i.length>1,s=i[0];let r=s.getAttribute("source");r=r.replace(/\\/g,"/");const o=t.getElementsByTagName("tile"),a=o&&o.length||1;let c=null;const l=t.getAttribute("name")||"",h=parseInt(t.getAttribute("spacing"))||0,_=parseInt(t.getAttribute("margin"))||0,u=e||parseInt(t.getAttribute("firstgid"))||0,d=new Gi(0,0);d.width=parseFloat(t.getAttribute("tilewidth")),d.height=parseFloat(t.getAttribute("tileheight"));const m=t.getElementsByTagName("tileoffset")[0];let p=0,f=0;m&&(p=parseFloat(m.getAttribute("x"))||0,f=parseFloat(m.getAttribute("y"))||0);let g=null;for(let t=0;t<a;t++){const e=i[t]?i[t]:s;if(!e)continue;let r=e.getAttribute("source");if(r=r.replace(/\\/g,"/"),!g||n){if(g=new zot,g.name=l,g.firstGid=u&Oot.FLIPPED_MASK,g.tileOffset.x=p,g.tileOffset.y=f,g.collection=n,!n&&(g.imageName=r,g.imageSize.width=parseFloat(e.getAttribute("width"))||0,g.imageSize.height=parseFloat(e.getAttribute("height"))||0,g.sourceImage=this._spriteFrameMap[r],!g.sourceImage)){const t=qot.getNameWithPostfix(r);if(g.imageName=t,g.sourceImage=this._spriteFrameMap[t],!g.sourceImage){const t=qot.getShortName(r);g.imageName=t,g.sourceImage=this._spriteFrameMap[t],g.sourceImage||(console.error(`[error]: ${t} not find in [${Object.keys(this._spriteFrameMap).join(", ")}]`),D(7221,r),console.warn(`Please try asset type of ${r} to 'sprite-frame'`))}}g.spacing=h,g.margin=_,g._tileSize.width=d.width,g._tileSize.height=d.height,this.setTilesets(g)}if(c=o&&o[t],!c)continue;this.parentGID=u+(parseInt(c.getAttribute("id"))||0);const a=c.getElementsByTagName("image");if(a&&a.length>0){const t=a[0];let e=t.getAttribute("source");if(e=e.replace(/\\/g,"/"),g.imageName=e,g.imageSize.width=parseFloat(t.getAttribute("width"))||0,g.imageSize.height=parseFloat(t.getAttribute("height"))||0,g._tileSize.width=g.imageSize.width,g._tileSize.height=g.imageSize.height,g.sourceImage=this._spriteFrameMap[e],!g.sourceImage){const t=qot.getNameWithPostfix(e);if(g.imageName=t,g.sourceImage=this._spriteFrameMap[t],!g.sourceImage){const t=qot.getShortName(e);g.imageName=t,g.sourceImage=this._spriteFrameMap[t],g.sourceImage||(D(7221,e),console.warn(`Please try asset type of ${e} to 'sprite-frame'`))}}g.firstGid=this.parentGID&Oot.FLIPPED_MASK}const m=(Oot.FLIPPED_MASK&this.parentGID)>>>0;this._tileProperties.set(m,Wot(c));const v=c.getElementsByTagName("animation");if(v&&v.length>0){const t=v[0].getElementsByTagName("frame"),e={frames:[],dt:0,frameIdx:0};this._tileAnimations.set(m,e);const i=e.frames;for(let e=0;e<t.length;e++){const n=t[e],s=u+(parseInt(n.getAttribute("tileid"))||0),r=parseFloat(n.getAttribute("duration"))||0;i.push({tileid:s,duration:r/1e3,grid:null})}}}}}const _=n.childNodes;for(i=0;i<_.length;i++){const t=_[i];if(!this._shouldIgnoreNode(t)){if("imagelayer"===t.nodeName){const e=this._parseImageLayer(t);e&&this.setImageLayers(e)}if("layer"===t.nodeName){const e=this._parseLayer(t);this.setLayers(e)}if("objectgroup"===t.nodeName){const e=this._parseObjectGroup(t);this.setObjectGroups(e)}}}return n}_shouldIgnoreNode(t){return 3===t.nodeType||8===t.nodeType||4===t.nodeType}_parseImageLayer(t){const e=t.getElementsByTagName("image");if(!e||0===e.length)return null;const i=new Uot;i.name=t.getAttribute("name"),i.offset.x=parseFloat(t.getAttribute("offsetx"))||0,i.offset.y=parseFloat(t.getAttribute("offsety"))||0;const n=t.getAttribute("visible");i.visible=!("0"===n);const s=t.getAttribute("opacity");i.opacity=s?Math.round(255*parseFloat(s)):255;const r=t.getAttribute("tintcolor");i.tintColor=r?jot(r):null;const o=e[0],a=o.getAttribute("source");return i.sourceImage=this._imageLayerSPF[a],i.width=parseInt(o.getAttribute("width"))||0,i.height=parseInt(o.getAttribute("height"))||0,i.trans=jot(o.getAttribute("trans")),i.sourceImage?i:(D(7221,a),console.warn(`Please try asset type of ${a} to 'sprite-frame'`),null)}_parseLayer(t){const e=t.getElementsByTagName("data")[0],i=new Got;i.name=t.getAttribute("name");const n=new Gi(0,0);n.width=parseFloat(t.getAttribute("width")),n.height=parseFloat(t.getAttribute("height")),i.layerSize=n;const s=t.getAttribute("visible");i.visible=!("0"===s);const r=t.getAttribute("opacity");i.opacity=r?Math.round(255*parseFloat(r)):255,i.offset=new Oi(parseFloat(t.getAttribute("offsetx"))||0,parseFloat(t.getAttribute("offsety"))||0);const o=t.getAttribute("tintcolor");i.tintColor=o?jot(o):null;let a="";for(let t=0;t<e.childNodes.length;t++)a+=e.childNodes[t].nodeValue;a=a.trim();const c=e.getAttribute("compression"),l=e.getAttribute("encoding");if(c&&"gzip"!==c&&"zlib"!==c)return P(7218),null;let h;switch(c){case"gzip":h=F5.unzipBase64AsArray(a,4);break;case"zlib":h=function(t){if(t.length%4!=0)return null;const e=t.length/4,i=window.Uint32Array?new Uint32Array(e):[];for(let n=0;n<e;n++){const e=4*n;i[n]=t[e]+256*t[e+1]+65536*t[e+2]+t[e+3]*(1<<24)}return i}(new N4.Inflate(F5.Base64.decodeAsArray(a,1)).decompress());break;case null:case"":if("base64"===l)h=F5.Base64.decodeAsArray(a,4);else if("csv"===l){h=[];const t=a.split(",");for(let e=0;e<t.length;e++)h.push(parseInt(t[e]))}else{const t=e.getElementsByTagName("tile");h=[];for(let e=0;e<t.length;e++)h.push(parseInt(t[e].getAttribute("gid")))}break;default:this.layerAttrs===Got.ATTRIB_NONE&&P(7219)}return h&&(i.tiles=new Uint32Array(h)),i.properties=Wot(t),i}_parseObjectGroup(t){const e=new Vot;e.name=t.getAttribute("name")||"",e.offset=new Oi(parseFloat(t.getAttribute("offsetx")),parseFloat(t.getAttribute("offsety")));const i=t.getAttribute("opacity");e.opacity=i?Math.round(255*parseFloat(i)):255;const n=t.getAttribute("tintcolor");e.tintColor=n?jot(n):null;const s=t.getAttribute("visible");s&&0===parseInt(s)&&(e.visible=!1);const r=t.getAttribute("color");r&&e.color.fromHEX(r);const o=t.getAttribute("draworder");o&&(e.draworder=o),e.setProperties(Wot(t));const a=t.getElementsByTagName("object");if(a){for(let t=0;t<a.length;t++){const i=a[t],n={};n.id=i.getAttribute("id")||t,n.name=i.getAttribute("name")||"",n.width=parseFloat(i.getAttribute("width"))||0,n.height=parseFloat(i.getAttribute("height"))||0,n.x=parseFloat(i.getAttribute("x"))||0,n.y=parseFloat(i.getAttribute("y"))||0,n.rotation=parseFloat(i.getAttribute("rotation"))||0,Wot(i,n);const s=i.getAttribute("visible");n.visible=!(s&&0===parseInt(s));const r=i.getElementsByTagName("text");if(r&&r.length>0){const t=r[0];n.type=Fot.TEXT,n.wrap="1"===t.getAttribute("wrap"),n.color=jot(t.getAttribute("color")),n.halign=kot(t.getAttribute("halign")),n.valign=Hot(t.getAttribute("valign")),n.pixelsize=parseInt(t.getAttribute("pixelsize"))||16,n.text=t.childNodes[0].nodeValue}const o=i.getAttribute("gid");o&&(n.gid=parseInt(o),n.type=Fot.IMAGE);const c=i.getElementsByTagName("ellipse");c&&c.length>0&&(n.type=Fot.ELLIPSE);const l=i.getElementsByTagName("polygon");if(l&&l.length>0){n.type=Fot.POLYGON;const t=l[0].getAttribute("points");t&&(n.points=this._parsePointsString(t))}const h=i.getElementsByTagName("polyline");if(h&&h.length>0){n.type=Fot.POLYLINE;const t=h[0].getAttribute("points");t&&(n.polylinePoints=this._parsePointsString(t))}n.type||(n.type=Fot.RECT),e.objects.push(n)}"index"!==o&&e.objects.sort(((t,e)=>t.y-e.y))}return e}_parsePointsString(t){if(!t)return null;const e=[],i=t.split(" ");for(let t=0;t<i.length;t++){const n=i[t].split(",");e.push({x:parseFloat(n[0]),y:parseFloat(n[1])})}return e}setTileAnimations(t){this._tileAnimations=t}getTileAnimations(){return this._tileAnimations}getTileProperties(){return this._tileProperties}setTileProperties(t){this._tileProperties=t}getCurrentString(){return this.currentString}setCurrentString(t){this.currentString=t}static getNameWithPostfix(t){const e=(t=t.replace(/\\/g,"/")).lastIndexOf("/")+1,i=t.length;return t.substring(e,i)}static getShortName(t){const e=(t=t.replace(/\\/g,"/")).lastIndexOf("/")+1;let i=t.lastIndexOf(".");return i=i<0?t.length:i,t.substring(e,i)}}var Xot,Yot,Kot,Jot,$ot,Zot,Qot,tat,eat,iat,nat,sat,rat;let oat=t("TiledTile",(Xot=dc("cc.TiledTile"),Yot=Dc(),Kot=Pc(),Jot=mc(SO),$ot=Kc(pe),Zot=Kc(pe),Qot=Kc(pe),tat=Kc(pe),eat=Kc(pe),Xot(iat=Yot(iat=Kot(iat=Jot(iat=Ec((sat=sc((nat=class extends Lh{constructor(){super(),this._layer=null,nc(this,"_x",sat,this),nc(this,"_y",rat,this)}get x(){return this._x}set x(t){t!==this._x&&(this._layer&&this._layer.isInvalidPosition(t,this._y)?y("Invalid x, the valid value is between [%s] ~ [%s]",0,this._layer.layerSize.width):(this._resetTile(),this._x=t,this.updateInfo()))}get y(){return this._y}set y(t){t!==this._y&&(this._layer&&this._layer.isInvalidPosition(this._x,t)?y("Invalid y, the valid value is between [%s] ~ [%s]",0,this._layer.layerSize.height):(this._resetTile(),this._y=t,this.updateInfo()))}get grid(){return this._layer?this._layer.getTileGIDAt(this._x,this._y):0}set grid(t){this._layer&&this._layer.setTileGIDAt(t,this._x,this._y)}onEnable(){const t=this.node.parent;this._layer=t.getComponent("cc.TiledLayer"),this._resetTile(),this.updateInfo()}onDisable(){this._resetTile()}_resetTile(){this._layer&&this._layer.getTiledTileAt(this._x,this._y)===this&&this._layer.setTiledTileAt(this._x,this._y,null)}updateInfo(){if(!this._layer)return;const t=this._x,e=this._y;if(this._layer.getTiledTileAt(t,e))return void y("There is already a TiledTile at [%s, %s]",t,e);const i=this._layer.getPositionAt(t,e);this.node.setPosition(i.x,i.y),this._layer.setTiledTileAt(t,e,this)}}).prototype,"_x",[$ot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rat=sc(nat.prototype,"_y",[Zot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sc(nat.prototype,"x",[Qot],Object.getOwnPropertyDescriptor(nat.prototype,"x"),nat.prototype),sc(nat.prototype,"y",[tat],Object.getOwnPropertyDescriptor(nat.prototype,"y"),nat.prototype),sc(nat.prototype,"grid",[eat],Object.getOwnPropertyDescriptor(nat.prototype,"grid"),nat.prototype),iat=nat))||iat)||iat)||iat)||iat)||iat));function aat(t,e,i){const n=i||t.sourceImage,s=n.texture,r=t.collection;if(!t.imageSize.width||!t.imageSize.height){const e=t.sourceImage;t.imageSize.width=e.width,t.imageSize.height=e.height}const o=t.imageSize.width,a=t.imageSize.height,c=t._tileSize.width,l=t._tileSize.height,h=n.width,_=n.height,u=t.spacing,d=t.margin;let m=1;if(!r){const t=Math.floor((o-2*d+u)/(c+u)),e=Math.floor((a-2*d+u)/(l+u));m=Math.max(1,e*t)}const p=t.firstGid;let f=null,g=!!e.get(p);const v=t.firstGid+m;let y=p;for(;y<v&&(g&&!e.get(y)&&(g=!1),g||!e.get(y));++y){if(f={tileset:t,x:0,y:0,width:c,height:l,t:0,l:0,r:0,b:0,cx:0,cy:0,offsetX:0,offsetY:0,rotated:!1,gid:y,spriteFrame:n,texture:s},t.rectForGID(y,f),!i||m>1)if(i){f._name=i.name;const t=i.unbiasUV[0],e=i.rotated?i.unbiasUV[1]:i.unbiasUV[5];f.l=t+(f.x+.5)/h,f.t=e+(f.y+.5)/_,f.r=t+(f.x+f.width-.5)/h,f.b=e+(f.y+f.height-.5)/_,f._rect=new ki(f.x,f.y,f.width,f.height)}else f.l=f.x/h,f.t=f.y/_,f.r=(f.x+f.width)/h,f.b=(f.y+f.height)/_,f._rect=new ki(f.x,f.y,f.width,f.height);else i.rotated?(f._rotated=!0,f._name=i.name,f._rect=i.getRect(),f.l=i.unbiasUV[0],f.t=i.unbiasUV[1],f.r=i.unbiasUV[4],f.b=i.unbiasUV[3]):(f._name=i.name,f._rect=i.getRect(),f.l=i.unbiasUV[0],f.t=i.unbiasUV[5],f.r=i.unbiasUV[2],f.b=i.unbiasUV[1]);f.cx=(f.l+f.r)/2,f.cy=(f.t+f.b)/2,e.set(y,f)}}var cat,lat;const hat=new Ii,_at=new Oi,uat=new mi,dat=new mi,mat={row:0,col:0};let pat=t("TiledUserNodeData",dc("cc.TiledUserNodeData")(cat=class extends Lh{constructor(){super(),this._index=-1,this._row=-1,this._col=-1,this._tiledLayer=null}})||cat),fat=t("TiledLayer",dc("cc.TiledLayer")(lat=class t extends HO{get cullingRect(){return this._cullingRect}get rightTop(){return this._rightTop}get layerSize(){return this._layerSize}get meshRenderDataArray(){return this._meshRenderDataArray}get leftDownToCenterX(){return this._leftDownToCenterX}get leftDownToCenterY(){return this._leftDownToCenterY}constructor(){super(),this._userNodeGrid={},this._userNodeMap={},this._userNodeDirty=!1,this.tiledTiles=[],this._viewPort={x:-1,y:-1,width:-1,height:-1},this._cullingRect={leftDown:{row:-1,col:-1},rightTop:{row:-1,col:-1}},this._cullingDirty=!0,this._rightTop={row:-1,col:-1},this._layerInfo=null,this._mapInfo=null,this._topOffset=0,this._downOffset=0,this._leftOffset=0,this._rightOffset=0,this.tiles=[],this.vertices=[],this._verticesDirty=!0,this._layerName="",this._layerSize=void 0,this._minGID=void 0,this._maxGID=void 0,this._layerOrientation=null,this._opacity=void 0,this._tintColor=void 0,this.texGrids=null,this._textures=[],this._tilesets=[],this._leftDownToCenterX=0,this._leftDownToCenterY=0,this._hasTiledNodeGrid=!1,this._hasAniGrid=!1,this._animations=null,this._enableCulling=void 0,this.colorChanged=!1,this._properties=void 0,this.renderOrder=void 0,this._staggerAxis=void 0,this._staggerIndex=void 0,this._hexSideLength=void 0,this._mapTileSize=void 0,this._odd_even=void 0,this._diffX1=void 0,this._diffY1=void 0,this._useAutomaticVertexZ=void 0,this._vertexZvalue=void 0,this._offset=void 0,this._meshRenderDataArray=null,this._meshRenderDataArrayIdx=0}hasTiledNode(){return this._hasTiledNodeGrid}hasAnimation(){return this._hasAniGrid}set enableCulling(t){this._enableCulling!==t&&(this._enableCulling=t,this._cullingDirty=!0,this.markForUpdateRenderData())}get enableCulling(){return this._enableCulling}addUserNode(t){let e=t.getComponent(pat);return e?(y("CCTiledLayer:addUserNode node has been added"),!1):(e=t.addComponent(pat),t.parent=this.node,this._userNodeMap[t.uuid]=e,e._row=-1,e._col=-1,e._tiledLayer=this,this._nodeLocalPosToLayerPos(t.getPosition(),_at),this._positionToRowCol(_at.x,_at.y,mat),this._addUserNodeToGrid(e,mat),this._updateCullingOffsetByUserNode(t),t.on(fx.TRANSFORM_CHANGED,this._userNodePosChange,e),t.on(fx.SIZE_CHANGED,this._userNodeSizeChange,e),!0)}removeUserNode(t){const e=t.getComponent(pat);return e?(t.off(fx.TRANSFORM_CHANGED,this._userNodePosChange,e),t.off(fx.SIZE_CHANGED,this._userNodeSizeChange,e),this._removeUserNodeFromGrid(e),delete this._userNodeMap[t.uuid],t._removeComponent(e),e.destroy(),t.removeFromParent(),!0):(y("CCTiledLayer:removeUserNode node is not exist"),!1)}destroyUserNode(t){this.removeUserNode(t),t.destroy()}_nodeLocalPosToLayerPos(t,e){e.x=t.x+this._leftDownToCenterX,e.y=t.y+this._leftDownToCenterY}getNodesByRowCol(t,e){const i=this._userNodeGrid[t];return i?i[e]:null}getNodesCountByRow(t){const e=this._userNodeGrid[t];return e?e.count:0}_updateAllUserNode(){this._userNodeGrid={};for(const t in this._userNodeMap){const e=this._userNodeMap[t];this._nodeLocalPosToLayerPos(e.node.getPosition(),_at),this._positionToRowCol(_at.x,_at.y,mat),this._addUserNodeToGrid(e,mat),this._updateCullingOffsetByUserNode(e.node)}}_updateCullingOffsetByUserNode(t){const e=t._uiProps.uiTransformComp.contentSize;this._topOffset<e.height&&(this._topOffset=e.height),this._downOffset<e.height&&(this._downOffset=e.height),this._leftOffset<e.width&&(this._leftOffset=e.width),this._rightOffset<e.width&&(this._rightOffset=e.width)}_userNodeSizeChange(){const t=this.node,e=this._tiledLayer;e._updateCullingOffsetByUserNode(t),e._userNodeDirty=!0,e.markForUpdateRenderData()}_userNodePosChange(){const t=this,e=t.node,i=t._tiledLayer;i._nodeLocalPosToLayerPos(e.getPosition(),_at),i._positionToRowCol(_at.x,_at.y,mat),i._limitInLayer(mat),mat.row===t._row&&mat.col===t._col||(i._removeUserNodeFromGrid(t),i._addUserNodeToGrid(t,mat))}_removeUserNodeFromGrid(t){const e=t._row,i=t._col,n=t._index,s=this._userNodeGrid[e],r=s&&s[i];r&&(s.count--,r.count--,r.list[n]=null,r.count<=0&&(r.list.length=0,r.count=0)),t._row=-1,t._col=-1,t._index=-1,this._userNodeDirty=!0,this.markForUpdateRenderData()}_limitInLayer(t){const e=t.row,i=t.col;e<0&&(t.row=0),e>this._rightTop.row&&(t.row=this._rightTop.row),i<0&&(t.col=0),i>this._rightTop.col&&(t.col=this._rightTop.col)}_addUserNodeToGrid(t,e){const i=e.row,n=e.col,s=this._userNodeGrid[i]=this._userNodeGrid[i]||{count:0},r=s[n]=s[n]||{count:0,list:[]};t._row=i,t._col=n,t._index=r.list.length,s.count++,r.count++,r.list.push(t),this._userNodeDirty=!0}isUserNodeDirty(){return this._userNodeDirty}setUserNodeDirty(t){this._userNodeDirty=t}onEnable(){super.onEnable(),this.node.on(fx.ANCHOR_CHANGED,this._syncAnchorPoint,this),this.node.on(fx.TRANSFORM_CHANGED,this.updateCulling,this),this.node.on(fx.SIZE_CHANGED,this.updateCulling,this),this.node.parent.on(fx.TRANSFORM_CHANGED,this.updateCulling,this),this.node.parent.on(fx.SIZE_CHANGED,this.updateCulling,this),this.markForUpdateRenderData(),this.scheduleOnce(this.updateCulling.bind(this))}onDisable(){var t,e;super.onDisable(),null===(t=this.node.parent)||void 0===t||t.off(fx.SIZE_CHANGED,this.updateCulling,this),null===(e=this.node.parent)||void 0===e||e.off(fx.TRANSFORM_CHANGED,this.updateCulling,this),this.node.off(fx.SIZE_CHANGED,this.updateCulling,this),this.node.off(fx.TRANSFORM_CHANGED,this.updateCulling,this),this.node.off(fx.ANCHOR_CHANGED,this._syncAnchorPoint,this)}_syncAnchorPoint(){const t=this.node,e=t._uiProps.uiTransformComp,i=t.getScale();this._leftDownToCenterX=e.width*e.anchorX*i.x,this._leftDownToCenterY=e.height*e.anchorY*i.y,this._cullingDirty=!0,this.markForUpdateRenderData()}getLayerName(){return this._layerName}setLayerName(t){this._layerName=t}getProperty(t){return this._properties[t]}getPositionAt(t,e){let i;switch(void 0!==e?(i=Math.floor(t),e=Math.floor(e)):(i=Math.floor(t.x),e=Math.floor(t.y)),this._layerOrientation){case Dot.ORTHO:return this._positionForOrthoAt(i,e);case Dot.ISO:return this._positionForIsoAt(i,e);case Dot.HEX:return this._positionForHexAt(i,e)}return null}isInvalidPosition(t,e){return t>=this._layerSize.width||e>=this._layerSize.height||t<0||e<0}_positionForIsoAt(t,e){let i=0,n=0;const s=Math.floor(t)+Math.floor(e)*this._layerSize.width,r=this.tiles[s];if(r){const t=(r&Oot.FLIPPED_MASK)>>>0,e=this.texGrids.get(t).tileset.tileOffset;i=e.x,n=e.y}return new Oi(.5*this._mapTileSize.width*(this._layerSize.height+t-e-1)+i,.5*this._mapTileSize.height*(this._layerSize.width-t+this._layerSize.height-e-2)-n)}_positionForOrthoAt(t,e){let i=0,n=0;const s=Math.floor(t)+Math.floor(e)*this._layerSize.width,r=this.tiles[s];if(r){const t=(r&Oot.FLIPPED_MASK)>>>0,e=this.texGrids.get(t).tileset.tileOffset;i=e.x,n=e.y}return new Oi(t*this._mapTileSize.width+i,(this._layerSize.height-e-1)*this._mapTileSize.height-n)}_positionForHexAt(t,e){const i=this._mapTileSize.width,n=this._mapTileSize.height,s=this._layerSize.height,r=Math.floor(t)+Math.floor(e)*this._layerSize.width,o=(this.tiles[r]&Oot.FLIPPED_MASK)>>>0;let a;a=this.texGrids.get(o)?this.texGrids.get(o).tileset.tileOffset:{x:0,y:0};const c=this._staggerIndex===Not.STAGGERINDEX_ODD?1:-1;let l=0,h=0,_=0,u=0;switch(this._staggerAxis){case Bot.STAGGERAXIS_Y:_=0,e%2==1&&(_=i/2*c),l=t*i+_+a.x,h=(s-e-1)*(n-(n-this._hexSideLength)/2)-a.y;break;case Bot.STAGGERAXIS_X:u=0,t%2==1&&(u=n/2*-c),l=t*(i-(i-this._hexSideLength)/2)+a.x,h=(s-e-1)*n+u-a.y}return new Oi(l,h)}setTilesGIDAt(t,e,i,n){if(!t||0===t.length||n<=0)return;i<0&&(i=0),e<0&&(e=0);let s=0;const r=e+n;for(let n=i;;n++)for(let i=e;i<r;i++){if(s>=t.length)return;this._updateTileForGID(t[s],i,n),s++}}setTileGIDAt(t,e,i,n){const s=(t&Oot.FLIPPED_MASK)>>>0;if(e=Math.floor(e),i=Math.floor(i),this.isInvalidPosition(e,i))throw new Error("cc.TiledLayer.setTileGIDAt(): invalid position");this.tiles&&this._tilesets&&0!==this._tilesets.length?0!==s&&s<this._tilesets[0].firstGid?P(7239,t):(n=n||0,this._updateTileForGID((s|n)>>>0,e,i)):P(7238)}_updateTileForGID(t,e,i){const n=0|e+i*this._layerSize.width;if(n>=this.tiles.length)return;if(t===this.tiles[n])return;const s=(t&Oot.FLIPPED_MASK)>>>0;this.texGrids.get(s)?(this.tiles[n]=t,this._updateVertex(e,i)):this.tiles[n]=0,this._cullingDirty=!0}getTileGIDAt(t,e){if(this.isInvalidPosition(t,e))throw new Error("cc.TiledLayer.getTileGIDAt(): invalid position");if(!this.tiles)return P(7237),null;const i=Math.floor(t)+Math.floor(e)*this._layerSize.width;return(this.tiles[i]&Oot.FLIPPED_MASK)>>>0}getTileFlagsAt(t,e){if(this.isInvalidPosition(t,e))throw new Error("TiledLayer.getTileFlagsAt: invalid position");if(!this.tiles)return P(7240),null;const i=Math.floor(t)+Math.floor(e)*this._layerSize.width;return(this.tiles[i]&Oot.FLIPPED_ALL)>>>0}setCullingDirty(t){this._cullingDirty=t}isCullingDirty(){return this._cullingDirty}updateViewPort(t,e,i,n){if(this._viewPort.width===i&&this._viewPort.height===n&&this._viewPort.x===t&&this._viewPort.y===e)return;this._viewPort.x=t,this._viewPort.y=e,this._viewPort.width=i,this._viewPort.height=n;let s=1;this._layerOrientation===Dot.ISO&&(s=2);const r=this._viewPort.x-this._offset.x+this._leftDownToCenterX,o=this._viewPort.y-this._offset.y+this._leftDownToCenterY;let a=r-this._leftOffset,c=o-this._downOffset;const l=r+i+this._rightOffset,h=o+n+this._topOffset,_=this._cullingRect.leftDown,u=this._cullingRect.rightTop;a<0&&(a=0),c<0&&(c=0),this._positionToRowCol(a,c,mat),mat.row-=s,mat.col-=s,mat.row=mat.row>0?mat.row:0,mat.col=mat.col>0?mat.col:0,mat.row===_.row&&mat.col===_.col||(_.row=mat.row,_.col=mat.col,this._cullingDirty=!0),l<0||h<0?(mat.row=-1,mat.col=-1):(this._positionToRowCol(l,h,mat),mat.row++,mat.col++),mat.row>this._rightTop.row&&(mat.row=this._rightTop.row),mat.col>this._rightTop.col&&(mat.col=this._rightTop.col),mat.row===u.row&&mat.col===u.col||(u.row=mat.row,u.col=mat.col,this._cullingDirty=!0,this.markForUpdateRenderData())}_positionToRowCol(t,e,i){const n=this._mapTileSize.width,s=this._mapTileSize.height,r=.5*n,o=.5*s;let a=0,c=0,l=0,h=0;const _=this._staggerAxis;switch(this._layerOrientation){case Dot.ORTHO:c=Math.floor(t/n),a=Math.floor(e/s);break;case Dot.ISO:c=Math.floor(t/r),a=Math.floor(e/o);break;case Dot.HEX:_===Bot.STAGGERAXIS_Y?(a=Math.floor(e/(s-this._diffY1)),l=a%2==1?r*this._odd_even:0,c=Math.floor((t-l)/n)):(c=Math.floor(t/(n-this._diffX1)),h=c%2==1?o*-this._odd_even:0,a=Math.floor((e-h)/s))}return i.row=a,i.col=c,i}updateCulling(){if(this._enableCulling){this.node.updateWorldTransform(),Ii.invert(hat,this.node.getWorldMatrix());const t=mw.root.batcher2D.getFirstRenderCamera(this.node);t&&(uat.x=0,uat.y=0,uat.z=0,dat.x=t.width,dat.y=t.height,dat.z=0,t.screenToWorld(uat,uat),t.screenToWorld(dat,dat),mi.transformMat4(uat,uat,hat),mi.transformMat4(dat,dat,hat),this.updateViewPort(uat.x,uat.y,dat.x-uat.x,dat.y-uat.y))}}getLayerOrientation(){return this._layerOrientation}getProperties(){return this._properties}_updateVertex(t,e){const i=Oot.FLIPPED_MASK,n=this.vertices,s=this._layerOrientation,r=this.tiles;if(!r)return;const o=this._rightTop,a=this._mapTileSize.width,c=this._mapTileSize.height,l=.5*a,h=.5*c,_=this._layerSize.height,u=this._layerSize.width,d=this.texGrids;let m,p,f,g,v,y,x=0,S=0;s===Dot.HEX&&(m=this._staggerAxis,p=this._diffX1,f=this._diffY1,g=this._odd_even);let C=0,A=0,b=0,T=0,E=0,P=0,w=0;const I=e*u+t;b=(r[I]&i)>>>0;const R=d.get(b);if(!R)return;switch(this._animations.get(b)&&(this._hasAniGrid=this._hasAniGrid||!0),s){case Dot.ORTHO:C=t,A=_-e-1,x=C*a,S=A*c;break;case Dot.ISO:C=_+t-e-1,A=_+u-t-e-2,x=l*C,S=h*A;break;case Dot.HEX:v=m===Bot.STAGGERAXIS_Y&&e%2==1?l*g:0,y=m===Bot.STAGGERAXIS_X&&t%2==1?h*-g:0,x=t*(a-p)+v,S=(_-e-1)*(c-f)+y,C=t,A=_-e-1}const D=n[A]=n[A]||{minCol:0,maxCol:0},M=D[C]=D[C]||{};D.minCol>C&&(D.minCol=C),D.maxCol<C&&(D.maxCol=C),o.row<A&&(o.row=A,s===Dot.ISO&&(o.row+=1)),o.col<C&&(o.col=C,s===Dot.ISO&&(o.col+=1));const O=R.tileset.tileOffset;x+=this._offset.x+O.x+R.offsetX,S+=this._offset.y-O.y-R.offsetY,T=-O.y+R.tileset._tileSize.height-c,T=T<0?0:T,E=O.y<0?0:O.y,P=-O.x<0?0:-O.x,w=O.x+R.tileset._tileSize.width-a,w=w<0?0:w,this._rightOffset<P&&(this._rightOffset=P),this._leftOffset<w&&(this._leftOffset=w),this._topOffset<E&&(this._topOffset=E),this._downOffset<T&&(this._downOffset=T),M.left=x,M.bottom=S,M.index=I,this._cullingDirty=!0}_updateVertices(){if(this.vertices.length=0,!this.tiles)return;const t=this._rightTop;t.row=-1,t.col=-1;const e=this._layerSize.height,i=this._layerSize.width;this._topOffset=0,this._downOffset=0,this._leftOffset=0,this._rightOffset=0,this._hasAniGrid=!1;for(let t=0;t<e;++t)for(let e=0;e<i;++e)this._updateVertex(e,t);this._verticesDirty=!1}getTiledTileAt(t,e,i){if(this.isInvalidPosition(t,e))throw new Error("TiledLayer.getTiledTileAt: invalid position");if(!this.tiles)return P(7236),null;const n=Math.floor(t)+Math.floor(e)*this._layerSize.width;let s=this.tiledTiles[n];if(!s&&i){const i=new iS;return s=i.addComponent(oat),s._x=t,s._y=e,s._layer=this,s.updateInfo(),i.parent=this.node,s}return s}setTiledTileAt(t,e,i){if(this.isInvalidPosition(t,e))throw new Error("TiledLayer.setTiledTileAt: invalid position");if(!this.tiles)return P(7236),null;const n=Math.floor(t)+Math.floor(e)*this._layerSize.width;return this.tiledTiles[n]=i,this._cullingDirty=!0,this._hasTiledNodeGrid=!!i||this.tiledTiles.some((t=>!!t)),i}getTexture(t){return t=t||0,this._textures&&t>=0&&this._textures.length>t?this._textures[t]:null}getTextures(){return this._textures}setTexture(t){this.setTextures([t])}setTextures(t){this._textures=t,this.markForUpdateRenderData()}getLayerSize(){return this._layerSize}getMapTileSize(){return this._mapTileSize}getTileSet(t){return t=t||0,this._tilesets&&t>=0&&this._tilesets.length>t?this._tilesets[t]:null}getTileSets(){return this._tilesets}setTileSet(t){this.setTileSets([t])}setTileSets(t){this._tilesets=t;const e=this._textures=[],i=this.texGrids;i.clear();for(let i=0;i<t.length;i++){const n=t[i];n&&(e[i]=n.sourceImage)}for(let e=0,n=t.length;e<n;++e){const n=t[e];n&&aat(n,i,n.sourceImage)}this._prepareToRender()}init(t,e,i,n,s){this._cullingDirty=!0,this._layerInfo=t,this._mapInfo=e;const r=t.layerSize;this._layerName=t.name,this.tiles=t.tiles,this._properties=t.properties,this._layerSize=r,this._minGID=t.minGID,this._maxGID=t.maxGID,this._opacity=t.opacity,t.tintColor&&(this._tintColor=t.tintColor),this.renderOrder=e.renderOrder,this._staggerAxis=e.getStaggerAxis(),this._staggerIndex=e.getStaggerIndex(),this._hexSideLength=e.getHexSideLength(),this._animations=e.getTileAnimations(),this._tilesets=i,this._textures=n,this.texGrids=s,this._layerOrientation=e.orientation,this._mapTileSize=e.getTileSize();const o=this._mapTileSize.width,a=this._mapTileSize.height,c=this._layerSize.width,l=this._layerSize.height;if(this._layerOrientation===Dot.HEX){let t=0,e=0;this._odd_even=this._staggerIndex===Not.STAGGERINDEX_ODD?1:-1,this._staggerAxis===Bot.STAGGERAXIS_X?(this._diffX1=(o-this._hexSideLength)/2,this._diffY1=0,e=a*(l+.5),t=(o+this._hexSideLength)*Math.floor(c/2)+o*(c%2)):(this._diffX1=0,this._diffY1=(a-this._hexSideLength)/2,t=o*(c+.5),e=(a+this._hexSideLength)*Math.floor(l/2)+a*(l%2)),this.node._uiProps.uiTransformComp.setContentSize(t,e)}else if(this._layerOrientation===Dot.ISO){const t=c+l;this.node._uiProps.uiTransformComp.setContentSize(.5*o*t,.5*a*t)}else this.node._uiProps.uiTransformComp.setContentSize(c*o,l*a);this._offset=new Oi(t.offset.x,-t.offset.y),this._useAutomaticVertexZ=!1,this._vertexZvalue=0,this._syncAnchorPoint(),this._prepareToRender()}_prepareToRender(){this._updateVertices(),this._updateAllUserNode()}requestMeshRenderData(){this._meshRenderDataArray||(this._meshRenderDataArray=[]);const t=this._meshRenderDataArray;for(;t.length>0&&t[t.length-1].subNodes&&0===t[t.length-1].subNodes.length;)t.pop();if(t.length>0){const e=t[t.length-1];if(e.renderData&&0===e.renderData.vertexCount)return e}const e=JM.add(),i={renderData:e,texture:null};return e.material=this.getRenderMaterial(0),this._meshRenderDataArray.push(i),i}requestSubNodesData(){this._meshRenderDataArray||(this._meshRenderDataArray=[]);const t=this._meshRenderDataArray;if(t.length>0&&t[t.length-1].subNodes&&0===t[t.length-1].subNodes.length)return t[t.length-1];const e={subNodes:[]};return this._meshRenderDataArray.push(e),e}destroyRenderData(){this._meshRenderDataArray&&(this._meshRenderDataArray.forEach((t=>{const e=t.renderData;e&&JM.remove(e)})),this._meshRenderDataArray.length=0),super.destroyRenderData()}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._meshRenderDataArray||this._assembler&&this._assembler.createData&&(this._assembler.createData(this),this.markForUpdateRenderData(),this._updateColor())}_render(t){if(this._meshRenderDataArray){for(let e=0;e<this._meshRenderDataArray.length;e++){this._meshRenderDataArrayIdx=e;const i=this._meshRenderDataArray[e];i.subNodes?i.subNodes.forEach((e=>{e&&t.walk(e.node)})):i.texture&&t.commitComp(this,i.renderData,i.texture,this._assembler,null)}this.node._static=!0}}})||lat);var gat,vat,yat,xat,Sat,Cat;let Aat=t("TiledObjectGroup",(gat=dc("cc.TiledObjectGroup"),vat=Dc(),yat=mc(SO),xat=Kc(ge),gat(Sat=vat(Sat=yat((sc((Cat=class extends Lh{constructor(...t){super(...t),this._premultiplyAlpha=!1,this._groupName=void 0,this._positionOffset=void 0,this._mapInfo=void 0,this._properties=void 0,this._offset=void 0,this._opacity=void 0,this._tintColor=null,this._animations=void 0,this._hasAniObj=void 0,this._texGrids=void 0,this.aniObjects=void 0,this._objects=[]}get premultiplyAlpha(){return this._premultiplyAlpha}set premultiplyAlpha(t){this._premultiplyAlpha=t}getPositionOffset(){return this._positionOffset}getProperties(){return this._properties}getGroupName(){return this._groupName}getProperty(t){return this._properties[t.toString()]}getObject(t){for(let e=0,i=this._objects.length;e<i;e++){const i=this._objects[e];if(i&&i.name===t)return i}return null}getObjects(){return this._objects}get offset(){return this._offset}_init(t,e,i){const n=Oot.FLIPPED_MASK,s=Oot.HORIZONTAL,r=Oot.VERTICAL;this._groupName=t.name,this._positionOffset=t.offset,this._mapInfo=e,this._properties=t.getProperties(),this._offset=new Oi(t.offset.x,-t.offset.y),this._opacity=t.opacity,t.tintColor&&(this._tintColor=t.tintColor),this._texGrids=i,this._animations=e.getTileAnimations(),this.aniObjects=[],this._hasAniObj=!1;const o=e.mapSize,a=e.tileSize;let c=0,l=0;const h=new hi,_=Dot.ISO===e.orientation;if(e.orientation===Dot.HEX)e.getStaggerAxis()===Bot.STAGGERAXIS_X?(l=a.height*(o.height+.5),c=(a.width+e.getHexSideLength())*Math.floor(o.width/2)+a.width*(o.width%2)):(c=a.width*(o.width+.5),l=(a.height+e.getHexSideLength())*Math.floor(o.height/2)+a.height*(o.height%2));else if(_){const t=o.width+o.height;c=.5*a.width*t,l=.5*a.height*t}else c=o.width*a.width,l=o.height*a.height;const u=this.node._uiProps.uiTransformComp;u.setContentSize(c,l);const d=c*u.anchorX,m=l*(1-u.anchorY),p=t.objects,f={};for(let t=0,e=p.length;t<e;t++){const e=p[t],c=e.type;e.offset=new Oi(e.x,e.y);const u=e.points||e.polylinePoints;if(u)for(let t=0;t<u.length;t++)u[t].y*=-1;if(_){const t=e.x/a.height,i=e.y/a.height;e.x=.5*a.width*(o.height+t-i),e.y=.5*a.height*(o.width+o.height-t-i)}else e.y=l-e.y;if(c===Fot.TEXT){const i=`text${e.id}`;f[i]=!0;let n=this.node.getChildByName(i);n||(n=new iS),n.setRotationFromEuler(0,0,-e.rotation),n.setPosition(e.x-d,e.y-m),n.name=i,n.parent=this.node,n.setSiblingIndex(t);let s=n.getComponent(lN);s||(s=n.addComponent(lN));const r=n._uiProps.uiTransformComp;n.active=e.visible,r.anchorX=0,r.anchorY=1,this._tintColor?(h.set(this._tintColor),h.a*=this._opacity/255,s.color.set(h)):s.color.a*=this._opacity/255,s.overflow=lN.Overflow.SHRINK,s.lineHeight=e.height,s.string=e.text,s.horizontalAlign=e.halign,s.verticalAlign=e.valign,s.fontSize=e.pixelsize,r.setContentSize(e.width,e.height)}else if(c===Fot.IMAGE){const o=e.gid,a=(o&n)>>>0,c=i.get(a);if(!c)continue;const l=c.tileset,u=`img${e.id}`;f[u]=!0;let p=this.node.getChildByName(u);e.width=e.width||c.width,e.height=e.height||c.height,p&&p._objFlags&il.Flags.HideInHierarchy&&(p.removeFromParent(),p.hideFlags|=il.Flags.DontSave,p.destroy(),p=null),p||(p=new iS),this._animations.get(a)&&(this.aniObjects.push({object:e,imgNode:p,gridGID:a}),this._hasAniObj=!0);const g=l.tileOffset.x,v=l.tileOffset.y;p.active=e.visible,p.setRotationFromEuler(0,0,-e.rotation),p.setPosition(e.x-d,e.y-m),p.name=u,p.parent=this.node,p.setSiblingIndex(t);let y=p.getComponent(FF);y||(y=p.addComponent(FF));const x=p._uiProps.uiTransformComp;_?(x.anchorX=.5+g/e.width,x.anchorY=v/e.height):(x.anchorX=g/e.width,x.anchorY=v/e.height),this._tintColor?(h.set(this._tintColor),h.a*=this._opacity/255,y.color.set(h)):y.color.a*=this._opacity/255,y.sizeMode=FF.SizeMode.CUSTOM,y._srcBlendFactor=this._premultiplyAlpha?fn.ONE:fn.SRC_ALPHA,y._dstBlendFactor=fn.ONE_MINUS_SRC_ALPHA,y._updateBlendFunc();let S=c.spriteFrame;S=S?S.clone():new jD,(o&s)>>>0&&(S.flipUVX=!S.flipUVX),(o&r)>>>0&&(S.flipUVY=!S.flipUVY),S.rotated=c._rotated,S.rect=c._rect,y.spriteFrame=S,x.setContentSize(e.width,e.height),y.markForUpdateRenderData()}}this._objects=p;const g=this.node.children,v=/^(?:img|text)\d+$/;for(let t=0,e=g.length;t<e;t++){const e=g[t],i=e.name;v.test(i)&&!f[i]&&e.destroy()}}update(t){if(!this._hasAniObj)return;const e=this.aniObjects,i=this._texGrids,n=Dot.ISO===this._mapInfo.orientation;for(let t=0,s=e.length;t<s;t++){const s=e[t],r=s.gridGID,o=i.get(r);if(!o)continue;const a=o.tileset,c=s.object,l=s.imgNode,h=a.tileOffset.x,_=a.tileOffset.y,u=l._uiProps.uiTransformComp;n?(u.anchorX=.5+h/c.width,u.anchorY=_/c.height):(u.anchorX=h/c.width,u.anchorY=_/c.height);const d=l.getComponent(FF),m=d.spriteFrame;m.rotated=o._rotated,m.rect=o._rect,d.spriteFrame=m,d.markForUpdateRenderData()}}}).prototype,"premultiplyAlpha",[xat],Object.getOwnPropertyDescriptor(Cat.prototype,"premultiplyAlpha"),Cat.prototype),Sat=Cat))||Sat)||Sat)||Sat));var bat,Tat,Eat,Pat,wat,Iat,Rat,Dat,Mat,Oat,Bat,Nat,Lat,Fat,zat,Vat,Gat,Uat;let kat=t("TiledMapAsset",(bat=dc("cc.TiledMapAsset"),Tat=Kc([PP]),Eat=Kc([ve]),Pat=Kc([jD]),wat=Kc([jD]),Iat=Kc([ve]),Rat=Kc([ve]),Dat=Kc([Gi]),bat((Bat=sc((Oat=class extends fh{constructor(...t){super(...t),nc(this,"tmxXmlStr",Bat,this),nc(this,"tsxFiles",Nat,this),nc(this,"tsxFileNames",Lat,this),nc(this,"spriteFrames",Fat,this),nc(this,"imageLayerSpriteFrame",zat,this),nc(this,"imageLayerSpriteFrameNames",Vat,this),nc(this,"spriteFrameNames",Gat,this),nc(this,"spriteFrameSizes",Uat,this)}}).prototype,"tmxXmlStr",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Nat=sc(Oat.prototype,"tsxFiles",[Sc,Tat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Lat=sc(Oat.prototype,"tsxFileNames",[Sc,Eat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fat=sc(Oat.prototype,"spriteFrames",[Sc,Pat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zat=sc(Oat.prototype,"imageLayerSpriteFrame",[Sc,wat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vat=sc(Oat.prototype,"imageLayerSpriteFrameNames",[Sc,Iat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gat=sc(Oat.prototype,"spriteFrameNames",[Sc,Rat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Uat=sc(Oat.prototype,"spriteFrameSizes",[Sc,Dat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mat=Oat))||Mat));var Hat,jat,Wat,qat,Xat,Yat,Kat,Jat,$at,Zat,Qat,tct,ect;t("TiledMap",(Hat=dc("cc.TiledMap"),jat=Dc(),Wat=Pc(),qat=mc(SO),Xat=Kc(kat),Yat=kc(),Hat(Kat=jat(Kat=Wat(Kat=qat(Kat=Ec((ect=tct=class extends Lh{constructor(...t){super(...t),this._texGrids=new Map,this._textures=[],this._tilesets=[],this._animations=new Map,this._imageLayers=[],this._layers=[],this._groups=[],this._images=[],this._properties={},this._tileProperties=new Map,this._mapInfo=null,this._mapSize=new Gi(0,0),this._tileSize=new Gi(0,0),this._mapOrientation=Dot.ORTHO,this._isApplied=!1,nc(this,"_tmxFile",$at,this),nc(this,"_enableCulling",Zat,this),nc(this,"cleanupImageCache",Qat,this)}get tmxAsset(){return this._tmxFile}set tmxAsset(t){this._tmxFile!==t&&(this._tmxFile=t,this._applyFile(),this._isApplied=!0)}get enableCulling(){return this._enableCulling}set enableCulling(t){this._enableCulling=t;const e=this._layers;for(let i=0;i<e.length;++i)e[i].enableCulling=t}getMapSize(){return this._mapSize}getTileSize(){return this._tileSize}getMapOrientation(){return this._mapOrientation}getObjectGroups(){return this._groups}getObjectGroup(t){const e=this._groups;for(let i=0,n=e.length;i<n;i++){const n=e[i];if(n&&n.getGroupName()===t)return n}return null}getProperties(){return this._properties}getLayers(){return this._layers}getLayer(t){const e=this._layers;for(let i=0,n=e.length;i<n;i++){const n=e[i];if(n&&n.getLayerName()===t)return n}return null}_changeLayer(t,e){const i=this._layers;for(let n=0,s=i.length;n<s;n++){const s=i[n];if(s&&s.getLayerName()===t)return void(i[n]=e)}}getProperty(t){return this._properties[t.toString()]}getPropertiesForGID(t){return this._tileProperties.get(t)}__preload(){this._tmxFile&&!1===this._isApplied&&(this._applyFile(),this._isApplied=!0)}onEnable(){this.node.on(fx.ANCHOR_CHANGED,this._syncAnchorPoint,this)}onDisable(){this.node.off(fx.ANCHOR_CHANGED,this._syncAnchorPoint,this)}_applyFile(){const t=[],e={},i=this._tmxFile;if(i){let n=i.spriteFrameNames;const s=i.spriteFrameSizes,r=i.spriteFrames,o={},a={};for(let i=0;i<n.length;++i){const c=n[i];a[c]=s[i],t[i]=r[i];const l=t[i];l&&(e[l.name]=l,o[c]=l)}const c={},l=i.imageLayerSpriteFrame;n=i.imageLayerSpriteFrameNames;for(let t=0;t<l.length;++t)c[n[t]]=l[t];const h=i.tsxFileNames,_=i.tsxFiles,u={};for(let t=0;t<h.length;++t)h[t].length>0&&(u[h[t]]=_[t].text);const d=new qot(i.tmxXmlStr,u,o,a,c),m=d.getTilesets();m&&0!==m.length||P(7241),this._buildWithMapInfo(d)}else this._releaseMapInfo()}_releaseMapInfo(){const t=this._layers;for(let n=0,s=t.length;n<s;n++){var e,i;null===(e=t[n].node.parent)||void 0===e||e.off(fx.SIZE_CHANGED,t[n].updateCulling,t[n]),null===(i=t[n].node.parent)||void 0===i||i.off(fx.TRANSFORM_CHANGED,t[n].updateCulling,t[n]),t[n].node.removeFromParent(),t[n].node.destroy()}t.length=0;const n=this._groups;for(let t=0,e=n.length;t<e;t++)n[t].node.removeFromParent(),n[t].node.destroy();n.length=0;const s=this._images;for(let t=0,e=s.length;t<e;t++)s[t].removeFromParent(),s[t].destroy();s.length=0}_syncAnchorPoint(){const t=this.node._uiProps.uiTransformComp.anchorPoint,e=this.node._uiProps.uiTransformComp.width*t.x,i=this.node._uiProps.uiTransformComp.height*(1-t.y);let n,s;for(n=0,s=this._layers.length;n<s;n++)this._layers[n].node._uiProps.uiTransformComp.setAnchorPoint(t);for(n=0,s=this._groups.length;n<s;n++){const t=this._groups[n],s=t.node._uiProps.uiTransformComp;s.anchorX=.5,s.anchorY=.5;const r=t.offset.x-e+s.width*s.anchorX,o=t.offset.y+i-s.height*s.anchorY;t.node.setPosition(r,o)}for(n=0,s=this._images.length;n<s;n++){const t=this._images[n]._uiProps.uiTransformComp;t.anchorX=.5,t.anchorY=.5;const s=this._images[n]._offset.x-e+t.width*t.anchorX,r=this._images[n]._offset.y+i-t.height*t.anchorY;this._images[n].setPosition(s,r)}}_fillAniGrids(t,e){for(const i of e.keys()){const n=e.get(i);if(!n)continue;const s=n.frames;for(let e=0;e<s.length;e++){const i=s[e];i.grid=t.get(i.tileid)}}}_buildLayerAndGroup(){const t=this._tilesets,e=this._texGrids,i=this._animations;e.clear();for(let i=0,n=t.length;i<n;++i){const n=t[i];n&&(n.sourceImage?aat(n,e,n.sourceImage):console.warn(`Can't find the spriteFrame of tilesets ${i}`))}this._fillAniGrids(e,i);let n=this._layers,s=this._groups,r=this._images;const o={};for(let t=0,e=n.length;t<e;t++)o[n[t].node.name]=!0;for(let t=0,e=s.length;t<e;t++)o[s[t].node.name]=!0;for(let t=0,e=r.length;t<e;t++)o[r[t].name]=!0;n=this._layers=[],s=this._groups=[],r=this._images=[];const a=this._mapInfo,c=this.node,l=a.getAllChildren(),h=this._textures;let _=0,u=0;if(l&&l.length>0)for(let i=0,d=l.length;i<d;i++){const d=l[i],m=d.name;let p=this.node.getChildByName(m);if(o[m]=!1,p||(p=new iS,p.name=m,p.layer=c.layer,c.addChild(p)),p.setSiblingIndex(i),p.active=d.visible,d instanceof Got){let i=p.getComponent(fat);i||(i=p.addComponent(fat)),i.init(d,a,t,h,e),i.enableCulling=this._enableCulling,d.ownTiles=!1,n.push(i)}else if(d instanceof Vot){let t=p.getComponent(Aat);t||(t=p.addComponent(Aat)),t._init(d,a,e),s.push(t)}else if(d instanceof Uot){const t=d.sourceImage;p.layerInfo=d,p._offset=new Oi(d.offset.x,-d.offset.y);let e=p.getComponent(FF);e||(e=p.addComponent(FF)),e.color.a*=d.opacity,e.spriteFrame=t;let i=t.width,n=t.height;t.original&&(i=t.originalSize.width,n=t.originalSize.height),p._uiProps.uiTransformComp.setContentSize(i,n),r.push(p)}_=Math.max(_,p._uiProps.uiTransformComp.width),u=Math.max(u,p._uiProps.uiTransformComp.height)}const d=c.children;for(let t=0,e=d.length;t<e;t++){const e=d[t];o[e.name]&&e.destroy()}this.node._uiProps.uiTransformComp.setContentSize(_,u),this._syncAnchorPoint()}_buildWithMapInfo(t){this._mapInfo=t,this._mapSize=t.getMapSize(),this._tileSize=t.getTileSize(),this._mapOrientation=t.orientation,this._properties=t.properties,this._tileProperties=t.getTileProperties(),this._imageLayers=t.getImageLayers(),this._animations=t.getTileAnimations(),this._tilesets=t.getTilesets();const e=this._tilesets;this._textures.length=0;const i=[];for(let t=0,n=e.length;t<n;++t){const n=e[t];n&&n.sourceImage&&(this._textures[t]=n.sourceImage,i.push(n.sourceImage))}for(let t=0;t<this._imageLayers.length;t++){const e=this._imageLayers[t];e&&e.sourceImage&&i.push(e.sourceImage)}this._buildLayerAndGroup(),this.cleanupImageCache&&this._textures.forEach((t=>{this.doCleanupImageCache(t)}))}doCleanupImageCache(t){t._image instanceof HTMLImageElement?(t._image.src="",t._image.destroy()):qh.hasFeature(qh.Feature.IMAGE_BITMAP)&&t._image instanceof ImageBitmap&&t._image.close&&t._image.close(),t._image=null}lateUpdate(t){const e=this._animations,i=this._texGrids;for(const n of e.keys()){const s=e.get(n),r=s.frames;let o=r[s.frameIdx];s.dt+=t,o.duration<s.dt&&(s.dt=0,s.frameIdx++,s.frameIdx>=r.length&&(s.frameIdx=0),o=r[s.frameIdx]),i.set(n,o.grid)}const n=this.getLayers();for(let t=0,e=n.length;t<e;t++){const e=n[t];(e.hasAnimation()||e.node.hasChangedFlags)&&e.markForUpdateRenderData()}}},tct.Orientation=Dot,tct.Property=Mot,tct.TileFlag=Oot,tct.StaggerAxis=Bot,tct.StaggerIndex=Not,tct.TMXObjectType=Fot,tct.RenderOrder=Lot,$at=sc((Jat=ect).prototype,"_tmxFile",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sc(Jat.prototype,"tmxAsset",[Xat,Yat],Object.getOwnPropertyDescriptor(Jat.prototype,"tmxAsset"),Jat.prototype),Zat=sc(Jat.prototype,"_enableCulling",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sc(Jat.prototype,"enableCulling",[Mc],Object.getOwnPropertyDescriptor(Jat.prototype,"enableCulling"),Jat.prototype),Qat=sc(Jat.prototype,"cleanupImageCache",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Kat=Jat))||Kat)||Kat)||Kat)||Kat)||Kat));const ict=Math.ceil(10922.5),nct=[];for(let t=0;t<4;t++)nct.push(new mi);const sct=new Ii,rct=new mi,oct={row:0,col:0};let act,cct,lct={x:0,y:0},hct={x:0,y:0},_ct={x:0,y:0},uct={x:0,y:0},dct=0,mct=0,pct=0,fct=0;const gct={createData(t){const e=t.requestMeshRenderData();return t.rightTop.col*t.rightTop.row*4>65535&&console.error("Vertex count exceeds 65535"),e},updateRenderData(t,e){t.updateCulling();const i=t.requestMeshRenderData();if(pct=t.leftDownToCenterX,fct=t.leftDownToCenterY,act=i,t.colorChanged||t.isCullingDirty()||t.isUserNodeDirty()||t.hasAnimation()||t.hasTiledNode()||t.node.hasChangedFlags){let e,i;if(t.colorChanged=!1,t.destroyRenderData(),t.enableCulling){const n=t.cullingRect;e=n.leftDown,i=n.rightTop}else e=oct,i=t.rightTop;switch(t.renderOrder){case Lot.RightDown:xct(e,i,-1,1,t);break;case Lot.LeftDown:xct(e,i,-1,-1,t);break;case Lot.RightUp:xct(e,i,1,1,t);break;case Lot.LeftUp:default:xct(e,i,1,-1,t)}t.setCullingDirty(!1),t.setUserNodeDirty(!1)}act=null},updateColor(t){const e=t.color,i=new Float32Array(4);i[0]=e.r/255,i[1]=e.g/255,i[2]=e.b/255,i[3]=e.a/255;const n=t.meshRenderDataArray;if(n)for(const t of n){if(!t.renderData)continue;const e=t.renderData,n=e.vData;for(let t=e.vertexStart,s=e.vertexCount;t<s;t++)n.set(i,9*t+5)}},fillBuffers(t,e){if(!t||!t.meshRenderDataArray)return;const i=t.meshRenderDataArray[t._meshRenderDataArrayIdx].renderData,n=i.iData;let s=0,r=0;const o=i.vertexCount/4;for(let t=0;t<o;t+=1)n[s]=r,n[s+1]=r+1,n[s+2]=r+2,n[s+3]=r+2,n[s+4]=r+1,n[s+5]=r+3,s+=6,r+=4}};function vct(t,e){let i;t._rotated?(lct.x=t.r,lct.y=t.t,hct.x=t.l,hct.y=t.t,_ct.x=t.r,_ct.y=t.b,uct.x=t.l,uct.y=t.b):(lct.x=t.l,lct.y=t.t,hct.x=t.l,hct.y=t.b,_ct.x=t.r,_ct.y=t.t,uct.x=t.r,uct.y=t.b),(e&Oot.DIAGONAL)>>>0&&(i=hct,hct=_ct,_ct=i),(e&Oot.HORIZONTAL)>>>0&&(i=lct,lct=_ct,_ct=i,i=hct,hct=uct,uct=i),(e&Oot.VERTICAL)>>>0&&(i=lct,lct=hct,hct=i,i=_ct,_ct=uct,uct=i)}function yct(t,e,i){t||(t=e.texture),act.texture||(act.texture=t),act=i.requestMeshRenderData(),act.texture=e.texture}function xct(t,e,i,n,s){if(!act||e.row<0||e.col<0)return;act.renderData||(act=s.requestMeshRenderData());let r=act.renderData.vData;const o=s.node.worldMatrix;dct=0,mct=0;const a=s.tiledTiles,c=s.texGrids,l=s.tiles,h=18,_=27,u=s.vertices;let d,m,p,f,g,v,y,x,S,C=0,A=0,b=0,T=0,E=0,P=null,w=0,I=!0;cct=vct;const R=new Float32Array(4);for(R[0]=s.color.r/255,R[1]=s.color.g/255,R[2]=s.color.b/255,R[3]=s.color.a/255,-1===i?(f=e.row,g=t.row):(f=t.row,g=e.row);(g-f)*i>=0;f+=i)for(d=u[f],w=s.getNodesCountByRow(f),I=d&&0===w,1===n?(m=I&&t.col<d.minCol?d.minCol:t.col,p=I&&e.col>d.maxCol?d.maxCol:e.col):(m=I&&e.col>d.maxCol?d.maxCol:e.col,p=I&&t.col<d.minCol?d.minCol:t.col);(p-m)*n>=0;m+=n){if(v=d&&d[m],w>0){const t=s.requestSubNodesData(),e=s.getNodesByRowCol(f,m);e&&e.count>0&&(t.subNodes=s.getNodesByRowCol(f,m).list,P=null,act=s.requestMeshRenderData())}if(!v)continue;if(C=l[v.index],x=c.get((C&Oot.FLIPPED_MASK)>>>0),!x)continue;P!==x.texture&&(yct(P,x,s),P=x.texture),y=x.tileset._tileSize,A=v.left-pct,b=v.bottom-fct,T=A+y.width,E=b+y.height,S=a[v.index];const t=act.renderData;t.reserve(4,0),mct=9*t.vertexCount,r=t.vData,S?S.node.active&&Sct(S.node,R,r,A,T,E,b,!1):(nct[0].x=A,nct[0].y=E,nct[1].x=A,nct[1].y=b,nct[2].x=T,nct[2].y=E,nct[3].x=T,nct[3].y=b,nct[0].transformMat4(o),r[mct]=nct[0].x,r[mct+1]=nct[0].y,r[mct+2]=nct[0].z,nct[1].transformMat4(o),r[mct+9]=nct[1].x,r[mct+9+1]=nct[1].y,r[mct+9+2]=nct[1].z,nct[2].transformMat4(o),r[mct+h]=nct[2].x,r[mct+h+1]=nct[2].y,r[mct+h+2]=nct[2].z,nct[3].transformMat4(o),r[mct+_]=nct[3].x,r[mct+_+1]=nct[3].y,r[mct+_+2]=nct[3].z,r.set(R,mct+5),r.set(R,mct+9+5),r.set(R,mct+h+5),r.set(R,mct+_+5)),cct(x,C),r[mct+3]=lct.x,r[mct+4]=lct.y,r[mct+9+3]=hct.x,r[mct+9+4]=hct.y,r[mct+h+3]=_ct.x,r[mct+h+4]=_ct.y,r[mct+_+3]=uct.x,r[mct+_+4]=uct.y,dct++,t.request(4,6),t.resize(t.vertexCount,t.indexCount),dct>=ict&&(yct(P,x,s),P=x.texture)}}function Sct(t,e,i,n,s,r,o,a){const c=18,l=27;t.updateWorldTransform(),Ii.fromRTS(sct,t.rotation,t.position,t.scale),mi.set(rct,-(n+pct),-(o+fct),0),Ii.transform(sct,sct,rct),Ii.multiply(sct,t.parent.worldMatrix,sct);const h=sct,_=h.m12,u=h.m13,d=h.m00,m=h.m01,p=h.m04,f=h.m05,g=1===d&&0===m&&0===p&&1===f;if(a){const t=(n+s)/2,e=(r+o)/2;g?(i[mct]=t+_,i[mct+1]=r+u,i[mct+9]=n+_,i[mct+9+1]=e+u,i[mct+c]=s+_,i[mct+c+1]=e+u,i[mct+l]=t+_,i[mct+l+1]=o+u):(i[mct]=t*d+r*p+_,i[mct+1]=t*m+r*f+u,i[mct+9]=n*d+e*p+_,i[mct+9+1]=n*m+e*f+u,i[mct+c]=s*d+e*p+_,i[mct+c+1]=s*m+e*f+u,i[mct+l]=t*d+o*p+_,i[mct+l+1]=t*m+o*f+u)}else g?(i[mct]=n+_,i[mct+1]=r+u,i[mct+9]=n+_,i[mct+9+1]=o+u,i[mct+c]=s+_,i[mct+c+1]=r+u,i[mct+l]=s+_,i[mct+l+1]=o+u):(i[mct]=n*d+r*p+_,i[mct+1]=n*m+r*f+u,i[mct+9]=n*d+o*p+_,i[mct+9+1]=n*m+o*f+u,i[mct+c]=s*d+r*p+_,i[mct+c+1]=s*m+r*f+u,i[mct+l]=s*d+o*p+_,i[mct+l+1]=s*m+o*f+u);i.set(e,mct+5),i.set(e,mct+9+5),i.set(e,mct+c+5),i.set(e,mct+l+5)}const Cct=t("tiledLayerAssembler",{getAssembler:()=>gct});fat.Assembler=Cct;class Act{constructor(){this.originalTarget=null,this.target=null,this.tag=Act.TAG_INVALID}clone(){const t=new Act;return t.originalTarget=null,t.target=null,t.tag=this.tag,t}isDone(){return!0}startWithTarget(t){this.originalTarget=t,this.target=t}stop(){this.target=null}step(t){P(1006)}update(t){P(1007)}getTarget(){return this.target}setTarget(t){this.target=t}getOriginalTarget(){return this.originalTarget}setOriginalTarget(t){this.originalTarget=t}getTag(){return this.tag}setTag(t){this.tag=t}reverse(){return P(1008),null}retain(){}release(){}}Act.TAG_INVALID=-1;class bct extends Act{constructor(...t){super(...t),this._duration=0,this._timesForRepeat=1}getDuration(){return this._duration*(this._timesForRepeat||1)}setDuration(t){this._duration=t}clone(){return new bct}}let Tct=0;class Ect{constructor(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1}}class Pct{constructor(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}_searchElementByTarget(t,e){for(let i=0;i<t.length;i++)if(e===t[i].target)return t[i];return null}_getElement(t,e){let i=this._elementPool.pop();return i||(i=new Ect),i.target=t,i.paused=!!e,i}_putElement(t){t.actions.length=0,t.actionIndex=0,t.currentAction=null,t.paused=!1,t.target=null,t.lock=!1,this._elementPool.push(t)}addAction(t,e,i){if(!t||!e)return void D(1e3);null==e.uuid&&(e.uuid="_TWEEN_UUID_"+Tct++);let n=this._hashTargets.get(e);n?n.actions||(n.actions=[]):(n=this._getElement(e,i),this._hashTargets.set(e,n),this._arrayTargets.push(n)),n.target=e,n.actions.push(t),t.startWithTarget(e)}removeAllActions(){const t=this._arrayTargets;for(let e=0;e<t.length;e++){const i=t[e];i&&this._putElement(i)}this._arrayTargets.length=0,this._hashTargets=new Map}removeAllActionsFromTarget(t){if(null==t)return;const e=this._hashTargets.get(t);e&&(e.actions.length=0,this._deleteHashElement(e))}removeAction(t){if(null==t)return;const e=t.getOriginalTarget(),i=this._hashTargets.get(e);if(i)for(let e=0;e<i.actions.length;e++)if(i.actions[e]===t){i.actions.splice(e,1),i.actionIndex>=e&&i.actionIndex--;break}}_removeActionByTag(t,e,i){for(let n=0,s=e.actions.length;n<s;++n){const s=e.actions[n];if(s&&s.getTag()===t){if(i&&s.getOriginalTarget()!==i)continue;this._removeActionAtIndex(n,e);break}}}_removeAllActionsByTag(t,e,i){for(let n=e.actions.length-1;n>=0;--n){const s=e.actions[n];if(s&&s.getTag()===t){if(i&&s.getOriginalTarget()!==i)continue;this._removeActionAtIndex(n,e)}}}removeActionByTag(t,e){t===Act.TAG_INVALID&&P(1002);const i=this._hashTargets;if(e){const n=i.get(e);n&&this._removeActionByTag(t,n,e)}else i.forEach((e=>{this._removeActionByTag(t,e)}))}removeAllActionsByTag(t,e){t===Act.TAG_INVALID&&P(1002);const i=this._hashTargets;if(e){const n=i.get(e);n&&this._removeAllActionsByTag(t,n,e)}else i.forEach((e=>{this._removeAllActionsByTag(t,e)}))}getActionByTag(t,e){t===Act.TAG_INVALID&&P(1004);const i=this._hashTargets.get(e);if(i){if(null!=i.actions)for(let e=0;e<i.actions.length;++e){const n=i.actions[e];if(n&&n.getTag()===t)return n}P(1005,t)}return null}getNumberOfRunningActionsInTarget(t){const e=this._hashTargets.get(t);return e&&e.actions?e.actions.length:0}pauseTarget(t){const e=this._hashTargets.get(t);e&&(e.paused=!0)}resumeTarget(t){const e=this._hashTargets.get(t);e&&(e.paused=!1)}pauseAllRunningActions(){const t=[],e=this._arrayTargets;for(let i=0;i<e.length;i++){const n=e[i];n&&!n.paused&&(n.paused=!0,t.push(n.target))}return t}resumeTargets(t){if(t)for(let e=0;e<t.length;e++)t[e]&&this.resumeTarget(t[e])}pauseTargets(t){if(t)for(let e=0;e<t.length;e++)t[e]&&this.pauseTarget(t[e])}purgeSharedManager(){l.director.getScheduler().unscheduleUpdate(this)}_removeActionAtIndex(t,e){e.actions[t],e.actions.splice(t,1),e.actionIndex>=t&&e.actionIndex--,0===e.actions.length&&this._deleteHashElement(e)}_deleteHashElement(t){let e=!1;if(t&&!t.lock&&this._hashTargets.get(t.target)){this._hashTargets.delete(t.target);const i=this._arrayTargets;for(let e=0,n=i.length;e<n;e++)if(i[e]===t){i.splice(e,1);break}this._putElement(t),e=!0}return e}update(t){const e=this._arrayTargets;let i;for(let n=0;n<e.length;n++){this._currentTarget=e[n],i=this._currentTarget;const s=i.target;if(s instanceof il&&!s.isValid)this.removeAllActionsFromTarget(s),n--;else{if(!i.paused&&i.actions){for(i.lock=!0,i.actionIndex=0;i.actionIndex<i.actions.length;i.actionIndex++)if(i.currentAction=i.actions[i.actionIndex],i.currentAction){if(i.currentAction.step(t*(i.currentAction._speedMethod?i.currentAction._speed:1)),i.currentAction&&i.currentAction.isDone()){i.currentAction.stop();const t=i.currentAction;i.currentAction=null,this.removeAction(t)}i.currentAction=null}i.lock=!1}0===i.actions.length&&this._deleteHashElement(i)&&n--}}}}class wct extends ew{constructor(...t){super(...t),this.actionMgr=new Pct}get ActionManager(){return this.actionMgr}update(t){this.actionMgr.update(t)}}t("TweenSystem",wct),wct.ID="TWEEN",wct.instance=void 0,mw.on(dw.EVENT_INIT,(()=>{const t=new wct;wct.instance=t,mw.registerSystem(wct.ID,t,ew.Priority.MEDIUM)}));class Ict extends bct{isDone(){return!0}step(t){this.update(1)}update(t){}reverse(){return this.clone()}clone(){return new Ict}}class Rct extends Ict{update(t){const e=this.target.getComponentsInChildren(DD);for(let t=0;t<e.length;++t)e[t].enabled=!0}reverse(){return new Dct}clone(){return new Rct}}class Dct extends Ict{update(t){const e=this.target.getComponentsInChildren(DD);for(let t=0;t<e.length;++t)e[t].enabled=!1}reverse(){return new Rct}clone(){return new Dct}}class Mct extends Ict{constructor(t){super(),this._isNeedCleanUp=!0,void 0!==t&&this.init(t)}update(t){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()}init(t){return this._isNeedCleanUp=t,!0}reverse(){return new Mct(this._isNeedCleanUp)}clone(){return new Mct(this._isNeedCleanUp)}}class Oct extends Ict{constructor(t,e,i){super(),this._selectorTarget=null,this._function=null,this._data=null,this.initWithFunction(t,e,i)}initWithFunction(t,e,i){return t&&(this._function=t),e&&(this._selectorTarget=e),void 0!==i&&(this._data=i),!0}execute(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)}update(t){this.execute()}getTargetCallback(){return this._selectorTarget}setTargetCallback(t){t!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=t)}clone(){const t=new Oct;return t.initWithFunction(this._function,this._selectorTarget,this._data),t}}class Bct extends bct{constructor(t){super(),this.MAX_VALUE=2,this._elapsed=0,this._firstTick=!1,this._easeList=[],this._speed=1,this._repeatForever=!1,this._repeatMethod=!1,this._speedMethod=!1,void 0===t||isNaN(t)||this.initWithDuration(t)}getElapsed(){return this._elapsed}initWithDuration(t){return this._duration=0===t?Kt.FLT_EPSILON:t,this._elapsed=0,this._firstTick=!0,!0}isDone(){return this._elapsed>=this._duration}_cloneDecoration(t){t._repeatForever=this._repeatForever,t._speed=this._speed,t._timesForRepeat=this._timesForRepeat,t._easeList=this._easeList,t._speedMethod=this._speedMethod,t._repeatMethod=this._repeatMethod}_reverseEaseList(t){if(this._easeList){t._easeList=[];for(let e=0;e<this._easeList.length;e++)t._easeList.push(this._easeList[e])}}clone(){const t=new Bct(this._duration);return this._cloneDecoration(t),t}easing(t){this._easeList?this._easeList.length=0:this._easeList=[];for(let t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this}_computeEaseTime(t){return t}step(t){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=t;let e=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);e=e<1?e:1,this.update(e>0?e:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))}startWithTarget(t){Act.prototype.startWithTarget.call(this,t),this._elapsed=0,this._firstTick=!0}reverse(){return P(1010),this}setAmplitudeRate(t){P(1011)}getAmplitudeRate(){return P(1012),0}speed(t){return t<=0?(P(1013),this):(this._speedMethod=!0,this._speed*=t,this)}getSpeed(){return this._speed}setSpeed(t){return this._speed=t,this}repeat(t){return t=Math.round(t),isNaN(t)||t<1?(P(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=t,this)}repeatForever(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this}}class Nct extends Bct{constructor(t){super(),this._actions=[],this._split=0,this._last=0,this._reversed=!1;const e=t instanceof Array?t:arguments;if(1===e.length)return void D(1019);const i=e.length-1;if(i>=0&&null==e[i]&&P(1015),i>=0){let t,n=e[0];for(let s=1;s<i;s++)e[s]&&(t=n,n=Nct._actionOneTwo(t,e[s]));this.initWithTwoActions(n,e[i])}}initWithTwoActions(t,e){if(!t||!e)return D(1025),!1;let i=t._duration,n=e._duration;i*=t._repeatMethod?t._timesForRepeat:1,n*=e._repeatMethod?e._timesForRepeat:1;const s=i+n;return this.initWithDuration(s),this._actions[0]=t,this._actions[1]=e,!0}clone(){const t=new Nct;return this._cloneDecoration(t),t.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),t}startWithTarget(t){Bct.prototype.startWithTarget.call(this,t),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1}stop(){-1!==this._last&&this._actions[this._last].stop(),Act.prototype.stop.call(this)}update(t){let e,i=0;const n=this._split,s=this._actions,r=this._last;let o;(t=this._computeEaseTime(t))<n?(e=0!==n?t/n:1,0===i&&1===r&&this._reversed&&(s[1].update(0),s[1].stop())):(i=1,e=1===n?1:(t-n)/(1-n),-1===r&&(s[0].startWithTarget(this.target),s[0].update(1),s[0].stop()),0===r&&(s[0].update(1),s[0].stop())),o=s[i],r===i&&o.isDone()||(r!==i&&o.startWithTarget(this.target),e*=o._timesForRepeat,o.update(e>1?e%1:e),this._last=i)}reverse(){const t=Nct._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t._reversed=!0,t}}function Lct(t){const e=t instanceof Array?t:arguments;if(1===e.length)return D(1019),null;const i=e.length-1;i>=0&&null==e[i]&&P(1015);let n=null;if(i>=0){n=e[0];for(let t=1;t<=i;t++)e[t]&&(n=Nct._actionOneTwo(n,e[t]))}return n}Nct._actionOneTwo=function(t,e){const i=new Nct;return i.initWithTwoActions(t,e),i};class Fct extends Bct{constructor(t,e){super(),this._times=0,this._total=0,this._nextDt=0,this._actionInstant=!1,this._innerAction=null,void 0!==e&&this.initWithAction(t,e)}initWithAction(t,e){const i=t._duration*e;return!!this.initWithDuration(i)&&(this._times=e,this._innerAction=t,t instanceof Ict&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)}clone(){const t=new Fct;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone(),this._times),t}startWithTarget(t){this._total=0,this._nextDt=this._innerAction._duration/this._duration,Bct.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)}stop(){this._innerAction.stop(),Act.prototype.stop.call(this)}update(t){t=this._computeEaseTime(t);const e=this._innerAction,i=this._duration,n=this._times;let s=this._nextDt;if(t>=s){for(;t>s&&this._total<n;)e.update(1),this._total++,e.stop(),e.startWithTarget(this.target),s+=e._duration/i,this._nextDt=s>1?1:s;t>=1&&this._total<n&&(e.update(1),this._total++),this._actionInstant||(this._total===n?e.stop():e.update(t-(s-e._duration/i)))}else e.update(t*n%1)}isDone(){return this._total===this._times}reverse(){const t=new Fct(this._innerAction.reverse(),this._times);return this._cloneDecoration(t),this._reverseEaseList(t),t}setInnerAction(t){this._innerAction!==t&&(this._innerAction=t)}getInnerAction(){return this._innerAction}}class zct extends Bct{constructor(t){super(),this._innerAction=null,t&&this.initWithAction(t)}initWithAction(t){return t?(this._innerAction=t,!0):(D(1026),!1)}clone(){const t=new zct;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone()),t}startWithTarget(t){Bct.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)}step(t){const e=this._innerAction;e.step(t),e.isDone()&&(e.startWithTarget(this.target),e.step(e.getElapsed()-e._duration))}isDone(){return!1}reverse(){const t=new zct(this._innerAction.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t}setInnerAction(t){this._innerAction!==t&&(this._innerAction=t)}getInnerAction(){return this._innerAction}}class Vct extends Bct{constructor(t){super(),this._one=null,this._two=null;const e=t instanceof Array?t:arguments;if(1===e.length)return void D(1020);const i=e.length-1;if(i>=0&&null==e[i]&&P(1015),i>=0){let t,n=e[0];for(let s=1;s<i;s++)e[s]&&(t=n,n=Vct._actionOneTwo(t,e[s]));this.initWithTwoActions(n,e[i])}}initWithTwoActions(t,e){if(!t||!e)return D(1027),!1;let i=!1;const n=t._duration,s=e._duration;return this.initWithDuration(Math.max(n,s))&&(this._one=t,this._two=e,n>s?this._two=Nct._actionOneTwo(e,kct(n-s)):n<s&&(this._one=Nct._actionOneTwo(t,kct(s-n))),i=!0),i}clone(){const t=new Vct;return this._cloneDecoration(t),t.initWithTwoActions(this._one.clone(),this._two.clone()),t}startWithTarget(t){Bct.prototype.startWithTarget.call(this,t),this._one.startWithTarget(t),this._two.startWithTarget(t)}stop(){this._one.stop(),this._two.stop(),Act.prototype.stop.call(this)}update(t){t=this._computeEaseTime(t),this._one&&this._one.update(t),this._two&&this._two.update(t)}reverse(){const t=Vct._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t}}function Gct(t){const e=t instanceof Array?t:arguments;if(1===e.length)return D(1020),null;e.length>0&&null==e[e.length-1]&&P(1015);let i=e[0];for(let t=1;t<e.length;t++)null!=e[t]&&(i=Vct._actionOneTwo(i,e[t]));return i}Vct._actionOneTwo=function(t,e){const i=new Vct;return i.initWithTwoActions(t,e),i};class Uct extends Bct{update(t){}reverse(){const t=new Uct(this._duration);return this._cloneDecoration(t),this._reverseEaseList(t),t}clone(){const t=new Uct;return this._cloneDecoration(t),t.initWithDuration(this._duration),t}}function kct(t){return new Uct(t)}class Hct extends Bct{constructor(t){super(),this._other=null,t&&this.initWithAction(t)}initWithAction(t){return t?t===this._other?(D(1029),!1):!!Bct.prototype.initWithDuration.call(this,t._duration)&&(this._other=t,!0):(D(1028),!1)}clone(){const t=new Hct;return this._cloneDecoration(t),t.initWithAction(this._other.clone()),t}startWithTarget(t){Bct.prototype.startWithTarget.call(this,t),this._other.startWithTarget(t)}update(t){t=this._computeEaseTime(t),this._other&&this._other.update(1-t)}reverse(){return this._other.clone()}stop(){this._other.stop(),Act.prototype.stop.call(this)}}class jct extends Bct{constructor(t,e,i){if(super(),this._opts=void 0,this._props=void 0,this._originProps=void 0,null==i)i=Object.create(null);else if(function(t){const e=" [Tween:] ",i=` option is not support in v + ${h}`,n=t;n.delay&&y(`${e}delay${i}`),n.repeat&&y(`${e}repeat${i}`),n.repeatDelay&&y(`${e}repeatDelay${i}`),n.interpolation&&y(`${e}interpolation${i}`),n.onStop&&y(`${e}onStop${i}`)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(t){const e=t.charAt(0);if(/[A-Z]/.test(e)){const i=(t=t.replace(e,e.toLowerCase())).split("-");if(2===i.length){const e=i[0];if("linear"===e)t="linear";else{const n=i[1];switch(e){case"quadratic":t=`quad${n}`;break;case"quartic":t=`quart${n}`;break;case"quintic":t=`quint${n}`;break;case"sinusoidal":t=`sine${n}`;break;case"exponential":t=`expo${n}`;break;case"circular":t=`circ${n}`;break;default:t=e+n}}}}return t}(i.easing)),i.progress||(i.progress=this.progress),i.easing&&"string"==typeof i.easing){const t=i.easing;i.easing=Bu[t],i.easing||I(1031,t)}this._opts=i,this._props=Object.create(null);for(const t in e){if(!e.hasOwnProperty(t))continue;let i,n,s=e[t];if("function"==typeof s&&(s=s()),null==s||"string"==typeof s)continue;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(i=Bu[s.easing],i||I(1031,s.easing)):i=s.easing,n=s.progress,s=s.value);const r=Object.create(null);r.value=s,r.easing=i,r.progress=n,this._props[t]=r}this._originProps=e,this.initWithDuration(t)}clone(){const t=new jct(this._duration,this._originProps,this._opts);return this._cloneDecoration(t),t}startWithTarget(t){Bct.prototype.startWithTarget.call(this,t);const e=!!this._opts.relative,i=this._props;for(const n in i){const s=t[n];if(void 0===s)continue;const r=i[n],o=r.value;if("number"==typeof s)r.start=s,r.current=s,r.end=e?s+o:o;else if("object"==typeof s){null==r.start&&(r.start={},r.current={},r.end={});for(const t in o)isNaN(s[t])||(r.start[t]=s[t],r.current[t]=s[t],r.end[t]=e?s[t]+o[t]:o[t])}}this._opts.onStart&&this._opts.onStart(this.target)}update(t){const e=this.target;if(!e)return;const i=this._props,n=this._opts;let s=t;n.easing&&(s=n.easing(t));const r=n.progress;for(const n in i){const o=i[n],a=o.easing?o.easing(t):s,c=o.progress?o.progress:r,l=o.start,h=o.end;if("number"==typeof l)o.current=c(l,h,o.current,a);else if("object"==typeof l)for(const t in l)o.current[t]=c(l[t],h[t],o.current[t],a);e[n]=o.current}n.onUpdate&&n.onUpdate(this.target,t),1===t&&n.onComplete&&n.onComplete(this.target)}progress(t,e,i,n){return t+(e-t)*n}}t("TweenAction",jct);class Wct extends Ict{constructor(t){super(),this._props=void 0,this._props={},void 0!==t&&this.init(t)}init(t){for(const e in t)this._props[e]=t[e];return!0}update(){const t=this._props,e=this.target;for(const i in t)e[i]=t[i]}clone(){const t=new Wct;return t.init(this._props),t}}class qct{constructor(t){this._actions=[],this._finalAction=null,this._target=null,this._tag=Act.TAG_INVALID,this._target=void 0===t?null:t}tag(t){return this._tag=t,this}then(t){return t instanceof Act?this._actions.push(t.clone()):this._actions.push(t._union()),this}target(t){return this._target=t,this}start(){return this._target?(this._finalAction&&wct.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),wct.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(y("Please set target to tween first"),this)}stop(){return this._finalAction&&wct.instance.ActionManager.removeAction(this._finalAction),this}clone(t){const e=this._union();return Xct(t).then(e.clone())}union(){const t=this._union();return this._actions.length=0,this._actions.push(t),this}to(t,e,i){(i=i||Object.create(null)).relative=!1;const n=new jct(t,e,i);return this._actions.push(n),this}by(t,e,i){(i=i||Object.create(null)).relative=!0;const n=new jct(t,e,i);return this._actions.push(n),this}set(t){const e=new Wct(t);return this._actions.push(e),this}delay(t){const e=kct(t);return this._actions.push(e),this}call(t){const e=new Oct(t,undefined,undefined);return this._actions.push(e),this}sequence(...t){const e=qct._wrappedSequence(...t);return this._actions.push(e),this}parallel(...t){const e=qct._wrappedParallel(...t);return this._actions.push(e),this}repeat(t,e){if(t===1/0)return this.repeatForever(e);const i=this._actions;let n;return n=e instanceof qct?e._union():i.pop(),i.push(function(t,e){return new Fct(t,e)}(n,t)),this}repeatForever(t){const e=this._actions;let i;return i=t instanceof qct?t._union():e.pop(),e.push(function(t){return new zct(t)}(i)),this}reverseTime(t){const e=this._actions;let i;return i=t instanceof qct?t._union():e.pop(),e.push(function(t){return new Hct(t)}(i)),this}hide(){const t=new Dct;return this._actions.push(t),this}show(){const t=new Rct;return this._actions.push(t),this}removeSelf(){const t=new Mct(!1);return this._actions.push(t),this}static stopAll(){wct.instance.ActionManager.removeAllActions()}static stopAllByTag(t,e){wct.instance.ActionManager.removeAllActionsByTag(t,e)}static stopAllByTarget(t){wct.instance.ActionManager.removeAllActionsFromTarget(t)}_union(){const t=this._actions;let e;return e=1===t.length?t[0]:Lct(t),e}_destroy(){this.stop()}static _wrappedSequence(...t){const e=qct._tmp_args;e.length=0;for(let i=t.length,n=0;n<i;n++){const i=e[n]=t[n];i instanceof qct&&(e[n]=i._union())}return Lct.apply(Lct,e)}static _wrappedParallel(...t){const e=qct._tmp_args;e.length=0;for(let i=t.length,n=0;n<i;n++){const i=e[n]=t[n];i instanceof qct&&(e[n]=i._union())}return Gct.apply(Gct,e)}}function Xct(t){return new qct(t)}function Yct(t){return y("tweenUtil' is deprecated, please use 'tween' instead "),new qct(t)}var Kct,Jct,$ct,Zct,Qct,tlt,elt,ilt,nlt,slt,rlt,olt,alt,clt,llt,hlt,_lt,ult,dlt,mlt,plt,flt,glt,vlt,ylt,xlt,Slt,Clt,Alt,blt,Tlt,Elt,Plt,wlt,Ilt,Rlt,Dlt,Mlt,Olt,Blt,Nlt,Llt,Flt,zlt,Vlt,Glt,Ult,klt,Hlt,jlt,Wlt,qlt,Xlt,Ylt,Klt,Jlt,$lt,Zlt,Qlt,tht;t("Tween",qct),qct._tmp_args=[],l.Tween=qct,l.tween=Xct,l.tweenUtil=Yct;const eht=new hi;var iht,nht;let sht;!function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.SPRITE=2]="SPRITE",t[t.SCALE=3]="SCALE"}(iht||(iht={})),Xt(iht),function(t){t.NORMAL="normal",t.HOVER="hover",t.PRESSED="pressed",t.DISABLED="disabled"}(nht||(nht={})),function(t){t.CLICK="click"}(sht||(sht={}));let rht,oht,aht,cht=function(e){return t({Button:e,ButtonComponent:e}),e}((Kct=dc("cc.Button"),Jct=Dc(),$ct=pc(110),Zct=Pc(),Qct=mc(SO),tlt=Kc(iS),elt=kc(),ilt=Lc(),nlt=kc(),slt=Lc(),rlt=Kc(iht),olt=kc(),alt=Lc(),clt=kc(),llt=Lc(),hlt=kc(),_lt=Lc(),ult=kc(),dlt=Lc(),mlt=kc(),plt=Lc(),flt=zc(),glt=Vc(),vlt=kc(),ylt=Lc(),xlt=kc(),Slt=Lc(),Clt=Kc(jD),Alt=kc(),blt=Lc(),Tlt=Kc(jD),Elt=kc(),Plt=Lc(),wlt=Kc(jD),Ilt=kc(),Rlt=Lc(),Dlt=Kc(jD),Mlt=kc(),Olt=Lc(),Blt=Kc([KI]),Nlt=kc(),Llt=Lc(),Kct(Flt=Jct(Flt=$ct(Flt=Zct(Flt=Qct(Flt=Ec((tht=Qlt=class extends Lh{constructor(...t){super(...t),nc(this,"clickEvents",Vlt,this),nc(this,"_interactable",Glt,this),nc(this,"_transition",Ult,this),nc(this,"_normalColor",klt,this),nc(this,"_hoverColor",Hlt,this),nc(this,"_pressedColor",jlt,this),nc(this,"_disabledColor",Wlt,this),nc(this,"_normalSprite",qlt,this),nc(this,"_hoverSprite",Xlt,this),nc(this,"_pressedSprite",Ylt,this),nc(this,"_disabledSprite",Klt,this),nc(this,"_duration",Jlt,this),nc(this,"_zoomScale",$lt,this),nc(this,"_target",Zlt,this),this._pressed=!1,this._hovered=!1,this._fromColor=new hi,this._toColor=new hi,this._time=0,this._transitionFinished=!0,this._fromScale=new mi,this._toScale=new mi,this._originalScale=null,this._sprite=null,this._targetScale=new mi}get target(){return this._target||this.node}set target(t){this._target!==t&&(this._target&&this._unregisterTargetEvent(this._target),this._target=t,this._applyTarget())}get interactable(){return this._interactable}set interactable(t){this._interactable!==t&&(this._interactable=t,this._updateState(),this._interactable||this._resetState())}set _resizeToTarget(t){t&&this._resizeNodeToTargetNode()}get transition(){return this._transition}set transition(t){this._transition!==t&&(this._transition===iht.COLOR?this._updateColorTransition(nht.NORMAL):this._transition===iht.SPRITE&&this._updateSpriteTransition(nht.NORMAL),this._transition=t,this._updateState())}get normalColor(){return this._normalColor}set normalColor(t){this._normalColor!==t&&(this._normalColor.set(t),this._updateState())}get pressedColor(){return this._pressedColor}set pressedColor(t){this._pressedColor!==t&&this._pressedColor.set(t)}get hoverColor(){return this._hoverColor}set hoverColor(t){this._hoverColor!==t&&this._hoverColor.set(t)}get disabledColor(){return this._disabledColor}set disabledColor(t){this._disabledColor!==t&&(this._disabledColor.set(t),this._updateState())}get duration(){return this._duration}set duration(t){this._duration!==t&&(this._duration=t)}get zoomScale(){return this._zoomScale}set zoomScale(t){this._zoomScale!==t&&(this._zoomScale=t)}get normalSprite(){return this._normalSprite}set normalSprite(t){if(this._normalSprite===t)return;this._normalSprite=t;const e=this.node.getComponent(FF);e&&(e.spriteFrame=t),this._updateState()}get pressedSprite(){return this._pressedSprite}set pressedSprite(t){this._pressedSprite!==t&&(this._pressedSprite=t,this._updateState())}get hoverSprite(){return this._hoverSprite}set hoverSprite(t){this._hoverSprite!==t&&(this._hoverSprite=t,this._updateState())}get disabledSprite(){return this._disabledSprite}set disabledSprite(t){this._disabledSprite!==t&&(this._disabledSprite=t,this._updateState())}__preload(){this.target||(this.target=this.node);const t=this.node.getComponent(FF);t&&(this._normalSprite=t.spriteFrame),this._applyTarget(),this._resetState()}onEnable(){this._registerNodeEvent()}onDisable(){this._resetState(),this._unregisterNodeEvent()}onDestroy(){this.target.isValid&&this._unregisterTargetEvent(this.target)}update(t){const e=this.target;if(this._transitionFinished||!e)return;if(this._transition!==iht.COLOR&&this._transition!==iht.SCALE)return;this._time+=t;let i=1;if(this._duration>0&&(i=this._time/this._duration),i>=1&&(i=1),this._transition===iht.COLOR){const t=e._uiProps.uiComp;hi.lerp(eht,this._fromColor,this._toColor,i),t&&(t.color=eht)}else this.transition===iht.SCALE&&(e.getScale(this._targetScale),this._targetScale.x=Xe(this._fromScale.x,this._toScale.x,i),this._targetScale.y=Xe(this._fromScale.y,this._toScale.y,i),e.setScale(this._targetScale));1===i&&(this._transitionFinished=!0)}_resizeNodeToTargetNode(){this.target&&this.target._uiProps.uiTransformComp}_resetState(){this._pressed=!1,this._hovered=!1;const t=this.target;if(!t)return;const e=this._transition;if(e===iht.COLOR&&this._interactable){const e=t.getComponent(HO);e&&(e.color=this._normalColor)}else e===iht.SCALE&&this._originalScale&&t.setScale(this._originalScale);this._transitionFinished=!0}_registerNodeEvent(){this.node.on(fx.TOUCH_START,this._onTouchBegan,this),this.node.on(fx.TOUCH_MOVE,this._onTouchMove,this),this.node.on(fx.TOUCH_END,this._onTouchEnded,this),this.node.on(fx.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(fx.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(fx.MOUSE_LEAVE,this._onMouseMoveOut,this)}_registerTargetEvent(t){t.on(fx.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)}_unregisterNodeEvent(){this.node.off(fx.TOUCH_START,this._onTouchBegan,this),this.node.off(fx.TOUCH_MOVE,this._onTouchMove,this),this.node.off(fx.TOUCH_END,this._onTouchEnded,this),this.node.off(fx.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(fx.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(fx.MOUSE_LEAVE,this._onMouseMoveOut,this)}_unregisterTargetEvent(t){t.off(fx.TRANSFORM_CHANGED)}_getTargetSprite(t){let e=null;return t&&(e=t.getComponent(FF)),e}_applyTarget(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new mi),mi.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))}_onTargetSpriteFrameChanged(t){this._transition===iht.SPRITE&&this._setCurrentStateSpriteFrame(t.spriteFrame)}_setCurrentStateSpriteFrame(t){if(t)switch(this._getButtonState()){case nht.NORMAL:this._normalSprite=t;break;case nht.HOVER:this._hoverSprite=t;break;case nht.PRESSED:this._pressedSprite=t;break;case nht.DISABLED:this._disabledSprite=t}}_onTargetColorChanged(t){this._transition===iht.COLOR&&this._setCurrentStateColor(t)}_setCurrentStateColor(t){switch(this._getButtonState()){case nht.NORMAL:this._normalColor=t;break;case nht.HOVER:this._hoverColor=t;break;case nht.PRESSED:this._pressedColor=t;break;case nht.DISABLED:this._disabledColor=t}}_onTargetTransformChanged(t){t&bv.SCALE&&this._originalScale&&this._transition===iht.SCALE&&this._transitionFinished&&mi.copy(this._originalScale,this.target.getScale())}_onTouchBegan(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),t&&(t.propagationStopped=!0))}_onTouchMove(t){if(!this._interactable||!this.enabledInHierarchy||!this._pressed)return;if(!t)return;const e=t.touch;if(!e)return;const i=this.node._uiProps.uiTransformComp.hitTest(e.getLocation());if(this._transition===iht.SCALE&&this.target&&this._originalScale)i?(mi.copy(this._fromScale,this._originalScale),mi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale));else{let t;t=i?nht.PRESSED:nht.NORMAL,this._applyTransition(t)}t&&(t.propagationStopped=!0)}_onTouchEnded(t){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(KI.emitEvents(this.clickEvents,t),this.node.emit(sht.CLICK,this)),this._pressed=!1,this._updateState(),t&&(t.propagationStopped=!0))}_onTouchCancel(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}_onMouseMoveIn(t){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==iht.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}_onMouseMoveOut(t){this._hovered&&(this._hovered=!1,this._updateState())}_updateState(){const t=this._getButtonState();this._applyTransition(t)}_getButtonState(){let t=nht.NORMAL;return this._interactable?this._pressed?t=nht.PRESSED:this._hovered&&(t=nht.HOVER):t=nht.DISABLED,t.toString()}_updateColorTransition(t){var e;const i=this[`${t}Color`],n=null===(e=this.target)||void 0===e?void 0:e.getComponent(HO);n&&(t===nht.DISABLED?n.color=i:(this._fromColor=n.color.clone(),this._toColor=i,this._time=0,this._transitionFinished=!1))}_updateSpriteTransition(t){const e=this[`${t}Sprite`];this._sprite&&e&&(this._sprite.spriteFrame=e)}_updateScaleTransition(t){this._interactable&&(t===nht.PRESSED?this._zoomUp():this._zoomBack())}_zoomUp(){this._originalScale&&(mi.copy(this._fromScale,this._originalScale),mi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)}_zoomBack(){this.target&&this._originalScale&&(mi.copy(this._fromScale,this.target.getScale()),mi.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}_applyTransition(t){const e=this._transition;e===iht.COLOR?this._updateColorTransition(t):e===iht.SPRITE?this._updateSpriteTransition(t):e===iht.SCALE&&this._updateScaleTransition(t)}},Qlt.Transition=iht,Qlt.EventType=sht,sc((zlt=tht).prototype,"target",[tlt,elt,ilt],Object.getOwnPropertyDescriptor(zlt.prototype,"target"),zlt.prototype),sc(zlt.prototype,"interactable",[nlt,slt],Object.getOwnPropertyDescriptor(zlt.prototype,"interactable"),zlt.prototype),sc(zlt.prototype,"transition",[rlt,olt,alt],Object.getOwnPropertyDescriptor(zlt.prototype,"transition"),zlt.prototype),sc(zlt.prototype,"normalColor",[clt,llt],Object.getOwnPropertyDescriptor(zlt.prototype,"normalColor"),zlt.prototype),sc(zlt.prototype,"pressedColor",[hlt,_lt],Object.getOwnPropertyDescriptor(zlt.prototype,"pressedColor"),zlt.prototype),sc(zlt.prototype,"hoverColor",[ult,dlt],Object.getOwnPropertyDescriptor(zlt.prototype,"hoverColor"),zlt.prototype),sc(zlt.prototype,"disabledColor",[mlt,plt],Object.getOwnPropertyDescriptor(zlt.prototype,"disabledColor"),zlt.prototype),sc(zlt.prototype,"duration",[flt,glt,vlt,ylt],Object.getOwnPropertyDescriptor(zlt.prototype,"duration"),zlt.prototype),sc(zlt.prototype,"zoomScale",[xlt,Slt],Object.getOwnPropertyDescriptor(zlt.prototype,"zoomScale"),zlt.prototype),sc(zlt.prototype,"normalSprite",[Clt,Alt,blt],Object.getOwnPropertyDescriptor(zlt.prototype,"normalSprite"),zlt.prototype),sc(zlt.prototype,"pressedSprite",[Tlt,Elt,Plt],Object.getOwnPropertyDescriptor(zlt.prototype,"pressedSprite"),zlt.prototype),sc(zlt.prototype,"hoverSprite",[wlt,Ilt,Rlt],Object.getOwnPropertyDescriptor(zlt.prototype,"hoverSprite"),zlt.prototype),sc(zlt.prototype,"disabledSprite",[Dlt,Mlt,Olt],Object.getOwnPropertyDescriptor(zlt.prototype,"disabledSprite"),zlt.prototype),Vlt=sc(zlt.prototype,"clickEvents",[Blt,Sc,Nlt,Llt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Glt=sc(zlt.prototype,"_interactable",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ult=sc(zlt.prototype,"_transition",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iht.NONE}}),klt=sc(zlt.prototype,"_normalColor",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hi.WHITE.clone()}}),Hlt=sc(zlt.prototype,"_hoverColor",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(211,211,211,255)}}),jlt=sc(zlt.prototype,"_pressedColor",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hi.WHITE.clone()}}),Wlt=sc(zlt.prototype,"_disabledColor",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(124,124,124,255)}}),qlt=sc(zlt.prototype,"_normalSprite",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xlt=sc(zlt.prototype,"_hoverSprite",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ylt=sc(zlt.prototype,"_pressedSprite",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Klt=sc(zlt.prototype,"_disabledSprite",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jlt=sc(zlt.prototype,"_duration",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),$lt=sc(zlt.prototype,"_zoomScale",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Zlt=sc(zlt.prototype,"_target",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Flt=zlt))||Flt)||Flt)||Flt)||Flt)||Flt)||Flt));l.Button=cht;(function(t){t[t.DEFAULT=0]="DEFAULT",t[t.DONE=1]="DONE",t[t.SEND=2]="SEND",t[t.SEARCH=3]="SEARCH",t[t.GO=4]="GO",t[t.NEXT=5]="NEXT"})(rht||(rht={})),jt(rht),function(t){t[t.ANY=0]="ANY",t[t.EMAIL_ADDR=1]="EMAIL_ADDR",t[t.NUMERIC=2]="NUMERIC",t[t.PHONE_NUMBER=3]="PHONE_NUMBER",t[t.URL=4]="URL",t[t.DECIMAL=5]="DECIMAL",t[t.SINGLE_LINE=6]="SINGLE_LINE"}(oht||(oht={})),jt(oht),function(t){t[t.PASSWORD=0]="PASSWORD",t[t.SENSITIVE=1]="SENSITIVE",t[t.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",t[t.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",t[t.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",t[t.DEFAULT=5]="DEFAULT"}(aht||(aht={})),jt(aht);var lht,hht,_ht,uht,dht,mht,pht,fht,ght,vht,yht,xht,Sht,Cht,Aht,bht,Tht,Eht,Pht,wht,Iht,Rht,Dht,Mht,Oht,Bht,Nht,Lht,Fht,zht,Vht,Ght,Uht,kht,Hht,jht,Wht,qht,Xht,Yht,Kht,Jht,$ht,Zht,Qht,t_t,e_t,i_t,n_t,s_t,r_t,o_t,a_t,c_t,l_t,h_t,__t,u_t,d_t,m_t,p_t;new Ii,new Ii,new mi,function(t){t.EDITING_DID_BEGAN="editing-did-began",t.EDITING_DID_ENDED="editing-did-ended",t.TEXT_CHANGED="text-changed",t.EDITING_RETURN="editing-return"}(p_t||(p_t={}));let f_t=function(e){return t({EditBox:e,EditBoxComponent:e}),e}((lht=dc("cc.EditBox"),hht=Dc(),_ht=pc(110),uht=Pc(),dht=mc(SO),mht=kc(),pht=Lc(),fht=kc(),ght=Lc(),vht=Kc(lN),yht=kc(),xht=Lc(),Sht=Kc(lN),Cht=kc(),Aht=Lc(),bht=Kc(jD),Tht=kc(),Eht=Lc(),Pht=Kc(aht),wht=kc(),Iht=Lc(),Rht=Kc(oht),Dht=kc(),Mht=Lc(),Oht=Kc(rht),Bht=kc(),Nht=Lc(),Lht=kc(),Fht=Lc(),zht=kc(),Vht=Lc(),Ght=Kc([KI]),Uht=kc(),kht=Lc(),Hht=Kc([KI]),jht=kc(),Wht=Lc(),qht=Kc([KI]),Xht=kc(),Yht=Lc(),Kht=Kc([KI]),Jht=kc(),$ht=Lc(),lht(Zht=hht(Zht=_ht(Zht=uht(Zht=dht(Zht=Ec((m_t=d_t=class t extends Lh{constructor(...t){super(...t),nc(this,"editingDidBegan",t_t,this),nc(this,"textChanged",e_t,this),nc(this,"editingDidEnded",i_t,this),nc(this,"editingReturn",n_t,this),this._impl=null,this._background=null,nc(this,"_textLabel",s_t,this),nc(this,"_placeholderLabel",r_t,this),nc(this,"_returnType",o_t,this),nc(this,"_string",a_t,this),nc(this,"_tabIndex",c_t,this),nc(this,"_backgroundImage",l_t,this),nc(this,"_inputFlag",h_t,this),nc(this,"_inputMode",__t,this),nc(this,"_maxLength",u_t,this),this._isLabelVisible=!1}get string(){return this._string}set string(t){this._maxLength>=0&&t.length>=this._maxLength&&(t=t.slice(0,this._maxLength)),this._string!==t&&(this._string=t,this._updateString(t))}get placeholder(){return this._placeholderLabel?this._placeholderLabel.string:""}set placeholder(t){this._placeholderLabel&&(this._placeholderLabel.string=t)}get textLabel(){return this._textLabel}set textLabel(t){this._textLabel!==t&&(this._textLabel=t,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}get placeholderLabel(){return this._placeholderLabel}set placeholderLabel(t){this._placeholderLabel!==t&&(this._placeholderLabel=t,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}get backgroundImage(){return this._backgroundImage}set backgroundImage(t){this._backgroundImage!==t&&(this._backgroundImage=t,this._ensureBackgroundSprite(),this._background.spriteFrame=t)}get inputFlag(){return this._inputFlag}set inputFlag(t){this._inputFlag!==t&&(this._inputFlag=t,this._updateString(this._string))}get inputMode(){return this._inputMode}set inputMode(t){this._inputMode!==t&&(this._inputMode=t,this._updateTextLabel(),this._updatePlaceholderLabel())}get returnType(){return this._returnType}set returnType(t){this._returnType=t}get maxLength(){return this._maxLength}set maxLength(t){this._maxLength=t}get tabIndex(){return this._tabIndex}set tabIndex(t){this._tabIndex!==t&&(this._tabIndex=t,this._impl&&this._impl.setTabIndex(t))}__preload(){this._init()}onEnable(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()}update(){this._impl&&this._impl.update()}onDisable(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()}onDestroy(){this._impl&&this._impl.clear()}setFocus(){this._impl&&this._impl.setFocus(!0)}focus(){this._impl&&this._impl.setFocus(!0)}blur(){this._impl&&this._impl.setFocus(!1)}isFocused(){return!!this._impl&&this._impl.isFocused()}_editBoxEditingDidBegan(){KI.emitEvents(this.editingDidBegan,this),this.node.emit(p_t.EDITING_DID_BEGAN,this)}_editBoxEditingDidEnded(){KI.emitEvents(this.editingDidEnded,this),this.node.emit(p_t.EDITING_DID_ENDED,this)}_editBoxTextChanged(t){t=this._updateLabelStringStyle(t,!0),this.string=t,KI.emitEvents(this.textChanged,t,this),this.node.emit(p_t.TEXT_CHANGED,this)}_editBoxEditingReturn(){KI.emitEvents(this.editingReturn,this),this.node.emit(p_t.EDITING_RETURN,this)}_showLabels(){this._isLabelVisible=!0,this._updateLabels()}_hideLabels(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}_onTouchBegan(t){t.propagationStopped=!0}_onTouchCancel(t){t.propagationStopped=!0}_onTouchEnded(t){this._impl&&this._impl.beginEditing(),t.propagationStopped=!0}_init(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(fx.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()}_ensureBackgroundSprite(){if(!this._background){let t=this.node.getComponent(FF);t||(t=this.node.addComponent(FF)),t!==this._background&&(t.type=FF.Type.SLICED,t.spriteFrame=this._backgroundImage,this._background=t,this._registerBackgroundEvent())}}_updateTextLabel(){let t=this._textLabel;if(!t){let e=this.node.getChildByName("TEXT_LABEL");e||(e=new iS("TEXT_LABEL"),e.layer=this.node.layer),t=e.getComponent(lN),t||(t=e.addComponent(lN)),e.parent=this.node,this._textLabel=t}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=lN.Overflow.CLAMP,this._inputMode===oht.ANY?(t.verticalAlign=nN.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this._updateLabelStringStyle(this._string)}_updatePlaceholderLabel(){let t=this._placeholderLabel;if(!t){let e=this.node.getChildByName("PLACEHOLDER_LABEL");e||(e=new iS("PLACEHOLDER_LABEL"),e.layer=this.node.layer),t=e.getComponent(lN),t||(t=e.addComponent(lN)),e.parent=this.node,this._placeholderLabel=t}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),this._inputMode===oht.ANY?t.enableWrapText=!0:t.enableWrapText=!1,t.string=this.placeholder}_syncSize(){const t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(this._background){const i=this._background.node._uiProps.uiTransformComp;i.anchorPoint=t.anchorPoint,i.setContentSize(e)}this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}_updateLabels(){if(this._isLabelVisible){const t=this._string;this._textLabel&&(this._textLabel.node.active=""!==t),this._placeholderLabel&&(this._placeholderLabel.node.active=""===t)}}_updateString(t){const e=this._textLabel;if(!e)return;let i=t;i&&(i=this._updateLabelStringStyle(i)),e.string=i,this._updateLabels()}_updateLabelStringStyle(t,e=!1){const i=this._inputFlag;if(e||i!==aht.PASSWORD)i===aht.INITIAL_CAPS_ALL_CHARACTERS?t=t.toUpperCase():i===aht.INITIAL_CAPS_WORD?t=t.replace(/(?:^|\s)\S/g,(t=>t.toUpperCase())):i===aht.INITIAL_CAPS_SENTENCE&&(t=(n=t).charAt(0).toUpperCase()+n.slice(1));else{let e="";const i=t.length;for(let t=0;t<i;++t)e+="●";t=e}var n;return t}_registerEvent(){this.node.on(fx.TOUCH_START,this._onTouchBegan,this),this.node.on(fx.TOUCH_END,this._onTouchEnded,this)}_unregisterEvent(){this.node.off(fx.TOUCH_START,this._onTouchBegan,this),this.node.off(fx.TOUCH_END,this._onTouchEnded,this)}_onBackgroundSpriteFrameChanged(){this._background&&(this.backgroundImage=this._background.spriteFrame)}_registerBackgroundEvent(){const t=this._background&&this._background.node;null==t||t.on(FF.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)}_unregisterBackgroundEvent(){const t=this._background&&this._background.node;null==t||t.off(FF.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)}_updateLabelPosition(t){const e=this.node._uiProps.uiTransformComp,i=-e.anchorX*e.width,n=-e.anchorY*e.height,s=this._placeholderLabel,r=this._textLabel;r&&(r.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),r.node.setPosition(i+2,n+t.height,r.node.position.z),this._inputMode===oht.ANY&&(r.verticalAlign=nN.TOP),r.enableWrapText=this._inputMode===oht.ANY),s&&(s.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),s.lineHeight=t.height,s.node.setPosition(i+2,n+t.height,s.node.position.z),s.enableWrapText=this._inputMode===oht.ANY)}_resizeChildNodes(){const t=this.node._uiProps.uiTransformComp,e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-t.width/2,t.height/2,e.position.z),e._uiProps.uiTransformComp.setContentSize(t.contentSize));const i=this._placeholderLabel&&this._placeholderLabel.node;i&&(i.setPosition(-t.width/2,t.height/2,i.position.z),i._uiProps.uiTransformComp.setContentSize(t.contentSize));const n=this._background&&this._background.node;n&&n._uiProps.uiTransformComp.setContentSize(t.contentSize),this._syncSize()}},d_t._EditBoxImpl=class{constructor(){this._editing=!1,this._delegate=null}init(t){}onEnable(){}update(){}onDisable(){this._editing&&this.endEditing()}clear(){this._delegate=null}setTabIndex(t){}setSize(t,e){}setFocus(t){t?this.beginEditing():this.endEditing()}isFocused(){return this._editing}beginEditing(){}endEditing(){}},d_t.KeyboardReturnType=rht,d_t.InputFlag=aht,d_t.InputMode=oht,d_t.EventType=p_t,sc((Qht=m_t).prototype,"string",[mht,pht],Object.getOwnPropertyDescriptor(Qht.prototype,"string"),Qht.prototype),sc(Qht.prototype,"placeholder",[fht,ght],Object.getOwnPropertyDescriptor(Qht.prototype,"placeholder"),Qht.prototype),sc(Qht.prototype,"textLabel",[vht,yht,xht],Object.getOwnPropertyDescriptor(Qht.prototype,"textLabel"),Qht.prototype),sc(Qht.prototype,"placeholderLabel",[Sht,Cht,Aht],Object.getOwnPropertyDescriptor(Qht.prototype,"placeholderLabel"),Qht.prototype),sc(Qht.prototype,"backgroundImage",[bht,Tht,Eht],Object.getOwnPropertyDescriptor(Qht.prototype,"backgroundImage"),Qht.prototype),sc(Qht.prototype,"inputFlag",[Pht,wht,Iht],Object.getOwnPropertyDescriptor(Qht.prototype,"inputFlag"),Qht.prototype),sc(Qht.prototype,"inputMode",[Rht,Dht,Mht],Object.getOwnPropertyDescriptor(Qht.prototype,"inputMode"),Qht.prototype),sc(Qht.prototype,"returnType",[Oht,Bht,Nht],Object.getOwnPropertyDescriptor(Qht.prototype,"returnType"),Qht.prototype),sc(Qht.prototype,"maxLength",[Lht,Fht],Object.getOwnPropertyDescriptor(Qht.prototype,"maxLength"),Qht.prototype),sc(Qht.prototype,"tabIndex",[zht,Vht],Object.getOwnPropertyDescriptor(Qht.prototype,"tabIndex"),Qht.prototype),t_t=sc(Qht.prototype,"editingDidBegan",[Ght,Sc,Uht,kht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),e_t=sc(Qht.prototype,"textChanged",[Hht,Sc,jht,Wht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),i_t=sc(Qht.prototype,"editingDidEnded",[qht,Sc,Xht,Yht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),n_t=sc(Qht.prototype,"editingReturn",[Kht,Sc,Jht,$ht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),s_t=sc(Qht.prototype,"_textLabel",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),r_t=sc(Qht.prototype,"_placeholderLabel",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),o_t=sc(Qht.prototype,"_returnType",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rht.DEFAULT}}),a_t=sc(Qht.prototype,"_string",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),c_t=sc(Qht.prototype,"_tabIndex",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),l_t=sc(Qht.prototype,"_backgroundImage",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),h_t=sc(Qht.prototype,"_inputFlag",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return aht.DEFAULT}}),__t=sc(Qht.prototype,"_inputMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oht.ANY}}),u_t=sc(Qht.prototype,"_maxLength",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),Zht=Qht))||Zht)||Zht)||Zht)||Zht)||Zht)||Zht));var g_t,v_t,y_t,x_t,S_t,C_t,A_t,b_t,T_t,E_t,P_t,w_t,I_t,R_t,D_t,M_t,O_t,B_t,N_t,L_t,F_t,z_t,V_t,G_t,U_t,k_t,H_t,j_t,W_t,q_t,X_t,Y_t,K_t,J_t,$_t,Z_t,Q_t,tut,eut,iut,nut,sut,rut,out,aut,cut,lut,hut,_ut,uut,dut,mut,put,fut,gut,vut,yut,xut,Sut,Cut,Aut,but;l.internal.EditBox=f_t,function(t){t[t.NONE=0]="NONE",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.GRID=3]="GRID"}(vut||(vut={})),Xt(vut),function(t){t[t.NONE=0]="NONE",t[t.CONTAINER=1]="CONTAINER",t[t.CHILDREN=2]="CHILDREN"}(yut||(yut={})),Xt(yut),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(xut||(xut={})),Xt(xut),function(t){t[t.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",t[t.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(Sut||(Sut={})),Xt(Sut),function(t){t[t.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",t[t.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(Cut||(Cut={})),Xt(Cut),(but=Aut||(Aut={}))[but.NONE=0]="NONE",but[but.FIXED_ROW=1]="FIXED_ROW",but[but.FIXED_COL=2]="FIXED_COL",Xt(Aut);const Tut=new mi;let Eut=function(e){return t({Layout:e,LayoutComponent:e}),e}((g_t=dc("cc.Layout"),v_t=Dc(),y_t=pc(110),x_t=Pc(),S_t=mc(SO),C_t=Oc(),A_t=Lc(),b_t=Oc(),T_t=Lc(),E_t=Kc(vut),P_t=kc(),w_t=Lc(),I_t=Kc(yut),R_t=Oc(),D_t=Lc(),M_t=Oc(),O_t=Lc(),B_t=Kc(xut),N_t=Lc(),L_t=Lc(),F_t=Lc(),z_t=Lc(),V_t=Lc(),G_t=Lc(),U_t=Lc(),k_t=Kc(Sut),H_t=Lc(),j_t=Kc(Cut),W_t=Lc(),q_t=Kc(Aut),X_t=Oc(),Y_t=Lc(),K_t=Oc(),J_t=Lc(),$_t=Lc(),g_t(Z_t=v_t(Z_t=y_t(Z_t=x_t(Z_t=S_t(Z_t=Ec((gut=fut=class extends Lh{constructor(...t){super(...t),nc(this,"_resizeMode",tut,this),nc(this,"_layoutType",eut,this),nc(this,"_cellSize",iut,this),nc(this,"_startAxis",nut,this),nc(this,"_paddingLeft",sut,this),nc(this,"_paddingRight",rut,this),nc(this,"_paddingTop",out,this),nc(this,"_paddingBottom",aut,this),nc(this,"_spacingX",cut,this),nc(this,"_spacingY",lut,this),nc(this,"_verticalDirection",hut,this),nc(this,"_horizontalDirection",_ut,this),nc(this,"_constraint",uut,this),nc(this,"_constraintNum",dut,this),nc(this,"_affectedByScale",mut,this),nc(this,"_isAlign",put,this),this._layoutSize=new Gi(300,200),this._layoutDirty=!0,this._childrenDirty=!1,this._usefulLayoutObj=[],this._init=!1}get alignHorizontal(){return this._isAlign}set alignHorizontal(t){this._layoutType===vut.HORIZONTAL&&(this._isAlign=t,this._doLayoutDirty())}get alignVertical(){return this._isAlign}set alignVertical(t){this._layoutType===vut.VERTICAL&&(this._isAlign=t,this._doLayoutDirty())}get type(){return this._layoutType}set type(t){this._layoutType=t,this._doLayoutDirty()}get resizeMode(){return this._resizeMode}set resizeMode(t){this._layoutType!==vut.NONE&&(this._resizeMode=t,this._doLayoutDirty())}get cellSize(){return this._cellSize}set cellSize(t){this._cellSize!==t&&(this._cellSize.set(t),this._doLayoutDirty())}get startAxis(){return this._startAxis}set startAxis(t){this._startAxis!==t&&(this._startAxis=t,this._doLayoutDirty())}get paddingLeft(){return this._paddingLeft}set paddingLeft(t){this._paddingLeft!==t&&(this._paddingLeft=t,this._doLayoutDirty())}get paddingRight(){return this._paddingRight}set paddingRight(t){this._paddingRight!==t&&(this._paddingRight=t,this._doLayoutDirty())}get paddingTop(){return this._paddingTop}set paddingTop(t){this._paddingTop!==t&&(this._paddingTop=t,this._doLayoutDirty())}get paddingBottom(){return this._paddingBottom}set paddingBottom(t){this._paddingBottom!==t&&(this._paddingBottom=t,this._doLayoutDirty())}get spacingX(){return this._spacingX}set spacingX(t){this._spacingX!==t&&(this._spacingX=t,this._doLayoutDirty())}get spacingY(){return this._spacingY}set spacingY(t){this._spacingY!==t&&(this._spacingY=t,this._doLayoutDirty())}get verticalDirection(){return this._verticalDirection}set verticalDirection(t){this._verticalDirection!==t&&(this._verticalDirection=t,this._doLayoutDirty())}get horizontalDirection(){return this._horizontalDirection}set horizontalDirection(t){this._horizontalDirection!==t&&(this._horizontalDirection=t,this._doLayoutDirty())}get padding(){return this._paddingLeft}set padding(t){this.paddingLeft===t&&this._paddingRight===t&&this._paddingTop===t&&this._paddingBottom===t||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=t,this._doLayoutDirty())}get constraint(){return this._constraint}set constraint(t){this._layoutType!==vut.NONE&&this._constraint!==t&&(this._constraint=t,this._doLayoutDirty())}get constraintNum(){return this._constraintNum}set constraintNum(t){this._constraint!==Aut.NONE&&this._constraintNum!==t&&(t<=0&&y("Limit values to be greater than 0"),this._constraintNum=t,this._doLayoutDirty())}get affectedByScale(){return this._affectedByScale}set affectedByScale(t){this._affectedByScale=t,this._doLayoutDirty()}updateLayout(t=!1){(this._layoutDirty||t)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)}onEnable(){this._addEventListeners();const t=this.node._uiProps.uiTransformComp;t.contentSize.equals(Gi.ZERO)&&t.setContentSize(this._layoutSize),this._childrenChanged()}onDisable(){this._usefulLayoutObj.length=0,this._removeEventListeners()}_checkUsefulObj(){this._usefulLayoutObj.length=0;const t=this.node.children;for(let e=0;e<t.length;++e){const i=t[e],n=i._uiProps.uiTransformComp;i.activeInHierarchy&&n&&this._usefulLayoutObj.push(n)}}_addEventListeners(){mw.on(dw.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(fx.SIZE_CHANGED,this._resized,this),this.node.on(fx.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(fx.CHILD_ADDED,this._childAdded,this),this.node.on(fx.CHILD_REMOVED,this._childRemoved,this),this.node.on(fx.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()}_removeEventListeners(){mw.off(dw.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(fx.SIZE_CHANGED,this._resized,this),this.node.off(fx.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(fx.CHILD_ADDED,this._childAdded,this),this.node.off(fx.CHILD_REMOVED,this._childRemoved,this),this.node.off(fx.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()}_addChildrenEventListeners(){const t=this.node.children;for(let e=0;e<t.length;++e){const i=t[e];i.on(fx.SIZE_CHANGED,this._doLayoutDirty,this),i.on(fx.TRANSFORM_CHANGED,this._transformDirty,this),i.on(fx.ANCHOR_CHANGED,this._doLayoutDirty,this),i.on(fx.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}}_removeChildrenEventListeners(){const t=this.node.children;for(let e=0;e<t.length;++e){const i=t[e];i.off(fx.SIZE_CHANGED,this._doLayoutDirty,this),i.off(fx.TRANSFORM_CHANGED,this._transformDirty,this),i.off(fx.ANCHOR_CHANGED,this._doLayoutDirty,this),i.off(fx.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}}_childAdded(t){t.on(fx.SIZE_CHANGED,this._doLayoutDirty,this),t.on(fx.TRANSFORM_CHANGED,this._transformDirty,this),t.on(fx.ANCHOR_CHANGED,this._doLayoutDirty,this),t.on(fx.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()}_childRemoved(t){t.off(fx.SIZE_CHANGED,this._doLayoutDirty,this),t.off(fx.TRANSFORM_CHANGED,this._transformDirty,this),t.off(fx.ANCHOR_CHANGED,this._doLayoutDirty,this),t.off(fx.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()}_resized(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()}_doLayoutHorizontally(t,e,i,n){const s=this.node._uiProps.uiTransformComp.anchorPoint,r=this._getFixedBreakingNum();let o=1,a=this._paddingLeft;this._horizontalDirection===Cut.RIGHT_TO_LEFT&&(o=-1,a=this._paddingRight);const c=(this._horizontalDirection-s.x)*t+o*a;let l=c-o*this._spacingX,h=0,_=0,u=0,d=0,m=!1;const p=this._usefulLayoutObj.length;let f=this._cellSize.width;const g=this._getPaddingH();this._layoutType!==vut.GRID&&this._resizeMode===yut.CHILDREN&&(f=(t-g-(p-1)*this._spacingX)/p);const v=this._usefulLayoutObj;for(let a=0;a<v.length;++a){const p=v[a],y=p.node,x=y.scale,S=this._getUsedScaleValue(x.x),C=this._getUsedScaleValue(x.y);this._resizeMode===yut.CHILDREN&&(p.width=f/S,this._layoutType===vut.GRID&&(p.height=this._cellSize.height/C));const A=Math.abs(this._horizontalDirection-p.anchorX),b=p.width*S,T=p.height*C;T>u&&(d=Math.max(u,d),_=u||T,u=T),l+=o*(A*b+this._spacingX);const E=o*(1-A)*b;if(e){if(r>0)m=a/r>0&&a%r==0,m&&(_=u>T?u:_);else if(b>t-g)l>c+o*A*b&&(m=!0);else{const e=(1-this._horizontalDirection-s.x)*t,i=l+E+o*(o>0?this._paddingRight:this._paddingLeft);m=Math.abs(i)>Math.abs(e)}m&&(l=c+o*A*b,T!==u&&(_=u),h+=_+this._spacingY,_=u=T)}const P=i(y,p,h);n&&y.setPosition(l,P),l+=E}return _=Math.max(_,u),Math.max(d,h+_)+this._getPaddingV()}_doLayoutVertically(t,e,i,n){const s=this.node._uiProps.uiTransformComp.anchorPoint,r=this._getFixedBreakingNum();let o=1,a=this._paddingBottom;this._verticalDirection===Sut.TOP_TO_BOTTOM&&(o=-1,a=this._paddingTop);const c=(this._verticalDirection-s.y)*t+o*a;let l=c-o*this._spacingY,h=0,_=0,u=0,d=0,m=!1;const p=this._usefulLayoutObj.length;let f=this._cellSize.height;const g=this._getPaddingV();this._layoutType!==vut.GRID&&this._resizeMode===yut.CHILDREN&&(f=(t-g-(p-1)*this._spacingY)/p);const v=this._usefulLayoutObj;for(let a=0;a<v.length;++a){const p=v[a],y=p.node,x=y.scale,S=this._getUsedScaleValue(x.x),C=this._getUsedScaleValue(x.y);this._resizeMode===yut.CHILDREN&&(p.height=f/C,this._layoutType===vut.GRID&&(p.width=this._cellSize.width/S));const A=Math.abs(this._verticalDirection-p.anchorY),b=p.width*S,T=p.height*C;b>h&&(_=Math.max(h,_),u=h||b,h=b),l+=o*(A*T+this._spacingY);const E=o*(1-A)*T;if(e){if(r>0)m=a/r>0&&a%r==0,m&&(u=h>T?h:u);else if(T>t-g)l>c+o*A*T&&(m=!0);else{const e=(1-this._verticalDirection-s.y)*t,i=l+E+o*(o>0?this._paddingTop:this._paddingBottom);m=Math.abs(i)>Math.abs(e)}m&&(l=c+o*A*T,b!==h&&(u=h),d+=u+this._spacingX,u=h=b)}const P=i(y,p,d);n&&(y.getPosition(Tut),y.setPosition(P,l,Tut.z)),l+=E}return u=Math.max(u,h),Math.max(_,d+u)+this._getPaddingH()}_doLayoutGridAxisHorizontal(t,e){const i=e.width;let n=1,s=-t.y*e.height,r=this._paddingBottom;this._verticalDirection===Sut.TOP_TO_BOTTOM&&(n=-1,s=(1-t.y)*e.height,r=this._paddingTop);const o=(t,e,i)=>s+n*(i+(1-e.anchorY)*e.height*this._getUsedScaleValue(t.scale.y)+r);let a=0;this._resizeMode===yut.CONTAINER&&(a=this._doLayoutHorizontally(i,!0,o,!1),s=-t.y*a,this._verticalDirection===Sut.TOP_TO_BOTTOM&&(n=-1,s=(1-t.y)*a)),this._doLayoutHorizontally(i,!0,o,!0),this._resizeMode===yut.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,a)}_doLayoutGridAxisVertical(t,e){const i=e.height;let n=1,s=-t.x*e.width,r=this._paddingLeft;this._horizontalDirection===Cut.RIGHT_TO_LEFT&&(n=-1,s=(1-t.x)*e.width,r=this._paddingRight);const o=(t,e,i)=>s+n*(i+(1-e.anchorX)*e.width*this._getUsedScaleValue(t.scale.x)+r);let a=0;this._resizeMode===yut.CONTAINER&&(a=this._doLayoutVertically(i,!0,o,!1),s=-t.x*a,this._horizontalDirection===Cut.RIGHT_TO_LEFT&&(n=-1,s=(1-t.x)*a)),this._doLayoutVertically(i,!0,o,!0),this._resizeMode===yut.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(a,i)}_doLayoutGrid(){const t=this.node._uiProps.uiTransformComp,e=t.anchorPoint,i=t.contentSize;this.startAxis===xut.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,i):this.startAxis===xut.VERTICAL&&this._doLayoutGridAxisVertical(e,i)}_getHorizontalBaseWidth(t=!0){const e=this._usefulLayoutObj;let i=0;const n=e.length;if(this._resizeMode===yut.CONTAINER){for(let t=0;t<e.length;++t){const n=e[t],s=n.node.scale;i+=n.width*this._getUsedScaleValue(s.x)}i+=(n-1)*this._spacingX+this._getPaddingH()}else i=this.node._uiProps.uiTransformComp.width;return i}_getVerticalBaseHeight(){const t=this._usefulLayoutObj;let e=0;const i=t.length;if(this._resizeMode===yut.CONTAINER){for(let i=0;i<t.length;++i){const n=t[i],s=n.node.scale;e+=n.height*this._getUsedScaleValue(s.y)}e+=(i-1)*this._spacingY+this._getPaddingV()}else e=this.node._uiProps.uiTransformComp.height;return e}_doLayout(){if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===vut.HORIZONTAL){const t=this._getHorizontalBaseWidth(),e=t=>(this._isAlign?mi.ZERO:t.position).y;this._doLayoutHorizontally(t,!1,e,!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===vut.VERTICAL){const t=this._getVerticalBaseHeight(),e=t=>(this._isAlign?mi.ZERO:t.position).x;this._doLayoutVertically(t,!1,e,!0),this.node._uiProps.uiTransformComp.height=t}else this._layoutType===vut.GRID&&this._doLayoutGrid()}_getUsedScaleValue(t){return this._affectedByScale?Math.abs(t):1}_transformDirty(t){t&bv.SCALE&&t&bv.POSITION&&this._affectedByScale&&this._doLayoutDirty()}_doLayoutDirty(){this._layoutDirty=!0}_childrenChanged(){this._childrenDirty=!0,this._doLayoutDirty()}_getPaddingH(){return this._paddingLeft+this._paddingRight}_getPaddingV(){return this._paddingTop+this._paddingBottom}_getFixedBreakingNum(){if(this._layoutType!==vut.GRID||this._constraint===Aut.NONE||this._constraintNum<=0)return 0;let t=this._constraint===Aut.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===xut.VERTICAL&&(t=this._constraint===Aut.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),t}},fut.Type=vut,fut.VerticalDirection=Sut,fut.HorizontalDirection=Cut,fut.ResizeMode=yut,fut.AxisDirection=xut,fut.Constraint=Aut,sc((Q_t=gut).prototype,"alignHorizontal",[C_t,A_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"alignHorizontal"),Q_t.prototype),sc(Q_t.prototype,"alignVertical",[b_t,T_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"alignVertical"),Q_t.prototype),sc(Q_t.prototype,"type",[E_t,P_t,w_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"type"),Q_t.prototype),sc(Q_t.prototype,"resizeMode",[I_t,R_t,D_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"resizeMode"),Q_t.prototype),sc(Q_t.prototype,"cellSize",[M_t,O_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"cellSize"),Q_t.prototype),sc(Q_t.prototype,"startAxis",[B_t,N_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"startAxis"),Q_t.prototype),sc(Q_t.prototype,"paddingLeft",[L_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"paddingLeft"),Q_t.prototype),sc(Q_t.prototype,"paddingRight",[F_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"paddingRight"),Q_t.prototype),sc(Q_t.prototype,"paddingTop",[z_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"paddingTop"),Q_t.prototype),sc(Q_t.prototype,"paddingBottom",[V_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"paddingBottom"),Q_t.prototype),sc(Q_t.prototype,"spacingX",[G_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"spacingX"),Q_t.prototype),sc(Q_t.prototype,"spacingY",[U_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"spacingY"),Q_t.prototype),sc(Q_t.prototype,"verticalDirection",[k_t,H_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"verticalDirection"),Q_t.prototype),sc(Q_t.prototype,"horizontalDirection",[j_t,W_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"horizontalDirection"),Q_t.prototype),sc(Q_t.prototype,"constraint",[q_t,X_t,Y_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"constraint"),Q_t.prototype),sc(Q_t.prototype,"constraintNum",[K_t,J_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"constraintNum"),Q_t.prototype),sc(Q_t.prototype,"affectedByScale",[$_t],Object.getOwnPropertyDescriptor(Q_t.prototype,"affectedByScale"),Q_t.prototype),tut=sc(Q_t.prototype,"_resizeMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yut.NONE}}),eut=sc(Q_t.prototype,"_layoutType",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vut.NONE}}),iut=sc(Q_t.prototype,"_cellSize",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi(40,40)}}),nut=sc(Q_t.prototype,"_startAxis",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xut.HORIZONTAL}}),sut=sc(Q_t.prototype,"_paddingLeft",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rut=sc(Q_t.prototype,"_paddingRight",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),out=sc(Q_t.prototype,"_paddingTop",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aut=sc(Q_t.prototype,"_paddingBottom",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cut=sc(Q_t.prototype,"_spacingX",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lut=sc(Q_t.prototype,"_spacingY",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hut=sc(Q_t.prototype,"_verticalDirection",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sut.TOP_TO_BOTTOM}}),_ut=sc(Q_t.prototype,"_horizontalDirection",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cut.LEFT_TO_RIGHT}}),uut=sc(Q_t.prototype,"_constraint",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Aut.NONE}}),dut=sc(Q_t.prototype,"_constraintNum",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),mut=sc(Q_t.prototype,"_affectedByScale",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),put=sc(Q_t.prototype,"_isAlign",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Z_t=Q_t))||Z_t)||Z_t)||Z_t)||Z_t)||Z_t)||Z_t));var Put,wut,Iut,Rut,Dut,Mut,Out,But,Nut,Lut,Fut,zut,Vut,Gut,Uut,kut,Hut,jut,Wut,qut,Xut,Yut,Kut;l.Layout=Eut,function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.FILLED=2]="FILLED"}(Kut||(Kut={})),jt(Kut);let Jut=function(e){return t({ProgressBar:e,ProgressBarComponent:e}),e}((Put=dc("cc.ProgressBar"),wut=Dc(),Iut=pc(110),Rut=Pc(),Dut=mc(SO),Mut=Kc(FF),Out=Lc(),But=Kc(Kut),Nut=Lc(),Lut=Lc(),Fut=Fc(),zut=Lc(),Vut=Lc(),Put(Gut=wut(Gut=Iut(Gut=Rut(Gut=Dut((Yut=Xut=class extends Lh{constructor(...t){super(...t),nc(this,"_barSprite",kut,this),nc(this,"_mode",Hut,this),nc(this,"_totalLength",jut,this),nc(this,"_progress",Wut,this),nc(this,"_reverse",qut,this)}get barSprite(){return this._barSprite}set barSprite(t){this._barSprite!==t&&(this._barSprite=t,this._initBarSprite())}get mode(){return this._mode}set mode(t){if(this._mode!==t&&(this._mode=t,this._barSprite)){const t=this._barSprite.node;if(!t)return;const e=t._uiProps.uiTransformComp.contentSize;this._mode===Kut.HORIZONTAL?this.totalLength=e.width:this._mode===Kut.VERTICAL?this.totalLength=e.height:this._mode===Kut.FILLED&&(this.totalLength=this._barSprite.fillRange)}}get totalLength(){return this._totalLength}set totalLength(t){this._mode===Kut.FILLED&&(t=qe(t)),this._totalLength!==t&&(this._totalLength=t,this._updateBarStatus())}get progress(){return this._progress}set progress(t){this._progress!==t&&(this._progress=t,this._updateBarStatus())}get reverse(){return this._reverse}set reverse(t){this._reverse!==t&&(this._reverse=t,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}_initBarSprite(){if(this._barSprite){const t=this._barSprite.node;if(!t)return;const e=this.node._uiProps.uiTransformComp,i=e.contentSize,n=e.anchorPoint,s=t._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===FF.FillType.RADIAL&&(this._mode=Kut.FILLED),this._mode===Kut.HORIZONTAL?this.totalLength=s.width:this._mode===Kut.VERTICAL?this.totalLength=s.height:this.totalLength=this._barSprite.fillRange,t.parent===this.node){const e=-i.width*n.x;t.setPosition(e,0,0)}}}_updateBarStatus(){if(this._barSprite){const t=this._barSprite.node;if(!t)return;const e=t._uiProps.uiTransformComp,i=e.anchorPoint,n=e.contentSize,s=t.getPosition();let r=new Oi(0,.5);const o=qe(this._progress);let a=this._totalLength*o,c=n,l=0,h=0;switch(this._mode){case Kut.HORIZONTAL:this._reverse&&(r=new Oi(1,.5)),c=new Gi(a,n.height),l=this._totalLength,h=n.height;break;case Kut.VERTICAL:r=this._reverse?new Oi(.5,1):new Oi(.5,0),c=new Gi(n.width,a),l=n.width,h=this._totalLength}if(this._mode===Kut.FILLED)this._barSprite.type!==FF.Type.FILLED?y("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(a*=-1),this._barSprite.fillRange=a);else if(this._barSprite.type!==FF.Type.FILLED){const n=r.x-i.x,o=r.y-i.y,a=new mi(l*n,h*o,0);t.setPosition(s.x+a.x,s.y+a.y,s.z),e.setAnchorPoint(r),e.setContentSize(c)}else y("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},Xut.Mode=Kut,sc((Uut=Yut).prototype,"barSprite",[Mut,Out],Object.getOwnPropertyDescriptor(Uut.prototype,"barSprite"),Uut.prototype),sc(Uut.prototype,"mode",[But,Nut],Object.getOwnPropertyDescriptor(Uut.prototype,"mode"),Uut.prototype),sc(Uut.prototype,"totalLength",[Lut],Object.getOwnPropertyDescriptor(Uut.prototype,"totalLength"),Uut.prototype),sc(Uut.prototype,"progress",[Fut,Uc,zut],Object.getOwnPropertyDescriptor(Uut.prototype,"progress"),Uut.prototype),sc(Uut.prototype,"reverse",[Vut],Object.getOwnPropertyDescriptor(Uut.prototype,"reverse"),Uut.prototype),kut=sc(Uut.prototype,"_barSprite",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hut=sc(Uut.prototype,"_mode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kut.HORIZONTAL}}),jut=sc(Uut.prototype,"_totalLength",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Wut=sc(Uut.prototype,"_progress",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),qut=sc(Uut.prototype,"_reverse",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gut=Uut))||Gut)||Gut)||Gut)||Gut)||Gut));var $ut,Zut,Qut,tdt,edt,idt,ndt,sdt,rdt,odt,adt,cdt,ldt,hdt,_dt,udt,ddt,mdt,pdt,fdt,gdt,vdt,ydt,xdt;l.ProgressBar=Jut;const Sdt=new mi,Cdt=new mi,Adt=new mi,bdt=new Oi,Tdt=new hi,Edt=new Oi;var Pdt;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(Pdt||(Pdt={})),Xt(Pdt);let wdt=function(e){return t({ScrollBar:e,ScrollBarComponent:e}),e}(($ut=dc("cc.ScrollBar"),Zut=Dc(),Qut=pc(110),tdt=Pc(),edt=mc(SO),idt=Kc(FF),ndt=kc(),sdt=Lc(),rdt=Kc(Pdt),odt=kc(),adt=Lc(),cdt=kc(),ldt=Lc(),hdt=kc(),_dt=Lc(),$ut(udt=Zut(udt=Qut(udt=tdt(udt=edt((xdt=ydt=class extends Lh{constructor(...t){super(...t),nc(this,"_scrollView",mdt,this),nc(this,"_handle",pdt,this),nc(this,"_direction",fdt,this),nc(this,"_enableAutoHide",gdt,this),nc(this,"_autoHideTime",vdt,this),this._touching=!1,this._opacity=255,this._autoHideRemainingTime=0}get handle(){return this._handle}set handle(t){this._handle!==t&&(this._handle=t,this.onScroll(Oi.ZERO))}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this.onScroll(Oi.ZERO))}get enableAutoHide(){return this._enableAutoHide}set enableAutoHide(t){this._enableAutoHide!==t&&(this._enableAutoHide=t,this._enableAutoHide&&this._setOpacity(0))}get autoHideTime(){return this._autoHideTime}set autoHideTime(t){this._autoHideTime!==t&&(this._autoHideTime=t)}hide(){this._autoHideRemainingTime=0,this._setOpacity(0)}show(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}onScroll(t){if(!this._scrollView)return;const e=this._scrollView.content;if(!e)return;const i=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize,s=this.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(i,n))return;this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));let r=0,o=0,a=0,c=0,l=0;const h=Edt;h.set(0,0),this._direction===Pdt.HORIZONTAL?(r=i.width,o=n.width,l=s.width,a=t.x,this._convertToScrollViewSpace(h,e),c=-h.x):this._direction===Pdt.VERTICAL&&(r=i.height,o=n.height,l=s.height,a=t.y,this._convertToScrollViewSpace(h,e),c=-h.y);const _=this._calculateLength(r,o,l,a),u=Edt;this._calculatePosition(u,r,o,l,c,a,_),this._updateLength(_),this._updateHandlerPosition(u)}setScrollView(t){this._scrollView=t}onTouchBegan(){this._enableAutoHide&&(this._touching=!0)}onTouchEnded(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){const t=this._scrollView.content;if(t){const e=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(e,i))return}}this._autoHideRemainingTime=this._autoHideTime}}onEnable(){const t=this.node.getComponent(FF);t&&(this._opacity=t.color.a)}start(){this._enableAutoHide&&this._setOpacity(0)}update(t){this._processAutoHide(t)}_convertToScrollViewSpace(t,e){const i=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,n=e._uiProps.uiTransformComp;if(i&&n){Sdt.set(-n.anchorX*n.width,-n.anchorY*n.height,0),n.convertToWorldSpaceAR(Sdt,Cdt);const e=i.convertToNodeSpaceAR(Cdt);e.x+=i.anchorX*i.width,e.y+=i.anchorY*i.height,t.set(e.x,e.y)}else t.set(Oi.ZERO)}_setOpacity(t){if(this._handle){let e=this.node.getComponent(FF);e&&(Tdt.set(e.color),Tdt.a=t,e.color=Tdt),e=this._handle.getComponent(FF),e&&(Tdt.set(e.color),Tdt.a=t,e.color=Tdt)}}_updateHandlerPosition(t){if(this._handle){const e=Adt;this._fixupHandlerPosition(e),this._handle.node.setPosition(t.x+e.x,t.y+e.y,e.z)}}_fixupHandlerPosition(t){const e=this.node._uiProps.uiTransformComp,i=e.contentSize,n=e.anchorPoint,s=this.handle.node._uiProps.uiTransformComp.contentSize,r=this.handle.node.parent;mi.set(Sdt,-i.width*n.x,-i.height*n.y,0);const o=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(Sdt,Cdt),a=t;a.set(0,0,0),r._uiProps.uiTransformComp.convertToNodeSpaceAR(o,a),this.direction===Pdt.HORIZONTAL?a.set(a.x,a.y+(i.height-s.height)/2,a.z):this.direction===Pdt.VERTICAL&&a.set(a.x+(i.width-s.width)/2,a.y,a.z),this.handle.node.setPosition(a)}_conditionalDisableScrollBar(t,e){return t.width<=e.width&&this._direction===Pdt.HORIZONTAL||t.height<=e.height&&this._direction===Pdt.VERTICAL}_calculateLength(t,e,i,n){let s=t;return n&&(s+=20*(n>0?n:-n)),i*(e/s)}_calculatePosition(t,e,i,n,s,r,o){let a=e-i;r&&(a+=Math.abs(r));let c=0;a&&(c=s/a,c=qe(c));const l=(n-o)*c;this._direction===Pdt.VERTICAL?t.set(0,l):t.set(l,0)}_updateLength(t){if(this._handle){const e=this._handle.node._uiProps.uiTransformComp,i=e.contentSize,n=e.anchorPoint;n.x===bdt.x&&n.y===bdt.y||e.setAnchorPoint(bdt),this._direction===Pdt.HORIZONTAL?e.setContentSize(t,i.height):e.setContentSize(i.width,t)}}_processAutoHide(t){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=t,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);const t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},ydt.Direction=Pdt,sc((ddt=xdt).prototype,"handle",[idt,ndt,sdt],Object.getOwnPropertyDescriptor(ddt.prototype,"handle"),ddt.prototype),sc(ddt.prototype,"direction",[rdt,odt,adt],Object.getOwnPropertyDescriptor(ddt.prototype,"direction"),ddt.prototype),sc(ddt.prototype,"enableAutoHide",[cdt,ldt],Object.getOwnPropertyDescriptor(ddt.prototype,"enableAutoHide"),ddt.prototype),sc(ddt.prototype,"autoHideTime",[hdt,_dt],Object.getOwnPropertyDescriptor(ddt.prototype,"autoHideTime"),ddt.prototype),mdt=sc(ddt.prototype,"_scrollView",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pdt=sc(ddt.prototype,"_handle",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fdt=sc(ddt.prototype,"_direction",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pdt.HORIZONTAL}}),gdt=sc(ddt.prototype,"_enableAutoHide",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vdt=sc(ddt.prototype,"_autoHideTime",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),udt=ddt))||udt)||udt)||udt)||udt)||udt));var Idt;l.ScrollBar=wdt;let Rdt=t("ViewGroup",dc("cc.ViewGroup")(Idt=pc(110)(Idt=class extends Lh{})||Idt)||Idt);var Ddt,Mdt,Odt,Bdt,Ndt,Ldt,Fdt,zdt,Vdt,Gdt,Udt,kdt,Hdt,jdt,Wdt,qdt,Xdt,Ydt,Kdt,Jdt,$dt,Zdt,Qdt,tmt,emt,imt,nmt,smt,rmt,omt,amt,cmt,lmt,hmt,_mt,umt,dmt,mmt,pmt,fmt,gmt,vmt,ymt,xmt,Smt,Cmt,Amt,bmt;l.ViewGroup=Rdt;const Tmt=1e-4,Emt=new mi,Pmt=new mi,wmt=new Oi,Imt=new Oi,Rmt=()=>(new Date).getMilliseconds(),Dmt={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};let Mmt;!function(t){t.SCROLL_TO_TOP="scroll-to-top",t.SCROLL_TO_BOTTOM="scroll-to-bottom",t.SCROLL_TO_LEFT="scroll-to-left",t.SCROLL_TO_RIGHT="scroll-to-right",t.SCROLL_BEGAN="scroll-began",t.SCROLL_ENDED="scroll-ended",t.BOUNCE_TOP="bounce-top",t.BOUNCE_BOTTOM="bounce-bottom",t.BOUNCE_LEFT="bounce-left",t.BOUNCE_RIGHT="bounce-right",t.SCROLLING="scrolling",t.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",t.TOUCH_UP="touch-up"}(Mmt||(Mmt={}));let Omt=function(e){return t({ScrollView:e,ScrollViewComponent:e}),e}((Ddt=dc("cc.ScrollView"),Mdt=Dc(),Odt=pc(110),Bdt=Pc(),Ndt=mc(SO),Ldt=Fc(),Fdt=kc(),zdt=Lc(),Vdt=Fc(),Gdt=kc(),Udt=Lc(),kdt=kc(),Hdt=Lc(),jdt=kc(),Wdt=Lc(),qdt=Kc(iS),Xdt=kc(),Ydt=Lc(),Kdt=kc(),Jdt=Lc(),$dt=Kc(wdt),Zdt=kc(),Qdt=Lc(),tmt=kc(),emt=Lc(),imt=Kc(wdt),nmt=kc(),smt=Lc(),rmt=kc(),omt=Lc(),amt=Kc([KI]),cmt=kc(),lmt=Lc(),Ddt(hmt=Mdt(hmt=Odt(hmt=Bdt(hmt=Ndt((bmt=Amt=class extends Rdt{constructor(...t){super(...t),nc(this,"bounceDuration",umt,this),nc(this,"brake",dmt,this),nc(this,"elastic",mmt,this),nc(this,"inertia",pmt,this),nc(this,"horizontal",fmt,this),nc(this,"vertical",gmt,this),nc(this,"cancelInnerEvents",vmt,this),nc(this,"scrollEvents",ymt,this),this._autoScrolling=!1,this._scrolling=!1,nc(this,"_content",xmt,this),nc(this,"_horizontalScrollBar",Smt,this),nc(this,"_verticalScrollBar",Cmt,this),this._topBoundary=0,this._bottomBoundary=0,this._leftBoundary=0,this._rightBoundary=0,this._touchMoveDisplacements=[],this._touchMoveTimeDeltas=[],this._touchMovePreviousTimestamp=0,this._touchMoved=!1,this._autoScrollAttenuate=!1,this._autoScrollStartPosition=new mi,this._autoScrollTargetDelta=new mi,this._autoScrollTotalTime=0,this._autoScrollAccumulatedTime=0,this._autoScrollCurrentlyOutOfBoundary=!1,this._autoScrollBraking=!1,this._autoScrollBrakingStartPosition=new mi,this._outOfBoundaryAmount=new mi,this._outOfBoundaryAmountDirty=!0,this._stopMouseWheel=!1,this._mouseWheelEventElapsedTime=0,this._isScrollEndedWithThresholdEventFired=!1,this._scrollEventEmitMask=0,this._isBouncing=!1,this._contentPos=new mi,this._deltaPos=new mi}get content(){return this._content}set content(t){if(this._content===t)return;const e=t&&t.parent&&t.parent._uiProps.uiTransformComp;!t||t&&e?(this._content=t,this._calculateBoundary()):P(4302)}get horizontalScrollBar(){return this._horizontalScrollBar}set horizontalScrollBar(t){this._horizontalScrollBar!==t&&(this._horizontalScrollBar=t,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Oi.ZERO)))}get verticalScrollBar(){return this._verticalScrollBar}set verticalScrollBar(t){this._verticalScrollBar!==t&&(this._verticalScrollBar=t,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Oi.ZERO)))}get view(){const t=this._content&&this._content.parent;return t?t._uiProps.uiTransformComp:null}scrollToBottom(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Oi(0,0),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i,!0)}scrollToTop(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Oi(0,1),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToLeft(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Oi(0,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToRight(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Oi(1,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToTopLeft(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Oi(0,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToTopRight(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Oi(1,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToBottomLeft(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Oi(0,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToBottomRight(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Oi(1,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToOffset(t,e,i=!0){const n=this.getMaxScrollOffset(),s=new Oi(0,0);0===n.x?s.x=0:s.x=t.x/n.x,0===n.y?s.y=1:s.y=(n.y-t.y)/n.y,this.scrollTo(s,e,i)}getScrollOffset(){const t=this._getContentTopBoundary()-this._topBoundary,e=this._getContentLeftBoundary()-this._leftBoundary;return new Oi(e,t)}getMaxScrollOffset(){if(!this._content||!this.view)return Oi.ZERO;const t=this._content._uiProps.uiTransformComp.contentSize;let e=t.width-this.view.width,i=t.height-this.view.height;return e=e>=0?e:0,i=i>=0?i:0,new Oi(e,i)}scrollToPercentHorizontal(t,e,i){const n=this._calculateMovePercentDelta({anchor:new Oi(t,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==i):this._moveContent(n)}scrollTo(t,e,i){const n=this._calculateMovePercentDelta({anchor:new Oi(t),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,i):this._moveContent(n)}scrollToPercentVertical(t,e,i){const n=this._calculateMovePercentDelta({anchor:new Oi(0,t),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,i):this._moveContent(n)}stopAutoScroll(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}setContentPosition(t){this._setContentPosition(t)}_setContentPosition(t){if(!this._content)return;const e=this._getContentPosition();Math.abs(t.x-e.x)<Tmt&&Math.abs(t.y-e.y)<Tmt||(this._content.setPosition(t),this._outOfBoundaryAmountDirty=!0)}getContentPosition(){return this._getContentPosition()}_getContentPosition(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):mi.ZERO.clone()}isScrolling(){return this._scrolling}isAutoScrolling(){return this._autoScrolling}getScrollEndedEventTiming(){return Tmt}start(){this._calculateBoundary(),this._content&&mw.once(dw.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}onEnable(){this._registerEvent(),this._content&&(this._content.on(fx.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(fx.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(fx.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(fx.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()}update(t){this._autoScrolling&&this._processAutoScrolling(t)}onDisable(){this._unregisterEvent(),this._content&&(this._content.off(fx.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(fx.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(fx.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(fx.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()}_registerEvent(){this.node.on(fx.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(fx.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(fx.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(fx.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(fx.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_unregisterEvent(){this.node.off(fx.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(fx.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(fx.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(fx.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(fx.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_onMouseWheel(t,e){if(!this.enabledInHierarchy)return;if(this._hasNestedViewGroup(t,e))return;const i=new mi,n=t.getScrollY();this.vertical?i.set(0,-.1*n,0):this.horizontal&&i.set(-.1*n,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(t)}_onTouchBegan(t,e){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(t,e)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(t)))}_onTouchMoved(t,e){if(!this.enabledInHierarchy||!this._content)return;if(this._hasNestedViewGroup(t,e))return;const i=t.touch;if(this._handleMoveLogic(i),!this.cancelInnerEvents)return;const n=i.getUILocation(wmt);if(n.subtract(i.getUIStartLocation(Imt)),n.length()>7&&!this._touchMoved&&t.target!==this.node){const e=new yE(t.getTouches(),t.bubbles,dA.TOUCH_CANCEL);e.touch=t.touch,e.simulate=!0,t.target.dispatchEvent(e),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(t)}_onTouchEnded(t,e){if(!this.enabledInHierarchy||!this._content||!t)return;if(this._hasNestedViewGroup(t,e))return;this._dispatchEvent(Mmt.TOUCH_UP);const i=t.touch;this._handleReleaseLogic(i),this._touchMoved?t.propagationStopped=!0:this._stopPropagationIfTargetIsMe(t)}_onTouchCancelled(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){if(t&&!t.simulate){const e=t.touch;this._handleReleaseLogic(e)}this._stopPropagationIfTargetIsMe(t)}}_calculateBoundary(){if(this._content&&this.view){const t=this._content.getComponent(Eut);t&&t.enabledInHierarchy&&t.updateLayout();const e=this.view,i=e.width*e.anchorX,n=e.height*e.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+e.width,this._topBoundary=this._bottomBoundary+e.height,this._moveContentToTopLeft(e.contentSize)}}_hasNestedViewGroup(t,e){if(!t||t.eventPhase!==mE.CAPTURING_PHASE)return!1;if(e)for(const i of e){const e=i;if(this.node===e)return!(!t.target||!t.target.getComponent(Rdt));if(e.getComponent(Rdt))return!0}return!1}_startInertiaScroll(t){const e=new mi(t);e.multiplyScalar(.7),this._startAttenuatingAutoScroll(e,t)}_calculateAttenuatedFactor(t){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*t+t*t*8e-9))}_startAttenuatingAutoScroll(t,e){const i=t.clone();if(i.normalize(),this._content&&this.view){const t=this._content._uiProps.uiTransformComp.contentSize,e=this.view.contentSize,n=t.width-e.width,s=t.height-e.height,r=this._calculateAttenuatedFactor(n),o=this._calculateAttenuatedFactor(s);i.x=i.x*n*(1-this.brake)*r,i.y=i.y*s*o*(1-this.brake),i.z=0}const n=t.length();let s=i.length()/n;if(i.add(t),this.brake>0&&s>7){s=Math.sqrt(s);const e=t.clone();e.multiplyScalar(s),i.set(e),i.add(t)}let r=this._calculateAutoScrollTimeByInitialSpeed(e.length());this.brake>0&&s>3&&(s=3,r*=s),0===this.brake&&s>1&&(r*=s),this._startAutoScroll(i,r,!0)}_calculateAutoScrollTimeByInitialSpeed(t){return Math.sqrt(Math.sqrt(t/5))}_startAutoScroll(t,e,i=!1){const n=this._flattenVectorByDirection(t);this._autoScrolling=!0,this._autoScrollTargetDelta=n,this._autoScrollAttenuate=i,mi.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=e,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(mi.ZERO,Tmt)||(this._autoScrollCurrentlyOutOfBoundary=!0)}_calculateTouchMoveVelocity(){const t=new mi;let e=0;if(e=this._touchMoveTimeDeltas.reduce(((t,e)=>t+e),e),e<=0||e>=.5)t.set(mi.ZERO);else{let i=new mi;i=this._touchMoveDisplacements.reduce(((t,e)=>(t.add(e),t)),i),t.set(i.x*(1-this.brake)/e,i.y*(1-this.brake)/e,i.z)}return t}_flattenVectorByDirection(t){const e=t;return e.x=this.horizontal?e.x:0,e.y=this.vertical?e.y:0,e}_moveContent(t,e){const i=this._flattenVectorByDirection(t);Emt.set(this._getContentPosition()),Emt.add(i),Emt.set(Math.round(1e4*Emt.x)*Tmt,Math.round(1e4*Emt.y)*Tmt,Emt.z),this._setContentPosition(Emt);const n=this._getHowMuchOutOfBoundary();wmt.set(n.x,n.y),this._updateScrollBar(wmt),this.elastic&&e&&this._startBounceBackIfNeeded()}_getContentLeftBoundary(){if(!this._content)return-1;const t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.x-e.anchorX*e.width}_getContentRightBoundary(){if(!this._content)return-1;const t=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+t.width}_getContentTopBoundary(){if(!this._content)return-1;const t=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+t.height}_getContentBottomBoundary(){if(!this._content)return-1;const t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.y-e.anchorY*e.height}_getHowMuchOutOfBoundary(t){if((t=t||new mi).equals(mi.ZERO,Tmt)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;const e=new mi,i=this._getContentLeftBoundary(),n=this._getContentRightBoundary();i+t.x>this._leftBoundary?e.x=this._leftBoundary-(i+t.x):n+t.x<this._rightBoundary&&(e.x=this._rightBoundary-(n+t.x));const s=this._getContentTopBoundary(),r=this._getContentBottomBoundary();return s+t.y<this._topBoundary?e.y=this._topBoundary-(s+t.y):r+t.y>this._bottomBoundary&&(e.y=this._bottomBoundary-(r+t.y)),t.equals(mi.ZERO,Tmt)&&(this._outOfBoundaryAmount=e,this._outOfBoundaryAmountDirty=!1),this._clampDelta(e),e}_updateScrollBar(t){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(t),this.verticalScrollBar&&this.verticalScrollBar.onScroll(t)}_onScrollBarTouchBegan(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}_onScrollBarTouchEnded(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}_dispatchEvent(t){if(t===Mmt.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(t===Mmt.SCROLL_TO_TOP||t===Mmt.SCROLL_TO_BOTTOM||t===Mmt.SCROLL_TO_LEFT||t===Mmt.SCROLL_TO_RIGHT){const e=1<<Dmt[t];if(this._scrollEventEmitMask&e)return;this._scrollEventEmitMask|=e}KI.emitEvents(this.scrollEvents,this,Dmt[t]),this.node.emit(t,this)}_adjustContentOutOfBoundary(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){const t=this._getHowMuchOutOfBoundary();Emt.set(this._getContentPosition()),Emt.add(t),this._content.setPosition(Emt),this._updateScrollBar(Oi.ZERO)}}_hideScrollBar(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()}_updateScrollBarState(){if(!this._content||!this.view)return;const t=this.view,e=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(e.height<t.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(e.width<t.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}_stopPropagationIfTargetIsMe(t){t.eventPhase===mE.AT_TARGET&&t.target===this.node&&(t.propagationStopped=!0)}_processDeltaMove(t){this._scrollChildren(t),this._gatherTouchMove(t)}_handleMoveLogic(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._processDeltaMove(this._deltaPos)}_handleReleaseLogic(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(Mmt.SCROLL_ENDED))}_getLocalAxisAlignDelta(t,e){const i=this.node._uiProps.uiTransformComp,n=new mi;i&&(e.getUILocation(wmt),e.getUIPreviousLocation(Imt),Emt.set(wmt.x,wmt.y,0),Pmt.set(Imt.x,Imt.y,0),i.convertToNodeSpaceAR(Emt,Emt),i.convertToNodeSpaceAR(Pmt,Pmt),mi.subtract(n,Emt,Pmt)),t.set(n)}_scrollChildren(t){this._clampDelta(t);const e=t;let i;this.elastic&&(i=this._getHowMuchOutOfBoundary(),e.x*=0===i.x?1:.5,e.y*=0===i.y?1:.5),this.elastic||(i=this._getHowMuchOutOfBoundary(e),e.add(i));let n="",s="";if(this._content){const{anchorX:t,anchorY:i,width:r,height:o}=this._content._uiProps.uiTransformComp,a=this._content.position||mi.ZERO;this.vertical&&(e.y>0?a.y-i*o+e.y>=this._bottomBoundary&&(n=Mmt.SCROLL_TO_BOTTOM):e.y<0&&a.y-i*o+o+e.y<=this._topBoundary&&(n=Mmt.SCROLL_TO_TOP)),this.horizontal&&(e.x<0?a.x-t*r+r+e.x<=this._rightBoundary&&(s=Mmt.SCROLL_TO_RIGHT):e.x>0&&a.x-t*r+e.x>=this._leftBoundary&&(s=Mmt.SCROLL_TO_LEFT))}this._moveContent(e,!1),(this.horizontal&&0!==e.x||this.vertical&&0!==e.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(Mmt.SCROLL_BEGAN)),this._dispatchEvent(Mmt.SCROLLING)),""!==n&&this._dispatchEvent(n),""!==s&&this._dispatchEvent(s)}_handlePressLogic(){this._autoScrolling&&this._dispatchEvent(Mmt.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=Rmt(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}_clampDelta(t){if(this._content&&this.view){const e=this.view.contentSize,i=this._content._uiProps.uiTransformComp;i.width<e.width&&(t.x=0),i.height<e.height&&(t.y=0)}}_gatherTouchMove(t){const e=t.clone();for(this._clampDelta(e);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);const i=Rmt();this._touchMoveTimeDeltas.push((i-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=i}_startBounceBackIfNeeded(){if(!this.elastic)return!1;const t=this._getHowMuchOutOfBoundary();if(this._clampDelta(t),t.equals(mi.ZERO,Tmt))return!1;const e=Math.max(this.bounceDuration,0);return this._startAutoScroll(t,e,!0),this._isBouncing||(t.y>0&&this._dispatchEvent(Mmt.BOUNCE_TOP),t.y<0&&this._dispatchEvent(Mmt.BOUNCE_BOTTOM),t.x>0&&this._dispatchEvent(Mmt.BOUNCE_RIGHT),t.x<0&&this._dispatchEvent(Mmt.BOUNCE_LEFT),this._isBouncing=!0),!0}_processInertiaScroll(){if(!this._startBounceBackIfNeeded()&&this.inertia){const t=this._calculateTouchMoveVelocity();!t.equals(Emt,Tmt)&&this.brake<1&&this._startInertiaScroll(t)}this._onScrollBarTouchEnded()}_isOutOfBoundary(){return!this._getHowMuchOutOfBoundary().equals(mi.ZERO,Tmt)}_isNecessaryAutoScrollBrake(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,mi.copy(this._autoScrollBrakingStartPosition,this._getContentPosition()),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}_processAutoScrolling(t){const e=this._isNecessaryAutoScrollBrake(),i=e?.05:1;this._autoScrollAccumulatedTime+=t*(1/i);let n=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);var s;this._autoScrollAttenuate&&(s=n,n=(s-=1)*s*s*s*s+1);const r=this._autoScrollTargetDelta.clone();r.multiplyScalar(n);const o=this._autoScrollStartPosition.clone();o.add(r);let a=Math.abs(n-1)<=Tmt;if(Math.abs(n-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(Mmt.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){const t=o.clone();t.subtract(this._autoScrollBrakingStartPosition),e&&t.multiplyScalar(i),o.set(this._autoScrollBrakingStartPosition),o.add(t)}else{const t=o.clone();t.subtract(this.getContentPosition());const e=this._getHowMuchOutOfBoundary(t);e.equals(mi.ZERO,Tmt)||(o.add(e),a=!0)}a&&(this._autoScrolling=!1);const c=o.clone();c.subtract(this._getContentPosition()),this._clampDelta(c),this._moveContent(c,a),this._dispatchEvent(Mmt.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(Mmt.SCROLL_ENDED))}_checkMouseWheel(t){if(!this._getHowMuchOutOfBoundary().equals(mi.ZERO,Tmt))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Mmt.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=t,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Mmt.SCROLL_ENDED),this._stopMouseWheel=!1)}_calculateMovePercentDelta(t){const e=t.anchor,i=t.applyToHorizontal,n=t.applyToVertical;this._calculateBoundary(),e.clampf(Oi.ZERO,Oi.ONE);let s=this._getContentBottomBoundary()-this._bottomBoundary;s=-s;let r=this._getContentLeftBoundary()-this._leftBoundary;r=-r;const o=new mi;if(this._content&&this.view){let t=0;const a=this._content._uiProps.uiTransformComp.contentSize,c=this.view.contentSize;i&&(t=a.width-c.width,o.x=r-t*e.x),n&&(t=a.height-c.height,o.y=s-t*e.y)}return o}_moveContentToTopLeft(t){let e=this._getContentBottomBoundary()-this._bottomBoundary;e=-e;const i=new mi;let n=0,s=this._getContentLeftBoundary()-this._leftBoundary;if(s=-s,this._content){const r=this._content._uiProps.uiTransformComp.contentSize;r.height<t.height&&(n=r.height-t.height,i.y=e-n),r.width<t.width&&(n=r.width-t.width,i.x=s)}this._updateScrollBarState(),this._moveContent(i),this._adjustContentOutOfBoundary()}_scaleChanged(t){t===bv.SCALE&&this._calculateBoundary()}},Amt.EventType=Mmt,umt=sc((_mt=bmt).prototype,"bounceDuration",[Sc,Ldt,Fdt,zdt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),dmt=sc(_mt.prototype,"brake",[Sc,Vdt,Gdt,Udt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),mmt=sc(_mt.prototype,"elastic",[Sc,kdt,Hdt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),pmt=sc(_mt.prototype,"inertia",[Sc,jdt,Wdt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sc(_mt.prototype,"content",[qdt,Xdt,Ydt],Object.getOwnPropertyDescriptor(_mt.prototype,"content"),_mt.prototype),fmt=sc(_mt.prototype,"horizontal",[Sc,Kdt,Jdt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sc(_mt.prototype,"horizontalScrollBar",[$dt,Zdt,Qdt],Object.getOwnPropertyDescriptor(_mt.prototype,"horizontalScrollBar"),_mt.prototype),gmt=sc(_mt.prototype,"vertical",[Sc,tmt,emt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sc(_mt.prototype,"verticalScrollBar",[imt,nmt,smt],Object.getOwnPropertyDescriptor(_mt.prototype,"verticalScrollBar"),_mt.prototype),vmt=sc(_mt.prototype,"cancelInnerEvents",[Sc,rmt,omt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ymt=sc(_mt.prototype,"scrollEvents",[amt,Sc,cmt,lmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xmt=sc(_mt.prototype,"_content",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Smt=sc(_mt.prototype,"_horizontalScrollBar",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cmt=sc(_mt.prototype,"_verticalScrollBar",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hmt=_mt))||hmt)||hmt)||hmt)||hmt)||hmt));var Bmt,Nmt,Lmt,Fmt,zmt,Vmt,Gmt,Umt,kmt,Hmt,jmt,Wmt,qmt,Xmt,Ymt,Kmt,Jmt,$mt,Zmt,Qmt,tpt;l.ScrollView=Omt;const ept=new mi;var ipt;!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(ipt||(ipt={})),Xt(ipt);let npt=function(e){return t({Slider:e,SliderComponent:e}),e}((Bmt=dc("cc.Slider"),Nmt=Dc(),Lmt=pc(110),Fmt=Pc(),zmt=mc(SO),Vmt=Kc(FF),Gmt=Lc(),Umt=Kc(ipt),kmt=Lc(),Hmt=Fc(),jmt=Lc(),Wmt=Kc([KI]),qmt=Lc(),Bmt(Xmt=Nmt(Xmt=Lmt(Xmt=Fmt(Xmt=zmt((tpt=Qmt=class extends Lh{constructor(...t){super(...t),nc(this,"slideEvents",Kmt,this),nc(this,"_handle",Jmt,this),nc(this,"_direction",$mt,this),nc(this,"_progress",Zmt,this),this._offset=new mi,this._dragging=!1,this._touchHandle=!1,this._handleLocalPos=new mi,this._touchPos=new mi}get handle(){return this._handle}set handle(t){this._handle!==t&&(this._handle=t)}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this._changeLayout())}get progress(){return this._progress}set progress(t){this._progress!==t&&(this._progress=t,this._updateHandlePosition())}__preload(){this._updateHandlePosition()}onEnable(){this._updateHandlePosition(),this.node.on(fx.TOUCH_START,this._onTouchBegan,this),this.node.on(fx.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(fx.TOUCH_END,this._onTouchEnded,this),this.node.on(fx.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(fx.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(fx.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(fx.TOUCH_END,this._onTouchEnded,this))}onDisable(){this.node.off(fx.TOUCH_START,this._onTouchBegan,this),this.node.off(fx.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(fx.TOUCH_END,this._onTouchEnded,this),this.node.off(fx.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(fx.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(fx.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(fx.TOUCH_END,this._onTouchEnded,this))}_onHandleDragStart(t){if(!t||!this._handle||!this._handle.node._uiProps.uiTransformComp)return;this._dragging=!0,this._touchHandle=!0;const e=t.touch.getUILocation();mi.set(this._touchPos,e.x,e.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),t.propagationStopped=!0}_onTouchBegan(t){this._handle&&t&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(t.touch),t.propagationStopped=!0)}_onTouchMoved(t){this._dragging&&t&&(this._handleSliderLogic(t.touch),t.propagationStopped=!0)}_onTouchEnded(t){this._dragging=!1,this._touchHandle=!1,this._offset=new mi,t&&(t.propagationStopped=!0)}_onTouchCancelled(t){this._dragging=!1,t&&(t.propagationStopped=!0)}_handleSliderLogic(t){this._updateProgress(t),this._emitSlideEvent()}_emitSlideEvent(){KI.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}_updateProgress(t){if(!this._handle||!t)return;const e=t.getUILocation();mi.set(this._touchPos,e.x,e.y,0);const i=this.node._uiProps.uiTransformComp,n=i.convertToNodeSpaceAR(this._touchPos,ept);this.direction===ipt.Horizontal?this.progress=qe(.5+(n.x-this._offset.x)/i.width):this.progress=qe(.5+(n.y-this._offset.y)/i.height)}_updateHandlePosition(){if(!this._handle)return;this._handleLocalPos.set(this._handle.node.getPosition());const t=this.node._uiProps.uiTransformComp;this._direction===ipt.Horizontal?this._handleLocalPos.x=-t.width*t.anchorX+this.progress*t.width:this._handleLocalPos.y=-t.height*t.anchorY+this.progress*t.height,this._handle.node.setPosition(this._handleLocalPos)}_changeLayout(){const t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(t.setContentSize(e.height,e.width),this._handle){const t=this._handle.node.position;this._direction===ipt.Horizontal?this._handle.node.setPosition(t.x,0,t.z):this._handle.node.setPosition(0,t.y,t.z),this._updateHandlePosition()}}},Qmt.Direction=ipt,sc((Ymt=tpt).prototype,"handle",[Vmt,Gmt],Object.getOwnPropertyDescriptor(Ymt.prototype,"handle"),Ymt.prototype),sc(Ymt.prototype,"direction",[Umt,kmt],Object.getOwnPropertyDescriptor(Ymt.prototype,"direction"),Ymt.prototype),sc(Ymt.prototype,"progress",[Uc,Hmt,jmt],Object.getOwnPropertyDescriptor(Ymt.prototype,"progress"),Ymt.prototype),Kmt=sc(Ymt.prototype,"slideEvents",[Wmt,Sc,qmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jmt=sc(Ymt.prototype,"_handle",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$mt=sc(Ymt.prototype,"_direction",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ipt.Horizontal}}),Zmt=sc(Ymt.prototype,"_progress",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Xmt=Ymt))||Xmt)||Xmt)||Xmt)||Xmt)||Xmt));function spt(...t){return Object.assign({},...t)}var rpt,opt,apt,cpt,lpt,hpt,_pt,upt,dpt,mpt,ppt,fpt,gpt,vpt,ypt,xpt,Spt,Cpt,Apt,bpt;l.Slider=npt,function(t){t.TOGGLE="toggle"}(bpt||(bpt={}));let Tpt=function(e){return t({Toggle:e,ToggleComponent:e}),e}((rpt=dc("cc.Toggle"),opt=Dc(),apt=pc(110),cpt=Pc(),lpt=mc(SO),hpt=kc(),_pt=Lc(),upt=Kc(FF),dpt=kc(),mpt=Lc(),ppt=Kc([KI]),fpt=Lc(),rpt(gpt=opt(gpt=apt(gpt=cpt(gpt=lpt((Apt=Cpt=class t extends cht{constructor(...t){super(...t),nc(this,"checkEvents",ypt,this),nc(this,"_isChecked",xpt,this),nc(this,"_checkMark",Spt,this)}get isChecked(){return this._isChecked}set isChecked(t){this._set(t)}get checkMark(){return this._checkMark}set checkMark(t){this._checkMark!==t&&(this._checkMark=t)}set _resizeToTarget(t){t&&this._resizeNodeToTargetNode()}get _toggleContainer(){const t=this.node.parent;return l.Node.isNode(t)?t.getComponent("cc.ToggleContainer"):null}_internalToggle(){this.isChecked=!this.isChecked}_set(t,e=!0){if(this._isChecked==t)return;this._isChecked=t;const i=this._toggleContainer;i&&i.enabled&&this.enabled&&(t||!i.anyTogglesChecked()&&!i.allowSwitchOff)&&(this._isChecked=!0,i.notifyToggleCheck(this,e)),this.playEffect(),e&&this._emitToggleEvents()}playEffect(){this._checkMark&&(this._checkMark.node.active=this._isChecked)}setIsCheckedWithoutNotify(t){this._set(t,!1)}onEnable(){super.onEnable(),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)}onDisable(){super.onDisable(),this.node.off(t.EventType.CLICK,this._internalToggle,this)}OnDestroy(){const t=this._toggleContainer;t&&t.ensureValidState()}_emitToggleEvents(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&KI.emitEvents(this.checkEvents,this)}},Cpt.EventType=spt(bpt,sht),sc((vpt=Apt).prototype,"isChecked",[hpt,_pt],Object.getOwnPropertyDescriptor(vpt.prototype,"isChecked"),vpt.prototype),sc(vpt.prototype,"checkMark",[upt,dpt,mpt],Object.getOwnPropertyDescriptor(vpt.prototype,"checkMark"),vpt.prototype),ypt=sc(vpt.prototype,"checkEvents",[ppt,Sc,fpt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xpt=sc(vpt.prototype,"_isChecked",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Spt=sc(vpt.prototype,"_checkMark",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gpt=vpt))||gpt)||gpt)||gpt)||gpt)||gpt));var Ept,Ppt,wpt,Ipt,Rpt,Dpt,Mpt,Opt,Bpt,Npt,Lpt;l.Toggle=Tpt;let Fpt=function(e){return t({ToggleContainer:e,ToggleContainerComponent:e}),e}((Ept=dc("cc.ToggleContainer"),Ppt=Dc(),wpt=pc(110),Ipt=Pc(),Rpt=Lc(),Dpt=Kc([KI]),Mpt=Lc(),Ept(Opt=Ppt(Opt=wpt(Opt=Ipt(Opt=Ec((Npt=sc((Bpt=class extends Lh{constructor(...t){super(...t),nc(this,"_allowSwitchOff",Npt,this),nc(this,"checkEvents",Lpt,this)}get allowSwitchOff(){return this._allowSwitchOff}set allowSwitchOff(t){this._allowSwitchOff=t}get toggleItems(){return this.node.children.map((t=>{const e=t.getComponent("cc.Toggle");return e&&e.enabled?e:null})).filter(Boolean)}onEnable(){this.ensureValidState(),this.node.on(fx.CHILD_ADDED,this.ensureValidState,this),this.node.on(fx.CHILD_REMOVED,this.ensureValidState,this)}onDisable(){this.node.off(fx.CHILD_ADDED,this.ensureValidState,this),this.node.off(fx.CHILD_REMOVED,this.ensureValidState,this)}activeToggles(){return this.toggleItems.filter((t=>t.isChecked))}anyTogglesChecked(){return!!this.toggleItems.find((t=>t.isChecked))}notifyToggleCheck(t,e=!0){if(this.enabledInHierarchy){for(let i=0;i<this.toggleItems.length;i++){const n=this.toggleItems[i];n!==t&&(e?n.isChecked=!1:n.setIsCheckedWithoutNotify(!1))}this.checkEvents&&l.Component.EventHandler.emitEvents(this.checkEvents,t)}}ensureValidState(){const t=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==t.length){const e=t[0];e.isChecked=!0,this.notifyToggleCheck(e)}const e=this.activeToggles();if(e.length>1){const t=e[0];for(let i=0;i<e.length;++i){const n=e[i];n!==t&&(n.isChecked=!1)}}}}).prototype,"_allowSwitchOff",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sc(Bpt.prototype,"allowSwitchOff",[Rpt],Object.getOwnPropertyDescriptor(Bpt.prototype,"allowSwitchOff"),Bpt.prototype),Lpt=sc(Bpt.prototype,"checkEvents",[Dpt,Sc,Mpt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Opt=Bpt))||Opt)||Opt)||Opt)||Opt)||Opt));var zpt,Vpt,Gpt,Upt,kpt,Hpt,jpt,Wpt,qpt,Xpt,Ypt,Kpt,Jpt,$pt,Zpt,Qpt,tft,eft,ift,nft,sft,rft,oft,aft,cft,lft,hft,_ft,uft,dft,mft,pft,fft,gft,vft,yft,xft,Sft,Cft,Aft,bft,Tft,Eft,Pft,wft;l.ToggleContainer=Fpt;const Ift=new Oi;function Rft(t){return t instanceof XE?fw:t._uiProps.uiTransformComp?t._uiProps.uiTransformComp.contentSize:Gi.ZERO}function Dft(t,e,i,n){t.parent?Ift.set(t.parent.getScale().x,t.parent.getScale().y):Ift.set(0,0);let s=Ift.x,r=Ift.y,o=0,a=0;for(let c=t.parent;;){if(!c)return i.x=i.y=0,void(n.x=n.y=1);const t=c.getPosition();if(o+=t.x,a+=t.y,c=c.parent,c===e)break;{c?Ift.set(c.getScale().x,c.getScale().y):Ift.set(0,0);const t=Ift.x,e=Ift.y;o*=t,a*=e,s*=t,r*=e}}n.x=0!==s?1/s:1,n.y=0!==r?1/r:1,i.x=-o,i.y=-a}let Mft,Oft;!function(t){t[t.ONCE=0]="ONCE",t[t.ALWAYS=1]="ALWAYS",t[t.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(Mft||(Mft={})),Xt(Mft),function(t){t[t.TOP=1]="TOP",t[t.MID=2]="MID",t[t.BOT=4]="BOT",t[t.LEFT=8]="LEFT",t[t.CENTER=16]="CENTER",t[t.RIGHT=32]="RIGHT",t[t.HORIZONTAL=56]="HORIZONTAL",t[t.VERTICAL=7]="VERTICAL"}(Oft||(Oft={}));const Bft=Oft.TOP|Oft.BOT,Nft=Oft.LEFT|Oft.RIGHT;let Lft=function(e){return t({Widget:e,WidgetComponent:e}),e}((zpt=dc("cc.Widget"),Vpt=Dc(),Gpt=pc(110),Upt=Pc(),kpt=mc(SO),Hpt=Kc(iS),jpt=Lc(),Wpt=Lc(),qpt=Lc(),Xpt=Lc(),Ypt=Lc(),Kpt=Lc(),Jpt=Lc(),$pt=Oc(),Zpt=Oc(),Qpt=Lc(),tft=Lc(),eft=Lc(),ift=Lc(),nft=Lc(),sft=Lc(),rft=Kc(Mft),oft=Lc(),zpt(aft=Vpt(aft=Gpt(aft=Upt(aft=kpt(aft=Ec((wft=Pft=class extends Lh{constructor(...t){super(...t),this._lastPos=new mi,this._lastSize=new Gi,this._dirty=!0,this._hadAlignOnce=!1,nc(this,"_alignFlags",lft,this),nc(this,"_target",hft,this),nc(this,"_left",_ft,this),nc(this,"_right",uft,this),nc(this,"_top",dft,this),nc(this,"_bottom",mft,this),nc(this,"_horizontalCenter",pft,this),nc(this,"_verticalCenter",fft,this),nc(this,"_isAbsLeft",gft,this),nc(this,"_isAbsRight",vft,this),nc(this,"_isAbsTop",yft,this),nc(this,"_isAbsBottom",xft,this),nc(this,"_isAbsHorizontalCenter",Sft,this),nc(this,"_isAbsVerticalCenter",Cft,this),nc(this,"_originalWidth",Aft,this),nc(this,"_originalHeight",bft,this),nc(this,"_alignMode",Tft,this),nc(this,"_lockFlags",Eft,this)}get target(){return this._target}set target(t){this._target!==t&&(this._unregisterTargetEvents(),this._target=t,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}get isAlignTop(){return(this._alignFlags&Oft.TOP)>0}set isAlignTop(t){this._setAlign(Oft.TOP,t),this._recursiveDirty()}get isAlignBottom(){return(this._alignFlags&Oft.BOT)>0}set isAlignBottom(t){this._setAlign(Oft.BOT,t),this._recursiveDirty()}get isAlignLeft(){return(this._alignFlags&Oft.LEFT)>0}set isAlignLeft(t){this._setAlign(Oft.LEFT,t),this._recursiveDirty()}get isAlignRight(){return(this._alignFlags&Oft.RIGHT)>0}set isAlignRight(t){this._setAlign(Oft.RIGHT,t),this._recursiveDirty()}get isAlignVerticalCenter(){return(this._alignFlags&Oft.MID)>0}set isAlignVerticalCenter(t){t?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=Oft.MID):this._alignFlags&=~Oft.MID,this._recursiveDirty()}get isAlignHorizontalCenter(){return(this._alignFlags&Oft.CENTER)>0}set isAlignHorizontalCenter(t){t?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=Oft.CENTER):this._alignFlags&=~Oft.CENTER,this._recursiveDirty()}get isStretchWidth(){return(this._alignFlags&Nft)===Nft}get isStretchHeight(){return(this._alignFlags&Bft)===Bft}get top(){return this._top}set top(t){this._top=t,this._recursiveDirty()}get editorTop(){return this._isAbsTop?this._top:100*this._top}set editorTop(t){this._top=this._isAbsTop?t:t/100,this._recursiveDirty()}get bottom(){return this._bottom}set bottom(t){this._bottom=t,this._recursiveDirty()}get editorBottom(){return this._isAbsBottom?this._bottom:100*this._bottom}set editorBottom(t){this._bottom=this._isAbsBottom?t:t/100,this._recursiveDirty()}get left(){return this._left}set left(t){this._left=t,this._recursiveDirty()}get editorLeft(){return this._isAbsLeft?this._left:100*this._left}set editorLeft(t){this._left=this._isAbsLeft?t:t/100,this._recursiveDirty()}get right(){return this._right}set right(t){this._right=t,this._recursiveDirty()}get editorRight(){return this._isAbsRight?this._right:100*this._right}set editorRight(t){this._right=this._isAbsRight?t:t/100,this._recursiveDirty()}get horizontalCenter(){return this._horizontalCenter}set horizontalCenter(t){this._horizontalCenter=t,this._recursiveDirty()}get editorHorizontalCenter(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter}set editorHorizontalCenter(t){this._horizontalCenter=this._isAbsHorizontalCenter?t:t/100,this._recursiveDirty()}get verticalCenter(){return this._verticalCenter}set verticalCenter(t){this._verticalCenter=t,this._recursiveDirty()}get editorVerticalCenter(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter}set editorVerticalCenter(t){this._verticalCenter=this._isAbsVerticalCenter?t:t/100,this._recursiveDirty()}get isAbsoluteTop(){return this._isAbsTop}set isAbsoluteTop(t){this._isAbsTop!==t&&(this._isAbsTop=t,this._autoChangedValue(Oft.TOP,this._isAbsTop))}get isAbsoluteBottom(){return this._isAbsBottom}set isAbsoluteBottom(t){this._isAbsBottom!==t&&(this._isAbsBottom=t,this._autoChangedValue(Oft.BOT,this._isAbsBottom))}get isAbsoluteLeft(){return this._isAbsLeft}set isAbsoluteLeft(t){this._isAbsLeft!==t&&(this._isAbsLeft=t,this._autoChangedValue(Oft.LEFT,this._isAbsLeft))}get isAbsoluteRight(){return this._isAbsRight}set isAbsoluteRight(t){this._isAbsRight!==t&&(this._isAbsRight=t,this._autoChangedValue(Oft.RIGHT,this._isAbsRight))}get isAbsoluteHorizontalCenter(){return this._isAbsHorizontalCenter}set isAbsoluteHorizontalCenter(t){this._isAbsHorizontalCenter!==t&&(this._isAbsHorizontalCenter=t,this._autoChangedValue(Oft.CENTER,this._isAbsHorizontalCenter))}get isAbsoluteVerticalCenter(){return this._isAbsVerticalCenter}set isAbsoluteVerticalCenter(t){this._isAbsVerticalCenter!==t&&(this._isAbsVerticalCenter=t,this._autoChangedValue(Oft.MID,this._isAbsVerticalCenter))}get alignMode(){return this._alignMode}set alignMode(t){this._alignMode=t,this._recursiveDirty()}get alignFlags(){return this._alignFlags}set alignFlags(t){this._alignFlags!==t&&(this._alignFlags=t,this._recursiveDirty())}updateAlignment(){l._widgetManager.updateAlignment(this.node)}_validateTargetInDEV(){}setDirty(){this._recursiveDirty()}onEnable(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),l._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()}onDisable(){l._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}onDestroy(){this._removeParentEvent()}_adjustWidgetToAllowMovingInEditor(t){}_adjustWidgetToAllowResizingInEditor(){}_adjustWidgetToAnchorChanged(){this.setDirty()}_adjustTargetToParentChanged(t){t&&this._unregisterOldParentEvents(t),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()}_registerEvent(){this.node.on(fx.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(fx.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(fx.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(fx.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_unregisterEvent(){this.node.off(fx.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(fx.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(fx.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}_removeParentEvent(){this.node.off(fx.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_autoChangedValue(t,e){if(!((this._alignFlags&t)>0))return;const i=this.node.parent&&this.node.parent._uiProps,n=i&&i.uiTransformComp,s=n?n.contentSize:fw;this.isAlignLeft&&t===Oft.LEFT?this._left=e?this._left*s.width:this._left/s.width:this.isAlignRight&&t===Oft.RIGHT?this._right=e?this._right*s.width:this._right/s.width:this.isAlignHorizontalCenter&&t===Oft.CENTER?this._horizontalCenter=e?this._horizontalCenter*s.width:this._horizontalCenter/s.width:this.isAlignTop&&t===Oft.TOP?this._top=e?this._top*s.height:this._top/s.height:this.isAlignBottom&&t===Oft.BOT?this._bottom=e?this._bottom*s.height:this._bottom/s.height:this.isAbsoluteVerticalCenter&&t===Oft.MID&&(this._verticalCenter=this._verticalCenter/s.height),this._recursiveDirty()}_registerTargetEvents(){const t=this._target||this.node.parent;t&&t.getComponent(SO)&&(t.on(fx.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.on(fx.SIZE_CHANGED,this._setDirtyByMode,this),t.on(fx.ANCHOR_CHANGED,this._setDirtyByMode,this))}_unregisterTargetEvents(){const t=this._target||this.node.parent;t&&(t.off(fx.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(fx.SIZE_CHANGED,this._setDirtyByMode,this),t.off(fx.ANCHOR_CHANGED,this._setDirtyByMode,this))}_unregisterOldParentEvents(t){const e=this._target||t;e&&(e.off(fx.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(fx.SIZE_CHANGED,this._setDirtyByMode,this))}_setDirtyByMode(){this.alignMode===Mft.ALWAYS&&this._recursiveDirty()}_setAlign(t,e){if(e===(this._alignFlags&t)>0)return;const i=(t&Nft)>0,n=this.node._uiProps.uiTransformComp;e?(this._alignFlags|=t,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=n.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=n.height))):(i?this.isStretchWidth&&(n.width=this._originalWidth):this.isStretchHeight&&(n.height=this._originalHeight),this._alignFlags&=~t)}_recursiveDirty(){this._dirty||(this._dirty=!0)}},Pft.AlignMode=Mft,sc((cft=wft).prototype,"target",[Hpt,jpt],Object.getOwnPropertyDescriptor(cft.prototype,"target"),cft.prototype),sc(cft.prototype,"isAlignTop",[Wpt],Object.getOwnPropertyDescriptor(cft.prototype,"isAlignTop"),cft.prototype),sc(cft.prototype,"isAlignBottom",[qpt],Object.getOwnPropertyDescriptor(cft.prototype,"isAlignBottom"),cft.prototype),sc(cft.prototype,"isAlignLeft",[Xpt],Object.getOwnPropertyDescriptor(cft.prototype,"isAlignLeft"),cft.prototype),sc(cft.prototype,"isAlignRight",[Ypt],Object.getOwnPropertyDescriptor(cft.prototype,"isAlignRight"),cft.prototype),sc(cft.prototype,"isAlignVerticalCenter",[Kpt],Object.getOwnPropertyDescriptor(cft.prototype,"isAlignVerticalCenter"),cft.prototype),sc(cft.prototype,"isAlignHorizontalCenter",[Jpt],Object.getOwnPropertyDescriptor(cft.prototype,"isAlignHorizontalCenter"),cft.prototype),sc(cft.prototype,"isStretchWidth",[$pt],Object.getOwnPropertyDescriptor(cft.prototype,"isStretchWidth"),cft.prototype),sc(cft.prototype,"isStretchHeight",[Zpt],Object.getOwnPropertyDescriptor(cft.prototype,"isStretchHeight"),cft.prototype),sc(cft.prototype,"top",[Qpt],Object.getOwnPropertyDescriptor(cft.prototype,"top"),cft.prototype),sc(cft.prototype,"editorTop",[Mc],Object.getOwnPropertyDescriptor(cft.prototype,"editorTop"),cft.prototype),sc(cft.prototype,"bottom",[tft],Object.getOwnPropertyDescriptor(cft.prototype,"bottom"),cft.prototype),sc(cft.prototype,"editorBottom",[Mc],Object.getOwnPropertyDescriptor(cft.prototype,"editorBottom"),cft.prototype),sc(cft.prototype,"left",[eft],Object.getOwnPropertyDescriptor(cft.prototype,"left"),cft.prototype),sc(cft.prototype,"editorLeft",[Mc],Object.getOwnPropertyDescriptor(cft.prototype,"editorLeft"),cft.prototype),sc(cft.prototype,"right",[ift],Object.getOwnPropertyDescriptor(cft.prototype,"right"),cft.prototype),sc(cft.prototype,"editorRight",[Mc],Object.getOwnPropertyDescriptor(cft.prototype,"editorRight"),cft.prototype),sc(cft.prototype,"horizontalCenter",[nft],Object.getOwnPropertyDescriptor(cft.prototype,"horizontalCenter"),cft.prototype),sc(cft.prototype,"editorHorizontalCenter",[Mc],Object.getOwnPropertyDescriptor(cft.prototype,"editorHorizontalCenter"),cft.prototype),sc(cft.prototype,"verticalCenter",[sft],Object.getOwnPropertyDescriptor(cft.prototype,"verticalCenter"),cft.prototype),sc(cft.prototype,"editorVerticalCenter",[Mc],Object.getOwnPropertyDescriptor(cft.prototype,"editorVerticalCenter"),cft.prototype),sc(cft.prototype,"isAbsoluteTop",[Mc],Object.getOwnPropertyDescriptor(cft.prototype,"isAbsoluteTop"),cft.prototype),sc(cft.prototype,"isAbsoluteBottom",[Mc],Object.getOwnPropertyDescriptor(cft.prototype,"isAbsoluteBottom"),cft.prototype),sc(cft.prototype,"isAbsoluteLeft",[Mc],Object.getOwnPropertyDescriptor(cft.prototype,"isAbsoluteLeft"),cft.prototype),sc(cft.prototype,"isAbsoluteRight",[Mc],Object.getOwnPropertyDescriptor(cft.prototype,"isAbsoluteRight"),cft.prototype),sc(cft.prototype,"isAbsoluteHorizontalCenter",[Mc],Object.getOwnPropertyDescriptor(cft.prototype,"isAbsoluteHorizontalCenter"),cft.prototype),sc(cft.prototype,"isAbsoluteVerticalCenter",[Mc],Object.getOwnPropertyDescriptor(cft.prototype,"isAbsoluteVerticalCenter"),cft.prototype),sc(cft.prototype,"alignMode",[rft,oft],Object.getOwnPropertyDescriptor(cft.prototype,"alignMode"),cft.prototype),sc(cft.prototype,"alignFlags",[Mc],Object.getOwnPropertyDescriptor(cft.prototype,"alignFlags"),cft.prototype),lft=sc(cft.prototype,"_alignFlags",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hft=sc(cft.prototype,"_target",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_ft=sc(cft.prototype,"_left",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uft=sc(cft.prototype,"_right",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dft=sc(cft.prototype,"_top",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mft=sc(cft.prototype,"_bottom",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pft=sc(cft.prototype,"_horizontalCenter",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fft=sc(cft.prototype,"_verticalCenter",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gft=sc(cft.prototype,"_isAbsLeft",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),vft=sc(cft.prototype,"_isAbsRight",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),yft=sc(cft.prototype,"_isAbsTop",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xft=sc(cft.prototype,"_isAbsBottom",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Sft=sc(cft.prototype,"_isAbsHorizontalCenter",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Cft=sc(cft.prototype,"_isAbsVerticalCenter",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Aft=sc(cft.prototype,"_originalWidth",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bft=sc(cft.prototype,"_originalHeight",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tft=sc(cft.prototype,"_alignMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mft.ON_WINDOW_RESIZE}}),Eft=sc(cft.prototype,"_lockFlags",[Sc,Ac],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aft=cft))||aft)||aft)||aft)||aft)||aft)||aft));var Fft,zft,Vft,Gft,Uft,kft,Hft,jft,Wft,qft,Xft,Yft,Kft,Jft,$ft,Zft,Qft,tgt,egt;l.internal.computeInverseTransForTarget=Dft,l.internal.getReadonlyNodeSize=Rft,l.Widget=Lft;const igt=new hi;var ngt;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(ngt||(ngt={})),Xt(ngt);let sgt=function(e){return t({PageViewIndicator:e,PageViewIndicatorComponent:e}),e}((Fft=dc("cc.PageViewIndicator"),zft=Dc(),Vft=pc(110),Gft=Pc(),Uft=Kc(jD),kft=Lc(),Hft=Kc(ngt),jft=Lc(),Wft=Kc(Gi),qft=Lc(),Xft=Lc(),Fft(Yft=zft(Yft=Vft(Yft=Gft((egt=tgt=class extends Lh{constructor(...t){super(...t),nc(this,"spacing",Jft,this),nc(this,"_spriteFrame",$ft,this),nc(this,"_direction",Zft,this),nc(this,"_cellSize",Qft,this),this._layout=null,this._pageView=null,this._indicators=[]}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){this._spriteFrame!==t&&(this._spriteFrame=t)}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t)}get cellSize(){return this._cellSize}set cellSize(t){this._cellSize!==t&&(this._cellSize=t)}onLoad(){this._updateLayout()}setPageView(t){this._pageView=t,this._refresh()}_updateLayout(){this._layout=this.getComponent(Eut),this._layout||(this._layout=this.addComponent(Eut));const t=this._layout;this.direction===ngt.HORIZONTAL?(t.type=Eut.Type.HORIZONTAL,t.spacingX=this.spacing):this.direction===ngt.VERTICAL&&(t.type=Eut.Type.VERTICAL,t.spacingY=this.spacing),t.resizeMode=Eut.ResizeMode.CONTAINER}_createIndicator(){const t=new iS;t.layer=this.node.layer;const e=t.addComponent(FF);return e.spriteFrame=this.spriteFrame,e.sizeMode=FF.SizeMode.CUSTOM,t.parent=this.node,t._uiProps.uiTransformComp.setContentSize(this._cellSize),t}_changedState(){const t=this._indicators;if(0===t.length||!this._pageView)return;const e=this._pageView.curPageIdx;if(!(e>=t.length)){for(let e=0;e<t.length;++e){const i=t[e];if(!i._uiProps.uiComp)continue;const n=i._uiProps.uiComp;igt.set(n.color),igt.a=127.5,n.color=igt}if(t[e]._uiProps.uiComp){const i=t[e]._uiProps.uiComp;igt.set(i.color),igt.a=255,i.color=igt}}}_refresh(){if(!this._pageView)return;const t=this._indicators,e=this._pageView.getPages();if(e.length===t.length)return;let i=0;if(e.length>t.length)for(i=0;i<e.length;++i)t[i]||(t[i]=this._createIndicator());else for(i=t.length-e.length;i>0;--i){const e=t[i-1];this.node.removeChild(e),t.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}},tgt.Direction=ngt,sc((Kft=egt).prototype,"spriteFrame",[Uft,kft],Object.getOwnPropertyDescriptor(Kft.prototype,"spriteFrame"),Kft.prototype),sc(Kft.prototype,"direction",[Hft,jft],Object.getOwnPropertyDescriptor(Kft.prototype,"direction"),Kft.prototype),sc(Kft.prototype,"cellSize",[Wft,qft],Object.getOwnPropertyDescriptor(Kft.prototype,"cellSize"),Kft.prototype),Jft=sc(Kft.prototype,"spacing",[Sc,Xft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$ft=sc(Kft.prototype,"_spriteFrame",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zft=sc(Kft.prototype,"_direction",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ngt.HORIZONTAL}}),Qft=sc(Kft.prototype,"_cellSize",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi(20,20)}}),Yft=Kft))||Yft)||Yft)||Yft)||Yft));var rgt,ogt,agt,cgt,lgt,hgt,_gt,ugt,dgt,mgt,pgt,fgt,ggt,vgt,ygt,xgt,Sgt,Cgt,Agt,bgt,Tgt,Egt,Pgt,wgt,Igt,Rgt,Dgt,Mgt,Ogt,Bgt,Ngt,Lgt,Fgt,zgt,Vgt,Ggt,Ugt,kgt,Hgt,jgt,Wgt,qgt,Xgt;l.PageViewIndicator=sgt;const Ygt=new Oi;var Kgt,Jgt,$gt;!function(t){t[t.Unified=0]="Unified",t[t.Free=1]="Free"}(Kgt||(Kgt={})),Xt(Kgt),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(Jgt||(Jgt={})),Xt(Jgt),function(t){t.PAGE_TURNING="page-turning"}($gt||($gt={}));let Zgt=function(e){return t({PageView:e,PageViewComponent:e}),e}((rgt=dc("cc.PageView"),ogt=Dc(),agt=pc(110),cgt=Pc(),lgt=Kc(Kgt),hgt=Lc(),_gt=Kc(Jgt),ugt=Lc(),dgt=Fc(),mgt=Lc(),pgt=Fc(),fgt=Lc(),ggt=Kc(sgt),vgt=Lc(),ygt=Lc(),xgt=Kc(wdt),Sgt=Oc(),Cgt=Kc(wdt),Agt=Oc(),bgt=Oc(),Tgt=Oc(),Egt=Oc(),Pgt=Kc([KI]),wgt=Oc(),Igt=Lc(),Rgt=Kc([KI]),Dgt=Lc(),rgt(Mgt=ogt(Mgt=agt(Mgt=cgt((Xgt=qgt=class t extends Omt{constructor(...t){super(...t),nc(this,"autoPageTurningThreshold",Bgt,this),nc(this,"horizontal",Ngt,this),nc(this,"vertical",Lgt,this),nc(this,"cancelInnerEvents",Fgt,this),nc(this,"scrollEvents",zgt,this),nc(this,"pageTurningSpeed",Vgt,this),nc(this,"pageEvents",Ggt,this),nc(this,"_sizeMode",Ugt,this),nc(this,"_direction",kgt,this),nc(this,"_scrollThreshold",Hgt,this),nc(this,"_pageTurningEventTiming",jgt,this),nc(this,"_indicator",Wgt,this),this._curPageIdx=0,this._lastPageIdx=0,this._pages=[],this._initContentPos=new mi,this._scrollCenterOffsetX=[],this._scrollCenterOffsetY=[],this._touchBeganPosition=new Oi,this._touchEndPosition=new Oi}get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,this._syncSizeMode())}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this._syncScrollDirection())}get scrollThreshold(){return this._scrollThreshold}set scrollThreshold(t){this._scrollThreshold!==t&&(this._scrollThreshold=t)}get pageTurningEventTiming(){return this._pageTurningEventTiming}set pageTurningEventTiming(t){this._pageTurningEventTiming!==t&&(this._pageTurningEventTiming=t)}get indicator(){return this._indicator}set indicator(t){this._indicator!==t&&(this._indicator=t,this.indicator&&this.indicator.setPageView(this))}get curPageIdx(){return this._curPageIdx}get verticalScrollBar(){return super.verticalScrollBar}set verticalScrollBar(t){super.verticalScrollBar=t}get horizontalScrollBar(){return super.horizontalScrollBar}set horizontalScrollBar(t){super.horizontalScrollBar=t}onEnable(){super.onEnable(),this.node.on(fx.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onDisable(){super.onDisable(),this.node.off(fx.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onLoad(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}getCurrentPageIndex(){return this._curPageIdx}setCurrentPageIndex(t){this.scrollToPage(t,1)}getPages(){return this._pages}addPage(t){t&&-1===this._pages.indexOf(t)&&this.content&&(t._uiProps.uiTransformComp?(this.content.addChild(t),this._pages.push(t),this._updatePageView()):P(4301))}insertPage(t,e){if(!(e<0)&&t&&-1===this._pages.indexOf(t)&&this.content)if(e>=this._pages.length)this.addPage(t);else{if(!t._uiProps.uiTransformComp)return void P(4301);this._pages.splice(e,0,t),this.content.insertChild(t,e),this._updatePageView()}}removePage(t){if(!t||!this.content)return;const e=this._pages.indexOf(t);-1!==e?this.removePageAtIndex(e):I(4300,t.name)}removePageAtIndex(t){const e=this._pages;if(t<0||t>=e.length)return;const i=e[t];i&&this.content&&(this.content.removeChild(i),e.splice(t,1),this._updatePageView())}removeAllPages(){if(!this.content)return;const t=this._pages;for(let e=0,i=t.length;e<i;e++)this.content.removeChild(t[e]);this._pages.length=0,this._updatePageView()}scrollToPage(t,e=.3){t<0||t>=this._pages.length||(this._curPageIdx=t,this.scrollToOffset(this._moveOffsetValue(t),e,!0),this.indicator&&this.indicator._changedState())}getScrollEndedEventTiming(){return this.pageTurningEventTiming}_updatePageView(){if(!this.content)return;const t=this.content.getComponent(Eut);t&&t.enabled&&t.updateLayout();const e=this._pages.length;this._curPageIdx>=e&&(this._curPageIdx=0===e?0:e-1,this._lastPageIdx=this._curPageIdx);const i=this._initContentPos;for(let t=0;t<e;++t){const e=this._pages[t].position;this.direction===Jgt.Horizontal?this._scrollCenterOffsetX[t]=Math.abs(i.x+e.x):this._scrollCenterOffsetY[t]=Math.abs(i.y+e.y)}this.indicator&&this.indicator._refresh()}_updateAllPagesSize(){const t=this.view;if(!this.content||!t)return;if(this._sizeMode!==Kgt.Unified)return;const e=this._pages,i=t.contentSize;for(let t=0,n=e.length;t<n;t++)e[t]._uiProps.uiTransformComp.setContentSize(i)}_handleReleaseLogic(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))}_onTouchBegan(t,e){t.touch.getUILocation(Ygt),Oi.set(this._touchBeganPosition,Ygt.x,Ygt.y),super._onTouchBegan(t,e)}_onTouchMoved(t,e){super._onTouchMoved(t,e)}_onTouchEnded(t,e){t.touch.getUILocation(Ygt),Oi.set(this._touchEndPosition,Ygt.x,Ygt.y),super._onTouchEnded(t,e)}_onTouchCancelled(t,e){t.touch.getUILocation(Ygt),Oi.set(this._touchEndPosition,Ygt.x,Ygt.y),super._onTouchCancelled(t,e)}_onMouseWheel(){}_syncScrollDirection(){this.horizontal=this.direction===Jgt.Horizontal,this.vertical=this.direction===Jgt.Vertical}_syncSizeMode(){const t=this.view;if(!this.content||!t)return;const e=this.content.getComponent(Eut);if(e){if(this._sizeMode===Kgt.Free&&this._pages.length>0){const i=this._pages[0]._uiProps.uiTransformComp,n=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===Jgt.Horizontal?(e.paddingLeft=(t.width-i.width)/2,e.paddingRight=(t.width-n.width)/2):this.direction===Jgt.Vertical&&(e.paddingTop=(t.height-i.height)/2,e.paddingBottom=(t.height-n.height)/2)}e.updateLayout()}}_initPages(){if(!this.content)return;this._initContentPos=this.content.position;const t=this.content.children;for(let e=0;e<t.length;++e){const i=t[e];this._pages.indexOf(i)>=0||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}_dispatchPageTurningEvent(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,KI.emitEvents(this.pageEvents,this,$gt.PAGE_TURNING),this.node.emit($gt.PAGE_TURNING,this))}_isQuicklyScrollable(t){if(this.direction===Jgt.Horizontal){if(Math.abs(t.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===Jgt.Vertical&&Math.abs(t.y)>this.autoPageTurningThreshold)return!0;return!1}_moveOffsetValue(t){const e=new Oi;if(this._sizeMode===Kgt.Free)this.direction===Jgt.Horizontal?e.x=this._scrollCenterOffsetX[t]:this.direction===Jgt.Vertical&&(e.y=this._scrollCenterOffsetY[t]);else{const i=this.view;if(!i)return e;this.direction===Jgt.Horizontal?e.x=t*i.width:this.direction===Jgt.Vertical&&(e.y=t*i.height)}return e}_getDragDirection(t){return this._direction===Jgt.Horizontal?0===t.x?0:t.x>0?1:-1:0===t.y?0:t.y<0?1:-1}_isScrollable(t,e,i){if(this._sizeMode===Kgt.Free){let n=0,s=0;if(this.direction===Jgt.Horizontal)return n=this._scrollCenterOffsetX[e],s=this._scrollCenterOffsetX[i],Math.abs(t.x)>=Math.abs(n-s)*this.scrollThreshold;if(this.direction===Jgt.Vertical)return n=this._scrollCenterOffsetY[e],s=this._scrollCenterOffsetY[i],Math.abs(t.y)>=Math.abs(n-s)*this.scrollThreshold}else{const e=this.view;if(!e)return!1;if(this.direction===Jgt.Horizontal)return Math.abs(t.x)>=e.width*this.scrollThreshold;if(this.direction===Jgt.Vertical)return Math.abs(t.y)>=e.height*this.scrollThreshold}return!1}_autoScrollToPage(){if(this._startBounceBackIfNeeded()){const t=this._getHowMuchOutOfBoundary();this._clampDelta(t),(t.x>0||t.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(t.x<0||t.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{const t=new Oi;Oi.subtract(t,this._touchBeganPosition,this._touchEndPosition);const e=this._curPageIdx,i=e+this._getDragDirection(t),n=this.pageTurningSpeed*Math.abs(e-i);if(i<this._pages.length){if(this._isScrollable(t,e,i))return void this.scrollToPage(i,n);{const t=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(t))return void this.scrollToPage(i,n)}}this.scrollToPage(e,n)}}},qgt.SizeMode=Kgt,qgt.Direction=Jgt,qgt.EventType=spt($gt,Mmt),sc((Ogt=Xgt).prototype,"sizeMode",[lgt,hgt],Object.getOwnPropertyDescriptor(Ogt.prototype,"sizeMode"),Ogt.prototype),sc(Ogt.prototype,"direction",[_gt,ugt],Object.getOwnPropertyDescriptor(Ogt.prototype,"direction"),Ogt.prototype),sc(Ogt.prototype,"scrollThreshold",[Uc,dgt,mgt],Object.getOwnPropertyDescriptor(Ogt.prototype,"scrollThreshold"),Ogt.prototype),sc(Ogt.prototype,"pageTurningEventTiming",[Uc,pgt,fgt],Object.getOwnPropertyDescriptor(Ogt.prototype,"pageTurningEventTiming"),Ogt.prototype),sc(Ogt.prototype,"indicator",[ggt,vgt],Object.getOwnPropertyDescriptor(Ogt.prototype,"indicator"),Ogt.prototype),Bgt=sc(Ogt.prototype,"autoPageTurningThreshold",[Sc,ygt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),sc(Ogt.prototype,"verticalScrollBar",[xgt,Jc,Sgt],Object.getOwnPropertyDescriptor(Ogt.prototype,"verticalScrollBar"),Ogt.prototype),sc(Ogt.prototype,"horizontalScrollBar",[Cgt,Jc,Agt],Object.getOwnPropertyDescriptor(Ogt.prototype,"horizontalScrollBar"),Ogt.prototype),Ngt=sc(Ogt.prototype,"horizontal",[Jc,Sc,bgt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Lgt=sc(Ogt.prototype,"vertical",[Jc,Sc,Tgt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Fgt=sc(Ogt.prototype,"cancelInnerEvents",[Jc,Sc,Egt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zgt=sc(Ogt.prototype,"scrollEvents",[Pgt,Sc,Jc,wgt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vgt=sc(Ogt.prototype,"pageTurningSpeed",[Sc,Mc,Igt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),Ggt=sc(Ogt.prototype,"pageEvents",[Rgt,Sc,Dgt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ugt=sc(Ogt.prototype,"_sizeMode",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kgt.Unified}}),kgt=sc(Ogt.prototype,"_direction",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jgt.Horizontal}}),Hgt=sc(Ogt.prototype,"_scrollThreshold",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),jgt=sc(Ogt.prototype,"_pageTurningEventTiming",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Wgt=sc(Ogt.prototype,"_indicator",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mgt=Ogt))||Mgt)||Mgt)||Mgt)||Mgt));l.PageView=Zgt;const Qgt=new mi,tvt=new Oi,evt=new Oi,ivt=new Oi(1,1),nvt=new Oi,svt=new Oi;function rvt(t,e){if(e._hadAlignOnce)return;e.alignMode===Mft.ONCE&&(e._hadAlignOnce=!0);const i=e.target;let n;const s=evt,r=ivt;i?(n=i,Dft(t,n,s,r)):n=t.parent;const o=Rft(n),a=n instanceof XE||!n.getComponent(SO),c=a?tvt:n.getComponent(SO).anchorPoint,l=a;t.getPosition(Qgt);const h=t._uiProps.uiTransformComp;let _=Qgt.x,u=Qgt.y;const d=h.anchorPoint,m=t.getScale();if(e.alignFlags&Oft.HORIZONTAL){let t=0,n=0;const a=o.width;l?(t=fw.left.x,n=fw.right.x):(t=-c.x*a,n=t+a),t+=e.isAbsoluteLeft?e.left:e.left*a,n-=e.isAbsoluteRight?e.right:e.right*a,i&&(t+=s.x,t*=r.x,n+=s.x,n*=r.x);let u=0,p=d.x,f=m.x;if(f<0&&(p=1-p,f=-f),e.isStretchWidth)u=n-t,0!==f&&(h.width=u/f),_=t+p*u;else if(u=h.width*f,e.isAlignHorizontalCenter){let t=e.isAbsoluteHorizontalCenter?e.horizontalCenter:e.horizontalCenter*a,n=(.5-c.x)*o.width;i&&(t*=r.x,n+=s.x,n*=r.x),_=n+(p-.5)*u+t}else _=e.isAlignLeft?t+p*u:n+(p-1)*u;e._lastSize.width=u}if(e.alignFlags&Oft.VERTICAL){let t=0,n=0;const a=o.height;l?(n=fw.bottom.y,t=fw.top.y):(n=-c.y*a,t=n+a),n+=e.isAbsoluteBottom?e.bottom:e.bottom*a,t-=e.isAbsoluteTop?e.top:e.top*a,i&&(n+=s.y,n*=r.y,t+=s.y,t*=r.y);let _=0,p=d.y,f=m.y;if(f<0&&(p=1-p,f=-f),e.isStretchHeight)_=t-n,0!==f&&(h.height=_/f),u=n+p*_;else if(_=h.height*f,e.isAlignVerticalCenter){let t=e.isAbsoluteVerticalCenter?e.verticalCenter:e.verticalCenter*a,n=(.5-c.y)*o.height;i&&(t*=r.y,n+=s.y,n*=r.y),u=n+(p-.5)*_+t}else u=e.isAlignBottom?n+p*_:t+(p-1)*_;e._lastSize.height=_}t.setPosition(_,u,Qgt.z),mi.set(e._lastPos,_,u,Qgt.z)}function ovt(t){const e=t.getComponent(Lft);if(e&&e.enabled){if(!l.isValid(t,!0))return;cvt.push(e)}const i=t.children;for(const t of i)t.active&&ovt(t)}function avt(){const t=mw.getScene();if(t){lvt.isAligning=!0,lvt._nodesOrderDirty&&(cvt.length=0,ovt(t),lvt._nodesOrderDirty=!1);let e=null;const i=lvt._activeWidgetsIterator;for(i.i=0;i.i<cvt.length;++i.i)e=cvt[i.i],e._dirty&&(rvt(e.node,e),e._dirty=!1);lvt.isAligning=!1}}const cvt=[],lvt=t("widgetManager",l._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Gt.MutableForwardIterator(cvt),animationState:null,init(){mw.on(dw.EVENT_AFTER_SCENE_LAUNCH,avt),mw.on(dw.EVENT_AFTER_UPDATE,avt),yw.instance.on("design-resolution-changed",this.onResized,this);{const t=this.onResized.bind(this);yw.instance.on("canvas-resize",t),jh.on("orientation-change",t)}},add(t){this._nodesOrderDirty=!0},remove(t){this._activeWidgetsIterator.remove(t)},onResized(){const t=mw.getScene();t&&this.refreshWidgetOnResized(t)},refreshWidgetOnResized(t){const e=iS.isNode(t)&&t.getComponent(Lft);e&&e.enabled&&(e.alignMode===Mft.ON_WINDOW_RESIZE||e.alignMode===Mft.ALWAYS)&&e.setDirty();const i=t.children;for(const t of i)this.refreshWidgetOnResized(t)},updateOffsetsToStayPut(t,e){function i(t,e){return Math.abs(t-e)>1e-10?e:t}const n=t.node;let s=n.parent;if(s){const r=nvt;r.set(0,0);const o=svt;if(o.set(1,1),t.target&&(s=t.target,Dft(n,s,r,o)),!e)return;const a=s._uiProps&&s._uiProps.uiTransformComp,c=a?a.anchorPoint:tvt,l=n._uiProps.uiTransformComp,h=Rft(s),_=l.anchorPoint,u=n.getPosition(),d=Oft,m=n.getScale();let p=0;if(e&d.LEFT){let e=-c.x*h.width;e+=r.x,e*=o.x,p=u.x-_.x*l.width*Math.abs(m.x)-e,t.isAbsoluteLeft||(p/=h.width),p/=o.x,t.left=i(t.left,p)}if(e&d.RIGHT){let e=(1-c.x)*h.width;e+=r.x,p=(e*=o.x)-(u.x+(1-_.x)*l.width*Math.abs(m.x)),t.isAbsoluteRight||(p/=h.width),p/=o.x,t.right=i(t.right,p)}if(e&d.TOP){let e=(1-c.y)*h.height;e+=r.y,p=(e*=o.y)-(u.y+(1-_.y)*l.height*Math.abs(m.y)),t.isAbsoluteTop||(p/=h.height),p/=o.y,t.top=i(t.top,p)}if(e&d.BOT){let e=-c.y*h.height;e+=r.y,e*=o.y,p=u.y-_.y*l.height*Math.abs(m.y)-e,t.isAbsoluteBottom||(p/=h.height),p/=o.y,t.bottom=i(t.bottom,p)}}},updateAlignment:function t(e){const i=e.parent;i&&iS.isNode(i)&&t(i);const n=e.getComponent(Lft);n&&i&&rvt(e,n)},AlignMode:Mft,AlignFlags:Oft});var hvt;mw.on(dw.EVENT_INIT,(()=>{lvt.init()}));let _vt=function(e){return t({SafeArea:e,SafeAreaComponent:e}),e}(dc("cc.SafeArea")(hvt=Dc()(hvt=pc(110)(hvt=Ec(hvt=Pc()(hvt=mc(Lft)(hvt=class extends Lh{onEnable(){this.updateArea(),jh.on("window-resize",this.updateArea,this),jh.on("orientation-change",this.updateArea,this)}onDisable(){jh.off("window-resize",this.updateArea,this),jh.off("orientation-change",this.updateArea,this)}updateArea(){const t=this.node.getComponent(Lft),e=this.node.getComponent(SO);if(!t||!e)return;t.updateAlignment();const i=this.node.position.clone(),n=e.anchorPoint.clone();t.isAlignTop=t.isAlignBottom=t.isAlignLeft=t.isAlignRight=!0;const s=Aw.getVisibleSize(),r=s.width,o=s.height,a=qh.getSafeAreaRect();t.top=o-a.y-a.height,t.bottom=a.y,t.left=a.x,t.right=r-a.x-a.width,t.updateAlignment();const c=this.node.position.clone(),l=n.x-(c.x-i.x)/e.width,h=n.y-(c.y-i.y)/e.height;e.setAnchorPoint(l,h),lvt.add(t)}})||hvt)||hvt)||hvt)||hvt)||hvt)||hvt);var uvt,dvt,mvt,pvt,fvt,gvt,vvt,yvt,xvt,Svt,Cvt,Avt,bvt,Tvt,Evt,Pvt,wvt,Ivt,Rvt;l.SafeArea=_vt;let Dvt=function(e){return t({UICoordinateTracker:e,UICoordinateTrackerComponent:e}),e}((uvt=dc("cc.UICoordinateTracker"),dvt=Dc(),mvt=Pc(),pvt=pc(110),fvt=Kc(iS),gvt=Lc(),vvt=Kc(yD),yvt=Lc(),xvt=Lc(),Svt=Lc(),Cvt=Kc([KI]),Avt=Lc(),uvt(bvt=dvt(bvt=mvt(bvt=pvt((sc((Tvt=class extends Lh{constructor(...t){super(...t),nc(this,"syncEvents",Evt,this),nc(this,"_target",Pvt,this),nc(this,"_camera",wvt,this),nc(this,"_useScale",Ivt,this),nc(this,"_distance",Rvt,this),this._transformPos=new mi,this._viewPos=new mi,this._canMove=!0,this._lastWPos=new mi,this._lastCameraPos=new mi}get target(){return this._target}set target(t){this._target!==t&&(this._target=t,this._checkCanMove())}get camera(){return this._camera}set camera(t){this._camera!==t&&(this._camera=t,this._checkCanMove())}get useScale(){return this._useScale}set useScale(t){this._useScale!==t&&(this._useScale=t)}get distance(){return this._distance}set distance(t){this._distance!==t&&(this._distance=t)}onEnable(){this._checkCanMove()}update(){const t=this.node.worldPosition,e=this._camera;if(this._canMove&&e&&e.camera&&(!this._lastWPos.equals(t)||!this._lastCameraPos.equals(e.node.worldPosition))&&(this._lastWPos.set(t),this._lastCameraPos.set(e.node.worldPosition),e.camera.update(),e.convertToUINode(t,this._target,this._transformPos),this._useScale&&mi.transformMat4(this._viewPos,this.node.worldPosition,e.camera.matView),this.syncEvents.length>0)){const t=this._distance/Math.abs(this._viewPos.z);KI.emitEvents(this.syncEvents,this._transformPos,t)}}_checkCanMove(){this._canMove=!(!this._camera||!this._target)}}).prototype,"target",[fvt,gvt],Object.getOwnPropertyDescriptor(Tvt.prototype,"target"),Tvt.prototype),sc(Tvt.prototype,"camera",[vvt,yvt],Object.getOwnPropertyDescriptor(Tvt.prototype,"camera"),Tvt.prototype),sc(Tvt.prototype,"useScale",[xvt],Object.getOwnPropertyDescriptor(Tvt.prototype,"useScale"),Tvt.prototype),sc(Tvt.prototype,"distance",[Svt],Object.getOwnPropertyDescriptor(Tvt.prototype,"distance"),Tvt.prototype),Evt=sc(Tvt.prototype,"syncEvents",[Cvt,Sc,Avt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pvt=sc(Tvt.prototype,"_target",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wvt=sc(Tvt.prototype,"_camera",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ivt=sc(Tvt.prototype,"_useScale",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Rvt=sc(Tvt.prototype,"_distance",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),bvt=Tvt))||bvt)||bvt)||bvt)||bvt));var Mvt;const Ovt=[fx.TOUCH_START,fx.TOUCH_END,fx.TOUCH_MOVE,fx.MOUSE_DOWN,fx.MOUSE_MOVE,fx.MOUSE_UP,fx.MOUSE_ENTER,fx.MOUSE_LEAVE,fx.MOUSE_WHEEL];function Bvt(t){t.propagationStopped=!0}let Nvt=function(e){return t({BlockInputEvents:e,BlockInputEventsComponent:e}),e}(dc("cc.BlockInputEvents")(Mvt=Dc()(Mvt=Pc()(Mvt=class extends Lh{onEnable(){for(let t=0;t<Ovt.length;t++)this.node.on(Ovt[t],Bvt,this)}onDisable(){for(let t=0;t<Ovt.length;t++)this.node.off(Ovt[t],Bvt,this)}})||Mvt)||Mvt)||Mvt);var Lvt,Fvt,zvt,Vvt,Gvt,Uvt,kvt,Hvt,jvt,Wvt,qvt;let Xvt=t("SubContextView",(Lvt=dc("cc.SubContextView"),Fvt=Dc(),zvt=pc(110),Vvt=mc(SO),Gvt=Pc(),Uvt=Lc(),kvt=Lc(),Lvt(Hvt=Fvt(Hvt=zvt(Hvt=Vvt(Hvt=Gvt((sc((jvt=class extends Lh{get designResolutionSize(){return this._designResolutionSize}set designResolutionSize(t){}get fps(){return this._fps}set fps(t){this._fps!==t&&(this._fps=t,this._updateInterval=1e3/t)}constructor(){super(),nc(this,"_fps",Wvt,this),this._sprite=void 0,this._imageAsset=void 0,this._texture=void 0,this._updatedTime=0,this._updateInterval=0,this._openDataContext=void 0,this._content=void 0,nc(this,"_designResolutionSize",qvt,this),this._content=new iS("content"),this._content.hideFlags|=il.Flags.DontSave|il.Flags.HideInHierarchy,this._sprite=null,this._imageAsset=new rf,this._openDataContext=null,this._updatedTime=performance.now(),this._texture=new xf}onLoad(){ND.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=ND.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1}onEnable(){this._registerNodeEvent()}onDisable(){this._unregisterNodeEvent()}_initSharedCanvas(){if(this._openDataContext){const t=this._openDataContext.canvas;let e=this._designResolutionSize.width,i=this._designResolutionSize.height;t.width=e,t.height=i}}_initContentNode(){if(this._openDataContext){const t=this._openDataContext.canvas,e=this._imageAsset;if(e.reset(t),this._texture.image=e,this._texture.create(t.width,t.height),this._sprite=this._content.getComponent(FF),this._sprite||(this._sprite=this._content.addComponent(FF)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{const t=new jD;t.texture=this._texture,this._sprite.spriteFrame=t}this._content.parent=this.node}}_updateSubContextView(){if(!this._openDataContext)return;const t=this.node.getComponent(SO),e=this._content.getComponent(SO),i=t.width/e.width,n=t.height/e.height,s=i>n?n:i;e.width*=s,e.height*=s;const r=Aw.getViewportRect(),o=e.getBoundingBoxToWorld(),a=Aw.getVisibleSize(),c=jh.devicePixelRatio,l=(r.width*(o.x/a.width)+r.x)/c,h=(r.height*(o.y/a.height)+r.y)/c,_=r.width*(o.width/a.width)/c,u=r.height*(o.height/a.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:h,width:_,height:u})}_updateSubContextTexture(){const t=this._imageAsset;if(!t||!this._openDataContext)return;if(t.width<=0||t.height<=0)return;const e=this._openDataContext.canvas;t.reset(e),(e.width>t.width||e.height>t.height)&&this._texture.create(e.width,e.height),this._texture.uploadData(e)}_registerNodeEvent(){this.node.on(fx.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(fx.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(fx.LAYER_CHANGED,this._updateContentLayer,this)}_unregisterNodeEvent(){this.node.off(fx.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(fx.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(fx.LAYER_CHANGED,this._updateContentLayer,this)}_updateContentLayer(){this._content.layer=this.node.layer}update(t){void 0!==t?performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture()):this._updateSubContextTexture()}onDestroy(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null}}).prototype,"designResolutionSize",[Uvt],Object.getOwnPropertyDescriptor(jvt.prototype,"designResolutionSize"),jvt.prototype),sc(jvt.prototype,"fps",[kvt],Object.getOwnPropertyDescriptor(jvt.prototype,"fps"),jvt.prototype),Wvt=sc(jvt.prototype,"_fps",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),qvt=sc(jvt.prototype,"_designResolutionSize",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi(640,960)}}),Hvt=jvt))||Hvt)||Hvt)||Hvt)||Hvt)||Hvt));var Yvt;l.SubContextView=Xvt;let Kvt=t("UIReorderComponent",dc("cc.UIReorderComponent")(Yvt=class{constructor(){I(1408,"UIReorderComponent")}})||Yvt);var Jvt,$vt,Zvt;l.UIReorderComponent=Kvt,l.ButtonComponent=cht,Ut.setClassAlias(cht,"cc.ButtonComponent"),l.EditBoxComponent=f_t,Ut.setClassAlias(f_t,"cc.EditBoxComponent"),l.LayoutComponent=Eut,Ut.setClassAlias(Eut,"cc.LayoutComponent"),l.ProgressBarComponent=Jut,Ut.setClassAlias(Jut,"cc.ProgressBarComponent"),l.ScrollViewComponent=Omt,Ut.setClassAlias(Omt,"cc.ScrollViewComponent"),l.ScrollBarComponent=wdt,Ut.setClassAlias(wdt,"cc.ScrollBarComponent"),l.SliderComponent=npt,Ut.setClassAlias(npt,"cc.SliderComponent"),l.ToggleComponent=Tpt,Ut.setClassAlias(Tpt,"cc.ToggleComponent"),l.ToggleContainerComponent=Fpt,Ut.setClassAlias(Fpt,"cc.ToggleContainerComponent"),l.WidgetComponent=Lft,Ut.setClassAlias(Lft,"cc.WidgetComponent"),l.PageViewComponent=Zgt,Ut.setClassAlias(Zgt,"cc.PageViewComponent"),l.PageViewIndicatorComponent=sgt,Ut.setClassAlias(sgt,"cc.PageViewIndicatorComponent"),l.SafeAreaComponent=_vt,Ut.setClassAlias(_vt,"cc.SafeAreaComponent"),Ut.setClassAlias(Dvt,"cc.UICoordinateTrackerComponent"),l.BlockInputEventsComponent=Nvt,Ut.setClassAlias(Nvt,"cc.BlockInputEventsComponent");let Qvt=t("VideoClip",dc("cc.VideoClip")((Zvt=sc(($vt=class extends fh{constructor(){super(),nc(this,"_duration",Zvt,this),this._video=null}set _nativeAsset(t){this._video=t,this._duration=t?t.duration:0}get _nativeAsset(){return this._video}}).prototype,"_duration",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jvt=$vt))||Jvt);function tyt(t,e,i){const n=document.createElement("video"),s=document.createElement("source");n.appendChild(s);const r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="blob",r.onload=function(){200===this.status||0===this.status?(s.src=URL.createObjectURL(this.response),i(null,n)):i(new Error(`${r.status}(no response)`))},r.onerror=function(){const e=`load video failure - ${t}`;v(e),i(new Error(e))},r.send()}function eyt(t,e,i,n){const s=new Qvt;s._nativeUrl=t,s._nativeAsset=e,n(null,s)}nI.register({".mp4":tyt,".avi":tyt,".mov":tyt,".mpg":tyt,".mpeg":tyt,".rm":tyt,".rmvb":tyt}),hI.register({".mp4":eyt,".avi":eyt,".mov":eyt,".mpg":eyt,".mpeg":eyt,".rm":eyt,".rmvb":eyt});const iyt=jt({REMOTE:0,LOCAL:1});let nyt,syt;!function(t){t.NONE="none",t.PLAYING="playing",t.PAUSED="paused",t.STOPPED="stopped",t.COMPLETED="completed",t.META_LOADED="meta-loaded",t.READY_TO_PLAY="ready-to-play",t.ERROR="error",t.CLICKED="clicked"}(nyt||(nyt={})),function(t){t[t.HAVE_NOTHING=0]="HAVE_NOTHING",t[t.HAVE_METADATA=1]="HAVE_METADATA",t[t.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",t[t.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",t[t.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(syt||(syt={}));class ryt{constructor(t){this._componentEventList=new Map,this._state=nyt.NONE,this._video=null,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._loaded=!1,this._loadedMeta=!1,this._ignorePause=!1,this._fullScreenOnAwake=!1,this._visible=!0,this._playing=!1,this._cachedCurrentTime=-1,this._waitingFullscreen=!1,this._waitingPlay=!1,this._keepAspectRatio=!1,this._component=null,this._uiTrans=null,this._node=null,this._stayOnBottom=!1,this._dirty=!1,this._forceUpdate=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=t,this._node=t.node,this._uiTrans=t.node.getComponent(SO),this._onHide=()=>{this.video&&this._state===nyt.PLAYING&&(this.video.pause(),this._interrupted=!0)},this._onShow=()=>{this._interrupted&&this.video&&(this.video.play(),this._interrupted=!1)},l.game.on(l.Game.EVENT_HIDE,this._onHide),l.game.on(l.Game.EVENT_SHOW,this._onShow)}get fullScreenOnAwake(){return this._fullScreenOnAwake}get loaded(){return this._loaded}get componentEventList(){return this._componentEventList}get video(){return this._video}get state(){return this._state}get isPlaying(){return this._playing}get UICamera(){return mw.root.batcher2D.getFirstRenderCamera(this._node)}onLoadedMetadata(t){this._loadedMeta=!0,this._forceUpdate=!0,this._visible?this.enable():this.disable(),this.dispatchEvent(nyt.META_LOADED);const e=t.target;this._keepAspectRatio&&e&&this.syncUITransform(e.videoWidth,e.videoHeight),this.delayedFullScreen(),this.delayedPlay()}onCanPlay(t){this._loaded=!0,this.dispatchEvent(nyt.READY_TO_PLAY)}onPlay(t){this._playing=!0,this.dispatchEvent(nyt.PLAYING)}onPlaying(t){this.dispatchEvent(nyt.PLAYING)}onPause(t){this._ignorePause?this._ignorePause=!1:(this._playing=!1,this.dispatchEvent(nyt.PAUSED))}onStoped(t){this._playing=!1,this._ignorePause=!1,this.dispatchEvent(nyt.STOPPED)}onEnded(t){this.dispatchEvent(nyt.COMPLETED)}onClick(t){this.dispatchEvent(nyt.CLICKED)}onError(t){this.dispatchEvent(nyt.ERROR);const e=t.target;e&&e.error&&x(`Error ${e.error.code}; details: ${e.error.message}`)}play(){this._loadedMeta||this._loaded?this.canPlay():this._waitingPlay=!0}delayedPlay(){this._waitingPlay&&(this.canPlay(),this._waitingPlay=!1)}syncFullScreenOnAwake(t){this._fullScreenOnAwake=t,this._loadedMeta||this._loaded?this.canFullScreen(t):this._waitingFullscreen=!0}delayedFullScreen(){this._waitingFullscreen&&(this.canFullScreen(this._fullScreenOnAwake),this._waitingFullscreen=!1)}dispatchEvent(t){const e=this._componentEventList.get(t);e&&(this._state=t,e.call(this))}syncUITransform(t,e){this._uiTrans&&(this._uiTrans.width=t,this._uiTrans.height=e)}syncCurrentTime(){this.video&&-1!==this._cachedCurrentTime&&this.video.currentTime!==this._cachedCurrentTime&&(this.seekTo(this._cachedCurrentTime),this._cachedCurrentTime=-1)}destroy(){this.removeVideoPlayer(),this._componentEventList.clear(),l.game.off(l.Game.EVENT_HIDE,this._onHide),l.game.off(l.Game.EVENT_SHOW,this._onShow)}}l.internal.VideoPlayerImpl=ryt;const oyt=Mi();class ayt extends ryt{constructor(t){super(t),this._eventList=new Map,this._clearColorA=-1,this._clearFlag=void 0}addListener(t,e){this._video&&(this._eventList.set(t,e),this._video.addEventListener(t,e))}removeAllListeners(){this._eventList.forEach(((t,e)=>{this._video&&this._video.removeEventListener(e,t)})),this._eventList.clear()}canPlay(){if(this.video){const t=this.video.play();window.Promise&&t instanceof Promise&&t.catch((()=>{})).then((()=>{this.syncCurrentTime()}))}}pause(){this.video&&(this.video.pause(),this._cachedCurrentTime=this.video.currentTime)}resume(){this.play()}stop(){this.video&&(this._ignorePause=!0,this.video.currentTime=0,this.video.pause(),this._cachedCurrentTime=0,setTimeout((()=>{this._ignorePause=!1,this.dispatchEvent(nyt.STOPPED)}),0))}syncClip(t){this.removeVideoPlayer(),t&&this.createVideoPlayer(t.nativeUrl)}syncURL(t){this.removeVideoPlayer(),t&&this.createVideoPlayer(t)}syncPlaybackRate(t){qh.browserType!==jl.UC?this.video&&(this.video.playbackRate=t):y("playbackRate is not supported by the uc mobile browser.")}syncVolume(t){this.video&&(this.video.volume=t)}syncMute(t){this.video&&(this.video.muted=t)}syncLoop(t){this.video&&(this.video.loop=t)}getDuration(){return this.video?this.video.duration:0}getCurrentTime(){return this.video?this.video.currentTime:-1}seekTo(t){this.video&&(this.video.currentTime=t)}canFullScreen(t){const e=this._video;if(e&&e.readyState===syt.HAVE_ENOUGH_DATA)return qh.os===Xl.IOS&&qh.isBrowser?(t?e.webkitEnterFullscreen&&e.webkitEnterFullscreen():e.webkitExitFullscreen&&e.webkitExitFullscreen(),void(this._fullScreenOnAwake=e.webkitDisplayingFullscreen)):Wh.supportsFullScreen?void(t?(qh.browserType===jl.IE&&(e.style.transform=""),e.setAttribute("x5-video-player-fullscreen","true"),Wh.requestFullScreen(e,(t=>{const i=qh.browserType===jl.IE?t.msFullscreenElement:t.fullscreenElement;this._fullScreenOnAwake=i===e}),(()=>{this._fullScreenOnAwake=!1}))):(e.removeAttribute("x5-video-player-fullscreen"),Wh.exitFullScreen())):(this._fullScreenOnAwake=t,this._forceUpdate=!0,void this.syncMatrix())}syncStayOnBottom(t){this._video&&(this._video.style["z-index"]=t?-32768:0,this._stayOnBottom=t),this._dirty=!0}syncKeepAspectRatio(t){this._keepAspectRatio=t,t&&this._loadedMeta&&this._video&&this.syncUITransform(this._video.videoWidth,this._video.videoHeight)}removeVideoPlayer(){const t=this._video;t&&ee(uw.container,t)&&(uw.container.removeChild(t),this.removeAllListeners()),this._cachedCurrentTime=0,this._playing=!1,this._loaded=!1,this._loadedMeta=!1,this._video=null}createVideoPlayer(t){const e=this._video=document.createElement("video");e.className="cocosVideo",e.style.visibility="hidden",e.style.position="absolute",e.style.bottom="0px",e.style.left="0px",e.style["transform-origin"]="0px 100% 0px",e.style["-webkit-transform-origin"]="0px 100% 0px",e.setAttribute("preload","auto"),e.setAttribute("webkit-playsinline",""),e.setAttribute("x5-playsinline",""),e.setAttribute("playsinline",""),this._bindDomEvent(),uw.container.appendChild(e);const i=document.createElement("source");e.appendChild(i),i.src=t}_bindDomEvent(){this._video,this.addListener("loadedmetadata",this.onLoadedMetadata.bind(this)),this.addListener("canplay",this.onCanPlay.bind(this)),this.addListener("canplaythrough",this.onCanPlay.bind(this)),this.addListener("play",this.onPlay.bind(this)),this.addListener("playing",this.onPlaying.bind(this)),this.addListener("pause",this.onPause.bind(this)),this.addListener("click",this.onClick.bind(this)),this.addListener("ended",this.onEnded.bind(this)),this.addListener("error",this.onError.bind(this))}onCanPlay(t){const e=t.target;if(!this._loaded||!e)switch(e.readyState){case syt.HAVE_METADATA:case syt.HAVE_ENOUGH_DATA:super.onCanPlay(t)}}enable(){if(this._video){if(this._visible=!0,"visible"===this._video.style.visibility)return;this._video.style.visibility="visible"}}disable(t){if(this._video){if(!t&&this._playing&&this._video.pause(),this._visible=!1,"hidden"===this._video.style.visibility)return;this._video.style.visibility="hidden"}}syncMatrix(){if(!this._video||!this._visible||!this._component)return;const t=this.UICamera;if(!t)return;if(Wh.fullScreen())return;this._dirty&&(this._dirty=!1,this._stayOnBottom?(this._clearColorA=t.clearColor.w,this._clearFlag=t.clearFlag,t.clearColor.w=0,t.clearFlag=Nn.ALL):this._clearFlag&&(t.clearColor.w=this._clearColorA,t.clearFlag=this._clearFlag,this._clearColorA=-1,this._clearFlag=null)),this._component.node.getWorldMatrix(oyt),t.update(!0),t.worldMatrixToScreen(oyt,oyt,uw.canvas.width,uw.canvas.height);let e=0,i=0;if(this._fullScreenOnAwake?(e=fw.width,i=fw.height):(e=this._uiTrans.contentSize.width,i=this._uiTrans.contentSize.height),!this._forceUpdate&&this._m00===oyt.m00&&this._m01===oyt.m01&&this._m04===oyt.m04&&this._m05===oyt.m05&&this._m12===oyt.m12&&this._m13===oyt.m13&&this._w===e&&this._h===i)return;this._m00=oyt.m00,this._m01=oyt.m01,this._m04=oyt.m04,this._m05=oyt.m05,this._m12=oyt.m12,this._m13=oyt.m13,this._w=e,this._h=i;const n=jh.devicePixelRatio,s=1/n,r=1/n,o=uw.container,a=oyt.m00*s,c=oyt.m01,l=oyt.m04,h=oyt.m05*r;this._video.style.width=`${this._w}px`,this._video.style.height=`${this._h}px`,qh.browserType!==jl.MOBILE_QQ?this._video.style.objectFit=this._keepAspectRatio?"none":"fill":y("keepAspectRatio is not supported by the qq mobile browser.");const _=this._w*s,u=this._h*r,{x:d,y:m}=this._uiTrans.anchorPoint,p=_*oyt.m00*d,f=u*oyt.m05*m,g=o&&o.style.paddingLeft?parseInt(o.style.paddingLeft):0,v=o&&o.style.paddingBottom?parseInt(o.style.paddingBottom):0,x=`matrix(${a},${-c},${-l},${h},${oyt.m12*s-p+g},${-(oyt.m13*r-f+v)})`;this._video.style.transform=x,this._video.style["-webkit-transform"]=x,qh.browserType!==jl.IE&&(this._forceUpdate=!1)}}class cyt{static getImpl(t){return new ayt(t)}}var lyt,hyt,_yt,uyt,dyt,myt,pyt,fyt,gyt,vyt,yyt,xyt,Syt,Cyt,Ayt,byt,Tyt,Eyt,Pyt,wyt,Iyt,Ryt,Dyt,Myt,Oyt,Byt,Nyt,Lyt,Fyt,zyt,Vyt,Gyt,Uyt,kyt,Hyt,jyt,Wyt,qyt,Xyt;l.internal.VideoPlayerImplManager=cyt;let Yyt,Kyt=t("VideoPlayer",(lyt=dc("cc.VideoPlayer"),hyt=Dc(),_yt=Pc(),uyt=mc(SO),dyt=Kc(Qvt),myt=Kc(iyt),pyt=Lc(),fyt=Lc(),gyt=Kc(Qvt),vyt=Lc(),yyt=Lc(),xyt=Fc(),Syt=Lc(),Cyt=Fc(),Ayt=Lc(),byt=Lc(),Tyt=Lc(),Eyt=Lc(),Pyt=Lc(),wyt=Lc(),Iyt=Kc([KI]),Ryt=kc(),Dyt=Lc(),lyt(Myt=hyt(Myt=_yt(Myt=uyt(Myt=Ec((Xyt=qyt=class extends Lh{constructor(...t){super(...t),nc(this,"_resourceType",Byt,this),nc(this,"_remoteURL",Nyt,this),nc(this,"_clip",Lyt,this),nc(this,"_playOnAwake",Fyt,this),nc(this,"_volume",zyt,this),nc(this,"_mute",Vyt,this),nc(this,"_playbackRate",Gyt,this),nc(this,"_loop",Uyt,this),nc(this,"_fullScreenOnAwake",kyt,this),nc(this,"_stayOnBottom",Hyt,this),nc(this,"_keepAspectRatio",jyt,this),this._impl=null,this._cachedCurrentTime=0,nc(this,"videoPlayerEvent",Wyt,this)}get resourceType(){return this._resourceType}set resourceType(t){this._resourceType!==t&&(this._resourceType=t,this.syncSource())}get remoteURL(){return this._remoteURL}set remoteURL(t){this._remoteURL!==t&&(this._remoteURL=t,this.syncSource())}get clip(){return this._clip}set clip(t){this._clip!==t&&(this._clip=t,this.syncSource())}get playOnAwake(){return this._playOnAwake}set playOnAwake(t){this._playOnAwake=t}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._impl&&this._impl.syncPlaybackRate(t)}get volume(){return this._volume}set volume(t){this._volume=t,this._impl&&this._impl.syncVolume(t)}get mute(){return this._mute}set mute(t){this._mute=t,this._impl&&this._impl.syncMute(t)}get loop(){return this._loop}set loop(t){this._loop=t,this._impl&&this._impl.syncLoop(t)}get keepAspectRatio(){return this._keepAspectRatio}set keepAspectRatio(t){this._keepAspectRatio!==t&&(this._keepAspectRatio=t,this._impl&&this._impl.syncKeepAspectRatio(t))}get fullScreenOnAwake(){return this._impl?(this._fullScreenOnAwake=this._impl.fullScreenOnAwake,this._fullScreenOnAwake):this._fullScreenOnAwake}set fullScreenOnAwake(t){this._fullScreenOnAwake!==t&&(this._fullScreenOnAwake=t,this._impl&&this._impl.syncFullScreenOnAwake(t))}get stayOnBottom(){return this._stayOnBottom}set stayOnBottom(t){this._stayOnBottom!==t&&(this._stayOnBottom=t,this._impl&&this._impl.syncStayOnBottom(t))}get nativeVideo(){return this._impl&&this._impl.video||null}get currentTime(){return this._impl?this._impl.getCurrentTime():this._cachedCurrentTime}set currentTime(t){Number.isNaN(t)?y(`illegal video time! value:${t}`):(t=We(t,0,this.duration),this._cachedCurrentTime=t,this._impl&&this._impl.seekTo(t))}get duration(){return this._impl?this._impl.getDuration():0}get state(){return this._impl?this._impl.state:nyt.NONE}get isPlaying(){return!!this._impl&&this._impl.isPlaying}syncSource(){this._impl&&(this._resourceType===iyt.REMOTE?this._impl.syncURL(this._remoteURL):this._impl.syncClip(this._clip))}__preload(){this._impl=cyt.getImpl(this),this.syncSource(),this._impl.syncLoop(this._loop),this._impl.syncVolume(this._volume),this._impl.syncMute(this._mute),this._impl.seekTo(this._cachedCurrentTime),this._impl.syncPlaybackRate(this._playbackRate),this._impl.syncStayOnBottom(this._stayOnBottom),this._impl.syncKeepAspectRatio(this._keepAspectRatio),this._impl.syncFullScreenOnAwake(this._fullScreenOnAwake),this._impl.componentEventList.set(nyt.META_LOADED,this.onMetaLoaded.bind(this)),this._impl.componentEventList.set(nyt.READY_TO_PLAY,this.onReadyToPlay.bind(this)),this._impl.componentEventList.set(nyt.PLAYING,this.onPlaying.bind(this)),this._impl.componentEventList.set(nyt.PAUSED,this.onPaused.bind(this)),this._impl.componentEventList.set(nyt.STOPPED,this.onStopped.bind(this)),this._impl.componentEventList.set(nyt.COMPLETED,this.onCompleted.bind(this)),this._impl.componentEventList.set(nyt.ERROR,this.onError.bind(this)),this._playOnAwake&&this._impl.loaded&&this.play()}onEnable(){this._impl&&this._impl.enable()}onDisable(){this._impl&&this._impl.disable()}onDestroy(){this._impl&&(this._impl.destroy(),this._impl=null)}update(t){this._impl&&this._impl.syncMatrix()}onMetaLoaded(){KI.emitEvents(this.videoPlayerEvent,this,nyt.META_LOADED),this.node.emit("meta-loaded",this)}onReadyToPlay(){this._playOnAwake&&!this.isPlaying&&this.play(),KI.emitEvents(this.videoPlayerEvent,this,nyt.READY_TO_PLAY),this.node.emit(nyt.READY_TO_PLAY,this)}onPlaying(){KI.emitEvents(this.videoPlayerEvent,this,nyt.PLAYING),this.node.emit(nyt.PLAYING,this)}onPaused(){KI.emitEvents(this.videoPlayerEvent,this,nyt.PAUSED),this.node.emit(nyt.PAUSED,this)}onStopped(){KI.emitEvents(this.videoPlayerEvent,this,nyt.STOPPED),this.node.emit(nyt.STOPPED,this)}onCompleted(){KI.emitEvents(this.videoPlayerEvent,this,nyt.COMPLETED),this.node.emit(nyt.COMPLETED,this)}onError(){KI.emitEvents(this.videoPlayerEvent,this,nyt.ERROR),this.node.emit(nyt.ERROR,this)}play(){this._impl&&this._impl.play()}resume(){this._impl&&this._impl.resume()}pause(){this._impl&&this._impl.pause()}stop(){this._impl&&this._impl.stop()}},qyt.EventType=nyt,qyt.ResourceType=iyt,Byt=sc((Oyt=Xyt).prototype,"_resourceType",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iyt.LOCAL}}),Nyt=sc(Oyt.prototype,"_remoteURL",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Lyt=sc(Oyt.prototype,"_clip",[dyt,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fyt=sc(Oyt.prototype,"_playOnAwake",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zyt=sc(Oyt.prototype,"_volume",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Vyt=sc(Oyt.prototype,"_mute",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gyt=sc(Oyt.prototype,"_playbackRate",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Uyt=sc(Oyt.prototype,"_loop",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kyt=sc(Oyt.prototype,"_fullScreenOnAwake",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hyt=sc(Oyt.prototype,"_stayOnBottom",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jyt=sc(Oyt.prototype,"_keepAspectRatio",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sc(Oyt.prototype,"resourceType",[myt,pyt],Object.getOwnPropertyDescriptor(Oyt.prototype,"resourceType"),Oyt.prototype),sc(Oyt.prototype,"remoteURL",[fyt],Object.getOwnPropertyDescriptor(Oyt.prototype,"remoteURL"),Oyt.prototype),sc(Oyt.prototype,"clip",[gyt,vyt],Object.getOwnPropertyDescriptor(Oyt.prototype,"clip"),Oyt.prototype),sc(Oyt.prototype,"playOnAwake",[yyt],Object.getOwnPropertyDescriptor(Oyt.prototype,"playOnAwake"),Oyt.prototype),sc(Oyt.prototype,"playbackRate",[Uc,xyt,Syt],Object.getOwnPropertyDescriptor(Oyt.prototype,"playbackRate"),Oyt.prototype),sc(Oyt.prototype,"volume",[Uc,Cyt,Ayt],Object.getOwnPropertyDescriptor(Oyt.prototype,"volume"),Oyt.prototype),sc(Oyt.prototype,"mute",[byt],Object.getOwnPropertyDescriptor(Oyt.prototype,"mute"),Oyt.prototype),sc(Oyt.prototype,"loop",[Tyt],Object.getOwnPropertyDescriptor(Oyt.prototype,"loop"),Oyt.prototype),sc(Oyt.prototype,"keepAspectRatio",[Eyt],Object.getOwnPropertyDescriptor(Oyt.prototype,"keepAspectRatio"),Oyt.prototype),sc(Oyt.prototype,"fullScreenOnAwake",[Pyt],Object.getOwnPropertyDescriptor(Oyt.prototype,"fullScreenOnAwake"),Oyt.prototype),sc(Oyt.prototype,"stayOnBottom",[wyt],Object.getOwnPropertyDescriptor(Oyt.prototype,"stayOnBottom"),Oyt.prototype),Wyt=sc(Oyt.prototype,"videoPlayerEvent",[Sc,Iyt,Ryt,Dyt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Myt=Oyt))||Myt)||Myt)||Myt)||Myt)||Myt));l.internal.VideoPlayer=Kyt,V(Kyt.prototype,"VideoPlayer.prototype",[{name:"onPasued",newName:"onPaused"}]),function(t){t.NONE="none",t.LOADING="loading",t.LOADED="loaded",t.ERROR="error"}(Yyt||(Yyt={}));class Jyt{constructor(t){this._componentEventList=new Map,this._state=Yyt.NONE,this._wrapper=void 0,this._webview=null,this._loaded=!1,this._forceUpdate=!1,this._component=null,this._uiTrans=null,this._node=null,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=t,this._node=t.node,this._uiTrans=t.node.getComponent(SO),this.reset(),this.createWebView()}reset(){this._wrapper=null,this._webview=null,this._loaded=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._state=Yyt.NONE,this._forceUpdate=!1}get loaded(){return this._loaded}get componentEventList(){return this._componentEventList}get webview(){return this._webview}get state(){return this._state}get UICamera(){return mw.root.batcher2D.getFirstRenderCamera(this._node)}dispatchEvent(t,...e){const i=this._componentEventList.get(t);i&&(this._state=t,i.call(this,e))}destroy(){this.removeWebView(),this._wrapper=null,this._webview=null,this._loaded=!1,this._component=null,this._uiTrans=null,this._forceUpdate=!1,this._componentEventList.clear()}}l.internal.WebViewImpl=Jyt;const $yt=Mi();class Zyt extends Jyt{constructor(t){super(t)}_bindDomEvent(){this.webview&&this.webview.addEventListener("load",(t=>{this._forceUpdate=!0,this.dispatchEvent(Yyt.LOADED);const e=t.target,i=e.contentDocument&&e.contentDocument.body;i&&i.innerHTML.includes("404")&&this.dispatchEvent(Yyt.ERROR,i.innerHTML)}))}loadURL(t){this.webview&&(this.webview.src=t,this.dispatchEvent(Yyt.LOADING))}createWebView(){const t=document.createElement("div");this._wrapper=t,t.id="webview-wrapper",t.style["-webkit-overflow"]="auto",t.style["-webkit-overflow-scrolling"]="touch",t.style.position="absolute",t.style.bottom="0px",t.style.left="0px",t.style.transformOrigin="0px 100% 0px",t.style["-webkit-transform-origin"]="0px 100% 0px",uw.container.appendChild(t);const e=document.createElement("iframe");this._webview=e,e.id="webview",e.style.border="none",e.style.width="100%",e.style.height="100%",t.appendChild(e),this._bindDomEvent()}removeWebView(){const t=this._wrapper;ee(uw.container,t)&&uw.container.removeChild(t),this.reset()}enable(){this._wrapper&&(this._wrapper.style.visibility="visible")}disable(){this._wrapper&&(this._wrapper.style.visibility="hidden")}evaluateJS(t){if(this.webview){const e=this.webview.contentWindow;if(e)try{e.eval(t)}catch(t){this.dispatchEvent(Yyt.ERROR,t),x(t)}}}setOnJSCallback(t){y("The platform does not support")}setJavascriptInterfaceScheme(t){y("The platform does not support")}syncMatrix(){if(!this._wrapper||!this._uiTrans||!this._component||"hidden"===this._wrapper.style.visibility)return;const t=this.UICamera;if(!t)return;this._component.node.getWorldMatrix($yt),t.update(!0),t.worldMatrixToScreen($yt,$yt,uw.canvas.width,uw.canvas.height);const{width:e,height:i}=this._uiTrans.contentSize;if(!this._forceUpdate&&this._m00===$yt.m00&&this._m01===$yt.m01&&this._m04===$yt.m04&&this._m05===$yt.m05&&this._m12===$yt.m12&&this._m13===$yt.m13&&this._w===e&&this._h===i)return;this._m00=$yt.m00,this._m01=$yt.m01,this._m04=$yt.m04,this._m05=$yt.m05,this._m12=$yt.m12,this._m13=$yt.m13,this._w=e,this._h=i;const n=jh.devicePixelRatio,s=1/n,r=1/n,o=uw.container,a=$yt.m00*s,c=$yt.m01,l=$yt.m04,h=$yt.m05*r;this._wrapper.style.width=`${e}px`,this._wrapper.style.height=`${i}px`;const _=this._w*s,u=this._h*r,d=_*$yt.m00*this._uiTrans.anchorX,m=u*$yt.m05*this._uiTrans.anchorY,p=o&&o.style.paddingLeft?parseInt(o.style.paddingLeft):0,f=o&&o.style.paddingBottom?parseInt(o.style.paddingBottom):0,g=`matrix(${a},${-c},${-l},${h},${$yt.m12*s-d+p},${-($yt.m13*r-m+f)})`;this._wrapper.style.transform=g,this._wrapper.style["-webkit-transform"]=g,this._forceUpdate=!1}}class Qyt{static getImpl(t){return new Zyt(t)}}var txt,ext,ixt,nxt,sxt,rxt,oxt,axt,cxt,lxt,hxt,_xt,uxt,dxt;l.internal.WebViewImplManager=Qyt;let mxt=t("WebView",(txt=dc("cc.WebView"),ext=Dc(),ixt=Pc(),nxt=mc(SO),sxt=Lc(),rxt=Kc([KI]),oxt=kc(),axt=Lc(),txt(cxt=ext(cxt=ixt(cxt=nxt(cxt=Ec((dxt=uxt=class extends Lh{constructor(...t){super(...t),nc(this,"_url",hxt,this),this._impl=null,nc(this,"webviewEvents",_xt,this)}get url(){return this._url}set url(t){this._url=t,this._impl&&this._impl.loadURL(t)}get nativeWebView(){return this._impl&&this._impl.webview||null}get state(){return this._impl?this._impl.state:Yyt.NONE}setJavascriptInterfaceScheme(t){this._impl&&this._impl.setJavascriptInterfaceScheme(t)}setOnJSCallback(t){this._impl&&this._impl.setOnJSCallback(t)}evaluateJS(t){this._impl&&this._impl.evaluateJS(t)}__preload(){this._impl=Qyt.getImpl(this),this._impl.componentEventList.set(Yyt.LOADING,this.onLoading.bind(this)),this._impl.componentEventList.set(Yyt.LOADED,this.onLoaded.bind(this)),this._impl.componentEventList.set(Yyt.ERROR,this.onError.bind(this)),this._impl.loadURL(this._url)}onLoading(){KI.emitEvents(this.webviewEvents,this,Yyt.LOADING),this.node.emit(Yyt.LOADING,this)}onLoaded(){KI.emitEvents(this.webviewEvents,this,Yyt.LOADED),this.node.emit(Yyt.LOADED,this)}onError(...t){KI.emitEvents(this.webviewEvents,this,Yyt.ERROR,t),this.node.emit(Yyt.ERROR,this,t)}onEnable(){this._impl&&this._impl.enable()}onDisable(){this._impl&&this._impl.disable()}onDestroy(){this._impl&&(this._impl.destroy(),this._impl=null)}update(t){this._impl&&this._impl.syncMatrix()}},uxt.EventType=Yyt,hxt=sc((lxt=dxt).prototype,"_url",[Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"https://cocos.com"}}),sc(lxt.prototype,"url",[sxt],Object.getOwnPropertyDescriptor(lxt.prototype,"url"),lxt.prototype),_xt=sc(lxt.prototype,"webviewEvents",[Sc,rxt,oxt,axt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cxt=lxt))||cxt)||cxt)||cxt)||cxt)||cxt));l.internal.WebView=mxt}}}));
